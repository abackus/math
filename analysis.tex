
\documentclass[12pt]{report}
\usepackage[utf8]{inputenc}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amsthm,amssymb}
\usepackage{mathrsfs}

\usepackage{enumitem}
%\usepackage[shortlabels]{enumerate}
\usepackage{tikz-cd}
\usepackage{mathtools}
\usepackage{amsfonts}
\usepackage{amscd}
\usepackage{makeidx}
\usepackage{enumitem}
\title{Analysis notes}
\author{Aidan Backus}
\date{December 2019}


\newcommand{\NN}{\mathbb{N}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\DD}{\mathbb{D}}
\newcommand{\TT}{\mathbb{T}}
\newcommand{\Sphere}{\mathbb S}

\newcommand{\AAA}{\mathcal A}
\newcommand{\BB}{\mathcal B}
\newcommand{\HH}{\mathcal H}

\newcommand{\CVect}{\mathbf{Vect}_\CC}
\newcommand{\Grp}{\mathbf{Grp}}
\newcommand{\Open}{\mathbf{Open}}
\newcommand{\Set}{\mathbf{Set}}

\newcommand{\Aut}{\operatorname{Aut}}
\newcommand{\Cantor}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\card}{\operatorname{card}}
\newcommand{\ch}{\operatorname{ch}}
\newcommand{\Dec}{\operatorname{Dec}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\diam}{\operatorname{diam}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\Expect}{\mathbf E}
\DeclareMathOperator*{\esssup}{ess\,sup}
\newcommand{\FF}{\mathcal{F}}
\DeclareMathOperator*{\Fix}{Fix}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\id}{\operatorname{id}}
\newcommand{\Ind}{\operatorname{Ind}}
\DeclareMathOperator*{\Inv}{Inv}
\newcommand{\interior}{\operatorname{int}}
\newcommand{\lcm}{\operatorname{lcm}}
\newcommand{\Lie}{\operatorname{Lie}}
\newcommand{\Lip}{\operatorname{Lip}}
\newcommand{\MM}{\mathcal M}
\newcommand{\OO}{\mathcal{O}}
\newcommand{\PGL}{\operatorname{PGL}}
\newcommand{\PSL}{\operatorname{PSL}}
\newcommand{\pic}{\vspace{30mm}}
%\newcommand{\Pr}{\operatorname{Pr}}
\newcommand{\Prim}{\operatorname{Prim}}
\newcommand{\pset}{\mathcal{P}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\Ric}{\operatorname{Ric}}
\newcommand{\Rep}{\operatorname{Rep}}
\newcommand{\Res}{\operatorname{Res}}
\newcommand{\Riem}{\mathcal{R}}
\newcommand{\Q}{\mathcal Q}
\newcommand{\RVect}{\RR\operatorname{-Vect}}
\newcommand{\Sch}{\mathcal{S}}
\DeclareMathOperator*{\sgn}{sign}
\newcommand{\SL}{\operatorname{SL}}
\newcommand{\Spec}{\operatorname{Spec}}
\newcommand{\spn}{\operatorname{span}}
\newcommand{\supp}{\operatorname{supp}}

\newcommand{\altrep}{\rho_{\text{alt}}}
\newcommand{\trivrep}{\rho_{\text{triv}}}
\newcommand{\regrep}{\rho_{\text{reg}}}
\newcommand{\stdrep}{\rho_{\text{std}}}

\newcommand{\dbar}{\overline\partial}

\DeclareMathOperator*{\Density}{Density}
\DeclareMathOperator*{\Dil}{Dil}
\DeclareMathOperator*{\Energy}{Energy}
\DeclareMathOperator*{\Mass}{Mass}
\DeclareMathOperator*{\Mod}{Mod}
\DeclareMathOperator*{\Trans}{Trans}

\def\Xint#1{\mathchoice
{\XXint\displaystyle\textstyle{#1}}%
{\XXint\textstyle\scriptstyle{#1}}%
{\XXint\scriptstyle\scriptscriptstyle{#1}}%
{\XXint\scriptscriptstyle\scriptscriptstyle{#1}}%
\!\int}
\def\XXint#1#2#3{{\setbox0=\hbox{$#1{#2#3}{\int}$ }
\vcenter{\hbox{$#2#3$ }}\kern-.6\wd0}}
\def\ddashint{\Xint=}
\def\dashint{\Xint-}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}
\newcommand{\dfn}[1]{\emph{#1}\index{#1}}

\usepackage{color}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true, % make the links colored
    linkcolor=blue, % color TOC links in blue
    urlcolor=red, % color URLs in red
    linktoc=all % 'all' will create links for everything in the TOC
    %Ning added hyperlinks to the table of contents 6/17/19
}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{axiom}[theorem]{Axiom}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{exercise}[theorem]{Exercise}
\newtheorem{problem}[theorem]{Problem}

\makeindex

\begin{document}

\maketitle

\tableofcontents

\part{Preliminaries}
\chapter{Functional analysis}
Here we treat functional analysis in a high level of abstraction.

Throughout these notes, we mean by $f \preceq g$ that there is a universal constant $C > 0$ such that $f \leq C g$.

\section{Locally convex spaces}
    Fix a vector space $V$.
\begin{definition}
    $V$ is said to be a \dfn{topological vector space} if it is equipped with a topology for which addition and multiplication are continuous.
\end{definition}
\begin{definition}
    $V$ is said to be \dfn{locally convex} if $V$ is equipped with a family of seminorms $P_\alpha$ and the initial topology with respect to the $P_\alpha$.
\end{definition}
    This is the smallest topology containing the open sets $P_\alpha([0, \varepsilon))$ for each $\alpha$ and each $\varepsilon > 0$ and which is translation-invariant.

    The most useful examples of locally convex spaces are Banach spaces.
\begin{definition}
    $V$ is said to be a \dfn{Banach space} if $V$ is equipped with the topology arising from a complete norm.
\end{definition}
\begin{definition}
    If $V$ is a topological vector space, then the \dfn{dual space} of $V^*$ is the space of \emph{continuous} linear maps $V \to \CC$.
\end{definition}
\begin{definition}
    Let $W$ be a Banach space and define a norm on $\Hom(V, W)$ by
    $$||T|| = \sup_{||v|| \leq 1} ||Tv||.$$
\end{definition}
    So $V^*$ is a normed space, $V^* \subseteq \Hom(V, \CC)$. In general it is very difficult to construct elements of $V^*$. In general we cannot guarantee constructively that $V^*$ is nontrivial. On the other hand, it is often impossible to construct linear functions which are discontinuous (for example, any linear functional on a Banach space will be continuous if it was constructed without the axiom of choice).
\begin{definition}
    A function $f: V \to \CC$ is said to be \dfn{sublinear} if it obeys the triangle inequality and if for each $c > 0$ and $x \in V$, $f(cx) = cf(x)$.
\end{definition}
    Obviously seminorms are sublinear. Minkowski gauges are another useful example.
\begin{definition}
    Let $K \subseteq V$. Then:
\begin{enumerate}
    \item $K$ is \dfn{convex} if for each $x, y\in K$, $c \in [0, 1]$, $cx + (1-c)y \in K$.
    \item $K$ is \dfn{balanced} if for each $c \in [0, 1]$, $cK \subseteq K$.
\end{enumerate}
    If $K$ is balanced and convex, then the \dfn{Minkowski gauge} of $K$ is the functional
    $$p_K(x) = \inf_{cK \ni x} c.$$
\end{definition}
    Notice that the balanced condition suggests that $K$ needs to be close to the origin. Moreover, Minkowski gauges are sublinear.

    Sublinear estimates allow us to construct functionals using the axiom of choice, while still guaranteeing that they are continuous.
\begin{theorem}[Hanh-Banach]
    \index{Hanh-Banach theorem}
    Assume that $p: V \to \CC$ is sublinear, $U \subset V$ a subspace, and $f: U \to \CC$ a linear functional. If $f$ is dominated by $p$, i.e. for each $x \in U$, $|f(x)| \leq |p(x)|$, then $f$ extends to $V$.
\end{theorem}
    In general the extension of $f$ will only be unique in case $U$ is dense. So we have to use the axiom of choice to construct $f$.
\begin{proof}
    The extension to the complex case is trivial so we replace $\CC$ with $\RR$. Assume that $f$ is defined on a space $W$, $U \subseteq W \subset V$. Choose $v \in V \setminus W$ and define $f(v)$ such that for each $w \in W$ and $s,t \geq 0$,
$$\frac{p(w-sv)}{s} \leq h(v) \leq \frac{p(w+tv) - f(w)}{t}.$$
    This is always possible because
    $$f((t+s)w) \leq p((t+s)w) = p((t+s)w + tsv - tsv) \leq p(sw + stv) + p(tw - stv)$$
    so
    $$\frac{f(w) - p(w - sv)}{s} \leq \frac{p(w+tv) - f(w)}{t}.$$
    Therefore for any $W$ and $v$ we can extend $f$ to $W + v$. If $\mathcal W$ is the family of subspaces of $V$ on which $f$ is defined and $\mathcal C \subset \mathcal W$ is a chain, then $\mathcal C$ therefore has an upper bound. Since $U \in \mathcal W$, Zorn's lemma implies that $\mathcal W$ has a maximal element, which is clearly $V$.
\end{proof}
    In case $p$ is the norm of $V$, this implies that $V^*$ is nontrivial. The Hanh-Banach theorem also has a useful geometric interpretation.
\begin{theorem}[Hanh-Banach separation theorem]
    \index{Hanh-Banach separation theorem}
    Let $\RR$ be the scalar field and $A, B \subset V$ be convex, nonempty, and disjoint. If $A$ is open then there is a $\varphi \in V^*$ and $t \in \RR$ such that for every $a \in A$ and $b \in B$,
    $$\varphi(a) < t \leq \varphi(b).$$
\end{theorem}
\begin{proof}
    Choose $a_0 \in A$ and $b_0 \in B$, and let $C = A - B + b_0 - a_0$. Then $0 \in C$, $C$ is convex, and $C = \bigcup_{b \in B} A - b + b_0 - a_0$, so $C$ is open. If $x = b_0 - a_0$, then $x \notin C$.

    By the Hanh-Banach theorem, choose a $\varphi \in V^*$ such that $\varphi(x_0) = 1$ and $\varphi < 1$ on $C$. Given $a \in A$ and $b \in B$ we have
    $$\varphi(a) < \varphi(b) + \varphi(a_0) - \varphi(b_0) + 1 = \varphi(b).$$
    If $t = \inf_B \varphi$, then this gives, for every $a$ and $b,$
    $$\varphi(a) \leq t \leq \varphi(b).$$
    Since $A$ is open, $\varphi(A)$ is open so the claim holds.
\end{proof}
    In particular, linear functionals separate points.

    Let's consider more properties of convexity. Let the scalar field be $\RR$ and let $S \subset V$ be nonempty, compact, and convex.
\begin{definition}
    A \dfn{face} of $S$ is a nonempty, compact, convex set $K \subseteq S$ such that for each $x \in K$, if there are $y_1, y_2 \in S$ and $c \in (0, 1)$ such that $x = cy_1 + (1-c)y_2$, then $y_1, y_2 \in K$. If $|K| = 1$, then $K$ is called an \dfn{extreme point}.
\end{definition}
\begin{definition}
    If $X \subset V$ is a set, the \dfn{convex hull} of $X$ is the smallest set containing $X$ which is closed and convex.
\end{definition}
    For example, if $S$ is a convex polygon, then the extreme points of $S$ are its vertices, and $S$ is the convex hull of its vertices. The Krein-Milman theorem says that this phenomenon happens even in infinite dimensions.
\begin{theorem}[Krein-Milman]
    \index{Krein-Milman theorem}
    $S$ is the convex hull of its extreme points.
\end{theorem}
\begin{proof}
    Assume that $S'$ is the convex hull of the extreme points of $S$. Then $S' \subseteq S$, so $S'$ is compact. If there is an $x_0 \in S \setminus S'$, then since $V^*$ separates points, there is a $\lambda \in V^*$ such that $\lambda(S') < \lambda(x_0)$. If $C = \max \lambda(x_0)$, then $\varphi^{-1}(C) \cap S$ contains no extreme points of $S$. We can contradict this by showing that every convex compact set has an extreme point.

    Let $\mathcal F$ be the set of all faces of $S$. Clearly $S \in \mathcal F$ so $\mathcal F$ is nonempty. If $\mathcal C \subset \mathcal F$ is a chain, then $\bigcap \mathcal C$ is a face, so by Zorn's lemma $\mathcal F$ has a minimal element $S_0$.

    Let $\varphi \in V^*$. Since $S_0$ is convex, it is connected, so $\varphi(S_0)$ is compact and connected. In particular, $\varphi(S_0) = [a, b]$ for some $a \leq b$. So $\varphi^{-1}(b) \cap S_0$ is nonempty, convex, and compact. If $x \in \varphi^{-1}(b) \cap S_0$,
    $$x = ty_1 + (1-t)y_2,$$
    then $y_1,y_2 \in S_0$. Therefore $\varphi(x) = b = c\varphi(y_1) + (1-c)\varphi(y_2)$, so $\varphi(y_1), \varphi(y_2) \geq c$. Therefore $y_1, y_2 \in \varphi^{-1}(b) \cap S_0$, so $\varphi^{-1}(b) \cap S_0$ is a face and by minimality, $\varphi^{-1}(b) \cap S_0 = S_0$. So $\varphi(S_0) = b$. Since $\varphi$ was arbitrary and $V^*$ separates points, $|S_0| = 1$. So $S$ has an extreme point.
\end{proof}


\section{Hilbert spaces}
    \begin{definition}
    A \dfn{Hilbert space} $V$ is a Banach space whose norm arises from an inner product.
    \end{definition}
    The basic fact about Hilbert spaces $V$ is that $V^* = V$.
\begin{theorem}[Riesz representation theorem]
    \index{Riesz representation theorem for Hilbert spaces}
    The association
\begin{align*}
    V &\to V^*\\
    v &\mapsto (w \mapsto \langle v, w\rangle)
\end{align*}
    is a surjective isometry.
\end{theorem}
\begin{proof}
    Evaluating $w \mapsto \langle v, w\rangle$ at $v$, we see $||v|| = ||v||_{op}$. So we just have to check surjectivity. Let $\varphi \in V^*$, and $F = \ker \varphi$. If $F = 0$ we're done; otherwise $F^\perp$ is nonempty. Let $z \in F^\perp$ and $\alpha = \varphi(z)/||z||$. Then for any $x \in V$,
    \begin{align*}
        \langle x, \alpha z\rangle  &=  \left\langle x - \frac{\varphi(x)}{\varphi(z)} z, \alpha z\right\rangle + \left\langle \frac{\varphi(x)}{\varphi(z)}z, \alpha z\right\rangle \\&= \left\langle \frac{\varphi(x)}{\varphi(z)}z, \alpha z\right\rangle
            = \frac{\varphi(x)}{\varphi(z)} \varphi(z) = \varphi(x).
    \end{align*}
\end{proof}


\section{Bochner integration}
    Now we fix a Banach space $B$ and a measure space $(X, \Sigma, \mu)$. Recall that the \dfn{Caratheodory construction} is the standard way of building $(X, \Sigma, \mu)$: we define a semiring $\Sigma_0$ of sets (i.e. a family of sets closed under finite intersection and subsets of finite disjoint unions) and a countably additive function $\mu$ on $\Sigma_0$, which then extends to an outer measure $\mu^*$ on the power set $\pset(X)$. If $E \subseteq X$ satisfies the \dfn{Caratheodory criterion}, i.e. that for all $F \subseteq X$,
    $$\mu^*(F) = \mu^*(F \cap E) + \mu^*(F \setminus E),$$
    then we declare that $E$ is measurable. The measurable sets form a $\sigma$-algebra $\Sigma$ on which $\mu^*$ is outer measurable (note that $\mu^*$ did not have to be constructed from a semiring for this step to work; any outer measure will do) and we define the restriction $\mu$ of $\mu^*$ to $\Sigma$ to be the desired outer measure.
\begin{definition}
    A $B$-valued \dfn{integrable simple function} is a finite linear combination of functions \begin{align*}
        \chi_E^b: X &\to B\\
        E \ni x &\mapsto b\\
        E^c \ni x &\mapsto 0
    \end{align*} where $E$ is a measurable set with $||\mu(E)|| < \infty$, $b \in B$.

    The integral of a $B$-valued ISF $f = \sum_n \chi_{E_n}^{b_n}$ is
    $$\int_X f ~d\mu = \sum_n b_n \mu(E_n)$$
    and the $L^1$-norm is $||f||_{L^1} = \int_X |f| ~d\mu$.
\end{definition}
    Then $L^1$ is naturally the Cauchy completion of the ISF.
\begin{definition}
    A function $X \to B$ is a $B$-valued \dfn{integrable function} if it lies in $L^1$.
\end{definition}
\begin{definition}
    For $p \in (1, \infty)$, the $L^p$ norm of $f: X \to B$ is
    $$||f||_{L^p} = \left(\int_X ||f(x)||^p ~d\mu(x)\right)^{1/p}$$
    and the $L^\infty$ norm is $||f||_{L^\infty} = \lim_{p \to \infty} ||f||_{L^p} = \esssup ||f||$.
\end{definition}
    The usual Lebesgue convergence theorems hold:
\begin{theorem}[Lebesgue convergence theorems]
    Let $\{f_n\}$ be a pointwise convergent sequence of integrable functions. Then:
\begin{enumerate}
    \item If each $f_n \leq f_{n+1}$,
    $$\lim_n \int f_n = \int \lim_n f_n < \infty.$$
    \item If there is an integrable function $g > 0$ such that every $|f_n| \leq g$,
    $$\lim_n \int f_n = \int \lim_n f_n \leq g.$$
    \item $$\int \liminf_n f_n \leq \liminf_n \int f_n.$$
\end{enumerate}
\end{theorem}

    Now let's make some estimates which will actually prove that the $L^p$-norm is a norm, besides being useful later.
\begin{theorem}[Jensen's inequality]
    \index{Jensen's inequality}
    Let $f: \RR \to \RR$ be convex and $g$ an integrable function. Then
    $$f\left(\int g\right) \leq \int f \circ g.$$
\end{theorem}
\begin{theorem}[Holder's inequality]
    \index{Holder's inequality}
    Let
    $$\frac{1}{p} + \frac{1}{q} = 1.$$
    Then $||fg||_{L^1} \leq ||f||_{L^p} ||g||_{L^q}$.
\end{theorem}
\begin{proof}
    The mapping $x \mapsto x^p$ is convex so if $f, g \geq 0$,
\begin{align*}
    \int fg
        &= \left(\int g^q\right) \int fg^{1-q} \frac{g^q}{\int g^q}
        \leq \left(\int g^q\right) \left(\int f^p g^{p(1-q)}\frac{g^q}{\int g^q}\right)^{1/p}\\
        &= \left(\int g^q\right) \left(\left(\int g^q\right) \left(\int f^p\right)\right)^{1/p}
        \leq \left(\int f^p\right)^{1/p} \left(\int g^q\right)^{1/q}.
\end{align*}
\end{proof}
    Notice that Holder's inequality implies that $L^2$ is a Hilbert space with inner product
    $$\langle f, g\rangle = \int fg.$$
\begin{theorem}[Minkowski's inequality]
    \index{Minkowski's inequality}
    Let
    $$\frac{1}{p} + \frac{1}{q} = 1.$$
    Then
    $$||f + g||_{L^p} \leq ||f||_{L^p} + ||g||_{L^p}.$$
\end{theorem}
\begin{proof}
    By Holder's inequality,
    \begin{align*}
        \int |f+g|^p
            &= \int |f+g||f+g|^{p-1}
            \leq \int (|f| + |g|) |f+g|^{p-1}
            \\&\leq \left(\left(\int |f|^p \right)^{1/p} + \left(\int |g|^p\right)^{1/p}\right)\left(\int |f+g|^{(p-1)\left(\frac{p}{p-1}\right)} \right)^{1-\frac{1}{p}}\\
            &= (||f||_{L^p} + ||g||_{L^p}) \frac{||f+g||_{L^p}^p}{||f+g||_{L^p}}.
    \end{align*}
\end{proof}
    Now we discuss change of variables.
\begin{definition}
    Let $\nu$ be a measure. Then
\begin{enumerate}
    \item $\nu$ is \dfn{absolutely continuous} with respect to $\mu$ if for every measurable set $A$, $\mu(A) = 0$ implies $\nu(A)$.
    \item $\nu$ is \dfn{singular} with respect to $\mu$ if there are disjoint measurable sets $A, B$ such that $X = A \cap B$, $\nu(A) = 0$ and $\mu(A) = 0$.
    \item If there is a measurable function $f$ such that for every measurable set $A$,
    $$\nu(A) = \int_A f ~d\mu,$$
    then $f$ is the \dfn{Radon-Nikodym derivative} of $\nu$, written
    $$f = \frac{d\nu}{d\mu}.$$
\end{enumerate}
\end{definition}
\begin{theorem}[Radon-Nikodym]
    \index{Radon-Nikodym theorem}
    Let $\mu$ be $\sigma$-finite and $\nu$ be a positive measure. Then there is a unique decomposition $\nu = \nu_a + \nu_s$ such that $\nu_a$ is absolutely continuous and $\nu_s$ is singular (with respect to $\mu$). Moreover, $\nu_a$ has a Radon-Nikodym derivative.
\end{theorem}
    In particular, if $\nu$ was already absolutely continuous, then $\nu_s = 0$ and $\nu$ has a Radon-Nikodym derivative.
\begin{proof}
    Uniqueness is obvious. First assume $\mu(X) < \infty$. Then $\mu + \nu$ is finite, so $L^\infty(\mu + \nu) \subseteq L^1(\mu + \nu)$. So by the Cauchy-Schwarz inequality, if $f$ is an ISF,
    $$\left|\int f ~d\nu\right| \leq ||f||_{L^1(\nu)} \leq ||f||_{L^1(\mu+\nu)} \preceq ||f||_{L^2(\mu)}.$$
    So $\int \cdot ~d\nu$ is $L^2$-continuous on ISF, hence on $L^2(\mu + \nu)$. So by the Riesz representation theorem, there is a nonnegative $h \in L^1(\mu + \nu)$ such that
    $$\int f ~d\nu = \int \int fh ~d(\mu + \nu)$$
    for any $f \in L^2$. In particular, if $A$ is measurable,
    $$\int_A h ~d(\mu + \nu) = \nu(A) \leq (\mu + \nu)(A).$$
    Without loss of generality we assume $h \leq 1$. If $g \in L^\infty(\nu)$,
    $$\int g ~d\nu = \int gh ~d\mu + \int gh ~d\nu.$$
    So if $Y$ is the set of all $y$ such that $0 \leq h(y) < 1$, it follows that $\mu(Y) = \mu(X)$. By induction,
    $$\int g ~d\nu = \int g(h + \dots + h^n) ~d\mu + \int gh^n ~d\nu.$$
    Since $h \leq 1$, the dominated convergence theorem implies
    $$\int gh^n ~d\nu \to \int_{X \setminus Y} g ~d\nu$$
    and if
    $$f = \frac{h\chi_Y}{1-h}$$
    we have
    $$\int g ~d\nu = \int_Y gf ~d\mu + \int_{X \setminus Y} g ~d\nu$$
    and take $\nu_s(A) = \nu(A \cap (X \setminus Y))$. Then we take
    $$\nu_a(A) = \int_A f ~d\mu$$
    so $f$ is the Radon-Nikodym derivative of $\nu_a$, $\nu_a + \nu_s = \nu$ by taking $g = \chi_A$.

    To extend to the $\sigma$-finite case, break up $X$ into countably many finite measure spaces and sum over them.
\end{proof}
    Next we discuss iterated integrals. Given measure spaces $(X, S, \mu)$ and $(Y, T, \nu)$, we need a $\sigma$-algebra on $X \times Y$ and a measure defined on that $\sigma$-algebra. To do this, we use the Caratheodory construction.
\begin{definition}
    If $E \in S$ and $F \in T$, then $E \times F$ is a \dfn{measurable rectangle}. Let $S \otimes T$ denote the smallest $\sigma$-algebra containing the measurable rectangles, and on for each measurable rectangle, define a countably additive function by
    $$\mu \otimes \nu(E \times F) = \mu(E) \nu(F).$$
\end{definition}
    By the monotone convergence theorem $d\nu$, $\mu \otimes \nu$ is countably additive. So the Caratheodory construction gives rise to a measure $\mu \otimes \nu$ whose measurable sets include $S \otimes T$ (in fact, is the completion of $S \otimes T$).
\begin{definition}
    The measure space $(X \times Y, S \otimes T, \mu \otimes \nu)$ is the \dfn{product measure space} of $(X, S, \mu)$ and $(Y, T, \nu)$.
\end{definition}
    Straight from the definitions, we know that for every measurable rectangle $E \times F$,
    $$\int \chi_{E \times F} ~d(\mu \otimes \nu) = \iint \chi_{E \times F} ~d\mu ~d\nu = \iint \chi_{E \times F} ~d\nu ~d\mu.$$

    For a function $f$ defined on $X \times Y$ we define $f^y(x) = f(x, y)$ and $f_x(y) = f(x, y)$. For a set $G \subseteq X \times Y$, we define $G^y = \{x \in X: (x, y) \in G\}$ and $G_x = \{y \in Y: (x, y) \in G\}$.
\begin{theorem}[Fubini]
    \index{Fubini's theorem}
    Let $f \in L^1(\mu \otimes \nu)$ and assume $\mu \otimes \nu$ is $\sigma$-finite. Then for almost every $y$, $f^y \in L^1(\mu)$. Moreover, the function
    $$F(y) = \int f^y ~d\mu$$
    has $F \in L^1(\nu)$, and
    $$\int f ~d(\mu \otimes \nu) = \iint f^y ~d\mu ~d\nu = \iint f_x ~d\nu ~d\mu.$$
\end{theorem}
    The assumption of $\sigma$-finiteness is not optional here, and Fubini's theorem can fail for large cardinality measure spaces.
\begin{definition}
    Let $M$ be a family of subsets of $X$ such that for every countable chain of $A_n$ in $M$ and $\bigcup_n A_n = A$ or $\bigcap_n A_n = A$, $A \in M$. Then we say $M$ is a \dfn{monotone class}.
\end{definition}
    If $R$ is a ring of sets, then the smallest monotone class $M$ containing $R$ is also a ring, and it is not hard to see that $M$ is the smallest $\sigma$-algebra containing $R$.
\begin{lemma}
    Let $G \in S \otimes T$. Then:
\begin{enumerate}
    \item $G_x \in T$ and $G^y \in S$.
    \item $x \mapsto \nu(G_x)$ and $y \mapsto \mu(G^y)$ are measurable.
    \item One has
    $$\mu \otimes \nu(G) = \int (x \mapsto \nu(G_x)) ~d\mu(x) = \int (y \mapsto \mu(G^y)) ~d\nu(y) = \iint \chi_G ~d\mu ~d\nu.$$
\end{enumerate}
\end{lemma}
\begin{proof}
    This is obvious if $G$ is a measurable rectangle. We shall show that the algebra of sets on which this claim holds is a monotone class, hence a $\sigma$-algebra. Clearly if $\bigcup_n G_n = G$ then $G$ has the property. Given $x \in X$, $\bigcup_n (G_n)_x = G_x$, so $G_x \in T$. Therefore the chain of functions $x \mapsto \nu(G_n)_x$ converges to $x \mapsto \nu(G_x)$ which is therefore measurable. So by the monotone convergence theorem,
    $$\lim_n \mu \otimes \nu(G_n) = \lim_n \int (x \mapsto \nu((G_n)_x) ~d\mu(x) = \int (x \mapsto \nu(G_x) ~d\mu(x) = \mu \otimes \nu(G).$$
    So this algebra is closed under ascending chains. The proof in the other direction is similar but you have to start by assuming that $\mu \otimes \nu(G_1) < \infty$.
\end{proof}
\begin{lemma}
    Let $f \geq 0$ be $S \otimes T$-measurable. Then
    $$\int f ~d\mu \otimes \nu = \iint f ~d\mu ~d\nu.$$
\end{lemma}
\begin{proof}
    Let $\{f_n\}$ be a chain of ISFs. This claim is obvious for ISF, so the monotone convergence theorem on the $f_n^y$ for each $y \in Y$.
\end{proof}
\begin{theorem}[Tonelli]
    \index{Tonelli's theorem}
    If $f$ is $S \otimes T$-measurable, $g(x) = ||f(x)||$, $g^y \in L^1(\mu)$, and $(y \mapsto \int g^y ~d\mu) \in L^1(\nu)$, then $f \in L^1(\mu \otimes \nu)$.
\end{theorem}
\begin{proof}
    Clear by the lemmata.
\end{proof}
\begin{proof}[Proof of Fubini's theorem]
    Let $g(x, y) = ||f(x, y)||$. Then if $\{f_n\}$ is a sequence of ISF converging to $f$, $g$ dominates the $f_n$. Apply the dominated convergence theorem twice, once for each integral.
\end{proof}

\section{Duality}
    Fix a normed space $V$. We consider properties of $V^*$. Since $\CC$ is complete, $V^*$ is a Banach space; in particular, $V^{**}$ is a Banach space. So we can always embed $V$ in a Banach space by the mapping
\begin{align*}
    V &\to V^{**}\\
    v &\mapsto (\varphi \mapsto \varphi(v)).
\end{align*}
    However, $V^{**}$ is rarely the completion of $V$ if $V$ is infinite-dimensional. Moreover, the topology of $V^*$ is a bit awkward to work with, since a convergence in operator norm is much stronger than convergence pointwise.
\begin{definition}
    The \dfn{weakstar topology} of $V^*$ is the initial topology such that every evaluation $\varphi \mapsto \varphi(v)$ is continuous.
\end{definition}
    In other words, the weakstar topology is the topology of pointwise convergence.
\begin{theorem}[Banach-Alaoglu]
    \index{Banach-Alaoglu theorem}
    Let $B$ be the closed unit ball of $V^*$. Then $B$ is weakstar compact.
\end{theorem}
    Like the Hanh-Banach and Krein-Milman theorems, the proof of Banach-Alaoglu uses the axiom of choice. However, the Banach-Alaoglu theorem is not really nonconstructive, since if $V$ is separable, we can use a diagonalization argument to prove it instead. Banach-Alaoglu generalizes to locally convex spaces.
\begin{proof}
    Let
    $$D_v = \{z \in \CC: |z| \leq ||v||\}$$
    and $D = \prod_{v \in V} D_v$. By Tychonoff's theorem, $D$ is compact. Moreover, there is a natural embedding
\begin{align*}
    \iota: V^* &\to D\\
    f &\mapsto \{f(v)\}_{v \in V}.
\end{align*}
    Since the product topology is the topology of pointwise convergence, $\iota$ is a homeomorphism $V^* \to \iota(V^*)$. So we just need to show that $\iota(V^*)$ is closed. So let $\{\{f_\alpha(v)\}_{v \in V}\}_{\alpha \in A}$ be a net in $D$, which converges to a $\{\varphi_v\}_{v \in V}$. Then $f(v) = \varphi_v$ is a linear functional and $f_\alpha \to f$ pointwise so $\{\varphi_v\}_{v \in V} \in \iota(V^*)$.
\end{proof}
    Now we compute the duals of the main examples of Banach spaces we have presented so far.
\begin{theorem}
    Let $p, q \in [1, \infty]$ and assume $\mu$ is $\sigma$-finite.
    $$\frac{1}{p} + \frac{1}{q} = 1.$$
    Then $(L^p(\mu))^* = L^q(\mu)$.
\end{theorem}
    Actually, this theorem is true without the $\sigma$-finiteness; however, it becomes much more difficult.
\begin{proof}
    For $g \in L^q$, one has $||g||_{p^*} \leq ||g||_q$ by Holder's inequality and by taking larger and larger measurable sets $E$ and considering $\int_E g$, we check $||g||_{p^*} \geq ||g||_q$. So we just need to show that the map $L^q \to L^{p^*}$ is surjective.

    If $h \in L^p$ and $X$ splits into finite measure spaces $X_k$ we put $h_k = \chi_{X_k}h$, so $\sum_k h_k = h$ in $L^p$ by the dominated convergence theorem. If $\varphi \in L^{p^*}$ then $\varphi(\sum_k h_k) = \sum_k \varphi(h_k)$ so we might as well assume $X = X_1$, viz. $\mu(X) < \infty$. Then $L^\infty \subseteq L^p$, so $\varphi \in (L^\infty)^*$. We can define an absolutely continuous measure $\nu$ by $\nu(A) = \varphi(\chi_A)$, and by the Radon-Nikodym theorem, there is a Radon-Nikodym derivative $f$ of $\nu$.

    Let $Y_n = \{x \in X: |f(x)| \leq n\}$ and let $g = f/|f|^{q-2}$, where $g(x) = 0$ if $f(x) = 0$, and $g_n = \chi_{Y_n}g_n$. Then $|g|^p = |f|^q$ and
    $$\int_{Y_n} |f|^q = \int g_nf = \varphi(g_n) \preceq ||g_n||_p \preceq ||f_n||_{L^p(Y_n)}.$$
    So $||f||_{L^q(Y_n)} < \infty$, and by the monotone convergence theorem, $f \in L^q$.
\end{proof}

\section{Vector lattices}
    We now consider the natural order structure of a space.
\begin{definition}
    A \dfn{vector lattice} is a vector space $V$ equipped with a partial order $\leq$ which is translation-invariant such that $(V, \leq)$ is a lattice, and such that for each $c \geq 0$ and $x \leq y$, $cx \leq cy$.
\end{definition}
    Recall that a lattice is just a poset which is closed under finite joins $\vee$ (suprema) and meets $\wedge$ (infima). Actually, we just need to check that $V$ is a semilattice, since multiplication by $-1$ implies that a semilattice is already a lattice.

    If $V$ is a vector lattice and $v \in V$, we define $f_\pm = \pm f \vee 0$. Then $f = f_+ - f_-$ and we define the absolute value (or valuation) $|f| = f_+ + f_-$.
\begin{definition}
    A \dfn{Banach lattice} is a vector lattice $V$ which is a Banach lattice, such that $|x| \leq |y|$ whenever $||x|| \leq ||y||$.
\end{definition}
\begin{example}
    A function space mapping into $\RR$ is usually a Banach lattice with the natural ordering, $f \leq g$ iff for every $x$, $f(x) \leq g(x)$. For example, $C(X)$ is a lattice. Spaces of operators are Banach lattices as well, whose positive elements are precisely the positive operators; as are spaces of signed measures, where the positive measures are the positive elements.
\end{example}
\begin{theorem}
    Let $V$ be a Banach lattice. There is a natural ordering on $V^*$, such that $f \in V^*$ is positive iff for each positive $v \in V$, $f(v) \geq 0$, and such that $f \leq g$ iff for every positive $v \in V$, $f(v) \leq g(v)$.
\end{theorem}
\begin{proof}
    Take the definition of positive functionals as in the statement of the theorem. If $f$ and $-f$ are both positive, each $v = v_+ - v_-$ has $f(v_+) \geq 0$ but $f(v_-) \leq 0$. So $f(v) = 0$. Since $v$ was arbitrary, $f = 0$.

    Given $f \in V^*$, define
    $$f^+(v) = \sup_{0 \leq x \leq v} f(x)$$
    for $v \geq 0$. Then $f^+ \geq f$, and $f^+$ is finite because if $x \leq v$, $|f(x)| \leq ||f|| ||v||$. Moreover, if $v, w \geq 0$, it is easy to check $f^+(v+w) = f^+(v) + f^+(w)$. So $f^+$ is positive-linear, so extends to all of $V$ and so $f^+ \in V^*$.

    Clearly $f^+ - f \geq 0$. We need to show this is optimal, i.e. $f^+ = f \vee 0$. Assume $g \geq f \vee 0$. Then for $0 \leq x \leq v$, $f(x) \leq g(x) \leq g(v)$, so taking the $\sup$ over $x$ we have $f^+(v) \leq g(v)$. The other direction is similar. So $f^+ = f \vee 0$.
\end{proof}
    Fix a compact Hausdorff space $X$, $|X| \geq 2$ (so in particular, every set which separates points is nonempty). Let us now study the behavior of sublattices of $C(X) = C(X \to \RR)$.
\begin{theorem}[Dini]
    \index{Dini's theorem}
    Let $L$ be a sublattice of $C(X)$, and define $g(x) = \inf_{f \in L} f(x)$. For each $\varepsilon > 0$, there exists a $h \in L$ such that $g \leq h \leq g + \varepsilon$.
\end{theorem}
\begin{proof}
    For each $f \in L$ let $U_f = \{x \in X: f(x) - g(x) \leq \varepsilon\}$. Then the $U_f$ are an open cover of $X$, which has a finite subcover by functions $f_1, \dots, f_k$. Take $h = \bigwedge_{j \leq k} f_j$.
\end{proof}
    When can a lattice be used to approximate any function in $C(X)$? A necessary condition is that the lattice strongly separates points. This turns out to be sufficient as well.
\begin{definition}
    A set $A \subseteq C(X)$ \dfn{separates points} if for each $x, y \in X$, there is an $f \in A$ such that $f(x) \neq f(y)$. If, in addition, the constant functions $\RR \subseteq A$, then $A$ \dfn{strongly separates points}.
\end{definition}
\begin{theorem}[Stone-Weierstrass]
    \index{Stone-Weierstrass theorem}
    If $L \subseteq C(X)$ is a sub-vector lattice or a subalgebra which strongly separates points, then $L$ is dense in $C(X)$.
\end{theorem}
    The lattice case is also called the \dfn{Kakutani-Krein theorem}.
\begin{lemma}
    \label{sw lem 1}
    Let $L$ be a sublattice of $C(X)$ which separates points and is closed under multiplication and addition by elements of $\RR$. Then if $B \subseteq X$ is compact, $p \in X \setminus B$, and $a, b \in \RR$, there is a $g \in L$ such that $g \geq a$, $g(p) = a$ and $g > b$ on $B$.
\end{lemma}
\begin{proof}
    For each $x \in B$ there exists $g_x \in L$ such that $g_x(p) = a$ and $g_x(x) = b+1$. Let $U_x = \{y\in X: g_x(y) > b\}$. Since $x \in U_x$, the $U_x$ are an open cover of $B$ with finite subcover $U_{x_1}, \dots, U_{x_k}$. Take $g = a \vee \bigvee_{j \leq k} g_{x_k}$.
\end{proof}
\begin{lemma}
    \label{sw lem 2}
    Assume that $L$ is a closed unital subalgebra of $C(X)$. Then $L$ is a lattice.
\end{lemma}
\begin{proof}
    Choose $\varepsilon > 0$ and apply the classical Weierstrass theorem to $[-1, 1]$ to find a polynomial $P_\varepsilon$ which approximates $|\cdot|$ in $L^\infty$-norm by $\varepsilon$. Then for each $f \in L$, we can approximate $|f|$ by $P_\varepsilon \circ f$. Since $L$ is unital, $P_\varepsilon \circ f \in L$. So $|f| \in L$, since $L$ is closed. The lattice operations $\vee$ and $\wedge$ can be expressed in terms of algebra operations $+$ and $\cdot$, and $|\cdot|$, so $L$ is closed under lattice operations.
\end{proof}
\begin{proof}[Proof of Stone-Weierstrass]
    First consider the case that $L$ is a lattice. Given $f \in C(X)$, define $L_f = \{g \in L: g \geq f\}$. Then $L_f$ is a sublattice of $L$. Given $x \in X$, $\delta > 0$, the set $B = \{y \in X: f(y) \geq f(x) + \delta\}$ is closed. Since $X$ is compact, there is an $M > 0$ such that $f < M$. Apply Lemma \ref{sw lem 1} with $a = f(x) + \delta$ and $b = M$, so there is a $g \in L$ such that $g \geq f(x) + \delta$, $g(x) = f(x) + \delta$ and $g > M$ on $B$. So $f \leq g \leq g + \delta$, so $f = \bigwedge L_f$. Therefore by Dini's theorem, there is an $h \in L$ with the desired properties.

    For the algebra case, since $L$ strongly separates points, $L$ is unital. Therefore $\overline L$ is a closed unital algebra, $\overline L$ is a closed lattice whose closure is $C(X)$, by Lemma \ref{sw lem 2} and the above case. So $\overline L = C(X)$.
\end{proof}
This even extends to decaying functions on locally compact Hausdorff spaces, by taking the one-point compactification.

\section{Positive Radon measures}
The usual construction of measures by ISF is somewhat unnatural when we have a nice topology, since then we can define integration in terms of continuous functions. Clearly ``nice" in this context implies locally compact Hausdorff; these conditions are also sufficient (though $\sigma$-compactness also helps). Throughout this section, we fix a locally compact Hausdorff space $X$ and consider the space $C_c(X)$ of compactly supported continuous functions $X \to \CC$.

We have not given a topology on $C_c(X)$, so a functional is just an element of $\Hom(C_c(X), \CC)$ for now.
\begin{definition}
    A \dfn{positive Radon measure} on $X$ is a functional on $C_c(X)$.
\end{definition}
Let us prove that a positive Radon measure is actually a measure in a natural way. First, we put a topology on $C_c(X)$. We start by putting the $L^\infty$-topology on $C_c(U)$ for each open set $U \subseteq X$ with compact closure.
\begin{definition}
    The \dfn{inductive limit topology} of $C_c(X)$ is the final (i.e. strongest) topology on $C_c(X)$ such that $\varphi: C_c(X) \to Y$ is continuous provided that for each open set $U \subseteq X$ with compact closure, $\varphi|_{C_c(U)}$ is continuous.
\end{definition}
In other words, the inductive limit topology is the final topology which makes the natural maps $C_c(U) \to C_c(X)$ continuous. A positive Radon measure is continuous for the inductive limit topology, as can be seen by taking an $h \in C_c(X)$ which is $1$ on $U$, so $||\varphi||_{C_c(U)} \leq \varphi(h)$.

Now we need some general facts about locally compact Hausdorff spaces.
\begin{definition}
    A (continuous) \dfn{partition of unity} on a subordinate to an open cover $U_1, \dots, U_n$ is a family of (continuous) functions $f_1, \dots, f_n$ which are compactly supported in $U_i$, such that $\sum_i f_i = 1$.
\end{definition}
\begin{theorem}
    \label{partitions of unity}
    For any finite open cover $\mathcal U$ of a compact set, there is a partition of unity subordinate to $\mathcal U$.
\end{theorem}
\begin{lemma}
    Let $K \subseteq X$ be compact. If $U_1, \dots, U_n$ is an open cover of $K$ there are compact sets $K_1, \dots, K_n$, $K_i \subseteq U_i$, which cover $K$.
\end{lemma}
\begin{proof}
    For each $x \in K$ choose a $j$ such that $U_j \ni x$ and an open set $V_x \ni x$ such that
    $$V_x \subset \overline V_x \subset U_j.$$
    Then the $V_x$ are an open cover of $K$ so they reduce to a finite subcover $V_{x_1}, \dots, V_{x_p}$. For each $k \leq p$ choose a $j_k \leq n$ such that $V_{x_k} \subseteq U_{j_k}$ and let $W_j = \bigcup_{j_k=j} V_k \subseteq U_j$. Then $\overline W_j \subseteq U_j$ and the $\overline W_j$ contain the $V_x$s, so are a compact cover of $K$.
\end{proof}
\begin{proof}[Proof of Theorem \ref{partitions of unity}]
    Fix a compact set $K$. By the lemma, we can choose $D_j \subseteq U_j$ a compact cover of $K$ and $g_j$ supported in $U_j$ with $g_j \geq 1$ on $D_j$, and $h = \sum_j g_j$. Then $h \geq 1$ on $C$ and put $k = h \vee 1 \geq 1$. So $1/k$ exists and we can put $f_j = g_j/k$, to force $\sum_j f_j = 1$.
\end{proof}

\begin{definition}
    A \dfn{content} is a function defined on sets into $[0, \infty]$ which is monotone, countably subadditive, and finitely additive, and which carries compact sets to $[0, \infty)$. A content $\mu$ is said to be \dfn{inner regular} if for every open set $U$,
    $$\mu(U) = \sup_{\substack{\overline V \subseteq U\\V \text{open}\\\overline V \text{compact}}} \mu(V).$$
\end{definition}
Fix a positive Radon measure $\varphi$, and define an inner-regular content $\mu$ on the topology $\mathcal T$ on $X$ by
\begin{align*}
    \mu: \mathcal T &\to [0, \infty]\\
    U &\mapsto \sup_{\substack{f \in C_c(U)\\0 \leq f \leq 1}} \varphi(f).
\end{align*}
Given a content $\nu$, we can extend $\nu$ to an outer measure $\nu^*$ on the power set $\pset$ by
$$\nu^*(A) = \inf_{\substack{U \subseteq A\\U \in \mathcal T}} \nu(U).$$
In turn, then, $\nu^*$ restricts to a measure, also called $\nu$, on its measurable $\sigma$-algebra, by the Caratheodory construction. So, in particular, $\mu$ gives rise to a measure.

\begin{definition}
    Let $\nu$ be a Borel measure. We say that $\nu$ is \dfn{outer regular} if for every Borel set $E$,
    $$\mu(E) = \inf_{\substack{E \subseteq U\\U \in \mathcal T}} \mu(U)$$
    and \dfn{inner regular} if for every \emph{open} set $U$,
    $$\mu(U) = \sup_{\substack{\overline V \subseteq U\\V \text{open}\\\overline V \text{compact}}} \mu(V).$$
\end{definition}
    We state the main result.
\begin{theorem}[Riesz-Markov representation theorem]
    \index{Riesz-Markov representation theorem}
    $\mu$ is a positive Borel measure which is both inner and outer regular, and $\varphi$ is the unique functional such that for every $f \in C_c(X)$,
    $$\varphi(f) = \int f~d\mu.$$
\end{theorem}
    The proof of the Riesz-Markov representation theorem is quite long, so we only sketch it.
\begin{proof}[Proof sketch]
    Let $\nu^*$ be an outer measure which is finitely additive and inner regular on the topology of $X$, and let $U$ be open. Then Caratheodory's criterion holds for $U$ and $\nu^*$ on open sets. Approximating any subset of $X$ by an open set, Caratheodory's criterion holds on the power set for $U$ and $\nu^*$. So $U$ is $\nu^*$-measurable, and $\nu^*$ restricts to a Borel measure $\nu$. In particular, $\mu$ is a Borel measure.

    If $f \in C_c(X)$, and $f \geq 1$ on an open set $U$, $\varphi(f) \geq \mu^*(U)$. Approximating any set $A$ by an open set, we see that $\varphi(f) \geq \mu^*(A)$ whenever $f \geq 1$ on $A$. On the other hand, if $f \leq 1$ on $A$, a monotone convergence argument shows that $\mu^*(A) \geq \varphi(f)$. Since $C_c(X)$ is a Banach lattice, we can replace $f$ with $f^+$ and by decomposing $X$ into a chain of sets $X_n \{x \in X: f(x) \geq n\varepsilon\}$ and summing the $f|_{X_n} \setminus f|_{X_{n-1}}$ we prove
    $$\varphi(f) = \int f~d\mu.$$

    Since $\mu$ was inner and outer regular as a content, approximation by open sets implies regularity on Borel sets. Moreover, if $\psi$ is a positive Radon measure, define a content $\nu$ by
    $$\nu(U) = \sup_{\substack{f \leq \chi_U\\f \in C_c(U)}} \int f ~d\nu.$$
    If $\nu = \mu$ it follows that $\psi = \varphi$.
\end{proof}
    Notice that on the other hand, a complex measure $\nu$ on $C_c(X)$ gives rise to a functional $\psi$ by
    $$\psi(f) = \int f ~d\nu.$$
    The positive part of $\psi$ is in fact the positive part of $\nu$.

    Now if $S$ is a locally compact semigroup, we let $M(S)$ be the set of all finite Radon measures on $S$. This is a convolution algebra, with
    $$\mu*\nu(f) = \iint_S f(xy) ~d\mu(x) ~d\nu(y).$$

\section{Baire categories}
    Now we look at a topological analogue of ``measure zero."
\begin{definition}
    Let $X$ be a topological space. A set $S \subseteq X$ is \dfn{nowhere dense} if for every open set $U$, $S \cap U$ is not dense in $U$. A set $T \subseteq X$ is \dfn{meager} or \dfn{of the first category} if $T$ is the countable union of nowhere dense sets. A set $W \subseteq X$ is \dfn{of the second category} if it is not of the first category, or \dfn{comeager} if it is the complement of a meager set.
\end{definition}
\begin{lemma}
    For a topological space, the following are equivalent:
\begin{enumerate}
    \item Every countable union of closed sets with empty interior has empty interior.
    \item Every countable intersection of open dense sets is dense.
    \item Every nonempty open set is of the second category.
\end{enumerate}
\end{lemma}
    This is basically obvious.
\begin{definition}
    A topological space is a \dfn{Baire space} if one (and all) of the above criteria hold.
\end{definition}
\begin{theorem}[Baire category theorem]
    \index{Baire category theorem}
    Every completely pseudometrizable or locally compact Hausdorff space is Baire.
\end{theorem}
    For example, a Banach space is Baire.
\begin{proof}
    Let $U_n$ be a sequence of open dense sets, and let $W$ be open, in the space $X$. Then $W \cap U_1$ is nonempty and open, say $x_1 \in W \cap U_1$. If $X$ is pseudometrizable, then there is a $\varepsilon_1 \in (0, 1)$ such that the open ball $V_1 = B(x_1, \varepsilon_1)$ satisfies $K_1 = \overline B(x_1, \varepsilon_1) \subseteq W \cap U_1$; if $X$ is locally compact Hausdorff, then there is a compact set with nonempty interior $V_1 \subseteq K_1 \subseteq W \cap U_1$. Iterate using the denseness of the $U_n$ and the axiom of choice to construct a sequence $x_n \in V_n \subseteq K_n \subseteq V_{n-1} \cap U_n$. If $X$ is pseudometrizable, then we can always choose $\varepsilon_n < 1/n$, so the $x_n$ are a Cauchy sequence. Otherwise, $\bigcap_n K_n$ is nonempty anyways by the finite intersection property. Either way, we can find an $x \in \bigcap_n K_n \subseteq \bigcap_n U_n$ such that $x \in W$. So $\bigcap_n U_n$ is dense.
\end{proof}
Actually, we didn't use the full axiom of choice. The Baire category theorem is equivalent over ZF to the following axiom.
\begin{axiom}[Axiom of dependent choice]
    \index{axiom of dependent choice}
    Let $X$ be a nonempty set and $R$ be a binary relation. If, for every $a \in X$, there is a $b \in X$ such that $aRx$, then there is a sequence of $x_n$ such that $x_nRx_{n+1}$.
\end{axiom}
The axiom of dependent choice is not strong enough to prove the existence of nonmeasurable sets, for example. Moreover, if $X$ is assumed to be separable, then the Baire category theorem just follows from induction, without even dependent choice.

\begin{theorem}[uniform boundedness principle]
    \index{uniform boundedness principle}
    Let $X$ be a Banach space and $Y$ a normed space, and $F$ be a set of linear mappings $X \to Y$. If for every $x \in X$,
    $$\sup_{T \in F} ||Tx|| < \infty,$$
    then
    $$\sup_{\substack{T \in F\\||x|| = 1}} ||Tx|| = \sup_{T \in F} ||T||.$$
\end{theorem}
The uniform boundedness principle is also called the Banach-Steinhaus theorem.\index{Banach-Steinhaus theorem} The proof is a standard application of the Baire category theorem: construct a chain of closed sets whose union is the entire space, which implies that one is not meager.
\begin{proof}
    Let
    $$X_n = \{x \in X: \sup_{T \in F} ||Tx|| \leq n\}.$$
    Then the $X_n$ are a closed chain whose union is $X$. So by the Baire category theorem, there is an $x \in X$, $m > 0$, and $\varepsilon > 0$ such that $B(x, \varepsilon) \subset X_m$. So if $||u|| < 1$ and $T \in F$,
\begin{align*}
    ||Tu|| &= \varepsilon^{-1} ||T(x + \varepsilon u) - Tx||
        \leq \varepsilon^{-1} ||T(x + \varepsilon u)|| + \varepsilon^{-1} ||Tx||
        \leq 2\frac{m}{\varepsilon}.
\end{align*}
    Taking the $\sup$ over $u$ of both sides,
    $$\sup_{T \in F} ||T|| \leq 2\frac{m}{\varepsilon} < \infty.$$
\end{proof}
\begin{theorem}[open mapping theorem]
    \index{open mapping theorem}
    If $A: X \to Y$ is a surjective continuous linear mapping between Banach spaces, then $A$ is open.
\end{theorem}
The open mapping theorem is also called the Banach-Schauder theorem.\index{Banach-Schauder theorem}
\begin{proof}
    We must show that if $U$ is the open unit ball of $X$, then $A(U)$ is open. Since $X = \bigcup_k kU$, $Y = \bigcup_k A(kU)$. By the Baire category theorem, there is a $k > 0$, $\varepsilon > 0$, and $y \in Y$ such that $B(y, \varepsilon) \subseteq \overline{A(kU)}$. If $V$ is the unit ball of $Y$, $v \in V$, $y+\varepsilon v \in \overline{A(kU)}$ so
    $$\varepsilon v \in \overline{A(kU)} + \overline{A(kU)} \subseteq \overline{A(2kU)}.$$
    So if $L = 2k/\varepsilon$, $V \subseteq \overline{A(LU)}$.

    In other words, for every $y \in Y$ and $\varepsilon > 0$ there is an $x \in X$ such that $||x|| \leq L||y||$ and $||y-Ax|| < \varepsilon$. In particular, given $y \in V$ we can choose $x_1$ such that $||x_1|| \leq L$ and $||x-Ax_1|| < 1/2$. Choose $||x_{n+1}|| \leq L2^{-n}$ such that
    $$||y - A(x_1 + \dots + x_n) - Ax_{n+1}|| < 2^{-n-1},$$
    by induction and the axiom of (dependent) choice. The sequence of partial sums is therefore Cauchy, so we can put $x = \sum_n x_n$, and $Ax = y$ by the above estimates. Also
    $$||x|| = \lim_{n \to \infty} \left|\left| \sum_{k\leq n} x_k\right|\right| \leq \sum_{n=1}^\infty x_n < 2L.$$
    So $y \in A(2LU)$. Therefore $V \subseteq A(2LU)$ which was to be shown.
\end{proof}
\begin{theorem}[closed graph theorem]
    Let $A: X \to Y$ be a linear mapping between Banach spaces. If the graph of $A$ is closed in $X \oplus Y$, then $A$ is continuous.
\end{theorem}
    Notice that while there isn't a canonical norm for $X \oplus Y$, any $\ell^p$ norm will do; since $X \oplus Y$ is a finite direct sum, all $\ell^p$ norms are equivalent. In particular, $X \oplus Y$ is a Banach space.
\begin{proof}
    Let $\Gamma$ be the graph of $A$, which is equipped with a natural (linear, bijective) projection $\pi_X: \Gamma \to X$. Since
    $$||P(x, Ax)|| = ||x|| \leq ||(x, Ax)||,$$
    $||P|| \leq 1 < \infty$. So by the open mapping theorem,
    $$||Tx|| \preceq ||P^{-1}x|| + ||x|| \preceq ||x||.$$
\end{proof}


\chapter{Complex analysis}
Throughout, we identify $\RR^2 = \CC$ and write $z = x + iy$, $dz = dx + idy$, so that $d\overline z = dx - i dy$. Then
$$dz \wedge d\overline z = 2i dx \wedge dy = 2i dA.$$
We thus write $2 \partial f = \partial_x f - i\partial_y f$ and $2\overline f = \partial_x f + i\partial_y f$, so that
$$df = \partial f ~dz + \overline \partial f ~d\overline z.$$
We let $K$ be a compact set in an $\Omega$-precompact open set $\omega$, where $\Omega$ is open in $\CC$. So we have inclusions
$$K \subset \omega \subset \overline \omega \subset \Omega \subseteq \CC.$$
We will always assume that $\partial \omega$ is a positively oriented, piecewise-$C^1$ Jordan curve.

\section{Cauchy-Green formula}
Making the change of variable $dA \mapsto dz \wedge d\overline z$ in Green's formula, we arrive at the following generalization of the Cauchy integal formula.
\begin{theorem}[Cauchy-Green]
    \index{Cauchy-Green formula}
    Let $f \in C^1(\omega)$. For each $\zeta \in \omega$,
    $$f(\zeta) = \frac{1}{2\pi i}\left(\int_{\partial\omega} \frac{f(z)}{z - \zeta}dz + \iint_\omega \frac{\overline \partial f(z)}{z - \zeta} ~dz \wedge d\overline z\right).$$
\end{theorem}
\begin{definition}
    The \dfn{Cauchy-Riemann equation} is the equation
    $$\overline \partial f = 0.$$
    If $f \in C^1(\omega)$ solves the Cauchy-Riemann equation, we say that $f$ is a \dfn{holomorphic function}, written $f \in A(\omega)$.
\end{definition}
So in case $f$ is holomorphic, we recover the classical Cauchy integral formula from the Cauchy-Green theorem.
\begin{theorem}
    Let $\mu$ be a finite Borel measure on $\CC$ with compact support $K$. Let
    $$u(\zeta) = \int_\CC \frac{d\mu(z)}{z - \zeta}.$$
    Then $u$ is holomorphic on $K^c$. If $\varphi \in C^k(\omega)$ and $2\pi i \mu = \varphi ~dz\wedge d\overline z$, then $u \in C^k(\omega)$ and $\overline u = \varphi$ on $\omega$. In particular, if $\mu$ solves the Cauchy-Riemann equation in the distributional sense, then $\mu$ is holomorphic.
\end{theorem}
\begin{corollary}[Cauchy]
    \index{Cauchy's inequality}
    If $u \in A(\Omega)$ then
    $$||\partial^j u||_{L^\infty(K)} \preceq_{K,j} ||u||_{L^1(\omega)}.$$
\end{corollary}
\begin{proof}
    Differentiate under the integral sign in the Cauchy-Green formula, and then use the triangle inequality.
\end{proof}
\begin{corollary}
    If we are given a sequence of $u_n \in A(\Omega)$ which converges locally uniformly to $u$, then $u \in A(\Omega)$.
\end{corollary}
\begin{proof}
    This is obvious for uniform convergence, but holomorphy is a local property.
\end{proof}
\begin{corollary}[Montel]
    \index{Montel's theorem}
    If we are given a sequence in $A(\Omega)$ which is locally bounded, then there is a locally uniformly convergent subsequence, whose limit is in particular holomorphic.
\end{corollary}
\begin{proof}
    Use Arzela-Ascoli on Cauchy's inequality. Then use locally uniform convergence.
\end{proof}
\begin{corollary}[root test]
    \index{root test}
    If $u(z) = \sum_n a_nz^n$, then $u$ is analytic on $D(0, \limsup_n |a_n|^{1/n})$.
\end{corollary}
\begin{corollary}[Taylor]
    \index{Taylor's theorem}
    If $u \in A(D(0, R))$, then $u \in C^\infty(D(0, R))$ and for $z \in D(0, R)$ we have
    $$u(z) = \sum_{n=0}^\infty \frac{\partial^n u(0)}{n!} z^n.$$
\end{corollary}
\begin{proof}
    Differentiate under the integral sign in the Cauchy-Green formula, then use the root test.
\end{proof}
\begin{corollary}
    If $\Omega$ is connected and $u \in A(\Omega)$, and there is a $z \in \Omega$ such that for all $j$, $\partial^ju(z) = 0$, then $u = 0$.
\end{corollary}
\begin{proof}
    Taylor series propagate to connected components.
\end{proof}
\begin{corollary}[Weierstrass preparation theorem]
    \index{Weierstrass preparation theorem}
    If $u \in A(\Omega)$, $0 \in \Omega$, $u \neq 0$, and $u(0) = 0$ with order $k$, then there is a $v \in A(\Omega)$ so that $u(z) = z^k v(z)$.
\end{corollary}
\begin{proof}
    Factor the $z^k$ out of the Taylor series.
\end{proof}
\begin{corollary}
    If $u \in A(\omega) \cap C(\overline \omega)$ then
    $$||u||_{L^\infty(\omega)} = ||u||_{L^\infty(\partial \omega)}.$$
\end{corollary}

\section{Conformal mappings}
\begin{definition}
\index{function!biholomorphic}
\index{function!conformal}
\index{function!angle-preserving}
\index{set!conformal}
\index{set!conformally equivalent}
\index{complex diffeomorphism}
A function between open sets $f: U \to V$ is \emph{biholomorphic}, \emph{conformal}, \emph{angle-preserving}, or a \emph{complex diffeomorphism} if $f$ is a bijection and $f$ and $f^{-1}$ are both holomorphic.

If such a conformal map exists then $U$ and $V$ are \emph{conformally equivalent} or \emph{conformal}.
\end{definition}


\begin{lemma}
\label{rotation of the disk}
Let $F: \DD \to \DD$ be conformal and $F(0) = 0$. Then $\exists \omega \in S^1$ such that for each $z \in \DD$,
$$F(z) = \omega z.$$
\begin{proof}
Apply Schwarz to $F$ and $F^{-1}$ so that
$$|z| \leq |F(z)| \leq |z|.$$
\end{proof}
\end{lemma}

\begin{theorem}
\label{automorphism of the disk}
\index{automorphism of the disk}
$F: \DD \to \DD$ is conformal if and only if there exist unique $a \in \DD$ and $\omega \in S^1$ such that
$$F(z) = \omega \frac{z - a}{1 - \overline a z}.$$
Moreover, $a$ can be chosen so that $F(a) = 0$, and
$$F^{-1}(z) = \omega^{-1} \frac{z + a}{1 + \overline a z}.$$
\begin{proof}
Suppose that $F$ is conformal and let $G: \DD \to \DD$ be given by
$$G(z) = \frac{z - a}{1 - \overline a z}.$$
Then since $|\overline a z| < 1$, $G \circ F^{-1}$ is conformal and $G(a) = 0$, thus $G \circ F^{-1}(0) = 0$. So by \ref{rotation of the disk}, $G \circ F^{-1}(z) = \omega z$ for some $\omega \in S^1$. Existence of $\omega$ is immediate (how could one rotate the disk at two different speeds?) and since $a$ is determined by the preimage of $0$, $a$ is unique as well.

On the other hand, if
$$F(z) = \omega \frac{z - a}{1 - \overline a z},$$
then since $|\overline a z| < 1$, $F$ is holomorphic, as is its inverse (that it actually is an inverse is immediate).
\end{proof}
\end{theorem}

\begin{theorem}[Riemann mapping theorem]
\index{Riemann mapping theorem}
If $U \subseteq \CC$ is open and simply connected, then $U$ is conformal with $\DD$ or $\CC$.
\end{theorem}

\begin{lemma}
\label{riem 1}
\index{Riemann mapping theorem!proof}
Suppose that $U \neq \CC$ is simply connected and $z_0 \in U$. Then the space
$$\FF = \{f: U \to \DD \, | \, f \text{ is holomorphic and injective, and } f(z_0) = 0\}$$
is a nonempty normal family.
\begin{proof}
For convenience, let $V$ be the strip
$$V = \{z \in \CC: |\Im z| < \pi\}.$$
Let $a \notin U$ and observe that $z - a \neq 0$. Since $\exp$ has a period of $2\pi i$, $\exp$ is a conformal map $V \to \CC \setminus \{0\}$. In particular, its inverse $\log$ is conformal $\CC \setminus \{0\} \to V$. Now let $\ell(z) = \log(z - a)$; $\ell$ is holomorphic and injective.

Suppose that there does not exist $\delta > 0$ such that for each $z \in U$,
$$|\ell(z) - \ell(z_0) - 2\pi i| < \delta.$$
Then there is a sequence $z_n$ in $U$ such that $\ell(z_n) \to \ell(z_0) + 2\pi i$. By continuity of $\exp$, $z_n \to z_0 e^{2\pi i} = z_0$. So $\ell(z_n) \to \ell(z_0) \neq \ell(z_0) + 2\pi i$, which is a contradiction, so $\delta$ exists.

Let
$$g(z) = \frac{1}{\ell(z) - \ell(z_0) - 2\pi i}.$$
Then $g$ is clearly injective and holomorphic and $|g| < \delta^{-1}$, so $g$ is bounded, and
$$f(z) = \frac{g(z) - g(z_0)}{\delta^{-1} + |g(z_0)|}$$
satisfies $f \in \FF$. Thus $\FF$ is nonempty.

Moreover, each $f \in \FF$ satisfies $|f| < 1$, so $\FF$ is uniformly bounded by $1$; therefore $\FF$ is normal by Montel's theorem.
\end{proof}
\end{lemma}

\begin{lemma}
\label{riem 2}
With $\FF$ and $z_0$ as in \ref{riem 1}, there exists a conformal $F \in \FF$ and if
$$\lambda = \sup_{f \in \FF} |f'(z_0)|$$
then $|F'(z_0)| = \lambda$.
\end{lemma}

$\FF$ is precompact in $\OO$, but this doesn't mean that $\FF$ is compact! So, while we want to use compactness to prove the existence of a function $F$ that satisfies the desired hypotheses, we'll have to prove that in fact $F \in \FF$ rather than $F \in \partial \FF$.

\begin{proof}[Proof of \ref{riem 2}]
Since elements of $\FF$ are injective, their derivatives are nonzero by the argument principle, so $\lambda > 0$, and there is a sequence $f_n$ such that $|f_n'(z_0)| \to \lambda$. By Montel's theorem, it has a convergent subsequence with a limit $F \in \OO$, such that $F(z_0) = 0$ and $F'(z_0) = \lambda$ by Weierstrass' theorem. Moreover, $|F| \leq 1$. $F$ is nonconstant since $\lambda > 0$, so by the open mapping theorem, $|F| < 1$, and by Hurwitz' theorem, $F$ is injective. Therefore $F \in \FF$.

Moreover, if $F$ is not surjective, then there exists $w \in \DD \setminus F(U)$. Let
$$\psi(z) = \frac{w - z}{1 - \overline wz}.$$
By \ref{automorphism of the disk}, $\psi$ is an automorphism of $\DD$, $\psi(w) = 0$ and $|\psi \circ F| > 0$. Now define
$$g(z) = \exp\left(\frac{\log \psi(F(z))}{2}\right).$$
Then $g(z_0) = \sqrt w$.
By \ref{automorphism of the disk} again,
$$\tilde \psi(z) = \frac{\sqrt w - z}{1 - \overline{\sqrt w} z}$$
is also an automorphism of $\DD$ and $\tilde \psi(\sqrt w) = 0$. Let $G = \tilde \psi \circ g$. Then $G \in \FF$.

Now let $s(z) = z^2$ and $\varphi = \psi^{-1} \circ s \circ \tilde \psi^{-1}$. Then $\varphi(0) = 0$ so by Schwarz $|\varphi(z)| \leq |z|$. Moreover, $\varphi$ is not injective anywhere, so $|\varphi'| < 1$. But $F = \varphi \circ G$ so
$$\lambda = |F'(z_0)| = |\varphi'(0) G'(z_0) | < |G'(z_0)| \leq \lambda$$
which is a contradiction.

So $F$ is surjective. Therefore the inverse function theorem implies that $F$ is conformal.
\end{proof}
Clearly this lemma implies the Riemann mapping theorem.




\section{Approximation by polynomials}
Let $K \subset \Omega \subseteq \CC$ be compact. If $K$ is the compactification of a disc, then it is easy to uniformly approximate holomorphic functions on $K$ by polynomials, just by truncating the Taylor series.

\begin{example}
    Let $K$ be the compactification of an annulus and assume $u$ has a pole in the center of $K$. If $p_j \to u$ on $K$ and the $p_j$ are entire functions, then in particular $p_j \to u$ on $\partial K$, so they are a Cauchy sequence in $A(K)$, so on a disk containing $K$, and in particular the pole of $u$. Therefore $p_j \to p$, an entire function, even though $u$ has a pole. Notice that we can still approximate $u$ by meromorphic functions, though.
\end{example}
\begin{theorem}[Runge approximation theorem]
    \index{Runge approximation theorem}
    The following are equivalent.
\begin{enumerate}
    \item If $u$ is holomorphic near $K$, then there are functions $u_j \in A(\Omega)$ such that $u_j \to u$ uniformly on $K$.
    \item The complement $\Omega \setminus K$ has no $\Omega$-precompact connected components.
    \item For each $z \in \Omega \setminus K$ there is an $f \in A(\Omega)$ such that
    $$|f(z)| > ||f||_{L^\infty(K)}.$$
\end{enumerate}
\end{theorem}
\begin{proof}
    Let us first prove that not-2 implies not-3 and not-1.

    If not-2, then there is a $K$-precompact component $O$ of $\Omega \setminus K$, so $\partial O \subseteq K$. If $f \in A(\Omega)$, then
    $$||f||_{L^\infty(O)} = ||f||_{L^\infty(\partial O)} \leq ||f||_{L^\infty(K)}$$
    by the maximum principle, implying not-3. Moreover, if 1 were true, then for every $f$ holomorphic near $K$, we could approximate $f$ by $f_j \in A(\Omega)$ uniformly. We have
    $$||f_j - f_k||_{L^\infty(\overline O)} \leq ||f_j - f_k||_{L^\infty(K)},$$
    so the $f_j$ form a Cauchy sequence in $L^\infty(K)$, which converge to a holomorphic function $F \in A(O)$. But if $f$ has a pole in $O$, then $f \neq O$, a contradiction, so we have not-1.

    Now we show 1 and 2 imply 3. Let $L = K \cup \overline{D(z, \varepsilon)}$ where $\epsilon < d(z, K)$. Then every component of $L$ is either a component of $K$ or else $\overline{D(z, \varepsilon)}$, and $L$ satisfies the hypotheses of 2, so in particular satisfies the hypotheses of 1. Let $u \in A(L)$ be given by $u = 1$ near $z$ and $u$ on $K$. By 1, $u$ is uniformly approximable in $A(\Omega)$. Assume $f \in A(\Omega)$ is such that $||f - u||_{L^\infty(L)} < \delta$ for $\delta$ small enough; then $f$ witnesses 3.

    Finally we show 2 implies 1. Let $X_2$ be the set of restrictions of holomorphic functions to $K$, and let $X_1$ be the set of restrictions of holomorphic functions on $\Omega$ to $K$. Then $X_1 \subset X_2 \subset C(K)$, and 1 holds iff $\overline{X_1} = \overline{X_2}$. So we must show $\overline{X_2} \subseteq \overline{X_1}$. By the Hanh-Banach and Riesz-Markov theorems, this is equivalent to showing that for every finite Borel measure $\mu$ with support in $K$ and every $f \in A(\Omega)$, $\int f ~d\mu = 0$. In particular, we can prove this with the addition assumption that $f$ is only holomorphic near $K$. So fix such a $f, \mu$.

    Let $\varphi$ be the holomorphic function given by $\mu$. Since $\varphi = 0$ on $\CC \setminus \Omega$, $\varphi = 0$ on any component of $\CC \setminus K$. Moreover,
    $$\frac{1}{z - \zeta} = -\sum_{j=0}^\infty \zeta^{-j-1}z^j$$
    whenever the sum converges, i.e. for $|\zeta|$ large enough. Therefore
    $$\varphi(\zeta) = -\sum_{j=0}^\infty \zeta^{-j-1} \int z^j ~d\mu(z) = 0$$
    for $|\zeta|$ large enough. By 2, $\Omega \setminus K$ has no $\Omega$-precompact components, so every component of $\Omega \setminus K$ touches $\partial \Omega$ or is unbounded. Therefore $\varphi = 0$ on $\CC \setminus K$.

    Let $\psi$ be a cutoff which is $1$ whenever $f$ is holomorphic. Then, taking $\omega = \CC$, we have
    $$\psi(z) = \frac{1}{2\pi i}\iint_\CC \frac{\overline \partial \psi(\zeta)}{\zeta - z} d\overline \zeta \wedge d\zeta.$$
    For each $z \in K$, the function
    $$\zeta \mapsto \frac{\overline \partial \psi(\zeta) f(\zeta)}{\zeta - z}$$
    is smooth since $\zeta \notin K$. So we are entitled to use Fubini's theorem to prove
\begin{align*}
    \int_\CC f ~d\mu &= \int_\CC \psi f ~d\mu
        = \frac{1}{2\pi i} \iiint_{\CC^2} \frac{\overline \partial \psi(\zeta) f(\zeta)}{\zeta - z} ~d\overline \zeta \wedge d\zeta ~d\mu(z)\\
        &= \frac{1}{2\pi i} \iint_\CC f(\zeta) \overline \partial \psi(\zeta) \int_\CC \frac{d\mu(z)}{\zeta - z} ~d\overline \zeta \wedge d\zeta
        = 0.
\end{align*}
    This proves 1.
\end{proof}
\begin{corollary}
    Let $K \subset \CC$ be compact, such that $\CC \setminus K$ is connected. Every function which is holomorphic near $K$ can be approximated by polynomials uniformly on $K$.
\end{corollary}
\begin{definition}
    The \dfn{holomorphically convex hull} of $K$ in $\Omega$, written $\hat K$, is the set of $z \in \Omega$ such that for every $f \in A(\Omega)$,
    $$|f(z)| \leq ||f||_{L^\infty(K)}.$$
    If $K = \hat K$, we say that $K$ is \dfn{holomorphically convex}.
\end{definition}
\begin{example}
    Let $K$ be as in the previous example; then $\hat K$ is the outer disc in the definition of $K$ as an annulus.
\end{example}
It is easy to check that
$$d(K, \CC \setminus \Omega) = d(\hat K, \CC \setminus \Omega).$$

Recall that $\ch K$ denotes the convex hull of $K$. If $K$ is convex, then $K$ is topologically $\overline{D(0, 1)}$, which is clearly holomorphically convex by Runge's approximation theorem. But the connection between convexity and holomorphic convexity is stronger than that.
\begin{proposition}
    For any $K$, $\hat K \subseteq \ch K$.
\end{proposition}
\begin{proof}
    It is easy to check that $\ch K$ is the intersection of half-planes
    $$H_{a,c} = \{z \in \CC: \Re(az) \leq c\}.$$
    Fix $a \in \CC$, $c \in \RR$; we will show $\hat K \subset H_{a,c}$. Let $z \in \hat K$. Then $|e^{az}| \leq \max_{w \in K} |e^{aw}|$. So $\Re e^{az} \leq \max_{w \in W} \Re |e^{aw}|$, implying
    $$\Re az \leq \max_{w \in K} aw \leq c.$$
    Therefore $z \in \hat K$.
\end{proof}
Moreover, $\hat K$ is the union of $K$ with all $\overline O$, for each $\CC$-precompact connected component $O$ of $\Omega \setminus K$.

\begin{definition}
    The \dfn{polynomially convex hull} of a compact set $K$ is the set
    $$\hat K = \{z \in \CC: |p(z)| \leq \max_{w \in K} |p(w)| \text{for every polynomial} p\}.$$
    If $K = \hat K$, then $K$ is \dfn{polynomially convex}.
\end{definition}

\section{Sheaves}
Let $X$ be a topological space. By $\Open(X)$ we will denote the posetal category of open sets in $X$; that is, objects are open sets in $X$ and morphisms are inclusions.

\begin{definition}
    A \dfn{presheaf} on $X$ is a functor $\Open(X)^{op} \to C$ for some concrete category $C$.

    If $U \subseteq X$ is an open set, and $\mathcal F: \Open(X)^{op} \to C$ a presheaf on $X$, then elements of $\mathcal F(U)$ are called \dfn{sections} of $\mathcal F$ at $U$. Sections of $\mathcal F$ at $X$ are called \dfn{global sections}.
\end{definition}
To motivate this terminology, let us assume that we are given a fiber bundle $\pi: E \to X$ (the most trivial case of this is when $E = X \times Y$ for some space $Y$, and $\pi$ is projection onto the first factor; as with any notion of bundle, the point is that $E$ is locally a product space.) Then the sections of $\pi$, i.e. the sets $\pi^{-1}(U)$, are exactly a sheaf (to be defined later), and thus a presheaf, $\Open(X)^{op} \to \Set$.

Now notice that every morphism in $\Open(X)^{op}$ is epic, so it makes sense to define the restriction maps $f \mapsto f|_V$ for sections $f \in \mathcal F(U)$ and $V \subseteq U$.

\begin{definition}
    Let $\mathcal F: \Open(X)^{op} \to C$ be a presheaf on $X$. Assume that for every open set $U \in \Open(X)$ and every open cover $\{U_j\}$ of $U$ we have the following conditions:
\begin{enumerate}
    \item For every pair of sections $f,g \in \mathcal F(U)$, if we have $f|_{U_i} = g|_{U_i}$ for every $i$, then $f = g$.
    \item If for every $i$ we have a section $f_i \in \mathcal F(U_i)$ such that on intersections, $f_i|_{U_i \cap U_j} = f_j|_{U_i \cap U_j}$, then there is a section $f \in \mathcal F(U)$ such that for every $i$, $f|_{U_i} = f_i$.
\end{enumerate}
    Then we say that $\mathcal F$ is a \dfn{sheaf} on $X$.
\end{definition}
\begin{proposition}
    Let $\mathcal F$ be a sheaf which is only defined on an open base, but otherwise satisfying all the conditions. Then $\mathcal F$ uniquely determines a sheaf on the entire topology.
\end{proposition}

    We now put sheaves into a category.
\begin{definition}
    Let $\mathcal F, \mathcal G: \Open(X)^{op} \to C$ be presheaves. A \dfn{morphism of presheaves} over $X$ is a natural transformation $\psi: \mathcal F \to \mathcal G$. If $\mathcal F$ and $\mathcal G$ are sheaves, then $\psi$ is a \dfn{morphism of sheaves}.
\end{definition}
That is, a morphism of sheaves $\psi: \mathcal F \to \mathcal G$ consists of, for each open set $U \subseteq X$, a morphism $\psi(U) \in \Hom(\mathcal F(U), \mathcal G(U))$ such that if $U \subseteq V$ for some open set $V \subseteq X$, then the diagram
$$\begin{tikzcd}
\mathcal F(V) \arrow[r,"\psi(V)"] \arrow[d] &\mathcal G(V) \arrow[d]\\
\mathcal F(U) \arrow[r,"\psi(U)"] &\mathcal G(U)
\end{tikzcd}$$
commutes.

In several complex variables, we are interested in holomorphic germs. The following family of definitions allows us to talk about germs algebraically.
\begin{definition}
    Let $C$ be a category such that for every directed set $\mathcal D$ in $C$, a colimit exists at $\mathcal D$, and let $x \in X$. Let $\mathcal F: \Open(X)^{op} \to C$ be a sheaf. The \dfn{stalk} of $\mathcal F$ at $x$ is the colimit
    $$\mathcal F_x = \varinjlim_{U \in \mathcal D_x} \mathcal F(U)$$
    where $\mathcal D_x$ is the directed set of all open sets $U \ni x$. An element of $\mathcal F_x$ is called a \dfn{germ} of $\mathcal F$ at $x$.
\end{definition}




\section{Subharmonicity}
\begin{definition}
    Let $X$ be a topological space. An \dfn{upper-semicontinuous function} on $X$ is a function $u: X \to [-\infty, \infty)$ such that for each $s \in \RR$, the preimage of the ray $[-\infty, s)$ is open in $X$.
\end{definition}
Notice that there is a dual notion of lower-semicontinuity, by considering the rays $(s, \infty]$. A function which is both upper- and lower-semicontinuous is just continuous, since open rays form a base of the topology of $\RR$.

\begin{definition}
    Let $\Omega \subseteq \RR^n$ be an open set. A \dfn{subharmonic function} on $\Omega$ is a upper-semicontinuous function $u: \Omega \to [-\infty, \infty)$ such that for every compact set $K \subseteq \Omega$ and every continuous function $h: K \to \RR$ which is harmonic in $K$, if $h \leq u$ on $\partial K$, then $h \leq u$ on $K$.
\end{definition}
This definition makes just as much sense in $\CC^n$, or even on a Riemannian manifold; one just needs a Laplace-Beltrami operator $\Delta_g$, so that we have a notion of harmonicity $\Delta_g h = 0$. By the maximum modulus principle, a harmonic function is already subharmonic (since it cannot attain its maximum on the boundary of a compact set).

Let $u$ be subharmonic. Then if $c > 0$, $cu$ is subharmonic (simply by replacing $h$ with $ch$ for each $h$ in the definition of subharmonicity). Moreover, if $A$ is a set of subharmonic functions and $u = \sup A$, then $u$ is subharmonic provided that $u$ is upper-semicontinuous (simply by considering the $h$ such that $v \leq h$ for every $v \in A$, which exist since $u$ is upper-semicontinuous and so finite).

\begin{proposition}
Let $u_1, \dots$ be a decreasing sequence of subharmonic functions. Then $u = \lim_j u_j$ is subharmonic.
\end{proposition}
\begin{proof}
    Note that
    $$\{z \in \Omega: u(z) < s\} = \bigcup_j \{z \in \Omega: u_j(s)\}$$
    is open so $u$ is upper-semicontinuous. If $h, K$ are as in the definition of subharmonicity and $\varepsilon > 0$ then the set
    $$\{z \in \partial K: u_j(z) \geq h(z) + \varepsilon\}$$
    is compact and decreasing as $j \to \infty$. The intersection of nonempty compact sets is nonempty, but the intersection is empty by definition of $H$, so there the sequence is eventually empty. Therefore $u_j \leq h + \varepsilon$ for $j$ large enough. So $u \leq h$.
\end{proof}

Now we consider equivalent definitions of subharmonicity.
\begin{proposition}
Let $u$ be an upper-semicontinuous function on $\Omega \subseteq \CC$. Let $\delta > 0$ and let $\Omega_\delta = \{z \in \Omega: d(z, \Omega^c) > \delta\}$. The following are equivalent:
\begin{enumerate}
    \item $u$ is subharmonic.
    \item If $D \subseteq \Omega$ is a compact disk, and $f$ is a polynomial such that $u \leq f$ on $\partial D$, then $u \leq f$ in $D$.
    \item For each $z \in \Omega_\delta$,
    $$2\pi u(z) \leq \int_0^{2\pi} u(z+re^{i\theta}) ~d\theta.$$
    \item For each positive measure $\mu$ on $[0, \delta]$ and each $z \in \Omega_\delta$,
    \begin{equation}
        \label{subharmonic equation in C}
        2\pi \mu([0, \delta]) u(z) \leq \int_0^\delta \int_0^{2\pi} u(z + re^{i\theta}) ~d\theta ~d\mu(r).
    \end{equation}
    \item For each $z \in \Omega_\delta$ there is a positive measure $\mu$ on $[0, \delta]$, such that Equation \ref{subharmonic equation in C} holds and such that $\mu((0, \delta]) > 0$.
\end{enumerate}
\end{proposition}
\begin{proof}
    Obviously 1 implies 2 and 3 implies 4 implies 5.

    Assume 2. To prove 3, let $z \in \Omega_\delta$ and $r \leq \delta$. Let $D$ be the disk of all $\zeta$ such that $|\zeta - z| \leq r$. If $\varphi(\theta) = \sum_k a_k e^{ik\theta}$ is a trigonometric polynomial such that $u(z + re^{i\theta}) \leq \varphi(\theta)$ for every $\theta \in [0, 2\pi]$, then $f(\zeta) = a_0 + 2\sum_{k\geq 1} a_k(\zeta - z)^k/r^k$ has $u \leq \Re f$ on $\partial D$, so on $D$ since $f$ is a polynomial. Plugging in $\theta = 0$, we have
\begin{equation}
    \label{subharmonic in C proof}
    u(z) \leq a_0 = \frac{1}{2\pi} \int_0^{2\pi} \varphi(\theta) ~d\theta.
\end{equation}
    Since the trigonometric polynomials are an algebra, they are dense in the space of continuous functions. Therefore Equation \ref{subharmonic in C proof} holds for any continuous $\varphi$. This proves 3.

    Assume 5 and let $h, K$ be as in the definition of subharmonicity. If $M = \sup u - h > 0$ then $u - h = M$ on some nonempty compact set $K_0$ by semicontinuity of $u - h$. Let $z_0 \in K_0$. Then
    $$\int_0^{2\pi} \int_0^\delta (u-h)(z_0 + re^{i\theta}) ~d\mu(r) ~d\theta < 2\pi (u-h)(z_0) \mu([0, \delta)).$$
    This is a contradiction of 5, so $u$ is subharmonic.
\end{proof}
    It follows that the class of subharmonic functions is closed under addition, and subharmonicity is a local property. Moreover, if $f$ is holomorphic on $\Omega$, it follows that $\log|f|$ is subharmonic: by the maximum modulus principle, $|f|$ does not attain its maximum on a compact disk $D$.

\begin{theorem}
    Assume $\Omega \subseteq \CC$ is open and connected and $u$ is subharmonic on $\Omega$ is not identically $-\infty$. Then $u \in L^1_{loc}(\Omega)$ and for any $v \in C^2_{comp}(\Omega)$, $v \geq 0$, $\langle u, \Delta v\rangle \geq 0$. If $u \in C^2(\Omega)$, then $\Delta u \geq 0$.
\end{theorem}
\begin{theorem}
    Suppose $u \in L^1_{loc}(\Omega)$ and for every $v \in C^2_{comp}(\Omega)$, $v \geq 0$, $\langle u, \Delta v \rangle \geq 0$. Then, up to a null set, $u$ is subharmonic. In particular, the mollification of $u$ is subharmonic.
\end{theorem}
From the above theorem we see that for $u \in L^1_{loc}$, then $u$ is subharmonic exactly when $\Delta u \geq 0$ in the weak sense.



\section{Operator theory}
\begin{theorem}[Schur]
\label{Schur}
Let $X$ be a $\sigma$-finite measure space and let $K$ be an integral operator. If there is a $p: X \to [0, \infty)$ and a $\lambda > 0$ such that
$$\int_X |K(x, y)|p(y) ~dy \leq \lambda p(x)$$
and
$$\int_X |K(x,y)| p(x) ~dx \leq \lambda p(y)$$
then
$$||K||_{L^2 \to L^2} \leq \lambda.$$
\end{theorem}
\begin{proof}
Let $u$ be an integrable simple function. By the Cauchy-Schwarz inequality and Fubini's theorem,
\begin{align*}
    ||Ku||^2_{L^2} &= \int_X \left|\int_X K(x, y)u(y) ~dy\right|^2 ~dx &\leq \left|\iint_{X^2} |K(x, y)|^{1/2}p(y)^{1/2} \frac{|u(y)|}{p(y)^{1/2}} |K(x, y)|^{1/2} ~dx ~dy\right|\\
    &\leq \int_X\left(\int_X |K(x, y)| p(y) ~dy\int_X \frac{|u(y)|^2}{p(y)}|K(x, y)| ~dy\right)~dx\\
    &\leq \lambda \int_X \frac{p(x)}{p(y)}|K(x, y)| |u(y)|^2 ~dy ~dx\\
    &\leq \lambda^2 |u(y)|^2 ~dy = \lambda^2 ||u||_{L^2}^2.
\end{align*}
Since ISF is dense in $L^2$ we're done.
\end{proof}
As a corollary we can easily compute the $\ell^2$ norm of a matrix, since every matrix is an integral operator for counting measure on $\{1, 2, \dots, n\}$.

\begin{theorem}
\label{norm of the resolvent}
Let $A$ be a self-adjoint operator and
$$R_A(\lambda) = (A - \lambda)^{-1}$$
its resolvent. Then we have
$$||R_A(\lambda)|| = \frac{1}{d(\lambda, \sigma(A))}.$$
\end{theorem}
Notice the utility of this theorem: we do not assume that $A$ is a bounded linear operator, so we cannot use the spectral radius theorem.
\begin{proof}
Since $\lambda$ is in the resolvent set, $d(\lambda, \sigma(A)) > 0$. We can assume $A$ is unbounded; therefore $R_A$ is bounded, and its spectrum consists of $0$ and the set of all $1/(\mu - \lambda)$, for $\mu \in \sigma(A)$. By the spectral radius theorem,
$$||(A - \lambda)^{-1}|| = \sup_{\mu \in \sigma(A)} |\lambda - \mu|^{-1}$$
which proves the claim.
\end{proof}

\chapter{Measure theory on $\RR^n$}
We now consider issues involving Lebesgue measure on $\RR^n$. I learned this material as part of preparing for Brown's diagnostic exam, from Pugh's ``Real Mathematical Analysis" and Evans-Gariepy's ``Fine Properties of Functions".

Throughout this section, let $m$ denote Lebesgue measure on $\RR^n$.

\section{Vitali coverings}
\begin{definition}
Let $X$ be a metric space.
A \dfn{fine cover} of a set $A \subseteq X$ is a cover $\mathcal V$ such that for every $x \in A$ and $\varepsilon > 0$ there is a $V \in \mathcal V$ such that $V \subseteq B(x, \varepsilon)$.
\end{definition}
\begin{definition}
Let $(X, \mu)$ be a measure space and $\varepsilon > 0$
An $\varepsilon$-\dfn{efficient cover} of a set $A \subseteq X$ is a cover $\mathcal V$ such that
$$\mu(A) \leq \varepsilon + \mu\bigcup \mathcal V.$$
\end{definition}
\begin{theorem}[Vitali covering lemma]
\index{Vitali covering lemma}
Let $A \subseteq \RR^n$. Then for every fine cover $\mathcal V$ of $A$ by infinite closed balls, there is an efficient, countable, disjoint subcover of $\mathcal V$ of almost all of $A$.
\end{theorem}
Note that we need not assume that $A$ is measurable, since we can always replace $m$ with Lebesgue outer measure $m^*$.
\begin{proof}
Since $A$ is $\sigma$-finite we may assume that $m^*(A) < \infty$, and then by a rearrangement that $A$ is bounded.
Let $\varepsilon > 0$ and choose $W \supseteq A$ to be a bounded open set such that
$$m(W) \leq m^*(A) + \varepsilon.$$
Let
$$\mathcal V_1 = \{V \in \mathcal V: V \subseteq W\}.$$
Then $\mathcal V_1$ is a fine cover of $A$.
Let $d_1 = \sup_{V \in \mathcal V_1} \diam V$. Then $d_1 < \infty$ since $W$ is bounded.
Choose $V_1 \in \mathcal V_1$ with $\diam V_1 \geq d_1/2$.
We will use a greedy algorithm to construct the subcover. Intuitively, $V_1$ is the ``largest element of $\mathcal V_1$", though of course the supremum $d_1$ may not be attained.

Inductively define $\mathcal V_k$ to be the set of $V \in \mathcal V_{k-1}$ which do not meet $U_{k-1} = \bigcup_{j < k-1} V_j$,
$d_k = \sup_{V \in \mathcal V_k} \diam V$, and choose $V_k \in \mathcal V_k$ to be ``maximal" in the sense that $\diam V_k \geq d_k/2$.
Let $\mathcal V' = \{V_k\}_k$.
Then $\mathcal V'$ is an efficient, countable, disjoint cover of something.

If $\mathcal V_k$ is ever empty then this implies that $U_{k-1}$ covers $A$.
So assume that $\mathcal V'$ is infinite, so that
$$m\bigcup_k V_k = \sum_k m(V_k).$$
Since this series converges we have
$$\lim_{k \to \infty} d_k = 0.$$

Let $5V_k$ denote the dilate of $V_k$ by $5$.
\begin{lemma}
For every $N$,
$$A \setminus U_{N-1} \subseteq \bigcup_{k \geq N} 5V_k.$$
\end{lemma}
\begin{proof}
Let $a \in A \setminus U_{N-1}$. Since $U_{N-1}$ is compact and $\mathcal V_1$ is fine, there is a $B \in \mathcal V_1$ such that $a \in B$ and $B \cap U_{N-1}$ is empty.
Thus $B \in \mathcal V_N$.

If the claim fails then $B \not \subseteq 5V_N$. But $V_N$ was chosen maximally so $V_N$ is disjoint from $B$. So $B \in \mathcal V_{N+1}$. In particular $B \in \mathcal V_k$ for every $k > N$.
Thus $B$ could have been chosen as the possible candidate for $V_k$ for every $k > N$, so
$$\lim_{k \to \infty} \diam B = 0$$
which is nonsense since $B$ is independent of $k$.
\end{proof}
Now let $\delta > 0$ be given, and choose $N$ so that
$$5^n \sum_{k \geq N} m(V_k) < \delta.$$
But
$$m^*(A \setminus U_{N-1}) \leq \sum_{k \geq N} m(5V_k) = 5^n \sum_{k \geq N} m(V_k) < \delta,$$
so $A \setminus \bigcap_N U_N$ is null.
\end{proof}

\section{Lebesgue's density theorem}
Throughout this section, fix a measurable set $E \subseteq \RR^n$.

We let $\lim_{B \downarrow x} y(B)$ denote the limit of $y(B)$ as $B$ ranges over the net of all balls $B$ containing $x$, ordered by reverse inclusion.

\begin{definition}
The \dfn{density} of $E$ at a point $x$ is given by
$$\Density x = \lim_{B \downarrow x} \frac{m(E \cap B)}{m(B)}.$$
If $\Density x = 1$, we say that $x$ is a \dfn{density point} of $E$.
\end{definition}
\begin{example}
An interior point is a density point.
\end{example}
\begin{definition}
The \dfn{measure-theoretic interior} of $E$ is the set of density points of $E$.
\end{definition}
\begin{theorem}[Lebesgue density theorem]
\index{Lebesgue density theorem}
Almost all of $E$ is the measure-theoretic interior of $E$.
\end{theorem}
\begin{proof}
As usual, we may assume that $E$ is bounded. Let $0 \leq a < 1$ and let
$$E_a = \{x \in E: \liminf_{B \downarrow x} \frac{m(E \cap B)}{m(B)} < a\}.$$
The quantity
$$\liminf_{B \downarrow x} \frac{m(E \cap B)}{m(B)}$$
is the lower density of $E$ at $x$.
\begin{lemma}
$m(E_a) = 0$.
\end{lemma}
\begin{proof}
For every $x \in E_a$, choose a sequence of balls $B_{k,x} \downarrow x$ such that
$$\frac{m(E \cap B_k)}{m(B_k)} < a.$$
The set $\{B_{k,x}: k \in \NN,~x \in E_a\}$ is a fine cover of $E_a$.
By the Vitali covering lemma we may choose a countable efficient cover $\{V_k\}_k$ of $E_a$ such that
$$\sum_k m(V_k) < m^*(E_a) + \varepsilon.$$
Then
$$m^*(E_a) = \sum_k m^*(E_a \cap V_k) < a \sum_k m(V_k) \leq a(m^*(E_a) + \varepsilon).$$
Solving for $m^*(E_a)$ we see that $m^*(E_a) \lesssim_a \varepsilon$, hence $m^*(E_a) = 0$.
\end{proof}
Now $E_a$ is an increasing chain, so $E_1 = \bigcup_{a < 1} E_a$ is null.
If $x \notin E_1$ then for every $a < 1$,
$$1 \geq \limsup_{B \downarrow x} \frac{m(E \cap B)}{m(B)} \geq \liminf_{B \downarrow x} \frac{m(E \cap B)}{m(B)} > a.$$
Taking the limit as $a \to 1$ we see the claim.
\end{proof}
In the proof that $E_a$ is null we did not know a priori that $E_a$ is measurable. This shows the power of the Vitali covering lemma, which allows us to work with merely outer measures rather than measures.

\begin{theorem}[Lebesgue differentiation theorem]
\index{Lebesgue differentiation theorem}
For every $f \in L^1_{loc}(\RR^n)$ and almost every $y \in \RR^n$,
$$\lim_{B \downarrow y} \dashint_B f(x)~dx = f(y).$$
\end{theorem}
\begin{proof}
We work our way up, checking increasingly complicated functions $f$.

First when $f = 1_E$ and $E$ is measurable, then this is the Lebesgue density theorem.
The claim then extends by linearity to simple functions.

Now if $f \geq 0$ and $f \in L^1$, let
$$A_\alpha = \{y \in \RR^n: \limsup_{B \downarrow y} \left|\dashint_B f(x)~dx - f(y)\right| > \alpha\}.$$
Then $A_0 = \bigcup_{\alpha > 0} A_\alpha$ so it suffices to show that given $\alpha,\varepsilon > 0$, $m(A_\alpha) < \varepsilon$.

Choose a simple function $f' \leq f$ such that $||f - f'||_1 < \varepsilon\alpha/4$. Let $g = f - f'$, and
$$A'_\alpha = \{y \in \RR^n: \limsup_{B \to y} \left|\dashint_B g(x)~dx - g(y)\right| > \alpha\}$$
satisfies $m(A_\alpha \Delta A'_\alpha) = 0$ (since points in the symmetric difference must be points where $f'$ contradicts the conclusion of the theorem).
Writing $A'_{\alpha,+} = \{g > \alpha/2\}$ and
$$A'_{\alpha,-} = \{y \in A'_\alpha: \limsup_{B \downarrow y} \dashint_B g(x)~dx > \alpha/2\}$$
we see that $A' \subseteq A'_{\alpha,+} \cup A'_{\alpha,-}$ so it suffices to control the bad sets $A'_{\alpha,\pm}$.

In fact,
$$\frac{\alpha}{2}m(A'_{\alpha,+}) \leq \int_{A'_{\alpha,+}} g(x)~dx \leq ||g||_1 < \frac{\alpha\varepsilon}{4}.$$
Thus $m(A'_{\alpha,+}) < \varepsilon/2$.

Now let $\mathcal V$ be the set of balls $B$ such that
$$\dashint_B g(x)~dx > \alpha/2.$$
Then $\mathcal V$ is a fine cover of $A'_{\alpha,-}$, so let $\{V_i\}_i$ be the subcover returned by the Vitali covering algorithm.
Then
$$\frac{\alpha}{2}m^*(A'_{\alpha,-}) \leq \sum_i \frac{\alpha}{2} m(V_i) \leq \sum_i m(B_i) \dashint_{V_i} g(x) ~dx \leq ||g||_1 < \frac{\varepsilon\alpha}{4}.$$
Thus $m(A'_{\alpha,-}) < \varepsilon/2$ as desired.

The assumption that $f$ is nonnegative can be removed by breaking up $f$ into positive and negative parts and using linearity of the conclusion.

Finally, the conclusion of the theorem is local, so the proof for $L^1$ cuts off to a proof for $L^1_{loc}$.
\end{proof}
We can actually reduce the assumption that $f \in L^1_{loc}$ to just that $f$ is measurable, using harmonic-analytic methods. We'll do this before the proof of Carleson's theorem later on.

As a consequence of Lebesgue's differentiation theorem we prove a flavor of the fundamental theorem of calculus.
\begin{definition}
Let $f$ be a function on $[a, b]$; then its \dfn{indefinite integral} is
$$x \mapsto \int_a^x f(t)~dt.$$
\end{definition}
\begin{corollary}
\index{fundamental theorem of calculus}
For every $f \in L^1([a, b])$, the indefinite integral $F$ of $f$ is an antiderivative of $f$ almost everywhere.
\end{corollary}
\begin{proof}
By Lebesgue's differentiation theorem,
$$\lim_{\varepsilon \to 0} \frac{F(x + \varepsilon) - F(x)}{\varepsilon} = \lim_{\varepsilon \to 0} \dashint_x^{x + \varepsilon} f(y)~dy = f(x)$$
almost everywhere.
\end{proof}







\part{Dynamical systems}
\chapter{Elementary dynamical systems}
\begin{definition}
By a \dfn{discrete dynamical system} we mean a transformation $T: X \to X$.
\end{definition}
We think of $T^n(X)$ as the state of $X$ at time $n$.
\begin{definition}
By a \dfn{continuous dynamical system} we mean a family of transformations $\varphi_t: X \to X$ satisfying the homomorphism assumption $\varphi_{t+s} = \varphi_t\varphi_s$.
\end{definition}
We can always build a continuous system from a discrete one and vice versa. Because discrete systems are much easier to study, we usually try to reduce the study of dynamical systems to the study of discrete dynamical systems.


\section{Types of dynamical systems}
\begin{definition}
A \dfn{periodic point} of a dynamical system $T$ is a $x$ such that there is a $t$ with $T^t(x) = x$.
\end{definition}
In dynamical systems, we want to know how many periodic points are there in a dynamical system. This is too specific so it is also common to look for recurrence: if a trajectory $x$ starts at $x_0$, how often does $x_n$ approximate $x_0$?

\begin{definition}
An \dfn{invariant set} $Y \subseteq X$ of a dynamical system $T: X \to X$ is a set such that $T^{-1}(A) = A$.
\end{definition}
\begin{definition}
An \dfn{invariant measure} $\mu$ (defined on a $\sigma$-algebra $\Sigma$) is one such that for every measurable set $A \in \Sigma$, $T^{-1}(A) \in \Sigma$ and $\mu(T^{-1}(A)) = \mu(A)$.
\end{definition}
In dynamical systems, we want to study invariant sets and invariant measures. The reason why we study the pullback in the definition of invariant measure is that $A \mapsto \mu(T^{-1}(A))$ is always a measure, but if $X = \{0, 1\}$, $T(0) = T(1) = 0$, $\mu$ counting measure, then $A \mapsto \mu(T(A))$ is not a measure.

We also will study structural stability, i.e. when a small perturbation of $T$ preserves the properties of $T$.
\begin{example}
KAM theory implies that the solar system is at least approximately structurally stable. Therefore the solar system will not collapse in our lifetimes.
\end{example}

\begin{definition}
Let $T: X \to X$ and $S: Y \to Y$ be dynamical systems. Then $S$ is \dfn{semiconjugate} to $T$, or that $T$ is a \dfn{factor} of $S$) if there is a surjective $\pi: Y \to X$ such that $T \circ \pi = \pi \circ S$. If $\pi$ is actually invertible, then $S$ and $T$ are \dfn{conjugate}.
\end{definition}
As far as set theory is concerned, conjugacy means that $S$ and $T$ are identical. If we may assume that $\pi$ is measure-preserving, smooth, etc., then it will follow that $S$ and $T$ are identical in the appropriate categories.
\begin{example}
Let $T: S^1 \to S^1$ be the dynamical system which rotates the circle by $2\pi\alpha$ for some $\alpha \in \RR$. Let $S: \RR^2 \setminus 0 \to \RR^2 \setminus 0$ to be the rotation of the punctured plane by $2\pi\alpha$. Then $T$ is a factor of $S$, witnessed by the transformation $\pi: \RR^2 \setminus 0 \to S^1$ which sends a point to its projection onto the circle.

We are mainly interested in $T$ when $\alpha$ is irrational (in which case $T$ is called the \dfn{irrational rotation}), in which case $T$ has no periodic points. We will show that there are no interesting examples of invariant sets for $T$, and in fact if we restrict to Borel measures, there is exactly one invariant measure of $T$, namely the Lebesgue measure. There is no structural stability because the rational numbers are dense in $\RR$.
\end{example}

We branch off into different subfields. Let $T: X \to X$ be a transformation. If $X$ is a metric space and $T$ is continuous, then we are studying \dfn{topological dynamics}. If $X$ is a smooth manifold and $T$ is smooth, then we are studying \dfn{smooth dynamics}. In this case, we have an auxiliary dynamical system defined by the differential form $df: TX \to TX$ which sends $T_xX \to T_{f(x)}X$. Finally, if $X$ is a measure space and $\mu$ is an invariant measure, then we are studying \dfn{ergodic theory}. Ergodic theory will be one of the main themes of this course.

One can also study \dfn{holomorphic dynamics}, where $T: \CC \to \CC$ is a holomorphic function. One can ``generalize" this to the study of rational functions from a variety to itself.

We now introduce Hamiltonian systems.
\begin{definition}
Let $X$ be a smooth manifold and let $\omega$ be a nondegenerate $2$-form such that $d\omega = 0$. Then we say that $(X, \omega)$ is a \dfn{symplectic manifold}.
\end{definition}
\begin{definition}
Let $X$ be a symplectic manifold. For a function $f: X \to \RR$, let $H_f$ be the vector field defined by the relation $\omega(\cdot, H_f) = df$. Then we define the \dfn{Hamiltonian dynamical system} on $X$ by the ordinal differential equation
$$\dot \rho(t) = H_f(\rho(t))$$
where $\rho(0)$ is given.
\end{definition}
In this case, the measure $\omega^n/n!$ is an invariant measure of $\omega$.
\begin{example}
Let $X$ be the cotangent space of $\RR^n$ and let $\omega = \sum_j d\xi_j \wedge dx_j$. Then $(X, \omega)$ is a symplectic manifold and
$$H_f = \sum_j \frac{\partial f}{\partial \xi_j} \partial x_j - \frac{\partial f}{\partial x_j} \partial_{\xi_j}.$$
\end{example}
\begin{example}
We show that the irrational rotation is a Hamiltonian system. Let $(\RR^2, dx\wedge dy)$ be our symplectic manifold, so
$$H_f = \frac{\partial f}{\partial x}\partial_y - \frac{\partial f}{\partial y}\partial_x.$$
Now let
$$f(x, y) = \frac{x^2 + y^2 - 1}{2}$$
so $\dot x = -\partial_yf$ and $\dot y = \partial_xf$. Then $S = \varphi_{-2\pi\alpha}$.

The irrational rotation is an especially useful example because it is simultaneously a topological, smooth, holomorphic, ergodic-theoretic and Hamiltonian system.
\end{example}

\section{Properties of the irrational rotation}
Let $T$ be the irrational rotation. For every $f: S^1 \to \RR$, let
$$S_Nf(\theta) = \frac{1}{N} \sum_{j=0}^{N-1} f(T^j(\theta)).$$
Let
$$\overline f = \frac{1}{2\pi} \int_0^{2\pi} f(\varphi) ~d\varphi.$$
\begin{theorem}
One has
$$\lim_{N \to \infty} S_Nf = \overline f,$$
pointwise if $f \in C(S^1)$ and in $L^2$ if $f \in L^2(S^1)$.
\end{theorem}
\begin{proof}
By the Stone-Weierstrass theorem, trigonometric polynomials are dense in $C(S^1)$ (in the $L^\infty$ topology), so to prove pointwise convergence we just need to check on trigonometric polynomials. It then suffices to check for the trigonometric basis $f(\theta) = e^{i\ell\theta}$. If $\ell = 0$ then this is obvious. If $\ell \neq 0$,
$$S_Nf(\theta) = \frac{1}{N} \sum_{j=0}^{N-1} e^{i\ell(\theta + 2\pi j\alpha)} = \frac{e^{i\ell\theta}}{N} \frac{1 - e^{i\ell2\pi N\alpha}}{1 - e^{i\ell2\pi\alpha}}.$$
Since $\alpha$ is irrational, the denominator is never $0$, hence is bounded from below. The numerator is clearly bounded from above, so as $N \to \infty$, $S_Nf \to 0$ uniformly. Meanwhile, $\overline f = 0$ since $f$ is periodic of period $2\pi\ell$. This proves the pointwise claim.

One can prove $L^2$-convergence by taking the Fourier series
$$f = \sum_\ell f_\ell e^\ell$$
where $e^\ell(\theta) = e^{i\ell\theta}$.
Then $f_0 = \overline f$. We have $\langle S_N(e^\ell), S_N(e^k)\rangle = 0$ whenever $k \neq \ell$ by orthogonality.
\begin{align*}\left|\left|\frac{1}{N} S_N\left(\sum_\ell f_\ell e^\ell\right) - f_0\right|\right|_{L^2}^2 &\leq \left|\left|\sum_{|\ell| \leq k} \frac{f_\ell}{N} S_N(e^\ell)\right|\right|_{L^2}^2\\&\quad + \left|\left|\sum_{|\ell| > k} \frac{f_\ell}{N} S_N(e^\ell) - f_0\right|\right|_{L^2}^2
\end{align*}
and
$$ \left|\left|\sum_{|\ell| > k} \frac{f_\ell}{N} S_N(e^\ell)\right|\right|_{L^2}^2 = \sum_{|\ell| > k} \left|\left|\frac{f_\ell}{N} S_N(e^\ell)\right|\right|^2_{L^2} \leq \sum_{|\ell| > k} |f_\ell|^2$$
and for any $\varepsilon > 0$ we may choose $k$ so that the sum over $|\ell| > k$ is at most $\varepsilon$. The sum over $|\ell| \leq k$ can also be chosen less than $\varepsilon$ by taking $N$ big enough so we're done.
\end{proof}
\begin{corollary}
$(2\pi n\alpha)_{n \in \NN}$ is dense in $S^1$.
\end{corollary}
\begin{proof}
We have for every $f \in C(S^1)$,
$$\frac{1}{N} \sum_{n=0}^{N-1} f(2\pi n\alpha) = \frac{1}{2\pi} \int_0^{2\pi} f(\varphi) ~d\varphi.$$
Suppose the claim fails. Then there is a open $U \subseteq S^1$ such that for every $n \in \NN$, $n\alpha \notin U$. Let $f$ be zero outside of $U$, such that $\int f \neq 0$. Then the left-hand side is $0$ while the right-hand side is nonzero.
\end{proof}
\begin{corollary}
The only invariant Borel probability measure of the irrational rotation is Lebesgue measure.
\end{corollary}
\begin{proof}
Suppose that $\mu$ is an invariant measure. Then
$$\int_{S^1} f(x + 2\pi n\alpha) ~d\mu(x) = \int_{S^1} f(x) ~d\mu(x)$$
but the $2\pi n\alpha$ are dense, so in fact we have
$$\int_{S^1} f(x + y) ~d\mu(x) = \int_{S^1} f(x) ~d\mu(x)$$
whence $\mu$ is rotation-invariance, hence the Lebesgue measure.
\end{proof}
\begin{definition}
A dynamical system $T$ with fixed $\sigma$-algebra $\Sigma$ is \dfn{uniquely ergodic} if there is a unique $T$-invariant probability measure on $\Sigma$.
\end{definition}
So we have just proven that the irrational rotation is uniquely ergodic for the Borel $\sigma$-algebra. This is a very unusual property.
\begin{corollary}
Modulo null sets, there are no invariant proper subsets of the irrational rotation.
\end{corollary}
\begin{proof}
Let $A$ be an invariant set and let $f = 1_A$, $g = 1 - f$. Then
$$\langle S_Nf, g\rangle = \int_0^{2\pi} S_Nf(\theta)\overline{g(\theta)} ~d\theta = \int_0^{2\pi} f(\theta)\overline{g(\theta)} ~d\theta = 0$$
but also
$$\langle f, g\rangle = |A|(2\pi - |A|)$$
so by the equality we have $|A|(2\pi - |A|) = 0$.
\end{proof}

\chapter{Ergodic theory}
\section{The mean ergodic theorem}
We now extend the above results on the irrational rotation to general dynamical systems.

Let $(X, \mu)$ be a probability space, and for a measurable function $f$ and measure-preserving transformation $T$, let
$$S_nf(x) = \sum_{j=0}^{n-1} f(T^j(x)).$$
be $n$ times the the time average of $f$. For example if $f$ is an indicator function for a set $A$ then $S_nf$ counts the number of times that we visit $f$. Let
$$\overline f = \int_X f ~d\mu$$
be the space average of $f$. So if $f$ is an indicator function then $\overline f$ is the probability of $A$. For the irrational rotation we proved that $S_n/nf \to \overline f$ pointwise and in $L^2$. This is a special case of the ergodic theorems.

\begin{lemma}
If $g \geq 0$ is an integrable function then
$$\int_X g\circ T ~d\mu = \int_X g~d\mu.$$
\end{lemma}
\begin{proof}
For indicator functions this is obvious. By taking sums we extend to simple functions and then use monotone convergence.
\end{proof}

\begin{definition}
Let $Uf = f \circ T$, the \dfn{Koopman operator} of $T$.
\end{definition}
By the lemma, $U$ is an isometry on $L^2$ and we have
$$S_nf(x) = \sum_{j=0}^{n-1} U^jf(x).$$
\begin{theorem}
Let $H$ be a Hilbert space and $U \in B(H)$ is an operator such that $||U|| \leq 1$. Let
$$\Inv = \{f \in H: Uf = f\}.$$
Let $P: H \to \Inv$ be the orthogonal projection. Then for every $f \in H$,
$$\sum_{1}{n} \sum_{j=0}^{n-1} U^jf \to Pf$$
in $L^2$.
\end{theorem}
The proof of this theorem uses the Banach-Alaoglu theorem and the following lemma:
\begin{lemma}
$Ug = g$ iff $U^*g = g$.
\end{lemma}
\begin{proof}
Since the adjoint is an involution we just need to check one direction. Suppose $Ug = g$. Then
$$0 = ||U^*g - g||^2 = ||U^*g||^2 + ||g||^2 - 2 \Re \langle U^*g, g\rangle = ||U^*g||^2 - ||g||^2 \leq ||Ug||^2 - ||g||^2 = 0.$$
\end{proof}
\begin{proof}[Proof of theorem]
It suffices to prove the claim when $f \in \Inv^\perp$, in which case $Pf = 0$. We expand
$$S_nf = \sum_{j=0}^{n-1} U^jf$$
as
$$||S_nf/n||^2 = \langle f, S_n^*S_n f/n^2\rangle$$
and
$$||S_nf/n|| \leq \frac{1}{n} \sum_{j=0}^{n-1} ||U^jf|| \leq ||f||$$
which is bounded. Now $f \in \Inv^\perp$ and $g_n = S_n^*S_nf/n^2$ is a bounded sequence, so $g_n$ has a weak limit. Suppose that $g$ is a weak limit; we claim that $g \in \Inv$, so $\langle f, g\rangle = 0$. But
$$(1 - U^*)(S_n^*/n) = \frac{1}{n} \sum_{j=0}^{n-1} (1 - U^*)(U^*)^{j-1} = \frac{1 - (U^*)^n}{n}$$
whose operator norm is bounded by $2/n$, so
$$(1 - U^*)g_n \to 0.$$
This implies that $(1 - U^*)g = 0$, so by the lemma $Ug = g$ and $g \in \Inv$.
\end{proof}
\begin{corollary}[von Neumann mean ergodic theorem]
\index{von Neumann mean ergodic theorem}
Let $(X, \mu, T)$ be a measure-preserving system and $f \in L^2(\mu)$. Let $\Inv(T)$ be the space of Koopman-invariant functions for $\mu$ and let $P: L^2(\mu) \to \Inv(T)$ be the orthogonal projection. Then
$$\frac{1}{n} \sum_{j=0}^{n-1} f(T^j(x)) \to Pf$$
in $L^2(\mu)$.
\end{corollary}
Note that the mean ergodic theorem does not assume that $\mu$ is a probability measure. However, when one applies the mean ergodic theorem he usually wants to assume that indicator functions are in $L^2$, which is only possible when $\mu$ is a finite measure.

\begin{lemma}
For every $g \in \Inv$ and $f \in L^2$,
$$\int_X (Pf)g ~d\mu = \int_X fg ~d\mu.$$
\end{lemma}
\begin{proof}
$$\langle Pf, g\rangle = \langle f, P^*g \rangle = \langle f, Pg \rangle = \langle f, g\rangle.$$
\end{proof}
\begin{corollary}
If $A$ is an invariant set and $\mu(A) < \infty$ then for every $f \in L^2$,
$$\int_A Pf = \int_A f.$$
\end{corollary}
\begin{corollary}
$P$ is a positive-semidefinite operator.
\end{corollary}
\begin{proof}
Suppose $f \geq 0$. Then $Pf(x)$ is the average of the Koopman iterates $f(T^j(x)) \geq 0$.
\end{proof}
\begin{corollary}
If $\mu$ is a probability measure then
$$\int_X Pf~d\mu = \int_X f ~d\mu.$$
\end{corollary}
\begin{corollary}
If $\mu$ is a probability measure and $f > 0$ a.e. then $Pf > 0$ a.e.
\end{corollary}
\begin{proof}
Note that $(Pf)^{-1}(0)$ is invariant since $Pf \in \Inv$, and has finite measure, so
$$\int_{(Pf)^{-1}(0)} f = \int_{(Pf)^{-1}(0)} Pf = 0.$$
Since $f$ is nonnegative this implies that $Pf = 0$ implies $f = 0$.
\end{proof}
\begin{example}
Applying the mean ergodic theorem to the irrational rotation we have
$$Pf = \overline f.$$
\end{example}
\begin{example}
Let $\Sigma_m^+$ be the Cantor space of infinite sequences in the alphabet $\{0, \dots, m-1\}$. Define the \dfn{shift map}
$$T(x_1x_2x_3\cdots) = x_2x_3x_4\cdots.$$
The dynamical system $(\Sigma_m^+, T)$ has many invariant measures. If $y$ is a word in $\{0, \dots, m-1\}$, let $C_y$ denote the cylinder of all sequences which begin with $y$. A Borel measure is defined uniquely (assuming it is well-defined at all) by assigning measures to each of the $C_y$.
In fact choose a probability vector $p$, i.e. $p = (p_0, \dots, p_{m-1})$ with $p_j \in [0, 1]$ such that $\sum_j p_j = 1$, and let
$$\mu_p(C_y) = \prod_j p_{y_j}.$$
Then $\mu_p$ is a Borel probability measure on $\Sigma_m^+$, and
$$\mu_p(T^{-1}(C_y)) = \mu_p\left(\bigcup_j C_{j \cdot y}\right) = \sum_j \mu_p(C_{j \cdot y}) = \mu_p(C_y).$$
Therefore $\mu_p$ is an invariant measure. As we will prove, this gives an ergodic system that is not uniquely ergodic. In case $p = (1/10, \dots, 1/10)$, and $m = 10$, this gives a construction of Lebesgue measure, which can be used to prove that almost every number is normal.
\end{example}

We now prove a recurrence theorem of Caratheodory, which confusingly is not named after Caratheodory.
\begin{theorem}[Poincare recurrence]
\index{Poincare recurrence theorem}
Suppose that $(X, \mu)$ is a probability space, $T: X \to X$ measure-preserving, and $B$ is measurable. Then for $\mu$-a.e. $x \in B$, there are infinitely many $n \in \NN$ such that $T^nx \in B$.
\end{theorem}
\begin{proof}
Let $f = 1_B$. By the mean ergodic theorem,
$$\frac{1}{n}\sum_{j=0}^{n-1} f(T^j(x)) \to_{L^2} Pf(x) > 0$$
a.e. in $B$. By the Riesz-Weyl theorem, there is a subsequence $(n_k)_k \in \NN$ such that
$$\frac{1}{n_k} \sum_{j=0}^{n_k-1} f(T^j(x)) \to_{a.e.} Pf(x).$$
The claimed property is true a.e. for the $n_k$.
\end{proof}
\begin{example}
Suppose we have two chambers connected, and a gas only in one chamber. By the second law of thermodynamics, the gas will spread throughout the two chambers. But by Poincare recurrence, the gas will almost surely return to the first chamber. However, the recurrence time of such a phenomenon may exceed the lifespan of the universe.
\end{example}
There is also a combinatorial proof of Poincare recurrence.
\begin{proof}[Proof of Poincare recurrence]
If there were only finitely many such $n$ we would be able to assume wlog that there were only zero such $n$, by time-translation. Then for every $x \in B$ and $n \in \NN$, $T^n(x) \notin B$. So if $n \neq m$, and $x \in T^{-n}(B) \cap T^{-m}(B)$, then $T^{n-m}(T^m(x)) = T^n(x) \in B$, a contradiction. Therefore the $T^{-n}(B)$ are disjoint and have positive measure, yet there are infinitely many of them and $\mu$ is a probability measure, a contradiction.
\end{proof}

\section{Pointwise ergodic theorem}
To introduce the pointwise ergodic theorem, we need to define conditional expectation.
\begin{definition}
Let $(X, \Sigma, \mu)$ be a probability space and $J \subseteq \Sigma$ a $\sigma$-algebra. Given $f$ a $\Sigma$-measurable function, $A \in \Sigma$, let
$$\mu_f(A) = \int_A f~d\mu.$$
Then define the \dfn{conditional expectation}
$$E(f|J) = \frac{d(\mu_f|_J)}{d(\mu|_J)},$$
the Radon-Nikodym derivative of $\mu_f$ with respect to $\mu$ when restricted to the $\sigma$-algebra $J$.
\end{definition}
\begin{example}
If $J$ is the trivial $\sigma$-algebra then $E(f|J)$ is the constant function given by the mean $E(f)$.
\end{example}
\begin{example}
Let $(X, \Sigma, \mu)$ be $[0, 1]$ and $J$ be the $\sigma$-algebra generated by $[0, 1/2]$. Then $E(f|J)(x)$ is the average of $f$ on $[0, 1/2]$ if $x \leq 1/2$ or is the average of $f$ on $(1/2, 1]$ for $x > 1/2$.
\end{example}
We actually have an equivalent definition of conditional expetation which uses the orthogonal projector from the mean ergodic theorem.
\begin{lemma}
Assume that $P$ is a probability measure. Let $P$ be the orthogonal projection $L^2(\mu) \to \Inv T$. Then $||P||_{L^1 \to L^1} \leq 1$, so $P$ extends uniquely to a projection $L^1(\mu) \to \Inv T$.
\end{lemma}
\begin{proof}
Note that for any $f \in L^2(\mu)$, $\{x \in X: Pf(x) \geq 0\}$ its complement are $T$-invariant sets. So
$$\int_X |Pf| = \int_{Pf \geq 0} Pf - \int_{Pf < 0} Pf = \int_{Pf \geq 0} f - \int_{Pf < 0} f \leq \int_{Pf \geq 0} |f| + \int_{Pf < 0} |f| = ||f||_{L^1(\mu)}.$$
Since $\mu$ is a probability measure, $L^2(\mu)$ is a dense subspace of $L^1(\mu)$, whence the claim.
\end{proof}
\begin{corollary}
Let $J$ be the $\sigma$-algebra of $T$-invariant sets. Then for any $f \in L^1(\mu)$,
$$E(f|J) = Pf.$$
\end{corollary}


\begin{theorem}[Birkhoff pointwise ergodic theorem]
\index{Birkhoff pointwise ergodic theorem}
Suppose that $(X, \Sigma, \mu)$ is a probability space, $T: X \to X$ measure-preserving, and $f \in L^1(\mu)$. Then for a.e. $x\in X$,
$$\lim_{n \to \infty} \frac{1}{n} \sum_{j=0}^{n-1} f(T^j(x)) = E(f|J)(x)$$
where $J$ is the $\sigma$-algebra of invariant sets,
$$J = \{A \in \Sigma: T^{-1}(A) = A\}.$$
\end{theorem}
\begin{corollary}
Let $J,\mu$ be as in the pointwise ergodic theorem, and $P$ as in the mean ergodic theorem. If $f \in L^2(\mu)$ then $E(f|J) = Pf$.
\end{corollary}
Note that for any open set of reals $U$, $E(f|J)^{-1}(U) \in J$ iff $E(f|J) \circ T = E(f|J)$. In fact, for any invariant set $A$,
$$\int_A E(f|J) ~d\mu = \int_A f~d\mu.$$
\begin{lemma}
The limit in the pointwise ergodic theorem exists $\mu$-a.e.
\end{lemma}
\begin{proof}
Let
$$\overline f(x) = \limsup_{n \to \infty} \frac{1}{n} \sum_{j=0}^{n-1} f(T^j(x))$$
and similarly for $\underline f$ and $\liminf$. Clearly $\overline f \geq \underline f$ and it suffices to show that $\overline f = \underline f$, $\mu$-a.e. In fact it suffices to show that
$$\int_X \overline f ~d\mu \leq \int_X f~d\mu \leq \int_X \underline f ~d\mu.$$
Replacing $f$ with $-f$ we see that in fact the seemingly weaker statement
$$\int_X \overline f ~d\mu \leq \int_X f~d\mu$$
is sufficient.

Fix $M > 0$, and let $\overline f_M = \min(\overline f, M)$. Then $\overline f_M \leq M$.
\begin{lemma}
$\overline f_M > -\infty$, $\mu$-a.e.
\end{lemma}
\begin{proof}[Proof of sublemma]
For any function $g$, $g \geq -|g|$. So
$$\int_X \overline f_M ~d\mu \geq \int_X \limsup_{n \to \infty} \frac{1}{n} \sum_{j=0}^{n-1} -|f \circ T^j| ~d\mu.$$
By Fatou's lemma,
$$\int_X \overline f_M ~d\mu \geq \limsup_{n \to \infty} \frac{1}{n} \int_X \sum_{j=0}^{n-1} -|f \circ T^j| ~d\mu = -\int_X |f| ~d\mu > -\infty$$
since $T$ is measure-preserving.
\end{proof}

Fix $\varepsilon > 0$. If $\overline f(x) < \infty$ then there is an $n$ such that
$$\frac{1}{n} \sum_{j=0}^{n-1} f(T^j(x)) \geq \overline f(x) - \varepsilon.$$
Let $n(x)$ be the smallest such $n$ witnessing this. If $\overline f(x) = \infty$ then there is a $n$ such that
$$\frac{1}{n} \sum_{j=0}^{n-1} f(T^j(x)) \geq M$$
so we may let $n(x)$ be the smallest such witness. Then
$$\overline f_M(x) \leq \frac{1}{n(x)} \sum_{j=0}^{n-1} f(T^j(x)) + \varepsilon.$$

For each $R > 0$, let
$$A_R = \{x \in X: n(x) > R\}.$$
Then the $A_R$ form a chain: if $R' > R$ then $A_{R'} \subseteq A_R$. Moreover, $\bigcap_R A_R = \emptyset$ and $\mu$ is a probability measure, so $\mu(A_R) \to 0$ as $R \to \infty$. Since $\mu$ is a probability measure, the constants are in $L^1(\mu)$ so
$$\lim_{R \to \infty} \int_{A_R} (|f| + M) ~d\mu = 0.$$

Fix $R > 1$. Let $n_i(x)$ be defined inductively. Let $n_0(x) = 0$. If $T^{n_i(x)}(x) \notin A_R$, let
$$n_{i+1}(x) = n_i(x) + n(T^{n_i(x)}(x)).$$
Otherwise, $T^{n_i(x)}(x) \in A_R$ and let $n_{i+1}(x) = n_i(x) + 1$, and we have
$$1 \leq n_{i+1} - n_i \leq R.$$

Suppose $T^{n_i(x)}(x) \notin A_R$. Then
$$n(T^{n_i(x)}(x))\overline f_M(T^{n_i(x)}(x)) \leq \sum_{j=0}^{n(T^{n_i(x)}(x))} f(T^{k + n_i(x)})(x) + n(T^{n_i(x)}(x))\varepsilon.$$
Clearly the constants are invariant functions and $\overline f$ is invariant under $T$. So
$$(n_{i+1} - n_i)(x) \overline f_M(x) \leq \sum_{j=n_i(x)}^{n_i(x) + 1} f(T^j(x)) + (n_{i+1} - n_i)(x) \varepsilon.$$

On the other hand, if $T^{n_i(x)}(x) \in A_R$, then we use the estimate $\overline f_M(x) \leq M$ and $n_{i+1}(x) - n(x) = 1$ to see that
$$(n_{i+1} - n_i)(x) \overline f_M(x) \leq M.$$

Let
$$\tilde f_M = f + (|f| + M)1_{A_R}.$$
Then in both cases,
$$(n_{i+1} - n_i)(x) \overline f_M(x) \leq \sum_{j=n_i(x)}^{n_{i+1}(x)} \tilde f_M(T^j(x)) + (n_{i+1} - n_i)(x)\varepsilon.$$

Fix some large $N$; then for any $x$ there is $k$ such that $n_k(x) \leq N \leq n_{k+1}(x)$. Then the series in question telescope and
\begin{align*}N \overline f_M(x) &\leq \sum_{j=0}^{n_k(x) - 1} \tilde f_M(T^j(x)) + (N - n_k(x))\overline f_M(x) + n_k(x)\varepsilon
\\& \leq \sum_{j=0}^{N-1} \tilde f_M(T^j(x)) - \sum_{j=n_k(x)}^{N-1} \tilde f_M(T^j(x)) + RM + N\varepsilon
\\& \leq \sum_{j=0}^{N-1} \tilde f_M(T^j(x)) - \sum_{j = N-R}^{N-1} |f(T^j(x))| + RM + N\varepsilon
\end{align*}
since $-|f| \leq |\tilde f|$. Dividing both sides by $N$,
$$\overline f_M(x) \leq \frac{1}{N} \sum_{j=0}^{N-1} \tilde f_M(T^j(x)) + \frac{1}{N} \sum_{j=N-R}^N |f(T^j(x))| + \varepsilon + \frac{RM}{N}.$$
We integrate both sides $d\mu(x)$. Then since $\mu(A_R) \leq \mu(X) = 1$,
\begin{align*}\int_X \overline f_M ~d\mu &\leq \int_X \tilde f_M + \frac{R}{N} \int_X |f| + \varepsilon + \frac{RM}{N} ~d\mu
\\ &\leq \int_X f~d\mu + \int_{A_R} (|f| + M)~d\mu + \frac{R}{N} ||f||_{L^1(\mu)} + \varepsilon + \frac{RM}{N}.
\end{align*}
Taking $N \to \infty$, we have
$$\int_X \overline f_M ~d\mu \leq \int_X f ~d\mu + \int_{A_R} (|f| + M) ~d\mu + \varepsilon.$$
Taking $R \to \infty$ and $\varepsilon \to 0$,
$$\int_X \overline f_M ~d\mu \leq \int_X f~d\mu.$$
Let $g_M = \overline f_M - \overline f_0$. Since the $\overline f_M$ are an increasing sequence, $g_M \geq 0$ and the $g_M$ form an increasing sequence. Moreover, we already proved that
$$\int_X \overline f_0 ~d\mu > -\infty.$$
Since $\overline f_0 \leq 0$, $\overline f_0 \in L^1(\mu)$. So the monotone convergence theorem implies that $g_M \to \overline f - \overline f_0$ in $L^1(\mu)$. This implies that
$$\int_X \overline f - \overline f_0 \leq \int_X f - \overline f_0 ~d\mu$$
as desired.
\end{proof}
We are finally ready to prove the pointwise ergodic theorem.
\begin{proof}[Proof of pointwise ergodic theorem]
It remains to show that the limit is $E(f|J)$. This follows from the mean ergodic theorem if $f \in L^2(\mu)$, since then $E(f|J) = Pf$. Otherwise, $f \notin L^2(\mu)$ but there is a $g \in L^2(\mu)$ such that $S_ng/n \to Pg$ a.e. and $||f - g|| < \varepsilon$. Moreover, we can find an $n$ such that
\begin{align*}||S_nf/n - Pf||_1 &\leq ||S_n(f-g)/n||_1 + ||S_ng/n - Pg||_1 + ||Pf - Pg||_1\\& \leq ||f - g||_1 + ||S_ng/n - Pg||_2 \leq ||f - g||_1 < 3\varepsilon.\end{align*}
Therefore $S_nf/n \to Pf= E(f|J)$.
\end{proof}
\begin{example}
We apply the pointwise ergodic theorem to the shift map. Fix a probability vector $p$. As a black box, we will assume that the shift map is ergodic; i.e. if $A \subseteq \Sigma_m^+$ is a Borel set and $T^{-1}(A) = A$ then $\mu_p(A)(1 - \mu_p(A)) = 0$. Let $\ell$ be a letter and $f = 1_{C_\ell}$ the indicator function of its cylinder. Then the Birkhoff ergodic average for $n$ iterates on a sequence $x$ is $1/n$ times the number of $j$ such that $x_j = \ell$, for $j \leq n$, since
$$T^j(x) = x_{j+1}x_{j+2}\cdots.$$
By the pointwise ergodic theorem, the Birkhoff average converges to $p_\ell$, $\mu_p$-a.e. As a corollary, we have proven the \dfn{law of large numbers}.
\end{example}

\section{Ergodic systems}
\begin{definition}
Let $(X, \Sigma, \mu)$ be a measure space and $T: X \to X$ a $\mu$-invariant transformation. We say that $T$ is an \dfn{ergodic transformation} for $\mu$, or that $\mu$ is an \dfn{ergodic measure} for $T$, if for every $A \in \Inv T$, $\mu(A) = 0$ or $\mu(A^c) = 0$.
\end{definition}
\begin{definition}
Let $(X, \Sigma, \mu, T, d)$ be an ergodic system equipped with a metric $d$ and assume that $\Sigma$ is the Borel $\sigma$-algebra for $d$. We say that $T$ is \dfn{uniquely ergodic} if the choice of $\mu$ is unique on $\Sigma$.
\end{definition}
We have already proven that the irrational rotation is uniquely ergodic, and since we have multiple choices of probability vector, the shift is not uniquely ergodic but is ergodic.
\begin{example}
We consider the multiplication map by $m$ on the circle, namely, $T: S^1 \to S^1$ has $T(x) = mx$ mod $1$ for some $m > 0$. Then $T$ is ergodic for Lebesgue measure $\mu$, in a particularly strong form, namely that
$$\lim_{n \to \infty} \mu(A \cap T^{-n}(B)) = \mu(A) \mu(B).$$
If we put $B = A^c$ this obviously implies that $\mu$ is a $T$-ergodic measure. To prove this claim we use this lemma.
\begin{lemma}
Let $T$ be the multiplication map, $f,g \in L^2(\mu)$. Then
$$\int_0^1 f \circ T^n(x) g(x) ~dx = \int_0^1f \int_0^1 g.$$
\end{lemma}
\begin{proof}
It suffices to check on an orthonormal basis of $L^2(\mu)$, namely $e_\ell(x) = e^{2\pi ix\ell}$. Then
$$\int_0^1 e_\ell \circ T^n(x) e_k(x) ~dx = \int_0^1 e^{2\pi i(\ell m^n + k)x} ~dx.$$
As $n \to \infty$ and either $\ell \neq 0$ or $k \neq 0$ then this integral goes to $0$. Otherwise, if $\ell = k = 0$, the integral is $1$. This proves the lemma on an orthonormal basis.
\end{proof}
The multiplication map has many invariant measures. In fact, $T$ has many periodic points and fixed points. The fixed points are intersections of the graph of $T$ with the identity map, of which there are a positive but finite set, which grows as $m \to \infty$. Replacing $T$ with $T^n$ replaces $m$ with $m^n$ which clearly $\to \infty$ as $n$ does. Fixed points of $T^n$ are periodic points, so the periodic points are dense.
\end{example}
\begin{example}
We show that the shift map on $\Sigma_m^+$ are ergodic. We identify $\overline x \in \Sigma_m^+$ with the number $x \in [0, 1]$ of which $\overline x$ is a $m$-ary expansion. The map $\pi(\overline x) = x$ is not injective because $m$-ary expansions are not unique. If we let $p = (1/m, \dots, 1/m)$ then $\pi_*\mu_p$ is Lebesgue measure and $T$ is conjugate up to a null set to the multiplication map by $m$. If $m = 3$ and $p = (1/2, 0, 1/2)$ then $\pi_*\mu_p$ is supported on the standard null Cantor set, which is its Hausdorff measure (the \dfn{Cantor-Lebesgue measure}).

For any cylinder $C_y$ generated by the word $y$,
$$\mu_p(T^{-1}(C_y)) = \mu_p \bigcup_{\ell=0}^{m-1} c_{\ell \cdot y} = \sum_{\ell=0}^{m-1} \mu_p(C_{\ell \cdot y}) = \sum_{\ell=0}^{m-1} p_\ell p_y = \mu_p(C_y).$$
So $\mu_p$ is $T$-invariant. Moreover, if $N > \ell > 1$ then
$$\mu_p(T^{-N}(C_y \cap C_z)) = \mu_p \bigcup_{|x| = N} C_{x \cdot y} \cap C_z = \mu_p \bigcup_{|x| = N - \ell} C_{z\cdot x \cdot y} = \mu_p(C_z) \mu_p(C_y)$$
where $|x|$ denotes the length of the word $x$. This proves that $\mu_p$ is an ergodic measure, and since $p$ is very far from unique, we have lots of ergodic measures for $T$. Thus $\pi_*\mu_p$ is an ergodic measure for the multiplication map. In fact these measures are often mutually singular:
\begin{lemma}
Let $p, p'$ be probability vectors. Then $\mu_p \perp \mu_{p'}$.
\end{lemma}
\begin{proof}
We prove this in the case $m = 2$. Let $p = (P, 1 - P)$ and $p' = (P', 1 - P')$. For any $P$, let
$$F_P = \{x \in \Sigma_m^+: \lim_{n \to \infty }\frac{\card \{x_i = 0: i \leq n\}}{n} = P\}.$$
Then if $P \neq P'$, $F_P \cap F_{P'}$ is empty. Let $f(x) = 1$ if $x_1 = 0$ and $f(x) = 0$ otherwise. Then the ergodic theorem implies that
$$\frac{\card \{x_i: i \leq n\}}{n} = \frac{S_nf(x)}{n} \to \int f = P,$$
$\mu_p$-a.e. Therefore $\mu_p(F_P) = \mu_p(\Sigma_m^+) = 1$. So $\mu_p(F_{P'}) = 0$ whence $\mu_p \perp \mu_{p'}$.
\end{proof}
This is very shocking because in the weakstar topology, $\mu_p$ can be approximated arbitrarily well by the $\mu_{p'}$ as $p' \to p$.
\end{example}

\section{Properties of ergodic transformations}
\begin{theorem}
For $(X, \mu)$ a measure space, $T: X \to X$ is ergodic iff for every measurable $f: X \to \RR$, $f \circ T = f$ a.e. implies that $f$ is constant a.e.
\end{theorem}
\begin{proof}
Let $c_1$ be the supremum of all $t$ such that $\mu(f^{-1}((-\infty, t))) = 0$ and $c_2$ the infimum of all $t$ such that $\mu(f^{-1}([t, \infty])) = 0$. Then the union of these two preimages is $X$ so $c_1 = c_2$, and $f = c_1$ a.e.
\end{proof}
We now restrict to the case that $X$ is a compact metric space.
\begin{definition}
Let $X$ be a compact metric space. Let $\mathcal M(X)$ denote the set of all Borel probability measures on $X$. If $T: X \to X$ is continuous, let $\mathcal M(X, T)$ be the set of all $T$-invariant Borel probability measures and $\mathcal M_e(X, T)$ the set of ergodic measures in $\mathcal M(X, T)$.
\end{definition}
\begin{example}
Ergodic transformations are not dense in a typical topology for mappings $X \to X$. In fact, if it was, then a slight perturbation of the solar system would make the orbit of the earth dense in the solar system, which would be quite bad.
\end{example}
\begin{theorem}[Krylov-Bogolibabov]
The set $\mathcal M(X, T)$ is nonempty.
\end{theorem}
That is, every transformation has an invariant measure. In fact, this measure can be taken to be a Radon measure.
\begin{proof}
Let $S_nf(x) = \sum_{j=0}^{n-1}f(T^j(x))$ be the ergodic average of $f$, as usual. Since $X$ is compact, $C(X)$ is separable and we may choose $(\varphi_m)_m$ to witness this. Fix $(x, m)$ and consider $S_n(\varphi^m(x))/m$. This sequence is bounded in $\RR$, so has a congergent subsequence, and by Cantor's diagonal argument we may choose the subsequence to converge for every $m$, say to $J(\varphi_m)$. Then $|J(\varphi_m)| \leq ||\varphi^m||_\infty$, and $J$ is a positive functional, so $J$ extends to a Radon probability measure $\mu$ on $X$. Moreover,
$$\frac{S_{n_k}}{n_k}\varphi_m(T(x)) = \frac{S_{n_k}}{n_k} \varphi_m(x) + \frac{\varphi_m(T^{n_k})(x) - \varphi_m(x)}{n_k}$$
which as the subsequence $n_k \to \infty$ converges to
$$J(\varphi_m \circ T) = J(\varphi_m) + 0$$
whence $\mu$ is $T$-invariant.
\end{proof}
It is easy to see that $\mathcal M(X, T)$ is weakstar closed, and that it is convex. Since $\mathcal M(X)$ is bounded, the Banach-Alaoglu theorem implies that $\mathcal M(X, T)$ is actually weakstar compact.
\begin{theorem}
The set $\mathcal M_e(X, T)$ is the set of extreme points of $\mathcal M(X, T)$.
\end{theorem}
\begin{proof}
Assume $\mu$ is not ergodic. Then there is an invariant set $A$ such that $0 < \mu(A) < 1$. Let $\mu|B$ denote the restriction of $\mu$ to the measurable set $B$. We have
$$\mu = \mu(A)\frac{\mu|A}{\mu(A)} + \mu(A^c) \frac{\mu|A^c}{\mu(A^c)}.$$
Then $\mu|A/\mu(A)$ and $\mu|A^c/\mu(A^c)$ are invariant Borel probability measures, so $\mu$ is not an extreme point.

Now suppose $\mu$ is ergodic and suppose $\mu = t\mu_1 + (1-t)\mu_2$ and $0 < t < 1$, where $\mu_1,\mu_2$ are invariant measures. We claim $\mu_1 = \mu_2$, which implies that $\mu$ is an extreme point. In fact, $\mu_1,\mu_2$ are absolutely $\mu$-continuous.
Let $\rho_1 \in L^1(\mu)$ be the Radon-Nikodym derivative of $\mu_1$ with respect to $\mu$. Then $\rho_1 \geq 0$.
Let $F = \{x \in X: \rho_1(x) < 1\}$. Then $\mu(T^{-1}F) = \mu(F)$ and some set-theoretic computations prove
$$\mu(F \setminus T^{-1}F) = \mu(T^{-1}F \setminus F).$$

Suppose $\mu(F \setminus T^{-1}F)$ is nonzero. Then
$$\mu(F \setminus T^{-1}F) > \int_{F \setminus T^{-1}F} \rho_1 ~d\mu = \int_{T^{-1}F \setminus F} \rho_1 ~d\mu \geq \mu(T^{-1}F \setminus F)$$
which is a contradiction. Therefore $\mu(F \setminus T^{-1}F) = 0$, so $F$ is almost $T$-invariant.

Since $\mu$ is ergodic, either $\mu(F) = 0$ or $\mu(F) = 1$. If $\mu(F) = 1$ then
$$1 = \mu_1(X) = \int_F \rho_1 ~d\mu < \mu(F) = 1$$
which is a contradiction. Therefore $F$ is $\mu$-null. Something similar happens on the set of $x$ such that $\rho_1(x) > 1$. Therefore $\rho_1 = 1$ in $L^1(\mu)$. So $\mu = \mu_1$.
\end{proof}
\begin{corollary}
Every transformation has an ergodic measure.
\end{corollary}
\begin{proof}
Use the Krein-Milman theorem.
\end{proof}
\begin{corollary}
If $\mu,\nu \in \mathcal M_e(X, T)$ then either $\mu = \nu$ or $\mu \perp \nu$.
\end{corollary}
\begin{proof}
By the Radon-Nikodym-Lebesgue decomposition, we can write
$$\mu = t\nu_1 + (1 - t)\nu_2$$
where $\nu_1,\nu_2 \in \mathcal M(X, T)$, $\nu_1$ is $\nu$-a.c. and $\nu_2 \perp \nu$. It follows that $t = 0$.
\end{proof}

\section{Mixing transformations}
\begin{definition}
Let $(X, \mu)$ be a probability space. We say $T: X \to X$ is \dfn{mixing} if for every measurable sets $A, B$,
$$\lim_{n \to \infty} \mu(A \cap T^{-n}B) = \mu(A)\mu(B).$$
\end{definition}
\begin{lemma}
A mixing transformation is ergodic.
\end{lemma}
\begin{proof}
For any invariant set $A$,
$$0 = \lim_{n \to \infty} \mu(A \cap T^{-n}(A^c)) = \mu(A)\mu(A^c)$$
so $\mu(A) = 0$ or $\mu(A^c) = 0$.
\end{proof}
\begin{example}
Let $X = \{0, 1\}$ and $\mu(\{0\}) = \mu(\{1\}) = 1/2$. Let $T$ be the only nontrivial bijection $X \to X$. Then the invariant sets are $X,\emptyset$ so $(X, \mu, T)$ is ergodic. But then
$$\mu(T^{-n}(\{0\}) \cap \{0\})$$
oscillates between $1/2$ and $0$ so the system is not mixing. Here the problem is periodicity.
\end{example}
\begin{lemma}
A system $(X, \mu, T)$ is mixing iff there is a $D \subset L^2(\mu)$ such that the span of $D$ is dense in $L^2(\mu)$ and for every $f, g\in D$,
$$\lim_{n \to \infty} \int_X f(T^n(x))g(x) ~d\mu(x) = \int_X f~d\mu \int_X g~d\mu.$$
\end{lemma}
\begin{proof}
The set of all indicator functions is an example of such a $D$.
\end{proof}
In other words, any two random variables become ``approximately independent" as time goes on.
\begin{example}
The multiplication map is mixing; here $D$ is the standard basis of the trigonometric polynomials.
\end{example}
\begin{example}
The irrational rotation is not mixing. Again this can be checked on the standard basis of trigonometric polynomials. This is because the irrational rotation is approximable arbitrarily well by rational rotations, which are periodic.
\end{example}

Let $M \in \GL(n, \ZZ)$. Since $M$ extends to an element of $\GL(n, \RR)$ which preserves $\ZZ^n$, $M$ drops to an automorphism of the torus $\TT^n$. Moreover, Lebesgue measure drops to a measure on $\TT^n$, so $\TT^n$ is a probability space.
\begin{theorem}
Let $M \in \GL(n, \ZZ)$ viewed as an automorphism of $\TT^n$. If $\det M \neq 0$ then $M$ is measure-preserving. Moreover, if $\Spec M$ does not contain any roots of unity, then $M$ is mixing.
\end{theorem}
\begin{proof}
We note that $M$ is measure-preserving if and only if for every $f \in L^2(\TT^n)$,
$$\int_{\TT^n} f \circ M = \int_{\TT^n} f$$
and in fact it suffices to check this on a dense subset $D$ of $L^2(\TT^n)$. In fact we let $D = \{e_\ell: \ell \in \ZZ^n\}$ where
$$e_\ell(x) = e^{2\pi i\langle \ell, x\rangle}.$$
Then $D$ is dense in $L^2(\TT^n)$ because every function in $L^2(\TT^n)$ has a multivariate Fourier series. Moreover,
$$\int_{\TT^n} e_\ell \circ M = \int_{\TT^n} e^{2\pi i\langle Mx, \ell\rangle} ~dx = \int_{\TT^n} e^{2\pi i\langle x, M^t\ell\rangle} ~dx.$$
Since $\det M^t \neq 0$, $M^t\ell \neq 0$ if $\ell \neq 0$ and $M^t0 = 0$. But then
$$\int_{\TT^n} e^{2\pi i\langle x, M^t\ell\rangle} ~dx = \int_{\TT^n} e_\ell.$$

For mixing, note that
$$\int_{\TT^n} e_\ell \circ M^N \overline{e_k} = \int_{\TT^n} e^{2\pi i\langle x, (M^N)^t \ell - k} ~dx.$$
In fact the integral is zero unless $(M^N)^t \ell - k = 0$, in which case the integral is $1$. If $\ell \neq 0$ or $k \neq 0$ then the integral is $0$ unless $(M^N)^t \ell = k$. Therefore the limit is nonzero if there are $N_1 < N_2$ such that $(M^{N_1})^t \ell = (M^{N_2})^t \ell = k$.
Solving for $k$ this happens iff $(M^{N_2 - N_1})^t \ell = \ell$. But this means that there is an eigenvalue $\lambda$ such that $\lambda^{N_2 - N_1} = 1$, which contradicts our hypothesis.
\end{proof}
\begin{example}
Suppose $M = \begin{bmatrix}2&1\\1&1\end{bmatrix}$. Then $\det M = 1$ and $M$ sends $\TT^2$ to itself, in fact is mixing and invertible. In particular $M$ is ergodic for Lebesgue measure.

We show that $M$ is not uniquely ergodic by looking for periodic points, i.e. $x$ such that there exists $n$ with $M^nx = x$. For $n = 1$, $0$ is periodic (i.e. a fixed point). In fact it is the unique fixed point.
Thus we let $\nu$ be the point mass centered at $0$. Clearly $\nu$ is a Borel measure which is invariant, and in fact ergodic.

Stronger, periodic points are dense in $\TT^2$, namely rational points are periodic. We count the number of points of period $n$. Let $\Fix(n) = \{x \in \TT^2: M^nx = x\}$. Viewing $[0, 1)^2$ as the fundamental domain of $\TT^2$ we have
$$\Fix(n) = \{x \in [0, 1)^2: (M^n - 1)x \in \ZZ^2\}.$$
We compute the integer points in the parallogram $(M^n - 1)[0, 1)^2$ using Pick's theorem. This is the area of $(M^n - 1)[0, 1)^2$, i.e.
$$\det (M^n - 1) = (\lambda^n - 1)(\lambda^{-n} - 1) = \lambda^n + \lambda^{-n} - 2$$
where $\lambda$ is the largest eigenvalue of $M$ (so $\lambda^{-1}$ is its smallest eigenvalue.) Thus
$$\card \Fix(n) = \lambda^n + \lambda^{-n} - 2.$$
In particular, $M$ is far from uniquely ergodic.

We now introduce the \dfn{Artin-Mazur zeta function} defined by
$$\zeta(z) = \exp\left(\sum_{n=1}^\infty \frac{z^n \card \Fix(n)}{n} \right).$$
For any $C^\infty$ diffeomorphism of a compact manifold this zeta function has a positive radius of convergence. We check this for $M$. In fact
$$\zeta(z) = \exp\left(\sum_{n=1}^\infty \frac{(\lambda^n + \lambda^{-n} - 2)z^n}{n}\right) = \exp\left(\sum_{n=1}^\infty \frac{(\lambda z)^n}{n} + \frac{(\lambda^{-1} z)^n}{n} - \frac{2z^n}{n}\right)$$
and since
$$\log (1-z) = -\sum_{n=1}^\infty \frac{z^n}{n}$$
it follows that
$$\zeta(z) = \frac{(1 - z)^2}{(1 - \lambda z)(1 - \lambda^{-1}z)}.$$
This is a rational function whose smallest pole is $-\lambda^{-1}$. This is related to the fact that the rate of growth of $\Fix(n)$ is asymptotically $\lambda^n$.
\end{example}

\begin{theorem}
Suppose that $M = \begin{bmatrix}2 & 1\\1 &1 \end{bmatrix}$, viewed as an automorphism of $\TT^2$. Then there is a $\varepsilon > 0$ such that for every $g = M + \delta g$, where $\delta g: \TT^2 \to \TT^2$ satisfies $||\delta g||_{C^1} < \varepsilon$, there is a homeomorphism $h: \TT^2 \to \TT^2$ such that $h \circ g = M \circ h$.
\end{theorem}
To prove this we need to use \dfn{Neumann series}; namely, if $||A|| < 1$ is a linear operator then
$$(1 - A)^{-1} = \sum_{k=0}^\infty A^k.$$
\begin{proof}
We construct $h$ to be of the form $h = \id + \delta h$ where $||\delta h||_{C^1}$ is small. If this is to hold then
$$(\id + \delta h) \circ (M + \delta g) = M \circ (\id + \delta h)$$
which simplifies to
$$M^{-1} \circ (\id + \delta h) \circ (M + \delta g) = \id + \delta h$$
i.e.
$$M^{-1} \circ \delta g + M^{-1} \circ \delta h \circ h = \delta h.$$
Thus $\delta h$ is a fixed point of the mapping
$$f \mapsto M^{-1} \circ \delta g + M^{-1} \circ f \circ g.$$
Unfortunately we cannot use the contraction fixed point theorem because $M^{-1}$ is not contracting (since $\lambda > 1$).

Let $\{e_+, e_-\}$ be the normalized eigenbasis of $M$. Decompose $\delta h$ as
$$\delta h = h_+ e_+ + h_- e_-$$
and similarly for $\delta g$. Then the fixed-point equation is
\begin{align*}
\lambda^{-1}g_+ + \lambda^{-1}h_+ \circ g &= h_+,\\
\lambda g_- + \lambda h_- \circ g &= h_-.\end{align*}

Let $X = C(\TT^2 \to \RR)$. Let $F_+f = \lambda^{-1} g_+ + \lambda^{-1}f g$ and $F_-f = -g_- \circ g^{-1} + \lambda^{-1} f \circ g^{-1}$. Then $F_+,F_-$ send $X$ to itself. Since $||M - g||_{C^1} = ||\delta g||_{C^1}$ is small and $M$ is invertible, $g$ is invertible by the inverse function theorem.

Then $F_+, F_-$ are contractions in $L^\infty$, so by the contraction fixed point theorem, there are $h_\pm$ which are fixed points of $F_\pm$. So
$$h = \id + h_+e_+ + h_-e_-$$
is the desired function. But $h$ may not be a homeomorphism. To fix this, we construct $\tilde h = \id + \delta \tilde h$ such that $\delta \tilde h$ is periodic and $||\delta \tilde h||_{C^1}$ is small such that $g \circ \tilde h = \tilde h \circ M$. Then $h^{-1} = \tilde h$.

Note that the fixed point $f$ of the contraction fixed-point theorem in a Banach space is given by the telescoping sum
$$f = f_0 + \sum_{n=0}^\infty f_{n+1} - f_n$$
where $f_0$ is the initial datum of the iteration and $f_{n+1} = Ff_n$, $F$ the given contraction. We assume that $f_0 = 0$ and $\theta$ is the constant of contraction for $F$, then
$$||f|| \leq \sum_{n=0}^\infty ||f_{n+1} - f_n|| \leq \frac{\theta}{1 - \theta} ||f_1||.$$
In this case,
$$||h_+||_{L^\infty} \leq \frac{1}{\lambda - 1} ||g_+||_{L^\infty}$$
and
$$||h_-||_{L^\infty} \leq \frac{1}{1 - \lambda^{-1}} ||g_-||_{L^\infty}.$$

Now $\tilde h$ has the required properties iff
$$\delta \tilde h \circ M - M - \delta \tilde h = \delta g \circ (\id + \delta \tilde h).$$
So we define a linear operator $L$ by
$$Lf = f \circ M - M \circ f.$$
We now write $\delta \tilde h$ in the eigenbasis $\{e_-, e_+\}$, so
$$L(\tilde h_- e_- + \tilde h_+e_+) = e_- \tilde h_- \circ M + e_+ \tilde h_+ \circ M - \tilde h_- \lambda^{-1} e_- - \tilde h_+ \lambda e_+.$$
The equation decouples so we have
$$L_\pm \tilde h_\pm = \tilde h_\pm \circ M - \lambda^{\pm 1} \tilde h_\pm.$$
We invert the operators $L_\pm$ using a Neumann series. In fact,
$$L_- \tilde h_- = (\tilde h_- - \lambda^{-1} \tilde h_- \circ M^{-1}) \circ M$$
Therefore
$$L_-^{_1}H = \sum_{n=0}^\infty \lambda^{-n} H \circ M^{-n-1}.$$
One can then show
$$L_+^{-1}H = -\sum_{n=0}^\infty \lambda^{-1-n}H \circ M^n.$$
Then
$$L^{-1}(H_+ e_+ + H_- e_-) = L_+^{-1}H_+e_+ + L_-^{-1}H_-e_-.$$
So it suffices to construct $\delta \tilde h$ such that
$$\delta \tilde h = L^{-1}(\delta g \circ (\id + \delta \tilde h)).$$
Let $G(f) = L^{-1}(\delta g \circ (\id + f))$.
We must show $G$ is a contraction. In fact,
$$||G(f_1 - f_2)||_{C^0} \leq ||L^{-1}||_{C^0 \to C^0} ||\delta g||_{C^1} ||f_1 - f_2||_{C^0} < \varepsilon ||L^{-1}||_{C^0 \to C^0} ||f_1 - f_2||_{C^0}.$$
So if $||L^{-1}||_{C^0 \to C^0} > 1/\varepsilon$ it follows that $G$ is a contraction of $C^0$.

Therefore $\tilde h$ exists so
$$h \circ g \circ \tilde h = \tilde h \circ M$$
whence $M$ commutes with $h \circ \tilde h = \id + f$ for some periodic function $f$. In particular $f$ commutes with $M$, and writing $f$ in the eigenbasis,
$$\lambda f_+ e_+ + \lambda^{-1} f_- e_- = (f_+ \circ M)e_+ + (f_- \circ M) e_-.$$
Decoupling again,
$$f_\pm = \lambda^{-n} f_\pm M^{\pm n}$$
and iterating $f_\pm$ sends it to $0$, so $f_\pm = 0$.
\end{proof}
We consider when the above stability properties generalize. Let $S \in C^\infty(\TT^2 \to \TT^2)$ be a diffeomorphism and consider the mapping of the tangent space
$$dS(x): T_x\TT^2 \to T_{S(x)}\TT^2.$$
Suppose that each tangent space splits
$$T_x\TT^2 = E_+(x) \oplus E_-(x)$$
where $dS(x)$ sends $E_\pm(x)$ to $E_\pm(S(x))$ and $x \mapsto E_\pm(x)$ is a continuous mapping into the Grassmannian. In the above proof we used the existence of a $\theta \in (0, 1)$ such that
$$||dT^n(x)v|| \leq C\theta^{|n|} ||v||$$
where $||\cdot||$ is the norm on $T_x\TT^2$ induced by the Riemannian metric of $\TT^2$ and if $v \in E_-(x)$ then the inequality ranges over $n\geq 0$, if $v \in E_+(x)$ then $n \leq 0$. Such a diffeomorphism is called an \dfn{Anosov diffeomorphism}. Very few compact Riemannian manifolds admit Anosov diffeomorphisms, and they have quite remarkable properties. For example, if $S$ is Anosov and measure-preserving then $S$ is mixing, but it is not even known if an Anosov diffeomorphism is necessarily measure-preserving.

More concretely, let $T: \TT^2 \to \TT^2$ be the action of a matrix $M \in \SL(2, \ZZ)$. Suppose $M$ has eigenvalues $\lambda^{\pm 1}$ and $m = \lambda + \lambda^{-1}$ is the trace of $M$, so $m \in \ZZ$. If $m^2 > 4$ then we say that $M$ is a \dfn{hyperbolic matrix} and in this case $T$ acts just like the cat map, and in fact is mixing.
If $m^2 = 4$ then $M$ is said to be a \dfn{parabolic matrix}, is conjugate to a shear matrix, and $T$ is known as a \dfn{Dehn twist}.
If $m^2 < 4$ then $m = 0$ (in which case $\lambda = \pm i$) or $m^2 = 1$ (in which case $\lambda = \pm e^{i\pi/3}$). Either way the matrix is idempotent and hence is a rational rotation. We say that $M$ is an \dfn{elliptic matrix}, and note that $T$ is not ergodic.


\section{The Hopf argument}
We introduce a technique to show that certain transformations of Riemannian manifolds are ergodic.
\begin{definition}
Let $X$ be a metric space and $T: X \to X$ be continuous. The \dfn{stable manifold} of $x \in X$ is the set $W^s(x)$ of $y \in X$ such that
$$\lim_{n \to \infty} d(T^n(x), T^n(y)) = 0.$$
If $T$ is a homeomorphism then we also define the \dfn{unstable manifold} $W^u(x)$ to be the stable manifold for $T^{-1}$.
\end{definition}
That is, $W^s(x)$ is the set of $y$ such that forward orbits of $x$ and $y$ approach each other.
\begin{example}
Suppose $T$ is the cat acting on $\TT^2$. (Henceforth we consider the action of any hyperbolic matrix to be a cat map, since by a number-theoretic argument the eigenvalues of a hyperbolic matrix cannot be rational.) Then $W^s(x) = x + e_-\RR$. Since $e_-$ is not a rational point, $e_-\RR$ is dense in $\TT^2$ for the same reason that orbits of the irrational rotation are dense. So $W^s(x)$ is dense in $\TT^2$, as is $W^u(x) = x + e_+\RR$.
\end{example}
\begin{theorem}[Banach-Saks]
\index{Banach-Saks theorem}
Let $H$ be a Hilbert space and suppose that $f_n \to f$ in the weakstar topology of $H$. Then there is a subsequence $(f_{n_k})_k$ such that the averages
$$\lim_{N \to \infty} \frac{1}{N}\sum_{k=1}^N f_{n_k} = f$$
in the norm of $H$.
\end{theorem}
\begin{proof}
Replacing $f_n$ with $f_n - f$ we may assume that $f = 0$. We will choose the subsequence so
$$\sum_{i<j} |\langle f_{n_i}, f_{n_j}\rangle| \leq 2.$$
This is proven by induction. Let $n_1 = 1$, and suppose we have chosen $n_1, \dots, n_k$ so that whenever $i < j \leq k$,
$$|\langle f_{n_i}, f_{n_j}\rangle| < 2^{-j}.$$
To choose $n_{k+1}$, we use the fact that for every fixed $i \leq k$,
$$\lim_{n \to \infty} \langle f_{n_i}, f_n\rangle = 0$$
by definition of the weakstar topology. Therefore there is a $n_{k+1}$ such that
$$|\langle f_{n_i}, f_{n_{k+1}}\rangle| < \frac{1}{2^{k+1}}.$$
This completes the induction, and
$$\sum_{i<j} |\langle f_{n_i}, f_{n_j}\rangle| \leq \sum_{j=1}^\infty j2^{-j} \leq 2.$$
Thus
\begin{align*}\left|\left|\frac{1}{n} \sum_{k=1}^n f_{n_k}\right|\right|^2 &\leq \frac{1}{n^2} \sum_{k=0}^n ||f_{n_k}||^2
\\&= \frac{2}{n^2} \sum_{1 \leq i < j \leq n} |\langle f_{n_i}, f_{n_j}\rangle|
\\&\leq \frac{1}{n} \sup_n ||f_n||^2 + \frac{4}{n^2} = O(n^{-1})
\end{align*}
since the $f_n \to 0$ weakly and hence are bounded.
\end{proof}
\begin{definition}
Let $(X, d, \mu)$ be a metric Borel probability space, $T: X \to X$ measurable. A function $f: X \to \CC$ is \dfn{$W^s$-invariant} if there is a $X_0$ such that $\mu(X_0) = 1$ and for every $x, y \in X_0$, such that $y \in W^s(x)$, $f(x) = f(y)$.
\end{definition}
\begin{theorem}
\label{weakstar accumulation}
Let $(X, d, \mu)$ be a metric Radon probability space and $f \in L^2(\mu)$. If $T: X \to X$ is continuous then every weakstar accumulation point of $\{f \circ T^n\}_n$ is $W^s$-invariant. If $T$ is also invertible then every weakstar accumulation point is $W^u$-invariant.
\end{theorem}
We use the fact that $\mu$ is a Radon probability measure to apply the below lemma.
\begin{lemma}
\label{lipschitz is l2 dense}
If $\mu$ is a Radon probability measure then the Lipschitz functions are dense in $L^2(\mu)$.
\end{lemma}
\begin{proof}
We need only to show that the indicator functions can be approximated by Lipschitz functions (here we are using that $\mu$ is a probability measure). If $A$ is measurable then there is an  open set $U$ such that $A \subseteq U$, $\mu(U \setminus A) < \varepsilon$, and in particular
$$||1_A - 1_U|| < \sqrt \varepsilon.$$
Therefore we only need to approximate $1_U$ by Lipschitz functions. Let
$$u_k(x) = \min(1, kd(x, X \setminus U)).$$
Then the $u_k$ are Lipschitz and tend to $1_U$ as $k \to \infty$.
\end{proof}
\begin{proof}[Proof of Theorem \ref{weakstar accumulation}]
Suppose $g$ is a weakstar accumulation point of $\{f \circ T^n\}_n$; passing to a subsequence we may assume that $\lim_n f \circ T^n = g$ in the weakstar topology.

If $f$ is Lipschitz (and $M$ its Lipschitz seminorm) then by applying the Banach-Saks theorem and passing to a subsequence we may assume that
$$\lim_{n \to \infty} \Psi_n(x) = \lim_{n \to \infty} \sum_{k=1}^n f \circ T^n = g$$
in the norm topology, where $\Psi_n$ is the avergae of the first $n$ terms. By the Riesz-Fisher theorem and passing to a subsequence again, we may assume that $\Psi_n \to g$ a.e. Since $f$ is Lipschitz,
$$|\Psi_\ell(x) - \Psi_\ell(y)| \leq \frac{1}{\ell} \sum_{k=1}^\ell |f \circ T^k(x) - f \circ T^k(y)| \leq \frac{M}{\ell} \sum_{k=1}^\ell d(T^k(x), T^k(y)) < \varepsilon$$
if $\ell$ is large and $y \in W^s(x)$. But $||g(x) - g(y)| - |\Psi_\ell(x) - \Psi_\ell(y)|| < \varepsilon$ if $\ell$ is large so $g$ is $W^s$-invariant.

By Lemma \ref{lipschitz is l2 dense}, if $f \in L^2(\mu)$, we can find a Lipschitz function $f'$ such that $||f - f'|| < \varepsilon$ and then $||f' \circ T^n||_{L^2} < ||f||_{L^2} + \varepsilon$ whence we can pass to a subsequence and assume $f' \circ T^n \to g'$ for some $g'$. Then
$$||g - g'|| \leq \liminf_{n \to \infty} ||(f - f') \circ T^n||_{L^2} \leq ||f - f'|| < \varepsilon.$$
Taking $\varepsilon = 1/k$ we let $g_k'$ be the given $g'$. Then $g_k' \to g$ in $L^2$ and by the Riesz-Fischer theorem again we may again pass to a subsequence and assume $g_k' \to g$ a.e., which implies that $g$ is $W^s$-invariant.

Now let $I$ be the space of functions in $L^2(\mu)$ which are $W^u$-invariant. Then $I$ is $L^2$-closed, since any sequence in $I$ has an a.e. convergent subsequence by the Riesz-Fischer theorem, and the limit of such a subsequence is $W^u$-invariant. In addition the Koopman operator of $T$ preserves $I$.

We will prove that if $f \in I^\perp$ then $f \circ T^n \to 0$ in the weakstar topology. Applying the above argument to $T^{-1}$ that if $f \circ T^{-n} \to g_0$ in the weakstar topology then $g_0$ is $W^u$-invariant. Suppose $f \circ T^{n_k} \to g$ in the weakstar topology. Since $T$ is measure-preserving we have
$$\int_X (f \circ T)g ~d\mu = \int_X f(T(x))g(T(T^{-1}(x))) ~d\mu(x) = \int f(x)g(T^{-1}(x)) ~d\mu(x)$$
whence $T^* = T^{-1}$. Therefore
$$\langle g, g\rangle = \lim_{n \to \infty} \langle f \circ T^n, g\rangle = \lim_{n \to \infty} \langle f, g \circ T^{-n}\rangle = \langle f, g_0\rangle = 0$$
since $g_0 \in I$ and $f \in I^\perp$.

So if $f$ is just any function in $L^2(\mu)$, write $f = f_1 + f_2$ where $f_1 \in I$ and $f_2 \in I^\perp$. If $f \circ T^n \to g$ in the weakstar topology then we want to show that $g$ is $W^u$-invariant.
Now $f^2 \circ T^n \to 0$ weakly, so we just need to check this for $f_1$. Since $f_1 \in I$ it follows that $f_1 \circ T^n \in I$ and so $g \in I$.
\end{proof}
Note that we have proven something stronger. If $f$ is Lipschitz, then we do not need to assume that $\mu$ is a probability measure. However, the Hopf argument for ergodicity requires that $f$ be an arbitrary $L^2$ function, since we must consider simple functions (which are far from Lipschitz) so this technique for proving that $T$ is ergodic does not work in infinite measure.
\begin{theorem}[Hopf argument]
\index{Hopf argument}
Let $(X, d, \mu)$ be a metric Radon probability space and $f \in L^2(\mu)$. If $f = f \circ T$ then $f$ is $W^s$-invariant.
\end{theorem}
\begin{proof}
Every weak accumulation point of $\{f \circ T^n\}_n$ is just $f$, which is hence $W^s$-invariant.
\end{proof}
Now suppose $T$ is invertible and $f = f \circ T$. Then $f$ is $W^s$-invariant and also $W^u$-invariant. Modulo measure zero, we expect that $f$ is simply constant, since we can propagate any value of $f$ along the stable and unstable manifolds of $T$. Since $f$ was arbitrary it should follow that $T$ is ergodic. However, this argument does not work in general; if $X$ is a Riemannian manifold, for example, we need to show that the stable and unstable manifolds form a coordinate system for $X$, and that Lebesgue measure disintegrates into a tensor product of measures on the stable and unstable manifolds.

As an example we prove the following theorem again.
\begin{definition}
A \dfn{hyperbolic matrix} is a matrix $M$ such that $\Spec M$ does not meet the unit circle.
\end{definition}
\begin{theorem}
Let $M \in \SL(n, \ZZ)$ be a hyperbolic matrix and $T$ the action of $M$ on $\TT^n$. Then $T$ is mixing.
\end{theorem}
We already proved this already using Fourier analysis. But we can also prove this using the Hopf argument, a version of the Jordan canonical form, and a Fubini disintegration lemma.
\begin{lemma}
For every $M \in \CC^{n \times n}$ there are projections $P_j: \CC^n \to \CC^n $, eigenvalues $\lambda_j \in \CC$, and nilpotent matrices $N_j$, such that $P_iP_j = \delta_i^jP_j$, $MP_j = P_jM$, $\sum_j P_j = 1$, and
$$M = \sum_{j=1}^J (\lambda_j + N_j)P_j.$$
\end{lemma}
To prove this form of the Jordan form we note that we can write the resolvent as
$$(M - \lambda)^{-1} = \frac{\tilde M(\lambda)}{\det(M-\lambda)},$$
so $(M - \lambda^{-1})$ is a rational function which has poles at zeroes of $\det(M - \lambda)$. This uses the fact that $\lambda$ is a zero of $\det(M - \lambda)$ iff $\lambda$ is an
eigenvalue. Each pole is surrounded by a small disc $D_j$ containing no other poles, and we let
$$P_j = \frac{1}{2\pi i} \int_{\partial D_j} (\lambda - M)^{-1} ~d\lambda.$$
This decomposes $M$ into generalized eigenspaces using residue calculus.

As a consequence of this Jordan form, we note that if $n_j$ is the least power such that $N_j^{n_j = 0}$ and $L > n_j$ for all $j$, then
$$M^L = \sum_{j=1}^J \lambda_j^L + L\lambda_j^{L_1}N_j + \dots + \binom{L}{n_j-1}\lambda_j^{L-n_j+1} N_j^{n_j-1} P_j$$
so, if $M$ is a hyperbolic matrix, we let
$$P_s = \sum_{|\lambda_j| < 1} P_j$$
and $P_u = 1 - P_s$, and then $P_uM^{-L} \to 0$ and $P_sM^L \to 0$ as $L \to \infty$.

If $M$ is real, then every eigenvalue of $M$ is either real or has a complex conjugate which is also an eigenvalue. In particular, $P_u\CC^n$ and $P_s\CC^n$ admit real bases, and so restrict to subspaces of $\RR^n$, say $E_u$ and $E_s$.
\begin{lemma}
Let $(W, \lambda)$ and $(Y, \nu)$ be probability spaces. If $g \in L^2(\lambda \otimes \nu)$ and there is a $Z \subset W \times Y$ such that $\lambda \otimes \nu(Z) = 1$, and there are measurable functions $\varphi_W: W \to \RR$ and $\varphi_Y: Y \to \RR$ such that
for every $(w, y) \in Z$, $g(w, y) = \varphi_1(w)$ and $g(w, y) = \varphi_2(y)$, then $g$ is constant a.e.
\end{lemma}
\begin{proof}
By Fubini's theorem,
$$1 = (\lambda \otimes \nu)(Z) = \int_W \int_Y 1_Z(w, y) ~d\nu(y) ~d\lambda(w).$$
Therefore there is a $w_0 \in W$ and $Y_0 \subseteq Y$ such that $\nu(Y_0) = 1$ and $\{w_0\} \times Y_0 \subseteq Z$. Suppose $(w, y) \in Z \cap (W \times Y_0)$, which is true for almost every $(w, y) \in W \times Y$. Since $(w_0, y) \in Z$ it follows that
$$\varphi_1(w_0) = g(w_0, y) = \varphi_2(y) = g(w, y).$$
\end{proof}
\begin{proof}[Proof that $T$ is mixing]
Let $E_u$ be the span of eigenvectors whose eigenvalues $\lambda$ satisfy $|\lambda| > 1$ and $E_s$ the span of eigenvectors whose eigenvalues are $|\lambda| < 1$. This is possible as a consequence of our discussion of the Jordan form of $M$, and in particular $E_u \oplus E_s = \RR^n$.

We will prove that $W^u(x)$ is the projection of $x + E_u$ into the torus and similarly for $E_s$. In fact, $E_{s,u}$ is $M$-invariant; $E_s$ is contracted by $M$ and $E_u$ is expanded by $M$.

If $U$ is a small open neighborhood of $x_0 \in \TT^n$, and using the manifold structure to view $U$ as a subset of $\RR^n$, then locally it is true that $W_u \cong \RR^{n_u}$ and $W_s \cong \RR^{n_s}$, where $n_u + n_s = n$. Thus for $x \in U$ we have a decomposition $x = t + s$, $t \in \RR^{n_u}$ and $s \in \RR^{n_s}$.
Then $W^s(t_0, s_0) \cap U \supseteq \{(t_0, s): s \in \RR^{n_s}\} \cap U$, and similarly for $W^u$.

We now use the Hopf argument. Suppose $g$ is a weakstar limit of a subsequence of $f \circ T^n$, for some $f \in L^2(\TT^n)$. Then $g$ is $W^s$-invariant and $W^u$-invariant. After normalization we see that $U$ can be viewed as a subset of $\RR^{n_u} \times \RR^{n_s}$, but then the Fubini disintegration lemma implies that $g$ is constant a.e. in $U$.

So $g$ is locally constant a.e., hence constant a.e. In fact, $g = \int_{\TT^n} f$. So if $h \in L^2(\TT^n)$,
$$\lim_{k \to \infty} \int_{\TT^n} (f \circ T^n)h = \iint_{\TT^n \times \TT^n} fh = \int_{\TT^n} f \int_{\TT^n} h.$$
\end{proof}
We are also interested in mixing time, i.e. how many times we need to mix before two random variables $f,h$ become ``within $\varepsilon$ of being independent." If we want this to happen at an exponential rate, we will need to assume $f, h\in C^\infty(\TT^n)$, or at least some amount of Sobolev or Hoelder regularity. In particular, indicator functions are rarely exponentially mixing.

\chapter{Flows on manifolds}
\begin{definition}
A \dfn{flow} on a metric space $X$ is a continuous action of $\RR$ on $X$.
\end{definition}
By a continuous action we mean that the map $\RR \to C(X \to X)$ is continuous.
\begin{example}
Let $\dot x = Mx$ by an ODE on $\RR^n$, $M \in \RR^{n \times n}$. The solution of this flow is of course
$$\varphi_t(x) = e^{tM}x.$$
We say that this flow is hyperbolic if $\Spec M$ does not meet the imaginary axis, i.e. $e^M$ is a hyperbolic matrix.

This readily generalizes to when $f: \RR^n \to \RR^n$ is a bounded Lipschitz function, in which case the Picard-Lindelof theorem guarantees that $\dot x = f(x)$ has a solution.
\end{example}
Now let $\mu$ be a Borel measure on $X$. Then $\mu$ is $\varphi$-invariant if for all $A$,
$$\mu(\varphi_t(A))=\mu(A)$$
like usual. This is of course equivalent to the assumption that for every $f \in L^2(\mu)$,
$$\int_X f \circ \varphi_t~d\mu = \int_X f~d\mu.$$
\begin{example}
Let $\dot x = Mx$ like usual and suppose $M$ is traceless. Then the action of $M$ preserves Lebesgue measure. Similarly, $\dot x = f(x)$ is measure-preserving iff $\nabla \dot f = 0$.
\end{example}

\section{Ergodic theorems for flows}
We now generalize the ergodic theorem to actions of $\RR$.
\begin{theorem}
Let $(X, \mu)$ be a probability space, $\varphi$ an action of $\RR$ on $X$, and $\mu$ is $\varphi$-invariant. Then if $f \in L^1(\mu)$,
$$\lim_{T \to \infty} \frac{1}{T} \int_0^T f(\varphi_t(x)) ~dt = E(f|J)(x)$$
where $J$ is the $\sigma$-algebra generated by the $\varphi$-invariant measurable sets. In fact, if $f \in L^2(\mu)$, then
$$\lim_{T \to \infty} \frac{1}{T} \int_0^T f(\varphi_t(x)) ~dt = Pf(x)$$
where $P: L^2(\mu) \to \Inv T$ is the orthogonal projection.
\end{theorem}
\begin{proof}
By reduction to the discrete ergodic theorems we just need to show that the limit of those integrals exists. Let $\Omega = \RR^\ZZ$, and define $\Gamma: X \to \Omega$ by
$$\Gamma(x)_j = \int_j^{j+1} f(\varphi_t(x)) ~dt.$$
Now let $T: \Omega \to \Omega$ be the shift $(T\omega)_j = \omega_{j+1}$. Then $\Gamma \circ \varphi_1 = T \circ \Gamma$.

Define $\tilde \mu(A) = \mu(\gamma^{-1}(A))$. This is defined for some $\sigma$-algebra in $\Omega$, and is a measure since $\tilde \mu = \gamma_*\mu$.
Moreover $(\Omega, \tilde \mu, T)$ is a measure-preserving system:
$$\tilde \mu(T^{-1}A) = \mu(\Gamma^{-1} \circ T^{-1}A) = \mu(\varphi_1^{-1} \circ \Gamma^{-1}A) = \mu(\Gamma^{-1}A) = \tilde \mu(A).$$
Now apply Birkhoff's ergodic theorem to the function
$$F(\omega) = \omega_0.$$
Then
$$\frac{1}{n} \sum_{j=0}^{n-1} F(T^j(\omega)) = \frac{1}{n} \sum_{j=0}^{n-1} \omega_j.$$
So
$$\tilde \mu\{\omega: \lim_{n \to \infty} \frac{1}{n} \sum_{j=0}^{n-1} \omega_j \text{ exists}\} = 1.$$
But on the other hand this is
$$\mu\{x: \lim_{n \to \infty} \int_0^n f \circ \varphi_t(x) ~dt \text{ exists}\} = 1.$$
Up to a small error term we may replace a large $n$ in this limit by any sufficiently large positive real number.
\end{proof}

\section{Geodesic flows in hyperbolic space}
Let $\HH^2$ be the upper-half plane, viewed as a Riemann surface. We define a Hermitian metric on $\HH^2$.
This means that for every tangent vector $a + ib \in T_z\HH^2$ we assign a length
$$|a + ib|_z = \frac{\sqrt{a^2 + b^2}}{\Im z}.$$
If we were to translate the vector $a + ib$ along a curve $\gamma$ then $a + ib$ becomes longer as $\Im \gamma(s)$ decreases.
In fact the distance element is given by
$$ds^2 = \frac{dx^2 + dy^2}{y^2};$$
i.e. the length of a curve $\gamma$ is given by
$$\ell(\gamma) = \int_\gamma ~ds = \int_a^b |z'(s)|_{z(s)} ~ds = \int_a^b \frac{|z'(s)|}{\Im z(s)} ~ds.$$
We also have an area form
$$dA = \frac{dx~dy}{y^2}$$
or in other words, the area of a set $\Omega$ is given by
$$A(\Omega) = \iint_\Omega \frac{dx~dy}{y^2}.$$

Now consider the group
$$\PSL(2, \RR) = \frac{\SL(2, \RR)}{\pm 1}.$$
Then $\PSL(2, \RR)$ acts on $\PP^1_\CC$ by linear fractional transformations; in fact
$$\begin{bmatrix}a & b\\
c & d\end{bmatrix}z = \frac{az + b}{cz + d}$$
and it is easy to check that this action preserves $\RR$ and orientation, so restricts to an action on $\HH^2$; namely,
$$\Im \frac{az + b}{cz + d} = \frac{\Im z}{|cz + d|^2}.$$
The action of $\PSL(2, \RR)$ is transitive; i.e. the orbit of every element is $\HH^2$.
It suffices to check this on a single point, say $i$; clearly any element in the upper-half plane can be written in terms of $i$.

Note that the stabilizer of $i$ is the set of matrices such that
$$\frac{ai + b}{ci + d} = i;$$
i.e. those matrices such that $a=d$, $c=-b$, $a^2 + b^2 = 1$, or in other words the rotation matrices.
Thus the stabilizer of $i$ is isomorphic to $\PP^1_\RR$, and so the action of $\PSL(2, \RR)$ on $\HH^2$ is not free.

Since the action of $\PSL(2, \RR)$ has no poles in $\HH^2$ and it has nonzero derivatives, $\PSL(2, \RR)$ is a subgroup of the group of conformal automorphisms of $\HH^2$.
Thus $\PSL(2, \RR)$ also acts on the tangent bundle $T\HH^2$; namely, if $f \in \PSL(2, \RR)$, $(z, \xi) \in T\HH^2$, then
$$f(z, \xi) = (f(z), f'(z)\xi).$$
Moreover, if $f = \begin{bmatrix}a&b \\c&d\end{bmatrix}$ then $f'(z) = (cz + d)^2$.

\begin{lemma}
The action of $\PSL(2, \RR)$ preserves the lengths of tangent vectors in $T\HH^2$.
\end{lemma}
\begin{proof}
Let $\xi \in T_z\HH^2$; we must show
$$|\xi|_z = \left|\frac{\xi}{(cz + d)^2}\right|_{f(z)}$$
where $f = \begin{bmatrix}a&b \\c&d\end{bmatrix}$. Now $|\xi|_z \Im z = |\xi|$ so
\begin{align*}\left|\frac{\xi}{(cz + d)^2}\right|_{f(z)} &= \frac{\left|\frac{\xi}{(cz + d)^2}\right|}{\Im \frac{az+b}{cz + d}} \\
&= \frac{\frac{|\xi|}{|cz + d|^2}}{\frac{\Im z}{|cz + d|^2}} = |\xi|_z.\end{align*}
\end{proof}
Thus $\PSL(2, \RR)$ acts on $\HH^2$ by isometries. In particular, $\PSL(2, \RR)$ preserves the area element $dA$.

Thus to study $\PSL(2, \RR)$ we do not actually need to consider the entire tangent bundle $T\HH^2$ but rather the unit sphere bundle
$$S\HH^2 = \{(z, \xi) \in T\HH^2: |\xi|_z = 1\}.$$
Thus $\PSL(2, \RR)$ preserves $S\HH^2$.
Having carried out all this setup, we are now interested in dynamical systems with phase space $S\HH^2$.
This is a $3$-dimensional real manifold with parametrization
$$(x, y, \theta) \mapsto (x + iy, ye^{i\theta})$$
and so is diffeomorphic to $\RR \times (0, \infty) \times \TT^1$.
Moreover $S\HH^2$ has an invariant metric
$$\frac{dx^2 + dy^2}{y^2} + d\theta^2.$$
In fact we have
$$d((z, v), (z', v')) = d(g(z, v), g(z', v'))$$
where $g \in \PSL(2, \RR)$.
So it has a volume form
$$dV = \frac{dx~dy~d\theta}{y^2}.$$
The volume form $dV$ is left-invariant and right-invariant for the action of $\PSL(2, \RR)$.
Therefore $dV$ is the Haar measure on the unimodular group $\PSL(2, \RR)$.

\begin{lemma}
The map
\begin{align*}
\Phi: \PSL(2, \RR) &\to S\HH^2\\
\begin{bmatrix}a&b\\
c&d\end{bmatrix} &\mapsto \left(\frac{ai + b}{ci + d}, \frac{i}{(ci + d)^2}\right)
\end{align*}
is a diffeomorphism.
\end{lemma}
\begin{proof}
It suffices to show that this map is a bijection. In fact, the stabilizer of $i$ is sent to
$$\begin{bmatrix}\cos \theta & \sin \theta\\-\sin \theta & \cos \theta\end{bmatrix} \mapsto (i, e^{2i\theta}i).$$
So the first two variables of the parametrization of $S\HH^2$ are controlled by $\PSL(2, \RR)$ modulo the stabilizer and the final variable is controlled by the stabilizer.
\end{proof}

We now introduce a very important flow on $S\HH^2 = \PSL(2, \RR)$. To do this, we note that we want to define a distance function $\HH^2$ by
$$d(z, w) = \inf_\gamma \frac{|\gamma'(s)|}{\Im \gamma(s)} ~ds$$
where the $\inf$ is taken over all curves $\gamma$ from $z$ to $w$.
Now we can find a group element $g \in \PSL(2, \RR)$ and a $a > 0$ such that $z = g(i)$ and $w = g(ai)$. Thus
$$d(z, w) = d(i, ai)$$
and so we are only interested in curves
$$\gamma(s) = x(s) + iy(s)$$
such that $x(0) = x(1) = 0$, $y(0) = 1$ and $y(0) = a$. We have
\begin{align*}\int_0^1 \frac{\sqrt{x'(s)^2 + y'(s)^2}}{y(s)} ~ds &\geq \int_0^1 \frac{|y'(s)|}{y(s)} ~ds \geq \left|\int_0^1 \frac{y'(s)}{y(s)} ~ds\right|
\\&= |(\log y(s))_{s=0}^1| = |\log a|
\end{align*}
and so
$$d(z, w) = |\log a|$$
and the curve which witnesses this is the image of the curve which witnesses that $d(i, ai) = |\log a|$.
In fact this curve $\gamma$ is a curve on the imaginary axis, which is sent by $\PSL(2, \RR)$ to a circle on which $g \circ \gamma$ is an arc.
Moreover, $i$ was the tangent vector to $\gamma$ at $\gamma(0) = i$, so $i/(ci + d)^2$ is the tangent vector to $g \circ \gamma$ at $g \circ \gamma(0) = g(i)$.

We now introduce the \dfn{geodesic flow} which carries $(z, \xi)$ along its respective great circle. Namely,
$$\varphi_t(i, i) = (e^ti, e^ti)$$
and if $g(i, i) = \Phi(g)$ is an element of $S\HH^2$ then it we define
$$\varphi_t(g(i, i)) = g(\varphi_t(i, i)) = g(e^ti, e^ti).$$
In other words, if $G_t = \begin{bmatrix}e^{t/2}&0\\0&e^{-t/2}\end{bmatrix}$ then we have
$$\varphi_t(\Phi(g)) = \Phi(gG_t).$$
Now $G_t \in \PSL(2, \RR)$ so $dV$ is left invariant by the geodesic flow.
So in fact $\varphi$ is a measure-preserving action of $\RR$ on $(S\HH^2, V)$.

Note that there is a standard linear fractional transformation $\HH^2 \to \DD$ given by
$$\zeta \mapsto \frac{\zeta - i}{\zeta + i}.$$
This gives all of the above structure to $\DD$ and hence $S\DD$.
In this space a geodesic is not a great circle, but a circle which is perpendicular to the unit circle.
So in fact an annulus in $\DD$ centered at the origin is preserved by $\varphi$ so $\varphi$ is not an ergodic flow.

We are interested in the stable and unstable manifolds of $\varphi$. We have
$$W^s(z, \xi) = \{(w, \zeta) \in S\HH^2: \lim_{t \to \infty} d(\varphi_t(w, \zeta), \varphi_t(z, \zeta)) = 0\}$$
and similarly for $W^u$. Using the action of $\PSL(2, \RR)$ it suffices to compute $W^s(i, i)$, and
$$W^s(i, i) = \{(i + t, i): t \in \RR\}.$$
This consists of the horizontal line through $i$, which is being translated upwards. As the imaginary part increases the distances will vanish.
It is reasonable to view $W^s(i, i)$ as the action of the $1$-parameter group $h^s_t: t \in \RR$ on $(i, i)$ where
$$h^s_t = \begin{bmatrix}1&t\\
0 & 1\end{bmatrix}.$$
Similarly
$$W^u(i, i) = \{-(i+t)^{-1}, i(i+t)^{-2}: t \in \RR\}$$
which is the action of the $1$-parameter group $h^u_t: t \in \RR$ on $(i, i)$ where
$$h^u_t = \begin{bmatrix}
1 & 0\\
t & 1
\end{bmatrix}.$$
The actions of $h^s_t$ and $h^u_t$ are called the \dfn{horocycle flows} determined by the geodesic flow on $S\HH^2$, and we have
$$\varphi_t \circ h^s_s = h^s_{se^{-t}} \circ \varphi_t$$
and similarly
$$\varphi_t \circ h^u_s = h^u_{se^t} \circ \varphi_t.$$

Henceforth we change notation to $W^+$ for the stable manifold and $W^-$ for the unstable, and identify $\Phi$ with the identity map.
We write $H$ for the horocycle flow and $G$ for the geodesic flow
Thus
$$W^\pm(g) = \{g' \in \PSL(2, \RR): \lim_{t \to \pm \infty} d(gG_t, g'G_t) = 0\}.$$
Then $H_s^+$ is the matrix $\begin{bmatrix}1&s\\0&1\end{bmatrix}$ and $H_s^-$ is its inverse $\begin{bmatrix}1&0\\s&1\end{bmatrix}$, and
$G_t = \begin{bmatrix}e^{t/2}&0\\ 0 &e^{-t/2}\end{bmatrix}$.

Unfortunately $S\HH^2 = \PSL(2, \RR)$ is not a compact Lie group; in fact, it has infinite volume. So we cannot hope to use the ergodicity theory to study the horocycle flow.
Therefore we fix a discrete subgroup $\Gamma \subset \PSL(2, \RR)$. For example, the modular group $\Gamma = \PSL(2, \ZZ)$ is sufficient.
Famously, $\PSL(2, \ZZ)$ is generated by $\begin{bmatrix}&1\\-1\end{bmatrix},\begin{bmatrix}1&1\\&1\end{bmatrix}$.
Now $\Gamma$ may not be a normal subgroup so the set of left cosets $\Gamma \setminus \HH^2 = \{\Gamma z: z \in \HH^2\}$ is not a group.
But it does have a Riemannian manifold structure and so it makes sense to talk about the unit tangent bundle
$$S(\Gamma \setminus \HH^2) = \{\Gamma g: g \in \PSL(2, \RR)\}.$$
In fact the standard fundamental domain $M$ of the modular surface $\Gamma \setminus \HH^2$ is contained in the complex projective line $\PP^1$.
It is $\HH^2$ modulo the action of $z \mapsto z + 1$ and $z \mapsto -1/z$. The modular surface is a Riemann surface, and the volume of the unit sphere bundle $\Gamma \setminus \PSL(2, \RR) = S(\Gamma \setminus \HH^2)$ is
$$V(\Gamma \setminus \PSL(2, \RR)) = \iint_{M \times S^1} \frac{dx~dy~d\theta}{y^2} \leq \int_0^{2\pi} \int_{-1/2}^{1/2} \int_{1/2}^\infty \frac{dy}{y^2}~dx~d\theta < \infty.$$
Renormalizing we assume $V(\Gamma \setminus \PSL(2, \RR)) = 1$ as necessary. Then the geodesic flow and the horocycle flows drop to an action on $\Gamma \setminus \PSL(2, \RR)$.

Having discussed the motivating example of $\PSL(2, \RR)$ we consider discrete subgroups $\Gamma$ more generally.
Notice that $\Gamma$ is discrete iff there is a $g \in \PSL(2, \RR)$ such that
$$d(g, \Gamma g \setminus \{g\}) > 0.$$
As another example, suppose that we have an $8$-gon in the Poincare disk model of hyperbolic space (so $\HH^2$ is mapped into the unit disk by the Cayley transform).
By identifying sides we end up with a compact genus-$2$ Riemann surface. In particular it is a probability space. We are interested in when the $8$-gon is the fundamental domain of $\Gamma$.

So suppose that $\Gamma$ is a discrete subgroup of $\PSL(2, \RR)$ such that
$$S(\Gamma \setminus \HH^2) = \Gamma \setminus \PSL(2, \RR)$$
is a probability space. Then
$$\varphi_t(\Gamma g) = \Gamma (g G_t)$$
is the action of the geodesic flow on $S(\Gamma \setminus \HH^2)$.
Similarly we have horocycle flows
$$h_s^\pm(\Gamma g) = \Gamma(g H^\pm_s).$$
These parametrize the stable and unstable manifolds as
$$W^\pm(\rho) = \{h_s^\pm(\rho): s \in \RR\}.$$
We have the commutation relation
$$\varphi_t \circ h_s^\pm = h_{se^{\mp t}}^\pm \circ \varphi_t.$$

We now prove ergodicity of the geodesic flow on $\Gamma \setminus \PSL(2, \RR)$ using the Hopf argument.
We consider the space of weakstar limits of $\{f \circ \varphi_t: t\in \RR\}$ whenever $f \in L^2(\Gamma \setminus \PSL(2, \RR))$.
If $f \circ \varphi_t = f$, we will show that $f$ is invariant under the horocycle flows. Therefore $f$ will be constant.
In fact, we will then show that the horocycle flows are ergodic, which implies that
$$\lim_{t\to \pm \infty}\langle f \circ \varphi_t, g\rangle = E(f)E(g)$$
so the geodesic flow is mixing. Let $\omega$ be the invariant volume form
$$\omega = \frac{dx~dy~d\theta}{y^2}.$$

\begin{example}
In zero curvature all this theory is kind of trivial. Let $\TT^2$ be the flat torus and let $\varphi$ be the geodesic flow on $\TT^2$, so
$$\varphi_t(x, v) = (x + tv, v).$$
Then $W^\pm(x, v) = \{(x, v)\}$. This corresponds to $\TT^2$ being flat, so that there is ``no gravity", i.e. no two points are attracted to each other.
\end{example}

\begin{theorem}
Suppose that $\Gamma \setminus \PSL(2, \RR)$ has finite volume. Then the geodesic flow on $\Gamma \setminus \PSL(2, \RR)$ is ergodic.
\end{theorem}
\begin{proof}
We have
$$h_{u'}^- \circ h_s^+ \circ \varphi_t = h_{s'}^+ \circ \varphi_{t'} \circ h_u^-$$
where $u' = u(1-e^tsu)^{-1}$, $s' = s(1 - e^tsu)$, and $t' = t - 2\log (1 - e^tsu)$. This is true whenver $u,s,t$ are close to $0$.

Fix $g \in \Gamma \setminus \PSL(2, \RR)$ and define local coordinates
$$\Psi(s, t, u) = h_{u'}^- \circ h_s^+ \circ \varphi_t(g).$$
Then $\Psi$ is a diffeomorphism close to $0$. Let $U \ni g$ be open. If $\tilde g \in U$ then
$$U \cap W^-(\tilde g) = \{\Psi(s, t, \xi)\}$$
where $\xi \in \RR$ is sufficiently close to the $u \in \RR$ such that $\Psi(s, t, u) = \tilde g$. In fact,
$$W^-(\tilde g) = \{h^-_\eta(\tilde g): \eta \in \RR\} = \{h_{u' + \eta}^- \circ h_s^+ \circ \varphi_t(g): \eta \in \RR\},$$
at least when $s,t,u,\eta$ are close to $0$.

We now prove that
$$U \cap \bigcup_T W^+(\varphi_T(\tilde g)) = \{\Psi(\sigma, \tau, u)\}$$
where $(\sigma,\tau)$ is sufficiently close to $(s, t)$. In fact, this is the set of all
$$h_{\sigma'}^+ \circ \varphi_{t'} \circ h^-_{u'} \circ h_s^+ \circ \varphi_t(g)$$
or in other words the set of
$$h_{u''}^- \circ h_\sigma^+ \circ h_\sigma^+ \circ \varphi_tau \circ h_s^+ \circ \varphi_t(g)$$
or in other words
$$h_{u''}^- \circ h_{\sigma + se^{-t}}^- \circ \varphi_{\tau + t}(g)$$
or in other words
$$\Psi(\sigma + se^{-\tau}, t + \tau, u)$$
or in other words
$$u(1 - e^{t + \tau}(e^{-\tau}s + \sigma)u)^{-1}.$$
This proves the claim.

Therefore we have written the space as a product of a two-dimensional space $\{(s, t)\}$ and one-dimensional space $\{u\}$, and can easily split $\omega$ into forms on each of these two space, and can therefore use the Hopf argument.
\end{proof}


\chapter{Topological dynamics}
\section{Recurrence in topological dynamics}
\begin{definition}
Let $X$ be a topological space, $T: X \to X$. We say that $T$ is \dfn{topologically transitive} if for every pair of nonempty open sets $U, V\subseteq X$, there is a sequence of $n_i \to \infty$ such that $T^{-n_i}U \cap V$ is nonempty.
\end{definition}
In other words, there is a $x \in U$ such that $T^nx \in V$ for infinitely many $n$.
\begin{definition}
Let $X$ be a topological space, $T: X \to X$. We say that $T$ is \dfn{topologically mixing} if for every pair of nonempty open sets $U, V \subseteq X$ and every $n$ large enough, $T^{-n}U \cap V$ is nonempty.
\end{definition}
\begin{example}
Consider rotations of $\TT^1$ by $\alpha$. If $\alpha$ is rational then $T$ is not transitive. But if $\alpha$ is irrational then $T$ is transitive. But $T$ is not mixing because if $U,V$ are tiny intervals, then they cannot be trapped in each other since $T$ is an isometry.
\end{example}
We now show that transitive maps are analogously to ergodic maps.
\begin{theorem}
If $T$ is a Borel map and preserves an ergodic probability measure $\mu$ with full support, then $T$ is topologically transitive. In fact, if $(X, T, \mu)$ is mixing, then $T$ is topologically mixing.
\end{theorem}
\begin{proof}
Let $U,V$ be given. For almost every $x \in U$ the fraction of the time that the forward orbit of $x$ lands in $V$ is $\mu(V)$. Since $\mu$ has full support it follows that $\mu(V) > 0$. Therefore $T$ is transitive.

If $(X, T, \mu)$ is mixing, then $\lim_n \mu(T^{-n}U \cap V) \to \mu(U)\mu(V) > 0$, so for large enough $n$, $\mu(T^{-n}U \cap V) > 0$.
\end{proof}
\begin{definition}
For any $x \in X$, let $\omega(x)$ be the set of accumulation points of $T^nx$ as $n \to \infty$.
\end{definition}
Thus $\omega(x)$ is closed, and is the set of all subsequential limits of $T^nx$ as $n \to \infty$.

\begin{theorem}
Let $(X, \mu, T)$ be an ergodic system, $X$ a metric space, and $\mu$ a probability measure. For almost every $x \in X$, $\supp \mu \subseteq \omega(x)$.
\end{theorem}
\begin{proof}
Note that $\supp \mu$ is separable, since $\mu$ is a Borel probability measure. Let $\{x_i\}_i$ be a dense subset of $\supp \mu$ and let $r \in \QQ$. By ergodicity there is a set $\Omega_{i,r}$ such that $\mu(\Omega_{i,r}) = 1$ and for every $x \in \Omega_{i,r}$, there are infinitely many $n$ such that $T^nx \in B(x_i, r)$.
If $x \in \bigcap_{i,r} \Omega_{i,r}$, which is a set of full measure, then for every $i,r$ there are infinitely many $n$ such that $T^nx \in B(x_i, r)$.
Then $x_i \in \omega(x)$, so $\{x_i: i \in \NN\} \subseteq \omega(x)$. Since $\omega(x)$ is closed, $\supp \mu \subseteq \omega(x)$.
\end{proof}

\begin{corollary}
Let $(X, \mu, T)$ be an ergodic system, $X$ a metric space, $\mu$ a probability measure, and suppose $\supp \mu = X$. Then for almost every $x \in X$, $\supp \mu \subseteq \omega(x)$.
\end{corollary}

\begin{definition}
A topological space $X$ is \dfn{topologically complete} if $X$ admits a complete metric. If $X$ additionally is separable, then we say that $X$ is a \dfn{Polish space}.
\end{definition}
Every Polish space admits a countable basis. The Baire category theorem also holds in Polish spaces (even topologically complete spaces); namely, a countable intersection of open dense sets is still dense.
\begin{theorem}
If $X$ is a Polish space and $T: X \to X$ is continuous, then the following are equivalent:
\begin{enumerate}
\item $T$ is transitive.
\item The set of $x \in X$ such that $\omega(x) = X$ is dense in $X$.
\item There is an $x \in X$ such that $\omega(x) = X$.
\end{enumerate}
\end{theorem}
\begin{proof}
Assume that $\omega(x) = x$ and let $U,V$ be given. Then the forward orbit of $x$ hits $U,V$ infinitely many times. Suppose $T^nx \in U$; then $T^nx$ meets $V$ infinitely many times, so $T$ is transitive.

If $T$ is transitive, let $Y = \{x \in X: \omega(x) = X\}$. Then
$$Y = \bigcap_U \bigcap_{N \geq 0} \bigcup_{n \geq N} T^{-n} U.$$
Here the first intersection is taken over nonempty open sets. Since $X$ is Polish we can replace the first intersection with an intersection over a countable basis for the topology of $X$.
Since $T$ is transitive, $\bigcup_n T^{-n}U$ is dense, and is open since $T$ is continuous. So $Y$ is a countable intersection of open dense sets, so is dense by the Baire category theorem.
\end{proof}

\begin{definition}
A point $x \in X$ is \dfn{recurrent} if $x \in \omega(x)$.
\end{definition}
If $X$ is a metric space then the set of recurrent points is equal to
$$\bigcap_{k > 0} \bigcap_{N \geq 0} \bigcup_{n \geq N} \{x \in X: d(x, T^nx) < \frac{1}{k}\}.$$
\begin{theorem}
Let $(X, \mu, T)$ be a measure-preserving system, $X$ a metrizable space, and $\mu$ a probability measure. Then almost every $x \in \supp \mu$ is recurrent.
\end{theorem}
\begin{proof}
Let $D$ be a countable basis for the topology of $\supp \mu$. Then by Poincare recurrence, for every $U \in D$, the set $U'$ of $x$ such that $x \notin U$ or there are infinitely many $k$ such that $T^kx \in U$ has full measure.
Now $\bigcap_{U \in D} U'$ has full measure, and consists of recurrent points.
\end{proof}

\begin{definition}
A point $x \in X$ is \dfn{nonwandering} if for every open $U \ni x$, there are infinitely many $n$ such that $T^{-n}U \neq U$ is nonempty. If $x$ is nonwandering then we write $x \in \Omega$.
\end{definition}
If $x \in X$ then $\omega(x) \subseteq \Omega$. In particular, if $x$ is recurrent, then $x$ is nonwandering. The converse is not true.

\begin{example}
Let $T: \TT^2 \to \TT^2$ be the cat map. Let $E^s$ be the stable eigenline of $T$. If $x \in E^s$ then $x$ approaches $0$ exponentially fast. Therefore $x$ is not recurrent.

But if $v$ has rational coefficients, then $v$ is recurrent, and we can approximate any point on $\TT^2$ arbitrarily well by such $v$. Therefore $T$ has no wandering points.
\end{example}

\begin{theorem}
Let $X$ be a metric space, $T: X \to X$ continuous. Then $x \in X$ is a wandering point iff there is an open $U \ni x$ such that for all $n$, $T^{-n}U \cap U$ is empty.
\end{theorem}
\begin{proof}
One direction is clear. For the converse, suppose $x$ wanders, so there is an open $U \ni x$ such that for all $n$ large enough, $T^{-n}U \cap U$ is empty. We need to remove the clause ``large enough." Let $N$ be the minimal $n$.
Now $x$ is not periodic, so there is an open $V \ni x$ such that for every $i \leq N$, $T^{-i}V \cap V$ is empty and $T^NV \subseteq U$. Therefore for every $i$, $T^{-i}V \cap V$ is empty.
\end{proof}

\chapter{Completely integrable systems}
Ergodic systems are intended to be understood as ``chaotic"; therefore they can often be not useful in practice. We now consider more predictable dynamical systems.

\section{Symplectic geometry}
\begin{definition}
Let $S$ be a (finite-dimensional, real) vector space. Then a \dfn{symplectic form} on $S$ is an antisymmetric, nondegenerate bilinear form. A \dfn{symplectic space} is a vector space equipped with a symplectic form.
\end{definition}
\begin{example}
The canonical example of a symplectic space is $\RR^{2n}$, which it will be convenient to view as $T^*\RR^n$, the cotangent bundle of $\RR^n$. Let $I$ denote the identity matrix on $\RR^n$ and let $J = \begin{bmatrix}0 & I \\ -I & 0\end{bmatrix}$. Then $\sigma(z, w) = \langle Jz, w\rangle$ is the \dfn{standard symplectic form} on $\RR^{2n}$.
In fact, if $(x_1, \dots, x_n, \xi_1, \dots, \xi_n)$ are coordinates on $\RR^{2n}$, and $\omega = \sum_j \xi_j dx_j$, then $\sigma = d\omega$. So $\sigma$ is a closed (hence exact) $2$-form.
\end{example}
Since symplectic spaces are vector spaces, we may always view them as having the standard differential structure of $\RR^{2n}$. In particular, it makes sense to ask for the linearization of a $C^1$-map $\kappa: S_1 \to S_2$, say $\partial \kappa$, and then if $\omega$ is a multilinear form on $S_2$, we can define the pullback $\kappa$ of $\omega$, a multilinear form on $S_1$, by
$$\kappa^*\omega(v_1, ..., v_n) = \omega(\partial \kappa(v_1), ..., \partial \kappa(v_n)).$$
\begin{definition}
Let $(S_1, \sigma_1)$ and $(S_2, \sigma_2)$ be symplectic spaces. A \dfn{symplectomorphism} is a map $\kappa: S_1 \to S_2$ such that $\sigma_1 = \kappa^*\sigma_2$.
\end{definition}
\begin{example}
Let $\kappa: \RR^{2n} \to \RR^{2n}$ be a linear map, and let $\sigma,J$ be standard. Let $\kappa(x, \xi) = (Ax + B\xi, Cx + D\xi)$; then $\kappa^*\sigma = \sigma$ iff the matrix $M = \begin{bmatrix}A&B\\C&D\end{bmatrix}$ satisfies $M^tJM=J$. This example motivates the definition of a symplectic matrix.
\end{example}
\begin{definition}
Let $J$ be standard for $\RR^{2n}$; a \dfn{symplectic matrix} is a matrix $M \in \RR^{2n \times 2n}$ such that $M^tJM = J$. The \dfn{symplectic group} is the group of all symplectic matrices.
\end{definition}
\begin{example}
There exist nonlinear symplectomorphisms. Let $\varphi: \RR^{2n} \to \RR$ be a smooth function such that the Hessian determinant of $\varphi$ at $(x_0, y_0)$ does not vanish, i.e.
$$\det \partial_x \partial_y \varphi(x_0, y_0) \neq 0.$$
For example, let $A \in \RR^{n \times n}$ be an invertible matrix, and consider the bilinear form $\varphi$ defined by $A$.

Let $\xi_0 = \partial_x\varphi(x_0, y_0)$ and $\eta_0 = -\partial_y\varphi(x_0, y_0)$. Then the implicit function theorem defines a mapping close to $(x_0, \xi_0) \in T^*\RR^n$ by
$$\kappa(x, \partial_x\varphi(x, y)) = (y, -\partial_y\varphi(x, y)).$$
To see that $\kappa$ is a symplectomorphism, we note that
\begin{align*}
  \kappa^*(d\eta \wedge dy) &= d(-d_y\varphi) \wedge dy = (-\partial_y^2\varphi~dy) \wedge dy + (-\partial_x\partial_y\varphi~dx) \wedge dy\\
    &= -\partial_x\partial_y \varphi~dx\wedge dy = \partial_x\partial_y\varphi~dy\wedge dx = d\xi \wedge dx.
\end{align*}
Therefore $\kappa$ defines a symplectomorphism from a neighborhood of $(x_0, \xi_0)$ to a neighborhood of $(y_0, \eta_0)$.
\end{example}
\begin{theorem}
Let $(S, \sigma)$ be a symplectic space. Then there is an invertible linear symplectomorphism $S \to \RR^{2n}$.
\end{theorem}
\begin{proof}
We prove this by the induction on the dimension $2n$ of $S$. Since $\sigma$ is antisymmetric and nondegenerate, $2n \geq 2$. Assume $2n = 2$. Then there are $e,f \in S$ such that $\sigma(e, f) = 1$, and $\{e, f\}$ is a basis of $S$. Define a linear map $\kappa$ by $\kappa(e) = (0, 1)$ and $\kappa(f) = (1, 0)$; then $\kappa$ is an invertible symplectomorphism.

Now if $2n > 2$, there are $e_1,f_1$, linearly independent, such that $\sigma(e_1, f_1) = 1$. Let $S_1$ be the span of $\{e_1, f_1\}$, and let $S_0$ be the sum of the kernels of $\sigma(\cdot, w)$ for $w \in S_1$.
Then the codimension of $S_0$ is $2$, and if $z = xe_1 + yf_1 \in S_0$, $0 = \sigma(z, e_1) = -y$ and $0 = \sigma(z, f_1) = x$, so $z = 0$. Therefore $S_1 \cap S_0 = 0$.
Therefore $S_0 \oplus S_1 = S$.
For every $z \in S_0$, if $\sigma(z, S_0) = 0$ then $\sigma(z, S) = 0$ so $z = 0$. Therefore $\sigma|_{S_0}$ is nondegenerate.
So by the inductive hypothesis, we have an invertible linear symplectomorphism $\kappa_0: S_0 \to \RR^{2n - 2}$. Let $\kappa: S \to \RR^{2n}$ extend $\kappa_0$ by sending $e_1, f_1$ to $\RR^{2n}/\RR^{2n-2}$ as in the base case.
\end{proof}
We now consider manifolds whose tangent bundles are bundles of symplectic spaces.
\begin{definition}
Let $S$ be a $2n$-dimensional manifold equipped with a closed, nondegenerate $2$-form $\sigma$. Then $(S, \sigma)$ is called a \dfn{symplectic manifold}.
\end{definition}
In other words, on every tangent space, $\sigma$ defines an antisymmetric nondegenerate bilinear form which varies smoothly, and $d\sigma = 0$.
\begin{example}
Let $\HH^2$ be the hyperbolic plane; then its tangent bundle $T\HH^2$ can be turned into a symplectic manifold by setting coordinates $(x + iy, \xi + i\eta)$, $y > 0$, and letting
$$\sigma = d\xi \wedge dx + d\eta \wedge dy.$$
In fact the tangent bundle of $T\HH^2$ is diffeomorphic to the half-space of $\RR^4$, on which $\sigma$ is the standard symplectic form.
\end{example}
We now consider differential forms on symplectic manifolds.
For $\kappa$ a symplectomorphism and $X$ a vector field, let $\kappa_*X$ denote the pushforward of $X$ along $\kappa$. That is, $\kappa_*X = \partial \kappa \circ X$.
Recall that the pullback $\kappa^*$ is defined dually to the pushfoward, i.e. if $\eta$ is a $1$-form and $X$ is a vector field, we have
$$\kappa^*\eta(X) = \eta(\kappa_*X).$$
We extend this definition to $m$-forms by declaring that $\kappa^*$ preserves $\wedge$.
\begin{definition}
If $\eta$ is an $m+1$-form and $X$ is a vector field, define for vector fields $Y_1, \dots, Y_m$
$$(X\lrcorner\eta)(Y_1, \dots, Y_m) = \eta(X, Y_1, \dots, Y_m).$$
\end{definition}
In particular, $X\lrcorner\eta$ is a $m$-form. One can check that if $\nu$ is a $k$-form and $\eta$ is an $m$-form then
$$X\lrcorner(\nu \wedge \eta) = (X\lrcorner\nu) \wedge \eta + (-1)^k\nu \wedge (X\lrcorner\eta).$$
None of the above used that $\kappa$ was a symplectomorphism but we will mainly be interested in the case that $\kappa$ is a symplectomorphism.

\begin{example}
Let $g: \RR^n \to \RR^n$ be a diffeomorphism and $w$ is a smooth function. Then
$$\kappa(x, \xi) = (g(x), (\partial g(x)^t)^{-1}(\xi + \nabla w(x)))$$
is a symplectomorphism of $\RR^{2n}$ and these are the only symplectomorphisms which lift from $g$.
\end{example}

\section{Hamiltonian flows on symplectic spaces}
We treat Hamiltonian flows first on symplectic spaces, revisiting symplectic manifolds later. So fix a symplectic space $(S, \sigma)$ and coordinates $(x, \xi)$ so that $\sigma = d\xi \wedge dx$.
\begin{definition}
For any function $f \in C^\infty(S)$, we let $H_f$, the \dfn{Hamiltonian vector field} of $f$, be defined by the relation $\sigma(\cdot, H_f) = df$.
\end{definition}
In other words,
$$H_f = \sum_j \frac{\partial f}{\partial \xi_j}\partial x_j - \frac{\partial f}{\partial x_j}\partial \xi_j$$
where $\{\partial x_j, \partial \xi_j\}$ define a basis for the tangent space.

Any vector field $X$ determines a flow by the ODE $\cdot x = X(x)$. This can also be expressed by writing
$$x(t) = \exp(tX)(x(0)).$$
Thus $t \mapsto \exp(tX)$ is a one-parameter group and a diffeomorphism.
So in particular we have defined a \dfn{Hamiltonian flow}.
\begin{example}
The notion of a symplectic manifold, and of a Hamiltonian flow, is motivated by classical mechanics. View $x$ as the position and $\xi$ as the momentum of a particle; let $V(x)$ be its potential energy and $m$ its mass. Then the energy of the particle is given by
$$f(x, \xi) = \frac{|\xi|^2}{2m} + V(x).$$
The Hamiltonian vector field is given by
$$H_f = \frac{1}{m}\langle \xi, \partial_x \rangle - \langle \nabla V(x), \partial_\xi\rangle.$$
Therefore the particle moves with velocity $\xi/m$, and its change in momentum is given by $-\nabla V(x)$. In particular, its acceleration $A$ satisfies \dfn{Newton's second law of motion},
$$mA + \nabla V(x) = 0.$$
\end{example}
To continue further we will need to introduce a Lie algebra structure on the space $C^\infty(S)$.
\begin{definition}
The \dfn{Poisson bracket} is defined by
$$\{f, g\} = \sigma(\nabla f, \nabla g).$$
\end{definition}
Thus the Poisson bracket also satisfies $\{f, g\} = H_fg$ and
$$\{f, g\} = \sum_j \frac{\partial f}{\partial \xi_j} \frac{\partial g}{\partial x_j} - \frac{\partial f}{\partial x_j} \frac{\partial g}{\partial \xi_j}.$$
Since vector fields act on functions as linear maps, it makes sense to talk about the commutator of vector fields, and then we have
$$H_{\{f, g\}} = [H_f, H_g].$$
One can check also that we have the Jacobi identity $\{f, \{g, h\}\} + \{g, \{h, f\}\} + \{h, \{f, g\}\} = 0$, so $\{\cdot, \cdot\}$ is a Lie bracket. Moreover, the flow
$$\varphi_t = \exp(tH_f)$$
is a symplectomorphism.

While we defined the Poisson bracket on functions, it will be useful to talk about a Lie algebra structure on any symplectic space $(S, \sigma)$, so given vectors $v,w \in S$, let
$$\{v, w\} = \sigma(v, w).$$
We first prove the linear case of Darboux's theorem. To motivate this theorem, note that if $\{e_1, \dots, e_n, f_1, \dots, f_n\}$ is a basis of $(S, \sigma)$, it is useful that $\{e_i, e_j\} = 0$, $\{f_i, f_j\} = 0$, and $\{e_i, f_j\} = \delta_{ij}$.
This is a similar condition to requiring that a basis of a Hilbert space is orthonormal. We say that such a basis is a \dfn{symplectic basis}.
Darboux's theorem says that a symplectic linearly indepdendent set can always be extended to a symplectic basis.
\begin{theorem}[linear Darboux theorem]
\index{linear Darboux theorem}
Let $S$ be a symplectic space of dimension $2n$ and $A,B \subset \{1, \dots, n\}$. Let $\{e_j\}_{j\in A}$ and $\{f_i\}_{i \in B}$ be linearly independent sets and suppose that $\{e_i, e_j\} = 0$, $\{f_i, f_j\} = 0$, and $\{e_i, f_j\} = \delta_{ij}$.
Then there are $\{e_j\}_{j \notin A}$ and $\{f_i\}_{i \notin B}$ such that $\{e_i, e_j\} = 0$, $\{f_i, f_j\} = 0$, and $\{e_i, f_j\} = \delta_{ij}$.
\end{theorem}
\begin{proof}
We first show that we may assume that $A = B$. In fact, suppose that the symmetric difference of these two sets is nonempty, say $J \in B \setminus A$.
Then there is an $e_J$ such that for every $j \in A$, $\{e_J, e_j\} = 0$ and every $k \in B$, $\{e_J, f_k\} = \delta_{Jk}$.
Here we used nondegeneracy of $\sigma$ and the linear independence hypothesis.
One can check that $e_J$ is linearly independent of $e_j$ and $f_k$, so we can add $J$ to $A$ without contradicting the hypothesis.

Suppose that $A = B \neq \{1, \dots, n\}$, and let $S'$ be the span of $\{e_j\}_{j \in A}$ and $\{f_j\}_{j \in A}$.
Let $S_0$ be the \dfn{symplectic complement} of $S'$, i.e. the set of $z \in S$ such that for every vector $w \in S'$ we have $\sigma(z, w) = 0$
Then $(S_0, \sigma)$ is a symplectic space. Choose a symplectic basis for $S_0$; then $S = S_0 \oplus S'$ and we're done.
\end{proof}


\section{Hamiltonian flows on symplectic manifolds}
We now revisit Hamiltonian flows but for symplectic manifolds $(S, \sigma)$. If $f \in C^\infty(S)$ we define the Hamiltonian vector field $H_f$ for every $(p, z) \in TS$ by
$$\sigma_p(z, H_f) = df_p(z).$$
Here, if $dx_1, \dots, dx_n, d\xi_1, \dots, d\xi_n$ is a basis for $T_p^*S$, the differential $df_p$ is the covector
$$df_p = \sum_{j=1}^n \frac{\partial f}{\partial x_j}(p) ~dx_j + \frac{\partial f}{\partial \xi_j}(p) ~d\xi_j.$$
Writing $\partial_{x_1}, \dots, \partial_{x_n}$ for the dual basis of $T_pS$, $z = \sum_j c_j \partial_{x_j} + d_j \partial_{\xi_J}$, we have $dx_j(\partial_{\xi_k}) = \delta_{jk}$ and similarly for $\xi_j$, so
$$df_p(\partial_{x_j}) = \frac{\partial f}{\partial \xi_k}(p)$$
and similarly for $\xi_j$.
We then define $\{f, g\} = H_fg$ as before, so
$$H_f = \sum_{j=1}^n \frac{\partial f}{\partial \xi_j}\partial_{x_j} - \frac{\partial f}{\partial x_j}\partial_{\xi_j}.$$
The notion of Poisson bracket still makes sense, as does the Jacobi identity. The proof of the Jacobi identity uses $d\sigma = 0$.
\begin{definition}
The \dfn{Hamiltonian flow} is defined by
$$\varphi_t = \exp(tH_f).$$
\end{definition}
The Hamiltonian flow is again a symplectomorphism, $\varphi_t^*\sigma = \sigma$.
In the classical mechanics interpretation of symplectic geometry, $f(x, \xi)$ is the energy of a particle with position $x$ and momentum $\xi$, and is known as the \dfn{Hamiltonian observable} of the dynamical system $(S, \sigma, \varphi)$.

\begin{example}
Take $f(x, \xi) = \xi^4 - x^4$. This is the Hamiltonian of the system $\cdot x = 4\xi^3$ and $\cdot \xi = 4x^3$. This can be solved as
$$x(t) = \frac{x(0)}{\sqrt{1-8tx(0)^2}}$$
which blows up in finite time. So we need a Hamiltonian which meets the hypotheses of Picard's theorem to be able to solve for the Hamiltonian flow.
Here the problem is that energy is not conserved.
\end{example}
In fact, if $|\partial^2f| \leq C$ then $\varphi_t$ exists for all time, by Picard's theorem. This is in particular true if $f$ is smooth and $M$ is compact.

It is useful to know that Hamiltonian flows are always measure-preserving where the measure is given by the symplectic form. So we can use the tools of ergodic theory to study Hamiltonian flows.

\section{Complete integrability}
\begin{definition}
Let $D$ be a symplectic manifold of dimension $2n$ and $f \in C^\infty(D)$. Then $H_f$ is said to be a \dfn{completely integrable flow} if there are $f_1, \dots, f_n$, known as \dfn{integrals of motion}, such that $df_1, \dots, df_n$ are linearly independent, $\{f, f_j\} = 0$ and $\{f_i, f_j\} = 0$.
\end{definition}
Note that the Hamiltonian $f$ is an integral of motion; i.e. $H_ff = 0$, or in other words $\varphi_t^*f = f$. An integrable flow is one with maximally many independent integrals of motion.
Intuitively an integral of motion is a conserved quantity. It should not be a surprise that energy is conserved.

\begin{example}
Take $f$ to only depend on momentum, and let $f_j(x, \xi) = \xi_j$. Then $H_f = \sum_j \partial_{\xi_j}f(\xi) \partial_{x_j}$ and $H_{f_j} = \partial_{x_j}$ so $\{f, f_j\} = 0$. In fact,
$$\varphi_t(x, \xi) = (x + t\nabla f(\xi), \xi).$$
Thus this is a completely integrable system.
\end{example}

Completely integrable systems are in some sense the opposite of ergodic systems: they have as many invariant sets as they possibly can!

For example, let $L$ be a set where all the integrals of motion $f_j$ are constant. Since the $df_j$ are independent, $L$ is an $n$-dimensional submanifold. This follows from the implicit function theorem. Moreover the $H_{f_j}$ are a basis for the tangent space of $L$.

Recall the following result.
\begin{theorem}
A vector field $X$ is tangent to a submanifold $L = \{g_1 = g_2 = \cdots = g_n = 0\}$ iff $Xg_j|_L = 0$.
\end{theorem}

\begin{example}[uncoupled harmonic oscillators]
\index{uncoupled harmonic oscillators}
Let $(q, p) \in \RR^{2n}$ be a coordinate system and let $\sigma = dp \wedge dq$. Let $\omega_j > 0$ be constants and put
$$f(q, p)  = \frac{1}{2} \sum_j p_j^2 + \omega_j^2 q_j^2$$
be the Hamiltonian of a family of $n$ uncoupled harmonic oscillators. Let
$$f_j(q, p) = \frac{1}{2} \sum_j p_j^2 + \omega_j^2 q_j^2$$
be the Hamiltonian of the $j$th oscillator. Then the $f_j$s are uncoupled so $\{f_j, f_k\} = 0$. Let $D$ be the open submanifold $f_j > 0$.
We need to restrict to $D$ because on the tangent spaces of $q_j = 0$ or $p_k = 0$, the $df_j$ are not linearly independent.
We have
$$H_f = \sum_j p_j \partial_{q_j} - \omega_j^2q_j\partial_{p_j}.$$
Moreover
$$(q_j(t), p_j(t)) = (q_j(0)\cos(\omega_jt) + p_j(0)\omega_j^{-1}\sin(\omega_jt), p_j(0)\cos(\omega_jt) - \omega_j q_j(0)\sin(\omega_jt)).$$
Interestingly, if we choose coordinates $(x, \xi) \in \TT^n \times \RR^n_+$ where
$$q_j = \sqrt{\frac{2\xi_j}{\omega_j}}\cos(x_j)$$
and $p_j = -\sqrt{2\xi_j\omega_j}\sin(x_j)$, then $f(q, p) = \sum_j\cos(\xi_j)$ and $dp \wedge dq = d\xi \wedge dx$. So the state space of this harmonic oscillator is identical to the positive tangent space of a torus.
In these coordinates,
$$\varphi_t(x, \xi) = (x + t\omega, \xi).$$
\end{example}

\section{The Liouville-Arnold-Jost theorem}
\begin{example}
Take $M = \HH^2 \times \RR^2$ and let
$$f(x, y, \xi, \eta) = y^2(\xi^2 + \eta^2).$$
Then $f_1 = f$ and $f_2 = \xi$ are integrals of motion. We should look for coordinates on which the flow is linear. Doing this is far from obvious, but a theorem guarantees that such coordinates exist for any completely integrable system.
\end{example}

\begin{theorem}[Liouville-Arnold-Jost]
\index{Liouville-Arnold-Jost theorem}
Suppose that $f = (f_1, \dots, f_n)$ are such that the $df_j$ are linearly independent, $\{f_i, f_j\} = 0$. Let $N = f^{-1}(0)$. If $N$ is compact and connected, then $N $ is diffeomorphic to $\TT^n$, and there is an open neighborhood $U$ of $N$ which admits coordinates $(x, \xi) \in \TT^n \times D_1$, where $0 \in D_1 \subset \RR^n$ is open,
given by a map $\psi: \TT^n \times D^1 \to \to U$, and a local diffeomorphism $\mu$ near $0$ of $\RR^n$ such that
$$\mu \circ f \circ \psi(\xi) = \xi$$
and $\psi$ is a symplectomorphism.
\end{theorem}
In the coordinates $(x, \xi)$, the action of the Hamiltonian is linear. Unfortunately the construction of $(x, \xi)$ is far from easy in general; the Liouville-Arnold-Jost theorem is far from constructive.

\begin{corollary}
If $H_f$ is completely integrable then there are coordinates $(x, \xi)$ such that the Hamiltonian $f$ only depends on $\xi$.
\end{corollary}
In particular, if the Hessian of $f$ is nondegenerate in $(x, \xi)$ then we can solve for $\xi$ using the implicit function theorem, say $\nabla_\xi f = \omega$. In this case there is a vector $j$ orthogonal to $\omega$, and quotienting out by the lattice generated by $j$, we end up with an irrational rotation.

We first prove a weak form of the Liouville-Arnold-Jost theorem, which intuitively says that symplectic geometry is locally trivial.
\begin{theorem}[Darboux]
\index{Darboux's theorem}
Let $(M, \sigma)$ be a $2n$-dimensional symplectic manifold. Let $A,B \subseteq \{1, \dots, n\}$. Let $q_j, p_k \in C^\infty$ near $p_0 \in M$, $j \in A$, $k \in B$, and $\{q_i, q_j\}= 0 $, $\{p_k, p_\ell\} = 0$, $\{p_k, q_j\}= \delta_{kj}$.
Assume that the $dp_k,dq_j$ are linearly independent.
Then there is a symplectomorphism $\kappa$ from a neighborhood of $0 \in \RR^{2n}$ to a neighborhood of $p_0$, such that $\kappa^*q_j = x_j$, $\kappa^*p_k = \xi_k$.
\end{theorem}

To prove Darboux's theorem we need another theorem of differential geometry.
\begin{theorem}[Frobenius]
\index{Frobenius' theorem}
Let $V_1, \dots, V_r$ be vector fields on $\RR^n$ and $r \leq n$. Suppose that the $V_j(0)$ are linearly independent and $[V_j, V_k] = \sum_\ell c_{jk\ell} V_\ell$, where the $c_{jk\ell} \in C^\infty$ near $0$.

If $S$ is a submanifold of $\RR^n$ of codimension $r$ such that $T_0S+ \spn V_j(0) = \RR^n$, then the system of equations
\begin{align*}
V_ju&=f_j\\
u|_S&=u_0
\end{align*}
has a unique solution near $0$ iff
$$V_jf_i- V_if_j = \sum_k c_{ijk}f_k.$$

In addition, there are local coordinates $(y_1, \dots, y_n)$ near $0$ and a $r \times r$ invertible matrix $B = (b_{ij})$ of smooth functions near $0$ such that
$$\partial_{y_i} = \sum_{j=1}^r b_{ij}V_j.$$
\end{theorem}
\begin{proof}
We first show that the third paragraph implies the second paragraph. The condition $V_jf_i - V_if_j = \sum_k c_{ijk}f_k$ is invariant under linear combinations so it suffices to check when $V_j = \partial_{x_j}$, where $S$ is given by $(x_1, \dots, x_r) = h(x_{r+1}, \dots, x_n)$.
In this case the $c_{ijk} = 0$ and we are being asked to check
$$\partial_{x_i}f_j - \partial_{x_j}f_i= 0$$
or in other words $\omega = \sum_{j=1}^rf_j~dx_j$ is a closed form. Locally then it is exact, say $du = \omega$. Then $u$ solves the system of equations.

We prove the third paragraph using induction on the dimension, say $m$. If $m = 1$ let $V_1 = a(x)\partial_x$ so $a(0) \neq 0$. Change coordinates to $y$ so that $dy = dx/a(x)$ and $y(0) = 0$.

Now if $m \geq 2$, we may change variables so that $V_1 = \partial_{x_1}$. This is always possible for any nonvanishing vector field. Without loss of generality we may assume that if $j \geq 2$,
$$V_j = \sum_{\ell=2}^m b_{j\ell} \partial_{x_\ell}$$
by subtracting off $b_{j1}V_1$ from $V_1$.
Let $x' = (x_2, \dots, x_m)$ and change variables in $x'$ using induction so that if $x_1 = 0$,
$$V_j = \sum_{\ell=2}^r b_{j\ell}\partial_{x_\ell}.$$
Thus we have discarded $(x_{m+1}, \dots, x_r)$.
Then
$$\frac{\partial b_{j\ell}}{\partial x_1} = V_1V_jx_\ell = [V_1, V_\ell]x_\ell = \sum_{k=2}^r c_{1jk}V_kx_\ell= \sum_{k=2}^r c_{1jk}b_{k\ell}.$$
By uniqueness of ODE, it follows that $b_{j\ell}(x) = 0$ for $\ell > r$.
\end{proof}

\begin{proof}[Proof of Darboux's theorem]
We can assume $p_0 = 0$. Set $x_j = q_j$ and $\xi_k = p_k$ where $j \in A$ and $k \in B$.
By the linear Darboux theorem, we can extend $(x, \xi)$ to a full set of coordinates such that at $0$, $\{x_i, x_j\} = \{\xi_i, \xi_j\} = 0$ and $\{\xi_k, x_\ell\} = \delta_{k\ell}$.
In particular, $H_{q_j}(0) = -\partial_{\xi_j}$ and $H_{p_k}(0) = \partial_{x_k}$.

Suppose $J \notin A$ (the case for $B$ is similar). We must find $q_J$ such that $\{q_J, q_j\} = 0$ and $\{q_J, p_k\} = \delta_{Jk}$. We thus try to solve the equation
$$H_{q_i}q_J = 0,\quad H_{p_k}q_J = \delta_{kJ},\quad q_J(x, \xi)= x_J$$
when $\xi_j = 0$ and $x_k = 0$.
The solution to this equation exists by Frobenius' theorem.
\end{proof}

An important special case to Darboux's theorem is when $A = \emptyset$ and $B = \{1, \dots, n\}$, i.e. we are given coordinates $\xi_1, \dots, \xi_n \in C^\infty$ such that $d\xi_j(p_0)$ are linearly independent and $\{\xi_i, \xi_j\} = 0$.
One then can find coordinates $x_1, \dots, x_n$ such that $\sum_j d\xi_j \wedge dx_j$ is indistinguishable from the standard system of symplectic coordinates in $\RR^{2n}$.

\begin{proof}[Proof of the Liouville-Arnold-Jost theorem]
Let $\Phi: \RR^n/\Gamma \to f^{-1}(0)$ be our torus diffeomorphism, and $\psi_0$ be a local diffeomorphism from close to $0$ to close to $\rho \in f^{-1}(0)$, such that $\psi_0^*f_j = \xi_j$ and $\psi_0^*\sigma$ is the standard symplectic form.
Let $\Phi_t$ be the Hamiltonian flow.

If $|t|$ is small,
$$\Phi_t \circ \psi_0(x, \xi) = \psi_0(x + t, \xi).$$
We want to use this relation to define $\psi$, an extension of $\psi_0$. That would mean that for all $R$ there is a neighborhood of $0$, $D_2(R)$, such that $\Phi_t(\psi(0, \xi))$ is well-defined for $t \in B(0, R)$ and $\xi \in D_2(R)$. If not then there is an $R$ such that for all $r$, there are $|t| \leq R$, and $|\xi| \leq r$, such that $\Phi_t(\psi(0, \xi))$ is not well-defined.
Then $\Phi_t(\psi_0(0, \xi)) \notin M$ which is impossible.

Let $\gamma_j$ be the generators of $\Gamma$.

\begin{lemma}
The map $\theta: B(0, R) \times D_2(R) \to M$, $\theta(x, \xi) = \Phi_x(\psi(0, \xi))$ satisfies
$$\theta^*\sigma = \sum_j d\xi_j \wedge dx_j.$$
\end{lemma}
\begin{proof}[Proof of lemma]
If $(x, \xi)$ is small,
$$\theta(x, \xi) = \Phi_x(\psi_0(0, \xi)) = \psi_0(x, \xi)$$
and the claim follows from the fact that $\psi_0$ is a symplectomorphism.

Now put $\theta_s(x, \xi) = \theta(x - s, \xi)$, which is defined on $B(s, R) \times D_2(R)$. Then
$$\theta^*\sigma = (\Phi_s \circ \theta_s)^*\sigma = \theta_{-s}^*\Phi_s^*\sigma = \theta_{-s}^*\sigma$$
so
$$\theta^*\sigma = \sum_j d\xi_j \wedge (dx_j - ds_j)$$
but the standard symplectic form is invariant under translation.
\end{proof}

We want to find $\gamma_j(\xi)$ such that
$$\theta(\gamma_j(\xi), \xi) = \theta(0, \xi).$$
This mimics the fact that $\theta(\gamma_j, 0) = \theta(0, 0)$.

Now $\psi_0^{-1}(\theta(\gamma_k, 0)) = (0, 0)$ so if $(y, \eta)$ is small, the definition
$$\rho(y, \eta) = \psi_0^{-1}(\theta(\gamma_k + y, \eta))$$
makes sense (we put $\rho(0) = 0$). Then
$$\xi_j = \psi_0^*f_j(x, \xi) = f_j(\theta(\gamma_k + y, \eta)) = f_j(\psi_0(y, \eta)) = \eta_j$$
but $\rho = \psi_0^{-1} \circ \theta_{\gamma_k}$ and $\psi_0,\theta_{\gamma_k}$ are symplectomorphisms, so $\rho$ is a symplectomorphism.
Then
$$\rho^*\sum_jd\xi_j \wedge dx_j = \sum_j d\eta_j \wedge dy_j.$$
This follows by the lemma. So
$$\rho(y, \eta) = (y + \frac{\partial Q_k}{\partial \eta}(\eta), \eta)$$
for some function $Q$ such that
$$\frac{\partial Q_k}{\partial \eta}(0, 0) = 0.$$
In particular if we put $(x, \xi) = \rho(y, \eta)$ we have $\xi = \eta$.
Therefore, since $\psi_0$ is injective,
$$\psi_0(y + \partial_\xi Q_k(\xi), \xi) = \psi_0(0,\xi)$$
implies that we have the differential equation
$$y + \frac{\partial Q_k}{\partial \xi} = 0.$$
Thus $y$ is determined by $\xi$.
This uniquely determines the function $\gamma_k$.
Now, by the group property of $\Phi_t$, we can translate $\gamma_k$ for all times, using the periodicity
$$\theta(x + \gamma_k(\xi), \xi) = \theta(x, \xi).$$
Thus $\theta: \RR^n \times D_2 \to M$ is well-defined.

Now forget that $k$ was the index used to describe the generators of the lattice $\Gamma$, and use it as a sequential index.

If we define $\Gamma(\xi) = \{\sum_j m_j\gamma_j(\xi)\}$, then we have a map
$$\theta_\xi: \frac{\RR^n}{\Gamma(\xi)} \to f^{-1}(\xi) \cap U.$$
Now this map is surjective, but to check that it is injective, we notice that we just need to check when $\xi$ is close to $0$.
If $(x_k, \xi_k)$ and $(x_k', \xi_k')$ are sequences of points (necessarily not in $\Gamma$) such that $\gamma_k \to 0$, $x_k - x_k' \notin \Gamma(\xi_k)$, and $\theta(x_k, \xi_k) = \theta(x_k', \xi_k')$.
Passing to a subsequence, we choose $x,x'$ such that $x_k \to x$ and $x_k' \to x'$. Then $\theta(x, 0) = \theta(x', 0)$, so $x - x' \in \Gamma(0)$, so there is a $\gamma_k \in \Gamma(\xi_k)$, such that $d(x_k - x_k', \gamma_k)$ is small, but since $\Gamma$ is discrete it follows that $\gamma_k$ is a constant sequence.
Translating by $\gamma_k$ we have $x_k - x_k' = 0 $. Thus close to any point $\theta_\xi$ is injective, hence $\theta_\xi$ is injective.

Finally we must ``normalize periods", i.e. find symplectomorphisms to replace $\Gamma(\xi)$ with $\Gamma$.
This is accomplished by a map $\sigma$ such that
$$\sigma^*\sum_j d\xi_j\wedge dx_j = \sum_j d\eta_j \wedge dy_j.$$
\end{proof}

\section{The Toda lattice}
We now consider the first example of a completely integrable system which is important in practice.

Suppose we have $n$ particles in $\RR^N$, interacting according to the Hamiltonian
$$H(q, p) = \sum_{j=1}^n \frac{p_j^2}{2m_j} + \sum_{i<j} V_{ij}(q_i - q_j).$$
Here $q_i$ is the position of the $i$th particle and $p_i$ is its momentum.

\begin{example}
The planetary system is given by
$$V_{ij}(q) = \frac{c_{ij}}{|q|}$$
for some $c_{ij} = c(m_i, m_j)$.
Here
$$\dot q_j = \frac{m_j}{p_j}$$
and
$$\dot p_j = -\partial_{q_j} U(q)$$
where
$$-\partial_{q_j} U(q) = m_j\ddot q_j.$$
Trying to understand this system (using $7$th-order perturbation theory by hand) lead to the discovery of Neptune.
\end{example}

\begin{definition}
Let $W_j(x) = e^x$ be the potential, and $N = 1$. Here
$$H(q, p) = \frac{1}{2} \sum_{j=1}^n p_j^2 + \sum_{j=1}^{n-1} e^{q_j - q_{j+1}},$$
where the particles are lined up so $-\infty = q_0 < q_1 < \cdots < q_n < q_{n+1} = \infty$.
This system is called the \dfn{Toda lattice}.
\end{definition}
We observe that the total momentum
$$P = \sum_j p_j$$
of the Toda lattice is conserved. Since $\{P, H\} = 0$, the Toda lattice is completely integrable when $n = 2$. But a miracle happens, and the Toda lattice is actually completely integrable for all $n$.
But the state space of the Toda lattice is not compact so we cannot use the Liouville-Arnold-Jost theorem.
\begin{theorem}
There are integrals of motion $F_j$ for the Toda lattice, which are polynomials in $p_k$ and $e^{q_k - q_{k+1}}$.
\end{theorem}
To see this, we introduce \dfn{Flaschka's coordinates}. Here
$$a_j = \frac{e^{(q_j-q_{j+1})/2}}{2}$$
where $j < n$ and
$$b_j = -\frac{p_j}{2}$$
where $j \leq n$. Then
$$\dot a_j = a_j(b_{j+1} - b_j)$$
and
$$\dot b_j = 2(a_j^2 - a_{j-1}^2).$$
Now this is missing a dimension but note that $s \mapsto (q + (s, \dots, s), p)$ is an action of $\RR$ on $\RR^{2n}$ which preserves the system,
namely translating all the $q_j$ by $t$, so we just need coordinates on $\RR^{2n-1} = \RR^{2n}/\RR$.

Now let $L$ be the matrix with $b_i$ on the diagonal and $a_i$ on the subdiagonal and superdiagonal. Let $B$ be the matrix with $a_i$ on the superdiagonal and $-a_i$ on the subdiagonal.
Then
$$\frac{dL}{dt} = [B, L]$$
if and only if $(q, p)$ is a solution of the Hamiltonian flow.
\begin{definition}
A pair of matrices $(B, L)$ such that $dL = [B, L]~dt$ if and only if the entries of $B,L$ satisfy a Hamiltonian flow $H$ are called a \dfn{Lax pair} for $H$.
\end{definition}
The fact that $(B, L)$ is a Lax pair for the Toda lattice is a ``miracle." It completely trivializes the study of the Toda lattice.
\begin{example}
The KdV equation is a PDE
$$u_t = 6uu_x - u_{xxx}$$
which admits a Lax pair. Here $L = -\partial_x^2 + u$ and $B = -4\partial_x^3 + 6u\partial_x + 3u_x$ are operators acting on $C^\infty$.
\end{example}

Note that $L$ is symmetric, so it is diagonalizable and its eigenvalues are real. The $a_j > 0$ since they are exponentials, and a computation shows that every eigenvalue has a $1$-dimensional eigenspace.
In fact, if $\varphi$ is an eigenvector for the eigenvalue $\lambda$ and we normalize so $\varphi_n = 1$, $a_{k-1}\varphi_{k-1} + b_k\varphi_k = \lambda \varphi_k$, so $\varphi$ is uniquely defined by the normalization and a backwards recursion.
Therefore $L$ only has simple eigenvalues. Therefore $\lambda_j(a, b)$, the $j$th eigenvalue of $L(a, b)$, determines a smooth function on $\RR^{n-1}_+ \times \RR^n$.
This can be proven by using the implicit function theorem on the characteristic polynomial of $L$ when $(a, b)$ is close to $0$.

In fact $\lambda_j$ is constant on any flow.
\begin{definition}
Two matrices are \dfn{isospectral} if their spectra are identical.
\end{definition}
We must show that the $L(a(t), b(t))$ are isospectral in $t$. To see this we solve the equation
$$\partial_t U(t) = B(a(t), b(t)) U(t)$$
where $U(0) = 1$. This is a system of ODE, so $U$ exists. Now $U(t)$ is an orthogonal matrix, since $U(0)$ is and
$$\frac{d}{dt}(U(t)^TU(t)) = 0$$
so $U(t)^TU(t) = U(0)^TU(0) = 1$. In other words, we have \dfn{unitary of Schrodinger propagation}.
We also can show that $L(t)U(t) = U(t)L(0)$. By unitarity it suffices to show that
$$\frac{d}{dt} U(t)^TL(t)U(t) = 0$$
and this follows by a straight computation:
\begin{align*}
\dot U^TLU + U^TL\dot U + U^T\dot LU &= U^TB^TLU = U^TLBU = U^T[B, L]U \\
&=U^T[L, B]U + U^T[B, L]U = 0.
\end{align*}
Therefore $L(a(t), b(t))$ is isospectral. So
$$F_k(q, p) = \tr(L(a, b)^k)$$
is a preserved quantity. In fact $F_1 = \tr L = -P/2$, while $F_2 = \tr L^2 = H/2$.

As we require, the $dF_k$ are linearly independent. It suffices to show that the determinant
$$\det\left(\frac{\partial F_k}{\partial \lambda_j}\right) \neq 0$$
and we have $F_k = \sum_j \lambda_j^k$. So
$$\det\left(\frac{\partial F_k}{\partial \lambda_j}\right) = n! \begin{vmatrix}1 & \cdots & 1\\
\lambda_i & \cdots & \lambda_i\\
\lambda_i^2 & \cdots & \lambda_i^2\\
&\vdots\\
\lambda_i^{n-1}& \cdots & \lambda_i^{n-1}\end{vmatrix} = n!\prod_{i<j} \lambda_j - \lambda_i$$
by Vandermonde's determinant formula, which is nonzero since the eigenvalues are simple.

We must show that $\{F_j, F_k\} = 0$ and it suffices to show $\{\lambda_j, \lambda_k\} = 0$.
Let $\lambda = \lambda_j$, $\mu = \lambda_k$, $L\varphi = \lambda\varphi$, and $L\psi = \mu\psi$.
Assume $||\varphi|| = ||\psi|| = 1$ and $\langle \varphi, \psi\rangle = 0$.
If $f,g$ are smooth then
$$\Psi^* \{f, g\}_* = \{\Psi^*f, \Psi^*g\},$$
and the pushforward is along the change-of-coordinates $\Psi: (p, q) \mapsto (a, b)$.
So we just want to show
$$\{\lambda, \mu\}_* = 0.$$
\begin{theorem}[Feynman-Hellman]
\index{Feynman-Hellman theorem}
Suppose $L$ is a differentiable one-parameter family of operators, and $L\varphi = \lambda\varphi$, where $\lambda$ is a simple eigenvalue. If $||\varphi|| = 1$ then
$$\cdot \lambda = \langle (L\varphi)', \cdot \varphi\rangle.$$
\end{theorem}
\begin{proof}
Differentiating $L\varphi$ using the Leibniz rule we have
$$(L\varphi)' = (\lambda \varphi)' + \lambda\cdot \varphi.$$
Now take the inner product with $\varphi$ on both sides and use the fact that $(||\varphi||)' = 1$.
\end{proof}
We have
\begin{align*}
\partial_{b_j} L &= e_j \otimes e_j\\
\partial_{a_j} L &= e_j \otimes e_{j+1} + e_{j+1} \otimes e_j.
\end{align*}
so by the Feynman-Hellman theorem,
\begin{align*}
\partial_{b_j} \lambda &= \varphi_j^2\\
\partial_{a_j} \lambda &= 2\varphi_{j+1}\varphi_j.
\end{align*}
Moreover
$$4\{\lambda, \mu\}_* = \sum_j (a_j \partial_{a_j}\lambda - a_{j-1}\partial_{a_{j-1}}\lambda)\partial_{b_j}\mu - (a_j\partial_{a_j} \mu - a_{j-1}\partial_{a_{j-1}}\mu)\partial_{b_j}\lambda$$
and plugging in the Feynman-Hellman computation,
$$2\{\lambda, \mu\}_* = \sum_j (a_j \varphi_j\varphi_{j+1} - a_j\varphi_{j-1}\varphi_j)\psi_j^2 - (a_j\psi_j\psi_{j+1} - a_j\psi_{j-1}\psi_j)\varphi_j^2.$$
We take the convention $a_0 = a_n = 0$. We introduce the Wronskian,
$$W_j = a_j(\varphi_{j+1}\psi_j - \varphi_j \psi_{j+1}).$$
Here we are thinking of the $\psi,\varphi$ as functions on finite sets, and viewing $W_j - W_{j-1}$ as the ``derivative" of $W_j$.
In this sense $W_j$ is the Wronskian of $\varphi,\psi$.

In fact,
$$W_j - W_{j-1} = (\lambda - \mu)\varphi_j\psi_j.$$
This can be verified by computing
\begin{align*}
L\varphi_j &= \lambda \varphi_j\psi_j\\
L\psi_j &= \mu \psi_j \varphi_j
\end{align*}
and subtracting the two lines.

It follows that
$$W_j^2 - W_{j-1}^2 = (\lambda - \mu)(a_j\varphi_{j+1}\varphi_j - a_{j-1}\varphi_{j-1}\varphi_j)\psi_j^2 - A)$$
where $A$ is the same as the previous term but with $\varphi$ replaced with $\psi$. Then
$$2\{\lambda, \mu\}_* = \frac{1}{\lambda - \mu}\sum_j W_j^2 - W_{j-1}^2 = (\lambda - \mu)^{-1}(W_n^2 - W_0^2)$$
since the Wronskians telescope, and by our convention we have $W_n = W_0 = 0$. So $\{\lambda, \mu\}_* = 0$.

Now define
$$x_j = |\langle \varphi_j, e_n\rangle|.$$
We will study the evolution of $x$. Let
$$f(z) = \langle (z - L)^{-1}e_n, e_n\rangle = \sum_j \frac{x_j^2}{z - \lambda_j}.$$

Since the $a_j > 0$ it is no loss of information to replace $a_j$ with $a_j^2$. Define
\begin{align*}
\chi: \RR^{n-1}_- \times \RR^n \to \RR^n \times \{x \in \RR^n_+: ||x|| = 1\}\\
(a^2, b) \mapsto (\lambda, x).
\end{align*}
If we can invert $\chi$ we will know how $(a, b)$ and hence $(q, p)$ evolves explicitly in terms of the eigenvalues $\lambda$ and scalars $x$.

\begin{lemma}
We have
$$-\frac{\dot x_j}{x_j} = -\lambda_j + \sum_k \lambda_kx_k^2.$$
Moreover, this flow preserves the set $\{x \in \RR^n_+: ||x|| = 1\}$.
\end{lemma}
\begin{proof}
To see that $||x|| = 1$ is preserved, we simply expand out the definition of $||x||$, differentiate it, and notice that $||x||' = 0.$
Moreover, if $\alpha_j = \log x_j$, then $\dot \alpha$ is Lipschitz and so exists for all time by a Picard-type theorem.

As for the main claim,
$$L(t)U(t) = U(t)L(0)$$
so
$$\varphi_k(t) = U(t) \varphi_k(0).$$
Since $\cdot U = BU$,
$$\cdot \varphi_k(t) = B(t)\varphi_k(t).$$
Then
$$\langle \cdot \varphi_k(t), e_n\rangle = a_{n-1}\langle \varphi_n, e_{n-1}\rangle + b_n x_k$$
so
$$\cdot x_k = - \lambda_k x_k + b_n x_k.$$
Since $||x|| = 1$, $(||x||)' = 0$, so differentiating,
$$0 = -\sum_k \lambda_k x_k^2 + b_n.$$
\end{proof}

The system given by the lemma is easy to solve. Set
$$y_j(t) = y_j(0)e^{-\lambda_jt}$$
and set
$$x_j = \frac{y_j}{||y||}.$$
Using this normalization,
$$\frac{x_j(t)^2}{x_j(0)^2} = \frac{e^{-2\lambda_jt}}{\sum_k x_k(0)^2e^{-2\lambda_kt}}.$$
We can therefore view $x$ as a linear dynamical system.
Thus, if we can invert $\chi$, we will explicitly have solved the system $(q, p)$.

We can view the situation as a commutative diagram
$$
\begin{tikzcd}
(q(0), p(0)) \arrow[r]\arrow[d] &L(0) \arrow[r] & (\lambda, x(0))\arrow[d]\\
(q(t), p(t)) & L(t)\arrow[l] & (\lambda, x(t))\arrow[l]
\end{tikzcd}
$$
We are looking for the arrow $(\lambda, x(t)) \to L(t)$.

Put
$$f(z) = \langle (z-L)^{-1}e_n, e_n\rangle = \sum_j \frac{x_j^2}{z - \lambda_j}.$$
\begin{theorem}[Stjeltes]
We have
$$f(z) = \frac{1}{z - b_n - \frac{a_{n-1}^2}{z - b_{n-1} - \frac{a_{n-2}^2}{z - b_{n-2} - \cdots}}}.$$
\end{theorem}
\begin{proof}
Let $L_j$ be the matrix containing the first $j$ rows and columns of $L$. Let $\Delta_j(z) = \det(z - L_j)$.
By Cramer's rule,
$$f(z) = \frac{\Delta_{n-1}(z)}{\Delta_n(z)}.$$
Moreover,
$$\Delta_j(z) = (z - b_j)\Delta_{j-1}(z) - a_{j-1}^{-1}\Delta_{j-2}(z)$$
by the recurrence definition of the determinant.
Here we take $\Delta_0 = \Delta_{-1} = 0$.

Let $\rho_j = \Delta_j/\Delta_{j-1}$, so
$$\rho_j(z) = z - b_j - \frac{a_{j-1}^2}{\rho_j - 1}.$$
Here we take $\rho_1(z) = z - b_1$.
Then $\rho_n = f^{-1}$ gives the continued fraction expansion.
\end{proof}
Now $f = P_{n-1}/Q_n$ where
$$P_{n-1}(z) = \sum_{j=1}^{n-1} x_j^2 \prod_{i \neq j} z - \lambda_i$$
and
$$Q_n(z) = \prod_{j=1}^n z - \lambda_j.$$
A straight computation gives
$$\frac{Q_n(z)}{P_{n-1}(z)} = z - \beta - \alpha\frac{Q_{n-2}(z)}{P_{n-1}(z)}.$$
Thus
$$f(z) = \frac{1}{z - \beta - \alpha g(z)}$$
where $g=Q_{n-2}/P_{n-1}$ and $\alpha,\beta$ are uniquely determined by $x, \lambda$, and $g$ is of the same form as $f$, say
$$g(z) = \sum_{j=1}^{n-1}\frac{\sigma_j}{z - \mu_j}$$
so $\sigma_j$ is the residue of $\mu_j$ at $z$. Thus
$$\sigma_j = -\frac{1}{\alpha f'(\mu_j)} > 0.$$

We now show that the Toda lattice admits scattering, i.e. we can determine its behavior at $t = +\infty$ from its behavior at $t = -\infty$.
\begin{theorem}
There is a $\delta > 0$ such that $q_j(t) = \alpha_j^+t + \beta_j^+ + O(e^{-\delta t})$ as $t \to +\infty$ and $q_j(t) = \alpha_j^-t + \beta_j^- + O(e^{\delta t})$ as $t \to -\infty$, where
$\lambda_i < \lambda_{i+1}$, $\alpha_j^+ = -2\lambda_{n-j+1}$, and $\alpha_j^- = -2\lambda_j$.
\end{theorem}
\begin{proof}
$a_j(t)^2$ and $b_j(t)$ are rational functions of $e^{-\lambda_jt}$. Thus they have asymptotic expansions $c_1^\pm e^{\eta_1^\pm t}+c_2^\pm e^{\eta_2^\pm t} + \cdots$ as $t \to \pm \infty$ and $\eta_j^\pm = \sum_k m_{jk}^\pm \lambda_j$ where $m_{jk}^\pm \in \ZZ$.

Now
$$\int_{t_1}^{t_2}a_j^2 - a_{j-1}^2 = b_j(t_2) - b_j(t_1)$$
telescopes, and since $2\sum_j b_j^2 + 4\sum_j a_j^2$ is a conserved quantity a sum of $b_j$ must be bounded. Therefore $a_j^2 \in L^1(dt)$.
Since $a_j$ has an asymptotic expansion in exponentials, it follows that $a_j \to 0$. Thus $L(t) \to L(\pm \infty)$ which is a diagonal matrix.
Solving $\dot a_j/a_j = b_{j+1} - b_j$ we have $b_j(+\infty) = \lambda_{n-j+1}$ and $b_{-j}(-\infty) = \lambda_j$.
\end{proof}
So the velocities are not just permuted, but are reversed in order.

\section{The QR algorithm}
We now apply the theory of completely integrable systems to study a diagonalization algorithm from numerical linear algebra.
It was voted among the top ten algorithms of the last century, along with the fast Fourier transform, which confusingly was discovered by Gauss long before the last century.
\begin{theorem}
For every invertible real matrix $A$ there is a unique factorization $A = QR$ such that $R_{ii} > 0$, $Q$ is orthogonal, $R$ is upper triangular.
\end{theorem}
\begin{proof}
Let $A = [a_1 \cdots a_n]$. Since $A$ is invertible the $a_i$ are linearly independent, so apply the Gram-Schmidt algorithm to $A$ to obtain an orthogonal matrix $Q$. Let
$$R = \begin{bmatrix}
\langle e_1, a_1\rangle & \langle e_1, a_2 \rangle & \cdots \\
0 & \langle e_2, a_2 \rangle & \cdots\\
&\vdots
\end{bmatrix}$$
then $A = QR$. If $Q_1R_1 = Q_2R_2$ then $Q_1^{-1}Q_2 = R_2 R_1^{-1}$ so $R_2R_1^{-1}$ is an upper triangular matrix which is positive on the diagonal and yet has determinant $1$, so $R_2 = R_1$.
\end{proof}
Given $A = QR$, let $T(A) = RQ$. Note that
$$T(A) = Q^*QRQ = Q^{-1}AQ.$$
Thus $T(A)$ and $A$ are isospectral, and $T$ preserves the space $B_{sa}$ of self-adjoint matrices.
\begin{theorem}[Kublanovskya-Francis, 1961]
\index{Kublanovskya-Francis theorem}
If $A$ is positive-definite and self-adjoint with simple eigenvalues then
$$\lim_{n \to \infty} T^n(A) = \diag(\lambda_i)$$
where $\lambda_i$ are the eigenvalues of $A$, $\lambda_i > \lambda_{i+1}$.
\end{theorem}
That is, $T$ is a discrete isospectral system which converges to the diagonalization. This is analogous to the Toda lattice, where we had a continuous isospectral system which converged to the diagonalization.
We proved that the convergence of $L$ is exponential, namely that
$$||L(t) - L(\infty)|| = O(\exp(-2t\min_j(\lambda_j - \lambda_{j-1}))).$$
Let $J$ be the space of tridiagonal matrices such that the subdiagonal and superdiagonal are positive and identical. An algebraic computation shows that $T$ sends $J$ to tridiagonal matrices.
Recall from Toda lattice theory that there is a diffeomorphism $\chi: J \to \{(\lambda, x)\}$ where $\lambda_i > \lambda_{i+1} > 0$, $\lambda$ is the spectrum of the preimage $L$, $x_j > 0$, and $||x|| = 1$.
Here $x$ is defined by the property that if $L = U\Lambda U^*$ then $x = U^*e_1$.
\begin{lemma}
Let
$$(\lambda, x^k) = \chi(T^k(\chi^{-1}(\lambda, x_0))).$$
Then
$$||\Lambda^k x^0|| x^k = \Lambda^k x^0.$$
\end{lemma}
\begin{proof}
It suffices to check this when $k = 1$. This can be checked by noting that the unitary matrix $U_1$ obtained by diagonalizing $T(\Lambda)$ is given by the Gram-Schmidt algorithm.
\end{proof}
Recall that the Toda flow is given by
$$x(t) = \frac{e^{At}x(0)}{||e^{At}x(0)||}.$$
Similarly we here have
$$x^k = \frac{e^{Ak} x(0)}{||e^{Ak} x(0)||}$$
where $A = \log \Lambda$.
Thus in the coordinates $(x, \lambda)$ the QR algorithm is a discretized Toda flow, provided that our initial conditions were tridiagonal.

We now construct a discrete Lax pair for the QR algorithm. For any matrix $A$, we may uniquely decompose
$$A = \pi_SA + \pi_LA$$
where $\pi_SA$ is anti-self-adjoint and $\pi_LA$ is lower triangular. In fact, $\pi_SA$ is given by taking the part of $A$ above the diagonal and reflecting it over the diagonal.
Given a continuous function $G: \RR_+ \to \RR$ we extend it to self-adjoint matrices $L$ by
$$G(L) = U G(\Lambda) U^*$$
where $LU = U\Lambda$ is the diagonalization of $L$ given by the spectral theorem and $G$ acts on diagonal matrices pointwise.
This is a functional calculus for self-adjoint operators.
Let $B_G = \pi_S \circ G$. Then the map $L \mapsto [B_G(L), L]$ preserves tridiagonality. This can be easily checked for $G(\lambda) = \lambda^k$ and then may use a variant of the Stone-Weierstrass theorem.
One may then check that if we define
$$\cdot x(t) = G(\Lambda)x(t) - \langle G(\Lambda)x(t), x(t)\rangle x(t)$$
then $\cdot L = [B_G(L), L]$. For appropriate $G$ this gives a Lax pair for the QR algorithm.

\chapter{Complex dynamics}
\section{Siegel's KAM theorem}
Let $U,V$ be neighborhoods of $0$ in $\CC$. Assume $f: U \to V$ is holomorphic, $f(0) = 0$, $f'(0) = e^{2\pi i\theta}$ where $\theta$ is an irrational angle.
We would like to find a conformal transformation $\varphi$ defined locally near $0$ which conjugates $f$ to rotation by $e^{2\pi i\theta}$.
If this is the case, we will have lots of invariant sets for $f$, namely the $\varphi$-image of circles centered around $0$.
Whether this is possible depends strongly on number-theoretic properties of $\theta$.

One can view the rotation $e^{2\pi i \theta}$ as a simple Copernican model of the solar system; then the real solar system is a slight perturbation, and we would like to know that it is quasiperiodic. That is, a slight perturbation of $f$ preserves the dynamics.

\begin{theorem}[Siegel]
\index{Siegel's theorem}
Suppose that $\theta$ is \dfn{diophantine} in the sense that there is a $C>0$ and $\mu$ large enough that for all $p, q \in \QQ$,
$$\left|\theta - \frac{p}{q}\right| \geq \frac{C}{q^\mu}.$$
Then there is a conformal transformation $\varphi$ such that
$$f(\varphi(z)) = \varphi(e^{2\pi i \theta}z).$$
\end{theorem}

We first show that there are diophantine numbers. Let $\mu > 2$.
Let $E$ be the set of all $\theta$ such that for infinitely many $p, q$, $|\theta - p/q| < q^{-\mu}$. Then for every $n$,
$$E \subseteq \bigcup_{q \geq n}\bigcup_{p=0}^q [p/q- q^{-\mu}, p/q + q^{-\mu}]$$
so
$$|E| \leq \sum_{q \geq n}\sum_{p = 1}^q 2q^{1-\mu} = O(n^{2-\mu})$$
so $E$ has measure $0$, hence most numbers are diophantine.

So fix a diophantine number $\theta$ and let $\lambda = e^{2\pi i\theta}$.

We now observe that if
$$f(\varphi(z)) = \varphi(\lambda z),$$
then $\varphi$ is automatically injective, hence conformal by the inverse function theorem. In fact if $\varphi(z) = \varphi(w)$ then
$$\varphi(\lambda z) = f(\varphi(z)) = f(\varphi(w)) = \varphi(\lambda w)$$
and iterating we see that
$$\varphi(\lambda^n z) = \varphi(\lambda^n w)$$
but the $\lambda^n z$ are a set with an accumulation point, and if two holomorphic functions agree on a set with an accumulation point then they agree everywhere.

\begin{lemma}
There is a $\varphi$ iff there is a $\delta > 0$ such that $f^n(z)$ is a bounded sequence if $|z| < \delta$.
\end{lemma}
\begin{proof}
If $\varphi$ exists then
$$f^n(z) = \varphi(\lambda^n \varphi^{-1}(z))$$
which is obviously bounded.

Conversely, assume a bound $M$ exists and let
$$h_n(z) = \frac{1}{n}\sum_{m=0}^{n-1} \lambda^{-m} f^m(z)$$
be the ergodic average. By assumption $|h_n(z)| \leq M$. By the Cauchy estimate for the disc $|z| < \delta/2$,
$$|h_n'(z)| \leq \frac{2M}{\delta}$$
so by the Ascoli theorem, we can pass to a Cauchy subsequence and assume $\lim_n h_n = h$ in $C^0$.
By Morera's theorem $h$ is holomorphic, and
$$h_n'(0) = \frac{1}{n} \sum_{m=0}^{n-1} \lambda^{-m} \lambda^m = 1$$
so $h'(0) = 1$ and by the inverse function theorem $h$ has a conformal inverse $\varphi$.
\end{proof}

We now show that some hypothesis on $\theta$ is necessary.
\begin{theorem}[Pfeiffer]
\index{Pfeiffer}
There is a $\theta$ such that for any polynomial $f$ of degree $\geq 2$, no $\varphi$ exists.
\end{theorem}
\begin{proof}
Assume
$$f(z) = z^d + \cdots + \lambda z.$$
Assume $\varphi$ exists and is defined if $|z| < \delta$.
Let $z_1, \dots, z_{d^n-1}$ be the nonzero fixed points of $f^n$, which exist since $f'(0) = \lambda \neq 0$.
Then they are nonzero zeroes of
$$f^n(z) - z = z^{d^n} + \cdots + (\lambda^n - 1)z.$$
By assumption, $|z_j| \geq \delta$; since $|z| < \delta$ is conjugated to rotation. Thus
$$\delta^{d^n} < \delta^{d^n - 1} \leq \prod_j |z_j| = |\lambda^n - 1|.$$
The last equality is true because the $z_j$ are zeroes of a polynomial whose constant term is $\lambda^n - 1$.
So we must find a $\theta$ such that for every $d,\delta$ we can find an $n$ such that
$$\delta^{d^n} \geq |\lambda^n - 1|.$$

For some sequence $q_k \in \NN$, to be determined, let
$$\theta = \sum_{k=1}^\infty 2^{-q_k}.$$
Then
$$|1 - \lambda^{2^{q_k}}| \sim 2^{q_k-q_{k+1}}.$$
Assume $\delta^{2^{q_k}} < |\lambda^{2^{q_k}} - 1|$, so
$$\delta^{d^{2^{q_k}}} = O(2^{q_k - q_{k+1}}).$$
Thus
$$q_{k+1} = O_\delta(d^{2^{q_k}}).$$
Now let
$$\log q_{k+1} \geq ke^{q_k}$$
which is a contradiction.
\end{proof}

We now prove Siegel's theorem. Siegel used an extremely complicated number-theoretic proof, but we will give Moser's proof, which easily follows from KAM theory.
\begin{proof}[Proof of Siegel's theorem]
Our goal is to construct $\varphi$ with the desired properties, which in particular imply
$$\varphi(z) = z + O(z^2).$$
Thus we define $\varphi(z) = z + \hat \varphi(z)$ so $\hat \varphi(z) = O(z^2)$, and write $f(z) = \lambda z + \hat f(z)$.
As in the case of the cat map, we want to solve the equation
$$\hat \varphi(\lambda z) - \lambda \hat \varphi(z) = \hat f(z + \hat \varphi(z))$$
for $\hat \varphi$.
Unfortunately the cat map was hyperbolic, while the dynamics here are rotational.
Let
$$\hat f(z) = \sum_{n=2}^\infty b_nz^n.$$

Linearize the equation we want to solve, we get a function
$$\hat \psi(z) = \sum_{n=2}^\infty c_nz^n,$$
such that
$$\hat \psi(\lambda z) - \lambda \hat \psi(z) = \hat f(z).$$
Solving the Taylor series we have
$$c_n = \frac{b_n}{\lambda^n - \lambda}.$$

Since $\theta$ is diophantine, there are $C,\mu$ such that
$$|\lambda^n - 1|^{-1} \leq C\frac{n^\mu}{\mu!}.$$
Moreover $|\hat f'(z)| < \delta$ if $|z| < \varepsilon$ for some $\varepsilon > 0$.

In fact, Cauchy estimates give us
$$|b_j| \leq \frac{\delta}{j\varepsilon^{j-1}}.$$
Assume $\eta < 1/5$ and $\eta$ is much smaller than $\varepsilon$. Then if $|z| < (1 - \eta)\varepsilon$,
$$|\psi'| \leq \sum_{j=2}^\infty \frac{jb_j}{|\lambda^j - \lambda|}\varepsilon^{j-1}(1 - \eta)^{j-1} < \frac{C\delta}{\mu!} \sum_{j=1}^\infty j(j+1)\cdots(j + \mu - 1)(1 - \eta)^{j-1} = \frac{C\delta}{\eta^{\mu + 1}}$$
where we used the Newton binomial formula.
Thus if $C\delta < \eta^{\mu + 2}$, which is possible if $\varepsilon$ and hence $\delta$ are small enough, if $|z| < (1 - \eta)\varepsilon$ then
$$|\hat \psi'(z)| \leq \eta.$$
Thus $\psi$ carries $D(0, \varepsilon(1 - 4\eta))\to D(0, \varepsilon(1-3\eta))$ and similarly if $|z| = \varepsilon(1 - \eta)$,
$$|\psi(z)| = |z + \hat \psi(z)| \geq \varepsilon(1 - 2\eta).$$

Assume $|w| < \varepsilon(1 - 2\eta)$ and $|z| = \varepsilon(1 - \eta)$. Then
$$|w| = |\psi(z)-(\psi(z) - w)| < |\psi(z)|.$$
By Rouche's theorem, $\psi$ and $\psi - w$ have the same number of zeroes in $D(0, \varepsilon(1 - \eta))$.
Then $\psi$ is a bijection $D(0, \varepsilon(1 - \eta)) \to D(0, \varepsilon(1 - 2\eta))$.
We thus have a diagram
$$\begin{tikzcd}
D(0, \varepsilon(1 - 4\eta)) \arrow[r,"\psi"] & D(0, \varepsilon(1-3\eta)) \arrow[r,"f"] & D(0, \varepsilon(1 - 2\eta)) \arrow[r, "\psi^{-1}"] & D(0, \varepsilon(1 - \eta)).
\end{tikzcd}$$
Let $\psi \circ g = f \circ \psi$, so $g$ carries $D(0, \varepsilon(1 - 4\eta)) \to D(0, \varepsilon(1 - \eta))$.

We now estimate $\hat g$, where $g(z) = \lambda z + \hat g(z)$. We have $\psi \circ g = f \circ \psi$. Thus
$$f(\psi(z)) = \lambda z = \hat g(z) + \hat \psi(g(z)) = \lambda(z + \hat \psi(z) + \hat f(z + \hat \psi(z))).$$
Therefore
$$\hat g(z) + \hat \psi(\lambda z + \hat g(z)) = \lambda \hat \psi(z) + \hat f(z + \hat \psi(z)).$$
Since $\hat f(z) = \hat \psi(\lambda z) - \lambda \hat \psi(z)$,
$$\hat g(z) = \hat \psi(\lambda z) - \hat \psi(\lambda z + \hat g(z)) + \hat f(z + \hat \psi(z)) - \hat f(z).$$
Let
$$C = \max_{D(0, (1 - 4\eta)\varepsilon)} |\hat g|.$$
Then
$$C \leq \sup |\hat \psi'|C + \sup |f'|\sup|\hat \psi| \leq C\eta + \delta \sup|\hat \psi|.$$

We apply Schwarz' lemma to $\hat \psi'$ to see
$$|\hat \psi'(z)| \leq c_0 \frac{\delta|z|}{\varepsilon(1-\eta)\eta^{1 + \mu}}.$$
Integrating both sides, we bound $|\hat \psi|$ and see that
$$C \leq C\eta + \frac{c_0\delta^2}{2\eta^{\mu + 1}}(1 - \eta)\varepsilon.$$
Solving for $C$,
$$\max_{D(0, (1-4\eta)\varepsilon)} |\hat g| \leq \frac{c_0\delta^2}{2}\eta^{-\mu-1}\varepsilon.$$
By a Cauchy estimate,
$$|\hat g'(z)| \leq \frac{c_0\delta^2}{2\eta^{\mu + 2}}$$
if $|z| < (1 - 5\eta)\varepsilon$.

We now iterate: let $g_0 = f$, and let $\psi_{n+1} \circ g_{n+1} = g_n \circ \psi_{n+1}$. Let $\eta_k = \alpha^k\eta_0$, $\alpha < 1$, and
$$R = \varepsilon \prod_k 1 - 5\eta_k > 0.$$
Then $|\hat g'_n| \leq \delta_n \leq \eta_k^{\mu + 2} \to 0$. So $g_n \to \lambda$ and
$$f \circ \varphi_n = \varphi_n g_n.$$
A calculation using a Cauchy estimate shows that $|\varphi_{n+1} - \varphi_n| \leq \delta_nC \to 0$, so the $\varphi_n$ are a Cauchy sequence, say $\varphi_n \to \varphi$, and $f \circ \varphi = \varphi \circ \lambda$.
\end{proof}

\chapter{Entropy and information theory}
We now consider a way to measure the complexity of a dynamical system. Though this was originally motivated by thermodynamics and statistical mechanics, it did not come to full form until work of Shannon in 1948.

\section{Shannon's axioms of entropy}
Fix a probability space $(X, \Sigma, \mu)$ and a partition $\mathcal P = (P_i)_i$ of $X$ (so $P_i \cap P_j$ is empty and $\bigcup_i P_i = X$). Let $p_i = \mu(P_i)$, so $p_i$ is the ``probability of finding a particle in $P_i$."
Entropy is supposed to measure the ``uncertainty" of the box $P_i$ that we find the particle in.

Equivalently, we seek motivation from ergodic theory. Let $(X_j, \Sigma_j, \mu_j, T_j)_j$ be a family of measure-preserving systems. Recall that $(X_1, T_1),(X_2,T_2)$ are isomorphic if there is an isomorphism of measurable spaces $\varphi: X_1 \to X_2$ such that $\varphi \circ T_1 = T_2 \circ \varphi$. (Note that $\varphi$ is not assumed to be an isomorphism of measure spaces.)
We want an invariant which allows us to distinguish two measure-preserving systems. (This is analogous to algebraic topology.)

We want a function $H$ defined on probability vectors $\vec p \in \Delta_n$, where $p_i = \mu(P_i)$ is obtained from the partition $\mathcal P$, and $\Delta_n$ is the $n$-simplex, and $H: \Delta_n \to \RR$. In this case, we let $H(\mathcal P) = H(\vec p)$.
We want $H(\vec p, 0) = H(\vec p)$ (so adding an empty set to the partition does not affect the complexity) and $k \mapsto H(1/k, \dots, 1/k)$ is increasing (so complexity increases as the partition gets finer).

If $\mathcal Q$ is also a partition, we let $\mathcal P \vee \mathcal Q$ be the set of all intersections of entries in $\mathcal P$ and in $\mathcal Q$. We will demand
$$H(\mathcal P \vee \mathcal Q) = H(\mathcal P) + H(\mathcal Q|\mathcal P)$$
where
$$H(\mathcal Q|\mathcal P) = \sum_{P \in \mathcal P} \mu(P)\mu\left(\frac{\mu(Q_1 \cap P)}{\mu(P)}, \cdots, \frac{\mu(Q_k \cap P)}{\mu(P)}\right)$$
is the ``conditional complexity" of $\mathcal Q$ given that we know $\mathcal P$.
These conditions on $H$ are known as \dfn{Shannon's axioms}.

\begin{theorem}[Shannon 1948]
Suppose $H$ satisfies Shannon's axioms; then there is a constant $K \geq 0$ such that
$$H(\vec p) = -K\sum_j p_j \log p_j.$$
\end{theorem}
Notice that this implies that $H$ is (up to a choice of Boltzmann constant, which amounts to a choice of physical units) the thermodynamic entropy, where $j$ ranges over a set of microstates, as defined by Boltzmann.
\begin{proof}
Define
$$h(n) = H(1/n, \dots, 1/n).$$
Assume $n = k\ell$, say $p_j = 1/k$, $q_i = 1/\ell$, where $\vec p,\vec q$ arise from partitions $\mathcal P,\mathcal Q$ respectively. Then
$$h(n) = h(k\ell) = H(\mathcal P \vee \mathcal Q) = H(\mathcal P) + H(\mathcal Q|\mathcal P) = h(k) + \frac{1}{k}\sum_{j=1}^k h(\ell) = h(k) + h(\ell).$$
Therefore $h$ is a multiplicative-to-additive isomorphism. The only such isomorphism defined on integers which is increasing is $\log$. In fact, we can use the monotonicity to show that for any $n$, if $k \geq \ell$,
$$\left|\frac{h(k)}{h(2)} - \frac{\log k}{\log 2}\right| < \frac{1}{n}.$$
Then if $\vec p$ is a rational point in $\Delta_n$,
one can use this to show that $H(\vec p) = c \sum_j p_j\log p_j$. Continuity extends this to all of $\Delta_n$.
\end{proof}

\begin{definition}
If $\vec p$ is the probability vector corresponding to the partition $\mathcal P$ of a fixed measure space, we define the \dfn{Shannon entropy} by
$$H(\mathcal P) = H(\vec p) = -\sum_j p_j \log p_j.$$
\end{definition}

\section{Conditional entropy}
We now give a more abstract setup for Shannon entropy. Given $\xi = \{A_j\}_j$ a partition of $(X, \Sigma, \mu)$, let $\xi(x) = A_j$ where $x \in A_j$. Then the join $\bigvee_i \xi_i$ is defined by
$$\left(\bigvee_i \xi_i\right)(x) = \bigcap_i \xi_i(x).$$
\begin{definition}
The \dfn{information function} $I(\xi)$ of $\xi$ is defined by
$$I(\xi, x) = -\log \mu(\xi(x)).$$
\end{definition}
Then entropy satisfies
$$H(\xi) = \int_X I(\xi, x) ~d\mu(x).$$
Indeed, $I(\xi, \cdot)$ is constant on any $A_j$, so it follows that
$$\int_X I(\xi, x) ~d\mu(x) = -\sum_j \mu(A_j) \log \mu(A_j).$$
\begin{definition}
Let $\mathcal A \subseteq \Sigma$ be a sub-$\sigma$-algebra. The \dfn{conditional entropy} of $\xi$ with respect to $\mathcal A$ is defined by
$$H(\xi|\mathcal A) = -\sum_j \int_X E(A_j|\mathcal A) \log(E(A_j|\mathcal A)) ~d\mu.$$
\end{definition}
Here
$$E(A|\mathcal A) = E(1_A|\mathcal A)$$
is the conditional expectation. If $\mathcal A$ is generated by a partition $\eta$,
$$E(f|\mathcal A)(x) = \frac{1}{\mu(\eta(x))} \int_{\eta(x)} f ~d\mu,$$
and we write $E(f|\eta) = E(f|\mathcal A)$. In particular,
$$E(A|\eta)(x) = \frac{\mu(A \cap \eta(x))}{\mu(\eta(x))}.$$
Unravelling the definitions, $H(\xi|\eta)$ agrees with the previous definition for conditional entropy that we gave.

We think of $H(\xi|\eta)$ as the entropy given that we know everything about $\eta$. In particular, $H(\xi|\Sigma) = 0$ (where $\Sigma$ is the $\sigma$-algebra). To see this, note that $E(f|\Sigma)$ is constant for any $f$, so $E(A|\mathcal A) \in \{0, 1\}$ and hence $E(A|\mathcal A)\log E(A|\mathcal A) = 0$.
On the other hand, $H(\xi) = H(\xi|\{0, X\})$.
More generally if $\mathcal A \subseteq \mathcal B$ then
$$H(\xi) \geq H(\xi|\mathcal A) \geq H(\xi|\mathcal B) \geq 0.$$
If $T$ is measure-preserving then
$$H(\xi|\mathcal A) = H(T^{-1}\xi|T^{-1}\mathcal A).$$
In particular $H(\xi) = H(^{-1}\xi)$.
We also have $H(\xi \vee \eta) \leq H(\xi) + H(\eta)$.

\section{The entropy of a group action}
Let $(X, \Sigma, \mu, T)$ be a measure-preserving system.
\begin{lemma}
For any partition $\xi$, the limit
$$\lim_{N \to \infty} \frac{1}{N} H\left(\bigvee_{j=0}^{N-1} T^{-j}\xi\right) = \inf_N H\left(\bigvee_{j=0}^{N-1} T^{-j}\xi\right) > -\infty.
$$
\end{lemma}
\begin{proof}
Let
$$a_N = H\left(\bigvee_{j=0}^{N-1} T^{-j}\xi\right).$$
Since $H(\xi \vee \eta) \leq H(\xi) + H(\eta)$, we have
$$0 \leq a_{N+M} \leq a_N + a_M,$$
Therefore
$$\lim_{N \to \infty} \frac{a_N}{N} = \inf_{N \to \infty} \frac{a_N}{N} > -\infty.$$
\end{proof}

\begin{definition}
Let
$$h(T, \xi, \mu) = \lim_{N \to \infty} \frac{1}{N}H\left(\bigvee_{j=0}^{N-1} T^{-j}\xi\right).$$
Then we may define the \dfn{entropy} of the transformation $T$ by
$$h(T, \mu) = \sup_\xi h(T, \xi, \mu),$$
$\xi$ ranging over all finite partitions of $(X, \Sigma, \mu)$ into measurable sets.
\end{definition}
We have $h(T, \eta) \leq h(T, \xi) + H(\eta|\xi)$. Moreover,
$$h(T, \xi) = \lim_{N \to \infty} H(\xi|\bigvee_{i\leq N} T^{-i}\xi).$$
Trivially, the $\sigma$-algebra generated by $T^{-1}\bigvee_{j\leq k-1}T^{-j}\xi$ is contained in the $\sigma$-algebra generated by $T^{-1}\bigvee_{j\leq k} T^{-j}\xi$, so if we let
$$b_k = H(\xi|T^{-1}\bigvee_{j \leq k}T^{-j}\xi)$$
then the $b_k$ form a decreasing sequence, and is bounded from below, so say $b_k \to b$. In particular, $b_k$ converges in Cesaro mean to $b$, so
$$\lim_{N \to \infty} H(\bigvee_{j \leq k} T^{-j}\xi) = \lim_{N \to \infty} H(\xi|T^{-1}\bigvee_{j \leq k}T^{-j}\xi).$$

\begin{example}
Take the partition $\xi$, $A_0 = \{x: x > 0\}$, $A_1 = \{x: x \leq 0\}$ of the circle $S^1 = \{(x, y): x^2 + y^2 = 1\}$. Let $T$ be the irrational rotation, so at each stae $\bigvee_{j\leq k} T^{-j}\xi$ has $2$ more sets than the previous stage. Thus
$$H\bigvee_{j=0}^{N-1} T^{-j}\xi \leq \log 2N$$
and dividing both sides by $N$ and taking $N \to \infty$ we see that
$$h(T, \xi) = 0.$$

On the other hand, for any transformation, $h(T^q) = qh(T)$, so if $T$ is a rational rotation of denominator $q$, $T^q = 1$ and $h(1) = 0$. Therefore $h(T) = 0$. More generally, this implies that any periodic transformation has $0$ entropy.
\end{example}

The definition of $h(T)$ is slightly useless because one cannot easily take a supremum over partitions. However, Sinai, a student of Kolmogorov, found a less useless equivalent definition.
\begin{definition}
Let $(X, \Sigma, \mu, T)$ be a measure-preserving system. A partition $\xi$ is said to be a \dfn{one-sided generator} of $\Sigma$ if $\Sigma$ is the $\sigma$-algebra generated by
$$\{A: \exists j(A \in T^{-j}\xi)\}$$
modulo $\mu$-null sets.
\end{definition}

\begin{theorem}[Sinai-Kolmogorov theorem]
\index{Sinai-Kolmogorov theorem}
If $(X, \Sigma, \mu, T)$ is a measure-preserving system and $\xi$ is a one-sided generator of $\Sigma$, then $h(T, \xi) = h(T)$.
\end{theorem}

\begin{example}
For $(S^1, \Sigma, \mu, T)$ an irrational rotation and $\xi$ the above partition, $\xi$ is a one-sided generator, so $h(T, \xi) = 0$.
\end{example}

\begin{theorem}[martingale convergence theorem]
\index{martingale convergence theorem}
Let $\{\xi_n\}$ be a sequence of $\sigma$-algebra such that $\xi_{n+1}(x) \subseteq \xi_n(x)$.
Let $\mathcal A$ the $\sigma$-algebra generated by $\bigcup_n \xi_n$. Then for any event $A$,
$$\lim_{n \to \infty} E(A|\xi_n) = E(A|\mathcal A)$$
in $L^2$.
\end{theorem}
We take this as a black box.

\begin{proof}[Proof of Sinai-Kolmogorov theorem]
By the martingale convergence theorem,
$$h(T, \xi) = \lim_{n \to \infty} H(T, \xi_n)$$
if $\xi_n$ refine to $\xi$.
In fact, if $\xi$ is a one-sided generator and we put
$$\xi_n = \bigvee_{j=1}^n T^{-j}\xi,$$
this means
$$h(T, \xi) = H(\xi|T^{-1}\Sigma).$$

Now take
$$\xi_n = \bigvee_{j=0}^n T^{-j}\xi,$$
which actually generates all of $\Sigma$.
Thus for any partition $\eta$,
$$\lim_{n \to \infty} H(\eta|\xi_n) = H(\eta|\Sigma) = 0.$$
Also
$$h(T, \eta) \leq h(T, \xi_n) + H(\eta|\xi_n)$$
so taking the limit,
$$h(T, \eta) \leq h(T, \xi)$$
and taking the supremum of both sides over $\eta$ we get the claim.
\end{proof}

\begin{corollary}
Suppose that we are in the situation of the Sinai-Kolmogorov theorem but
$$\bigvee_{j=-n}^n T^j\xi$$
generates $\Sigma$, instead of $\bigvee_{j=0}^n T^{-j}\xi$. Then $h(T, \xi) = h(T)$.
\end{corollary}
\begin{proof}
The proof is the same.
\end{proof}

\begin{example}
Kolmogorov formulated the definition of entropy to try to understand a question of von Neumann: which asked if there was a measure-theoretic sense in which rolling a die is more complex than flipping a coin. In fact their entropies are not the same, and so as measure-preserving systems they are not isomorphic.

To see this, take the one-sided Bernoulli shift $T$ on $k$ letters with probability vector $\vec p$. Let $C_\sigma$ be the cylinder set of Cantor space $k^\omega$ generated by the string $\sigma$.
Let $\xi$ be the partition generated by all $C_\sigma$s where $\sigma$ has length $1$.

Then
$$h(T) = h(T, \xi) = \lim_{n \to \infty} \frac{1}{n}H(T^{-n+1}\xi) = \lim_{n\to\infty} \frac{1}{-n}\sum_{|\sigma| = n} p_{\sigma_0}\cdots p_{\sigma_n}\log p_{\sigma_0}\cdots p_{\sigma_n}.$$
Thus
$$h(T) = -\lim_{n \to \infty}\frac{1}{n}\sum_{j=1}^n p_{\sigma_j} \log p_{\sigma_j}.$$

Thus if we have uniform probability vectors $(1/n,\dots, 1/n)$ of length $n$ then $h(T) = \log n$.
\end{example}

\begin{example}
The entropy of the cat with eigenvalue $\lambda$ is $\log \lambda$. This is a tedious computation that we omit.
\end{example}

\begin{example}
Let $E_m(x) = x\mod 1$ be the circle multiplication map with winding number $m \in (0, 1)$.
Let
$$\xi = \{(\ell/m, \ell+1/m): \ell\}$$
be a partition, then
$$T^{-j}\xi = \{(\ell/m^{j+1}, \ell+1/m^{j+1}): \ell\}$$
which clearly generates the Borel $\sigma$-algebra $\Sigma$ as $n \to \infty$. Then
$$h(T) = h(T, \xi) = \lim_{n \to \infty} \frac{1}{n}H(T^{-n+1}\xi) = \lim_{n \to \infty} \frac{1}{n} \sum_{\ell=0}^{m^n - 1} \frac{1}{m^n} = \log m.$$
\end{example}

\section{Topological entropy}
We now relate the entropy defined above (which we now call \dfn{metric entropy}) to \dfn{topological entropy} defined in the sense of metric spaces (confusingly enough.)

Fix a compact metrizable space $X$ and a continuous transformation $T: X \to X$.
Any compact, second-countable Hausdorff space will do, by the Urysohn metrization theorem.

\begin{definition}
Given an open cover $\mathcal U$ of $X$, we define the \dfn{covering entropy}
$$H(\mathcal U) = \log \min_\mathcal V \card \mathcal V$$
where $\mathcal V$ ranges over all finite subcovers of $\mathcal U$.
\end{definition}

So an extremely complicated cover with lots of barely overlapping parts has very high entropy.

\begin{definition}
The \dfn{topological entropy} of $(X, T)$ is
$$h_{top}(T, \mathcal U) = \lim_{n \to \infty} \frac{1}{n} H(\bigvee_{j=0}^{n-1} T^{-j}\mathcal U).$$
We define
$$h_{top}(T) = \sup_{\mathcal U} h_{top}(T, \mathcal U).$$
\end{definition}

The entropy $h_{top}(T)$ is supposed to measure the exponential growth of the orbits of $T$. In fact we can give counting laws for the number of periodic points in terms of $h_{top}$. But we will not do that today.

Henceforth let $\mathcal M(T)$ be the space of $T$-invariant Borel probability measures on $X$.
We proved previously the Krylov-Bogolibabov theorem, which guarantees that $\mathcal M(T)$ is nonempty, convex, and compact, and its extreme points are the ergodic measures of $T$.
\begin{theorem}
We have
$$h_{top}(T) = \max_{\mu \in \mathcal M(T)} h(\mu).$$
\end{theorem}
Here the maximum is achieved because $\mathcal M(T)$ is compact.

\begin{example}
The Cantor space $m^\omega$ is metrizable as witnessed by
$$d(x, y) = \theta^{\min_{x_i \neq y_i} i}$$
where $\theta \in (0, 1)$ is fixed. This is actually an ultrametric; i.e. all triangles are isoceles.

The topological entropy of any shift is
$$h_{top}(T) = \log m,$$
and this is attained by the cover by open cylinders; any other cover would add inefficiency.
We were interested in Bernoulli probability measures on $m^\omega$ and they had metric entropy $\log m$ if the probability was distributed correctly.
So topological and metric entropies agree here.
\end{example}

\begin{proof}[Proof that $h \leq h_{top}$]
Given a Borel partition $\xi$ and a Borel measure $\mu$ we will find a cover $\mathcal U$ such that
$$h_\mu(T, \xi) \leq h_{top}(T, \mathcal U) + 1 + \log 2$$
and hence
$$h_\mu(T^k, \xi) \leq h_{top}(T^k, \mathcal U) + 1 + \log 2$$
which implies
$$h_\mu(T, \xi) \leq h_{top}(T, \mathcal U) + \frac{1 + \log 2}{k}$$
and taking the limit as $k \to \infty$ the claim follows.

Let $\xi = \{A_1, \dots, A_k\}$ be a Borel partition. Since $\mu$ is Borel, there are $C_j$ so that $\mu(A_j \setminus C_j) < 1/k$.
This gives a new partition
$$\eta = \{C_1, \dots, C_k, X \setminus_{j=1}^k C_j$$
by closed sets, plus an open set, such that
$$h_\mu(T, \xi) \leq h_\mu(T, \eta) + 1$$
Let
$$U_j = X \setminus \bigcup_{i\neq j} C_i;$$
then the $U_j$ form an open cover $\mathcal U$ of $X$.

Since $\xi$ was a partition, for any $U_j$ there is an $x \in U_j$ such that $x \notin U_i$ if $i \neq j$.
In particular, $\mathcal U$ is a \dfn{coarse cover} in the sense that it has no proper subcover, and
$$H(\mathcal U) = \log \card \mathcal U = \log k.$$
Moreover,
$$\card \bigvee_{j=0}^{n-1} T^{-j}\eta \leq 2^n \card \bigvee_{j=0}^{n-1} T^{-j}\mathcal U.$$
Here we are using the inequality
$$(k+1)^n \leq 2^n k^n,$$
the fact that $\card \eta = k + 1$, that $\mathcal U$ is coarse, and that $\card \mathcal U = k$.

Thus
$$H(\bigvee_{j=0}^{n-1} T^{-j}\eta) \leq \exp H(\bigvee_{j=0}^{n-1} T^{-j}\mathcal U) + \log 2,$$
so
$$h_\mu(T, \xi) \leq h_\mu(T, \eta) + 1 \leq h_{top}(\mathcal U) + 1 + \log 2.$$
\end{proof}

For the converse, we need to use the metric properties of $X$.
\begin{definition}
The \dfn{Bowen distance} of $T$ is given by
$$d_n(x, y) = \max_j d(T^j(x), T^j(y)).$$
The \dfn{Bowen ball} is defined by
$$B(x, \varepsilon, n) = \{y \in X: d_n(x, y) < \varepsilon\}.$$
\end{definition}
If $d_n(x, y) < \varepsilon$, then until time $n$, the orbits of $x$ and $y$ must remain within $\varepsilon$ of each other.
For hyperbolic systems with positive Lyapunov exponent, this requires that either $n$ be very small, or $d(x, y)$ be very small.

\begin{definition}
We say that $A \subseteq X$ is $(n, \varepsilon)$-\dfn{spanning} if
$$\bigcup_{a \in A} B(a, \varepsilon, n) = X.$$
The \dfn{spanning number} of $(n, \varepsilon)$ is
$$\text{Span}(n, \varepsilon) = \min_A \card A$$
where $A$ ranges over $(n, \varepsilon)$-spanning sets.
\end{definition}
Such sets must exist since $X$ is compact.

\begin{definition}
The \dfn{separating number} of $(n, \varepsilon)$ is
$$\text{Sep}(n, \varepsilon) = \max_B \card B$$
where $B$ ranges over sets such that whenever $x, y\in B$ either $x = y$ or $d_n(x, y) \geq \varepsilon$.
The \dfn{covering number} of $(n, \varepsilon)$ is
$$\text{Cov}(n, \varepsilon) = \min_{\mathcal U} \card \mathcal U$$
where $\mathcal U$ is an open cover by sets whose Bowen $n$-diameter is at most $\varepsilon$.
\end{definition}

Then
$$\text{Cov}(n, 2\varepsilon) \leq \text{Span}(n, \varepsilon) \leq \text{Sep}(n, \varepsilon) \leq \text{Cov}(n, \varepsilon).$$

\begin{definition}
The \dfn{Bowen entropy} is defined by
$$H_\varepsilon(T) =\lim_{n \to \infty}\frac{\log \text{Cov}(n, \varepsilon)}{n}.$$
\end{definition}

\begin{lemma}
We have
$$h_{top}(T) = \sup_{\varepsilon > 0} H_\varepsilon(T).$$
\end{lemma}
\begin{proof}
Fix $\mathcal U$. Let $\delta$ be the Lebesgue number of $\mathcal U$. Then
$$\exp H(\bigvee_{j=0}^{n-1} T^{-j}\mathcal U) \leq \text{Span}(n, \delta/2)$$
so
$$h_{top}(T) \geq \sup_{\varepsilon > 0} H_\varepsilon(T).$$

Conversely, if the diameter of every set in $\mathcal U$ is $<\varepsilon$ then
$$\text{Sep}(n, \varepsilon) \leq \exp H(\bigvee_{j=0}^{n-1} T^{-j}\mathcal U)$$
which proves the converse.
\end{proof}

\begin{proof}[Proof that $h_\top \leq \sup_\mu h_\mu$]
For every $n$ choose $E_n \subset X$ to be $(n,\varepsilon)$-separated and maximal. Let $\nu_n$ be the uniform probability measure on $E_n$, which extends to an atomic measure on $X$ (just put delta functions at each point in $E_n$).

Let
$$\mu_n = \frac{1}{n}\sum_{j=0}^{n-1} T^j_*\nu_n$$
where $S_*$ denotes pushforward by $S$.
Here the set $F_n = \bigcup_{j=0}^{n-1}T^j E_n$ is $(0,\varepsilon)$-separated and $\mu_n$ is a uniform measure on $F_n$.

Then
$$H_\varepsilon(T) = \limsup_{n \to \infty} \frac{\log \card E_n}{n},$$
and we pass to a subsequence where this sequence converges. We then pass to a subsequence again, using compactness of $\mathcal M(T)$, to find a limit point $\mu$ of the $\mu_n$.

We then construct a Borel partition $\xi = \{A_0, \dots, A_{k-1}\}$ of $X$ such that $\mu(A_j) < \varepsilon$ and $\mu(\partial A_j) = 0$.
Then
$$\lim_{n \to \infty} H(\mu_n, \bigvee_{j=0}^{n-1}T^{-j}\xi) = H(\mu, \bigvee_{j=0}^{n-1} T^{-j}\xi),$$
as a computation will check, and so
$$\lim_{n\to\infty} \frac{1}{n} \log \card E_n = \lim_{n \to \infty} \frac{1}{n} H(\nu_n, \bigvee_{j=0}^{n-1}T^{-j}\xi) \leq \frac{1}{q} H(\mu, \bigvee_{j=0}^{q-1} T^{-j}\xi)$$
and we now take $q \to \infty$.
\end{proof}



\part{Operator algebras}
\chapter{Banach algebras}
\begin{definition}
A \dfn{Banach algebra} is a Banach space equipped with a bilinear, associative multiplication such that
$$||xy|| \leq ||x|| ||y||.$$
If $*$ is a linear involution on $\mathcal A$ such that $(xy)^* = y^*x^*$ and $1^*= 1$ if $\mathcal A$ is unital. then we say that $\mathcal A$ is a \emph{$*$-algebra}.
\end{definition}

\begin{definition}
\index{$C^*$-algebra}
Let $\mathcal A$ be a $*$-algebra. If one has the \emph{$C^*$-identity}
$$||x^*x|| = ||x||^2,$$
then we say that $\mathcal A$ is a \emph{$C^*$-algebra}.
\end{definition}

For example, if $\mathcal H$ is a Hilbert space, then $\mathcal B(\mathcal H)$ is a $C^*$-algebra. Later we will learn that sub-$*$-algebras of $\mathcal B(\mathcal H)$ are the only examples of $C^*$-algebras.

Often the norm topology is too strong, so we introduce a new topology which is weaker on $\BB(\HH)$.
\begin{definition}
    The \dfn{strong operator topology} is the locally convex topology on $\BB(\HH)$ defined by the seminorms
    $$P_\xi(T) = ||T\xi||.$$
\end{definition}
In other words, a sequence converges in the strong operator topology $T_n \to T$ iff for each $\xi \in \HH$, $||(T_n - T)\xi|| \to 0$. So the strong operator topology is the topology of pointwise convergence.
\begin{definition}
    A \dfn{von Neumann algebra} $\mathcal A$ is a sub-$*$-algebra of $\BB(\HH)$ which is closed in the strong operator topology.
\end{definition}


\section{The spectrum}
Fix a Banach algebra $A$.
\begin{definition}
    Let $a \in A$. The \dfn{spectrum} $\sigma(a)$ is the set of $z \in \CC$ such that $\sigma(a) - z$ is not invertible. The \dfn{resolvent} $\rho(a)$ is the complement of $\sigma(a)$.
\end{definition}

\begin{lemma}
    Let $a \in A$. If $||a|| < 1$ then $1 - a$ is invertible with inverse
    $$(1 - a)^{-1} = \sum_{n=0}^\infty a^n.$$
\end{lemma}
\begin{proof}
    The partial sums converge since $||a|| < 1$. Therefore
    $$(1 - a) \sum_{n=0}^\infty a^n = (1 - a) \lim_{n \to \infty} \sum_{k=0}^n a^k = \lim_{n \to \infty} \sum_{k=0}^n a^k - a^{k-1} = 1$$
    since the summands telescope.
\end{proof}
In particular, if $||1 - a|| < 1$ then $a$ is invertible.
\begin{definition}
    The \dfn{general linear group} of $A$ is $\GL(A)$, the group of invertible elements of $A$.
\end{definition}
By the above lemma, there is a ball $B$ around $1$ contained in $\GL(A)$. By continuity of translation, we can carry $B$ to be centered at any point of $\GL(A)$. Therefore $\GL(A)$ is an open set.

\begin{proposition}
    The function $z \mapsto (z - a)^{-1}$ is holomorphic on $\rho(a) \cup \infty$.
\end{proposition}
    In this case, holomorphy is indicated by local existence of a convergent power series.
\begin{proof}
    We have
    $$(a - z)^{-1} = \sum_{n=0}^\infty (a - z_0)^{-n-1}(z-z_0)^n$$
    for each $z_0 \in \rho(a)$ and $z$ close enough to $z_0$ that the power series converges. To see that the function is still holomorphic at $\infty$, notice that
    $$(a - z^{-1})^{-1} = z(1 - az)^{-1}$$
    which vanishes as $z \to 0$. Replacing $z$ by $z^{-1}$, we see that the function is bounded close to infinity, and continuous, so holomorphic there.
\end{proof}

We now observe that the usual proofs of Cauchy's integral formula and its friends such as Cauchy's estimate and Liouville's theorem go through even in case of holomorphic functions $U \to A$, $U \subseteq \CC$ open.

We now come to the famous Gelfand-Mazur theorem, which can be thought of as a ``restatement of the fundamental theorem of algebra" for our purposes. For the notation, recall that the map $z \mapsto z1$ is an embedding of $\CC$ in any Banach algebra.
\begin{theorem}[Gelfand-Mazur]
    \index{Gelfand-Mazur theorem}
    If $A = \GL(A) \cup 0$, then $A = \CC$.
\end{theorem}
\begin{proof}
    Let $a \in \GL(A)$ and assume towards contradiction that $a \notin \CC$. Then the resolvent $z \mapsto (a - z)^{-1}$ is a holomorphic function defined on the Riemann sphere, so constant. Taking $z = \infty$, the resolvent is identically $0$, but also identically $a^{-1}$ (taking $z = 0$). This is a contradiction.
\end{proof}
Notice that this fails over $\RR$, as witnessed by $\CC$ as well as the quaternions $\mathbb H$. This is why we study Banach algebras over $\CC$.

\section{Ideals}
Let $I$ be an ideal of $A$. It is immediate that the norm-closure $\overline I$ is an ideal. Moreover, since $\GL(A) \ni 1$ is open, if $I$ is a proper ideal, then $I$ does not meet $\GL(A)$ and so $\overline I$ does not contain $1$, so $\overline \cdot$ preserves propriety. Therefore maximal ideals are closed. Moreover, for continuous morphisms, kernels are closed, so we might as well only study closed ideals.

If $I$ is a (left, right) ideal then $A/I$ is a (left, right) module over $A$, equipped with the seminorm
$$||a|| = \inf_{d \in I} ||a - d||.$$
In case $I$ is closed, this seminorm is actually a norm, and complete since $A$ is complete. So we end up with a Banach space.

\begin{definition}
    A \dfn{Banach module} over $A$ is an $A$-module $M$ which is a Banach space, such that
    $$||am||_M \leq ||a||_A ||m||_M.$$
\end{definition}
It is not very hard to check that $M = A/I$ is a Banach module. In fact, for $b, c \in I$, we have
$$||am||_M \leq ||(a - c)(m - d)||_A \leq ||a - c||_A ||m - d||_A.$$
Taking the $\inf$ over $c, d$ of both sides, we have
$$||am||_M \leq ||a||_A ||m||_M.$$
In case $I$ is two-sided, $M$ is a Banach $(A, A)$-bimodule, or in other words, a Banach algebra.

In what follows we use $\Hom(A, B)$ to mean the $K$-algebra of morphisms of $K$-algebras $A \to B$ over some field $K$ (which is usually $\CC$).

If $I$ is a maximal ideal, therefore, $A/I$ is a field, and so $A/I = \CC$ by the Gelfand-Mazur theorem. But a maximal ideal gives a epimorphism $A \to \CC$, and conversely, the kernel of a such an epimorphism is a maximal ideal. This gives a bijection between the maximal spectrum of $A$ and $\Hom(A, \CC) \setminus 0$, which we call $\hat A$.

\begin{lemma}
    Let $K$ be a field and $A$ a unital $K$-algebra. Let $\varphi \in \Hom(A, K)$. Then if $a \in A$, $\varphi(a) \in \sigma(a)$.
\end{lemma}
\begin{proof}
    We have $\varphi(a - \varphi(a)) = 0$.
\end{proof}
\begin{lemma}
    If $\varphi: A \to \CC$ is a nonzero morphism, then $||\varphi|| \leq 1$.
\end{lemma}
\begin{proof}
    $\varphi(a) \in \sigma(a)$ so $||\varphi(a)|| \leq ||a||$.
\end{proof}

Therefore $\hat A$ is contained in the unit ball $A'_1$ of the dual $A'$. Since nets in $\hat A$ act continuously on $A$, their pointwise convergence preserves operations of $A$. So $\hat A$ is closed. In particular, the Banach-Alaoglu theorem implies that $\hat A$ is a weakstar compact Hausdorff space.

\begin{definition}
    Let $a \in A$. The \dfn{Gelfand transform} $\hat a$ is the function
    $$\hat a(\varphi) = \varphi(a),$$
    for $\varphi \in \hat A$.
\end{definition}
Notice that $||\hat a||_{L^\infty(\hat A)} \leq ||a||_A$ and $\hat a(\hat A) \subseteq \sigma_A(a)$. Conversely, let $\lambda \in \sigma_A(a)$. Then $a - \lambda$ is not invertible, so there is a maximal ideal $I \supseteq (a - \lambda)$ and an epimorphism $\varphi$ such that $\ker \varphi = I$. Thus $\lambda \in \hat a(\hat A)$. Therefore $\hat A = \sigma_A(a)$, but the proof of this is highly nonconstructive.

\begin{example}
    Recall that $c_0(\NN)$, the set of $x \in \ell^\infty(\NN)$ such that $x_n \to 0$ as $n \to \infty$, is a closed ideal of $A = \ell^\infty(\NN)$. Therefore there is a $\varphi$ such that $\varphi(c_0(\NN)) = 0$. But, in fact, $\hat A = \beta\NN$, where $\beta$ is the Stone-Cech functor. It follows that it is consistent with ZF without the axiom of choice that $\varphi$ does not exist.
\end{example}

\begin{definition}
    Let $a \in A$. The \dfn{spectral radius} of $a$ is
    $$r(a) = \max_{\lambda \in \sigma(a)} |\lambda|.$$
\end{definition}
Equivalently, $r(a) = ||\hat a||_{L^\infty(\hat A)}$. Therefore we have $r(ab) \leq r(a)r(b)$.

\section{The holomorphic functional calculus}
    As usual, let $A$ be a commutative Banach algebra.
\begin{definition}
    Let $a \in A$ and let $f$ be a holomorphic function on $D(0, ||a|| + \varepsilon)$. Put
    $$f(z) = \sum_{n=0}^\infty \alpha_n z^n.$$
    The \dfn{holomorphic functional calculus} is the morphism $f \mapsto f(a)$ defined by
    $$f(a) = \sum_{n=0}^\infty \alpha_n a^n.$$
\end{definition}
    The Taylor series of $f$ converges uniformly absolutely on $D(0, ||a||)$, so the partial sums of $f(a)$ form a Cauchy sequence in $A$. Therefore $f(a)$ is a well-defined element of $A$, and we can think of $f$ as a mapping $U \to A$, where $U$ consists of elements of $A$ that are small enough. If $f$ is entire, then $f$ lifts to a function $A \to A$.
\begin{theorem}[spectral mapping theorem]
    \index{spectral mapping theorem}
    If $\lambda \in \sigma(a)$ then $f(\lambda) \in \sigma(f(a))$.
\end{theorem}
\begin{proof}
    We have
    \begin{align*}
        f(a) - f(\lambda) &= \sum_{n=0}^\infty \alpha_n(a^n - \lambda^n)
            = \sum_{n=0}^\infty \alpha_n(a - \lambda)(a^{n-1} + a^{n-2}\lambda + \dots + \lambda^{n-1})\\
            &= (a - \lambda)b
    \end{align*}
    for some $b$, if we can show that the partial sums are a Cauchy sequence. In fact
    $$||a^{n-1} + \dots + \lambda^{n-1}|| \leq n||a||^{n-1}$$
    which is the right-hand side of $f'(||a||)$ (which clearly converges, so partial sums are Cauchy). Therefore $f(a) - f(\lambda) = (a-\lambda)b$. So if $f(a) - f(\lambda)$ is invertible, then so is $a - \lambda$.
\end{proof}





\chapter{$C^*$-algebras}
\section{Weights}
\begin{definition}
\index{weight}
Let $\mathcal A$ be a sub-$*$-algebra of $\mathcal B(\mathcal H)$. A map $\omega: \mathcal A^+ \to [0, \infty]$ is a \emph{weight} if $\omega$ is additive and if $\omega(ta) = t\omega(a)$ whenever $t \geq 0$.
\end{definition}

Fix a weight $\omega$. By $m_\omega$ we mean the span of the set of positive $a$ such that $\omega(a) < \infty$, and by $m_\omega^{sa}$ we mean the closure of the set of positive $a$ such that $\omega(a) < \infty$ under subtraction. Clearly $\omega$ extends uniquely to $m_\omega^{sa}$ by $\omega(b-c) = \omega(b) - \omega(c)$. So $\omega$ extends to a positive linear functional on $m_\omega$ in the obvious way. On the other hand, if $\varphi$ is any positive linear functional on $\mathcal B(\mathcal H)$, then $\varphi$ is a weight such that $m_\varphi = \mathcal B(\mathcal H)$.

Now we define $n_\omega$ to be the set of $a \in \mathcal A$ such that $\omega(a^*a) < \infty$, which is clearly a subspace of $\mathcal A$.
\begin{lemma}
    $n_\omega$ is a left ideal of $\mathcal A$.
\begin{proof}
    If $T \geq 0$ then
    \begin{align*}
        \langle S^*TS\xi, \xi\rangle
            &= \langle TS\xi, S\xi\rangle
            \leq ||T|| ||S\xi||^2\\
            &= ||T|| \langle S\xi, S\xi\rangle
            = ||T|| \langle S^*S\xi, \xi\rangle.
    \end{align*}
    So if $d \in \mathcal A$ and $a \in n_\omega$ then
    \begin{align*}
        (da)^*da = a^*d^*da \leq ||d^*d|| a^*a = ||d||^2 a^*a
    \end{align*}
    whence
    $$||\omega((da)^*(da)) \leq ||d||^2 \omega(a^*a) < \infty.$$
\end{proof}
\end{lemma}
\begin{definition}
\index{tracial weight}
If $\omega(a^*a) = \omega(aa^*)$ then $\omega$ is \emph{tracial}.
\end{definition}
Clearly if $\omega$ is tracial then $n_\omega$ is a two-sided ideal. For example, if $\omega$ is actually the trace,
$$\omega(x) = \sum_j \langle x^*xe_j, e_j\rangle$$
for $\{e_j\}_j$ an orthonormal basis of the separable Hilbert space $\mathcal H$, then $\omega$ is tracial and $n_\omega$ is just the space of trace-class operators and $\omega$ is tracial.

\index{polarization identity}
Recall the polarization identity:
$$4b^*a = \sum_{k=0}^3 i^k(a+i^kb)^*(a+i^kb).$$
From this we are justified in defining, on $n_\omega$,
$$\langle a, b\rangle_\omega = \omega(b^*a).$$
This would be an inner product if $N_\omega = \{a \in \mathcal A: \omega(a^*a) = 0\}$ were trivial. Clearly $N_\omega$ is a subspace, so we can take the completion of $n_\omega/N_\omega$ and recover a Hilbert space.

\section{The GNS construction}
\begin{definition}
    The completion of $n_\omega/N_\omega$ is denoted $L^2(\mathcal A, \omega)$.
\end{definition}
If $b \in n_\omega$, then
$$\langle ab, ab\rangle_\omega
    = \omega(b^*a^*ab)
    \leq ||a^*a|| \omega(b^*b) = ||a||^2 ||b||_\omega^2.$$
So if $a \in \mathcal A$ then $\xi \mapsto a\xi$ is a well-defined, bounded operator on $n_\omega/N_\omega$ and so extends to $L^2(\omega)$.

\begin{definition}
    \index{$*$-representation}
    A \emph{$*$-representation} is a morphism of $*$-algebras (i.e. a morphism of algebras preserving $*$) into $\BB(\HH)$.
\end{definition}
If $a \in \AAA$, $b,c \in n_\omega$, then
$$\langle ab, c\rangle_\omega = \omega(c^*ab) = \omega((a^*c)^*b) = \langle b, a^*c\rangle_\omega,$$
which descends to $L^2(\omega)$. So we can define a $*$-representation
\begin{align*}
    L: \AAA &\to \BB(L^2(\omega))\\
        a &\mapsto (\xi \mapsto a\xi).
\end{align*}
\begin{definition}
    \index{GNS construction}
    \index{left regular representation}
    The map $L$ is called the \emph{GNS construction} (for Gelfand-Neimark-Segal) of $\AAA$, or the \emph{left regular representation} of $\AAA$.
\end{definition}
The GNS construction allows us to assume that $\AAA$ is actually acting on a Hilbert space, namely $L^2(\omega)$. So a $C^*$-algebra is always an operator algebra.

We can also define a right regular representation\index{right regular representation},
\begin{align*}
    R: \AAA &\to \BB(L^2(\omega))\\
        a &\mapsto (\xi \mapsto \xi a).
\end{align*}
Notice that $R$ is an antihomomorphism.

\begin{lemma}
    Assume that for each positive $a \in \AAA$, $\sqrt a$ exists. Then $m_\omega \subseteq n_\omega$, and in particular $m_\omega$ is a sub-$*$-algebra of $\AAA$.
    \end{lemma}
\begin{proof}
If $a \in m_\omega$ is positive,
    $$\omega(\sqrt a^2) = \omega(\sqrt a^* \sqrt a) = \omega(a)$$
so $\sqrt a \in n_\omega$. Since $n_\omega$ is a left ideal, $a \in n_\omega$.
\end{proof}


\begin{example}
    Let $X$ be a measure space and $K \in L^2(X \times X)$. Then the integral operator $T_K: L^2(X) \to L^2(X)$ has $||T_K||_{\BB^2} = ||K||_{L^2}$. Indeed, if $\{\xi_n\}_n$ is a Hilbert basis for $L^2(X)$ then
\begin{align*}
    \sum_n ||T_k\xi_n||^2
        &= \sum_{m,n} |\langle T_k\xi_m, \xi_n\rangle|^2
        = \sum_{m,n} \left|\iint_{X \times X} K(x, y) \xi_n(y) \xi_m(x) ~dx ~dy\right|^2\\
        &= \sum_{m,n} |\langle K, \xi_m \otimes \xi_n\rangle|^2
        = ||K||_{L^2}
\end{align*}
    since the $\xi_m \otimes \xi_n$ form a Hilbert basis for $L^2(X \times X) = L^2(X) \otimes L^2(X)$.
\end{example}
\begin{example}
    If $\AAA = C([0, 1])$ and
    $$\omega(f) = \int_0^1 f(t) ~dt$$
    then $\omega$ is a tracial weight on $\AAA$ such that $n_\omega = \AAA$. But of course $n_\omega$ is a Banach space when given the $\BB^2 = L^2$ norm. Its completion is $L^2([0, 1])$.
\end{example}
\begin{proposition}
    Let $\omega$ be a tracial weight and $\AAA$ be a sub-$*$-algebra of $\BB_0(\HH)$. If $b \geq 0$ and $b \in m_\omega$, and $a \in \BB(\HH)$ then
    $$|\omega(ab)| \leq ||a||_{op}|\omega(b)|.$$
\end{proposition}
\begin{proof}
    We have
\begin{align*}
    |\omega(ab)|^2
        &= |\omega(a \sqrt b \sqrt b)|^2
        = |\omega(\sqrt b a \sqrt b)|^2
        = |\langle a \sqrt b, \sqrt b\rangle|^2\\
        &\leq \langle a\sqrt b, a\sqrt b\rangle \langle \sqrt b, \sqrt b\rangle
        = \omega(\sqrt b a^* a\sqrt b)\omega(b)
        \leq ||a||^2 \omega(b)^2.
\end{align*}
\end{proof}

We summarize the GNS construction, and the Gelfand transform, in the following theorem. We define $C_\infty(X)$ to be a subspace of the space of continuous functions $C(X)$. If $X$ is compact we define $C_\infty(X) = C(X)$. Otherwise, we let $C_\infty(X)$ be those functions in $C(X)$ which vanish at the point at infinity given by the one-point compactification of $X$. For example, $C_\infty(\RR)$ consists of functions on $\RR$ which go to zero as $|x| \to \infty$.
\begin{theorem}[Gelfand-Naimark]
    \index{Gelfand-Naimark theorem}
    For every $C^*$-algebra $A$, there is a faithful $*$-representation of $A$. Moreover, if $A$ is commutative, then there is a locally compact Hausdorff space $X$ such that $A = C_\infty(X)$ (which gives a representation of $A$ on $L^2(X)$. If $A$ is also unital, then $X$ is compact and is naturally in bijection with the maximal ideal space of $A$. Moreover, the map $A \mapsto X$ is a contravariant equivalence of categories between compact Hausdorff spaces and commutative, unital $C^*$-algebras.
\end{theorem}

\section{The $\BB^p$ spaces}
\begin{definition}
    If $T \in \BB^2(\HH)$ then $T$ is called a \dfn{Hilbert-Schmidt operator}.
\end{definition}
\begin{example}
    Let $\HH$ be the separable Hilbert space. Take $\AAA = \BB_0(\HH)$ and $\omega$ to be the trace. Since $\BB_0(\HH)$ has square roots and $\omega$ is tracial, we can apply the above result to prove that $n_\omega$ and $m_\omega$ are two-sided ideals and hence sub-$*$-algebras.

    If we write $|T| = \sqrt T^2$, and let $\BB^p(\HH)$ be the space of $T \in \BB_0(\HH)$ such that $\omega(|T|^p) < \infty$, then $\BB^1(\HH) = m_\omega(\HH)$ and $\BB^2(\HH) = n_\omega(\HH)$.

    We think of $\BB^p(\HH)$ as the noncommutative analogue of $\ell^p$.
\end{example}
Let's check that that example actually makes sense.
\begin{theorem}
    $\BB^2(\HH)$ is a Banach space.
\end{theorem}
\begin{proof}
    First observe that $||T||_{op} \leq ||T||_2$. To do this, compute the trace of $T$ by using an orthonormal basis containing a $\xi$ such that $||T\xi|| \geq ||T||_{op} - \varepsilon$. As this is possible for any $\varepsilon > 0$ the claim holds.

    Now assume that $\{T_n\}_n$ is $2$-Cauchy, so in particular $op$-Cauchy. So there is a $T \in \BB_0(\HH)$ such that $T_n \to^{op} T$.

    If $P$ is a finite-rank projection then $(T-T_n)P$ is a finite-rank operator, hence $\in \BB^2(\HH)$. So
\begin{align*}
    ||(T-T_n)P||_2^2
        &= tr P(T-T_n)^*(T-T_n)P
        = tr (T-T_n)P(T-T_n)^*
        = \lim_{k \to \infty} tr (T_k-T_n)P(T_k -T_n)^*\\
        &\leq \limsup_{k \to \infty} (T_k-T_n)(T_k-T_n)^*
        = \limsup_{k \to \infty} ||T_k-T_n||_2^2.
\end{align*}
Let $C_n = \limsup_{k \to \infty} ||T_k-T_n||_2^2$. Then $C_n \to 0$ and
$$||(T-T_n)P||_2^2 \leq C_n$$
regardless of the choice of $n$ and $P$. Since $T-T_n$ is a compact operator, we can approximate it arbitrarily well by $(T-T_n)P$ by choosing $P$. So $||T-T_n||_2^2 \to 0$.
\end{proof}
Recall the \dfn{polar decomposition} of $T \in \BB_0(\HH)$ is the factorization
$$T = V|T|$$
where $|T| = \sqrt T^2$ and $V$ is a \dfn{partial isometry}, i.e. an isometry on its cokernel.
\begin{lemma}
    If $T \in \BB^1(\HH)$ and $A \in \BB(\HH)$ then
    $$|tr(AT)| \leq ||A||_{op} tr|T|.$$
\end{lemma}
\begin{proof}
    Write $T = V|T|$. Then
\begin{align*}
    |tr(AT)|
        &= |tr(AV|T|)|
        \leq ||AV||_{op} tr|T|
        \leq ||A||_{op} tr|T|.
\end{align*}
\end{proof}
\begin{lemma}
    $||\cdot||_1 = tr|\cdot|$ is a norm on $\BB^1(\HH)$.
\end{lemma}
\begin{proof}
    Let $S,T \in \BB^1(\HH)$ and $S+T = W|S+T|$. Then
\begin{align*}
    tr|S+T|
        &= tr W^*(S+T)
        = tr(W^*S) + tr(W^*T)
        \leq |trW^*S| + |trW^*T|
        \leq tr|S| + tr|T|.
\end{align*}
\end{proof}
\begin{theorem}
    $\BB^1(\HH)$ is a Banach algebra.
\end{theorem}
\begin{proof}
    Since $||T||_{op} \leq ||T||_1$ the proof is basically the same as for Hilbert-Schmidt operators.
\end{proof}
\begin{theorem}
    $\BB^1(\HH)^* = \BB(H)$.
\end{theorem}
\begin{proof}
    If $A \in \BB(\HH)$, let $\Psi_A(T) = tr(AT)$. Then
$$||\Psi_A(T)|| \leq ||A||||T||_1.$$
    So $A \mapsto \Psi_A$ is an isometry and so $\BB(\HH) \subseteq \BB^1(\HH)^*$.

    Let $\Psi \in \BB^1(\HH)^*$ and $\xi,\eta \in \HH$. Define a bounded operator $\langle \xi, \eta\rangle_O$ by
    $$\langle \xi, \eta\rangle_O\zeta = \xi \langle \eta, \zeta\rangle.$$
    (So $\langle\cdot,\cdot\rangle_O$ is an operator-valued pseudo-inner product (the pseudo- here means that it could be zero).
    Define a semilinear form
    $$B_\Psi(xi, \eta) = \Psi\langle \xi, \eta\rangle_O.$$
    So $|B_\Psi(\xi, \eta)| \leq ||\Psi||||\xi||||\eta||$. Therefore by the Riesz representation theorem, there is an operator $A$ such that $B_\Psi(\xi, \eta) = \langle A\xi, \eta\rangle$. Therefore $||A|| = ||\Psi||$ and $\Psi = \Psi_A$. So $\BB^1(\HH)^* \subseteq \BB(\HH)$.
\end{proof}

\section{Representation theory of groups}
Let $G$ be a group with a good topology (so $G$ admits a Haar measure).

\begin{definition}
A \dfn{unitary representation} of $G$ is a continuous morphism of groups $G \to U(H)$. It is \dfn{irreducible} if the only $G$-invariant subspaces are trivial.
\end{definition}
For $\pi$ a unitary representation, we have $\pi(x)^* = \pi(x)^{-1}$.

\begin{example}
    Let $G = \SL(3, \ZZ)$. Then the ``obvious" map $G \to \SL(3, \CC)$ is not a unitary representation. In fact $G$ has very few finite-dimensional unitary representations, because $G$ is not compact.
\end{example}

\begin{definition}
    The \dfn{left regular representation} of $G$ is the map $G \to U(L^2(G))$ given by
    $$\pi(x)(\xi)(y) = \xi(x^{-1}y).$$
\end{definition}

It is natural to want to study the subalgebra of $B(H)$ generated by $\pi(G)$ for $\pi$ a unitary representation. This will be given by linear combinations of the $\pi(x)$s as $x \in G$, which we identify with the space $C_c(G)$ of compactly supported continuous functions on $G$. Namely, for $f \in G$ we define
$$\pi(f) = \int_G f(x) \pi(x) ~dx.$$
\begin{definition}
    The norm-closure of $\pi(C_c(G))$ is the \dfn{reduced C$^*$-algebra} of $G$.
\end{definition}
Now an easy computation shows
$$\pi(f)\pi(g) = \pi(f*g)$$
and of course $\pi(f)^* = \pi(f^*)$ where we define $f^*(x) = \overline f(x^{-1})$. Finally, we observe that
$$||\pi(f)|| \leq ||f||_{L^1(G)}$$
so $\pi$ is a $*$-Banach algebra morphism which extends to a map
$$\pi: L^1(G) \to B(L^2(G)).$$
This leads to the abstract theory of Fourier transform.

\section{Compact operators}
Let $B_0(H)$ denote the algebra of compact operators in $H$. This is a closed ideal of $H$, hence a $C^*$ algebra (proof: it is the closure of the ideal $B_f(H)$ of finite rank operators in $H$.) It will be one of our main examples of a noncommutative, nonunital $C^*$ algebra.

We now study the representation theory of $B_0(H)$.

Like any $C^*$ algebra, $B_0(H)$ has a normalized approximate identity, sequential if $H$ is separable. Decompose $H$ by transfinite recursion as
$$H = \bigoplus_{\alpha < \kappa} \CC$$
where $\kappa$ is some cardinal ($\kappa = \aleph_0$ if $H$ separable) and the biproduct is in the category of Hilbert spaces. For $\lambda < \kappa$, let $H_\lambda = \bigoplus_{\alpha < \lambda} H_\lambda$ so $H$ is the injective limit of the $H_\lambda$; then let $e_\lambda$ be the natural projection $H \to H_\lambda$. The $e_\lambda$ form a net with respect to the natural ordering on $\kappa$ and are obviously an approximate identity.

Recall that if we fix a representation $\pi: A \to B(H)$, we can view $H$ as a module over $A$ by defining $a\xi = \pi(a)(\xi)$. Recall also that a representation is said to be nondegenerate if $HA$ is dense in $A$.

In fact, any representation of $B_0(H)$ is faithful. Since representations are continuous, and $B_0(H)$ has no closed ideals (since $B_f(H)$ contains all proper ideals of $B_0(H)$, and is dense in $H$), any representation of $B_0(H)$ is faithful.

There is a natural $*$-representation $B_0(H) \to B(H)$ given by the inclusion map. Since $e_\lambda\xi \to \xi$, this representation is nondegenerate. In some sense this is the only such representation.
\begin{lemma}
    A nondegenerate $*$-representation of $B_0(H)$ is isomorphic to a direct sum to copies of the representation $B_0(H) \to B(H)$. In particular, the only irreducible such representation is the representation $B_0(H) \to B(H)$.
\end{lemma}
\begin{proof}
    Let $\langle \xi, \eta\rangle_0$ be the $B_0(H)$-valued inner product
    $$\langle \xi, \eta\rangle_0 \zeta = \xi \langle \eta, \zeta\rangle.$$
    In fact such an inner product has values in rank-$1$ operators since $\xi \langle \eta, \zeta\rangle$ lies in the span of $\xi$.

    For $T \in B(H)$, $T\langle \xi, \eta\rangle_0\zeta = (T\xi)\langle \eta, \zeta\rangle$ so $T\langle \xi, \eta\rangle_0 = \langle T\xi, \eta\rangle_0$, and $\langle \xi, \eta\rangle_0T = \langle \xi, T^*\eta\rangle_0$.

    Let $\pi: B_0(H) \to B(V)$ be a nondegenerate $*$-representation, $\xi \in H$ a unit vector. Then $\langle \xi, \xi\rangle_0$ is a rank-$1$ projection. Since $\pi$ is faithful, $\pi(\langle \xi, \xi\rangle_0)$ is a nonzero projection. Let $v$ be a unit vector of $\langle \xi, \xi\rangle_0(V)$ and define $Q: H \to V$ by $Q\eta = \langle \eta, \xi\rangle_0 v$. Then by a tedious computation, $Q$ is an isometry.

    We now show that $Q$ commutes the representations. Let $T = \langle \omega, \zeta\rangle_0$. Any operator in $B_0(H)$ can be written as an infinite linear combination of rank-$1$ operators so it suffices to show that $QT = TQ$. In fact,
    $$Q(T\eta) = \langle T\eta, \zeta\rangle_0 v = TQ(\eta).$$
    Also, $Q(H)^\perp$ is $\pi$-invariant, so we repeat the argument on $Q(H)^\perp$ to see that we have
    $$V = Q(H) \oplus Q(H)^\perp$$
    as $B_0(H)$-modules. Now run Zorn's lemma to keep decomposing $Q(H)^\perp$ until we hit an irreducible representation.
\end{proof}

This is a very remarkable property of $B_0(H)$. To see why, we need something stronger than ZFC.
\begin{definition}
    A \dfn{$\Diamond$-sequence} is a net of sets $\alpha \mapsto A_\alpha$, for $\alpha < \aleph_1$, such that for any $A \subseteq \aleph_1$,
    $$\hat A = \{\alpha < \aleph_1: A \cap \alpha = A_\alpha\}$$
    is stationary in $\aleph_1$.
\end{definition}
In other words, for every closed and unbounded (``club") set $C \subseteq \aleph_1$, $C \cap \hat A$ is nonempty. The existence of a $\Diamond$-sequence implies that $V = L$, in particular implying GCH.

Naimark conjectured that if $A$ was a $C^*$-algebra with only one irreducible representation, then $A = B_0(H)$. This is true if $A$ is separable.
\begin{theorem}[Ackemann-Weaver]
    If there is a $\Diamond$-sequence, then there is a $C^*$-algebra $A$ which has only one irreducible representation such that $A \neq B_0(H)$.
\end{theorem}

In this lemma, you should read $A = B(H)$ and $I = B_0(H)$.
\begin{lemma}
    Let $A$ be a $*$-normed algebra and $I$ a $*$-ideal of $A$ with normalized approximate unit. Then every nondegenerate $*$-representation of $I$ extends uniquely to $A$.
\end{lemma}
\begin{proof}
    Let $\pi: I \to B(H)$ be such a representation. Define
    $$\tilde \pi(a) \sum_\alpha \pi(d_\alpha) \xi_\alpha = \sum_\alpha \pi(ad_\alpha) \xi_\alpha$$
    where the $\xi_\alpha$ are a Hilbert basis of $H$. Then $\tilde \pi$ is a well-defined function since if $\sum_\alpha \pi(d_\alpha)\xi_\alpha = 0$, then
    $$\sum_\alpha \pi(ad_\alpha)\xi_\alpha = \lim_\lambda \sum_\alpha \pi(ae_\lambda d_\alpha) \xi_\alpha = \lim_\lambda \pi(ae_\lambda) \sum_\alpha \pi(d_\alpha)\xi_\alpha = 0$$
    since the $e_\lambda$ are a normalized approximate unit. This is unique because
    $$\tilde \pi(a)\pi(d)\xi = \pi(ad)\xi$$
    and the $\pi(ad)\xi$ are dense in $H$.
\end{proof}

\begin{lemma}
    Let $A,I$ be as above and let $\pi$ be an irreducible representation of $A$. Then either $I \subseteq \ker\pi$ or $\pi$ is an irreducible representation of $I$.
\end{lemma}
\begin{proof}
    Assume $I$ is not contained in $\ker \pi$. Then $\overline{IH}$ is nonzero and $A$-invariant. Since $\pi$ is irreducible, $\overline{IH} =H$. Therefore $\pi$ is a nondegenerate representation of $I$.

    We have $e_\lambda\xi \to \xi$ for any $\xi$ since $\pi$ is nondegenerate. Let $K \subseteq H$ be nondegenerate and nonzero. Using $e_\lambda$, $\overline{IK} = K$ so $\overline{IK}$ is $A$-invariant. Therefore since $\pi$ is irreducible, $K = H$.
\end{proof}

\begin{lemma}
    Let $A,I$ be as above. Let $\pi: A \to B(H)$ and $\rho: A \to B(K)$ be irreducible representations. If $\pi \cong \rho$ as representations of $I$, then $\pi \cong \rho$ as representations of $A$.
\end{lemma}
\begin{proof}
    Let $U: H \to K$ be an isomorphism of $I$-modules. For $d \in I$,
    $$U(\pi(a)\pi(d)\xi) = U(\pi(ad)\xi) = \rho(ad)U\xi = \rho(a)U(\pi(d)\xi).$$
    So $U\pi = \rho U$.
\end{proof}

\begin{theorem}[Burnside]
    Assume $H \neq \CC$. Let $A \subseteq B_0(H)$ be a $C^*$-algebra. If $A$ acts on $H$ irreducibly, then $A = B_0(H)$.
\end{theorem}
\begin{proof}
    By assumption on $H$, $A \neq 0$. Let $T \neq 0$. Then $T^*T \in A$ is nonzero, so we can assume without loss of generality that $T$ is self-adjoint. Moreover, $C^*(T, 1) = C(\sigma(T))$ acts on $H$ as an abelian monoid.

    Let $\lambda \in C(\sigma(T))$. Taking bump functions centered on $\lambda$ we can find a sequence of $\xi_n \in H$ such that $(T - \lambda)\xi_n \to 0$. Since $T$ is comapct, $T$ sends the unit ball of $H$ to a precompact set. So the $T\xi_n$ have a weak limit $\eta$. Thus $T\eta = \lambda\eta$. Therefore $T$ has an eigenvector for $\lambda$. So the only limit point of $\sigma(T)$ is $0$, because the other eigenvectors are all orthogonal.

    Let $P$ be a projection of minimal rank in $A$. We claim that $P$ is a rank-$1$ projection. In fact, $PTP$ is a self-adjoint operator on the finite-dimensional space $PH$, so has spectral projections in $A$ whose rank is the same as that of $P$ by minimality. Thus there is a unique such spectral projection; i.e. there is an $s \in \RR$ such that $PTP = sP$. Moreover, if $\xi,\eta \in PH$ are orthonormal, $R \in A$, then $\langle R\xi, \eta\rangle = s\langle\xi, \eta\rangle = 0$. Therefore $\langle A\xi, \eta\rangle = 0$, yet $A$ acts irreducibly, which is a contradiction. Therefore $P$ is a rank-$1$ projection.

    Now $R,S \in A$ implies that $RPS$ is a rank-$1$ projection. Thus $\overline{APAH} = H$. So $\overline{APA}$ is the set of rank-$1$ operators. Any compact operator can be written as an infinite linear combination of those.
\end{proof}

\begin{corollary}
    Let $A$ be a $C^*$-algebra and $\pi: A \to B(H)$ an irreducible representation. If $\pi(A)$ contains a nonzero compact operator then $\pi(A)$ contains $B_0(H)$.
\end{corollary}
\begin{proof}
    Let $I = \pi(A) \cap B_0(H)$. Then $I$ acts irreducibly on $H$ so by Burnside's theorem, $\overline{\pi(I)} = B_0(H)$. But $\pi$ takes $I/\ker \pi$ to $B_0(H)$ isometrically (since it is injective), so $\pi(I)$ is closed since $I$ is complete. Thus $\pi(I) = B_0(H)$.
\end{proof}

We write $\hat A$ to denote the set of all isomorphism classes of irreducible representations of $A$.
\begin{definition}
    Let $\pi: A \to B(H)$ range over $\hat A$. We say that $A$ is \dfn{liminal} or \dfn{CCR} if for every $\pi$, $\pi(A) = B_0(H)$. We say $A$ is \dfn{postliminal} or \dfn{GCR} if for every $\pi$, $B_0(H) \cap \pi(A) \neq 0$. We say $A$ is \dfn{antiliminal} or \dfn{NCR} if for every $\pi$, $B_0(H) \cap \pi(A) = 0$.

    If $A$ is a von Neumann algebra, we say that $A$ is \dfn{type-I} if $A$ is postliminal. We say that $A$ is \dfn{non-type-I} if $A$ is not postliminal.
\end{definition}
    We will prove later that if $G$ is a semisimple Lie group or a nilpotent Lie group, then $C^*(G)$ (by which we really mean $C^*(L^1(G))$) is CCR. But if $G$ is solvable we cannot even prove that $C^*(G)$ is GCR.
\begin{example}
    Let $\alpha$ be the Lie action of $\RR$ on $\CC^2$ by $\alpha(t)(z, w) = (e^{2\pi it}z, e^{2\pi i\mu t}w)$ where $\mu$ is irrational. Then we take the outer semidirect product $G = \CC^2 \times_\alpha \RR$. Then $C^*(G)$ is not GCR.
\end{example}
\begin{theorem}
    Let $\pi: A \to B(H)$ be an irreducible representation and let $I = \ker \pi$. If $\pi(A) \cap B_0(H) \neq 0$ then for every irreducible representation $\rho$ of $A$ such that $\ker \rho = I$, $\rho \cong \pi$.
\end{theorem}
\begin{proof}
    Let $J = \pi^{-1}(B_0(H))$, so $I \subseteq J$. Then $\pi$ is an irreducible representation of $J$ with kernel $I$, so drops to an irreducible representation of $J/I$. By Burnside's theorem, $\pi$ is an isomorphism $J/I \to B_0(H)$.

    But by assumption on $\rho$, $\rho$ is an isomorphism $J/I \cong B_0(H)$. Since there can be only one irreducible representation of $B_0(H)$, $\rho \cong \pi$ as representations of $J$. But $\rho,\pi$ extend uniquely to $A$, so $\rho \cong \pi$ as representations of $A$.
\end{proof}
\begin{corollary}
    If $A$ is a GCR algebra, then every representation of $A$ is uniquely determined by its kernel.
\end{corollary}
\begin{definition}
    A \dfn{primitive ideal} is a kernel of some irreducible representation.
\end{definition}
    So if $A$ is GCR, then there is a bijection between $\hat A$ and the set of primitive ideals of $A$. On the other hand, NCR algebras are very bad:
\begin{theorem}
    Let $\pi: A \to B(H)$ be an irreducible representation and assume $\pi(A) \cap B_0(H) = 0$. Then there are uncountably many irreducible representations $\rho$ of $A$ such that $\ker \rho = \ker \pi$.
\end{theorem}
    In fact Mackey showed that in some sense the set of representations sharing a kernel with $\pi$ is ``unclassifiable."
\begin{example}
    Let $A$ be a unital, infinite-dimensional, simple $C^*$-algebra and $\pi: A \to B(H)$ an irreducible representation. Since $A$ is simple, it has no proper ideals; yet $\pi^{-1}(B_0(H))$ is an ideal. If $\pi^{-1}(B_0(H)) = A$ then $A$ is not unital, a contradiction. So $\pi(A) \cap B_0(H) = 0$. Therefore $A$ is an NCR algebra.
\end{example}
\begin{theorem}
    Every primitive ideal is prime.
\end{theorem}
\begin{proof}
    Let $I$ be a primitive ideal of $A$, say $I = \ker \pi$. Let $J_1,J_2$ be ideals of $A$ such that $J_1J_2 \subseteq I$. If $J_1 \subseteq I$ there is nothing to prove. Otherwise, $\pi(J_1) \neq 0$, so $\overline{\pi(J_1)H} \neq 0$ is $\pi$-invariant. By irreducibility, $\overline{\pi(J_1)H} = H$, so $\overline{\pi(J_2)H} = \overline{\pi(J_2)\pi(J_1)H} = \overline{\pi(J_1J_2)H} \subseteq \overline{\pi(I)H} = 0$. So $J_2 \subseteq I$.
\end{proof}
    Recall that the prime spectrum $\Spec R$ of a ring $R$ is defined by the Zariski (or Jacobson, or hull-kernel) topology is given by declaring that $S \subset \Spec R$ is closed if there is an ideal $I$ such that $S = \{J \in \Spec R: J \subseteq I\}$. By the above theorem, if $R$ is a $C^*$-algebra, then the Zariski topology drops to a topology on the set of primitive ideals $\Prim R$. This topology is far from Hausdorff in general, but is at least locally compact. If $R$ is a commutative $C^*$-algebra, then $\Prim R$ is naturally the maximal ideal space of $R$ (since every primitive ideal is maximal in that case) and this just generalizes the Gelfand-Naimark theorem in that case.

    In fact, if $A$ is separable, then every closed prime ideal of $A$ is primitive. This follows from applying the Baire category theorem to $\Prim A$. This does not work in general: Weaver used transfinite induction to find a counterexample if $A$ is not separable. (It may be undecidable whether there is a counterexample in ZF alone.)

\chapter{Generators and relations}
We now study $C^*$-algebras determined by generators and relations.

\section{Construction of maximally free algebras}
Let $\{a_i\}$ be a set of generators, and take the free $*$-algebra $F$ over $\CC$ generated by the $a_i$. This is the set of noncommutative polynomials in the $a_i$ and $a_i^*$ (where $a_i^*$ is just a formal symbol for now).

Given a set $R$ of relations, we can view $R$ as noncommutative polynomial equations. So we take the ideal $(R, R^*)$, which is the $*$-ideal generated by $R$. Then we let $A = F/(R, R^*)$, which is a $*$-algebra still. We consider the set $\Pi$ of all $*$-representations of $A$. Then for $a \in A$ we set
$$||a|| = \sup_{\pi \in \Pi} ||\pi(a)||.$$
A priori we have $||a|| = \infty$. This happens if $F$ is the free $*$-algebra on one generator. So we need $R$ to force $||a_i|| < \infty$ for each generator $a_i$.

Assume that $R$ forces $||a_i|| < \infty$ (for example, if the generators are sent to unitary operators). Since the image of every $\pi \in \Pi$ is a $C^*$-algebra, $||\cdot||$ is a seminorm satisfying the $C^*$-identity $||a^*a|| = ||a||^2$. So we take the completion with respect to $||\cdot||$; i.e. we annihilate the kernel of the seminorm and then complete. What is left over is a $C^*$-algebra.

Just because a set of generators and relations gives a valid $C^*$-algebra of $A$ does not mean that we necessarily can find a natural, faithful representation. Moreover, even if we have a natural, faithful representation of $A$, the norm arising from that representation is not necessarily the norm given by taking the supremum over $\Pi$.

\begin{example}
Let $G$ be a discrete group, which we view as a set of generators. We impose relations corresponding to each true relation in $G$. (This can be viewed as taking the first-order theory of $G$.) We also take the relations $x^* = x^{-1}$ for $x \in G$ so the resulting maximally free operator algebra $A$ naturally represents the elements of $G$ as unitary operators. Therefore for $x \in G$ we have $||x|| = 1$; so $A$ is actually a $C^*$-algebra. In fact, it is easy to see that $A$ is the completion of $C_c(G)$, i.e. finitely supported functions on $G$. In other words, $A = C^*_r(G)$ is the reduced group $C^*$-algebra.

Moreover, $A$ acts on $\ell^2(G)$ by left translation, since $G$ does. This representation is faithful, so $A$ is unusual amongst the free $C^*$-algebras in that it has a natural faithful representation. In general, the norm in $\ell^2(G)$ does not always agree with the norm on $A$; this happens if and only if $G$ is an \dfn{amenable group}. (It turns out that since $G$ is discrete, $G$ is amenable if and only if there is a finitely additive, left-invariant probability measure on $G$. For example, this fails if $G$ is the free group on $n$ letters, $n \geq 2$.)
\end{example}

\section{Tensor products of $C^*$-algebras}
An important application of generators and relations is the ability to define the tensor product of $C^*$-algebras.
\begin{definition}
    Let $A,B$ be unital $C^*$-algebras. Their \dfn{tensor product} $A \otimes B$ is the $C^*$-algebra with generators $A \cup B$ and relations consisting of all true relations in $A$, all true relations in $B$,
    $$\forall a\in A~\forall b\in B~ab = ba,$$
    and $\forall x ~(1_A1_B)x = x$.
\end{definition}
The relation $ab = ba$ is the ``tensor product relation", so we can reasonably think of $ab$ as $a \otimes b$. Similarly, the relation $(1_A1_B)x = x$ requires that $1_{A \otimes B} = 1_A1_B$, so $A \otimes B$ is unital. We have embeddings $A \to A \otimes B$, $B \to A \otimes B$ given by $a \mapsto a \otimes 1_B$ and $b \mapsto 1_A \otimes b$.

To see that this is actually well-defined (i.e. has finite norm), let $\pi$ be a $*$-representation of $A \otimes B$. Then $\pi$ restricts to a $*$-representation of $A$ (and similarly to $B$) along the mapping $A \to A \otimes B$. Therefore for any $a \in A$,
$$||\pi(a \otimes 1_B)|| \leq ||a||.$$
Similarly for $B$; so there is an upper bound on the norm of any generator. Therefore $A \otimes B$ is a $C^*$-algebra.

\begin{example}
    Let $X,Y$ be compact Hausdorff spaces. Then we have $C(X \times Y) = C(X) \otimes C(Y)$.
\end{example}

We now consider the representation theory of tensor products.
\begin{definition}
    Let $\pi: A \to B(H)$ and $\rho: B \to B(K)$ be representations. The \dfn{tensor product of representations} $\pi \otimes \rho: A \otimes B \to B(H \otimes K)$ is defined by
    $$\pi \otimes \rho(a \otimes b)(\xi \otimes \eta) = \pi(a)\xi \otimes \rho(b)\eta.$$
\end{definition}
The norm induced by the tensor product of representations is also a $C^*$-norm, so we have two reasonable $C^*$-norms on $A \otimes B$. If we use the norm obtained by taking the supremum over representations, we emphasize this by writing $A \otimes_{max} B$. If we are using the norm obtained by the tensor product of Gelfand-Naimark-Segal representations, we write $A \otimes_{min} B$.
\begin{example}[Takesaki, 1959]
    Let $G$ be the free group on $2$ generators, $\lambda$ its left regular representation, $\rho$ its right regular representation. Consider the tensor product $C_r^*(G) \otimes C_r^*(G)$, represented by $\lambda \otimes \rho$. Then the two norms given above are the ``minimum" (i.e. tensor product $\lambda \otimes \rho$) and ``maximum" norms respectively, but there are many intermediate norms between the two that have been studied in recent years. In particular, the tensor product does not have a unique norm.
\end{example}
\begin{definition}
    A \dfn{nuclear $C^*$-algebra} $A$ is a $C^*$-algebra such that for every $C^*$-algebra $B$, the norm on $A \otimes B$ is unique.
\end{definition}
\begin{example}
    $B_0(H)$ is nuclear, since it uniquely embeds in $B(H)$. It follows that any GCR algebra is nuclear. But if $G$ is a discrete group, then $C^*(G)$ is nuclear if and only if $G$ is amenable. Thus the free group on $2$ generators is not nuclear.
\end{example}
\begin{definition}
    An \dfn{exact $C^*$-algebra} $A$ is a $C^*$-algebra such that $A \otimes_{min} \cdot$ is an exact functor.
\end{definition}
    Note that $A \otimes_{max} \cdot$ is an exact functor for any $A$.

We now treat the coproduct in the category of $C^*$-algebras.
\begin{definition}
    The \dfn{free product} of $C^*$-algebras $A, B$, $A*B$, is defined to have generators $A \cup B$ and relations induced from $A,B$ as well as $1_A = 1_B$.
\end{definition}
The norm is defined as in the case of tensor products. A representation of $A*B$ consists of a pair of representations of $A$ and $B$ on the same Hilbert space, by the universal property.

\chapter{Representation theory of locally compact groups}
\section{Noncommutative dynamical systems}
\begin{definition}
    A \dfn{noncommutative dynamical system} is an action of a group $G$ on a $C^*$-algebra $A$.
\end{definition}

    Often it is convenient that a noncommutative dynamical system is taking place inside a Hilbert space $H$.
\begin{definition}
    Let $\alpha: G \to \Aut(A)$ be a noncommutative dynamical system. Let $\pi: A \to B(H)$ a $*$-representation, $U: G \to U(H)$ a unitary representation. If the dynamical system satisfies the \dfn{covariance relation}
    $$\alpha(x)a = U_x\pi(a)U_x^*,$$
    then $(\pi, U)$ is called a \dfn{covariant representation} of $\alpha$.
\end{definition}

    we now define $*$-operations on $C_c(G \to A)$. If $f,g \in C_c(G \to A)$ then
\begin{align*}\left(\sum_x f(x)x\right)\left(\sum_y g(y)y\right) &= \sum_{x,y} f(x)xg(y)y \\
    &= \sum_{x,y} f(x)\alpha(x)(g(y))xy\\
    &= \sum_{x,y} f(x)\alpha(x)(g(x^{-1}y))y.
\end{align*}
    This motivates the following definition.
\begin{definition}
    If $\alpha$ is a noncommutative dynamical system, then for $f,g \in C_c(G \to A)$, we define
    $$(f*g)(y) = \sum_x f(x) \alpha(x)(g(x^{-1}y)),$$
    the \dfn{twisted convolution} of $f,g$ by $\alpha$.
\end{definition}
\begin{definition}
    If $\alpha$ is a noncommutative dynamical system, $f \in C_c(G \to A)$, then
    $$f^*(x) = \alpha(x)(f(x^{-1})^*),$$
    the \dfn{twisted involution} of $f$ by $\alpha$.
\end{definition}
    With twisted convolution and involution, $C_c(G \to A)$ is a $*$-algebra. Moreover, we have an injective mapping $A \to C(G \to A)$ give by $a \mapsto a\delta_1$, $1$ the identity of the group. We also have an injective mapping $G \to C(G \to M(A))$ with $x \mapsto 1x$ (here $1$ is the identity of the noncommutative Stone-Cech compactification $M(A)$; if $A$ is unital then $A = M(A)$.

\begin{definition}
    Given any covariant representation $(\pi, U)$ of $\alpha: G \to \Aut(A)$ we call the \dfn{integrated form} $\sigma$, a $*$-representation $\sigma: C_c(G, A) \to B(H)$ by
    $$\sigma(f) = \sum_x \pi(f(x))U_x.$$
\end{definition}
    The set of all possible integrated forms is bounded. Therefore we can make the following definition by generators and relations:
\begin{definition}
    The $C^*$-algebra generated by $C_c(G, A)$ and $A$ is called $C^*(G, A)$ or $A \rtimes_\alpha G$. It is called the \dfn{crossed product $C^*$-algebra} or the \dfn{covariance $C^*$-algebra}.
\end{definition}
    The generators of $A \rtimes_\alpha G$ will consist of all elements of $G$ and of $A$, the relations will be all relations in $G$ and $A$ as well as
    $$xa = \alpha(x)ax$$
    since $G$ acts on $A$ by convolution (since $\alpha$ has a covariant representation).

    To see that that there are, in fact, covariant representations, we give an explicit one.
\begin{definition}
    Let $\rho: A \to B(H_0)$ be a $*$-representation, and define
    $$H = \ell^2(G \to H_0) = \ell^2(G) \otimes H_0.$$
    Now define a unitary representation of $G$ on $H$ by (for $x,y \in G$, $\xi \in H$)
    $$U(x)(\xi)(y) = \xi(x^{-1}y).$$
    We then define $\pi: A \to B(H)$ by
    $$\pi(a)(\xi)(x) = \rho(\alpha(x^{-1})(a))(\xi)(x),$$
    which is a $*$-representation. It is called the \dfn{induced covariant representation} of $\alpha$ by $\rho$.
\end{definition}
\begin{lemma}
    The induced covariant representation is covariant.
\end{lemma}
\begin{proof}
    We have
\begin{align*}U(x)(\pi(a))(\xi)(y) &= (\pi(a)(\xi))(x^{-1}y) = \rho(\alpha((x^{-1}y)^{-1}))(U(x)(\xi))(y)\\
    &= \rho(\alpha(y^{-1}x)(a)) = \rho(\alpha(y^{-1})(\alpha(x))(a))(U(x)(\xi))(y)\\
    &= (\pi(\alpha(x)(a))U(x)(\xi))(y).
\end{align*}
    So
    $$U(x)(\pi(a))(\xi) = \pi(\alpha(x)(a)U(x))(\xi)$$
    which implies
    $$U(x)(\pi(a)) = \pi(\alpha(x)(a))U(x)$$
    so that $(\pi, U)$ is a covariant representation.
\end{proof}
    If $K$ is a subgroup of $G$, $(\rho, V)$ a covariant representation of $\alpha|_K$ on $H_0$, then the induced representation of $(\rho, V)$ is a covariant representation of $\alpha$. Here $H = \ell^2(G/H) \otimes H_0$.
\begin{definition}
    The \dfn{reduced group $C^*$-algebra of the representation} $\alpha$, $C^*_r(A, G, \alpha)$, is the $C^*$-algebra generated by $C_c(G \to A)$ with $||f||$ defined to be the supremum of $||\sigma(f)||$ for $\sigma$ ranging over the integrated forms of induced covariant representations.
\end{definition}
\begin{definition}
    If $C^*(A, G, \alpha) = C^*_r(A, G, \alpha)$, then $\alpha$ is said to be an \dfn{amenable action}.
\end{definition}
    If $\alpha$ is trivial, then
    $$C^*(A, G, \alpha) = A \otimes C^*(G)$$
    so the theory of covariant representations includes the theory of unitary representations.

    Though all the above theory was developed for discrete groups, it works fine for locally compact groups, as we now describe in detail. In fact, if $G$ is a locally compact group, then we consider the left Haar measure $\mu$, which is a Radon measure that is unique up to positive scalars (but need not be two-sided). Moreover, if $y \in G$, if we let
    $$\nu(f) = \int_G f(xy) ~d\mu(x)$$
    then $\nu$ is a left Haar measure, so we can find a $\Delta(y)$ such that $\nu = \Delta(y)\mu$.
\begin{definition}
    The function $\Delta: G \to \RR^+$ is called the \dfn{modular function} of $G$.
\end{definition}
    The modular function is a continuous morphism of groups.
\begin{definition}
    A group is \dfn{unimodular} if $\Delta = 1$.
\end{definition}
    For unimodular groups, the left and right Haar measures coincide. So any abelian group is unimodular. Moreover, $\RR^+$ has no compact subgroups, so any compact group is unimodular. Semisimple Lie groups and nilpotent Lie groups can also be shown to be unimodular. Solvable Lie groups are often not unimodular.
\begin{example}
    Let $(M, \omega)$ be a Poisson manifold (e.g. $\omega$ is a symplectic form on $M$). We let $h$ be a semiclassical parameter for a family of noncommutative ring structures on $C_c^\infty(M \to \CC)$, so we can view $(M, \omega, h)$ as a family of operator algebras. There is a notion of modular function for $M$.
\end{example}
    The trouble with locally compact groups is that the maps $G \to U(H)$ are typically not norm-continuous. In fact, this is already apparent for the left regular representation $\RR \to U(L^2(\RR))$, where we take a function with compact support and translate it by far outside its support.
\begin{definition}
    An action $\alpha$ of $G$ on a Banach space $A$ is \dfn{strongly continuous} if for every $a \in A$, $x \mapsto \alpha(x)(a)$ is continuous.
\end{definition}
    This is the correct definition of the continuity of a representation of a locally compact group.
\begin{definition}
    If $G$ is a locally compact group, a $C^*$-dynamical system for $G$ is a strongly continuous action of $G$ on a $C^*$-algebra. A \dfn{covariant representation} of the $C^*$-dynamical system is one which is also strongly continuous.
\end{definition}
    The integrated form of a covariant representation $(\pi, U)$ of a $C^*$-dynamical system is given by
    $$\sigma_f(\xi) = \int_G \pi(f(x))U(x)(\xi) ~dx.$$
    Using Bochner integration, we can define the integrated form for any $f \in C_c(G \to A)$. Now
    $$||\sigma_f(\xi)|| \leq \int_G ||f(x)|| ~dx ~||\xi||$$
    so it follows that $||\sigma_f|| \leq ||f||_{L^1(G)}$. So $\sigma$ extends to $L^1(G \to A)$. Though the elements of $C_c(G \to A)$ are functions, it makes sense to think of them as Radon-Nikodym derivatives of $A$-valued measures on $G$ with respect to Haar measure. As in the theory of discrete groups, $\sigma_f\sigma_g = \sigma_{f*_\alpha g}$ where the twisted convolution is defined by
    $$f*_\alpha g(x) = \int_G f(y) \alpha(y)(g(y^{-1}x))(y) ~dy.$$
    Therefore $||f*_\alpha g||_{L^1(G)} \leq ||f||_{L^1(G)}||g||_{L^1(G)}$.

    Another complication comes in the form of groups that are not unimodular. This happens because
\begin{align*}
    \sigma_f^* &= \int_G \pi(f(x))U_x ~dx = \int_G U_x^* \pi(f(x))^* ~dx\\
    &= \int_G U_{x^{-1}} \pi(f(x))^* ~dx = \Delta(x) \int_G U_x\pi(f(x^{-1})^*) ~dx.
\end{align*}
    Therefore we must define the twisted involution
    $$f^*(x) = \Delta(x)\alpha(x)(f(x^{-1})^*)$$
    if we want $\sigma_f^* = \sigma_{f^*}$.
\begin{example}
    Let $G$ be the group of affine transformations of $\RR$ (the ``$ax + b$ group"). This group is far from unimodular, and its action on $\RR$ is important in the theory of wavelets. So the modular function is important in signal processing.
\end{example}
    We write $C^*(A, G, \alpha) = A \rtimes_\alpha G$ for the completion of $C_c(G \to A)$ with respect to the norm given by taking the supremum over all integrated forms. The reduced algebra $A \rtimes_\alpha^r G$ is given by taking the supremum over all integrated forms arising from covariant representations.

    Now $L^1(G)$ does not have an identity since it does not have a delta function if $G$ is not discrete. But we could always take an approximate delta function. Specifically, we let $\Lambda$ denote the filter of all open sets containing the identity $1$ of $G$. (A filter-base also suffices.) Then given a neighborhood $\lambda$ of $1$, let $f_\lambda \in C_c(G \to \RR^+)$ be supported in $\lambda$ with $||f_\lambda||_{L^1(G)} = 1$. We view $f_\lambda$ as a probability measure carried by $\lambda$. Obviously the $(f_\lambda)_\lambda$ are an approximate delta function in $L^1(G)$.

    Let $\alpha$ be an action of $G$ on a $C^*$-algebra $A$ with approximate identity $(e_\mu)_\mu$. We then define
    $$h_{\mu,\lambda}(x) = f_\lambda(x) e_\mu$$
    to obtain an approximate identity for $L^1(G \to A)$.

\begin{theorem}
    There is a natural bijection between nondegenerate $*$-representations of $A \rtimes_\alpha G$ and covariant representations of $\alpha$.
\end{theorem}
\begin{proof}[Proof sketch]
    Let $\sigma$ be a nondegenerate $*$-representation of $A \rtimes_\alpha G$ and consider its multiplier algebra $M(A \rtimes_\alpha G)$. We have an injection $G \to M(A \rtimes_\alpha G)$ by $x \mapsto \delta_x$, using the fact that $L^1(G)$ is a $2$-sided ideal in the multiplier algebra $M(G)$, where we think of double centralizers as finite Radon measures (this is true up to natural isomorphism). We also have an injection $A \to M(A \rtimes_\alpha G)$, by $a \mapsto a \delta_{1_G}$. We can therefore obtain a covariant representation $(\pi, U)$ of $\alpha$ obtained by restricting $\sigma$ to $A,G$. It follows that $\sigma$ is the integrated form of $(\pi, U)$.
\end{proof}
    In particular, it makes sense to talk about the hull-kernel topology on the set of covariant representations of $\alpha$.

\begin{definition}
    For $G$ a locally compact group, we let $(A, \alpha)$ and $(B, \beta)$ be $C^*$-dynamical systems. Let $\varphi: A \to B$ be a $*$-morphism. Then $\varphi$ is a \dfn{equivariant morphism} with respect to $\alpha,\beta$ if for every $a \in A$,
    $$\varphi(\alpha(x)(a)) = \beta(x)(\varphi(a)).$$
\end{definition}
    The category of $C^*$-dynamical systems over $G$ has equivariant morphisms as its morphisms by definition. Equivariant morphisms $\varphi:A \to B$ give rise to maps $C_c(G \to A) \to C_c(G \to B)$ given by
    $$\varphi(f)(x) = \varphi(f(x)).$$
    This naturally extends to the group $C^*$-algebras, so gives rise to a morphism $\varphi: A \rtimes_\alpha G \to B \rtimes_\alpha G$. Therefore the following theorem holds.
\begin{theorem}
    The map $\alpha \mapsto A \rtimes_\alpha G$ is a functor from the category of $C^*$-dynamical systems over $G$ to the category of $C^*$-algebras.
\end{theorem}
    Using category theory, we can obtain the following theorem.
\begin{theorem}
    Let $(A, \alpha)$ be a $C^*$-dynamical system. Let $I$ be an $\alpha$-invariant ideal of $A$. Then the natural action of $\alpha$ on $A/I$is a $C^*$-dynamical system, and the natural arrows
    $$0 \to I \rtimes_\alpha G \to A \rtimes_\alpha G \to (A/I) \rtimes_\alpha G \to 0$$
    form a short exact sequence.
\end{theorem}
    In other words, the functor $\cdot \rtimes_\alpha G$ is exact on $\alpha$-invariant ideals. This is not true for the reduced product.
\begin{proof}
    Consider the short exact sequence
$$\begin{tikzcd}0 \arrow[r]& I\arrow[r,"i"] & A\arrow[r,"p"] & A/I\arrow[r] &0\end{tikzcd}.$$
    Straight from the definitions, the induced map $p^*$ is onto and $p^*(i^*(C_c(G, A))) = 0$. So $i^*$ maps into the kernel of $p^*$.

    We now claim that the induced map $i^*$ is injective. Let $\sigma$ be a faithful representation of $I \rtimes_\alpha G$. Let $(\pi, U)$ the covariant representation of $\sigma$. Then if $\sigma$ is nondegenerate, so is $(\pi, U)$. Then $\pi$ extends to a representation $\tilde \pi$ of $A$. Since $\pi$ is nondegenerate, we can restrict to the image of $\pi(I)$ without any loss of generality when proving that $(U, \tilde \pi)$ is covariant. In fact,
    $$U(x)\tilde \pi(a)(\pi(d)\xi) = \pi(\alpha(x)(ad))U(x)\xi$$
    which proves covariance of $(U, \tilde \pi)$. So let $\tilde \sigma$ be a representation of $A \rtimes_\alpha G$ for which $(U, \tilde \pi)$ is a covariant representation. Then
    $$\tilde\sigma|_{i^*(I \rtimes_\alpha G)} = \sigma,$$
    so $\tilde \sigma \circ i^*$ is faithful on $I \rtimes_\alpha G$. Therefore $\ker i^* = 0$. In particular $I \rtimes_\alpha G$ is isomorphic to an ideal of $A \rtimes_\alpha G$, and without loss of generality we assume that they are equal (i.e. $i^*$ is the identity).

    Finally we show exactness at $A \rtimes_\alpha G$; i.e. $\ker p^* \subseteq I \rtimes_\alpha G$. Since $I \rtimes_\alpha G$ is a $C^*$-algebra, $A \rtimes_\alpha G/I \rtimes_\alpha G$ exists, and has a faithful representation $\sigma$. Pulling $\sigma$ back along the quotient map $A \rtimes_\alpha G \to A \rtimes_\alpha/I \rtimes_\alpha G$, we obtain a representation of $A \rtimes_\alpha G$. Let $(\pi, U)$ be the corresponding covariant representation of $A \rtimes_\alpha G$.

    Let $d \in I$, $h \in C_c(G)$. Let $f \in C_c(G \to I) \subseteq I \rtimes_\alpha G$ be defined by
    $$f(x) = h(x)d$$
    so $\sigma(f) = 0$. Thus
    $$0 = \int_G \pi(d)f(x)U(x) ~dx = \pi(d) \int_G f(x)U(x) ~dx.$$
    Since the integral on the right does not have to be zero, $\pi(d) = 0$. So $I \subseteq \ker \pi$. Therefore $\pi$ drops to a representation $\tau$ of $A/I \rtimes_\alpha G$. It is routine to prove that $\sigma = \tau \circ p^*$. So $\ker \sigma = \ker p^* \subseteq I \rtimes_\alpha G$.
\end{proof}
    Note that the representation $\tau$ may not exist on the reduced product, which explains why the theorem fails there.

\section{Group actions on locally compact spaces}
    Let $A$ be a commutative $C^*$-algebra and let $G$ be a locally compact group which acts on $A$ by $\alpha$. Then we can find a locally compact Hausdorff space $M$ such that $A = C_\infty(M)$. We have an action $\alpha$ of $G$ on $M$ by homeomorphisms, and $G \times M$ is locally compact. We will assume that $\alpha$ is \dfn{jointly continuous}, i.e. the map
\begin{align*}
    G \times M &\to M\\
    (x, m) &\mapsto \alpha(x)m
\end{align*}
    is continuous. Thus the action
    $$\alpha(x)(f)(y) = f(\alpha(x)^{-1}y)$$
    of $G$ on $C_c(M) \subseteq A$ is isometric, in particularly, strongly continuous in $L^\infty$-norm. Moreover, $\alpha$ is continuous in the inductive limit topology of $C_c(M)$. Therefore if $\mu$ is an $\alpha$-invariant Radon measure on $M$, $\alpha$ acts strongly continuously on $L^p(\mu)$.

    We now consider $A \rtimes_\alpha G$, which contains $C_c(G \to A)$. Since
    $$(f *_\alpha g)(y) = \int_G f(x)\alpha(x)(g(x^{-1}y)) ~dx,$$
    it follows that
    $$(f *_\alpha g)(y)(m) = \int_G f(x)(m) g(x^{-1}y)(\alpha(x)^{-1}m) ~dx.$$
\begin{theorem}
    Let $M$ be a second-countable locally compact Hausdorff space, $A = C_\infty(M) \rtimes_\alpha G$. Let $\sigma$ be an irreducible nondegenerate representation of $A$ and let $(\pi, U)$ be the covariant representation of $\sigma$, $I = \ker \pi$. Let $Z \subseteq M$ be the hull of $I$. Then there is an $\alpha$-orbit whose closure is $Z$.
\end{theorem}
    Notice that $I$ is $\alpha$-invariant, hence an ideal of $A$. Expanding out the definitions, $I$ is the set of $f$ whose supports are disjoint from $Z$. In particular, $Z$ is closed and $\alpha$-invariant and $A/I = C_\infty(Z)$. The theorem says that there is a $m_0 \in M$ such that
    $$Z = \overline{\{\alpha(x)m_0: x \in G\}}.$$
\begin{example}
    For the irrational rotation, every orbit-closure is the entire circle, so for every ideal, the hull is the entire space. This generalizes to various ergodic actions.
\end{example}
\begin{proof}[Proof of theorem]
    Since $M$ is second-countable, so is $Z$. Let $\{B_n\}_n$ be open subsets of $M$ such that the $B_n \cap Z$ form a countable base for the topology of $Z$, $B_n \cap Z$ nonempty. Let
    $$O_n = \bigcup_{x \in G} \alpha(x)(B_n).$$
    Then the $O_n$ are open, $\alpha$-invariant, and meet $Z$.

    Let $J_n = C_\infty(O_n) \subseteq C_\infty(M)$. Since $O_n \cap Z$ is nonempty, there is a $f \in J_n$ which is not identically zero on $Z$, by Urysohn's lemma. So $\pi(J_n)$ is nonzero. Since $\sigma$ is nondegenerate, so is $\pi$, and $\pi(J_n)H$ generates a nonzero closed $\sigma$-invariant subspace. Since $\sigma$ is irreducible, $\pi(J_n)H$ generates $H$.

    Let $\xi$ be a unit vector of the representation space $H$. Define a Radon probability measure $\mu$ on $M$ by
    $$\int_M f~d\mu = \langle \pi(f)\xi, \xi\rangle.$$
    If $f \in I$, $f = 0$ $\mu$-almost everywhere. Therefore $Z$ contains the support of $\mu$. Since $M$ is second-countable, $J_n$ is a separable $C^*$-algebra and we can find a countable normalized approximate unit $\{e_{n,m}\}_m$ of $J_n$. We can assume that the $e_{n,m}$ are compactly supported in $O_n$. Since $\pi|_{J_n}$ is nondegenerate,
    $$\lim_{m \to \infty} \pi(e_{n,m})\xi = \xi.$$
    The $e_{n,m}$ are supported on $O_n$, so $O_n$ contains the support of $\mu$. Therefore
    $$\supp \mu \subseteq \bigcap_{n=1}^\infty O_n \cap Z.$$
    (Here we are using the cardinality assumption; the complements must be $\mu$-null and there are only countably many of them.)
    Since $\mu$ is a probability measure, $\supp \mu$ is nonempty.

    Let $m_0 \in \supp \mu$. Each of the $O_n$ is $\alpha$-invariant, so $\alpha_G(m_0) \subseteq \supp \mu$. So for each $n$, $\alpha_G(m_0) \subseteq O_n \cap Z$. Since $\alpha_G(m_0)$ is contained in every element of an open base of $Z$, $\alpha_G(m_0)$ is dense in $Z$.
\end{proof}
\begin{example}
    Let $M$ be the two-point compactification of $\RR$. Then the action of $\RR$ on $M$ by translation is jointly continuous, and $\RR$ is a dense orbit, but the boundary points $\pm \infty$ are fixed points. So not every point has a dense orbit. We will study $C(M) \rtimes \RR$ soon.
\end{example}
    Let $\alpha$ be an action of $G$ on $M$. For $m \in M$, let $G_m$ be the stabilizer of $m$. By the orbit-stabilizer theorem, the map
\begin{align*}
    G/G_m &\to \alpha_G(m)\\
    x &\mapsto \alpha_{xG_m}(x)
\end{align*}
    is a bijection (where $xG_m$ is the coset of $G_m$ by $x$). Now $G_m$ is a closed normal subgroup so $G/G_m$ is a locally compact group. In general the orbit-stabilizer map $G/G_m \to \alpha_G(m)$ is not a homeomorphism. It is favorable that the orbit of $x$ is open in its closure, in which case the orbit is locally compact.
\begin{theorem}
    Let $m_0 \in M$. If $G$ is a second countable group which acts on $M$ by $\alpha$, and $\alpha_G(m_0)$ is locally compact, then $G/G_{m_0} \to \alpha_G(m_0)$ is a homeomorphism.
\end{theorem}
\begin{proof}
    Use the Baire category theorem on the locally compact space $\alpha_G(m_0)$.
\end{proof}
    Let $H$ be a closed normal subgroup and let $M = G/H$. Then $G$ acts on $M$ by left translation, and $A = C_\infty(M) \rtimes G$ is a $C^*$-algebra. If $H = G$, then $A = C^*(G)$. If $H = 0$, then $A = C_\infty(G) \rtimes G$.

    In case $H = 0$, we study the covariant representation on $L^2(G)$ given by $U$ the left regular representation, $\pi$ the representation by pointwise representation; i.e.
        $$\pi(f)(\xi)(x) = f(x)\xi(x).$$
    To see covariance, we compute
    $$U(x)\pi(f)(\xi)(y) = \pi(f)(\xi)(x^{-1}y) = f(x^{-1}y) \xi(x^{-1}y) = \pi(\alpha(x)(f))(U(x)(\xi))(y).$$
\begin{definition}
    The \dfn{Schrodinger representation} of a group $G$ is the covariant representation $(\pi, U)$ of $C_\infty(G) \rtimes_G$ on $L^2(G)$ given above.
\end{definition}
    We compute the integrated form $\sigma$ of the Schrodinger representation by realizing that
    $$C_c(G \to A) = C_c(G \to C_\infty(G))$$
    is generated by $C_c(G \times G)$. Given $F \in C_c(G \times G)$ we have
    \begin{align*}\sigma(F)(\xi)(x) &= \left(\int_G \pi(F(y))U(y)(\xi) ~dy \right)(x)
    \\&= \int_G F(y, x) \xi(y^{-1}x) ~dy.
    \end{align*}
    Now $f, g \in C_c(G)$ can be viewed as elements of $L^2(G)$, which has a rank-$1$-operator-valued inner product $\langle\cdot,\rangle\cdot_0$. In fact,
    \begin{align*}\langle f, g\rangle_0(\xi)(x) &= f(x) \langle g, \xi\rangle(x) \\
    &= f(x) \int_G \overline{g(y)}\xi(y) ~dy
    \\&= \int_G f(x) \overline{g(y^{-1})} \xi(y^{-1}) \Delta(y^{-1}) ~dy\\
    &= \int_G f(x) g(y^{-1}x) \xi(y^{-1}x) \Delta(y^{-1}x) ~dy.
    \end{align*}
    We define
    $$\langle f, g\rangle_E (x, y) = f(x) \overline{g(y^{-1}x)} \Delta(y^{-1}x).$$
    Then this is an inner product which has values in $C_c(G \times G)$. Let $E$ be the (algebraic) span of
    $$\{\langle f, g\rangle_E: f,g \in C_c(G)\}.$$
    Thus
    $$\langle f, g\rangle_E * \langle h, k\rangle_E = \langle \langle f, g\rangle_E h, k\rangle_E$$
    and
    \begin{align*}\pi(\langle f, g\rangle_E) \pi(\langle h, k\rangle_E) &= \langle f, g\rangle_0 \langle f, g\rangle_0 = \langle \langle f, g\rangle_0 h, k\rangle_0 \\
    &= \langle g, h\rangle \langle f, k\rangle_0 = \pi(\langle g, h\rangle \langle f, k\rangle_E)
    \end{align*}
    allows us to define
    $$\langle f, g\rangle_E * \langle h, k\rangle_E = \langle g, h\rangle \langle f, k\rangle_E.$$
    This defines a convolution on $E$ which is compatible with the convolution on $C^*(G, C_\infty(G))$. Therefore $E$ is a subalgebra of $C^*(G, C_\infty(G))$. Clearly $E$ is a $*$-algebra since
    $$\langle f, g\rangle_E = \langle g, f\rangle_E.$$
    Moreover, $C_c(G)$ is dense in $L^2(G)$, so $\pi(E)$ is dense in $B_0(H)$.

    We claim that $E$ is also closed under pointwise multiplication. In fact,
\begin{align*}
    \langle f, g\rangle_E\langle h, k\rangle_E(x, y) &= f(x)\overline{(\Delta g)}(y^{-1}x) h(x) \overline{(\Delta k)}(y^{-1}x)\\
        &= f(x)g(x) \overline{\Delta g}k(y^{-1}x) \Delta(y^{-1}x).
\end{align*}
    Clearly $E$ is closed under complex conjugation and separates points of $G \times G$ from zero. Thus we can apply the Stone-Weierstrass theorem, but this is not very interesting because we actually want to prove that $E$ is dense in $C_c(G \times G)$ for the inductive limit topology. In fact, if $O$ is an open, precompact subset of $G \times G$, we can find $V \times W \subseteq G \times G$, where $V,W$ are open, precompact subsets of $G$ and consider the algebraic span of $\langle C_c(V), C_c(W)\rangle_E$. By the Stone-Weierstrass theorem, this is $L^\infty$-dense in $C_c(V \times W)$. One can then check that $E$ is dense in $L^1(G \to C_\infty(G))$ and hence dense in $C^*(G, C_\infty(G))$.

    We claim that $E$ has the same operator norm as $C^*(G, C_\infty(G))$. In fact if $f_1, \dots, f_n$ are an $L^2$-orthonormal set in $C_c(G)$ then the $\langle f_j, f_k\rangle_0$ span the $C^*$-algebra $\CC^{n \times n}$ once we choose a basis. On $C^*$-algebras the operator norm is uniquely determined, so $E$ agrees with $C^*(G, C_\infty(G))$ in operator norm on any finite-dimensional subalgebra. Such matrix algebras can be used to approximate $C^*(G, C_\infty(G))$ so we have proven the claim. We consider that we have proven the following theorem.
\begin{theorem}
    $C_\infty(G) \rtimes G = B_0(L^2(G))$.
\end{theorem}
    Since $B_0(L^2(G))$ has no proper ideals, one also has $C_\infty(G) \rtimes^r G = B_0(L^2(G))$. Therefore the translation action is amenable.
\begin{example}
    If $G$ is not an amenable group, then $G$ still admits an amenable action by translation.
\end{example}
    Now if $G$ acts on $X$ by $\alpha$, and $O$ is an orbit of $\alpha$, then if $O$ is an orbit which is open in its closure, $C_\infty(O) \subseteq C(\overline O)$. Moreover, $C_\infty(O) \rtimes_\alpha G = B_0(L^2(G))$.
\begin{example}
    Let $\RR$ act on its two-point compactification $X$ by translation. Then $C_\infty(X) = C(X)$ contains $C_\infty(\RR)$. So
    $$C(X) \rtimes \RR \supset C_\infty(\RR) \rtimes \RR = B_0(L^2(\RR))$$
    which gives a GCR representation of $C(X)$ on $L^2(\RR)$. It is not CCR because $C(X)$ is unital.

    If we instead look at the orbits of $\pm \infty$, we see that $C^*(\RR) = C(\pm\infty) \rtimes_\alpha \RR$. By the Fourier transform, $\widehat{C^*(\RR)} = \RR$. (More generally, if $G$ is a locally compact abelian group, then $C^*(G)$ is a commutative $C^*$-algebra, $\widehat{C^*(G)}$ consists of one-dimensional representations of $G$, which are exactly the continuous morphisms $G \to S^1$.)
\end{example}
\begin{definition}
    Let $H$ be a closed normal subgroup of $G$. For simplicity we assume that the Haar measure on $G/H$ is $G$-invariant. Let $V: H \to U(K)$ be a unitary representation. We define a Hilbert space by taking all functions $\xi: G \to K$ such that for all $x \in G$, $s \in H$, $\xi(xs) = V(s)^* \xi(x)$ where we define $\langle \xi, \eta\rangle(x) = \langle \xi(x), \eta(x)\rangle$. Since $\langle \xi, \eta\rangle$ is constant on cosets, it drops to a function on $G/H$ such that
    $$\langle \xi, \eta\rangle(x) = \int_{G/H} \langle \xi, \eta\rangle(x) ~dx.$$
    We take the Hilbert space to be all $\xi$ such that $\langle \xi, \xi\rangle < \infty$, which $G$ acts on by left translation. This action of $G$ is called the \dfn{induced representation} of $G$ from $V$, $\Ind V$.
\end{definition}
    If $H,V$ are as above, $\alpha$ the action of $G$ on $C_\infty(G/H)$ by left translation, then we obtain a covariant representation of $\alpha$ on the induced representation space by letting $C_\infty(G/H)$ act by left translation and $\lambda$ be the left action of $G$ on $G/H$. Then $(C_\infty(G/H), \lambda)$ is a covariant representation of $\alpha$.

    Let $G$ be a unimodular group (though the same argument goes through without too much trouble otherwise). Recall that $C_c(G/H \to G) \subseteq C(G/H) \rtimes_\alpha G$. We define for $f, g \in C^*(H)$,
    $$\langle f, g\rangle_{C^*(H)} = f^* * g|_H.$$
    Here we are using continuity; if $H$ is a Haar null set then the restriction map is not defined for measurable functions in general. Let $B = C_c(G/H \to G)$. Then we can define
    $$\langle f,g\rangle_B h = f \langle g, h\rangle_{C^*(H)}.$$
    One can then prove $C(G/H) \rtimes_\alpha G$ is strongly Morita equivalent to $C^*(H)$. This theory generalizes to when $G$ is merely a groupoid rather than a group.
\section{Semidirect products of groups}
\begin{definition}
    If $N$ and $Q$ are locally compact groups, and $\alpha: Q \to \Aut(N)$ a jointly continuous action, then we define $N \rtimes_\alpha Q$ as follows. As a Hausdorff space, $N \rtimes_\alpha Q$ is the product of topological spaces $N \times Q$. The group operation is defined by
    $$(n_1, q_1)(n_2, q_2) = (n_1\alpha(q_1)(n_2), q_1q_2).$$
    Then $N \rtimes_\alpha Q$ is the \dfn{semidirect product} of locally compact groups.
\end{definition}
    We remember the group operation on $N \rtimes_\alpha Q$ by recalling that ``whenever we want to commute an $n$ and a $q$, the $q$ must act on the $n$."

    Let $G = N \rtimes_\alpha Q$. Then $Q$ and $N$ embed in $G$ in the obvious way and we have a split exact sequence
    $$0 \to N \to G \to Q \to 0.$$
    Therefore any representation of $G$ restricts to representations of $N$ and $Q$. Moreover, $Q$ acts on $N$ by inner automorphisms, i.e.
    $$qnq^{-1} = \alpha(q)(n).$$
    The action of $q$ does not preserve Haar measure, but it does send Haar measure to a translation-invariant measure; i.e. it multiplies Haar measure by a scalar, say $\sigma(q)$.

    We now define an action of $Q$ on $C^*(N)$. In fact, for $f \in C_c(N)$, $n \in N$, $q \in Q$,
    $$\alpha(q)(f)(n) = \sigma(q)f(\alpha(q)(n)).$$
    Then $\alpha(q)$ is an isometry in $L^1$-norm, so $Q$ acts on $L^1(N)$ by isometries. This action $\alpha$ immediately extends to $C^*(N)$.

    Let $U$ be a unitary representation of $G$. Restricting, we obtain representations of $C^*(N)$ and $Q$, and $U$ is a covariant representation of $\alpha: Q \to \Aut(C^*(N))$. Conversely, a representation of $C^*(N) \rtimes_\alpha Q$ gives rise to a covariant representation of $\alpha$. Then
    $$C^*(N) \rtimes_\alpha Q = C^*(G).$$
    This can be remembered as $C^*(N) \rtimes_\alpha Q = C^*(N \rtimes_\alpha Q)$.

    Let $N$ be an abelian group. Then $C^*(N) = C_\infty(\hat N)$ (where $\hat N$ denotes the Fourier transform, $\hat N = \Hom(N, S^1)$ in the category of locally compact groups). Since $Q$ acts on $N$ and hence $C^*(N)$, $Q$ also acts on $\hat N$. In fact if $\varphi \in \hat N$, then
    $$\alpha(q)(\varphi)(n) = \varphi(\alpha(q^{-1})(n)).$$
    Then $C^*(N \rtimes_\alpha Q) = C_\infty(\hat N) \rtimes_\alpha Q$. Thus we are back in the original situation of a locally compact group acting on a locally compact space.
\begin{example}[Wigner 1939]
    Let $L$ be the \dfn{Lorentz group}, the automorphism group of Minkowski spacetime (linear automorphisms that preserve the Lorentzian metric $g(x, y) = -x_0y_0 + x_1y_1 + x_2y_2 + x_3y_3$.) Then $L$ acts on $\RR^4$, so we have a semidirect product $\RR^4 \rtimes L$, the \dfn{Poincare group}. The unitary representations of the Poincare group are important in relativistic quantum mechanics. Elementary particles ``should be" completely determined by their symmetries, so correspond to representations of certain stabilizers of $\RR^4 \rtimes L$. This paper led to the discovery that electrons have spin. In principle one could use the representation theory of $\RR^4 \rtimes L$ to rederive the periodic table of elements.
\end{example}

\section{The Heisenberg commutation relations}
We now look at an algebra with ``invalid" generators and relations.

In quantum physics, the position $q$ and momentum $p$ observables act on certain dense subspaces of tensor powers of $L^2(\RR)$ with
    $$[p, q] = i\hbar.$$
They must be unbounded operators, since their commutator is a scalar. So $q, p$ are not elements of a $C^*$-algebra. This relation is called the \dfn{Heisenberg commutation relation}.

We want to be able to form the holomorphic functional calculus for an unbounded operator $T$. In particular, we would like to define a one-parameter unitary group by the group morphism $t \mapsto e^{itT}$.
\begin{example}
    The Schrodinger equation is the PDE that says that if $H$ is the Hamiltonian, the action of its one-parameter unitary group $t \mapsto e^{itH}$ is the time-advance map.
\end{example}
Reasoning just formally about how the holomorphic functional calculus should behave, we let $U(s) = e^{isP}$ and $V(t) = e^{itQ}$. Weyl observed that
$$U(s) V(t) U(s)^* = e^{itU(s)QU(s)^*}$$
so we let
$$\varphi(s) = U(s)QU(-s).$$
Then
$$\varphi'(s) = iU(s)(PQ - QP)U(-s) = -\hbar.$$
So $\varphi(s) = Q - s\hbar$ whence
$$U(s)V(t) = e^{itQ}e^{-i\hbar ts}U(s) = e^{-i\hbar st} V(t) U(s).$$

Recall that $\hat \RR \cong \RR$ (noncanonically). If we let $\langle\cdot,\cdot\rangle$ be the pairing of $\RR$ and $\hat \RR$, then we have just proved
$$U(s)V(t) = \langle s, t\rangle V(t)U(s).$$
Here the choice of isomorphism is induced by some normalization of the Fourier transform.

\begin{definition}
Let $G$ be an locally compact abelian group. By a \dfn{representation for the Heisenberg commutation relations} of $G$ we mean a pair of unitary representations $(U, V)$, $U: G \to \Aut(H)$, $V: \hat G \to \Aut(H)$, such that
$$U(s)V(t) = \langle s, t\rangle V(t)U(s).$$
\end{definition}
Any unitary representation $V$ of $\hat G$ lifts to a representation $\pi$ of the commutative $C^*$-algebra $C^*(\hat G)$, which is $C_\infty$ of the double dual of $G$. By the Pontryagin duality theorem, the double dual of any locally compact abelian group is itself, so $C^*(\hat G) = C_\infty(G)$. Let $f = \hat h \in C_\infty(G)$ for some $h \in L^1(G)$. Then
$$\pi(f) = \int_{\hat G} h(t) V(t) ~dt.$$
Therefore
\begin{align*}
    U(s)\pi(f)U(s)^* &= \int_{\hat G} h(t) U(s)V(t)U(s)^* ~dt = \int_{\hat G} h(t) \langle s, t\rangle V(t) ~dt\\
        &= \pi(\alpha_s(f))
\end{align*}
where $\alpha$ is the action of $G$ on $C_\infty(G)$ by left translation. So $(\pi, U)$ is a covariant representation of $\alpha$ and hence a representation of $C_\infty(G) \rtimes_\alpha G = B_0(L^2(G))$. But $B_0(L^2(G))$ only has one irreducible representation, which turns out to be the Schrodinger representation. This shows that the Heisenberg picture and the Schrodinger picture are equivalent. This is a theorem of von Neumann which was important to the foundations of physics.

\section{Projective representations}
Let $W: G \times \hat G \to U(H)$ be defined by
$$W(s, t) = U(s)V(t),$$
where $(U, V)$ is a representation for the Heisenberg commutation relations. Then
\begin{align*}
W(s, t) W(s', t') &= U(s)V(t)U(s')V(t') = -U(s + s') V(t) \langle s', t\rangle V(t')\\
&= \langle s', t\rangle U(s + s') V(t + t') = \langle s', t\rangle W(s + s', t + t').
\end{align*}

\begin{definition}
    Let $G$ be a group. A \dfn{projective representation} of $G$ is a continuous function $W: G \to U(H)$ defined by
    $$W(x)W(y) = c(x, y)W(xy)$$
    for some $c: G^2 \to S^1$.
\end{definition}
Here we are thinking of $S^1$ as the unit circle subgroup of $\CC$. It is a morphism up to a harmless constant. In fact, if $\PP H$ is the projective space of some Hilbert space, then every projective representation drops to a morphism of groups $G \to \Aut(\PP H)$, since it permutes the one-dimensional subspaces. Wigner proved that every automorphism of $\PP H$ is given by a unitary or antiunitary (i.e. conjugate linear) operator. If $P$ is a rank-$1$ projection, then $P$ is sent to $UPU^{-1}$ by any such automorphism, for $U$ a unitary or antiunitary operator.
\begin{example}
    Charge-conjugation, parity, and time-reversal are examples of antiunitary operators in quantum field theory.
\end{example}
So we have constructed a projective representation of $G \times \hat G$.

Up to a normalization we may assume $U_1 = 1$.

Given $d: G \to S^1$, set $V(x) = d(x)U(x)$. Then
$$V(x)V(y) = d(x)d(y)U(x)U(y) = d(x)d(y)\overline{d(xy)}V(xy).$$
Associativity of $\Aut(\PP H)$ manifests as
$$c(xy, z) c(x, y) = c(x, yz) c(y, z).$$
We say that $c$ is a \dfn{$2$-cocycle} for $G$ valued in $S^1$.

\begin{example}
    Let $C_k$ be the set of all functions $G^k \to S^1$. The \dfn{boundary operator for the homology of groups} with values in $S^1$ is defined by $\partial: C_1 \to C_2$ by
    $$\partial d(x, y) = d(x)d(y)d(xy),$$
    and $\partial: C_2 \to C_3$ by
    $$\partial d(x, y, z) = c(xy, z)c(x, y)\overline{c(x, yz)c(y, z)}.$$
    This extends to a homology theory for all $k$. Here $S^1$ can be replaced by any abelian group. If $c' = (\partial d) c$, then $c'$ and $c$ are homologous.
\end{example}

Assume that for all $\xi \in H$, $x \mapsto U(x)(\xi)$ is measurable. Then for every $f \in L^1(G)$, we define
$$U(f)(\xi) = \int_G f(x)U(x)(\xi) ~dx.$$
Then $||U(f)|| = ||f||_{L^1}$ and $U(f)U(g) = U(f*_cg)$ where $*_c$ is the twisted convolution defined by
$$f *_c g(x) = \int_G f(y) g(y^{-1}x)c(y, y^{-1}x) ~dy.$$
So $L^1(G, c)$ (which is $L^1$ with the twisted convolution $*_c$) is a Banach algebra, which is not commutative even if $G$ is abelian. If $c$ is homologous to $c'$ then we have an isomorphism $L^1(G, c) \to L^1(G, c')$.

Given a $2$-cocycle $c$ we can consider all projective representations of $G$ where the $2$-cocycle is homologous to $c$. In these cases, the isomorphism of Banach algebras above implies that we can assume that the $2$-cocycle is actually $c$. For $f \in L^1(G, c)$, this defines the $C^*$-norm by
$$||f||_{C^*(G, c)} = \sup_U ||U(f)||$$
where $U$ ranges over all projective representations whose cocycles are homologous to $c$. Here we have a twisted adjoint, which for unimodular groups can be explicitly expressed as
$$f^*(x) = \overline{f(x) c(x, x^{-1})}.$$

We have a left regular representation $L: L^1(G, c) \to L^2(G)$ defined by
$$L(f)(\xi)(x) = \int_G f(y) \xi(y^{-1}x) c(y, y^{-1}x) ~dy.$$
This gives rise to the reduced $C^*$-algebra $C^*_r(G, c)$.

\begin{example}
    Let $G = \RR^n \times \widehat{\RR^n}$. We define the cocycle $c((x, s), (y, t)) = \langle (x, s), (y, t)\rangle$. We already saw that $C^*(G, c) \cong B_0(L^2(G))$ in an unnatural way, by uniqueness of the Heisenberg commutation relation. Now $G$ is abelian, but $B_0(L^2(G))$ is far from commutative.
\end{example}

\begin{example}
    Let $G = \ZZ^n$. Then every cocycle is homologous to a \dfn{bicharacter}, a cocycle $c$ of the form
    $$c(m, \ell) = e^{\langle im, \Theta \ell\rangle}$$
    where $\Theta \in \RR^{n \times n}$.

    When we study $G$ we will assume without loss of generality that $c$ is a bicharacter. Henceforth we will mainly be interested in discrete groups, but really we are actually studying $\ZZ^n$.
\end{example}
    If $G$ is a discrete group with a cocycle $c$, we can define a faithful tracial state $\tau$ on $\ell^1(G, c)$ (hence on $C^*(G, c)$) by $\tau(f) = f(e)$. Moreover, $\delta_1$ is the identity of $\ell^1(G, c)$, and $\tau(f *_c f^*) = \sum_{y \in G} |f(y)|^2$. From this it follows that the GNS construction for $\tau$ gives a faithful representation $\ell^1(G, c) \to \ell^2(G)$, so extends to a representation $C^*(G, c) \to \ell^2(G)$.

    If $G$ is discrete and abelian, then $\hat G$ is compact, and we have an action $\hat \alpha: G \to \Aut(C^*(G, c))$,
    $$\hat \alpha(t)(f)(x) = \langle x, t\rangle f(x).$$
    Then
    $$\hat \alpha(t)(f *_c g)(x) = \hat\alpha(t)(f) *_c \hat\alpha(t)(g)(x).$$

    To study the properties of this action $\hat \alpha$, $G$ be a compact group with its Haar probability measure, and $\alpha: G \to \Aut A$ an action. Then we define $P: A \to A$,
    $$P(a) = \int_G \alpha(x)(a) ~dx.$$
    Then $P$ is $\alpha$-invariant, $\alpha(y)(P(a)) = P(a)$. In particular, if we let $A^G$ be the algebra of all fixed points of $\alpha$, $P$ carries $A$ into $A^G$. Conversely, if $a$ is actually a fixed point, then $P(a) = a$. So $P$ is the projection map $A \to A^G$.
\begin{definition}
    Assume $B \subseteq A$, and $P: A \to B$ is a projection. If for every $b \in B$, $a \in A$, $P(ab) = P(a)b$ and $P(ba) = bP(a)$, we say that $P$ is a \dfn{conditional expectation}.
\end{definition}
    It is easy to check that the projection $P: A \to A^G$ is a conditional expectation. Moreover, if $a > 0$ then $P(a) > 0$.

    If $G$ is a compact abelian group (in applications, $G$ is usually a torus), then $\hat G$ is discrete (in applications, $\ZZ^n$). We let $\alpha$ be an action of $G$ on $A$. For each $t \in \hat G$, set
    $$a_t = \int_G \langle x, t\rangle \alpha_x(a) ~dx.$$
    So the $a_t$ are the generalized Fourier coefficients of $a$. We have
    $$\alpha(y)(a_t) = \alpha(y)\left(\int_G \overline{\langle x, t\rangle} \alpha(x)(a) ~dx\right) = \int_G \overline{\langle y^{-1x}, t\rangle} \alpha(x)(a) ~dx = \langle y, t\rangle a_t.$$
    We now set $A_t = \{a \in A: \forall y ~\alpha(y)(a) = \langle y, t\rangle a\}$. Then $a_t \in A_t$ and $A_t$ is a closed subspace, hence a $C^*$-algebra. For $a \in A_t$, $b \in A_s$, we have
    $$\alpha(y)(ab) = \alpha(y)(a)\alpha(y)(b) = \langle y, t\rangle \langle y, s\rangle ab = \langle y, ts\rangle ab$$
    so $ab \in A_{ts}$.

\chapter{Noncommutative geometry}
\section{Quantum tori}
Fix $\Theta \in \RR^{d \times d}$ and let $c_\Theta(m, n) = e^{2\pi im\cdot\Theta n}$, for $(m, n) \in \ZZ^{d + d}$. Then $c_\Theta$ is a cocycle for the duality of $\ZZ^d$ and the torus $T^d$. In fact the pairing is given by
$$c_\Theta = \langle m, \Theta n\rangle.$$
\begin{definition}
    The $C^*$-algebra $A_\Theta = C^*(\ZZ^d, c_\Theta)$ is called the algebra of functions on the \dfn{noncommutative torus} or \dfn{quantum torus} of dimension $d$.
\end{definition}
Now
$$\delta_m * \delta_n * \delta_m^* = \langle n, (\Theta - \Theta^t)m\rangle \delta_n.$$
So we can reasonably define
$$\rho_\Theta(m) = (\Theta - \Theta^t)m \in T^d.$$
We now define
$$H_\Theta = \overline{\{\rho_\Theta(m) \in T^d: m \in \ZZ^d\}}.$$
Then $H_\Theta$ is an subgroup of $T^d$, so $\rho_\Theta: \ZZ \to T^d$ is a morphism of groups. It gives rise to an action $\alpha$ of $H_\Theta$ on $A$ defined by
$$\delta_m a \delta_m^* = \alpha(\rho_\Theta(m))(a).$$

\section{The 2-torus}
\begin{theorem}
    If $H_\Theta = T^d$ then $A_\Theta$ is simple.
\end{theorem}
\begin{proof}
If $I$ is a closed ideal of $A_\Theta$ then $I$ is closed under conjugation, hence under the action of $H_\Theta$. Now $A_\Theta$ is a space of noncommutative functions on $T^d$ so we're done.
\end{proof}

\begin{example}
    If $d = 2$, we take $\Theta = \begin{bmatrix}&\theta\\0&\end{bmatrix}$. Then $\Theta - \Theta^t = \begin{bmatrix}&\theta\\-\theta&\end{bmatrix}$. So
    $$\rho_\Theta(m_1, m_2) = (\theta m_2, -\theta m_1).$$
    If $\theta$ is irrational then $\{\theta m_2: m_2 \in \ZZ\}$ is dense in $S^1$. Therefore $\rho_\Theta$ acts densely on $T^2$. So if $\Theta$ is irrational then $A_\Theta$ is simple.

    Let $M = S^1$, $\theta \in \RR$, $\alpha$ the action of $\ZZ$ on $M$ by rotation by $\theta$. Then $C(M) \rtimes_\alpha \ZZ$ is a rotation algebra, i.e. it is the universal $C^*$-algebra generated by a unitary, namely $U = e^{2\pi i t}$. If $V$ is the unitary acting on $C(M)$ by $Vf = \alpha(1)(f)$ (so translation by $\theta$), then $VU = e^{2\pi i\theta}UV$. One can then show that
    $$C(M) \rtimes_\alpha \ZZ = C^*(\ZZ^2, c_\Theta)$$
    where $\Theta = \begin{bmatrix}&\theta\\-\theta&\end{bmatrix}$. So this is another construction of $A_\Theta$.

    If $\theta$ is irrational, then $\alpha$ is a free action (i.e. all stabilizers are trivial). We now define a morphism $C(M) \to C_b(\ZZ)$ by $\tilde f(n) = f(\alpha(n)(t_0))$ for some fixed $t_0 \in M$. Now $C_b(\ZZ)$ acts on $\ell^2(\ZZ)$ by multiplication and $\ZZ$ acts on $\ell^2(\ZZ)$ by translation. This gives a covariant representation of $\alpha$ on $\ell^2(\ZZ)$. One can then show using certain commutation relations that the covariant representation is irreducible, hence gives an irreducible representation of $A_\Theta$. This depends on the orbit of $t_0$, so we construct uncountably many irreducible representations of $A_\Theta$, all of which have kernel $0$ since $A$ is simple.

    Thus we have constructed a $C^*$-algebra with lots of irreducible representations that have the same primitive ideal but are not unitarily equivalent. There are even more irreducible representations that we have not treated.

    If $\theta$ is rational then every orbit is finite, and $C(M) \rtimes_\alpha \ZZ$ is a continuous field of $d \times d$ matrix algebras, which is not isomorphic to $C(T^2 \to M^d)$.
\end{example}

\begin{example}
    Let $M$ be a compact Hausdorff space, $G$ a finite group, $\alpha$ a free action of $G$ on $M$. Then $M/\alpha$ is a compact Hausdorff space and we have a Morita equivalence $C(M) \rtimes_\alpha G \to C(M/\alpha)$. ``Most" of noncommutative algebraic topology is only defined up to Morita equivalence, so from the point of view of an algebraic topologist, $C(M) \rtimes_\alpha F = C(M/\alpha)$. This is a very unusual situation!

    If $G$ is an infinite group instead, then $M/\alpha$ may not be Hausdorff (for example, if $G$ is a Lie group which foliates $M$ badly). Then $C(M/\alpha)$ may not be a $C^*$-algebra, so we have no way of studying its algebraic topology. We can still find topological invariants of the dynamical system $\alpha$ by instead studying the topology of $C(M) \rtimes_\alpha G$.
\end{example}

\begin{example}
    Let $H = U + U^* + r(V + V^*)$ where $U,V$ are the generating unitaries of the $2$-dimensional quantum torus. In physics, $U + U^*$ is the potential energy, $r(V + V^*)$ is the kinetic energy, $r$ ``electron coupling", and $H$ the Hamiltonian. Hofstadter (of Godel-Escher-Bach fame) showed that if $\theta$ is rational but with large denominators, then the spectrum of $H$ approximates a Cantor set. So he conjectured that if $\theta$ is irrational then the spectrum is Cantor space. Katz offered $10$ martinis for anyone who could prove this, which was known as the \dfn{ten martinis conjecture}. Avila et al. proved the ten martinis conjecture.
\end{example}

If $\delta_m \in Z(A_\Theta)$ then $\alpha(\rho_\Theta(m))$ is the identity. So for all $n$,
$$1 = \langle n (\Theta - \Theta^t)m \rangle = \langle(\Theta^t - \Theta)n, m\rangle$$
so $m$ lies in the dual group $H_\Theta^\perp$ of $H_\Theta$. One can then show that $Z(A_\Theta) = C^*(H_\Theta^\perp) = C(\widehat{H_\Theta^\perp})$. Then we can express $A_\Theta$ as a continuous field over $C(\widehat{H_\Theta^\perp})$.

\section{Noncommutative smooth manifolds}
We now take the theory of Lie groups and smooth manifolds and turn it into a noncommutative theory.

Let $G$ be a Lie group. We can always assume that $G$ is a closed, connected subgroup of $\GL(\RR^n)$. In fact $\GL(\RR^n)$ can be obtained by applying the exponential map to $\RR^{n \times n}$; i.e. the exponential of a matrix is an invertible matrix. We therefore define $\Lie G = \{X \in \RR^{n \times n}: \forall t \in \RR~e^{tX} \in G\}$. Then $\Lie G$ is a Lie algebra and $\Lie$ is the functor that sends a Lie group to its Lie algebra. Besides, $\exp: \Lie G \to G$ is the exponential map (in the sense of Riemannian geometry), so is close to the identity of $G$ a homeomorphism.

Given $X \in \Lie G$, $t \mapsto e^{tX}$ is a morphism of groups $\RR \to G$; i.e. a \dfn{smooth one-parameter subgroup} of $G$. In fact every one-parameter subgroup is of this form, though we note that $t \mapsto e^{tX}$ may not be injective. (For example $S^1$ is a one-parameter subgroup which is periodic.)

\begin{example}
    $\Lie T^d = \RR^d$.
\end{example}
Let $\alpha$ be a strongly continuous action of $\RR$ by isometries on a Banach space $B$. Let $b \in B$. Then we have a one-parameter semigroup $r \mapsto \alpha(r)(b)$.

\begin{definition}
    Let $G$ be a Lie group and $\alpha$ a strongly continuous action of $G$ by isometries on a Banach space $B$. Given $X \in \Lie G$, $b \in B$, $X \mapsto \alpha(X)(b)$, the \dfn{directional derivative} is
    $$D_Xb = \lim_{r \to 0} \frac{\alpha(\exp(rX))(b) - b}{r}.$$
    We let $B^\infty$ be those $b \in B$ such that every higher directional derivative $D_{X_1} \cdots D_{X_n} b$ exists.
\end{definition}
\begin{theorem}[Garding]
    \index{Garding's theorem}
    Let $f \in C^\infty_{comp}(G)$, $f$ supported in a small enough neighborhood of the identity. Given $b \in B$, then the integrated form $\alpha(f)(b) \in B^\infty$.
\end{theorem}
\begin{proof}
    Let $X \in \Lie G$. Then
\begin{align*}D_X(\alpha(f)(b)) &= \lim_{t \to 0} \frac{\alpha(\exp(tX))(\alpha(f)(b)) - \alpha(f)(b)}{t} \\
    &= \lim_{t \to 0} \frac{1}{t}\left(\alpha(\exp(tX))\int_G f(x)\alpha(x)(b) ~dx - \int_G f(x)\alpha(x)(b) ~dx \right)\\
    &= \lim_{t \to 0} \frac{1}{t}\left(\int_G f(\exp(-tX)x) \alpha(x)(b) ~dx - \int_G f(x) \alpha(x)(b) ~dx\right)\\
    &= \lim_{t \to 0} \int_G \frac{f(\exp(-tX)x) - f(x)}{t} - \alpha(x)(b) ~dx\\
    &= \int_G D_{-X}f(x)\alpha(x)(b) ~dx.
    \end{align*}
    So $\alpha(f)(b)$ is once differentiable. Now use the fact that
    $$D_YD_X\alpha(f)(b) = \alpha(D_YD_Xf)(b)$$
    to see that $\alpha(f)(b)$ twice differentiable and induct.
\end{proof}
\begin{corollary}
    $B^\infty$ is dense in $B$.
\end{corollary}
\begin{proof}
    Choose an action $\alpha$ and let $f_n \in C^\infty_{comp}(G)$ be an approximate identity for $L^1(G)$. Then the sequence of $\alpha(f_n)(b)$ approximates $b$ arbitrarily well.
\end{proof}
    Let $A$ be a Banach algebra. If $\alpha$ is a strongly continuous action by algebra homomorphisms of the Lie group $G$, then for $a,b \in A^\infty$, $X \in \Lie G$, the directional derivative $D_X$ is a derivation of $A$. It is reasonable to think of the space of derivations of $A$ as ``vector fields on the noncommutative space $\hat A$," assuming that the space of derivations has the structure of a $A$-module. But in general, it is only a $Z(A)$-module. Therefore, in general, we cannot define the tangent bundle of a noncommutative smooth manifold.
\begin{example}
    Let $G = T^d$ so $\hat G = \ZZ^d$ and $\Lie G = \RR^d$, and let $\alpha$ be an action of $G$ on a Banach space $B$. Let $b \in B^\infty$. Then
\begin{align*}
    \alpha(f)(D_Xb) &= \lim_{t \to 0} \int_G f(x) \alpha(x)\left(\frac{\alpha(\exp(tX))(b) - b}{t}\right) ~dx\\
        &= \lim_{t \to 0} \int_G \frac{(f(x \exp(-tX)) - f(x))\alpha(x)(b)}{t} ~dx = \alpha(D_Xf)(b)
\end{align*}
    where we used the fact that $G$ is abelian, hence unimodular. (This formula is therefore true for any unimodular group.) The Fourier transform of $b$ is given by
    $$(D_Xb)_n = \alpha(e_n)(D_Xb) = -\alpha(D_Xe_n)(b) = 2\pi inXb_n$$
    where
    $$e_n(t) = e^{2\pi int},$$
    and the multiplication of $\ZZ^d$ and $\RR^d$ is given by the dot product.

    Let the Laplacian $\Delta$ act on $B^\infty$ by
    $$(\Delta b)_n = \sum_j (2\pi)^2 (nE_j)^2 b_n$$
    where the $E_j$ form a basis for $\RR^d$. Then for $k \in \NN$,
    $$((1 + \Delta)^k b)_n = \left(1 + (2\pi)^2 \sum_j (nE_j)^2\right)^k b_n$$
    so
    $$b_n = \frac{((1 + \Delta)^kb)_n}{(1 + (2\pi)^2\sum_j(nE_j)^2)^k}$$
    whence
    $$||b_n|| \leq \frac{||(1+ \Delta)^kb||}{(1 + (2\pi)^2\sum_j (nE_j)^2)^k}.$$
    Therefore if $p$ is a polynomial on $\ZZ^d$,
    $$p(n)||b_n|| \leq \frac{|p(n)|\cdot ||(1 + \Delta)^kb||}{(1 + (2\pi)^2 \sum_j (nE_j)^2)^k}$$
    and if $k$ is large enough, it follows that $n \mapsto |p(n)|||b_n||$ is bounded (since $(1 + \Delta)^kb$ is independent of $n$). Since $p$ can grow arbitrarily fast, the function $n \mapsto ||b_n||$ lies in $C_\infty(\ZZ^d)$. In fact it lies in the Schwartz space of $C_\infty(\ZZ^d)$.
\end{example}
\begin{theorem}
    Let $b \in B$. Then $b \in B^\infty$ if and only if $n \mapsto ||b_n||$ is a Schwartz function on $\ZZ^d$.
\end{theorem}
\begin{example}
    Recall that $A_\Theta = C^*(\ZZ^d, c_\Theta)$. Then $a_n \in \CC$ and $c_\Theta$ is an action of $T^d$, so $A_\Theta^\infty$ is isomorphic to the Schwartz space of $\ZZ^d$.
\end{example}
    We now introduce noncommutative differential forms. Given $a \in A^\infty$, let $da: \Lie G \to A$ be given by
    $$da(X) = \alpha(X)(a).$$
    Then $d$ is a derivation. We let $\tilde \Omega$ be the space of linear maps $\Lie G \to A$, viewed as a $(A, A)$-bimodule. Then let $\Omega$ be the submodule generated by $d$; i.e. linear combinations of elements of the form $a~db$, i.e. $1$-forms on $A$.
\begin{definition}
    Let $A$ be a $C^*$-algebra. The $(A,A)$-bimodule $\Omega$ is known as the \dfn{noncommutative cotangent bundle} of $A$.
\end{definition}
    From this it is not difficult to define the higher exterior power $\Omega^k$ and define the boundary map
    $$d: \Omega^k \to \Omega^{k+1}.$$

\section{Noncommutative vector bundles}
    Let $X$ be a compact Hausdorff space, $E$ a vector bundle over $X$, and let $\Gamma(E)$ be the vector space of continuous sections of $E$. Given $\xi \in \Gamma(E)$ and $f \in C(X)$, $(f\xi)(x) = f(x)\xi(x)$ by scalar multiplication so $\Gamma(E)$ is a $C(X)$-module.

    In this section we will assume all $C(X)$-modules are finitely generated.
\begin{definition}
    Let $R$ be a unital ring. A \dfn{projective module} over $R$ is a $R$-module $V$ which is isomorphic to a direct summand of a free $R$-module.
\end{definition}
    In other words, if $V$ is free then there is a $R$-module $W$ and a free $R$-module $F$ such that $V \oplus W \cong F$.
\begin{theorem}[Swan]
    \index{Swan's theorem}
    Let $X$ be a compact Hausdorff space. A $C(X)$-module $V$ is projective if and only if there is a vector bundle $E$ such that $V \cong \Gamma(E)$. Moreover, we have an isomorphism of vector bundles $E \cong F$ if and only if $\Gamma(E) \cong \Gamma(F)$.
\end{theorem}
    So we have an equivalence of categories relating projective $C(X)$-modules and vector bundles over $X$. Though Swan proved this result in 1962, by this time Grothendieck had already started identifying projective modules with vector bundles over algebraic varieties.

    Let $R$ be a ring. If we view $R^n$ as a right $R$-module, then $\End_R(R^n) \cong M_n(R)$, where $M_n(R)$ is viewed as acting on $R^n$ from the left. So we usually will view $R^n$ as a right $R$-module. Henceforth we assume that every ring acts on its modules from the right.

    If $V$ is a projective module which appears as a direct summand in $R^n$, then there is a projection $P \in \End_R(R^n)$ such that $P(R^n) \cong V$. This is not a bijection between projections and projective modules, but it is often useful. Indeed, for any projection $P$, $P(R^n)$ is a projective $R$-module.
\begin{example}
    Let $R = C(X)$, $P \in M_n(R)$ a projection. Then $P$ acts on $R^n = C(X \to \CC^n)$. So $P(R^n)$ is a projective module, and we can find the vector bundle from Swan's theorem by looking at its localizations.
\end{example}
    If $R$ is a unital ring, let $S(R)$ be the space of isomorphism classes of projective $R$-modules. For $V,W$ isomorphism classes, define $V + W = V \oplus W$. Then $S(R)$ is an abelian monoid, and $S$ is a functor from unital rings to abelian monoids. But $S(R)$ is badly behaved because $V \oplus W \cong V' \oplus W$ does not imply $V \cong V'$.
\begin{example}
    Let $T$ be the circle, $A = C(T \to \RR)$. So $A$ consists of periodic functions $\RR \to \RR$ which are continuous of period $1$. Let $\Xi_n^\pm$ be the set of continuous $\xi: \RR \to \RR$ such that $\xi(t+n) = \pm \xi(t)$. Then
    $$S(R) = \{\Xi_n^\pm: n \in \ZZ\}.$$
    From the space $\Xi_1^-$ we can recover the Moebius strip.
\end{example}
\begin{example}
    Let $A = C(T^2)$, viewed as continuous functions $f: \RR^2 \to \CC$ which are periodic of period $1$ in both variables. Now let $\Xi_{m,q}$ be the space of $\xi \in C(\RR^2 \to \CC)$ such that $\xi(s + 1, t) = \xi(s, t)$ and
    $$\xi(s, t+m) = e^{2\pi iqs} \xi(s, t).$$
    Together with the free $A$-modules, we recover all projective modules over $A$, i.e. all $\CC$-vector bundles over $T^2$. So we have classified vector bundles on a torus.
\end{example}
\begin{example}
    Let $S^2$ be the $2$-sphere, viewed as the unit sphere of $\RR^3$, and let $A = C(S^2 \to \RR)$. Let $\Xi$ be the $A$-module of continuous sections of the tangent bundle $TS^2$ of $S^2$. This can be viewed as the set of $\xi \in C(S^2 \to \RR^3)$ such that for all $x \in S^2$, $\langle \xi(x), x\rangle = 0$. By the hairy ball theorem, $TS^2$ is a nontrivial bundle. But the normal bundle $NS^2$, whose continuous sections consist of $\xi: S^2 \to \RR^3$ such that $\xi(x) \in \RR x$, is isomorphic to $S^2 \times \RR$, so is a trivial bundle. Therefore, if $S(A)$ was a cancellative monoid, then
    $$\Xi \oplus A \cong \Xi \oplus NS^2 \cong A^3 \cong A^2 \cong A$$
    so we could conclue that $\Xi \cong A^2$ and hence $TS^2$ is trivial, a contradiction. Therefore $S(A)$ is noncancellative, and constructing its Grothendieck group will be quite difficult.
\end{example}
    Let $C(R)$ be the universal cancellative abelian monoid for $S(R)$. In other words, for every $V,V'$ for which there exists $W$ with $V \oplus W \cong V' \oplus W$, we impose the relation $V = V'$. We then take the universal abelian group containing $C(R)$, say $K_0(R)$, i.e. the Grothendieck group\footnote{According to Rieffel, Grothendieck does not deserve to have such a trivial construction named after him.} of $S(R)$. (Constructively, elements of $K_0(R)$ are pairs $(V, W)$ where $V,W$ are elements of $C(R)$, and we are thinking of $(V, W)$ as meaning $V - W$.) We define the positive elements of $K_0(R)$ to be those in $C(R)$.

    In fact one constructs \dfn{K-theoretic group}s $K_n(R)$ for every $n \in \NN$. The first groups $n \in \{0, 1, 2\}$ were well-known previously, but Quillen introduced K-theoretic groups for any ring and any natural number. But we are not interested in Quillen's K-theoretic groups. We introduce, for $R$ a Banach algebra, the topological K-theoretic group $K_1^{top}(R)$. If one tries to define $K_2^{top}(R)$ over $\CC$ we find $K_2^{top}(R) = K_0(R)$; similarly over $R$ we have $K_8^{top}(R) = K_0(R)$. This is the \dfn{Bott periodicity theorem}.
\begin{example}
    Let $A_\theta = C^*(\ZZ^2, c_\theta)$ be the quantum $2$-torus. Then $A_0 = C(T^2)$. In case of the $2$-torus, $A_\theta = C(T) \rtimes_{\alpha_\theta} \ZZ$ acts on $L^2(T)$. We have projections on $A_\theta$ provided that $\theta \in (0, 1)$, namely
    $$P = U_{-1}M_h + M_f + M_gU_1$$
    for certain multiplication operators $M_f,M_g,M_h$. If $\varepsilon > 0$ and $\theta + \varepsilon < 1$, then the function $f$ is supported on $[0, \theta + \varepsilon]$ and identically $1$ on $[\varepsilon, \theta]$ and the trace $t(P)$ of the projection is given by
    $$t(P) = \int_0^1 f = \theta.$$
    If there is a unitary equivalence $P \cong P'$, then $t(P') = t(P)$. By a theorem on the homework, there are only countably many projections in a separable $C^*$-algebra up to unitary equivalence, so $A_\theta$ contains countably many traces, and its set of traces is determined by $\theta$. Yet there are uncountably many choices of $\theta$. So \dfn{Rieffel's theorem} says that there are uncountably many quantum tori up to $C^*$-isomorphism. In fact $(\ZZ + \ZZ\theta) \cap [0, 1]$ indexes the quantum tori that embed in $A_\theta$. But when Rieffel showed this result to Voicolescu, he proved \dfn{Voicolescu's theorem}, which shows that
    $$K_0(A_\theta) \cong \ZZ^2$$
    where $C(A_\theta) = (Z + Z\theta) \cap [0, \infty)$. So the K-theoretic group is not a complete invariant of the quantum tori, but the positive elements of the K-theoretic group give more information.
\end{example}





\part{Complex analysis}
\chapter{Holomorphy in several complex variables}
This chapter follows Hormander's SCV book, Chapter II, and Zworski's lectures on SCV.

\section{Cauchy-Riemann equations}
Let us generalize the Cauchy-Riemann equations to higher dimensions.
\begin{definition}
    Let $f: \CC^n \to \CC$ be a function. We write $z = x + iy$ and define the partial derivatives
    $$\frac{\partial f}{\partial z_j} = \frac{1}{2}\left(\frac{\partial f}{\partial x_j} - i\frac{\partial f}{\partial y_j}\right),$$
    and
    $$\frac{\partial f}{\partial \overline z_j} =
    \frac{1}{2}\left(\frac{\partial f}{\partial x_j} + i\frac{\partial f}{\partial y_j}\right).$$
    We define the \dfn{Wirtinger differential} of $f$ by $\partial f = \sum_j \partial_{z_j}f dz_j$ and $\overline \partial f = \sum_j \partial_{\overline z_j} f d\overline z_j$. Finally, we define the \dfn{total differential} $df = \partial f + \overline \partial f$.
\end{definition}
For ease of notation we frequently make the decomposition $dz_j = dx_j + idy_j$ and $d\overline z_j = dx_j - idy_j$. Then $df = \sum_j \partial_{x_j}f ~dx_j + \partial_{y_j}f ~dy_j$, as it should be.

Notice that if $n = 1$ and $f$ is holomorphic, then $\overline \partial f = 0$. Indeed, $f = u + iv$ solves the Cauchy-Riemann equations, so
$$\frac{\partial f}{\overline \partial z} = \frac{1}{2}\left(\frac{\partial u}{\partial x} - \frac{\partial v}{\partial y} + \frac{\partial u}{\partial y} + \frac{\partial v}{\partial x}\right) = 0.$$
This motivates the general definition of holomorphy.
\begin{definition}
    The \dfn{Cauchy-Riemann equation} is the equation
    $$\overline \partial f = 0.$$
    If $f: \CC^n \to \CC$ solves the Cauchy-Riemann equation, then $f$ is said to be a \dfn{holomorphic function} of several complex variables. If $f = (f_1, \dots, f_m)$ is a function $\CC^n \to \CC^m$ such that each $f_j$ is holomorphic, then $f$ itself is said to be holomorphic.
\end{definition}
It is easy to check that the composite of holomorphic functions is holomorphic.

Recall that the implicit function theorem guarantees that a $C^r$ relation between $\RR^n$ and $\RR^m$ that ``passes the vertical hyperplane test" is actually the graph of a $C^r$ function $\RR^n \to \RR^m$. In particular, this holds if $r = \infty$, but demanding holomorphy of the function is actually a much stronger condition, so we must check that it holds.
\begin{theorem}[implicit function theorem]
    \index{implicit function theorem}
    Let $U$ be a neighborhood of $(w_0, z_0) \in \CC^m \times \CC^n$, and let $f: U \to \CC^m$ be holomorphic. Suppose that $f(w_0, z_0) = 0$ and $\det(\partial f_j/\partial w_k)_{j,k=1}^m \neq 0$. Then there is a unique holomorphic function $g: \CC^n \to \CC^m$ such that $f(g(z), z) = 0$ and $g(z_0) = w_0$.
\end{theorem}
\begin{proof}
    By replacing $\CC$ with $\RR^2$, we can apply the classical implicit function theorem. To do this, we write $f = u + iv$ and consider the Jacobian
$$\frac{\partial(u,v)}{\partial(x,y)} = \begin{bmatrix}
    \Re \partial f & -\Im \partial f\\
    \Im \partial f & \Re \partial f.
\end{bmatrix}$$
    One easily checks that the determinant of this matrix is $|\det(\partial f_j/\partial w_k)|_{j,k=1}^m$ which is nonzero. This gives a function $g$ with $f(g(z), z) = 0$.

    To prove holomorphy, we apply $\dbar$. This is
$$\dbar_k f_j(g(z), z) = \sum_\ell \partial_{w_\ell} f_j \dbar g_\ell(z)$$
    by the chain rule, using that $\dbar f = 0$. We have $\dbar_k f_j(g(z), z) = 0$, so by linear algebra, $\dbar g_\ell = 0$. So $g$ is holomorphic.
\end{proof}
\begin{corollary}[inverse function theorem]
    \index{inverse function theorem}
    Let $z_0 \in \CC^m$ and $f: \CC^m \to \CC^m$ be a  holomorphic function whose Jacobian does not vanish at $z_0$. Then there is a neighborhood $U \ni z_0$ such that $f$ is a holomorphic diffeomorphism of $U$ into its image.
\end{corollary}

    Recall that if $\alpha = (\alpha_1, \dots, \alpha_n)$ is a multiindex, then the differential form $dx_\alpha$ is given by
    $$dx_\alpha = \bigwedge_{j=1}^n dx_{\alpha_j}.$$
\begin{definition}
    A differential form $\omega$ is \dfn{type} $(p, q)$ if it can be written
    $$\omega = \sum_{|\alpha| = p} \sum_{|\beta| = q} f_{\alpha,\beta} dz_\alpha d\overline z_\beta.$$
    For each function space $\mathcal F$, we let $\mathcal F_{p,q}$ denote the space of differential forms of type $(p, q)$ over $\mathcal F$.
\end{definition}

\section{Basic properties}
\begin{theorem}[Hartogs]
    \index{Hartogs' theorem}
    Let $u: \Omega \to \CC$ be holomorphic in each variable alone; then $u$ is holomorphic.
\end{theorem}
Allegedly this theorem is useless (though it comes up in dynamical systems). Its proof is very difficult, using the Baire category theorem and the Schwarz lemma. However, if we are allowed to assume that $u$ is continuous, then the proof is almost trivial.
\begin{lemma}
    Assume that we are given a sequence $u_j$ of uniformly bounded subharmonic functions, such that $\limsup_j u_j$ is bounded from above. Then the $u_j$ are locally uniformly bounded from above by $\sup \limsup_j u_j + \varepsilon$.
\end{lemma}
\begin{proof}
    Without loss of generality, we may assume that the $u_j \leq 0$. Let $K$ be a compact set with $d(K, \Omega^c) \geq 3r$. Let $z \in K$, $\varepsilon > 0$. Then we can find a $n_0$ such that for any $n > n_0$,
$$\int_{|z' - z| < r} u_n(z') ~dz' \leq (C + \frac{\varepsilon}{2})\pi r^2$$
    by Fatou's lemma. If $\delta$ is small enough and $|w - z| < \delta$, then
$$\pi(r + \delta)^2 u_n(w) \leq \int_{|z' - z| \leq r + \delta} u_n(z') ~dz' \leq \int_{|z' - z| < \delta} u_n(z') ~dz' \leq (C + \varepsilon/2) \pi r^2$$
for $n$ large enough. Therefore
$$u_n(w) \leq (C + \varepsilon/2)\left(\frac{ r + \delta}{r}\right)^2 \leq C + \varepsilon$$
for $\delta$ small enough. This does not depend on $z, w$.

Cover $K$ by discs $D(z, \delta)$, so reduce to a finite subcover to find a uniform $\delta$.
\end{proof}

\begin{definition}
    A \dfn{polydisk} in $\CC^n$ is a set $D$ of the form
    $$D = \prod_{j=1}^n D_j$$
    where each $D_j \subset \CC$ is an open disk. The \dfn{distinguished boundary} $\partial_0 D$ is the set
    $$\partial_0 D = \prod_{j=1}^n \partial D_j.$$
    If $u: \overline D \to \CC^m$ is a continuous function which is holomorphic on $D$, we simply say $u$ is \dfn{holomorphic} on $\overline D$.
\end{definition}
Notice that $\partial_0 D$ is in general a torus (since it is a product of circles) and a very small subset of $\partial D$.

By induction on $n$, one easily proves the following.
\begin{theorem}[Cauchy's integral formula in a polydisk]
    \index{Cauchy's integral formula}
    Let $D$ be a polydisk in $\CC^n$ and let $u: \overline D \to \CC$ is holomorphic in each variable separately and continuous on $\overline D$. Then one has
    $$u(z) = \frac{1}{(2\pi i)^n} \int_{\partial_0 D} \frac{u(\zeta) ~d\zeta}{(\zeta_1 - z_1)\cdots(\zeta_n - z_n)}.$$
\end{theorem}
\begin{corollary}
    Let $U \subseteq \CC^n$ be an open set and $f: U \to \CC^m$ be a holomorphic function. Then $f \in C^\infty(U)$, and for every compact set $K \subset U$, every multiindex $\alpha$, and every open neighborhood $V$ of $K$, we have
    $$||\partial^\alpha u||_{L^\infty(K)} \preceq_{K,\alpha} ||u||_{L^1(V)}.$$
\end{corollary}
\begin{proof}
    Since $K$ is compact, it can be covered by finitely many sets contained in polydiscs contained in $V$. Now use Cauchy's integral formula (the implicit constant arising from the denominator of the formula, the measures of the distinguished boundary, and the obligatory factors of $2\pi$).
\end{proof}
\begin{corollary}[Montel]
    \index{Montel's theorem}
    Let $(u_k)_k$ be a sequence of holomorphic functions on an open set $U \subseteq \CC^n$. If $u_k \to u$ locally uniformly, then $u$ is holomorphic. On the other hand, if one has
    $$||u_k||_{L^\infty(K)} \preceq_K 1$$
    for $K \subset U$ compact, then $(u_k)_k$ has a locally uniformly convergent subsequence (which, in particular, has a holomorphic limit).
\end{corollary}
The proof is the same as in one variable.

We view $\dbar$ as an exterior derivative. For $(0, 1)$-forms $f$ we have
$$\dbar f = \sum_{j<k} (\dbar_j f_k - \dbar_k f_j) d\overline z_j \wedge d\overline z_k$$
and if $\dbar u = f$ for some $(0, 0)$-form $u$, $\dbar f = 0$.

\begin{theorem}
    Let $\Omega \subset \CC^n$ be bounded, $n > 1$, and assume that $\CC^n \setminus \Omega$ is connected. If there is a $\rho \in C^4(\CC^n \to \RR)$ such that $\partial \Omega$ is the zero set of $\rho$ and $d\rho|_{\partial \Omega} \neq 0$, and there is a $u \in C^4(\overline \Omega)$ such that $\dbar u \wedge \dbar \rho = 0$ on $\partial \Omega$, then there is a $U \in A(\Omega) \cap C^1(\overline \Omega)$ such that $U = u$ on $\partial \Omega$.
\end{theorem}
    Note that if $U$ exists, then $U - u = \rho h$ for some $h \in C^1(\overline \Omega)$, with $-\dbar u = \dbar \rho h$ on $\partial \Omega$. This is what we mean by $\dbar u \wedge \dbar \rho = 0$ on $\partial \Omega$, which is hence a necessary condition as well as sufficient.
\begin{definition}
    For $\rho$ as above, the equation $\dbar u \wedge \dbar \rho = 0$ is called the \dfn{tangential Cauchy-Riemann equation}.
\end{definition}
    Clearly if $u$ is holomorphic then it solves the tangential Cauchy-Riemann equations. Otherwise, what this condition is saying is that $\dbar u$ and $\dbar \rho$ are proportional. The intuition is that if $\sum_j t_j \dbar_j \rho = 0$ then $\sum_j t_j \dbar_j u = 0$, and the hypothesis here is that the vector field $\sum_j t_j \dbar_j$ is tangent (in the sense of the complexified tangent bundle) to $\partial \Omega$. Thus, what the tangential Cauchy-Riemann equations say is that any section $V$ of the tangent bundle of $\partial \Omega$ which only contain antiholomorphic coordinates has $Vu = 0$, so annihilates $u$.
\begin{example}
    Take the unit ball $B$ of $\CC^2$. Here $\rho(z) = |z|^2 - 1$. If $V = t_1 \dbar_1 + t_2 \dbar_2$ then $V\rho(z) = 2t\cdot z$. Thus the antiholomorphic vector fields which are tangent to $\partial B$ are elements of the ideal generated by $z_2 \dbar_1 - z_1 \dbar_2$.
\end{example}
\begin{proof}[Proof of theorem]
    We construct $U_0 \in C^1(\overline \Omega)$ such that $U_0 = u$ on $\partial \Omega$ and $\dbar U_0 = O(\rho^2)$ on $\partial \Omega$. By the tangential Cauchy-Riemann equations, we have a $h_0 \in C^3$ such that $\dbar u = h_0\dbar \rho$ on $\partial \Omega$. Thus $\dbar u = h_0 \dbar \rho + \rho h_1$ for some $h_1 \in C^3_{0,1}$. Then $\dbar(u-h_0\rho) = \dbar u - h_0\dbar \rho - \dbar h_0\rho = \rho h_1 - \dbar h_0 \rho = \rho(h_1 - \dbar h_0) = \dbar \rho h_2$ for $h_2 \in C^2_{0, 1}$, and $0 =\dbar(\rho h_2) = \dbar \rho \wedge h_2 + \rho \dbar h_2$. Now $\dbar h_2 = 0$ on $\partial \Omega$ so $\dbar \rho \wedge h_2 = 0$ on $\partial \Omega$, i.e. $h_2 = h_3 \dbar \rho + \rho h_4$ for some $h_3 \in C^2$ and $h_4 \in C^2_{0, 1}$. Now let $h_5 = -h_3/2$, then $2\dbar \rho h_5 = -h_2 + O(\rho)$, so
    $$\dbar(u-h_0\rho+h_5\rho^2) = \rho(h_3\dbar \rho + \rho h_4) - \rho^2\dbar h_3/2 + 2\rho \dbar \rho(-h_3/2)=\rho^2h_4 - \rho^2 \dbar h_3/2 = O(\rho^2).$$
    Thus let $U_0 = u - h_0\rho + h_5\rho^2$. So there is an $f \in C^1$ such that $\dbar U_0 = \rho^2 f$.

    Now let $F = \rho^2f$ on $\overline \Omega$ and $0$ away from $\Omega$. Then $F \in C^1(\CC)$. So there is a $v \in C^1_{comp}$ such that $\dbar v = F$. By continuity, $v = 0$ on $\partial \Omega$. Let $U = U_0 - v$.
\end{proof}





\section{Plurisubharmonicity and domains of holomorphy}
\begin{definition}
    Let $\Omega \subseteq \CC^n$ be open, and $u: \Omega \to [-\infty, \infty)$ be a upper-semicontinuous function. We say $u$ is a \dfn{plurisubharmonic function} or \dfn{plush function} if for every $a, b \in \CC^n$, the function $z \mapsto u(az + b)$ is subharmonic whenever it is defined.
\end{definition}
\begin{lemma}If $u$ is $C^2$, then $u$ is plush iff the Hessian matrix
$$\lambda_{ij} = \partial_i \dbar_j f$$
is positive-semidefinite everywhere.\end{lemma}
\begin{proof}
    We have $0 \leq \Delta_\tau u(z + \tau w) = 4\partial_\tau \dbar_\tau u(z + \tau w)$. By the chain rule,
    $$0 \leq 4 \partial_\tau \sum_j \dbar_j u (z + \tau w)\overline w_j = 4 \sum_{k,j} \partial_k \dbar_j u(z + \tau w) \overline w_j w_k.$$
    Now divide both sides by $4$.
\end{proof}
We let $P(\Omega)$ denote the set of plush functions on $\Omega$. It is easy to see from this characterization that for any holomorphic function $f$, $\log |f| \in P(\Omega)$. A tensor product of subharmonic functions, $u \otimes v(z, w) = u(z) v(w)$ is also plush. Any convex function is plush.

Recall that the decreasing sequence of a subharmonic functions converges to a subharmonic function. Restricting to a line we see:
\begin{corollary}
    The limit of a decreasing sequence of plush functions is plush.
\end{corollary}
    Thus we could define a plush function to be a decreasing limit of smooth plush functions (where a smooth plush function is one satisfying the Hessian characterization.)

\begin{corollary}
Let $\varphi$ be a standard mollifier and $u$ plush. Let $u_\varepsilon$ denote the $\varepsilon$-mollification of $u$. Then $u_\varepsilon$ decreases to $u$ as $\varepsilon \to 0$ and $u_\varepsilon \in C^\infty(\Omega_\varepsilon) \cap P(\Omega_\varepsilon)$ for $\Omega_\varepsilon = \{z \in \Omega: d(z, \partial \Omega) > \varepsilon\}$.
\end{corollary}
The proof is the same as in one dimension (i.e. for subharmonic functions).

\begin{corollary}
    Let $\Omega \subseteq \CC^n$, $\Omega' \subseteq \CC^m$, $f: \Omega \to \Omega'$ a holomorphic mapping, and $u \in P(\Omega')$. Then the pullback $f^*u \in P(\Omega)$.
\end{corollary}
\begin{proof}
    Without loss of generality we can assume that $u$ is smooth (since the pullback of a decreasing sequence is decreasing). By the Hessian characterization, the pullback is plush.
\end{proof}


\begin{definition}
    An open set $\Omega \subseteq \CC^n$ is a \dfn{domain of holomorphy} if there are no $\Omega_1, \Omega_2 \subset \CC^n$, $\Omega_1$ is nonempty, $\Omega_1 \subset \Omega_2 \cap \Omega$, $\Omega_2$ is not contained in $\Omega_1$, and for every $u \in A(\Omega)$ there is a $\tilde u \in A(\Omega_2)$ such that $u|_{\Omega_1} = u_1|_{\Omega_1}$.
\end{definition}
    For example, a polydisk $D = \prod_j D_j$ is a domain of holomorphy because we could always find $f_j \in A(D_j)$ which cannot extend to any open set beyond $D_j$, and then $f(z) = \sum_j f_j(z_j)$ cannot be extended to any open set. More generally, a product of domains of holomorphy is a domain of holomorphy. If $n = 1$ then every set is a domain of holomorphy, so this is the distinction between one and many variables.

We choose a function $\delta: \CC^n \to [0, \infty)$ such that $\delta(z) > 0$ for $z \neq 0$, $\delta(tz) = |t|\delta(z)$ for $\delta \in \CC$. For example, $\delta(z) = |z|$, or $\delta(z) = \max_j |z_j|r_j^{-1}$ for $r_j > 0$. Put
$$\delta(z, \Omega) = \inf_{w \in \Omega} \delta(z - w).$$

Recall that for $K \subset \Omega$ a compact set, the holomorphic hull $\hat K_\Omega$ is defined by the set of $z \in \Omega$ such that for every $f \in A(\Omega)$, $|f(z)| \leq ||f||_{L^\infty(K)}$.

\begin{lemma}
    Suppose $\Omega$ is a domain of holomorphy, $f \in A(\Omega)$, and $K$ compactly contained in $\Omega$. If for every $z \in K$,
    $$|f(z)| \leq \delta(z, \CC^n \setminus \Omega),$$
    then this estimate is also true for $z \in \hat K_\Omega$, the holomorphic hull of $K$. In particular,
    $$f(z) = \inf_{\substack{w \in \CC \setminus \Omega\\z \in K}} \delta(z - w) = \inf_{\substack{w \in \CC \setminus \Omega\\z \in \hat K_\omega}}
 \delta(z - w).$$\end{lemma}
\begin{proof}
    For $D = \{|z_j| < r_j\}$ a polydisc, let
    $$\Delta_\Omega^D(z) = \sup_{z + rD \subseteq \Omega} r = \delta(z, \CC^n \setminus \Omega)$$
    where $\delta(z) = \max_j |z_j|r_j^{-1}$.

    Suppose $f \in A(\Omega)$ and $|f(z)| \leq \Delta_\Omega^D(z)$ for $z \in K$. We claim that for each $\zeta \in \hat K_\Omega$ and $u \in A(\Omega)$,
    $$u(z) = \sum_\alpha \frac{(z - \zeta)^\alpha}{\alpha!} \partial^\alpha u(\zeta)$$
    on $\zeta + |f(\zeta)|D$. Since $\Omega$ is a domain of holomorphy, this Taylor series cannot converge on a large enough polydisc, so $|f(\zeta)| \leq \Delta_\Omega^D(z)$, which proves the claim in case $\Omega$ itself is a polydisc.

    To prove the claim, let $L_t = \{z \in \Omega: \exists w \in K~|z_j - w_j| \leq tr_j|f(w)|\}$. If $t < 1$, then $L_t$ is compact. In fact, if $\{z^k\}_j$ is a sequence in $L_t$ then there is a sequence of $w^k$ witnessing that $z^k \in L_t$. Since $K$ is compact we can choose a limit $w$ of the $w^k$. Thus for $k$ large,
    $$|z^k_j - w_j| \leq tr_j |f(w)| + \varepsilon.$$
    Taking $\varepsilon$ small, we see that the $z^k$ lie in a compact set in $K$ since $|z_j^k - w_j^k| \leq \Delta_\Omega^D(w)$, so have a limit $z \in K$.

    Let $M_t = ||u||_{L^\infty(L_t)}$. By the Cauchy inequality applied to the polydisc $\zeta + |f(\zeta)|D$,
    $$|\partial^\alpha u(w)| t^{|\alpha|} \frac{r^\alpha}{\alpha!} |f(w)|^{|\alpha|} \leq M_t.$$
    Let $F(\zeta) = \partial^\alpha u(\zeta) t^{|\alpha|} r^\alpha (\alpha!)^{-1} f(\zeta)^{|\alpha|}$. Then $F$ is holomorphic and $|F(\zeta)| \leq M_t$ for $\zeta \in K$. So by the definition of $\hat K_\Omega$, $||F||_{L^\infty(\hat K_\Omega)} \leq M_t$. Therefore
    $$\frac{|\partial^\alpha u(\zeta)|}{\alpha!} \leq M_t t^{|\alpha|} r^\alpha |f(\zeta)|^{|\alpha|}$$
    so if $|z_j - \zeta_j| \leq tr_j |f(\zeta)|$ then the Taylor series converges.

    The above argument proves the lemma when $\delta(z) = \max_j |z_j|r_j^{-1}$. The general $\delta$ satisfies
    $$\delta(z, \CC^n \setminus \Omega) = \sup \{r \in R: \forall w \in \CC ~\delta(w) \leq 1 \implies \forall a \in B(0, r) ~z + aw \in \Omega\}.$$
    Thus $\delta(z, \CC^n \setminus \Omega) = \inf_{\delta(w) \leq 1} \delta_w(z, \CC^n \setminus \Omega)$ where $\delta_w(z, \CC^n \setminus \Omega) = \sup_{\forall a ~z \in aw \in \Omega} r$ where $a$ ranges over $B(0, r)$. Take $w = (1, 0, \dots, 0)$ and $D_k = \{z: |z_1| < 1, j \neq 1 \implies |z_j| < 1/k\}$. Thus $\Delta^{D_k}_\Omega(z) \to \delta_w(z, \CC^n \setminus \Omega)$ as $k \to \infty$. Moreover $\Delta^{D_{k+1}}_\Omega(z) \geq \Delta^{D_k}_\Omega(z)$ so by Dini's theorem the convergence of the $\Delta^{D_k}_\Omega$ is uniform.

    If $|f(z)| \leq \delta_w(z, \CC^n \setminus \Omega)$ then $|f(z)| \leq (1 + \varepsilon) \Delta^{D_k}_\Omega(z)$ for $k$ large enough and $z \in K$. By the lemma, $|f(z)| \leq (1 + \varepsilon)\Delta_\Omega^{D_k}(z)$ and $z \in \hat K_\Omega$. By Dini's theorem again one has
    $$|f(z)| \leq \delta_w(z, \CC^n \setminus \Omega).$$
    Take the infimum over $w$ of both sides. So $|f(z)| \leq \delta(z, \CC^n \setminus \Omega)$ even for ``weird" choices of $\delta$.
\end{proof}


\begin{theorem}
The following are equivalent:
\begin{enumerate}
    \item $\Omega$ is a domain of holomorphy.
    \item For every compact subset $K$ of $\Omega$, the holomorphic hull $\hat K_\Omega$ is compactly contained in $\Omega$, and for every $f \in A(\Omega)$,
    $$\sup_K \frac{|f(z)|}{\delta(z, \CC^n \setminus \Omega)} = \sup_{\hat K_\Omega} \frac{|f(z)|}{\delta(z, \CC^n \setminus \Omega)}.$$
    \item For every compact subset $K$ of $\Omega$, the holomorphic hull $\hat K_\Omega$ is compactly contained in $\Omega$.
    \item There is a $f \in A(\Omega)$ which does not extend to any larger set.
\end{enumerate}
\end{theorem}
\begin{proof}
    Obviously 2 implies 3 and 4 implies 1. By the lemma above, 1 implies 2. So we just need to show 3 implies 4.

    Let $\{K_j\}$ a compact exhaustion of $\Omega$ (so for any compact $L \subset \Omega$ and every $j$ large enough $L \subseteq K_j$). Define $D_\zeta = \{\zeta\} + rD$ for $D = \{|z_j| < r_j\}$ and $r = \sup_{\{\zeta\} + \rho D \subset \Omega} \rho$.

    Let $M$ be the set of rational points of $\Omega$; then we choose a sequence of $\zeta_j \in M$ so that every element of $M$ appears infinitely often. We also choose a sequence of $z_j \in D_{\zeta_j}$ such that $z_j \notin K_j$; this is possible because $D_{\zeta_j}$ touches $\partial \Omega$ but $K_j$ does not because it is compact.

    By (3), there is a $f_j \in A(\Omega)$ such that $f_j(z_j) = 1$ and $||f_j||_{L^\infty(K_j)} < 1$. Replacing $f_j$ by a power of $f_j$, we can assume without loss of generality that $||f_j|_{L^\infty(K_j)} < 2^{-j}$.

    Now let
    $$f(z) = \prod_j (1 - f_j(z))^j.$$
    To see that this product converges we just have to show convergence in any compact set $L$, and we can assume without loss of generality that there is a $J$ such that $L = K_J$. For $j > J$ we have $|f_j(z)| < 2^{-j}$ and since we only care about the tail we can assume $J = 1$. Then
    $$\log f(z) = \sum_j j|\log(1-f_j(z))| \leq \sum_j j |f_j(z)| \leq \sum_j j2^{-j} < \infty.$$
    Therefore convergence is locally uniform so $f \in A(\Omega)$.

    For every $D_{\zeta_j}$ there is a $w_N$ such that for every $|\alpha| \leq N$, $\partial^\alpha f(z_N) = 0$. Therefore $f$ has a zero of order $N$ in $D_{\zeta_j}$. In particular, the zeroes of $f$ have higher and higher order as we approach $\partial \Omega$. Therefore if $f$ is defined at a point $z$ of $\partial \Omega$ then $z$ is an infinite-order zero of $f$. So $f = 0$. But $f$ is nonzero so this is a contradiction.
\end{proof}
\begin{example}
    As a counterexample, notice that if $\Omega = B(0, 3) \setminus \overline{B(0, 1)}$ and $K = \partial B(0, 2)$ then $\hat K_\Omega = \overline{B(0, 2) \setminus B(0, 1)}$ by Hartogs' theorem and the maximum principle for $n \geq 2$. This is not a compact subset of $\Omega$, so $\Omega$ is not a domain of holomorphy.
\end{example}
\begin{corollary}
    If $\Omega$ is convex then $\Omega$ is a domain of holomorphy.
\end{corollary}
\begin{proof}
    Recall that $\hat K_\Omega$ is contained in the convex hull of $K$, which is a compact subset of $\Omega$.
\end{proof}
\begin{corollary}
    If $\Omega_\alpha$ are domains of holomorphy then the interior of $\bigcap_\alpha \Omega_\alpha$ is a domain of holomorphy.
\end{corollary}
\begin{proof}
    Let $K \subset \Omega$ be a compact set. Then $\hat K_\Omega$ is a compact subset of $\hat K_{\Omega_\alpha}$ for every $\alpha$, in particular of the compact set $\bigcap_\alpha \hat K_{\Omega_\alpha}$, which is a compact subset of $\Omega$.
\end{proof}
\begin{corollary}
    Let $\Omega$ be a domain of holomorphy, $f_1, \dots, f_N \in A(\Omega)$. Then
    $$\Omega_f = \{z \in \Omega: |f_j(z)| < 1\}$$
    is a domain of holomorphy.
\end{corollary}
\begin{proof}
    Let $K$ be a compact subset of $\Omega_f$. Then by compactness, there is a $r < 1$ such that $K \subset \{z \in \Omega: |f_j(z)| < r\}$. Thus for any $z \in \hat K_{\Omega_f}$, $|f_j(z)| \leq r$. Moreover
    $$\hat K_{\Omega_f} \subseteq \hat K_\Omega \subset \{|f_j| \leq r\} \subseteq \Omega_f.$$
    Therefore $\hat K_{\Omega_f}$ is a compact subset of $\Omega_f$.
\end{proof}
\begin{corollary}
    Let $u: \Omega \to \CC^m$ be a holomorphic transformation, $\Omega' \subseteq \CC^m$ a domain of holomorphy. Then the pullback $u^{-1}(\Omega')$ is a domain of holomorphy.
\end{corollary}

We now relate domains of holomorphy to plurisubharmonicity.
\begin{theorem}
    If $\Omega$ is a domain of holomorphy and $\delta$ as above, then $z \mapsto -\log \delta(z, \CC^n \setminus \Omega)$ is a continuous plurisubharmonic function.
\end{theorem}
\begin{proof}
    For $z_0 \in \Omega$, $w \in \CC^n$, take $D = \{z_0 + \tau w: \tau \in \CC, ~|\tau|\leq r\}$. If $r$ is small enough then $D \subseteq \Omega$. Let $f$ be a polynomial in $\tau$ and $-\log \delta(z_0 + \tau w, \CC^n \Omega) \leq \Re f(\tau)$ for every $|\tau| = r$. We must show this is true for $|\tau| < r$ as well.

    Let $F$ be a polynomial on $\CC^n$ such that $F(z_0 + \tau w) = f(\tau)$. Then
    $$|e^{-F(z)}| \leq \delta(z, \CC^n \setminus \Omega)$$
    for $z \in \partial D$, hence for $z \in \widehat{\partial D}_\Omega$, in particular for $z\in D$. Thus the claim holds for $|\tau| < r$.
\end{proof}
    In fact the converse of this result holds, using Hormander $L^2$-estimates with plush weights on $\Omega$.
\begin{definition}
    Let $K \subset \Omega$ be a compact set. The \dfn{plurisubharmonic hull}
    $$\hat K^p_\Omega = \{z \in \Omega: \forall u \in P(\Omega) ~u(z) \leq \sup_K u.\}$$
    If $K = \hat K^p_\Omega$, we say that $K$ is \dfn{plurisubharmonically convex}.
\end{definition}
    Now if $f \in A(\Omega)$ we have $\log |f| \in P(\Omega)$, so we are testing by fewer functions that in the case of the analytic hull $\hat K_\Omega$. Thus $\hat K^p_\Omega \subseteq \hat K_\Omega$.
\begin{theorem}
    The following are equivalent:
\begin{enumerate}
    \item $z \mapsto -\log \delta(z, \CC^n \setminus \Omega)$ is plush.
    \item There is a $u \in P(\Omega)$ such that for every $c \in \RR$, $\Omega_c = \{z \in \Omega: u(z) < c\}$ is $\Omega$-precompact.
    \item For every $K \subset \Omega$ compact, $\hat K^p_\Omega$ is compact in $\Omega$.
\end{enumerate}
\end{theorem}
\begin{definition}
    $\Omega$ is \dfn{pseudoconvex} if one (and hence) all of the above conditions hold. The function $u$ appearing in (2) is called a \dfn{plurisubharmonic exhaustion function}.
\end{definition}
    If $\Omega$ is a domain of holomorphy, then $\Omega$ is pseudoconvex.
\begin{proof}[Proof of theorem]
    To see 1 implies 2, let $u(z) = -\log \delta(z, \CC^n \setminus \Omega) + |z|^2$. This is clearly plush and blows up at the boundary. So it is a plush exhaustion function.

    To see 2 implies 3, let $c = \sup_K u$. Then $\{z \in \Omega: u(z) \leq \sup_K u\}$ is clearly compact and contains $\hat K^p_\Omega$.

    So we just need to prove 3 implies 1. Take $z_0 \in \Omega$ and $w \in \CC^n \setminus 0$. We need to show that for every $|\tau| = r$, if $-\log(z_0 + \tau w, \CC^n \setminus \Omega) \leq \Re f(\tau)$ then for every $|\tau| \leq r$ we have $-\log(z_0 + \tau w, \CC^n \setminus \Omega)$.

    If $|\tau| = r$ then $\delta(z_0 + \tau w, \CC^n \setminus \Omega) \geq |e^{-f(\tau)}|$. Let $a \in \CC^n$ be such that $\delta(a) < 1$. Let $F_\lambda(\tau) = z_0 + \tau w + \lambda z e^{-f(t)}$ and let $D_\lambda = F_\lambda(D(0, r))$ and $\Lambda = \{\lambda \in [0, 1]: D_\lambda \subseteq \Omega\}$. We must show $\Lambda = [0, 1]$ by showing that $\Lambda$ is clopen and nonempty.

    If $\lambda \in \Lambda$ and we perturb $\lambda$, then we do not move $D_\lambda$ by much, so it remains in the open set $\Omega$. Therefore $\Lambda$ is open. Moreover, $0 \in \Lambda$ by assumption 3, so $\Lambda$ is nonempty.

    Let $K = \{z_0 + \tau w + \lambda a e^{-f(\tau)}: |\tau| = r, ~\lambda \in [0, 1]\}$. Then $K$ is $\Omega$-compact since by assumption 3, $\delta(z_0 + \tau w, \CC^n \setminus \Omega) \geq |e^{-f(\tau)}|$. Since $|a| < 1$ we have $|a\lambda e^{-f(\tau)}| < 1$ whence $\delta(z_0 + \tau w + \lambda ae^{-f(t)}) > 0$. Thus the function
    $$\tau \mapsto u(z_0 + \tau w + a \lambda e^{-f(\tau)}$$
    is subharmonic near $|\tau| \leq r$. Thus
    $$u(z_0 + \tau w + \lambda ae^{-f(\tau)}) \leq \sup_K u$$
    for $|\tau| \leq r$, by the maximum principle, since $K$ contains the boundary of $\hat K^p_\Omega$. Thus $D_\lambda \subseteq \hat K^p_\Omega$.

    If we have a sequence of $\lambda_j \in \Lambda$, say $\lambda_j \to \lambda_0 \in [0, 1]$, then the $D_{\lambda_j} \subseteq \hat K^p_\Omega$, giving a continuous family of closed sets which converge to a closed set $D_{\lambda_0}$. So $D_{\lambda_0} \subseteq \hat K^p_\Omega$, so $\lambda_0 \in \Lambda$. So $\Lambda$ is closed, which proves the theorem.
\end{proof}
\begin{corollary}
    If $(\Omega_\alpha)_\alpha$ is a family of pseudoconvex domains then the interior $\Omega$ of $\bigcap_\alpha \Omega_\alpha$ is pseudoconvex.
\end{corollary}
\begin{proof}
    One has
    $$\delta(z, \CC^n \setminus \Omega) = \delta\left(z, \CC^n \setminus \bigcap_\alpha \Omega_\alpha\right) \inf_\alpha \delta(z, \CC^n \setminus_\alpha).$$
    Taking $-\log$ of both sides we arrive at
    $$-\log \delta(z, \CC^n \setminus \Omega) = \sup_\alpha -\log \delta(z, \CC^n \setminus \Omega_\alpha)$$
    and the right-hand side is plush since the supremum of plush functions is plush.
\end{proof}
\begin{corollary}
    $\Omega$ is pseudoconvex if and only if for every $z \in \hat \Omega$ there is a neighborhood $\omega \ni z$ such that $\Omega \cap \omega$ is pseudoconvex.
\end{corollary}
\begin{proof}
    If $\Omega$ is pseudoconvex, let $\omega$ be a convex neighborhood of $z$. So $\omega$ is pseudoconvex; use the previous corollary.

    For the converse, notice that this is trivial if $z \in \Omega$ by (3) of the above theorem. If $z_0 \in \partial \Omega$ and $\omega \ni z_0$ we notice that $\delta(z, \CC^n \setminus \Omega) = \delta(z, \CC^n \setminus (\Omega \cap \omega))$ if $|z - z_0|$ is small. Thus the function $z \mapsto -\log \delta(z, \CC^n \setminus \Omega)$ is plush near $z_0$. But plurisubharmonicity is a local property so the function is plush on a neighborhood of $\partial \Omega$, i.e. there is a closed set $F \subset \Omega$ such that $z \mapsto -\log \delta(z, \CC^n \setminus \Omega)$ is plush on $\Omega \setminus C$.

    Let
    $$\Phi(r) = \max_{\substack{|\zeta| \leq r\\\zeta \in F}} -\log \delta(\zeta, \CC^n \setminus \Omega)$$
    so $\Phi$ is increasing. Now let $\Phi_1$ be a convex increasing function such that $\Phi_1 \geq \Phi$. So we define $\varphi(z) = \Phi_1(|z|)$. So $\varphi$ is a plush function and we can put
    $$u(z) = \max(\varphi(z), -\log\delta(z, \CC^n\setminus\Omega))$$
    which is a supremum of plush functions, hence plush. Clearly $u$ satisfies (2).
\end{proof}
    So pseudoconvexity is a local property.
\begin{theorem}
    \label{Levi condition}
    Let $\rho \in C^2(\CC^n)$ with $d\rho|_{\rho = 0} = 0$ and let $\Omega = \{z \in \CC: \rho(z) < 0\}$. Then $\Omega$ is pseudoconvex if and only if for every $z \in \partial \Omega$, $w \in \CC^n$ such that $\sum_j \partial_j \rho(z) w_j = 0$
    we have
    $$\sum_{j,k=1}^n \partial_j \dbar_k \rho(z) w_j \overline w_k \geq 0.$$
\end{theorem}
\begin{definition}
    If $\Omega$ satisfies the hypotheses of Theorem \ref{Levi condition} and is pseudoconvex then $\Omega$ satisfies the \dfn{Levi condition}.
\end{definition}
\begin{example}
    Let $\Omega = \{z \in \CC^2: |z_1|^2 + 2 \Im z_2 < 0\}$. Then
    $$\rho(z) = |z_1|^2 + 2 \Im z_1.$$
    Calculating, we see that $$\partial\dbar \rho = \begin{bmatrix}1&0\\0&0\end{bmatrix}$$
    so $\Omega$ satisfies the \emph{strict} Levi condition (where $\geq$ is replaced with $>$). In this case, for any $z_0 \in \partial \Omega$ there is a $U \in A(\Omega)$ which has a singularity at $z_0$, so $U$ does not extend beyond $\Omega$. In fact, we put
    $$U(z) = (z_1\overline a) - iz_2 - |a|^2/2 + ib)^{-1}$$
    where $a \in \CC$, $b \in \RR$. We put $z_0 = (a, b -i|a|^2/2)$, then $U$ has a singularity at $z_0$. However, as we will prove in a later theorem, any function on $\CC^2 \setminus \Omega$ admits an analytic continuation to $\Omega$.

    For this example, the tangential Cauchy-Riemann equation is $(\dbar_1 + iz_1\dbar_2)u(z) = 0$. That tangential Cauchy-Riemann operator, viewed as an operator on a $3$-dimensional manifold (since $\partial \Omega$ is a $3$-dimensional manifold) was used by Levi to disprove the version of the Cauchy-Kovaleskai theorem for smooth (rather than analytic) functions because for the generic $f \in C^\infty(\partial \Omega)$ we do not have $Pu = f$.
\end{example}
\begin{proof}[Proof of Theorem \ref{Levi condition}]
    First, a one-line lemma: Let $\rho_1 = h\rho$, $\rho > 0$, $h \in C^2$ with $h > 0$. Then if $\rho$ satisfies the Levi condition then $\rho_1$ does as well. So we can replace the $\rho$ in the hypotheses in theorem with any $\rho$ satisfying the same conditions, and we willl.

    To prove that if $\Omega$ is pseudoconvex with a $C^2$ boundary then the Levi condition holds, we let $\rho(z) = -\inf_{w \notin \Omega} |z - w|$ for $z \in \Omega$ and $\rho(z) = \inf_{w \in \Omega} |z - w|$ for $z \notin \Omega$. Thus $\rho(z)$ is the ``signed distance" from $z$ to $\partial \Omega$. If $z \notin \partial \Omega$, we have
    $$z = w + \rho(z)n(w)$$
    for a minimizer $w \in \partial \Omega$ (which exists since $\partial \Omega$ is closed) and $n$ the unit normal. Since $\Omega$ has a $C^2$-boundary, $n$ is a $C^1$ function of the element $w'$ of $\RR^k$ where $k$ is the dimension of $\partial \Omega$ as a real manifold. Let $f(w') = w$. Then
    $$F(z, w', \rho(z)) = z - (f(w'), w') - \rho(z)\frac{(\nabla f(w'), 1)}{\sqrt{|\nabla f(w')|^2 + 1}}$$
    and $F$ is $C^1$. By rotating the manifold $\partial \Omega$ so that the tangent plane near $w$ is horizontal and translate so $w = 0$, i.e. $w' = 0$, $f(0) = 0$, $\nabla f(0) = 0$. So
    $$\frac{\partial F}{\partial(w', \rho(z))}(z_0, 0, \rho(z_0)) = \begin{bmatrix}\frac{\partial F}{\partial w'} & \frac{\partial F}{\partial \rho}\end{bmatrix} = \begin{bmatrix}I + O(\rho(z_0)) & 0 \\ O(\rho(z_0)) & -1\end{bmatrix}$$
    which is invertible if $\rho(z_0)$ is small. Therefore we can use the implicit function theorem to see that $\rho$ is well-defined and $C^1$. We now implicitly differentiate $x = y + \rho n$ to see that
    $$e_j = \partial_j(y'(x) + \rho(x)\left(y'(x) + \frac{-\nabla f(y'(x))}{\sqrt{1 + |\nabla f(y'(x))|}}, f(y') + \rho(1 + O(y')^2)\right)$$ which evaluates at $x = x_0$, $y' = 0$ to show that
    $$\delta_{Nj} = \partial_j \rho(x_0).$$
    Rotating back to the original coordinate frame,
    $$\nabla \rho(x) = n(y(x))$$
    whenever $x$ is close to $\partial \Omega$. Therefore $\nabla \rho \in C^1$ so $\rho \in C^2$.

    Now for $z \in \Omega$ and the standard $\delta$ (namely $\delta(z, w) = |z - w|$) we have $\rho(z) = -\delta(z, \CC^n \setminus \Omega)$. Then $-\delta = \rho$ so $\delta \in C^2$ whence
    $$-\partial_j \dbar_k \log \delta = \delta^{-2} \partial_j \delta \dbar_k \delta - \delta^{-1} \partial_j \dbar_k \delta$$
    so it follows that
    $$\sum_{j,k} \delta^{-1} \partial_j \delta w_j \dbar_k \delta \overline w_k - \partial_j \dbar_k \delta w_j \overline w_k \geq 0.$$
    We know that $\partial_j \rho(z_0) w_j = 0$ for $z_0 \in \partial \Omega$ (hypothesis of the Levi condition) so
    $$\sum_j \partial_j \rho(z) w_j = O(|z - z_0|).$$
    Taking $z \to z_0$,
    $$\sum_{j,k} \partial_j \dbar_k \rho w_j \overline w_k \geq 0$$
    (conclusion of the Levi condition).

    We prove the converse by contradiction. Assume that $-\log \delta(z, \CC^n \setminus \Omega)$ is not plush in $z$, in any neighborhood of $\partial \Omega$. Then $\partial \dbar \log(z + \tau w, \CC^n \setminus \Omega) > 0$ for some $z$ close to $\partial \Omega$. We will expand this function in a Taylor series in $\tau$. In fact,
    $$\log \delta(z + \tau w, \CC^n \setminus \Omega) = \log \delta(z, \CC^n \setminus \Omega) + \Re (A \tau) + \Re (B \tau^2) + C|\tau|^2 + o(|\tau|^2)$$
    for some $A, B \in \CC$ and $C > 0$.

    Now let $z(\tau) = z + \tau w + ae^{A\tau + B\tau^2}$ for some $a \in \CC$. Then
\begin{align*}
    \delta(z(\tau), \CC^n \setminus \Omega) &\geq \delta(z + \tau w, \CC^n \setminus \Omega) - \delta(a)|e^{A\tau + B\tau^2}|\\
    &\geq \delta(a) (e^{C|\tau|^2/2} - 1)|e^{A\tau + B\tau^2}| \sim |\tau|^2
\end{align*}
    for $|\tau|$ small enough. Choose $a$ so that $\delta(a) = d(z, \CC^n \setminus \Omega)$. Then $z(0) = z + a \in \partial \Omega$. Since the function looks like $|\tau|^2$ we have
\begin{align*}\partial_\tau \delta(z(\tau), \CC^n \setminus \Omega)|_{\tau = 0} &= 0\\
\partial_\tau^2 \delta(z(\tau), \CC^n \setminus \Omega)|_{\tau = 0} &> 0.
\end{align*}
    By the chain rule,
\begin{align*}
    0 &= \partial_\tau \delta(z(\tau), \CC^n \setminus \Omega)|_{\tau = 0} = -\sum_j \partial_j \rho z(0) z_j'(0)\\
    0 &< \partial_\tau^2 \delta(z(\tau), \CC^n \setminus \Omega)|_{\tau = 0} = -\sum_{j,k} \partial_j \dbar_k \rho z_j'(0) \overline z_k'(0).
\end{align*}
    Since $\rho < 0$, this contradicts the Levi condition.
\end{proof}
    We will not bother to prove the following theorem, but it is true. The proof uses the theory of Hormander $L^2$ estimates on complex manifolds with boundary, which is technically complicated but not very interesting.
\begin{theorem}[Levi problem]
    \index{Levi problem}
    If $\Omega$ is pseudoconvex then $\Omega$ is a domain of holomorphy.
\end{theorem}

\begin{theorem}
    Assume that $\omega$ is a neighborhood of $z_0$ and $\rho \in C^4(\omega)$, $\rho(z_0) = 0$, $d\rho(z_0) = 0$. Suppose that there is a $w \in \CC^n$ such that
    $$\sum_{j,k} \partial_j \dbar_k \rho(z_0) w_j \overline w_k < 0$$
    and
    $$\sum_j \partial_j \rho(z_0) w_j = 0.$$
    Then there is an $\omega' \subseteq \omega$, $z_0 \in \omega'$, such that for every $u \in C^4(\omega')$ such that for every $z \in \omega'$, $\rho(z) = 0$ implies
    $$\dbar u \wedge \dbar \rho(z) = 0.$$
    Let $\omega_+' = \{z \in \omega': \rho(z) > 0\}$. Then there is a function $U$ defined on $\omega'$ such that if $\rho(z) = 0$ then $U(z) = u(z)$, and such that $U \in A(\omega_+')$.
\end{theorem}
\begin{proof}
    Write $z = (z_1, z', z_n)$. There is an affine change of coordinates such that
    $$\rho(z) = \Im z_n + A_{11}|z_1|^2 + O(|z_1|^3) + O(|z'|^2)$$
    for some $A_{11} < 0$. In particular, we can find $\delta, \varepsilon > 0$ such that
    $$\omega' = \{z \in \CC^n: |z_1| < \delta, ~|z'| + |z_n| < \varepsilon\} \subseteq \omega$$
    satisfies $\rho(z) < 0$ if $|z_1| = \delta$, $z \in \omega'$, and also such that
    $$\partial_1 \dbar_1 \rho < 0$$
    on $\omega'$. Now the set of $z_1 \in \CC$ such that $|z'| + |z_n| < \varepsilon$ implies $\rho(z) < 0$ is connected: otherwise, $\rho$ would have a local minimum in the second connected component, yet $\Delta \rho < 0$ so this is impossible.
\begin{lemma}
    For every $f \in C^k_{(0, 1)}(\omega')$ such that $f|_{\omega' \setminus \omega_+'} = 0$, $k \geq 1$, $\dbar f = 0$, there is a $v \in C^k(\omega')$ such that $\dbar v = f$ and $v|_{\omega' \setminus \omega_+'} = 0$.
\end{lemma}
\begin{proof}
    We define
    $$v(z) = \frac{1}{2\pi i} \int_{|z_1| < \delta} \frac{f_1(\tau, z')}{\tau - z_1} ~d\tau \wedge d\overline \tau$$
    so $\dbar v = f$. In particular $v$ is analytic whenever $\rho \leq 0$. We claim $v = 0$ on $\omega' \setminus \omega_+'$. Near the boundary (except for the top) of $\omega'$, $\dbar v = 0$, and $v = 0$ at the bottom, so $v = 0$ near the bottom. The set of points where $\rho < 0$ is connected, so $v = 0$ there.
\end{proof}
    Let $v$ be as in the lemma. Let $U_0 \in C^2(\omega')$ be such that $\dbar U_0 = O(\rho^2)$ and $U_0|_{\rho=0} = u|_{\rho = 0}$. Then let $U = U_0 + v$. So $\dbar U = \dbar U_0 + \dbar v$, $\dbar v = - \dbar U_0$, and $v|_{\omega' \setminus \omega_+'} = 0$ so we're done.
\end{proof}

\section{Hormander $L^2$ estimates}
We want to use the method of a priori estimates to show that $\dbar u = f$ has a solution, but the Hilbert space $L^2(\CC^n)$ contains no holomorphic functions except $0$. Therefore we must weight the inner product to apply Hilbert space theory. Fix $\Omega \subseteq \CC^n$ open. We let $\lambda$ denote Lebesgue measure.

\begin{definition}
    Let $\varphi \in C^2(\Omega)$. We say that $\varphi$ is a \dfn{strictly plurisubharmonic function} or simply that $\varphi$ is \dfn{strictly plush} if
    $$\inf_{t \in \CC^n \setminus 0} \frac{\sum_j\sum_k \partial_j \dbar_k \varphi(z) t_j \overline{t_k}}{\sum_j |t_j|^2} > 0.$$
\end{definition}
\begin{definition}
Let $\varphi$ be a strictly plush function on $\Omega$. We define the \dfn{weighted inner product} with strictly plush weight $\varphi$ to be the inner product $(\cdot,\cdot)_\varphi$ of the Hilbert space $L^2(\varphi)$ corresponding to the Borel measure $e^{-\varphi} ~d\lambda$ on $\Omega$.
\end{definition}
In other words,
$$(f, g)_\varphi = \int_\Omega f(z) g(z) e^{-\varphi(z)} ~dz.$$
To motivate this definition, notice that
$$\int |u|^2 e^{-\varphi} = \int e^{2\log |u| - \varphi}$$
so we must have $\varphi > 2 \log |u|$ at infinity. But $\log |u|$ is subharmonic, so the point is that $\varphi$ must have an especially strong form of subharmonicity for this to work on as many holomorphic functions as possible. This leads us to consider $\varphi$ as a plush function.

Suppose that we have solved the equation $\dbar u = f$, for $f: \Omega \to \CC^n$ a good function. Then for $f$ to be the ``gradient" of $u$ with respect to $\dbar$, it must be the case that
$$\dbar_j f_k = \dbar_k f_j$$
since $u$ is smooth and so has equality of mixed partials. We call this condition the \dfn{Cauchy-Riemann constraint equation}. One could view it as the statement that the $1$-form $\overline du = \sum_k f_j ~dx_j$ is closed. Of course, $\overline du$ is an exact form, hence closed.

\begin{theorem}[Hormander's estimates]
    \index{Hormander's $L^2$-estimates}
    Let $\varphi$ be strictly plush and let
    $$\kappa(z) = \inf_{t \in \CC^n \setminus 0} \frac{\sum_j\sum_k \partial_j \dbar_k \varphi(z) t_j \overline{t_k}}{\sum_j |t_j|^2}$$
    witness that $\varphi$ is strictly plush. Assume that $f \in L^2(\varphi + \log \kappa, \Omega \to \CC^n)$ satisfies the Cauchy-Riemann constraints $\dbar_j f_k = \dbar_k f_j$. Then there is a $u \in L^2_\varphi$ such that $\dbar_j u = f_j$ and
    $$||u||_{L^2(\varphi, \Omega \to \CC)} \leq ||f||_{L^2(\varphi + \log \kappa, \Omega \to \CC^n)}.$$
\end{theorem}
Before proving the theorem, we need the notion of weak solution for the operator $\dbar$. We introduce the differential operators
$$\delta_j = \partial_j - (\partial_j \varphi).$$
If $u$ is a smooth solution to the equation $\dbar u = f$ and $g$ is smooth, then
$$(\delta_j g, u)_\varphi
    = \int_\Omega \partial g \overline u e^{-\varphi} - \int_\Omega \partial_j \varphi g \overline u e^{-\varphi}
    = (g, f_j)_\varphi.$$
In other words, $\dbar_j^* = \delta_j$.


For functions $\Omega \to \CC^n$ we define
$$(g, h)_\varphi = \sum_j (g_j, h_j)_\varphi.$$
\begin{proof}[Proof of the Hormander estimates]
    Fix a convex function $\phi \geq 0$ such that
    $$\phi(z) \geq |z| \log \kappa(z),$$
    which is possible because $\kappa > 0$. Then for any $\varepsilon > 0$, we have $\log \kappa \leq \varepsilon \phi$ on $|z| > 1/\varepsilon$. Thus
    $$\int_{|z| > 1/\varepsilon} |f|^2 e^{-\varphi - \varepsilon\phi} \leq \int_{|z| > 1/\varepsilon} |f|^2 e^{-\varphi-\log\kappa} < \infty,$$
    and the set $\{|z| \leq 1/\varepsilon\}$ is no problem for integrability, so $f \in L^2_{\varphi + \varepsilon\phi}$. Since $\phi$ is convex, it is plush, so $\varphi_\varepsilon = \varphi + \varepsilon \phi$ is strictly plush. Taking weakstar limits as $\varepsilon \to 0$, we can assume that $f \in L^2(\varphi)$.

    Fix $g \in C^\infty_c(\Omega \to \CC^n)$. Then
    \begin{align*}
(\delta_j g_j, \delta_k g_k)_\varphi &= -(\dbar_j \delta_k g_j, g_k)_\varphi \\
&= -(\delta_k \partial_{\overline{z}_j} g_j,g_k)_\varphi - ([\dbar_j, \delta_k]g_j, g_k)_\varphi \\
&= (\dbar_j g_j, \dbar_k g_k)_\varphi + (\partial_j \dbar_k \varphi g_j, g_k)_\varphi
\end{align*}
    so, summing both sides over $j, k$,
    $$(\delta g, \delta g)_\varphi + \frac{1}{2} \sum_{j \neq k} ||\dbar_j g_k - \dbar_k g_j||_\varphi^2 = \sum_j ||\dbar_j g||_\varphi^2 + \sum_{jk} (g_j \partial_j \dbar_k \varphi, g_k).$$
    By the Cauchy-Schwartz inequality,
    $$(g, f)_\varphi^2 = (g\kappa, f)_{\varphi + \log \kappa}^2 \leq ||g\kappa||_{\varphi + \log \kappa} ||f||_{\varphi + \log \kappa}$$
    and
\begin{align*}
    ||g\kappa||_{\varphi + \log \kappa}
        &= \inf_{t \neq 0} ||t||^{-2} \sum_{jk} \int_\Omega g\overline g e^{-\varphi} \partial_j \dbar_k \varphi t_j \overline{t_k}
        \leq \sum_{jk} \int_\Omega g\overline g e^{-\varphi} \partial_j \dbar_k \varphi\\
        &\leq \sum_j ||\dbar_j g||_\varphi^2 + \sum_{jk} (g_j\partial_j \dbar_k \varphi, g_k)
\end{align*}
    In conclusion,
$$(g, f)_\varphi^2 \leq ||\delta g||^2_\varphi ||f||_{\varphi + \log \kappa}^2 + \frac{1}{2} \sum_{j \neq k} ||\dbar_j g_k - \dbar_k g_j||_\varphi^2 ||f||_{\varphi + \log \kappa}^2.$$

    Let $N$ be the subspace of $L^2(\varphi, \Omega \to \CC^n)$ consisting of $g$ which satisfy the Cauchy-Riemann constraints. If $h \in N^\perp$ (with respect to $(\cdot, \cdot)_\varphi$) and $\psi$ is a test function, then $\dbar \psi \in N$, so $0 = (h, \dbar \psi)_\varphi = (\delta h, \psi)_\varphi$. But $\psi$ was arbitrary, so $\delta h = 0$.

    Let $P: L^2(\varphi, \Omega \to \CC^n) \to N$ be the canonical projection. Then
    $$|(g, f)_\varphi| = |(Pg, f)_\varphi| \leq ||f||_{\varphi + \log \kappa}^2 ||\delta g||_\varphi.$$
    Let us define the space $D$ of elements of $L^2(\varphi, \Omega \to \CC^n)$ of the form $\delta g$ for some $g \in L^2(\varphi)$, and define $T \in D^*$ by $T(\delta g) = (g, f)_\varphi$. Then $||T|| \leq ||f||_{\varphi + \log \kappa} < \infty$. So by the Hanh-Banach theorem, $T$ admits a linear extension $\tilde T$ to $L^2(\varphi, \Omega \to \CC^n)$. Then $\tilde T$ has a Riesz representation, say $u$, which completes the proof.
\end{proof}



\chapter{Multivariable holomorphic functional calculus}
This chapter follows Hormander's SCV book, Chapter III.

\section{The Gelfand transform}
Let $B$ be an abelian, unital Banach algebra. One of the fundamental problems of the theory of such algebras is to consider to what extent that $B$ can be approximated by algebras of the form $C(K)$, for $K$ a compact Hausdorff space.
\begin{definition}
    A \dfn{Banach algebra representation} of $B$ on $K$ is a continuous morphism of algebras $B \to C(K)$.
\end{definition}

To classify representations, we consider the space of characters on $B$.
\begin{definition}
    A \dfn{character} or \dfn{multiplicative functional} on $B$ is a continuous morphism of algebras $m: B \to \CC$ which is not identically $0$. The space of all characters on $B$ is denoted $M_B$.

    For each $f \in B$, the function $\hat f$ defined on characters by $\hat f(m) = m(f)$ is the \dfn{Gelfand transform} of $f$. We give the space $M_B$ the weakstar topology, namely the weakest topology such that for each $f \in B$, the Gelfand transform $\hat f$ is continuous. The resulting map $B \to C(M_B)$ is called the \dfn{Gelfand representation} of $f$.
\end{definition}
    By the Banach-Alaoglu theorem, $M_B$ is a compact Hausdorff space.

    The Gelfand representation is universal among representations of $B$.
\begin{lemma}
    If $T: B \to C(K)$ is a representation of $B$, then there is a map $\varphi$ so that for every $f \in B$,
    $$Tf = \hat f \circ \varphi.$$
\end{lemma}
\begin{proof}
    Recall that $Te$ is idempotent, so its image $(Te)(K)$ consists only of $0$ or $1$. Let $K_0$ be the kernel of $Te$ and $K_1$ be its complement in $K$. Then $\{K_0, K_1\}$ is a partition of $K$ into compact, open sets. But then for any $f \in B$, $Tf = 0$ on $K_0$, so we might as well assume $K = K_1$. Under this assumption, for each $x \in K$, the map $f \mapsto Tf(x)$ is a character, which we denote $\varphi(k)$.
\end{proof}

\begin{definition}
    Let $f \in B$. The \dfn{resolvent function} of $f$ is the meromorphic function $R_f: U \to B$ given by
    $$R_f(\lambda) = \frac{1}{f - \lambda e}.$$
    The domain $U$ of the resolvent function of $f$ is called the \dfn{resolvent set} of $f$. The complement in $B$ of $U$ of $f$ is called the \dfn{spectrum} of $f$, denoted $\sigma(f)$.
\end{definition}
    In case $B$ is a space of matrices, then the spectrum of $f$ is exactly the set of eigenvalues of $f$ viewed as a linear operator, since then $f$ solves the eigenvalue equation
    $$f(x) = \lambda x.$$
\begin{theorem}[spectral radius theorem]
    \index{spectral radius theorem}
    For each $f \in B$, $\sigma(f) = \{\hat f(m): m \in M_B\}$. Moreover,
    $$\sup_{m \in M_B} |\hat f(m)| = \lim_{n \to \infty} ||f^n||^{1/n}.$$
\end{theorem}
    The proof of this theorem uses some complex analysis, which we now consider.
\begin{lemma}
    Let $g \in B$. If $g$ is invertible, then the mapping
    $$\lambda \mapsto (g - \lambda h)^{-1}$$
    is continuous on the disk $D$ of all $\lambda$ such that
    $$|\lambda| < \frac{1}{||g^{-1}h||}.$$
    Assume $\omega \subseteq D$ is bounded by a finite number of $C^1$ arcs. If $\varphi$ is holomorphic on $\omega$ and $C^1$ on $\overline \omega$, then
    $$\int_{\partial \omega} (g - \lambda h)^{-1} \varphi(\lambda) d\lambda = 0.$$
\end{lemma}
\begin{proof}
    Let $H = g^{-1}h$ and
    $$I(\lambda) = g^{-1}\sum_{n=0}^\infty \lambda^n H^n.$$
    This series converges locally uniformly on $D$, in fact by definition of $D$. Also,
    $$I(\lambda)(g - \lambda h) = I(\lambda)g(e - \lambda H) = e.$$
    Therefore we can integrate term by term after multiplying by $\varphi(\lambda)$, and each term is holomorphic.
\end{proof}
\begin{lemma}
    If $(e - \lambda f)^{-1}$ exists for every $|\lambda| \leq R$, then for each $n \geq 0$,
    $$R^n ||f^n|| \leq \sup_{|\lambda| = R} ||(e-\lambda f)^{-1}||.$$
\end{lemma}
\begin{proof}
    By homotopy invariance and the above lemma, the integral
    $$\frac{1}{2\pi i} \int_{|\lambda| = r} (e-\lambda f)^{-1}\lambda^{-n-1} ~d\lambda$$
    is independent of $r$ if $r \leq R$, and if $r||f|| < 1$, then the integral is equal to $f^n$.
\end{proof}
\begin{lemma}
    For each $f \in B$, $\sigma(f)$ is nonempty.
\end{lemma}
\begin{proof}
    Assume $\sigma(f)$ is empty. Then $(e - \lambda f)^{-1}$ exists for every $\lambda \in \CC$, and the holomorphic function
    $$||(e - \lambda f)^{-1}|| \leq \frac{||f^{-1}||}{|\lambda|}||(e - \lambda^{-1}f^{-1})^{-1}||$$
    is bounded as $\lambda\to \infty$, contradicting Liouville's theorem.
\end{proof}
\begin{corollary}
    If $B$ is a field, then $B = \CC$.
\end{corollary}
\begin{proof}
    By the lemma, for every $f \in B$ we can find $\lambda \in \CC$ such that $f - \lambda e$ is not invertible, but since $B$ is a field, it follows that $f = \lambda e$.
\end{proof}
\begin{lemma}
    If $I$ is a proper ideal of $B$ then there is a $m \in M_B$ such that $m(f) = 0$ for every $f \in I$.
\end{lemma}
\begin{proof}
    By Zorn's lemma, we can find a maximal ideal $\mathfrak m \supseteq I$. The natural map $B \to B/\mathfrak m = \CC$ is a character, call it $m$.
\end{proof}
    Finally we are ready to prove the spectral radius theorem.
\begin{proof}[Proof of spectral radius theorem]
    We first claim that $\{\hat f(m): m \in M_B\} \subseteq \sigma(f)$: if $\lambda \notin \sigma(f)$, then there is a $g \in B$ so that $g(f - \lambda e) = e$, so $\hat g(\hat f - \lambda) = 1$. Therefore $\hat f(m) \neq \lambda$ for any $m$.

    Now let
    $$1/R \leq \sup_{z \in \sigma(f)} |z|.$$
    So if $|\lambda| \leq R$, $(e-\lambda f)^{-1}$ exists by the above lemmata. So
    $$\left(\limsup_{n \to \infty} R^n||f^n||\right)^{1/n} =  R\limsup_{n \to \infty}||f^n||^{1/n} \leq 1$$
    and it follows that
    $$\limsup_{n \to \infty} ||f^n||^{1/n} \leq \frac{1}{R} \leq \sup_{z \in \sigma(f)} |z|.$$

    Third, if $\lambda \in \sigma(f)$, then $f - \lambda e$ is not a unit, so the ideal $I = (f - \lambda e)$ is proper. Therefore we can find a $m \in M_B$ which is annihilated by $I$. Then $\lambda = m(f)$, so $\sigma(f) \subseteq \{\hat f(m): m \in M_B\}$. This proves the first assertion of the spectral radius theorem.

    Since the Gelfand representation is continuous, there is a $C \geq 1$ such that
    $$\sup_{m \in M_B} |\hat f(m)| \leq C||f||.$$
    So
    $$\sup_{m \in M_B} |\hat f(m)| \leq C^{1/n} ||f^n||^{1/n} \leq C^{1/n}||f||$$
    implying that
    $$\sup_{m \in M_B} |\hat f(m)| \leq \liminf_{n \to \infty} ||f^n||^{1/n}.$$
    Therefore by the lemmata
    $$\sup_{m \in M_B} |\hat f(m)| \leq \liminf_{n \to \infty} ||f^n||^{1/n} \leq \limsup_{n \to \infty} ||f^n||^{1/n} \leq \sup_{z \in \sigma(f)} |z| = \sup_{m \in M_B} |\hat f(m)|.$$
    This proves the second assertion.
\end{proof}
    Now we generalize the notion of a spectrum to several complex variables. A version of the spectral radius theorem holds still.
\begin{definition}
    The \dfn{joint spectrum} $\sigma(f_1, \dots, f_n)$ is the set of all $\lambda \in \CC^n$ such that the ideal
    $$(f_1 - \lambda_1 e, \dots, f_n -\lambda_n e)$$
    is proper.
\end{definition}
\begin{corollary}
    For $f_1, \dots, f_n \in B$,
    $$\sigma(f_1, \dots, f_n) = \{(\hat f_1(m), \dots, \hat f_n(m): m \in M_B\}.$$
\end{corollary}
    The proof is essentially the same. This generalization of the spectral radius theorem will allow us to classify the Gelfand representations of finitely generated Banach algebras.
\begin{theorem}
    Let $B$ be the Banach algebra generated by $f_1, \dots, f_n$. Then the mapping
\begin{align*}
    \varphi: M_B &\to \sigma(f_1, \dots, f_n)\\
    m &\mapsto (\hat f_1(m), \dots, \hat f_n(m))
\end{align*}
    is a homeomorphism. Moreover, $\sigma(f_1, \dots, f_n)$ is polynomially convex, and for each $f \in B$, one can approximate $\hat f \circ \varphi^{-1}$ uniformly by polynomials on $\sigma(f_1, \dots, f_n)$.
\end{theorem}
\begin{proof}
    Since $M_B$ carries the weakstar topology, $\varphi$ is continuous, and injective since if $p$ is a polynomial,
    $$m(p(f_1, \dots, f_n)) = p(\hat f_1(m), \dots, \hat f_n(m))$$
    (and polynomials in the $f_j$ are dense in $B$, by definition of $B$). By the corollary of the spectral radius theorem, $\varphi$ is surjective.

    To prove the second statement, let $K = \sigma(f_1, \dots, f_n)$, $z \in \hat K$, and define a map on the generators by $f_j \mapsto z_j$. This will extend to a character on all of $B$ if it is continuous; and indeed
    $$|p(z)| \leq \sup_{w \in K} |p(w)| \leq \sup_{m \in M_B} |m(p(f))| \leq |p(f)|.$$
    Therefore $z \in K$, proving the second claim. The final claim follows because polynomials are dense in $B$.
\end{proof}

\section{The holomorphic functional calculus}
We now show that holomorphic functions can be extended to an (abelian, unital) Banach algebra $B$, even in several complex variables.
\begin{theorem}[holomorphic functional calculus in several complex variables]
    \index{holomorphic functional calculus in several complex variables}
    Let $f_1, \dots, f_n \in B$ and let $\varphi$ be a holomorphic function on a neighborhood of the joint spectrum $\sigma(f_1, \dots, f_n)$. Then there is a $g \in B$ such that
    $$\hat g = \varphi(\hat f_1, \dots, \hat f_n).$$
\end{theorem}
One generally writes $g = \varphi(f_1, \dots, f_n)$, so we think of $\varphi$ as a function $B^n \to B$.

\begin{lemma}
    Let $\Omega \subseteq \CC^n$ be open and contain $\sigma(f_1, \dots, f_n)$. Then there is a finitely generated Banach subalgebra $B'$ of $B$ such that $f_1, \dots, f_n \in B'$ and $\sigma_{B'}(f_1, \dots, f_n) \subseteq \Omega$.
\end{lemma}
\begin{proof}
    As $B'$ increases, $\sigma_{B'}(f_1, \dots, f_n)$ decreases. So we show that for every $z \notin \sigma(f_1, \dots, f_n)$, we can find $B'$ so that $z \notin \sigma_{B'}(f_1, \dots, f_n)$. Indeed, we can find $f_{j+n} \in B$ so that
    $$e = \sum_{j=1}^n f_{j+n}(f_j - z_je).$$
    Now let $B'$ be the Banach algebra generated by the $f_j$.
\end{proof}
\begin{lemma}
    Let $B'$ be as above. Let $f_1, \dots, f_v$ be the generators of $B'$, and let $\pi: \CC^v \to \CC^n$ be the projection which annihilates $(0, \dots, 0, z_{n+1}, \dots, z_v)$. Then there are polynomials $p_k$ such that for each $z \in \CC^v$ such that for each $j$, $|z_j| \leq ||f_j||$, if
    $$|p_k(z)| \leq ||p_k(f_1, \dots, f_v)||,$$
    then $\pi(z) \in \Omega$.
\end{lemma}
\begin{proof}
    Assume $\pi(z) \notin \sigma_{B'}(f_1, \dots, f_n)$. Then the map $f_j \mapsto z_j$ cannot extend to a character on $B'$, so is discontinuous if we were to try to extend it; i.e. there is a $p$ so that
    $$|p(z_1, \dots, z_v)| \geq ||p(f_1, \dots, f_v)||.$$
    This is still true close to $z$, so use compactness of the closed polydisk
    $$\{z \in \CC^v: |z_j| \leq ||f_j||\}.$$
\end{proof}
    Now we come to the theorem that we will use to prove the holomorphic functional calculus.
\begin{theorem}
    Let $f_1, \dots, f_n \in B$ and let $\varphi$ be holomorphic in a neighborhood of $\sigma(f_1, \dots, f_n)$. Then there are $f_{n+1}, \dots, f_N$ and a holomorphic function $\Phi$ on a neighborhood of the polydisk
    $$\{z \in \CC^N: |z_j| \leq ||f_j||\}$$
    such that $\varphi(f_1, \dots, f_n) = \Phi(f_1, \dots, f_N)$.
\end{theorem}
\begin{proof}
    Let $\Omega$ be a neighborhood of $\sigma(f_1, \dots, f_n)$. By the lemma, we can find $f_{n+1}, \dots, f_v$ and $p_1, \dots, p_\mu$ satisfying certain conditions. Let $N = v + \mu$ and $f_{v+k} = p_k(f_1, \dots, f_v)$. The function $\varphi \circ \pi$ is holomorphic in a neighborhood of the compact set of all $z \in \CC^v$ such that $|z_j| \leq ||f_j||$ and $|p_k(z)| \leq ||f_{k+v}||$. Therefore by results in several complex variables, we can find the desired $\Phi$.
\end{proof}
\begin{proof}[Proof of holomorphic functional calculus]
    Let $\Phi$ and $f_{n+1}, \dots, f_N$ be as above. By holomorphy, we can write
    $$\Phi(z) = \sum_\alpha a_\alpha z^\alpha$$
    such that
    $$\sum_\alpha |a_\alpha| R^\alpha < \infty$$
    where $R = (||f_1||, \dots, ||f_N||)$ and $z = (z_1, \dots, z_N)$. Therefore the series
    $$g = \sum_\alpha a_\alpha f^\alpha$$
    norm-converges. Moreover,
    $$\hat g = \sum_\alpha a_\alpha \hat f^\alpha = \Phi(\hat f_1, \dots, \hat f_N) = \varphi(\hat f_1, \dots , \hat f_n).$$
\end{proof}



\chapter{Algebraic geometry}
Throughout this chapter, we assume that all rings are commutative and unital.

\section{Schemes and varieties}
\begin{definition}
    A \dfn{ringed space} $X = (X, \mathcal F)$ consists of a sheaf of rings $\mathcal F$ on $X$. If the stalks of $\mathcal F$ are all local rings, then we say that $X$ is a \dfn{locally ringed space}.

    A \dfn{morphism of ringed spaces} $\psi: (X, \mathcal F) \to (Y, \mathcal G)$ consists of a continuous map $\psi: X \to Y$ and for each $U \in \Open(Y)$, a morphism of rings $\psi_U: \mathcal G(U) \to \mathcal F(\psi^{-1}(U))$ such that for every open set $V \subseteq U$, the diagram
$$\begin{tikzcd}
\mathcal G(V) \arrow[r,"\psi_V"] \arrow[d] &\mathcal F(\psi^{-1}(V)) \arrow[d]\\
\mathcal G(U) \arrow[r,"\psi_U"] &\mathcal F(\psi^{-1}(U))
\end{tikzcd}$$
    commutes.

    Let $(X, \mathcal F)$ and $(Y, \mathcal G)$ be locally ringed spaces. A \dfn{morphism of locally ringed spaces} $\psi: (X, \mathcal F) \to (Y, \mathcal G)$ is a morphism of ringed spaces such that for every $x \in X$, the maximal ideal $\mathfrak m$ of the stalk $\mathcal F_x$ is given by $\mathfrak m = \psi_x(\mathfrak n)$ where $\mathfrak n$ is the maximal ideal of the stalk $\mathcal G_{\psi(x)}$ and $\psi_x$ is the colimit of morphisms $\psi_U$ as $U$ ranges over the directed set $\mathcal D_{\psi(x)}$ of all open sets $U \ni \psi(x)$.
\end{definition}
So a morphism of locally ringed spaces is a morphism of ringed spaces, whose domain and codomain are locally ringed, which preserves the maximal ideals at each stalk.

\begin{definition}
    Let $R$ be a ring. Let $X$ be the spectrum of $R$, equipped with the Zariski topology. If $U = D(f)$ is a distinguished open set, let $\mathcal F(U)$ be the localization of $R$ at $R \setminus D(f)$. Let $\mathcal F$ be the induced sheaf. Then $\Spec R = (X, \mathcal F)$ is called the \dfn{affine scheme} associated to $R$.
\end{definition}
\begin{proposition}
    Let $R$ be a ring. The affine scheme $\Spec R$ is a locally ringed space, and $R$ is the ring of global sections of $\Spec R$.
\end{proposition}
\begin{definition}
    A \dfn{scheme} is a locally ringed space which is locally an affine scheme. A \dfn{morphism of schemes} is a morphism of locally ringed spaces.
\end{definition}
    If $X$ is a scheme, then there is a unique morphism $X \to \Spec \ZZ$, which is the categorical dual of the morphisms $\ZZ \to R$ for each ring $R$ appearing in the definition of $X$.
\begin{definition}
    Let $S$ be a scheme. A \dfn{scheme over} $S$, $X$, is a scheme $X$ such that there is a morphism of schemes $\pi: X \to S$.

    Let $X$ and $Y$ be schemes over $S$, witnessed by morphisms $\pi: X \to S$ and $\varphi: Y \to S$. A \dfn{morphism of schemes over} $S$, $\psi: X \to Y$, is a morphism of schemes $\psi: X \to Y$ such that $\pi = \varphi \circ \psi$.

    In case $S = \Spec \CC$, we say that $X$ is a \dfn{complex scheme}.
\end{definition}
    Notice that if $X = (X, \mathcal F)$ is a complex scheme and $U \subseteq X$ is an affine subscheme, then $\mathcal F(U)$ admits a morphism of rings $\CC \to \mathcal F(U)$. This gives rise to a complex algebra structure on $\mathcal F(U)$.
\begin{definition}
    If $X$ is a complex scheme and every algebra $\mathcal F(U)$ is finitely generated over $\CC$, we say that $X$ is a \dfn{complex scheme of finite type}.
\end{definition}
\begin{definition}
    A \dfn{reduced scheme} $X = (X, \mathcal F)$ is a scheme such that for every open set $U \subseteq X$, the ring $\mathcal F(U)$ has no nilpotents.
\end{definition}
\begin{definition}
    Let $\pi: X \to Y$ be a morphism of schemes. The \dfn{diagonal morphism} $\delta_\pi: X \to X \times_Y X$ is the fiber product of the identity $X \to X$ with itself induced by $\pi$. If $\delta_\pi(X)$ is closed in $X \times_Y X$, we say that $\pi$ is a \dfn{separated morphism}.

    If the unique morphism $X \to \Spec \ZZ$ is separated, we say that $X$ is a \dfn{separated scheme}.
\end{definition}
\begin{definition}
    A \dfn{variety} is a reduced, separated complex scheme of finite type.
\end{definition}

\section{Formal power series}
Let $\sum_\alpha a_\alpha z^\alpha$ be a formal power series on $\CC^n$ with domain of (absolute) convergence $D$. Let $B$ be the set of $z$ such that $|a_\alpha z^\alpha|$ is uniformly bounded in $\alpha$. Clearly $D \subseteq B$.
\begin{lemma}
    Assume $w \in B$ and $U = \{z \in \CC^n: |z_j| < |w_j|\}$. Then $U \subseteq D$.
\end{lemma}
\begin{theorem}
    $D^* = \{\xi \in \RR^n: (e^{\xi_1}, \dots, e^{\xi_n}) \in D\}$ is an open, convex set. If $\xi \in D^*$ and $|\eta_j| \leq |\xi_j|$ then $\eta \in D^*$. Moreover, $z \in D$ if and only if $|z_j| \leq e^{\xi_j}$ for some $\xi \in D^*$.
\end{theorem}
\begin{proof}
    $D^*$ is the interior of $B^*$. We will show $B^*$ is convex. There is an $M$ such that $\xi, \eta \in B^*$ if and only if
    $$|a_\alpha e^{\alpha\xi}| \leq M$$
    and similarly for $e^{\alpha\eta}$. This remains true when we raise both sides to the $t$ or $1-t$ power. Then
    $$|a_\alpha|e^{\alpha(t\xi + (1-t)\eta)} \leq M.$$
    Thus $t\xi + (1-t)\eta \in B^*$.

    The other claims follow from the definition or are obvious from the lemma.
\end{proof}
\begin{definition}
    A \dfn{Reinhardt domain} is a set $\Omega \subset \CC^n$ such that for every $z \in \Omega$ and every $\theta \in \RR^n$, $(e^{i\theta_1} z_1, \dots, e^{i\theta_n} z_n) \in \Omega$.
\end{definition}


\section{Bergman kernels}
Suppose $\Phi$ is a strictly plush quadratic form on $\CC^n$. That is,
$$\Phi(z) = \Re \langle Az, z\rangle + \langle Cz, \overline z \rangle$$
where $A \in \CC^{n \times n}$ and $C$ is a positive matrix. (The inner product is antilinear in $\overline z$, hence why we needed complex conjugation). Then we define
$$L^2_\Phi(\CC^n) = \left\{u: \int_{\CC^n} |u(z)|^2 e^{-2\Phi(z)} ~dz < \infty\right\}.$$
Thus we can define $H_\Phi(\CC^n) = L^2_\Phi(\CC^n) \cap A(\CC^n)$. Taking the holomorphic part of a compactly supported function (which is always possible for smooth functions by the Hormander $L^2$ estimates), we see that $H_\Phi(\CC^n)$ is nonempty. $H_\Phi(\CC^n)$ is closed, hence a Hilbert space.

It is often useful to have a semiclassical parameter, so we put
$$||u||_\Phi^2 = \int_{\CC^n} |u|^2 e^{-2\Phi/h} ~dm.$$

Putting
$$u_\alpha(z) = e^{-\langle Az, z\rangle/h} z^\alpha$$
we recover an orthonormal basis
$$f_\alpha = C (h^{n + |\alpha|} \alpha!)^{-1/2}u_\alpha$$
of $H_\Phi$.

Let
$$\Pi_\Phi: L^2_\Phi \to H_\Phi$$
be the orthogonal projection. Then one can check that
$$\Pi_\Phi u(z) = C \int_{\CC^n} e^{2\Psi(z, \overline w)/h - 2\Phi(w)/h} u(w) ~dm(w),$$
where $\Psi: \CC^{2n} \to \CC$ is the unique analytic quadratic function such that
$$\Psi(z, \overline z) = \Phi(z).$$
\begin{example}
    If $\Phi(z) = |z|^2/2$ then $\Psi(z, w) = \langle z, w\rangle/2$ and
$$\Pi u(z) = \frac{1}{(\pi h)^n} \int_{\CC^n} e^{-\langle z, \overline w\rangle/h - |w|^2/h}u(w) ~dm(w).$$
\end{example}
    In quantum mechanics, $H$ is the space of wavefunctions. If $g \in L^\infty$ is a classical observable, we quantize $g$ by
    $$T_g = \Pi g \Pi.$$
    In fact, $g$ itself cannot be holomorphic by Liouville's theorem, but $T_g$ preserves $A$.
\begin{definition}
    The projection $T_g$ is called the \dfn{Toeplitz operator} of $g$.
\end{definition}
\begin{example}
    Let $g(z) = \overline z_j$, $u \in H_{\Phi + \varepsilon|z|^2}$, where $\Phi(z) = |z|^2/2$. Then $T_g$ carries $H$ to itself, and
    $$T_gu(z) = \frac{1}{(h\pi)^n} \int_{\CC^n} e^{-\langle z, \overline w \rangle/h - |w|^2/h} \overline w_j u(w) ~dm(w).$$
    We first see that
    $$\overline w_j e^{-\langle z, \overline w\rangle - |w|^2/h} = -h\partial_{w_j} e^{-\langle z, \overline w\rangle - |w|^2/h}$$
    and since the integrals converge, we integrate by parts to see that
    $$T_gu(z) = \frac{1}{(h\pi)^n} e^{-\langle z, \overline w\rangle/h - |w|^2/h} h\partial_{w_j}u(w) ~dm(w) = \Pi(h\partial_ju(z)) = h\partial_j u(z).$$
    That is, multiplication by $\overline z_j$ is the same as differentiating in $z_j$. So this is, in fact, a quantization.
\end{example}




\section{Quillen's theorem}
\begin{theorem}[Catlin-d'Angelo-Quillen]
    \index{Catlin-d'Angelo-Quillen theorem}
    Let
    $$f(z, \overline z) = \sum_{|\alpha| = |\beta| = m} c_{\alpha\beta} z^\alpha \overline z^\beta$$
    be a bihomogeneous quadratic form on $\CC^n$ such that $f(z, \overline z) > 0$ for every $z \neq 0$. Then there is a $N \in \NN$ and a polynomial
    $$P_j(z) = \sum_{|\alpha| = m} p_\alpha^j z^\alpha$$
    such that
    $$|z|^{2N} f(z, \overline z) = \sum_{j=1}^J |P_j(z)|^2.$$
\end{theorem}
    Quillen developed this theorem to prove the complex Nullstellensatz. It was also used by Polya for the following theorem.
\begin{theorem}[Polya]
    \index{Polya's theorem}
    Suppose $p$ is a real homogeneous polynomial on $\RR^n$ and $p(x) > 0$ if $\forall j ~x_j \geq 0$ and $\sum_j x_j = 1$. Then there is a $N \in \NN$ such that $(x_1 + \dots + x_n)^Np(x)$ has positive coefficients.
\end{theorem}
\begin{proof}
    Write $x_j = z_j \overline{z_j}$ and put $c_{\alpha\beta} = 0$ for $\alpha \neq \beta$, then use Quillen's theorem.
\end{proof}
    To prove Quillen's theorem, we develop the theory of real quadratic forms.

    Let $q: \CC^n \to \RR$ be a quadratic form.
\begin{lemma}
    There is a decomposition $q = h + \ell$ such that $h(iz) = -ih(z)$ and $\ell(z) = \ell(iz)$.
\end{lemma}
\begin{definition}
    $\ell$ is the \dfn{Levi form} of $q$.
\end{definition}
\begin{proof}
    Define $Jq(z) = q(iz)$. Then $J^2 = 1$. Put $h = (q - Jq)/2$, $\ell = (q + Jq)/2$. Then $h$ is \dfn{pluriharmonic} in the sense that for any $j$ in any coordinate system, $\partial_j \dbar_j h(iz)$ is constant because $h$ is a quadratic form. Moreover,
    $$\partial_j \dbar_j h(iz) = -\partial_j(\dbar_jh(iz)) = \partial_j \dbar_j h(iz)$$
    which proves the claim for $h$.
\end{proof}
    To prove Quillen's theorem, let
    $$P_f(z) = \sum_{|\alpha| = |\beta| = m} c_{\alpha\beta} z^\alpha (h\partial)^\beta$$
    be a quantization of $f$. Then if $h = 1/N$, $P_f$ carries the space $\mathcal P_{m + N}$ of homogeneous polynomials of degree $m + N$ to itself, as we will prove, and this will prove Quillen's theorem.
\begin{lemma}
    There is a polynomial $P$ such that
    $$f(z, \overline z) = \sum_{j=1}^J |P_j(z)|^2$$
    if and only if $A = (c_{\alpha\beta})_{\alpha\beta}$ is a positive-definite matrix.
\end{lemma}
    Note that this is not trivial because $A$ acts on the vector space $\CC^K$, where $K$ is the set of partitions of $m$, which by some combinatorics can be very large!
\begin{proof}
    For any symmetric matrix $A \in \CC^{K \times K}$ we can find $w_k \in \CC^K$, $\lambda_j$, $j,k \in K$, such that
    $$A = \sum_{j,k} \lambda_j w_k w_k^*$$
    by the spectral theorem. Here $f$ is real-valued, so $c_{\alpha\beta} = \overline{c_{\beta\alpha}}$ whence $A$ is symmetric. Thus we can use that decomposition.

    Let $Z = (z^\alpha)_{\alpha \in K}$. Then
    $$f(z, \overline z) = Z^*AZ = \sum_{\alpha \in K} \lambda_\alpha Z^*w_\alpha w_\alpha^* Z$$
    so $f(z, \overline z)$ is the sum over $\alpha$ of the sign of $\lambda_\alpha$ times $|P_\alpha(z)|^2$, where
    $$P_\alpha(z) = |\lambda_\alpha|^{1/2} w_\alpha^* Z = |\lambda_\alpha|^{1/2} \sum_{\beta \in K} \overline w_\alpha^\beta z^\beta.$$
    So if $A$ is positive then the $\lambda_\alpha \geq 0$.

    For the converse, just run the same argument in reverse.
\end{proof}
\begin{example}
    Let $z \in \CC^2$,
    $$f(z, \overline z) = |z_1|^4 + |z_2|^4 + c|z_1|^2 |z_2|^2$$
    for some $|c| \in (0, 2)$. Then $f$ is a positive quadratic form. There are only $3$ partitions of $2$, so the matrix $A$ acts on $\CC^3$ by
    $$A = \begin{bmatrix}
        1 &&\\&c&\\&&1
    \end{bmatrix}.$$
    Then $A$ is positive-definite if and only if $c > 0$, so that is exactly when $f$ is a positive quadratic form.
\end{example}
    Let $\mathcal P_{n + M}$ be the space of homogeneous polynomials of degree $n + M$. Let $\Phi(z) = |z|^2/2$ as in the theory of Bergman kernels and $T_\cdot$ be the quantization operator.
\begin{lemma}
    Let
    $$|z|^{2N} f(z, \overline z) = \sum_{|\alpha| = |\beta| = N + m} c_{\alpha\beta}^N z^\alpha \overline z^\beta$$
    be a bihomogeneous form. Let
    $$P_f(z) = \sum_{|\alpha| = |\beta| = m} c_{\alpha\beta}z^\alpha T_{\overline z^\beta}.$$
    Then $A = (c_{\alpha\beta})$ is positive if and only if there is a $c > 0$ such that for every $u \in \mathcal P_{n + M}$ we have
    $$\langle P_f u, u\rangle_\Phi \geq c||u||_\Phi$$
\end{lemma}
\begin{proof}
    The orthonormal projection $\Pi: L^2 \to H$ is self-adjoint so
    $$T_g^* = T_{\overline g}.$$
    Moreover, it is easy to check that $P_f$ is self-adjoint, and $P_f = \sum_{\alpha,\beta} c_{\alpha\beta} z^\alpha (h\partial)^\beta$. Then
\begin{align*}P_fg(z) &= \sum_{\alpha,\beta} c_{\alpha\beta} z^\alpha \Pi(\overline z^\beta g(z)) \\
&= \sum_{L=0}^\infty \frac{1}{(\pi h)^n} \int_{\CC^n} \frac{\langle z, \overline w\rangle^L}{h^LL!} f(z, \overline w) g(w) e^{-|w|^2/h} ~dm(w)\\
&= \sum_L (h\pi)^{-n} \int_{\CC^n} \sum_{|\mu| = L} \frac{z^\mu \overline w^\mu}{\mu! h^{|\mu|}} f(z, \overline w) g(w) e^{-|w|^2/2h} ~dm(w).
\end{align*}
Assume $g \in \mathcal P_{m + N}$. By homogeneity one can only get a nonzero contribution to the integral when $L = N$. So
$$P_fg(z) = (\pi h)^{-n} \int_{\CC^n} \sum_{|\mu| = N} \frac{z^\mu \overline w^\mu}{\mu! h^{|\mu|}} f(z, \overline w) g(w) e^{-|w|^2/h} ~dm(w).$$
Let $u \in \mathcal P_{m + N}$ expand as
$$u(z) = \sum_{|\gamma| = m + N} u_\gamma(z) z^\gamma.$$
Then
\begin{align*}\langle P_fu, u\rangle &=
h^{N + 2m}\sum_{\substack{|\alpha| = |\beta| = m\\|\mu| = N}} c_{\alpha\beta} \frac{(\alpha + \mu)!(\beta + \mu)!}{\mu!}u_{\beta + \alpha} \overline u_{\alpha + \mu}\\
&= (\pi h)^{-n} h^{N+2m} \sum_{|\gamma| = |\rho| = N + m} c^N_{\rho\gamma} \rho! \gamma! u_\rho \overline u_\gamma
\end{align*}
and $(c^N_{\rho\gamma}\rho!\gamma!)$ is positive iff $A$ is positive. Since
$$\frac{\langle z, \overline z\rangle^N}{N!} \sum_{|\alpha|=|\beta|=m} c_{\alpha\beta}z^\alpha z^\beta = \sum_{\substack{|\alpha| = |\beta| =m\\|\mu| = N}} \frac{c_{\alpha\beta}}{\mu!} z^{\alpha + \mu} \overline z^{\beta + \mu}$$
we plug this back into $\langle Pf u, u\rangle$.
\end{proof}
\begin{lemma}
    For every $\delta > 0$ and $m > 1$ there is a $\varepsilon > 0$ such that if $|Mh - 1| < \varepsilon$, then for every $u \in \mathcal P_M$,
    $$||~|z|^mu||_{L^2_\Phi(|z| \leq 1 - \delta)} \leq O(h^\infty)||u||_\Phi.$$
\end{lemma}
\begin{proof}
    Let
    $$\Pi_M: L^2_\Phi \to \mathcal P_M$$
    be the orthogonal projection. Now
    $$||\Pi_M |z|^m 1_{|z| \leq 1/2} \Pi_M||_{L^2_\Phi \to L^2_\Phi} = O(h^\infty)$$
    if $hM$ is close to $1$. In fact, it is no trouble to reduce to when $m = 0$ since $|z|^m < 2^{-m}$ and then
    $$||u||_{L^2_\Phi(|z| < 1/2)}^2 = \langle 1_{|z| < 1/2}u, u\rangle_\Phi = \langle \Pi_M 1_{|z| < 1/2}\Pi_Mu, u\rangle_\Phi.$$
    We now use Schur's criterion with $p(w) = |w|^M$. In fact
    $$\Pi_Mu(z) = (\pi h)^n \int_{\CC^n} \langle z, \overline w\rangle^M\frac{u(w)}{M!h^M} e^{-|w|^2/h} ~dw$$
    so if $K$ is the integral kernel defined by
    $$\Pi_M1_{|z|\leq 1/2}\Pi_M = \int_M K(z, w) u(w) e^{-|w|^2/h} ~dw$$
    we have
    $$K(z, w) = (h\pi)^{-2n} \int_{\CC^n} \frac{\langle z, \overline \zeta\rangle^M}{M!h^M} 1_{|\zeta|<1/2} \frac{\langle \zeta, \overline w\rangle^M}{M!h^M} e^{-|\zeta|^2/h} ~d\zeta$$
    since by Fubini's theorem the integral kernel of a product of integral operators is the product of the integral kernels. Thus
\begin{align*}|K(z, w)| &\leq (\pi h)^{-2n} \int_{|\zeta|<1/2} \frac{|z|^M|\zeta|^{2M}|w|^M}{M!h^M M!h^M} e^{-|\zeta|^2/h} ~d\zeta
\end{align*}
    implies
\begin{align*}
    \int_{\CC^n} |K(z, w)| |w|^M e^{-|w|^2/h} ~dw &\leq \frac{|z|^M}{(\pi h)^{2M}} \int_{\CC^n} \int_{|\zeta| < 1/2} \frac{|\zeta|^{2M}}{M!h^M} \frac{|w|^{2M}}{M!h^M} e^{-|\zeta|^2/h} e^{-|w|^2/h} ~d\zeta ~dw\\
    &=: I_1I_2
\end{align*}
    where we are thinking of the $e^{-|\cdot|^2/h}$ as a Radon-Nikodym derivative of a certain measure (so we can use Schur's criterion on that measure). Using polar coordinates,
\begin{align*}I_1 &\leq \frac{C}{M!h^{M+n}} \int_0^\infty r^{2M+2n-1} e^{-r^2/h} ~dr\\
&= O\left(\frac{1}{M!}\right) \int_0^{\infty} t^{M+n-1} e^{-t} ~dt\\
&\leq O\left(\frac{1}{M!}\right) (M + n - 1)! \leq O((M + n)^n).
\end{align*}
    Since $Mh$ is close to $1$, $e^{(M+m+n-1)t}$ looks like $e^{t/h}$, and if $1 - \rho = Mh$ then $\rho$ is small. We recall that $\log 1/4 - 1/4 \approx -1.6 < 1$. So if we take $r^2 = t$,
\begin{align*}
    I_2 &\leq C\int_0^{1/2} \frac{r^{2M + 2n - 1}}{M!h^{M+n}} e^{-r^2/h} ~dr \\
    &= C\int_0^{1/4} \frac{t^{M+m+n-1}}{M!h^{M+n}} e^{-t/h} ~dt
    = \frac{Ce^{\delta/4h}}{M!h^{M+n}} \int_0^{1/4} (te^{-t})^{1/h} ~dt\\
    &= \frac{Ce^{\delta/4h}}{M!h^{M+n}} \int_0^{1/4} e^{(\log t - t)/h} ~dt
    \leq C\frac{e^{\delta/4h}-1.5/h}{M!h^{M+n}}\\
    &\leq C\frac{e^{-1.2/h}}{M!(1-\rho)^{-(n+M)}M^{-(n+M)}}
    \leq C\frac{(1+\rho)^{n+M}e^{-1.2/h}}{M^{M+1/2}M^{-M}M^{-n}}\\
    &\leq O(M^n (1 + \rho)^{n+M}) e^{-(1-\rho)M}
    \leq O(e^{-CM}) = O(e^{-C/h})
\end{align*}
    by Stirling's formula.
\end{proof}
\begin{lemma}
    Let $|\alpha| = |\beta| = m$. There are $p_j \in \mathcal P_{m - j}$ such that if
    $$q_{\alpha\beta}(z, \overline z) = z^\alpha \overline z^\beta + \sum_{j=1}^n h^j p_j^{\alpha\beta}(z, \overline z)$$
    then $z^\alpha T_{\overline z^\beta} = T_{q_{\alpha\beta}}$.
\end{lemma}
\begin{proof}
    This is obvious if $m = 0$. Otherwise, assume that it is true for $m$, and use the fact that
    $$T_{z^\alpha \overline z^\beta} = (h \partial_z)^\beta z^\alpha = z^\alpha(h\partial_z)^\beta \sum_{j=1}^m h^j \sum_{|\mu|=m-j} p_j^{\alpha\beta} z^\mu (h\partial_z)^\mu$$
    to prove the lemma by induction.
\end{proof}
\begin{proof}[Proof of Quillen's theorem]
    By a previous lemma, we have $f = T_q$ where
    $$q(z, \overline z) = f(z, \overline z) + \sum_{j=1}^m h^j p_j(z, \overline z)$$
    for some $p_j \in \mathcal P_{m - j}$ which depend on our choice of $h$. We claim that for some $N > 1$, $h < 1$ and every $u \in \mathcal P_{m + N}$, there is a $c > 0$ such that
    $$\langle T_qu, u\rangle_\Phi \geq c||u||^2_\Phi.$$
    In fact we take $c$ so that $f(z, \overline z) > 2c$ for $2|z| > 1$, which is possible by homogeneity of $f$. So if $h > 0$ is small enough, then
    $$q(z, \overline z) > c$$
    for every $z$ with $2|z| > 1$. In particular we have the luxury to choose $h$ so that we can find $N$ such that $N = 1/h$. Now $\Pi$ is self-adjoint and $u \in H$, so
\begin{align*}
    \langle T_qu, u\rangle_\Phi &= \langle \Pi q\Pi u, u\rangle_\Phi = \langle q\Pi u, \Pi u\rangle_\Phi \\
    &= \langle qu, u\rangle_\Phi \geq c\langle 1_{|z| \geq 1/2}u, u\rangle_\Phi - c||u||_{L^2_\Phi(|z| < 1/2)}\\
    &= c||1_{|z| \geq 1/2} u||_{L^2_\Phi(|z| \geq 1/2)}^2 - O(h^\infty)||u||_\Phi\\
    &\geq c\frac{||u||_\Phi^2}{2}.
\end{align*}
\end{proof}

\chapter{Line bundles over complex varieties}
\begin{definition}
    An \dfn{immersion} is an injective continuous function.
\end{definition}

\begin{definition}
    An \dfn{holomorphic atlas} on a topological space $M$ is an open cover $(U_\alpha)_\alpha$ equipped with open immersions $\tau_\alpha: U_\alpha \to \CC^n$ such that whenever $U_\alpha \cap U_\beta$ is nonempty, the mapping
    $$\tau_\alpha \circ \tau_\beta^{-1}: \tau_\beta(U_\alpha \cap U_\beta) \to \tau_\alpha(U_\alpha \cap U_\beta)$$
    is holomorphic.
\end{definition}

\begin{definition}
    A \dfn{complex manifold} $M$ is a Hausdorff space equipped with a holomorphic atlas.
\end{definition}

\begin{definition}
    A function $f: M \to \CC^m$ is a \dfn{holomorphic function} if for every $\alpha$, $f \circ \tau^{-1}: \tau_\alpha(U_\alpha) \to \CC^,$ is holomorphic.
\end{definition}

\begin{example}
    Let
    $$M = \{z \in \CC^{n+1}: z_0^2 + \dots + z_n^2 = 1\}.$$
    Then there is a $j$ such that $z_j \neq 0$. By the implicit function theorem, we can show that $M$ is a complex manifold. But it is not compact, and in fact has complex codimension $1$.
\end{example}

\begin{definition}
    Let $V$ be a complex vector space, which the multiplicative group $\CC^*$ acts on by scalar multiplication. Let $\PP(V) = (V\setminus 0)/\CC^*$, the \dfn{complex projective space}. Define for $x \in \PP(V)$ the equivalence class $[x] \in \PP(V)$. Define $\Omega_j = \{[x] \in \PP(V): x_j \neq 0\}$. Then define
    $$\tau_j^{-1}([x]) = (x_0x_j^{-1}, \dots, x_{j-1}x_j^{-1}, x_{j+1}x_j^{-1}, \dots, x_nx_j^{-1}).$$
    Then for $z \in \tau_j(\Omega_i \cap \Omega_j)$,
    $$\tau_i \circ \tau_j^{-1}(z) = (z_0z_i^{-1}, \dots, z_{j-1}z_i^{-1}, z_i^{-1}, z_{j+1}z_i^{-1}, \dots, z_{i-1}z_i^{-1}, z_{i+1}z_i^{-1}, \dots, z_nz_i^{-1}).$$
\end{definition}
    Then if $V = \CC^{n+1}$, $\PP(V) = S^{2n-1}/S^1$ where $S^1$ acts on $S^{2n-1}$ by scalars. So $\PP(V)$ is a compact complex manifold.
\begin{example}
    Let $M = \{x \in \CC^{n+1}: x_0^2 + \dots + x_{n+1}^2 = 0\}/\CC^*$, where $\CC^*$ acts on $\CC^{n+1}$ by scalars. By a similar argument as with projective space, $M$ is a compact complex manifold.
\end{example}

\begin{theorem}
    The only holomorphic functions on a compact connected complex manifold are constant.
\end{theorem}
\begin{proof}
    A function would have to attain a maximum since the manifold is compact, and by the maximum principle if a function attains its maximum on the interior of a connected set then it is constant there.
\end{proof}

\section{Holomorphic line bundles}
\begin{definition}
    A \dfn{holomorphic line bundle} is a holomorphic projection of complex manifolds $\pi: E \to M$, such that for every $x \in M$, $E_x = \{\pi^{-1}(x)\}$ is isomorphic to $\CC$, and that there is an open set $U \ni x$ and a holomorphic function $\Theta: \pi^{-1}(U) \to U \times \CC$ such that $\Theta|_{E_x}: E_x \to \{x\} \times \CC$ is an isomorphism of vector spaces.
\end{definition}
    We define $\Theta_{j\ell} = \Theta_j \cap \Theta_\ell^{-1}$ whenever $U_j \cap U_\ell$ is nonempty. Then $\Theta_{j\ell}(x, \cdot)$, $x \in M$, is a linear map $\CC \to \CC$, so there is a scalar $g_{j\ell}(x)$ such that $\Theta_{j\ell}(x, t) = g_{j\ell}(x)t$.
\begin{definition}
    The functions $g_{j\ell}: \Theta_j \cap \Theta_\ell^{-1} \to \CC$ are called \dfn{transition functions} for the holomorphic line bundle.
\end{definition}
    We have $g_{j\ell}g_{\ell j} = 1$. In fact, on $U_j \cap U_k \cap U_\ell$, then $g_{j\ell}g_{\ell k}g_{kj} = 1$. On the other hand, we have a holomorphic line bundle for any family of functions with these compatibility conditions. Let $J$ be the index set, $(j, x, t) \sim (j', x, t')$ whenever $t' = g_{j'j}t$. Then $J \times M \times \CC$ projects by $\sim$ to a holomorphic line bundle $E$.
\begin{example}
    The \dfn{trivial line bundle} is $E = M \times \CC$.
\end{example}
\begin{example}
    The \dfn{tautological line bundle} $O(-1)$ over $\PP^n$, the moduli space of all lines through $0 \in \CC^{n+1}$, sends the line corresponding to each point of $\PP^n$ to itself. It is defined by
    $$O(-1) = \{([x], \xi) \in \PP^n \times \CC^{n+1}: \xi \in [x]\}.$$
    (Here we allow $0 \in [x]$.) We define $\Theta_j([x], \xi) = \xi_j$. Then $\Theta_j \circ \Theta_\ell^{-1}([x], \xi) = x_j\xi/x_\ell$. That is,
    $$g_{j\ell}(x) = \frac{x_j}{x_\ell}.$$
\end{example}

\begin{definition}
    Let $\pi: E \to M$ be a holomorphic line bundle. A \dfn{section} is a right inverse of $\pi$.
\end{definition}
    So a section carries $x \in E$ to the complex line $\CC \times \{x\}$. We denote by $C^\infty(M, E)$ the space of smooth sections of $\pi$. The space of holomorphic sections is denoted by $H^0(M, E)$, for sheaf-theoretic reasons.
\begin{example}
    For the tautological line bundle, let $x \in U_j$. We define a vector space isomorphism $e_j: E_x \to \CC$ that sends a point in $[x]$ to its $j$th coordinate. This allows us to express as section $s$ as $s(x) = s_j(x) e_j(x)$ whenever $x \in U_j$. If $x \in U_j \cap U_\ell$, then $e_\ell(x) = g_{j \ell}(x)e_j(x)$ and $s_j(x) e_j(x) = s_\ell(x) e_\ell(x)$. So $s_j(x) e_j(x) = s_j(x) g_{\ell j}(x) e_\ell(x) = s_\ell(x) e_\ell(x)$ whence $s_j(x)/x_j = s_\ell(x)/x_\ell$. (Clearly this does not depend on the choice of $x \in [x]$.)

    A section $s$ of $O(-1)$ defines a function on $\CC^{n+1} \setminus 0$, $\tilde s$, by, for $[x] \in U_j$,
    $$\tilde s(x) = \frac{s([x])}{x_j}.$$
    Then $\tilde s$ is well-defined, does not depend on the choice of $j$, and is homogeneous of degree $-1$. So $C^\infty(\PP^n, O(-1))$ is infinite-dimensional while $H^0(\PP^n, O(-1)) = 0$.
\end{example}
    We now define operations on the category of line bundles. The goal is to construct line bundles that have holomorphic sections.
\begin{definition}
    Let $M$ be a complex manifold. If $E$ is a holomorphic line bundle, we define the \dfn{dual line bundle} $E^*$ by requiring that the fibers $E_x^*$ are dual vector spaces to the fibers $E_x$. Given $g_{ij}$ the transition maps for $E$, we define the dual transition maps $g_{ij}^* = g_{ij}^{-1}$.
\end{definition}
    Then $E^*$ is a holomorphic line bundle, and given $x \in U_j \cap U_k \subset E$, $\xi \in E_x$, $f \in E_x^*$, $f(\xi)$ does not depend on whether we compute $f(\xi)$ in $U_k$ or in $U_j$.
\begin{example}
    The dual of the tautological line bundle is by definition $O(1) = O(-1)^*$. It has the transition maps
    $$g_{ij}^*([x]) = \frac{x_j}{x_i}.$$
    As above, the sections are functions on $\CC^{n+1} \setminus 0$ which are homogeneous of degree $1$. So $H^0(\PP^n, O(1))$ consists of linear forms on $\CC^{n+1}$ (since every holomorphic function extends over $0$ on $\CC^{n+1}$.)
\end{example}

\begin{definition}
    Let $F,E$ be holomorphic line bundles over $M$. We define the \dfn{tensor product of line bundles} by $(F \otimes E)_x = F_x \otimes E_x$ on fibers and
    $$g_{ij}^{F \otimes E} = g_{ij}^F \otimes g_{ij}^E.$$
\end{definition}
    Here the tensor product of holomorphic functions is defined by pointwise multiplication.
\begin{example}
    Let $O(k) = O(1)^{\otimes k}$ (for $k \geq 0$; for $k < 0$ we have $O(k) = O(-1)^{\otimes -k}$). Then we have transition maps $g_{ij}^k([x]) = x_j^k x_i^{-k}$ so $H^0(\PP^n, O(k))$ consists of $k$th degree forms on $\CC^{n+1}$. The dimension of $H^0(\PP^n, O(k))$ is $(n+k)!/n!$.
\end{example}
\begin{definition}
    The \dfn{Picard group} is the group $\{O(k): k \in \ZZ\}$ of line bundles on $\PP^n$. with tensor product as multiplication and duality as inversion.
\end{definition}
    So the Picard group is isomorphic to $\ZZ$. The identity of the Picard group $O(0)$ is the trivial bundle. The sections on $O(0)$ are exactly those functions $\PP^n \to \CC$.


\begin{definition}
    A \dfn{Hermitian metric} on a holomorphic line bundle $h = (h_j)_j$ is a vector of smooth $h_j: U_j \to [0, \infty)$ satisfying the compatibility condition $h_j(x) = |g_{ij}(x)|^2 h_i(x)$, such that with $e_j(x) = \Theta^{-1}_j(x, 1)$ defined for $x \in U_j$, we have norms $||\cdot||$ on each fiber defined by
    $$||e_j(x)||^2_h = h_j(x).$$
\end{definition}
    The norm is well-defined because any element of a fiber $E_x$ is a scalar multiple of $e_j(x)$. For a section $s$ we have
    $$||s(x)||_h^2 = h_j(x) |s_j(x)|^2$$
    in $U_j$.
\begin{definition}
    The \dfn{Fubini-Study metric} is the Hermitian metric on $O(1)$ given by
    $$h_j([x]) = \frac{|x_j|^2}{|x|^2}$$
    for $[x] \in \PP^n$.
\end{definition}
\begin{example}
    Let
    $$f(x, \overline x) = \sum_{|\alpha| = |\beta| = k} c_{\alpha\beta} x^\alpha \overline x^\beta$$
    be such that $f(x, \overline x) > 0$. Then we can define
    $$h_j(x) = \frac{|x_j|^{2k}}{f(x, \overline x)}.$$
    By Quillen's theorem, if $k$ is large enough then there is a polynomial such that the metric we have just defined is the pullback of the Fubini-Study metric.
\end{example}
\begin{definition}
    A \dfn{Hermitian line bundle} is a holomorphic line bundle equipped with a Hermitian metric.
\end{definition}
\begin{definition}
    A \dfn{positive line bundle} is a Hermitian line bundle $(E, h)$ such that $h_j = e^{-\varphi_j}$ for some strictly plush functions $\varphi_j$.
\end{definition}
    On a positive line bundle, there will be lots of holomorphic sections.
\begin{example}
    Take $U_0 \subset \PP^n$ to be the set of $[x]$ such that $x_0 \neq 0$. Then $h_0([x]) = |x_0|^2|x|^{-2}$ for the Fubini-Study metric. The Fubini-Study metric makes $O(1)$ into a positive line bundle by
    $$\varphi_0(z) = - \log(|x_0|^2 |x|^{-2}) = \log(1+|z|^2).$$
    In fact,
    $$\partial_j \dbar_k \varphi_0(z) = \frac{\delta_{jk}}{1 + |z|^2} - \frac{z_k \overline z_j}{(1 + |z|^2)^2}.$$
    It is easy to check that this matrix is positive-semidefinite, so $(O(1), h)$ is a positive line bundle.
\end{example}

\section{Integration on Hermitian line bundles}
Let $h$ be the Hermitian line bundle defined by $h_\alpha = e^{-\varphi_\alpha}$ for some strictly plurisubharmonic function $\varphi_\alpha$.
\begin{definition}
The \dfn{Levi form} of $h$ is given by
$$\omega_\alpha = \frac{1}{2i}\partial\dbar \partial_\alpha.$$
\end{definition}
The Levi form is a $(1, 1)$-form, given by
$$\omega_\alpha = \frac{1}{2i} \sum_{j,k} \partial_j\dbar_k \varphi_\alpha dx_j \wedge d\overline x_k.$$
Then
$\varphi_\alpha = 2\log|g_{\alpha\beta}| + \varphi_\beta$ for transition functions $\varphi$. It follows that $\omega_\alpha = \omega_\beta$ on overlapping patches so $\omega$ is a real $2$-form.

\begin{example}
    Let $h$ be the Fubini-Study metric. Then the Levi form of $h$ is
\begin{align*}\omega_\ell &= \frac{i}{2} \sum_j \frac{dx_j \wedge d\overline x_j}{1 + |x|^2} - \sum_{\substack{j \neq \ell\\k\neq \ell}} \frac{\overline x_j x_k ~dx_j \wedge d\overline x_k}{(1+|x|^2)^2}\\
    &= \frac{i}{2}\left(\frac{d(x~d\overline x)}{(1 + |x|^2)} - \frac{(\overline x ~dx)\wedge(x ~d\overline x)}{(1 + |x|^2)^2}\right).
\end{align*}
\end{example}

Given a Levi form $\omega$ on an $n$-dimensional manifold, we obtain a volume form $dV = \omega^n/n!$ (where $\omega^n$ is the exterior power).
\begin{example}
    The Fubini-Study Levi form is invariant under the unitary group. We can use this diagonalize the Fubini-Study metric so that the double sum is only a single sum, and prove that
    $$dV = \frac{i^n}{2^n} \frac{dx_1 \wedge d\overline x_1 \wedge \dots \wedge dx_n \wedge d\overline x_n}{(1+|x|^2)^{n+1}}.$$
\end{example}
Because we have a volume form, integration makes sense.
\begin{definition}
    The space $L^2(M, E, h)$ is the completion of the space of $s \in C^\infty(M, E)$ for which the norm defined by the inner product
    $$\langle s, s'\rangle_h = \int_M \langle s(x), s'(x)\rangle_h ~dV.$$
\end{definition}
Here the inner product in the integral is the inner product induced on each line appearing in the line bundle induced by the Hermitian metric $h$.

We thus introduce the Bergman projection $L^2(M, E) \to H^0(M, E)$, which is orthogonal. To construct it, we compute an orthonormal basis of $H^0(M, E)$.
\begin{example}
    For the Fubini-Study metric on $O(k)$, $O$ the Picard group, consider the basis $s_\alpha^k$ such that on the patch $\Omega_0$, $s_\alpha^k(x) = x_1^{\alpha_1}\dots x_n^{\alpha_n}$, $|\alpha| = k$. Then
\begin{align*}
    \langle s_\alpha, s_\beta\rangle_{FS} &= \int_{\PP^n} x^\alpha \overline x^\beta h_{FS,0}(x) ~dV_{FS} \\&= \frac{i}{2} \int_{\CC^n} \frac{x_1^{\alpha_1} \cdots x_n^{\alpha_n} \overline x_1^{\beta_1} \cdots \overline x_n^{\beta_n}}{(1+|x|^2)^{k+n+1}} ~dx_1\wedge d\overline x_1\wedge \cdots \wedge dx_n \wedge d\overline x_n\\
    &= \delta_{\alpha\beta} \pi^n \frac{\alpha!}{(n+k)!}
\end{align*}
    where we used polar coordinates. Therefore we normalize by dividing $s^k_{\alpha,0}$ by $\sqrt{(k+n)!/(\alpha!\pi^n)}$ to get an orthonormal basis. The Bergman projection is given by
    $$\Pi_ku(x) = \sum_{|\alpha| = k} s_\alpha^k(x) \langle u, s_\alpha^k\rangle_k.$$
    The \dfn{Bergman kernel} $B_k$ is defined by
    $$\Pi_ku(x) = \int_{\PP^n} \langle u(y), B_k(y, x)\rangle_h ~dV.$$
    So we have
    $$B_k(y, x) = \sum_\alpha s_\alpha^k(y) \overline{s_\alpha^k(x)}.$$
    Therefore $B_k$ is holomorphic in the first variable and antiholomorphic in the second variable. We conclude that $B_k$ can be given by the explicit formula
    $$B_k(x, y) = \sum_{|\alpha| = k } \frac{(k+n)!}{\alpha!\pi^n} z^\alpha \overline w^\alpha = \frac{(k+n)!}{k!\pi^n} \langle z, w\rangle^k$$
    where $x = [z]$, $y = [w]$. In particular, the Bergman kernel is given by the Hermitian metric:
    $$B_k(x, x) = e^{-2k\varphi_0(x)} = \frac{(k+n)!}{k!\pi^n}.$$
\end{example}

\section{Asymptotics for the Bergman kernel}
    Here we let, for $L$ a line bundle, $L^k$ denote the $k$th tensor power of $L$ with itself.
\begin{theorem}[Fefferman, Boutet, de Monvel, Sjostrand, Zelditch, Catlin, Berman, Bernsom]
    Let $L \to M$ be a positive Hermitian line bundle and let $s_j^k$ be an orthonormal basis of $H^0(M, L^k)$. Then there is an asymptotic expansion
    $$\sum_j |s_j^k(x)|^2_h = \frac{k^n}{\pi^n} + \sum_{\ell=1}^\infty a_\ell(x)k^{n-\ell}.$$
\end{theorem}
    Towards this theorem, we work locally. We identify a coordinate patch with $B_{\CC^n}(0, 1)$ and fix a strictly plurisubharmonic weight $\varphi$ on $B_{\CC^n}(0, 1)$ and a semiclassical parameter $h \in (0, 1)$. This gives a $(1, 1)$-form
    $$\omega = -i\partial\dbar\varphi = \sum_{jk} \partial_j \dbar_k \varphi ~dx_j \wedge d\overline x_k.$$
    We then have a volume form defined by $n! ~dV = \omega^k$, the right hand side being an exterior power. Then
    $$||u||_\varphi^2 = \int_{B_{\CC^n}(0, 1)} |u(x)|^2 e^{-2\varphi(x)/h} ~dV(x)$$
    is a $L^2$-norm and we denote its inner product by $(\cdot,\cdot)_\varphi$. We will obtain a local reproducing kernel $K$ given some $\varepsilon > 0$ and $\chi$ a $B_{\CC^n}(0, \varepsilon)$-cutoff function, i.e.
    $$u(x) = \int_{B_{\CC^n}(0, 1)} \chi(y)u(y) \overline{K(y, x)} e^{-2\varphi(y)/h} ~dV(y).$$
\begin{definition}
    The reproducing kernel $K$ is called a \dfn{Bergman kernel} if $K(x, \cdot)$ is holomorphic.
\end{definition}
\begin{example}
    Reproducing kernels also have applications in machine learning.
\end{example}
    To construct the Bergman kernel, we obtain an approximate reproducing kernel, which is correct up to an error of order $h^\infty$.

    Recall that for $A: L^2_\varphi \to L^2_\varphi$ an integral operator, $e^-\varphi A e^\varphi$ sends $L^2$ to itself an its integral kernel is given by $e^{-\varphi(x)/h} K_A(x, y) e^{-\varphi(y)/h}$.

\begin{definition}
    Let $\Lambda \subseteq B_{\CC^n}(0, 1) \times \CC^n$, $\Lambda = \{(y, \xi)\}$ where $\xi$ is a function of $(x, y)$. Then $\Lambda$ is a \dfn{good contour} if
    $$\Im \langle \xi, x - y\rangle \geq \delta|x - y|^2 + \varphi(y) - \varphi(x).$$
\end{definition}
\begin{example}
    If $\varphi(x) = |x|^2/2$ then
    $$\overline{K(y, x)} = (\pi h)^{-n} e^{\langle x, \overline y\rangle/h}$$
    and this Bergman kernel is valid on $\CC^n$. Here $\omega = i/2\sum_j dz_j \wedge d\overline z_j$ and $dV$ is the Euclidean volume form. We obtain a good contour by $\xi(x, y) = i\overline y$. Then
    $$2\Im \langle i\overline y, x - y\rangle = |y|^2 + |x|^2 + |x - y|^2.$$
\end{example}

    Taylor expanding,
    $$\varphi(x) = \varphi(y) - \Im Q(x, y)(x - y) + (\partial\dbar\varphi(x)(x-y))\overline{x - y} + O(|x - y|^3)$$
    where $Q$ is some holomorphic function and
    $$2\delta |x - y|^2 \leq (\partial\dbar\varphi(x)(x-y))\overline{x-y}.$$
    We now define a good contour by $\xi = Q$.
\begin{lemma}
    Suppose $\Lambda$ is a good contour for $\varphi$. Then there is a $\varepsilon > 0$ and a $B(0, \varepsilon)$-cutoff $\chi$ such that for every $u \in A(B(0, 1))$,
    $$u(x) = i^{-n^2}(2\pi h)^{-n} \int_\Lambda e^{i\langle \xi, x - y\rangle/h} u(y) \chi(y) ~d\xi \wedge dy + O(e^{(\varphi(x) - \delta)/h})||u||_\varphi.$$
\end{lemma}
    This lemma can be intuited by deforming $\Lambda$ into a flat space and then applying the Fourier inversion formula. That is not a proof, however. We put $c_n = i^{-n^2}$ for simplicity.
\begin{proof}
    Define the form
    $$\eta = c_n(2\pi h)^{-n} e^{i\langle \xi, x - y\rangle/h} u(y)\chi(y) ~d\xi \wedge dy.$$
    Define $$I_s = \int_{\Lambda_s} \eta$$
    where $\Lambda_s$ is the form defined by $\xi_s(x, y) = \xi(x, y) + i\overline{s(x - y)}$.
\begin{lemma}
    As $s \to \infty$, $I_s \to u(x)$ for $x \in B(0, 1/2)$.
\end{lemma}
\begin{proof}
    We have the expression
    $$e^{i\langle\xi, x - y\rangle/h} e^{-s|x - y|^2/h} u(y) \chi(y)(c_n ~d_{\overline y} \xi(x, y) \wedge dy + s^n~dm(y)).$$
    By the dominated convergence theorem $e^{-s|x-y|^2/h}c_n~d_{\overline y}\xi(x, y) \wedge dy \to 0$ as $s \to \infty$. As a distribution,
    $$s^n(2\pi h)^{-n} e^{-s|x - y|^2/h} \to \delta_0(x - y).$$
\end{proof}
Now $\Omega = \CC^n \times [0, s]$ and $\partial \Omega = \CC^n \times s - \CC^n \times 0$ (as a chain). We introduce the homotopy $h(y, t) = \langle y, \xi\rangle + it\overline{x - y}$, so $h: \CC^n \to [0, \infty) \to \CC^{2n}$ and put $\omega = h^*\eta$. Since $\omega$ is compactly supported (since $\eta$ has a factor of $\chi$) we can apply Stokes' theorem to see that
    $$\int_\Omega d\omega = \int_{\partial \Omega} \omega.$$
    Since $\eta$ has a factor of $d\xi \wedge dy$, $\partial \eta = 0$. So
    $$d\eta = \dbar \eta = c_n(2\pi h)^{-n} e^{-\langle \xi, x-y\rangle/h} u(y) \dbar \chi \wedge dy \wedge d\xi.$$
    Then
$$
    I_s - I_0 = \int_{\CC^n \times s} h^*\eta = \int_{\CC^n \times 0} h^*\eta = \int_{\CC^n \times [0, s]} h^*~d\eta
$$
    Since $I_s \to u(x)$ we can estimate $d\eta$. If $|y| < 1/2$ then $d\chi = 0$, and
    $$\Re (i\langle x - y, \xi\rangle/h) \leq -\delta|x-y|^2 + \varphi(x) - \varphi(y)$$
    since $\Lambda$ is good. Since $|x| < \varepsilon$ and we can take $\varepsilon < 1/4$ we only need to consider $|y| > 1/2$, in which case
    $$\Re(i\langle x - y, \xi\rangle)/h \leq -\delta/C - \varphi(y) + \varphi(x).$$
    Now
\begin{align*}
    \left|\int_{\CC^n \times [0, s]} h^*(d\eta)\right| &\leq Ch^{-n} e^{-\delta/16h + \varphi(x)/h} \int_{|y| \geq 1/2} |\chi'(y)| |u(y)|e^{-\varphi(y)/h} ~dm(y) \int_0^s (1 + t^n)e^{-t/16h} ~dt\\
    &\leq Ce^{-\delta/32h + \varphi(x)/h}||u||_\varphi.
\end{align*}
    We conclude that
    $$I_s - I_0 = O(e^{-\delta/h}e^{\varphi(x)/h})||u||_\varphi.$$
    The right hand side does not depend on $s$ so we take $s \to \infty$ to see that we have constructed an approximate kernel.
\end{proof}
    Unfortunately the approximate kernel we constructed here may not be holomorphic. So we consider for which $a$ do we have
    $$u(x) = c_n(2\pi h)^{-n} \int_\Lambda e^{i\langle \xi, x-y\rangle} u(y)(1+a)\chi(y) ~d\xi \wedge dy + O(\varphi(x)/h - \delta/h)||u||_\varphi.$$
    If
    $$ae^{i\langle \xi, x - y\rangle/h} ~d\xi = d\xi(e^{i\langle \xi ,x -y\rangle}A)$$
    where $A = \sum_j A_j(x, y, \xi, h) ~d\hat \xi_j$ and $d\hat \xi_j$ is the unique $(n-1,0)$-form such that $\xi_j \wedge d\hat \xi_j = d\xi$ then
\begin{align*}
    \int_\Lambda e^{i\langle \xi, x-y\rangle/h} u(y) \chi(y) a(x, y, \xi, h) ~d\xi\wedge dy &= \int_\Lambda u(y)\chi(y) d(e^{i\langle \xi, x-y\rangle/h}A) \wedge dy\\
    &= \int_\Lambda \chi(y)d(u(y)e^{i\langle \xi, x-y\rangle/h}A) \wedge dy\\
    &= -\int_\Lambda d\chi \wedge u(y)e^{i\langle \xi,x-y\rangle/h}A \wedge dy\\
    &= O(e^{-\delta/h}e^{\varphi(x)/h})||u||_\varphi
\end{align*}
    using that $\Lambda$ is a good contour. Intuitively we are replacing a pseudodifferential symbol that depends on $(x, y, \xi)$ with a pseudodifferential operator that depends on $(x, \xi)$.
\begin{definition}
    A symbol $a(x, y, \xi, h)$ is a \dfn{negligible symbol} if $a = \sum_j \D_{\xi_j}A_j + (x-y)A/h$ for some $A$.
\end{definition}
    We introduce the differential operator $\tilde \nabla = \partial_\xi + i(x - y)/h$. Then $ia = \tilde \nabla A$ and we absorb the $i$ into the $A$.

    In this case the error term introduced by adding $a$ is $O(e^{-\delta/h}e^{\varphi(x)/h})||u||_\varphi$. We are specifically interested in when $A$ has an asymptotic sum $A = \sum_m A_m h^m$. What this means is that for every $N$,
    $$A - \sum_{m\leq N} A_m h^m = O(h^{N+1})$$
    or in other words the sum ``converges" modulo $O(h^\infty)$. We write $A^{(N)}$ for the $N$th partial sum. Then $a^{(N)} = \tilde \nabla A^{(N)} + O(h^{N+1})$.

    We now introduce the pseudodifferential operator
    $$S = e^{ih\langle D_y, D_\xi\rangle} = \sum_{m=0}^\infty \frac{(ih)^m}{m!} D_y \cdot D_\xi.$$
    A priori this makes no sense, but it does make sense modulo $O(h^\infty)$. In fact if $a = \sum_m a_m h^m$, $b = \sum_m b_m h^m$ we say $Sa = b$ if and only if
    $$b_j = \sum_{m+p = j} \frac{i^m}{m!}(D_\xi \cdot D_y)^m a_p$$
    where the dot product of differential operators is defined by $D_\xi \cdot D_y = \sum_j D_{\xi_j}D_{y_j}$. Moreover $S^{-1} = e^{-ihD_y\cdot D_\xi}$. Then $S^{-1}Sa = a$ up to $O(h^\infty)$.
\begin{lemma}
    $a$ is a negligible symbol if and only if $Sa|_{x = y} = 0$.
\end{lemma}
\begin{proof}
    $S\partial_\xi = \partial_\xi S$ and, thinking of $y_j$ as the multiplication operator, $Sy_j = y_jS + hD_{\xi_j}S$. Therefore
    $$S((x-y)A) = (x-y)SA - hD_{\xi_j}SA.$$
    If $a$ is negligible, say $a = \tilde \nabla A$, then
    $$Sa = S\tilde \nabla A = \partial_{\xi_j}SA + i(x-y)SA/h - \partial_{\xi_0}SA = i(x-y)SA/h$$
    which restricts to $0$ on $x=y$. Conversely, if $Sa|_{x=y} = 0$ we can write $Sa = (x-y)B$. Now $S\tilde \nabla = i(x-y)S/h$ so
    $$\tilde \nabla S^{-1} = iS^{-1}(x-y)/h.$$
    Therefore
    $$\tilde \nabla S^{-1}B = iS^{-1}(x-y)B/h.$$
    So $ia/h = \tilde \nabla(S^{-1}B)$.
\end{proof}
\begin{definition}
    Let $Y \subset \CC^N$ be a $\RR$-linear subspace. Then $Y$ is a \dfn{totally real space} if $Y \cap iY = 0$.
\end{definition}
    Assume $\varphi$ is analytic as a function on $\RR^n \times \RR^n$. We extend $\varphi$ to a function on the maximal totally real subspace $\{(x, \overline x) \in \CC^n \times \CC^n\}$. To do this, let $\iota(x, y) = (x + y, -i(x - y))$. Then let $\iota^*\tilde \varphi = \varphi$. We then can find a $\psi$ which is holomorphic near $(0, 0)$ such that $\psi(z, \overline z) = \varphi(z)$. Then $\psi(x, \overline y) = \psi(y, \overline x)$ with
    $$2 \Re \psi(x, \overline y) - \varphi(x) - \varphi(y) \leq -\delta|x - y|^2.$$
    We solve for $\xi$ in the equation
    $$i\langle \xi, x - y\rangle = 2(\psi(x, z) - \psi(y, z)).$$
    This is possible by the lemma on negligible symbols and $\xi$ is a function of $(x, y, z)$. By Taylor's theorem,
    $$\xi(x, y, z) = -2i\int_0^1 \partial_x \psi(tx + (1-t)y, z) ~dt$$
    so $\xi(x, x, z) = -2i\partial_x \psi(x, z)$. In fact $(x, y, z) \mapsto (x, y, \xi)$ is a biholomorphic function close to $0$ on $\CC^{3n}$ by the analytic implicit function theorem. To see this we must show that the quadratic form given by the matrix $\partial_z \xi(0)$ is nondegenerate. Now
    $$\partial_z \xi(0) = -2i \partial_x\partial_z \psi(0) = -2i \partial_x\dbar_x \varphi(0)$$
    which is nondegenerate since $\varphi$ is strictly plush. By our previous estimate on $\psi$, the contour
    $$\Lambda = \{(y, \xi): \xi = \xi(x, y, \overline y)\}$$
    is good.
\begin{lemma}
    We have
    $$u(x) = (\pi h)^{-n} \int_{B(0, 1)} \chi(y) e^{i(2\psi(x, \overline y) - 2\psi(y, \overline y))/h} \frac{i}{2} \det \dbar_y \xi (1 + a^{(N)})u(y) ~d\overline y \wedge dy + O(e^{\varphi(x)/h}h^{N+1})||u||_\varphi.$$
\end{lemma}

\begin{definition}
    The \dfn{Bergman function} is defined on a compact complex manifold equipped with a positive line bundle by
    $$B(x) = ||K(x, x)|| = K(x, x)e^{-2\varphi(x)}.$$
\end{definition}
\begin{lemma}
    We have
    $$B(x) = \sup_{\substack{s \in H^0(M \to L)\\||s||_{L^2} \leq 1}} ||s(x)||^2.$$
\end{lemma}
\begin{proof}
    We have
    $$K(x, y) = \sum_\alpha u_\alpha(x) \overline{u_\alpha(y)},$$
    the sum ranging over an orthonormal basis $u_\alpha$ of $H^0(M \to L)$. It follows that
    $$B(x) = \sum_\alpha ||u_\alpha(x)||^2$$
    and now we use the Cauchy-Schwarz inequality.
\end{proof}
    From this we can easily compute
    $$\int_M B ~dV = \dim H^0(M \to L).$$

    Given $L \to M$ fixed, we let $B_k$ denote the Bergman function determined by $L^k$.
\begin{lemma}
    The Bergman function satisfies
    $$|B_k(x)| \leq Ck^n.$$
\end{lemma}
    Therefore $\dim H^0(M \to L^k)$ is finite and grows like $k^n$. Morally this lemma is a restatement of the uncertainty principle because it describes how many independent states can be on a compact set, with $h = 1/k$. The uncertainty principle says we cannot localize past $\sqrt{1/h} = \sqrt k$. Here we cannot localize too much because we only have so many holomorphic sections.
\begin{proof}
    Let $s \in H^0(M \to L^k)$. We want to show
    $$||s(x)||^2 \leq Ck^n ||s||_{L^2_k}.$$
    Then the claim follows from the previous lemma. Since $||s||_{L^2_k} \leq ||s||_{L^2_k(\Omega_j)}$ we might as well prove the claim locally.

    Choose an atlas so $\theta_j(x_0) = 0$ and write $s(x) = (x, u(x))$ where $u$ is holomorphic near $x_0 = 0$. Now $\varphi_j$ is strictly plurisubharmonic so up to a linear change of variables
    $$\varphi_j(x) = \sum_{j=1}^n \lambda_j|x_j|^2 + \Re Q(x) + \varphi(0) + O(|x|^3)$$
    where $Q(x) = \langle Ax, x\rangle + \langle a, x\rangle$ is holomorphic. Now $\varphi(0)$ does not affect our computation so we might as well take $\varphi(0) = 0$. By absorbing the holomorphic term $Q$ into $u$ we may assume $Q = 0$. Close to $0$ we may assume $O(|x|^3) = 0$. Now
    $$\frac{||u(0)||^2}{||u|_{L^2_k(\Omega_j)}} \leq \frac{||u(0)||^2}{||u||_{L^2_k(B(0, R_k))}}$$
    and we now make the change of variables
    $$f(w) = u(w/\sqrt k)$$
    and
    $$k\varphi(w) = \varphi_0(w) = \frac{1}{2}\sum_j \lambda_j |w_j|^2 + O(|w|^3k^{-1/2}).$$
    By our assumptions on $\varphi$, $u(0) = f(0)$. Here $dm$ and $dV$ are absolutely continuous to each other so we can replace $dV$ with $dm$ up to a constant error. Hence
\begin{align*}\frac{||u(0)||^2}{||u||_{L^2_k(\Omega_j)}} &\leq \frac{Ck^n||f(0)||^2}{\int_{|w| \leq B_k(\sqrt k)} |f(w)|^2 e^{-2\varphi_0(w)}  ~dm(w)} \\
    &\leq \frac{Ck^n||f(0)||^2}{\int_{|w| \leq B_k(\sqrt k)} |f(w)|^2 e^{-\sum_j \lambda_j|w_j|^2} ~dm(w)}.
\end{align*}
    Now $|f|^2$ is strictly plush so by the mean value theorem for measures,
$$\int_{|w| \leq B_k(\sqrt k)} e^{-\sum_j \lambda_j |w_j|^2} |f(0)|^2 ~dm(w) \leq \int_{|w| \leq B_k(\sqrt k)} |f(w)|^2 e^{-\sum_j \lambda_j |w_j|^2} ~dm(w).$$
    Pulling out $|f(0)|^2$ and taking $k$ big enough that the integral converges we see our lemma.
\end{proof}
    Actually Mike Christ showed that
    $$|K(x, y)| \leq Ce^{-\sqrt{k \log k}}d(x, y).$$
    But we have only proved $|K(x, y)| = O(k^{-\infty})$.
\begin{theorem}
    Assume $\varphi$ is real analytic. If $d(x, y) < \varepsilon$ then in a suitable trivialization,
    $$\partial^\alpha_{x,y}(K(x, y) - K^{(N)}(x, y)) = O(k^{-N-1+n+|\alpha|}e^{k(\varphi(x)+k\varphi(y)})||u||_k.$$
\end{theorem}
    To prove the theorem we rephrase the Hormander $L^2$-estimates to work for manifolds.
\begin{lemma}
    For every $(0, 1)$-form $f \in C^\infty_{0,1}(M \to L^k)$ such that $\dbar f = 0$ there is a $u \in C^\infty(M \to L^k)$ such that $\dbar u = f$ and $||u||_{L^2_k} \leq C||f||_{L^2_k}$, and $C$ can be chosen independently of $k$.
\end{lemma}
\begin{lemma}
    One has
    $$K(y, x) = (xK_x, K_y^{(N)})_{L^2_k} + O(k^{-N-1+n})e^{k\varphi(x) + k\varphi(y)}||K_x||_{L^2_k}.$$
\end{lemma}
\begin{proof}
    We use the fact that
    $$u(y) = (\chi_yu, K^N(\cdot, y))_{L^2_k} + O(k^{-N-1+n}e^{k\varphi(y)})||u||_\varphi$$
    on the function $u(y) = K_x(y)$. Then
    $$K(y, x) = (\chi K_x, K_y^{(N)})_{L^2_k} + O(k^{N-1})e^{k\varphi(y)}||u||_{L^2_k}.$$
    Here
    $$||K_x||_{L^2_k}^2 = B_k(x)e^{2k\varphi(x)}$$
    so
    $$||K_x||_{L^2_k} \leq Ck^{n/2}e^{k\varphi(x)}.$$
    Now use
    $$e^{k\varphi(y)}||u||_{L^2_k}^2 \leq e^{k\varphi(x) + k\varphi(y)} k^{n/2}$$
    to prove the lemma.
\end{proof}
    Recall also that if $P: H \to \ker A$ is an orthogonal projection and $Pu = v$, $w = u - Pu$, then $A(u - Pu) = Au$ and
    $$||w|| = \min_{A\tilde w = Au} ||\tilde w||.$$
\begin{proof}[Proof of theorem]
    We may assume that $\chi$ is real-valued. Then
    $$(\chi K_x, K_y^{(N)})_{L^2_k} = (K_x, \chi K_y^{(N)})_{L^2_k} = \overline{P_k(\chi K_x^{(N)})(y)}.$$
    Then we define
    $$u_y(x) = K_y^{(N)}(x) - (\chi K_y^{(N)}, K_x)_{L^2_k} = K_y^{(N)}(x) - P_k(\chi K_y^{(N)})(x).$$
    By the linear algebra above, $u_y$ is the $L^2_k$-minimal solution to the problem
    $$\dbar u_y = \dbar \chi K_y^{(N)} + \chi \dbar K_y^{(N)} = \dbar \chi K_y^{(N)}$$
    because $\varphi$ was assumed analytic. Moreover, $\dbar \chi = 0$ away from the diagonal. So
    $$\dbar u_y(x) = O(e^{-\delta k}e^{k\varphi(x) + k\varphi(y)}).$$
    Since $u_y$ is the minimal solution, $||u_y||_{L^2_k} \leq ||\tilde u||_{L^2_k}$ where $\tilde u$ is the solution to the $\dbar$-problem yielded by the Hormander estimate. Therefore the Hormander estimate gives
    $$||u_y||_{L^2_k} \leq Ce^{-\delta k}e^{k\varphi(y)}.$$
    By the Cauchy-Green formula we have, for any compactly supported $\psi$ which is identically $1$ near $0$,
    $$|u(0)| \leq \sup_D e^{k\varphi(y)} O(e^{-\delta/k} e^{k\varphi(y)})$$
    for any open neighborhood $D$ of $0$. If we take $D \subset B(0, k^{-1})$ and translate appropriately we have
    $$|u_y(x)| \leq e^{-\delta k}e^{k\varphi(y)} e^{k\varphi(x)}.$$
\end{proof}
    Therefore we can actually approximate the Bergman kernel by its asymptotic expansion. We use this theorem to find an asymptotic expansion for the Bergman function.
\begin{corollary}
    One has
    $$B_k(x) = \left(\frac{k}{\pi}\right)^n(1 + k^{-1}b_1(x, \overline x) + k^{-2}b_2(x, \overline x) + \dots)$$
    where the sum is meant in the asymptotic sense.
\end{corollary}
\begin{corollary}
    One has
    $$\dim H^0(M \to L^k) = \frac{k^n}{\pi^n}(1 + O(k^{-1})) \int_M ~dV.$$
\end{corollary}
    All that remains is to extend from the real-analytic case to the $C^\infty$ case. To do this we use a technique introduced by Hormander and Nirenberg.
\begin{lemma}
    Suppose $f \in C^\infty_{comp}(\RR^m)$. Then there is a $\tilde f \in C^\infty(\CC^m)$ such that $\tilde f|_{\RR^m} =f$ and $\dbar \tilde f(z) = O(|\Im z|^\infty)$.
\end{lemma}
\begin{proof}
    By a Paley-Weiner type theorem, we can define
    $$\tilde f(x + iy) = \frac{1}{(2\pi)^m} \int_{\RR^m} e^{ix\xi} \chi(|\xi||y|)e^{-y\xi} \hat f(\xi) ~d\xi$$
    for some compactly supported function $\chi$ which is identically $1$ at $0$. Obviously $\tilde f$ is smooth, and $\dbar$ only falls on the $\chi$ term. Then we end up with $\chi'$, which is not supported at $0$, and a factor of $|\xi|y_j|y|^{-1}$. We can then add factors of $|\xi||y|^{-1}$ with impunity since $\chi^{(N)}$ is $0$ close to $0$. Iterating we get the decay we need.
\end{proof}
\begin{definition}
    The function $\tilde f$ is called the \dfn{almost analytic extension} of $f$.
\end{definition}
    Using the theory of almost analytic extensions, one can prove the following lemma.
\begin{lemma}
    Assume $\varphi$ is smooth. There is a function $\psi$ which is $C^\infty$ in a neighborhood of $0 \in \CC^{n + n}$ such that $\psi(x, \overline x) = \varphi(x)$ and $\dbar_x\psi(x, \overline y)$ and $\partial_y\psi(x, \overline y) = O(|x - y|^\infty)$.
\end{lemma}
    Now notice that we can replace any assumption that $\dbar \varphi = 0$ with $\dbar \varphi$ with the property in the above lemma anywhere in the above construction of the approximate Bergman kernel, since the function was only an approximation away from the diagonal anyways. This completes the proof of the theorem of Fefferman, Boutet, de Monvel, etc.

\section{Morphisms into projective space}
    Throughout this section, let $M$ be a compact complex manifold, $L \to M$ a line bundle. Let $\omega_{FS}$ be the Fubini-Study metric on $O(1)$, the dual of the tautological line bundle, of $\PP^n$ for some $n$. We let $(s_j^k)_j$ be an orthonormal basis of $H^0(M \to L^k)$. Define the morphism
\begin{align*}
    \varphi_k: M &\to \PP^{d_k - 1}\\
    x &\mapsto [s_0^k(x), \dots, s_{d_k}^k(x)].
\end{align*}

\begin{theorem}[Catlin-Tian-Yau-Zelditch asymptotics]
    \index{Catlin-Tian-Yau Zelditch asymptotics}
    Let $\omega$ be a positive Hermitian metric on $L$. Then there is an asymptotic expansion
    $$\omega = \frac{1}{k}\varphi^*_k\omega_{FS} + \frac{\omega_2}{k^2} + \frac{\omega_3}{k^3} + \dots$$
    for some $\omega_j$ which are $(1, 1)$-forms.
\end{theorem}
\begin{proof}
    Write $s_j^k(z) = f_j^k(z)e_k$ for some holomorphic functions $f_j^k$. Then
    $$\varphi_k^*\omega_{FS} = i\partial \dbar\left(\log \sum_{j=1}^{d_k} |f_j^k(z)|^2 \right).$$
    On the other hand, the Bergman projector is given by
    $$B_k(z) = e^{-2k\varphi(z)} \sum_{j=1}^{d_k} |f_j^k(z)|^2.$$
    Therefore
    $$i\partial\dbar \log B_k(z) = -k \omega + \varphi_k^* \omega_{FS}.$$
    So
    \begin{align*}
        \omega = \frac{1}{k} \varphi_k^*\omega_{FS} + \frac{1}{ik} \partial \dbar \log B_k(z)\\
            &= \frac{1}{k} \varphi_k^*\omega_{FS} + \frac{1}{ik} \partial \dbar \frac{a_1(x)}{k} + \dots
    \end{align*}
    as $k \to \infty$.
\end{proof}

\begin{definition}
    A \dfn{Hodge metric} is a positive $(1, 1)$-form $\omega$ such that $[\omega] \in H^2(M, \QQ)$.
\end{definition}
    In other words, $\omega$ is in the second rational-valued cohomology class of $M$.

\begin{theorem}[Kodiara embedding theorem]
    \index{Kodiara embedding theorem}
    The following are equivalent:
\begin{enumerate}
    \item If $n$ is large enough, then $M$ can be embedded in $\PP^n$.
    \item $M$ admits a positive Hermitian line bundle.
    \item $M$ admits a Hodge metric.
\end{enumerate}
\end{theorem}
    In the below proof we use $\varphi$ to mean the weight and $\varphi_k$ to mean the embedding, oops.
\begin{proof}
    Obviously if we have an embedding in projective space we can just pull back $(O(1), \omega_{FS})$ to $M$. The proof that positive Hermitian line bundles are equivalent to Hodge metrics uses Chern classes.

    If $M$ has a positive Hermitian line bundle, then $\varphi_k$ is an immersion $M \to \PP^{d_k}$. Suppose that $\varphi_k$ is never injective. Then there are sequences $x_k,y_k$ such that $x_k \neq y_k$ and $\varphi_k(x_k) = \varphi_k(y_k)$.

    First suppose $d(x_k, y_k)\sqrt k \to \infty$. Since $\varphi_k(x_k) = \varphi_k(y_k)$, for all $x$, the Bergman kernel $K$ has $K(x, x_k) = K(x, y_k)$. Then
$$\int_{B(x_k, r_{k/2})} |K_k(x, x_k)|^2 e^{-2k\varphi(x)} ~dV(x) \sim e^{2k\varphi(x_k)} \frac{k^n}{\pi^n}$$
yet
$$\int_{B(x_k, r_{k/2})} |K_k(x, x_k)|^2 e^{-2k\varphi(x)} ~dV(x) = \int_{B(y_k, r_{k/2})} |K_k(x, y_k)|^2 e^{-2k\varphi(x)} ~dV(x).$$
    Now $d(x_k, y_k) \gg k^{-1/2}$ so the balls can be taken to be disjoint. Then
    $$K_k(x_k, x_k) = \int_M |K_k(x, x_k)|^2 e^{-2k\varphi(x)} ~dV(x) \geq \frac{k^n}{\pi^n}(e^{2k\varphi(x_k)} + e^{2k\varphi(y_k)}).$$
    But
    $$K_k(x_k, y_k) \sim \frac{k^n}{\pi^n} e^{2k\varphi(x_k)}.$$
    Without loss of generality we can assume $\varphi(y_k) \geq \varphi(x_k)$. But
    $$e^{2k\varphi(x_k)} \gtrsim e^{2k\varphi(x_k)} + e^{2k\varphi(y_k)}$$
    which is a contradiction.

    Otherwise we can assume $d(x_k, y_k) \leq Ck^{-1/2}$. By changing coordinates we may assume that $x_k = 0$, $y_k = w_kk^{-1/2}$, $|w_k| \leq C$, and $x_k \neq y_k$. Now put
    $$f_k(t) = \frac{|K_k(0, tw_kk^{-1/2})|^2}{K_k(0, 0)K_k(tw_kk^{-1/2}, tw_kk^{-1/2})}.$$
    Then $f_k$ is smooth on $[0, 1]$ and by the Cauchy-Schwarz inequality $0 \leq f_k(t) \leq 1$. In fact $f_k(0) = 1$ and $f_k(1) = 1$. So there is a $t_k \in [0, 1]$ such that $f_k''(t_k) \geq 0$. But
\begin{align*}
    f_k(t) &= \exp(-2k\psi(0, tw_kk^{-1/2} - \varphi(0) - \varphi(tw_kk^{-1/2})))(1 + r(tw_k)k^{-1} + \dots)\\
        &= \exp(-t^2\langle Aw_k, \overline w_k\rangle + O(t^3|w_k|^3))(1 + r_k(t_wk)k^{-1} + \dots)
\end{align*}
    which implies $|w_k| = O(k^{-1/2})$.
    So
    $$f_k''(t) = -2\langle Aw_k, \overline w_k\rangle O(|w_k|^3k^{-1/}2 + |w_k|^2k^{-1}) \leq -C|w_k|^2 < 0$$
    which is a contradiction.
\end{proof}
\begin{theorem}[Chow]
    \index{Chow's theorem}
    If $M$ admits a positive Hermitian line bundle, then $M$ is a projective variety.
\end{theorem}
\begin{proof}
    A compact submanifold of $\PP^n$ is a projective variety.
\end{proof}

\section{Zworski's conjecture}

\begin{conjecture}[Zworski]
Let $\Pi_N: L^2(\PP^n \to O(N)) \to H^0(\PP^n \to O(N))$ be the Bergman projector, and consider the differential equation
$$iu_t = \Pi_N(|u|_N^2u)$$
on the finite-dimensional space $H^0(\PP^n \to O(N))$. Then this differential equation has a Lax pair and hence is a completely integrable system.
\end{conjecture}

\chapter{Riemann surfaces and analytic continuation}
These notes are based on Teleman's lectures on Riemann surfaces and consist of stuff I had to learn while studying the meromorphic continuation of NLS resolvents.

Recall that there is no canonical way to define $\sqrt\cdot$ as a holomorphic function on some open subset of $\CC$ because it requires a choice of branch. However, there is a way to define $\sqrt\cdot$ on a surface that is not $\CC$.

\begin{definition}
A \dfn{concrete Riemann surface} is a set $S \subseteq \CC^2$ such that for every $(z, w) \in S$ there is an open $U \ni (z, w)$ and a holomorphic $F: U \to \CC$ such that $F(z, \cdot)$ is not identically $0$ and $S \cap U = \{F = 0\} \cap U$.
It is said to be \dfn{nonsingular} if for every $(z, w)$, $F$ can be chosen so that $\nabla F(z, w) \neq 0$.
Otherwise, $(z, w)$ is a \dfn{singularity}.
\end{definition}
Thus a concrete Riemann surface is locally a holomorphic variety.

\begin{example}
Let $S = \{(z, w): z = w^2\}$. Then $S$ can be viewed as the domain of $\sqrt\cdot$, by $\sqrt{(z, w)} = w$, and a choice of branch is the same thing as a holomorphic embedding of some open subset $U \subset \CC$ into $S$.
\end{example}

\section{Basic definitions}
The definition of a concrete Riemann surface is a bit unfortunate because no such Riemann surface can be compact.
\begin{definition}
An \dfn{Riemann surface} is a one-dimensional complex manifold.
\end{definition}
\begin{example}
$\PP^1$ is a Riemann surface known as the \dfn{Riemann sphere}. So is any open subset of $\PP^1$, by the Riemann mapping theorem.
\end{example}
Now we prove the obvious.
\begin{lemma}
Every nonsingular concrete Riemann surface is a Riemann surface.
\end{lemma}
\begin{proof}
By the inverse function theorem, nonsingularity implies that the map $(z, w) \mapsto w$ is locally an isomorphism of Riemann surfaces.
Obviously the domains of such isomorphisms form a holomorphic atlas.
\end{proof}
\begin{lemma}
Every compact connected Riemann surface has only constant holomorphic functions.
\end{lemma}
\begin{proof}
Just use the maximum principle.
\end{proof}

Now we show that in appropriate coordinates, every holomorphic mapping looks like $z \mapsto z^n$.
This is analogous to the idea that every holomorphic function can only have finite-order zeroes; if we view $s = 0$ in the below theorem this is exactly what the theorem says.
\begin{theorem}
Let $f: R \to S$ be a holomorphic mapping of Riemann surfaces, $f(r) = s$, $f$ nonconstant near $r$.
Then if $V \ni s$ is open, $\psi: V \to \DD$ a holomorphic chart such that $\psi(s) = 0$, then there is a holomorphic character $\phi: U \to \DD$, $U \ni r$ such that the diagram
$$\begin{tikzcd} U \arrow[r,"f"] \arrow[d,"\phi"] & V \arrow[d,"\psi"]\\
\DD \arrow[r,"z \mapsto z^n"] & \DD
\end{tikzcd}$$
commutes. Moreover $n$ does not depend on the choice of charts.
\end{theorem}
\begin{proof}
Let $h: U \to \DD$ be a holomorphic chart, $h(r) = 0$. Let $g \circ h = \psi \circ f$, so $g$ is holomorphic near $0$.
Let $n$ be the order of the zero. Then $g^{1/n}$ is holomorphic near $0$, and is a local isomorphism of Riemann surfaces.
Thus we may take $\phi$ to be an appropriate rescaling of $g^{1/n} \circ h$.

Moreover $n$ is the number of solutions to the equation $f(x) = y$ which converge to $r$ as $y$ converges to $s$, which is chart-independent.
\end{proof}
\begin{definition}
The number $v_f(r) = n$ appearing in the above theorem is called the \dfn{valency} of $f$ at $r$.
\end{definition}

\begin{definition}
View $\PP^1 = \CC \cup \{\infty\}$. Let $X$ be a Riemann surface. A function $f: X \to \PP^1$ is said to be a \dfn{meromorphic function} on $X$ if it can be locally written as a quotient of holomorphic functions $X \to \CC$.
\end{definition}
A meromorphic function is the same thing as a holomorphic function $X \to \PP^1$ which is not identically $\infty$. Its poles are the preimages of $\infty$, and the order of the pole is just the valency.
Clearly the collection of meromorphic functions on a connected Riemann surface forms a field. The only nontrivial thing being claimed here is that they are an integral domain, which follows because every holomorphic function has full support.

\section{Holomorphic mappings of compact Riemann surfaces}
Recall the open mapping theorem: a nonconstant holomorphic map is open, in the sense that open sets push forward to open sets. This can be proven using the residue calculus.
\begin{corollary}
Let $f: X \to Y$ be a nonconstant holomorphic map, $X$ a connected compact Riemann surface. Then $f(X)$ is a compact connected component of $Y$.
\end{corollary}
\begin{proof}
Since $f$ is an open continuous map of a compact connected set, $f(X)$ is open, compact, and connected, hence clopen and connected, hence a connected component.
\end{proof}
\begin{corollary}
A nonconstant holomorphic map between compact connected Riemann surfaces is constant.
\end{corollary}
\begin{corollary}
A holomorphic function on a compact connected Riemann surface is constant.
\end{corollary}
Just like any theorem in complex analysis we can use the above to prove the fundamental theorem.
\begin{corollary}[fundamental theorem]
  \index{fundamental theorem of algebra}
A nonconstant polynomial is surjective.
\end{corollary}
The point is that the theorem that holomorphic functions on compact Riemann surfaces are surjective is just a generalization of the fundamental theorem.

We now reduce the study of meromorphic functions from analysis to algebraic geometry.
\begin{theorem}
A meromorphic function on $\PP^1$ can be written uniquely as
$$z \mapsto p(z) + \sum_{ij}\frac{c_{ij}}{(z - p_i)^j}$$
where $p$ is a polynomial, the $c_{ij}$ are constants, $p_i$ are poles, and the sum is finite.
\end{theorem}
\begin{corollary}
Every meromorphic function on $\PP^1$ is rational.
\end{corollary}
\begin{proof}[Proof of theorem]
Let $f: \PP^1 \to \PP^1$ be meromorphic and nonconstant (otherwise the claim is trivial).
Then the poles of $\PP^1$ are isolated, so finite since $\PP^1$ is compact.
Subtract off the principal parts at each pole except for poles at $\infty$.
Then we are left with a meromorphic function whose only pole is at $\infty$; i.e. an entire function.
But the only entire functions which do not have an essential singularity on $\PP^1$ are polynomials.
\end{proof}
\begin{corollary}
A meromorphic function on $\PP^1$ can be uniquely written as
$$z \mapsto c\frac{\prod_{i=1}^n z - z_i}{\prod_{j=1}^m z - p_j}.$$
\end{corollary}
\begin{proof}
Let $f: \PP^1 \to \PP^1$ be meromorphic and nonconstant.
Then $f$ is rational so it has finitely many zeroes and poles. Factoring out those zeroes and poles we see that $f$ must be a polynomial with no zeroes, hence a constant by the fundamental theorem.
\end{proof}
\begin{corollary}
A meromorphic function on $\PP^1$ has as many zeroes as poles.
\end{corollary}
\begin{proof}
Let
$$f(z) = \frac{\prod_{i=1}^n z - z_i}{\prod_{j=1}^m z - p_j}.$$
If $n \neq m$ then $\infty$ has valence $n - m$, hence has a zero of order $n - m$ if $n > m$, or a pole of order $m - n$ if $n < m$.
\end{proof}

Before generalizing the notion of the degree of a polynomial to more general functions on compact Riemann surfaces, we need to recall some topological preliminaries.
\begin{definition}
A \dfn{proper map} of Hausdorff spaces is a map such that the preimage of every compact set is compact.
\end{definition}
\begin{lemma}
If $X$ is a compact Hausdorff space and $Y$ is a Hausdorff space, then any continuous map $X \to Y$ is proper.
\end{lemma}
\begin{proof}
The preimage of a closed set is closed and hence compact.
\end{proof}
\begin{lemma}
Let $f: X \to Y$ be a continuous proper map and $X,Y$ Hausdorff. Let $y \in Y$ and $U \ni f^{-1}(y)$ open. Then there is a $V \ni y$ such that $f^{-1}(V) \subseteq U$.
\end{lemma}
\begin{proof}
Let $\mathcal V$ be the set of open neighborhoods of $y$ which admit a compact closure. Then $\bigcap_{V \in \mathcal V} \overline V = \{y\}$ since $Y$ is Hausdorff.
So $\bigcap_{V \in \mathcal V} f^{-1}(\overline V) = f^{-1}(y)$. Therefore
$$\emptyset = U^c \cap \bigcap_{V \in \mathcal V} f^{-1}(\overline V) = \emptyset.$$
By the finite intersection property of the compact set $\bigcap_{V \in \mathcal V} f^{-1}(\overline V)$, there is already an empty finite intersection.
\end{proof}
We count the zeroes and poles of a holomorphic map. To do this we need to choose a basepoint of the codomain that will play the role of zero, but in reality this choice of basepoint doesn't matter.
\begin{definition}
Let $f: X \to Y$ be a proper holomorphic map of connected Riemann surfaces (say, a holomorphic map of compact connected Riemann surfaces), $y \in Y$. Then the number
$$\deg f = \sum_{x \in f^{-1}(y)} v_f(x)$$
is the \dfn{degree} of $f$.
\end{definition}
\begin{theorem}
With hypotheses as in the definition of degree, $\deg f$ is finite and independent of the choice of basepoint $y$.
\end{theorem}
\begin{proof}
Since $f$ is proper, $f^{-1}(y)$ is compact, hence finite since it is discrete, say
$$f^{-1}(y) = \{x_1, \dots, x_n\}.$$
Let $U_j$ be holomorphic charts at each $x_j$. Since $f$ is proper, there is a holomorphic chart $V \ni y$ such that $f^{-1}(V) \subseteq \bigcup_j U_j$.
In the coordinates $(\bigcup_j U_j, V)$, $f(z) = z^n$.
Since $X,Y$ are connected this propagates by an open cover to all of $X,Y$.
\end{proof}

\section{Elliptic functions}
The meromorphic functions on $\PP^1$, which turns out to be the unique compact connected Riemann surface of genus $0$, were exactly the rational functions.
This is kind of boring so now we turn to meromorphic functions on a compact connected Riemann surface of genus $1$.
Such a function is the same thing as a doubly periodic function on $\CC$, i.e. a meromorphic function $f: \CC \to \PP^1$ such that there are noncollinear $\omega_1,\omega_2 \in \CC$, with
$$f(z) = f(z + k\omega_1) = f(z + k\omega_2)$$
for any $z \in \CC$, $k \in \ZZ$. Rescaling, we may assume that $\omega_1 = 1$, and write $\tau = \omega_2$ after the rescaling.
Clearly such a function drops to a fuction on a torus, which is compact, and hence cannot be a holomorphic function.
\begin{definition}
An \dfn{elliptic function} is a meromorphic function on a torus $\CC/L$, where $L$ is a lattice generated by two noncollinear complex numbers.
\end{definition}
We will always identify $\CC/L$ with a choice of fundamental domain in $\CC$, which is a parallelogram.
Note that by shifting the fundamental domain slightly we may and do assume that there are neither any zeroes nor poles on the boundary of the parallelogram.
We may view $\CC/L$ as an abelian group by addition modulo $L$.
\begin{theorem}
Let $f: \CC/L \to \PP^1$ be an elliptic function, and let $z_1, \dots, z_n, p_1, \dots, p_m$ be the zeroes and poles of $f$. Then $n = m$, $\sum_j \Res(f, p_j) = 0$, and $\sum_j z_j = \sum_j p_j$.
\end{theorem}
\begin{proof}
To see $n = m$, use the argument principle: let $\gamma$ be the boundary of the parallelogram $\CC/L$, so that
$$\frac{1}{2\pi i} \int_\gamma \frac{f'(u)}{f(u)} ~du = n - m.$$
But by periodicity the integral along the top of the parallelogram cancels with the integral along the bottom; similarly for the left and right. Thus $n -m  =0$.

By residue calculus,
$$\frac{1}{2\pi i} \int_\gamma f(u)~du=\sum_j \Res(f, p_j)$$
and for the same reason as above the integral is $0$.

Now
$$\frac{1}{2\pi i} \int_\gamma u\frac{f'(u)}{f(u)} ~du = \sum_j z_j - p_j$$
but
$$\int_0^1 u\frac{f'(u)}{f(u)} ~du + \int_{1+\tau}^\tau u\frac{f'(u)}{f(u)} ~du = \int_0^1 u\frac{f'(u)}{f(u)} - (u + \tau)\frac{f'(u)}{f(u)}~du = -\tau \int_0^1 \frac{f'(u)}{f(u)}~du = -\tau(\log f(1) - \log f(0)).$$
Now $f(0) = f(1)$ but $\log f(1) - \log f(0)$ is just some multiple of $2\pi i$ since $\log$ is multivalued. Thus
$$\sum_j z_j - p_j = k\tau$$
for some $k \in \ZZ$.
\end{proof}

As a consequence an elliptic function cannot have a single simple pole on $\CC/L$. Therefore it must have at least two poles. The simplest way to accomplish this is to put them both in the same place.
\begin{definition}
Let $L$ be a lattice containing $0$ and $L^*$ its nonzero elements.
The \dfn{Weierstrass $\wp$-function} for $L$ is the function
$$\wp(u) = \frac{1}{u^2} + \sum_{\omega \in L^*} \frac{1}{(u - \omega)^2} - \frac{1}{\omega^2}.$$
\end{definition}
\begin{lemma}
$\wp$ drops to an elliptic function on $\CC/L$.
\end{lemma}
\begin{proof}
We first check that the series converges locally uniformly on $\CC$. Since a sum of finitely many terms is clearly rational and a locally uniform limit of rational functions is meromorphic, this implies that $\wp$ is meromorphic.

To see this, let $K \subset \CC$ be compact. Then if $u \in K$ and $\omega \in L \setminus K$,
$$\left|\frac{1}{(u - \omega)^2} - \frac{1}{\omega^2}\right| < \frac{|u|^2 + 2|u\omega|}{|\omega|^2|u - \omega|^2} = \frac{|u|^2}{|\omega|^2|u - \omega|^2} + \frac{2|u|}{|\omega||u - \omega|^2}.$$
Since $K$ is compact we have $|u| \lesssim 1$ and $|u - \omega| \gtrsim |\omega|$. Therefore
$$\left|\frac{1}{(u - \omega)^2} - \frac{1}{\omega^2}\right| \lesssim |\omega|^{-4} + |\omega|^{-3} \lesssim |\omega|^{-3}.$$
Clearly $\sum_{\omega \in L^*} |\omega|^{-3}$ converges.

Thus we may differentiate $\wp$ to see that
$$\wp'(u) = -2\sum_{\omega \in L} (u - \omega)^{-3}.$$
This function is clearly periodic in $L$, so drops to an elliptic function on $\CC/L$. Thus
$$\wp(u) - \wp(u + \omega) = C$$
for some constant $C$. Moreover, $\wp$ is even, viz. $\wp(u) = \wp(-u)$. But if $u = -\omega/2$,
$$C = \wp(u) - \wp(u + \omega) = 0,$$
so $\wp$ is elliptic.
\end{proof}
\begin{corollary}
The degree of $\wp: \CC/L \to \PP^1$ is $2$.
\end{corollary}
\begin{corollary}
Let $\omega_1,\omega_2$ generate the lattice $L$. Then the critical points of $\wp$ are exactly $\omega_1/2$, $\omega_2/2$, and $\omega_1/2 + \omega_2/2$.
\end{corollary}
\begin{proof}
Since $\wp$ is even, $\wp'$ is odd. Thus $\wp'(\omega_1/2) + \wp'(-\omega_1/2) = 0$, but $\wp'(\omega_1/2) = \wp'(-\omega_1/2)$. Same for the others.
Since $\deg \wp' = 3$, there can be no other zeroes.
\end{proof}
\begin{corollary}
Let $e_i$ be the values of $\wp$ at its critical points. Then the $e_i$ are distinct and the equation $\wp(z) = e_i$ has a double solution $z$.
For any $w \neq e_i$, $\wp(z) = w$ has two simple solutions $z$.
\end{corollary}
\begin{proof}
Since they are critical points, the $e_i$ have double solutions. Note there can be no other solutions since $\wp$ is of degree $2$.
Moreover if they are not distinct, the $e_i$ would have a solution of order $4$, contradicting the degree of $\wp$.
\end{proof}
\begin{theorem}
For every elliptic function $f$ there are rational functions $R_0,R_1$ such that
$$f = R_0 \circ \wp + \wp' (R_1 \circ \wp).$$
Moreover the term $R_0 \circ \wp$ is the even part of $f$ (so $\wp'(R_1 \circ \wp)$ is the odd part of $f$).
\end{theorem}
\begin{proof}
Decompose $f$ into its even and odd parts and so suppose that $f$ is either even or odd. If $f$ is odd, then $f/\wp'$ is even, so assume that $f$ is even.
Now $\wp$ is an even elliptic surjection $\CC/L \to \PP^1$, so if $f: \CC/L \to \PP^1$ is continuous, there is a continuous map $R: \PP^1 \to \PP^1$ such that
$$\begin{tikzcd}
\CC/L \arrow[r,"f"] \arrow[dr,"\wp"] & \PP^1 \arrow[d,"R"] \\
&\PP^1
\end{tikzcd}$$
commutes. Away from the four points $e_i,\infty$, $\wp$ is locally an isomorphism of Riemann surfaces, so if $R \circ \wp$ is holomorphic away from the four bad points, so is $R$, and hence $R$ is rational.
But a continuous function which is holomorphic on a codiscrete set is holomorphic everywhere.
\end{proof}
\begin{corollary}
An elliptic function is uniquely defined modulo constant terms by the principal parts of its poles. Conversely, any arrangement of poles $p_k$ satisfying
$$\sum_k \Res(f, p_k) = 0$$
defines an elliptic function.
\end{corollary}
\begin{proof}
A rational function on $\PP^1$ is defined by its principal parts.
\end{proof}

We now show that $\wp$ is defined as the solution of a certain differential equation.
This gives an algebraic characterization of elliptic functions, which is useful to number theory.
To accomplish this, we need the Laurent expansion of $\wp$.
\begin{lemma}
There are constants $G_j(L)$ such that
$$u^2\wp(u) = 1 + 3G_4(L)u^4 + 5G_6(L)u^6 + 7G_8(L)u^7 + \cdots.$$
\end{lemma}
\begin{proof}
If $|u| < |\omega|$ then
$$(u - \omega)^{-k} = \frac{(-1)^k}{\omega^k}\left(1 + k\frac{u}{\omega} + \frac{k(k+1)}{2!} \frac{u^2}{\omega^2} + \frac{k(k+1)(k+2)}{3!}\frac{u^3}{\omega^3} + \cdots\right).$$
Plugging this into the definition of $\wp$, the odd terms all cancel since $\wp$ is even, and the claim follows.
\end{proof}
\begin{theorem}
There are constants $g_2,g_3$ such that
$$(\wp')^2 = 4\wp^3 - g_2\wp - g_3.$$
\end{theorem}
\begin{proof}
Compare the first few terms in the Laurent expansion of $\wp'$ with those of the Laurent expansion of $4\wp^3 - g_2\wp - g_3$.
Such terms agree so their difference is an elliptic function with no poles and a zero, hence $0$.
\end{proof}
\begin{corollary}
$g_2^3 \neq 27g_3^3$ and $e_1,e_2,e_3$ are the solutions $z$ of the equation
$$4z^3 - g_2z - g_3 = 0.$$
\end{corollary}
\begin{proof}
The $e_i$ are the critical points, i.e. where $\wp' = 0$. Moreover the discriminant $g_2^3 - 27g_3^3$ must be nonzero since the $e_i$ are distinct.
\end{proof}
\begin{definition}
An \dfn{elliptic curve} is a variety of the form
$$w^2 = 4z^3 - g_2z - g_3$$
with nonzero discriminant $g_2^3 - 27g_3^3$.
\end{definition}
Note that elliptic curves can be considered affine (as subsets of $\CC^2$) or projective (as subsets of $\PP^2$). In the latter case they are tori (compact), as shown by the following theorem.
The requirement that the discriminant is nonzero implies that the elliptic curve has no singularities.
\begin{theorem}
The map $(\wp, \wp'): \CC/L \setminus 0 \to \CC^2$ defines an isomorphism of Riemann surfaces between $\CC/L \setminus 0$ and the (affine) elliptic curve
$$w^2 = 4z^3 - g_2z - g_3.$$
\end{theorem}
\begin{proof}
Let $(z, w)$ be coordinates for $\CC^2$ and let $X$ be the affine variety.
Let $\pi: \CC^2 \to \CC$ be projection onto the $z$-factor. Then we have a commutative diagram
$$\begin{tikzcd}
\CC/L \setminus 0 \arrow[r,"(\wp, \wp')"] \arrow[dr,"\wp"] &X\arrow[d,"\pi"]\\
&\CC
\end{tikzcd}.$$
Away from $e_1,e_2,e_3$, $\pi$ is a proper, two-to-one map and away from the preimages of $e_1,e_2,e_3$, $\wp$ is a proper, two-to-one map.
Moreover, $\wp(u) = \wp(-u)$ while $\wp'(u) = -\wp'(-u)$, so that $\wp'$ takes both values $\pm \wp'(u)$ at the two points $\pm u$ such that $\wp(u) = \wp(-u)$.
Therefore $(\wp, \wp')$ is a bijection. Moreover $\wp'$ has simple zeroes only, so $(\wp, \wp')$ has no singularities.
\end{proof}

\section{Elliptic curves}
We now consider the converse problem to the previous section, where we took a lattice and constructed an elliptic curve from it. Let $T$ be a projective elliptic curve; we will find a lattice $L$ such that $\CC/L = T$, assuming that such a lattice exists.
(It turns out that a lattice will always exist but we do not prove this.)

Let $u$ be the standard coordinate on $\CC/L$ obtained by projection from $\CC$.
Then $du$ is a holomorphic $1$-form on $\CC/L$, since it is the holomorphic pushforward of the holomorphic $1$-form $du$ on $\CC$.
Since every holomorphic function on $\CC/L$ is constant, the following lemma results.
\begin{lemma}
Every holomorphic $1$-form on $\CC/L$ is a constant multiple of $du$.
\end{lemma}
\begin{theorem}
Suppose that there is a lattice $L$ such that $T = \CC/L$.
Then, up to a rescaling,
$$L = \{\int_\gamma du: \gamma \text{ is a closed curve in } T\}.$$
\end{theorem}
\begin{proof}
A closed curve in $T$ lifts to a curve in $\CC$ such that the start point $z_0$ and end point $z_1$ satisfy $z_1 - z_0 \in L$. Thus
$$\int_\gamma du = z_1 - z_0 \in L.$$
Conversely, if $z \in L$, we can find a curve $\gamma$ with this property.
\end{proof}
\begin{corollary}
Let $T$ be a Riemann surface of genus $1$ and let $\phi$ be a nonzero holomorphic $1$-form on $T$. Then $T = \CC/L$, where
$$L = \{\int_\gamma du: \gamma \text{ is a closed curve in } T\}.$$
\end{corollary}
\begin{lemma}
Consider the embedding $T \to \CC^2$ given by
$$u \mapsto (\wp(u), \wp'(u)) = (z, w).$$
Then $du = dz/w$.
\end{lemma}
\begin{proof}
$$\frac{dz}{w} = \frac{d\wp(u)}{\wp'(u)} = \frac{\wp'(u)~du}{\wp'(u)} = du.$$
\end{proof}
\begin{corollary}
One has
\begin{align*}
\omega_1 &= 2\int_{e_2}^{e_3}\frac{dz}{w}\\
\omega_2 &= 2\int_{e_1}^{e_3}\frac{dz}{w}.
\end{align*}
\end{corollary}
\begin{proof}
Change variables to $u$ and note that $e_1 = \wp(\omega_1/2)$ for example.
\end{proof}
The point is that elliptic curves $w^2 = f(z)$ have a one-dimensional space of holomorphic $1$-forms, generated by $dz/w$.

\section{Analytic continuation}
We now construct the Riemann surface of any holomorphic function. This is the maximal Riemann surface on which the function can be defined.
Recall from elementary complex analysis:
\begin{lemma}
If $f$ is a holomorphic function near a point $z \in \CC$, and $R > 0$ is the radius of convergence of the Taylor series of $f$ at $z$, then $f$ admits an analytic continuation to $B(z, R)$.
Moreover, if $P$ is the set of poles and essential singularities of $f$, then $R = d(z, P) > 0$.
\end{lemma}
As a consequence, suppose that $f$ is holomorphic near $z$; we want to define $f(w)$. We choose a path $\gamma$ from $z$ to $w$ which does not pass through $P$, if it exists (otherwise we have no hope of analytically continuing $f$ to $w$).
Since $P$ is closed and $\gamma$ is compact, $d(\gamma, P) > 0$.
Thus for any $z' \in \gamma$, we can at least analytically continue to $B(z', d(\gamma, P))$, and by compactness finitely many of these balls cover $\gamma$.
The problem is that the choice of $\gamma$ matters: see the case of $\sqrt\cdot$ being continued from a neighborhood of $1$ to $-1$.
However, the choice of $\gamma$ is unique up to isomorphism of Riemann surfaces.

\begin{definition}
Let $f$ be a holomorphic function near $z \in \CC$.
By an \dfn{analytic continuation} of $f$ we mean a $4$-tuple $(X, x, \pi, F)$, where $X$ is a connected Riemann surface, $x \in X$, $\pi: X \to \CC$ a holomorphic function which is locally an isomorphism of Riemann surfaces, and $\pi(x) = z_0$, and $F: X \to \CC$ is a holomorphic function such that $F = f \circ \pi$ near $x$.
We will sometimes suppress $X,x,\pi$ and refer to $F$ as an analytic continuation.
\end{definition}
\begin{definition}
The \dfn{Riemann surface of the holomorphic function} $f$ is the final object in the category of analytic continuations of $f$.
\end{definition}
We now show that every holomorphic function has a Riemann surface, i.e. the category of analytic continuations has final objects.
In particular this implies that the Riemann surface is unique.
\begin{lemma}
The category of analytic continuations has final objects.
\end{lemma}
\begin{proof}
Let $f$ be holomorphic near $z$ and let
$$A = \{(R_\alpha, r_\alpha, \pi_\alpha, F_\alpha): \alpha < \kappa\}$$
be the set of all analytic continuations of $f$.
Let $R$ be the disjoint union of $A$ modulo the equivalence relation that $x_\alpha = x_\beta$ iff $\pi_\alpha(x_\alpha) = \pi_\beta(x_\beta)$ and $F_\alpha = F_\beta$ in a neighborhood of $x_\alpha,x_\beta$.
In particular, all of the $r_\alpha$ are identified with $z$.
By construction $\pi,F$ are inherited by $A$ and are continuous. One can check that $R$ is Hausdorff and second-countable, hence is a surface.
Moreover by declaring that $\pi$ is locally an isomorphism of Riemann surfaces we can put holomorphic charts on $R$ which is then a Riemann surface. Every point in $R$ is path-connected to $r_\alpha$, so $R$ is connected. Obviously any analytic continuation embeds in $R$, so $R$ is final.
\end{proof}

As a consequence we show that for simply connected open subsets of $\CC$ analytic continuations are unique (as sets, not as Riemann surfaces identified up to isomorphism).
We really need trivial algebraic topology here -- anything more fancy and we run into issues with $\sqrt\cdot$.
\begin{theorem}[monodromy]
\index{monodromy theorem}
Let $U \subseteq \CC$ be a simply connected open set, $f$ holomorphic near $z \in U$.
If $f$ can be analytically continued along any path in $U$ then there is a unique analytic continuation of $f$ to $U$.
\end{theorem}
To prove this we need the notion of a path-lifting property.
\begin{definition}
Let $U,V$ be path-connected spaces, and $\pi: V \to U$ a local homeomorphism.
We say that $\pi$ has the \dfn{path-lifting property} if every path in $U$ lifts to a path in $V$.
\end{definition}
\begin{lemma}
Let $\pi: V \to U$ be a local homeomorphism of path-connected spaces. If $U$ is simply connected and $\pi$ has the path-lifting property then $\pi$ is a homeomorphism.
\end{lemma}
\begin{proof}
We construct an inverse of $\pi$: let $u \in U$, choose a path $\gamma$ to $u$, and lift $\gamma$ to a path $\widetilde \gamma$.
Then let $\pi^{-1}(u)$ be the endpoint of $\widetilde \gamma$.
\end{proof}
\begin{lemma}
A holomorphic function $f$ can be analytically continued along a path $\gamma$ starting at $a$ iff $\gamma$ can be lifted to the Riemann surface of $f$, starting at the lift of $a$.
\end{lemma}


\begin{proof}[Proof of monodromy theorem]


\end{proof}


\part{Harmonic analysis}
\chapter{Rearrangement-invariant spaces}
We are interested in studying integral transforms. One often only defines these transforms on test functions and extends them using a continuity argument. For example, the \dfn{Hilbert transform} is defined by
$$Hf(x) = \frac{1}{\pi}\int_{-\infty}^\infty \frac{f(y)}{x-y}~dy.$$
This makes no sense if $f(0) \neq 0$, for example, but one can fix this by taking
$$Hf(x) = \lim_{\varepsilon \to 0} \frac{1}{\pi} \left(\int_{-\infty}^\varepsilon + \int_\varepsilon^\infty\right) \frac{f(y)}{x-y}~dy.$$
Then $Hf$ converges if $f$ is a Schwartz function. One can then check that for every $p \in (1, \infty)$ there is a constant $C_p$ such that for every $f$ for which $Hf$ is defined,
$$||Hf||_{L^p} \leq C_p ||f||_{L^p}.$$
So $H$ extends uniquely to a bounded linear operator on $L^p$, since such $f$ are dense in $H$.

We therefore consider certain generalizations of $L^p$ spaces. Fix a $\sigma$-finite measure space $(X, \Sigma, \mu)$.

\begin{definition}
A norm $||\cdot||$ is \dfn{rearrangement-invariant} if for every isomorphism of measure spaces $\Phi: X \to X$ and every measurable function $f$ we have
$$||f|| = ||f \circ \Phi||.$$
\end{definition}
\begin{definition}
A norm $||\cdot||$ is \dfn{monotone} if for all measure functions $f,g$ such that $|f| \leq |g|$ a.e. we have
$$||f|| \leq ||g||.$$
\end{definition}
A rearrangement-invariant, monotone norm ignores the sign of a function, and is only interested in how ``tall" a function is versus how ``wide" the function is.
Clearly $L^p$ norms are rearrangement-invariant and monotone.

\section{Log-convexity for $L^p$ norms}
Recall that $L^p$ norms are \dfn{log-convex}, i.e. if $\theta \in (0, 1)$ and
$$\frac{1}{r} = \frac{1-\theta}{p} + \frac{\theta}{q},$$
we have
$$||f||_{L^r} \leq ||f||^{1-\theta}_{L^p} ||f||^\theta_{L^q}.$$
This is essentially equivalent to the H\"older inequality. We give another proof of log-convexity.

\begin{theorem}[three-lines lemma]
\index{three-lines lemma}
Let $f$ be holomorphic on the strip $0 \leq \Re z \leq 1$ of at most double-exponential growth. Suppose that $|f(z)| \leq A$ when $\Re z = 0$ and $|f(z)| \leq B$ when $\Re z = 1$. Then
$$|f(z)| \leq A^{1-\Re z}B^{\Re z}.$$
\end{theorem}
\begin{proof}
The hypothesis and conclusion are invariant under multiplying $f$ by $Ce^{cz}$ where $C,c \in \RR$, as long as we appropriately rescale $A,B$. Thus we may assume that $A = B = 1$, and want to show $||f||_{L^\infty} \leq 1$.

Assume $f$ goes to $0$ at infinity, so there is an $N$ such that if $\Im z \geq N$, we have $|f(z)| \leq 1$. Then by the maximum principle, $||f||_{L^\infty} = 1$.

Otherwise, note that
$$f(z) = \lim_{\varepsilon \to 0} f(z)\exp(\varepsilon e^{i((\pi-\varepsilon)z+\varepsilon/2)}),$$
and by assumption on $f$, it follows that the function in the limit goes to $0$, so the right-hand side is $\leq 1$.
\end{proof}

\begin{proof}[Proof of log-convexity]
Let $f$ be a simple function and suppose $\mu(X) < \infty$. Let
$$g(z) = \int_X |f|^z.$$
Then $|g(z)| = O(e^{|z|})$ and $|g(s + it)| = ||f||_{L^s}^s$.
The claim follows for $f$ by rescaling the three-lines lemma.

The claim is invariant under monotone convergence and $\mu$ is $\sigma$-finite, so the assumptions that $f$ is simple and $\mu$ is finite can be dropped.
\end{proof}

Log-convexity allows us to prove that certain $L^p$ spaces embed in others.
\begin{corollary}
If $\mu(\supp f) < \infty$ and $p \leq q$ then
$$||f||_{L^p} \leq \mu(\supp f)^{1/p-1/q}||f||_{L^q}.$$
In particular, if $\mu(X) < \infty$, then $L^q(\mu) \subseteq L^p(\mu)$.
\end{corollary}
\begin{proof}
This is obvious if $q = \infty$ and otherwise follows by log-convexity.
\end{proof}

\begin{definition}
A \dfn{granular measure} is a measure $\nu$ such that there is a $\delta > 0$ such that for every set $A$ which is not $\nu$-null, $\nu(A) > \delta$.
\end{definition}
\begin{corollary}
If $\mu$ is $\delta$-granular and $p \leq q$ then
$$||f||_{L^q} \leq \delta^{1/q-1/p}||f||_{L^p}.$$
In particular, $L^p(\mu) \subseteq L^q(\mu)$.
\end{corollary}
The proof is the same. In particular, $\ell^p$ spaces satisfy this estimate, and if $\card \supp f = N$, $f \in \ell^p$, then we have
$$||f||_{\ell^q} \leq ||f||_{\ell^p} \leq N^{1/p-1/q}||f||_{\ell^q}$$
if $q \geq p$.
Though Lebesgue measure is not granular, if a function is constant on boxes which tile $\RR^n$, one can replace the Borel algebra with the $\sigma$-algebra generated by the boxes, and restrict Lebesgue measure to this $\sigma$-algebra; then it becomes granular.

Now note that by log-convexity with $q = \infty$, if $p \leq q$ we have
$$||f||_{L^q} \leq C^{1-p/q}||f||_{L^p}^{p/q}$$
if $|f| \leq C$.
On the other hand, if $|f| \geq c$ on $\supp f$ then replacing $f$ by $1/f$ in the above estimate we have
$$||f||_{L^p} \leq c^{1-q/p}||f||_{L^q}^{q/p}.$$

\section{Lorentz norms}
Still fix a measure space $(X, \mu)$.
\begin{definition}
The \dfn{weak $L^p$ norm} is defined by
$$||f||_{L^{p,\infty}} = \sup_{\lambda > 0} \lambda \mu(\{|f| \geq \lambda\})^{1/p}.$$
\end{definition}
\begin{theorem}[Chebyshev inequality]
\index{Chebyshev inequality}
One has
$$||f||_{L^{p,\infty}} \leq ||f||_{L^p}.$$
\end{theorem}
\begin{proof}
Take $\sup_\lambda$ of both sides of the inequality
$$\lambda^p \mu(\{|f| \geq \lambda\}) \leq \int_{|f| \geq \lambda} \lambda^p~d\mu \leq \int_X |f|^p ~d\mu = ||f||_{L^p}^p.$$
\end{proof}
So $L^p \subseteq L^{p,\infty}$. This motivates the terminology ``weak $L^p$".

Let $\lambda$ be the coordinate function on $\RR^+$. Recall that $d\lambda/\lambda$ is the Haar measure on $\RR^+$, the group of positive reals under multiplication.
Now $L^\infty(d\lambda/\lambda) = L^\infty(\RR^+)$ since Haar and Lebesgue measures are mutually absolutely continuous. Thus we have
$$||f||_{L^{p,\infty}} = p^0||\lambda \mu(\{|f| \geq \lambda\})^{1/p}||_{L^\infty(d\lambda/\lambda)}.$$
This seems a little silly until we reason by metaphor with the following lemma.
\begin{lemma}
One has
$$||f||_{L^p} = p^{1/p}||\lambda \mu(\{|f| \geq \lambda\})^{1/p}||_{L^p(d\lambda/\lambda)}.$$
\end{lemma}
\begin{proof}
One has
$$p\int_0^{|f(x)|} \lambda^p ~\frac{d\lambda}{\lambda} = \int_0^{|f(x)|} p\lambda^{p-1} ~d\lambda = |f(x)|^p$$
by the fundamental theorem. Integrating both sides and using Fubini's theorem, we have
\begin{align*}||f||_{L^p}^p &= p\int_X \int_0^{|f(x)|} \lambda^p ~\frac{d\lambda}{\lambda}~dx \\
&= p\int_0^\infty \lambda^p \int_X 1_{|f(x)| \geq \lambda} ~dx~\frac{d\lambda}{\lambda} \\
&= p\int_0^\infty \lambda^p \mu(\{|f| \geq \lambda\}) ~\frac{d\lambda}{\lambda}.
\end{align*}
The claim follows by taking $p$th roots.
\end{proof}
Thus we make the following definition.

\begin{definition}
The $(p,q)$th \dfn{Lorentz norm} is defined by
$$||f||_{L^{p,q}} = p^{1/q}||\lambda\mu(\{|f| \geq \lambda\})^{1/p}||_{L^q(d\lambda/\lambda)}.$$
\end{definition}
Thus the definition of $L^{p,\infty}$ is consistent with that of the weak $L^p$ norm and we have $L^{p,p} = L^p$.

We now consider certain approximate step functions that will allow us to determine what the Lorentz norms actually measure.
\begin{definition}
A \dfn{substep function} of height $H$ and width $W$ is a function $f$ such that $||f||_{L^\infty} \leq H$ and $\mu(\supp f) \leq W$.

A $\delta$-\dfn{quasistep function} of height $H$ and width $W$ is a function $f$ such that $\delta H \leq |f| \leq H/\delta$ and $\delta W \leq \supp(f) \leq H/\delta$.
\end{definition}
Usually the exact value of $\delta$ is not important, and we suppress the $\delta$ by writing $|f| \sim H$.
However, one is always implicitly fixed when working with a family of quasistep functions; for example, every function is trivially $0$-quasistep, which is not very useful.

We can use substep and quasistep functions to understand the behavior of Lorentz norms.
\begin{theorem}
Let $f$ be a measurable function and let $p,q,A$ be given. Then the following are equivalent:
\begin{enumerate}
\item $||f||_{L^{p,q}} \lesssim_{p,q} A$.
\item There is a decomposition $f = \sum_{m=-\infty}^\infty f_m$ where $f_m$ is quasistep of height $2^m$ and width $W_m$ such that the $\supp(f_m)$ are disjoint and
$$\left(\sum_{m=-\infty}^\infty 2^{mq}W^{q/p}_m\right)^{1/q} \lesssim_{p,q} A.$$
\item There is a pointwise estimate $|f| \leq \sum_{m=-\infty}^\infty 2^m1_{E_m}$ where
$$\left(\sum_{m=-\infty}^\infty 2^{mq}\mu(E_m)^{q/p}\right)^{1/q} \lesssim_{p,q} A.$$
\item There is a decomposition $f = \sum_{n=-\infty}^\infty f_n$ where $f_n$ is substep of width $2^n$ and height $H_n$ such that the $\supp(f_n)$ are disjoint, $H_n$ are nonincreasing, $H_{n+1} \leq |f_n| \leq H_n$ on $\supp f_n$, and
$$\left(\sum_{n=-\infty}^\infty H_n^q2^{nq/p}\right)^{1/q} \lesssim_{p,q} A.$$
\item There is a pointwise estimate $|f| \leq \sum_{n=-\infty}^\infty H_n 1_{E_n}$ where $\mu(E_n) \lesssim_{p,q} 2^n$ and
$$\left(\sum_{n=-\infty}^\infty H_n^q2^{nq/p}\right)^{1/q} \lesssim_{p,q} A.$$
\end{enumerate}
\end{theorem}
Intuitively, if $f$ is quasistep of height $H,W$ then $||f||_{L^{p,q}} \approx HW^{1/p}$, and this estimate propagates in \emph{sums} of quasistep functions in $\ell^q$ norm.


\chapter{Decoupling theory}
This chapter is based on Terry Tao's online course on harmonic analysis.

\section{Square-root cancellation}
If $z_j$ are ``random, independent" complex numbers, one intuitively expects
$$\left|\sum_j z_j\right| \approx \sqrt{\sum_j |z_j|^2}.$$
This is true for the expected value where the $z_j$ are given random, uniformly selected signs, up to a constant.
This is \dfn{Khinchine's inequality}.

Another way one can make the above claim rigorous is using Littlewood-Paley theory.
\begin{theorem}[Littlewood-Paley estimates]
\index{Littlewood-Paley estimates}
Let $p \in (1, \infty)$, $A_j$ be the annuli in frequency space
$$A_j = \{\xi \in \RR^d: 2^j \leq |\xi| \leq 2^{j+1}\}.$$
Assume that $f_j$ are functions such that $\hat f_j$ are supported on disjoint annuli $A_{k_j}$. Then
$$||\sum_j f_j||_{L^p} \lesssim_{p, d} ||\sqrt{\sum_j |f_j|^2}||_{L^p}.$$
If the annuli are separated then we can replace $\lesssim_{p, d}$ with $\sim_{p,d}$.
\end{theorem}
We will prove this later on.
We note however that it is trivial when $p = 2$. In fact, since the $\hat f_j$ have disjoint support, the $f_j$ are orthogonal by Plancherel's theorem.
So by the Pythagorean theorem,
$$||\sum_j f_j||_{L^2} = ||\sqrt{\sum_j |f_j|^2}||_{L^2}.$$
If we even just have ``almost-orthogonality" we still get decent estimates in $L^2$.
One can manipulate the $L^2$ estimate to get estimates in $L^{2^k}$, $k \geq 2$, but one needs something stronger than orthogonality here, and as $k \to \infty$ this becomes extremely complicated.

To generalize to $p > 2$ where $p \neq 2^k$, we want to study \dfn{decoupling estimates}, those of the form
$$||\sum_j f_j||_{L^p} \lesssim_{p, d} \sqrt{\sum_j ||f_j||_{L^p}^2}.$$
This is weaker than a square root cancellation estimate, but it is much easier to prove.
If $p = 2$ it follows easily by noting that
$$||\sum_j |f_j|^2||_{L^1} \leq \sum_j |||f_j|^2||_{L^1}$$
by the triangle inequality, and then taking the square root of both sides.
One can therefore think of decoupling estimates as vast generalizations of the Pythagorean theorem.
The reason these estimates are called decoupling estimates is that we start with the left-hand sides, where we take a norm of $\sum_j f_j$, and then on the right-hand side we take norms of each of the $f_j$s separately, and they ``decouple" in the sense that their norms no longer influence each other.

One can iterate decoupling estimates in the sense that
$$||\sum_{j_1, \dots, j_n} f_{j_1, \dots, j_n}||_{L^p} \lesssim_{p, d, n} \sqrt{\sum_{j_1, \dots, j_n} ||f_{j_1, \dots, j_n}||_{L^p}^2},$$
simply by induction on $n$. Thus decoupling plays nicely with induction, though notice that the constant possibly depends on $n$.
An important concept in the study of decoupling estimates is to control the dependency of the constant on $n$.

\begin{proof}[Proof of Littlewood-Paley estimates]
We first prove that if $|k_j - k_{j'}| \geq 2$ then
$$||\sqrt{\sum_j |f_j|^2}||_{L^p} \lesssim_{p,d} ||\sum_j f_j||_{L^p}.$$

Let $\psi$ be a bump function on $\{\xi: 1-\varepsilon < |\xi| < 2 + \varepsilon\}$ which is identically $1$ on $\{\xi: 1 < |\xi| < 2\}$.
Let
$$\widehat{P_{k_j}f}(\xi) = \psi(2^{-k_j}\xi)\hat f(\xi)$$
so $P_{k_j}$ is a Fourier multiplier (actually a Littlewood-Paley projector), which is bounded $L^p \to L^p$.
Let $f = \sum_j f_j$, so $f_j = P_{k_j}f_j$.
Let $\epsilon_1, \dots, \epsilon_n$ be random signs, drawn uniformly and independently, and let
$$P = \sum_j \epsilon_j P_{k_j}$$
be a random Fourier multiplier, which again is bounded $L^p \to L^p$ uniformly in the choice of signs. (Here we use $p > 1$ and Calderon-Zygmund theory, or more accurately the Hormander-Mikhlin theorem.) Thus
$$||\sum_j \epsilon_j f_j||_{L^p} \lesssim_{p,d} ||\sum_j f_j||_{L^p}.$$
The claim then follows from Khinchine's inequality.

To prove $\gtrsim_{p, d}$, use the triangle inequality to split up into two sums, one where the $k_j$ are odd and one where the $k_j$ are even.
This trick is called \dfn{sparsification}. We work with each term separately so that $|k_j - k_{j'}| > 2$ and we meet the hypotheses of $\lesssim_{p, d}$.
Now
$$f_j = \epsilon_j P_{k_j} \sum_\ell \epsilon_\ell f_\ell,$$
so
$$f = \sum_j \epsilon_j P_{k_j} \sum_\ell \epsilon_\ell f_\ell.$$
Again by Calderon-Zygmund theory,
$$||\sum_j f_j||_{L^p} \lesssim_{p, d} ||\sum_j \epsilon_j f_j||_{L^p}$$
and we use Khinchine's inequality again.
\end{proof}

\begin{lemma}
Let $f_1, \dots, f_n$ have Fourier supports $\Omega_1, \dots, \Omega_n$.
If any $\xi$ lies in at most $A_2$ of the $\Omega_i$ (``the $\Omega_i$ have overlap $A_2$") then
$$||\sum_j f_j||_{L^2} \leq \sqrt{A_2} ||\sqrt{\sum_j |f_j|^2}||_{L^2}.$$
If $\Omega_i + \Omega_j$ have overlap $A_4$ then
$$||\sum_j f_j||_{L^4} \leq \sqrt[4]{A_4} ||\sqrt{\sum_j |f_j|^2}||_{L^4}.$$
\end{lemma}
\begin{proof}
The first claim follows by using Plancherel to pass to Fourier space and then using Cauchy-Schwarz.

For the second claim, note that
$$||\sum_j f_j||_{L^4}^2 = \sum_{ij} f_if_j||_{L^2}$$
and since $f_if_j$ has Fourier support $\Omega_i + \Omega_j$ this reduces the claim to the first claim.
\end{proof}

\section{Decoupling estimates}
\begin{definition}
Let $\mathcal U = \{U_1, \dots, U_n\}$ be a finite multiset of nonempty open sets and let $p \in [1, \infty]$. The \dfn{decoupling constant} $\Dec_p(\mathcal U)$ is the optimal constant in the inequality
$$||\sum_j f_j||_{L^p} \leq \Dec_p(\mathcal U)\sqrt{\sum_j ||f_j||^2}$$
whenever $f_j$ has Fourier support in $U_j$.
\end{definition}
If all but one of the $f_j$ vanish we see that $\Dec_p(\mathcal U) \geq 1$, and by Cauchy-Schwarz we have $\Dec_p(\mathcal U) \leq \sqrt{\card \mathcal U}$.
Intuitively $\Dec_p(\mathcal U)$ measures how spread out $\mathcal U$ is: if they are ``more disjoint" then $\Dec_p(\mathcal U) \to 1$.

One can check that if $U_i \subseteq U_i'$ then
$$\Dec_p(U_1, \dots, U_n) \leq \Dec_p(U_1', \dots, U_n').$$
We also have a triangle inequality
$$\Dec_p(\mathcal U \cup \mathcal V) \leq \sqrt{\Dec_p(\mathcal U)^2 + \Dec_p(\mathcal V)^2}.$$
If $L$ is an affine transformation then $L$ preserves $\Dec_p$, so $\Dec_p$ is dimensionless.

They also interpolate: if $p_0 \leq p \leq p_1$ and
$$\frac{1}{p} = \frac{1-\theta}{p_0} + \frac{\theta}{p_1},$$
and
$$||P_{U_j}f||_{L^{p_i}} \lesssim_{p_i,d} ||f||_{L^{p_i}},$$
where $P_{U_j}$ is the Littlewood-Paley projector, then
$$\Dec_p(\mathcal U) \lesssim_{p_0,p_1,p,d} \Dec_{p_1}(\mathcal U)^{1-\theta}\Dec_{p_0}(\mathcal U)^\theta.$$
If we have partitions $U_j = \bigoplus_i U_{j,i}$ into open sets up to measure zero, then
$$\Dec_p(\{U_{j,i}: j,i\}) \leq \Dec_p(\mathcal U)\sup_j \Dec_p(\{U_{j,i}:i\}).$$
We can also add dummy dimensions: if $d' \geq 1$ then
$$\Dec_p(\mathcal U) = \Dec_p(\{U_i \times \RR^{d'}: i\}).$$

If $p = 2$, decoupling is easy: by a previous lemma, if the sets have overlap $A_2$, then
$$\Dec_p(\mathcal U) \leq \sqrt{A_2}.$$

We now prove $L^6$ decoupling for the parabola.
\begin{theorem}
Let $\delta > 0$, let $\phi(\xi) = (\xi, \xi^2)$ parametrize the parabola in $\RR^2$, let $\Sigma$ be a $\delta$-separated subset of $[-1, 1]$ and $\Omega = \phi(\Sigma)$, and take the parallelograms $R(\omega, \delta)$ centered on points $\omega$ of $\Omega$ with width $2\delta$, height $2\delta^2$,
and slope equal to the slope of the parabola at $\omega$. Then for any $\varepsilon > 0$,
$$\Dec_6(\{R(\omega, \delta): \omega \in \Omega\}) \lesssim_\varepsilon \delta^\varepsilon.$$
\end{theorem}
This theorem was proven in the early 2010s by Bourgain and Demeter. We will give an argument of Li published in 2018.
If $p > 6$ then the above decoupling estimate fails; we omit the proof of this.

To prove the above theorem, if $\delta > 0$ let
$$D(\delta) = \sup_\Sigma \Dec_6(R(\omega, \delta): \omega \in \phi(\Sigma))$$
where $\Sigma$ ranges over all $\delta$-separated subsets of $[-1, 1]$. Then
$$1 \leq D(\delta) \lesssim \delta^{-1/2}.$$
This is because in this case we would be decoupling $\sim \delta^{-1}$ many sets.
We must show
$$D(\delta) \lesssim_\varepsilon \delta^{-\varepsilon}.$$
Note that $D$ is not necessarily increasing in $\delta$.
If $\delta$ increases to $\delta + \varepsilon$, we cannot refine the partition $\Sigma_\delta$ to a partition $\Sigma_{\delta + \varepsilon}$ if $\varepsilon$ is too small -- so we end up with a completely different partition!

We first show that $D$ is stable.
\begin{lemma}
If $\delta \sim \delta'$ then $D(\delta) \sim D(\delta')$.
\end{lemma}
\begin{proof}
This claim is transitive, so we may actually prove it when $\delta$ and $\delta'$ are not symmetrical, say
$$10\delta \leq \delta' \lesssim \delta.$$

We first show $D(\delta) \lesssim D(\delta')$, i.e. if $\Sigma$ is $\delta$-separated then
$$\Dec_6(R(\omega, \delta): \omega \in \phi(\Sigma)) \lesssim D(\delta').$$
Using sparsification and the triangle inequality for $\Dec$ we may split up $\Sigma$ into finitely many pieces, each of which is $\delta'$ separated, and then assume that $\Sigma$ is $\delta'$-separated.
Thus
$$\Dec_6(R(\omega, \delta): \omega \in \phi(\Sigma)) \lesssim \Dec_6(R(\omega,\delta'): \omega \in \phi(\Sigma)) \lesssim D(\delta').$$

Conversely, we must show that if $\Sigma'$ is $\delta'$-separated then
$$\Dec_6(R(\omega', \delta'): \omega' \in \phi(\Sigma')) \lesssim D(\delta).$$
That is,
$$||\sum_{\omega'} f_{\omega'}||_{L^6} \lesssim D(\delta)\sqrt{\sum_{\omega'} ||f_{\omega'}||_{L^6}^2},$$
for any $f_{\omega'} \in L^6(\RR^2)$ whose Fourier support is in $R(\omega', \delta')$.
By breaking up the $R(\omega', \delta')$ into parallelograms $R(\phi(\xi),\delta) + (0, jc\delta^2)$ where $j = O(1)$ is an index and $c$ is a small absolute constant, and applying Littlewood-Paley projectors, we see the claim.
\end{proof}

\begin{lemma}
Let $\delta \leq \delta_0.$ Let $\Sigma$ be $\delta$-separated and contained in an interval $I$ of length $2\delta_0$. Then
$$\Dec_6(R(\omega, \delta):\omega \in \phi(\Sigma)) \lesssim D(\delta/\delta_0).$$
\end{lemma}
\begin{proof}
If $\delta_0 \sim 1$ then this follows from the stability lemma. Otherwise, choose an absolute constant $c > 0$ and $\delta_0 < c$.
Acting on the parabola by the Galilean group we may assume $I$ is centered at $0$.

Now rescale the parabola by $(\xi_1, \xi_2) \mapsto (\xi_1/\delta_0, \xi_2/\delta_0^2)$. This has a nontrivial Jacobian but it's not a big deal. Then the claim is
$$\Dec_6(R(\omega, \delta): \omega \in \phi(\Sigma)) \lesssim \Dec_6(R(\omega, 1): \omega \in \phi(\Sigma/\delta_0)).$$
\end{proof}
Thus we at least have a local induction in scales. In fact it implies
$$D(\delta_1\delta_2) \lesssim D(\delta_1) D(\delta_2)$$
by using the triangle inequality to split $\Sigma$ into small subsets where we can induct on scales.
The trouble is that the implied constant in this estimate could be huge, and so every time we apply the induction hypothesis we could get a horrible buildup.
So we need to replace this estimate with a slightly better estimate; annoyingly, nobody seems to know how to do this in general, other than trial and error.

\begin{definition}
Let $0 \leq \delta \leq \rho_1, \rho_2 \leq \nu \leq 1$. Let $M_{2,4}(\delta, \nu, \rho_1, \rho_2)$ be the best constant such that
for any $\delta$-separated sets $\Sigma_1,\Sigma_2$ contained in intervals $I_1,I_2$ of lengths $\rho_1,\rho_2$, such that $d(I_1, I_2) \geq \nu$,
and $f_{\omega_1},g_{\omega_2}$ collections of Schwartz functions whose Fourier support is contained in $R(\omega_1,\delta)$, $R(\omega_2,\delta)$,
$$\int_{\RR^2}|\sum_{\omega_1 \in \phi(\Sigma_1) f_{\omega_1}}|^2 |\sum_{\omega_2 \in \phi(\Sigma_2)}|^4
\leq M_{2,4}(\delta, \nu, \rho_1, \rho_2)^6 \sum_{\omega_1 \in \phi(\Sigma_1)} ||f_{\omega_1}||_{L^6}^2 \sum_{\omega_2 \in \phi(\Sigma_2)} ||g_{\omega_2}||_{L^6}^2$$
\end{definition}
We might as well think of $\nu = 1$ but it is convenient to be able to perturb it. Confusingly, we want to hold $\delta$ fix and induct on $\rho$.
The reason for this madness is because we want to use Hilbert space theory, and this is possible because of the sum of squares in $f_{\omega_1}$.
Otherwise we would use $3+3$ instead of $2+4$. In fact the $L^4$ term will look like a constant and then this reduces to basic facts about $L^2$.

By Holder, we have
$$\int_{\RR^2}|\sum_{\omega_1 \in \phi(\Sigma_1) f_{\omega_1}}|^2 |\sum_{\omega_2 \in \phi(\Sigma_2)}|^4
\leq ||\sum_{\omega_1} f_{\omega_1}||_{L^6}^2 ||\sum_{\omega_1}||_{L^6}^4.$$
Therefore
$$M_{2,4}(\delta, \nu, \rho_1, \rho_2) \leq D(\delta).$$
We will mainly be interested in when $\rho_1 = \rho_2 = \nu \gtrsim 1$.

\begin{lemma}
If $0 \leq \delta \leq \nu \leq 1$ then
$$D(\delta) \lesssim \nu^{-O(1)} M_{2,4}(\delta, \nu, \nu, \nu) + D(\delta/\nu).$$
\end{lemma}
In this scenario, the $\nu^{-O(1)} \approx 1$ and $D(\delta/\nu)$ terms are basically irrelevant and so, heuristically, this lemma says that
$$D(\delta) \lesssim M_{2,4}(\delta, \nu, \nu, \nu)$$
which is what we want, because since the $L^4$ term is basically a constant, this reduces the $L^6$ decoupling problem to an $L^2$ problem.
This gives a hint as to why $6$ is the optimal exponent.
\begin{proof}
Let $\Sigma$ be a $\delta$-separated subset of $[0, 1]$ and for each $\omega \in \phi(\Sigma)$, let $f_\omega \in L^6$ have Fourier support in $R(\omega, \delta)$.
Normalizing, we assume $\sum_\omega ||f_\omega||_{L^6}^2 = 1$. We then must show
$$\int_{\RR^2} |\sum_\omega f_\omega|^6 \lesssim \nu^{-O(1)} M_{2,4}(\delta, \nu, \nu, \nu)^6 + D(\delta/\nu)^6.$$
Partition $\Sigma$ into components $\Sigma_I$ where each $\Sigma_I$ is contained in some subinterval $I$ of $[-1, 1]$ of length $\nu$.
Let $\mathcal I$ index the intervals, so $\card \mathcal I = O(1/\nu)$. Then
$$|\sum_{\omega \in \phi(\Sigma)} f_\omega(x)| \leq \sum_{I \in \mathcal I}|\sum_{\omega \in \phi(\Sigma_I)} f_\omega(x)|.$$
Then for each $x$, the pigeonhole principle furnishes an $I_x$ such that
$$|\sum_{\omega \in \phi(\Sigma)} f_\omega(x)| \lesssim |\sum_{\omega \in \phi(\Sigma_I)} f_\omega(x)|,$$
the ``narrow case", or there are $I, J$ such that $d(I, J) \geq \nu$ and
$$|\sum_{\omega \in \phi(\Sigma)} f_\omega(x)| \lesssim \nu^{-O(1)}|\sum_{\omega \in \phi(\Sigma_I)} f_\omega(x)||\sum_{\omega \in \phi(\Sigma_J)} f_\omega(x)|.$$
In particular,
$$|\sum_{\omega \in \phi(\Sigma)} f_\omega(x)| \lesssim \nu^{-O(1)} \sum_{d(I, J) \geq \nu} |\sum_{\omega \in \phi(\Sigma_I)} f_\omega|^2|\sum_{\omega \in \phi(\Sigma_J)} f_\omega|^4 + \sum_I |\sum_{\omega \in \phi(\Sigma_I)} f_\omega|^6.$$
By definition,
$$\int_{\RR^2} \sum_{\omega \in \phi(\Sigma_I)} f_\omega|^2|\sum_{\omega \in \phi(\Sigma_J)} f_\omega|^4 \lesssim M_{2,4}(\delta, \nu, \nu, \nu).$$
Meanwhile, by the parabolic rescaling estimate,
$$\int_{\RR^2} |\sum_{\omega \in \phi(\Sigma_I)} f_\omega|^6 \lesssim D(\delta/\nu)^6 (\sum_{\omega \in \phi(\Sigma_I)} ||f_\omega||_{L^6}^2)^3$$
but by our normalization, after summing over $I$, this implies that
$$\sum_I \int_{\RR^2} |\sum_{\omega \in \phi(\Sigma_I)} f_\omega|^6 \lesssim D(\delta/\nu)^6.$$
\end{proof}
Thus if we can get a good estimate in the endpoint case $\rho_1 = \rho_2 = \nu$ we are in good shape, as
$$D(\delta) \approx M_{2,4}(\delta, \nu, \nu, \nu)$$
when $\nu$ is much larger than $\delta$.
On the other hand it's only easy to estimate $M_{2,4}(\delta, \rho_1, \rho_2, \nu)$ when $\rho_1,\rho_2$ are very small.

Our next lemma allows to assume that \emph{one} of the $\rho$'s is very small:
\begin{lemma}
Suppose $0 \leq \delta \leq \rho_2^2 \leq \rho_1' \leq \rho_1 \leq \nu \leq 1$ and $\delta \leq \rho_2 \leq \nu$ then
$$M_{2,4}(\delta, \nu, \rho_1, \rho_2) \lesssim \nu^{-O(1)}M_{2,4}(\delta, \nu, \rho_1', \rho_2).$$
\end{lemma}
\begin{proof}
It suffices to show that
$$\int_{\RR^2} |\sum_{\omega_1 \in \phi(\Sigma_1)} f_{\omega_1}|^2 |\sum_{\omega_2 \in \phi(\Sigma_2)} g_{\omega_2}|^4 \lesssim \nu^{-O(1)} M_{2,4}(\delta, \nu, \rho_1, \rho_2)^6$$
whenever $\Sigma_1,\Sigma_2$ are of the appropriate lengths $\rho_1,\rho_2$ and separation $\delta,\nu$ and the $f_{\omega_i},g_{\omega_i}$ have Fourier support in $R(\omega_i,\delta)$. Here we normalize
$$\sum_{\omega_1} ||f_{\omega_1}||_{L^6}^2 = ||\sum_{\omega_2} g_{\omega_2}||_{L^6}^4 = 1.$$
We are viewing the integral we are trying to bound as a weighted sum of $L^2$-norms where the $L^4$-norms are weights.

Partition $\Sigma_1$ into $\delta$-separated subsets $\Sigma_{1,I'}$ of intervals $I'$ of length $\rho_1'$ of bounded overlap.
The left-hand side of the claim is given by $||\sum_{I'} F_{I'}G^2||^2_{L^2}$ where $F_{I'} = \sum_{\omega_1 \in \phi(\Sigma_{1,I'})} f_{\omega_1}$ and $G = \sum_{\omega_2}g_{\omega_2}$.
But
$$||F_{I'}G^2||_{L^2}^2 \leq M_{2,4}(\delta, \nu, \rho_1', \rho_2) \sum_{\omega_1} ||f_{\omega_1}||_{L^6}^2.$$
So we must prove
$$||\sum_{I'} F_{I'}G^2||_{L^2}^2 \lesssim \nu^{-O(1)} \sum_{I'} ||F_{I'}G^2||_{L^2}^2.$$

After a Galilean transform we may assume $J$ is centered at $0$ and thus $I$ is at least $\gtrsim \nu$ from the origin.
In this setting $G$ is Fourier supported on a small rectangle of height $O(\rho_2^2 + \delta)$, so it is almost constant in the vertical direction.
A copmutation I missed means this implies the lemma.
\end{proof}

\begin{lemma}
For any $0 \leq \delta \leq \rho_1 \leq \rho_2 \leq \nu \leq 1$,
$$M_{2,4}(\delta, \nu, \rho_1, \rho_2) \lesssim \sqrt{M_{2,4}(\delta, \nu, \rho_2, \rho_1) D(\delta/\rho_2)}.$$
\end{lemma}
This follows by Hoelder's inequality. In fact, if $f$ is the sum of the $f_\omega$, $\omega \in \phi(I_1)$ where $|I_1| = \rho_1$ and similarly for $g$ and $\rho_2$,
this lemma is equivalent to the inequality
$$\int_{\RR^2} |f|^2|g|^4 \leq \int_{\RR^2} |f|^4|g|^2 \int_{\RR^2} |g|^6.$$
This is true by the $L^6$ version of Hoelder, if we normalize $||f||_{L^6} = ||g||_{L^6} = 1$ and then rescale appropriately.
This allows us to induct on the scales $\rho_j$ by ping-ponging back and forth between $\rho_j$.

Let $\alpha$ be the least exponent such that for every $\delta > 0$, $D(\delta) \leq \delta^{ - \alpha - o(1)}$.
Then
$$\alpha = \limsup_{\delta \to 0} - \frac{\log D(\delta)}{\log \delta}.$$
\begin{lemma}
One has $\alpha = 0$.
\end{lemma}
\begin{proof}
Suppose not; we will find an $\alpha'$ such that $D(\delta) \leq \delta^{ - \alpha' - o(1)}$, a contradiction.

Let $\nu = \delta^\varepsilon$ for some $\varepsilon > 0$ which is independent of $\delta$ and to be chosen later.
Then
$$D(\delta) \lesssim \delta^{-O(\varepsilon)} M_{2,4}(\delta, \nu, \nu, \nu) + \delta^{(-1-\varepsilon)\alpha - o(1)}.$$
Since $\alpha > 0$, the second term is harmless.
We then need to control the first term.

By an above lemma,
$$M_{2,4}(\delta, \nu, \nu, \nu) \lesssim \delta^{-O(\varepsilon)} M_{2,4}(\delta, \nu, \nu^2, \nu).$$
If $a \leq O(\varepsilon^{-1})$, we have
$$M_{2,4}(\delta, \nu, \nu^{2a}, \nu^a) \leq M_{2,4}(\delta, \nu, \nu^a, \nu^{2a})^{1/2} D(\delta/\nu^a)^{1/2}$$
and
$$D(\delta/\nu^a)^{1/2} \lesssim (\delta/\nu^a)^{-(\delta + o(1))/2} = \delta^{-\alpha/2 + a\alpha\varepsilon/2 - o(1)}.$$
Thus
$$M_{2,4}(\delta, \nu, \nu^{2a}, \nu^a) \lesssim M_{2,4}(\delta, \nu, \nu^{2a}, \nu^a)^{1/2} \delta^{-\alpha/2-o(1)} \delta^{a\alpha\varepsilon/2}$$
and by an above lemma,
$$M_{2,4}(\delta, \nu, \nu^{2a}, \nu^a) \lesssim \nu^{-O(1)} M_{2,4}(\delta, \nu, \nu^{4a}, \nu^{2a})^{1/2} \delta^{-\alpha/2-o(1)}\delta^{a\alpha\varepsilon/2},$$
or
$$(\delta^\alpha M_{2,4}(\delta, \nu, \nu^{2a}, \nu^a))^{1/a} \lesssim (\delta^\alpha M_{2,4}(\delta, \nu, \nu^{4a}, \nu^{2a}))^{1/2a} \delta^{\alpha\varepsilon/2-O(\varepsilon/a)-o(1)}.$$
Here if $a$ is large then we gain a small power of $\delta^\varepsilon$. If $k \leq -\log_2(4\varepsilon)$ then
$$\delta^\alpha M_{2,4}(\delta, \nu, \nu^2, \nu) \lesssim_k (\delta^\alpha M_{2,4}(\delta, \nu, \nu^{2^{k+1}}, \nu^{2^k}))^{2^{-k}} \delta^{k\alpha\varepsilon}-O(\varepsilon)-o_k(1).$$
Here $o_k(1)$ is a constant that $\to 0$ as $\delta \to 0$ as $k,\varepsilon$ are held constant.
Thus
$$\delta^\alpha M_{2,4}(\delta, \nu, \nu^2, \nu) \lesssim \delta^{k\alpha\varepsilon/2-O(\varepsilon)-o(1)}$$
or
$$D(\delta) \lesssim \delta^{-\alpha+k\varepsilon\alpha/2 - O(\varepsilon)+o(1)}+\delta^{(\varepsilon - 1)\alpha + o(1)}.$$
This gives the desired contradiction.
\end{proof}
This completes the proof of the main theorem.

\chapter{Pseudodifferential calculus}
Let $\Sch$ denote the Schwartz space of $\RR$.
Consider the position and momentum operators $X,D: \Sch \to \Sch$. We normalize them by $Xf(x) = xf(x)$ and $Df(x) = f'(x)/(2\pi i)$.
Previously we have taken physical space and frequency space as separate but isomorphic, with the isomorphism $\RR \to \RR$ sending $X$ to $D$.
But now we will be interested in considering the ``phase space", where we work with position and momentum together.
This should be viewed as analoguous to how in music theory we indicate notes by their place in time, and their frequncies.

However, there is no perfectly rigorous phase space, by the uncertainty principle: we cannot describe a point in phase space arbitrarily well because then it would be a point in physical space, hence is delocalized to frequency space.

\section{The Kohn-Nirenberg quantization}
We are interested in developing a functional calculus for the unbounded operators $X,D$.
This is easy for polynomials; for example, the quantum harmonic oscillator $D^2 + X^2$ is a polynomial in $X,D$. Intuitively this should be associated to the polynomial
$$a(x, \xi) = \xi^2 + x^2,$$
and then we write $a(X, D)$ for the quantum harmonic oscillator.

In general, given some function $a$ of phase space, we let
$$a(X, D)f(x) = \int_{-\infty}^\infty a(x, \xi) \hat f(\xi) e^{2\pi i\xi} ~d\xi$$
be the induced Fourier multiplier. The map $a \mapsto a(X, D)$ is called the \dfn{Kohn-Nirenberg quantization} of the \dfn{symbol} $a$.
This is at first defined for $f \in \Sch$ and
$$\partial_x^j \partial_\xi^\ell a(x, \xi) \lesssim_{a,j} \langle x\rangle^{O_{a,j,\ell}(1)} \langle \xi\rangle^{O_{a,j,\ell}(1)}.$$
More generally, a functional calculus for functions defined on phase space is known as a \dfn{quantization} of phase space.
Most interesting observables from quantum mechanics are in fact given by the Kohn-Nirenberg quantization.

We denote the seminorms of $\Sch$ by
$$||u||_{\alpha,\beta} = \sup_x |x^\alpha \partial^\beta u(x)|.$$
\begin{lemma}
If $a$ satisfies the above estimates then $a(X, D)$ is a bounded operator on $\Sch$.
\end{lemma}
\begin{proof}
Let $f \in \Sch$ and $\alpha,\beta$ be given; we must show that $||a(X, D)f||_{\alpha,\beta}$ is bounded by finitely many Schwartz seminorms of $f$.
By the Leibniz rule,
\begin{align*}
||a(X,D)f||_{\alpha,\beta} &= \sup_x \left|x^\alpha \partial^\beta \int_{-\infty}^\infty a(x, \xi) \hat f(\xi) e^{2\pi ix\xi} ~d\xi\right|\\
&\lesssim_\beta \sup_x \sum_{\gamma \leq \beta} \left|x^\alpha \int_{-\infty}^\infty (\partial_x^\gamma a)(x, \xi) \hat f(\xi) \xi^{\beta - \gamma} e^{2\pi i x\xi} ~d\xi\right|.
\end{align*}
We treat each of these integrals separately. Since everything is Schwartz we can integrate by parts to get, for any $\mu$,
$$\int_{-\infty}^\infty (\partial_x^\gamma a)(x, \xi) \hat f(\xi) \xi^{\beta - \gamma} e^{2\pi i x\xi} ~d\xi
= \frac{(-1)^\mu}{(2\pi ix)^\mu} \int_{-\infty}^\infty \partial_\xi^\mu((\partial_x^\gamma a)(x, \xi) \hat f(\xi) \xi^{\beta - \gamma}) e^{2\pi ix\xi} ~d\xi.$$
Since $\partial_\xi^\nu \partial_x^\gamma a$ is of polynomial growth in $\xi$ for any $\nu \leq \mu$ and $\hat f$ is Schwartz (in fact $f \mapsto \hat f$ is bounded on $\Sch$) we have
$$\left|\int_{-\infty}^\infty \partial_\xi^\mu((\partial_x^\gamma a)(x, \xi) \hat f(\xi) \xi^{\beta - \gamma}) e^{2\pi ix\xi} ~d\xi\right|
\lesssim_{a,\beta,\mu} \sum_{\delta,\delta' \leq C_{\beta,\mu}} ||f||_{\delta,\delta'}.$$
Therefore
$$\left|\int_{-\infty}^\infty (\partial_x^\gamma a)(x, \xi) \hat f(\xi) \xi^{\beta - \gamma} e^{2\pi i x\xi} ~d\xi\right|
\lesssim_{a,\beta,\mu} \langle x\rangle^{-\mu} \sum_{\delta,\delta' \leq C_{\beta,\mu}} ||f||_{\delta,\delta'}.$$
Taking $\mu = \alpha$,
$$||a(X,D)f||_{\alpha,\beta} \lesssim_{a,\alpha,\beta} \sum_{\delta,\delta' \leq C_{\beta,\alpha}} ||f||_{\delta,\delta'}.$$
Since $C_{\beta,\alpha} < \infty$ this is as desired.
\end{proof}

\begin{lemma}
If $a,b$ are symbols such that $a(X, D) = b(X, D)$ then $a = b$.
\end{lemma}
\begin{proof}
If $a(X, D) = b(X, D)$ then for every $f \in \Sch$,
$$\int_{-\infty}^\infty (a(x, \xi) - b(x, \xi))\hat f(\xi)e^{2\pi i x\xi} ~d\xi = 0.$$
In particular this is true when
$$f(\xi) = e^{2\pi i\xi y}\chi(\xi)g(y, \xi)$$
where $\chi$ is a smooth approimation to the indicator function of $[-N, N]$, $y \in \RR$ is to be determined, and $g(y, \xi)$ is a smooth approximation to the function which is $1$ when $a(x,\xi)/b(x,\xi) > 0$ and $-1$ otherwise. Plugging in $y = x$ and taking the limits as the approximations become rough, we have
$$\lim_{N \to \infty} \int_{-N}^N |a(x, \xi) - b(x, \xi)| ~d\xi = 0.$$
But this implies that $a = b$.
\end{proof}

A fundamental defect with any quantization is that it is not an algebra morphism:
$$ab(X, D) \neq a(X, D)b(X, D).$$
This is because $[x, \xi] = 0$ but $2\pi i[X, D] = -1$.
This motivates semiclassical analysis, because in the limit where frequency is very large, $[X, D] \to 0$, and this is formalized by introducing a semiclassical parameter $h$ and taking $h \to 0$.
As a useful consequence of $2\pi i[X, D] = -1$ we prove the Heisenberg uncertainty principle:
\begin{theorem}[Heisenberg uncertainty principle]
\index{Heisenberg uncertainty principle}
If $x,\xi \in \RR$ and $f \in \Sch$, then
$$||(X - x)f||_{L^2}||(D - \xi)f||_{L^2} \geq \frac{||f||_{L^2}^2}{4\pi}.$$
\end{theorem}
\begin{proof}
By the Cauchy-Schwarz inequality we have
$$|\langle [X - x]f, [D - \xi]f\rangle| \leq ||(X - x)f||_{L^2} ||(D - \xi)f||_{L^2}.$$
Since $x,\xi$ commute with everything, $[X - x, D - \xi] = [X, D] = -1/2\pi i$. So
$$|\langle [X - x, D - \xi]f, f\rangle| = \frac{||f||_{L^2}^2}{2\pi}.$$
But also
$$2|\langle [X - x]f, [D - \xi]f\rangle| = |\langle [X - x, D - \xi]f, f\rangle| = \frac{||f||_{L^2}^2}{2\pi}$$
since $X$ is self-adjoint while $D$ is anti-self-adjoint.
\end{proof}
Physically, $||(X-x)f||_{L^2}/||f||_{L^2}$ should be viewed as the variance $\Delta x$ of the observable $X$ when applied to the wavefunction $f$. Similarly for $\Delta \xi$. So the Heisenberg uncertainty principle says
$$(\Delta x)(\Delta \xi) \geq \frac{1}{4\pi}.$$
The intuitive reason for the uncertainty principle is that $f$ is a function of one variable, yet we want to view it as a function of phase space (two variables), yet there is no smooth bijection $\RR \to \RR^2$.

Fortunately, $ab(X, D) \approx a(X, D)b(X, D)$ where $\approx$ means ``equal up to lower order terms" here. For example $[X, D]$ is a zeroth-order operator.
We need certain estimates on the growth of the symbol to make ``lower order terms" a rigorous definition, and then prove the above approximate commutativity relation.

There are other interesting quantizations, but they essentially behave equivalently to the Kohn-Nirenberg quantization, so we restrict to this quantization in what follows.

\begin{definition}
Let $\alpha \in \RR$. A symbol $a$ has \dfn{order} $\alpha$ if it is smooth and
$$\partial_x^j\partial_\xi^\ell a(x, \xi) \lesssim_{a,j,\ell} \langle \xi \rangle^{\alpha - \ell}.$$
We let $S^\alpha$ denote the space of all symbols of order $\alpha$.
In this case we say $a(X, D)$ is known as an \dfn{pseudodifferential operator} of order $\alpha$.
\end{definition}
Thus if $a \in S^\alpha$, then $a(x, \xi)$ is bounded in $x$ and grows like $\xi^\alpha$, even after it is differentiated.
If one tiles phase space by rectangles which have $x$-width $1$ and $\xi$-width $\sim \xi$, then $a$ restricted to any rectangle is approximately constant.
Thus at high frequencies $\xi \to \infty$, the effect of the uncertainty principle is unimportant, since there $a$ is so close to constant that we can localize it quite well.

We let
$$||a||_{\alpha,j,\ell} = \sup_{x,\xi} \frac{\partial_x^j\partial_\xi^\ell a(x, \xi)}{\langle \xi\rangle^{\alpha - \ell}}$$
denote the $(j,\ell)$th Hormander seminorm for symbols of order $\alpha$.
For example, fractional differential operators are pseudodifferential operators.

A smooth linear differential operator is a pseudodifferential operator provided that its coefficients are bounded.
\begin{example}
The quantum harmonic oscillator $D^2 + X^2$ is not a pseudodifferential operator but it is locally a pseudodifferential operator of order $0$.
\end{example}

\section{The Calderon-Vallaincourt theorem}
We start by proving a generalization of the Hormander-Mikhlin multiplier thoerem which shows that pseudodifferential operators of null order are bounded on $L^p$.
The assumption on order is best-possible here; clearly $X,D$ are not bounded on $L^p$ for any $p$, and this remains for fractional operators such as $D^\varepsilon$.
\begin{theorem}[Calderon-Vallaincourt]
Every pseudodifferential operator of order $0$ extends to a bounded operator on $L^2$.
\end{theorem}
Actually, we can use Calderon-Zygmund theory to extend to this to $L^p$: once a Calderon-Zygmund operator is bounded on $L^q$ for some $q$, it is bounded on $L^p$ for every $p$. But we omit the proof.

We will give two proofs of the Calderon-Vallaincourt theorem, both of which use sequences of operators which are ``almost orthogonal."
One way to quantify the extent to which operators are almost orthogonal is if they meet the hypotheses of the Cotlar-Stein lemma:
\begin{lemma}[Cotlar-Stein]
Suppose that $T_1, \dots, T_n: H \to H'$ are linear operators such that the maps $T_i^*T_j: H \to H$ satisfy the estimate
$$\sum_j ||T_i^*T_j||^{1/2} \leq A$$
uniformly in $i$ and similarly the $T_iT_j^*: H' \to H'$ satisfy the estimate
$$\sum_j ||T_iT_j^*||^{1/2} \leq B$$
uniformly in $j$. Then
$$||\sum_j T_j|| \leq \sqrt{AB}.$$
\end{lemma}
\begin{proof}
Since $B(H)$ is a $C^*$-algebra we have
$$||T_i|| = ||T_iT_i^*||^{1/2} \leq A.$$
Similarly $||T_i|| \leq B$ and hence $||T_i|| \leq \sqrt{AB}$, the geometric mean. We want to iterate this estimate.

Let $T = \sum_j T_j$.
Iterating and using the fact that $B(H)$ is a $C^*$-algebra again, we see that
$$||T|| \leq ||(T^*T)^m||^{1/(2m)}.$$
This is in particular true when $m$ is a power of $2$. We have the bound
$$||T|| \leq \sqrt[2m]{ \sum_j ||T^*_{i_1} T_{i_2} \cdots T^*_{i_{2m-1}} T_{i_{2m}}}||.$$
Here the $i_j$ are a substring of some permutation of $n$.
We split this up as
$$||T|| \leq \sqrt[2m]{ \sum_j ||T^*_{i_1} T_{i_2}|| \cdots ||T^*_{i_{2m-1}} T_{i_{2m}}||}.$$
This gives a bound $||T|| \leq n^{1/2m}A$. Similarly we can bound $||T|| \leq n^{1/2m}B$. Taking geometric means we have
$$||T|| \leq n^{1/2m}\sqrt{AB},$$
and iterating we see $||T|| \leq \sqrt{AB}$.
\end{proof}
If the $T_i$ have pairwise orthogonal images then $T_i^*T_j = 0$ whenever $i \neq j$; similarly for the adjoints.
So if $A,B$ are minimal possible (say $A = \sum_j ||T_i||^2$) then the operators $T_i$ are actually orthogonal, and the size of $A$ measures ``how orthogonal" they are.

The Cotlar-Stein lemma also has a useful corollary, which we will not need for the Calderon-Vallaincourt theorem.
\begin{corollary}
Suppose that we have a sequence of operators $T_i: H \to H'$ satisfying the bounds
$$\sum_{j \leq J} ||T_i^*T_j||^{1/2} \leq A$$
uniformly in $i,J$ and similarly
$$\sum_{i \leq I} ||T_iT_j^*||^{1/2} \leq B$$
uniformly in $I,j$. Then the infinite series $T = \sum_j T_j$ converges in the weak operator topology, and
$$||T|| \leq \sqrt{AB}.$$
\end{corollary}
\begin{proof}
The estimate on the infinite series follows from the fact that the estimate is uniformly true on partial sums by the Cotlar-Stein lemma.
Now we must show that if $f \in H, g \in H'$, then
$$\sum_i \langle g, T_if\rangle$$
is a convergent series. Suppose not, so there are $f,g$ such that for every $C > 0$ there is an $I \in \NN$ such that
$$\left|\sum_{i \leq I} \langle g, T_if\rangle\right| > C.$$
This is in particular true when $C = ||f|| ||g|| \sqrt{AB}$, which is a contradiction by the Cotlar-Stein lemma.
\end{proof}
We can actually prove convergence in the strong operator topology, but omit the proof.

Now recall that a symbol of order $0$ is a smooth function $a: \RR^2 \to \RR$ such that $\partial_xa(x,\xi)$ is bounded and $\partial_\xi^\ell a(x,\xi) = O(\xi^{-\ell})$.
Let $a$ be a symbol of order $0$.

We want to run a Littlewood-Paley decomposition on $a$, because these hypotheses imply that $a$ is ``approximately constant" on each of the dyadic pieces of $\RR$.
Let $\phi$ be a bump function on $[-1,1]$ which is $1$ on $[-1/2,1/2]$ and consider the Littlewood-Paley decomposition
$$a = \sum_k a_k$$
where $a_0 = a(x)\phi$ and
$$a_k(x, \xi) = (\phi(\xi/2^k) - \phi(\xi/2^{k+1}))a(x, \xi).$$
To avoid technicalities, we don't want to have to worry about the infinite sum; by Fatou's lemma, we must then show
$$||\sum_{k \leq K} a_k(X, D)||_{L^2} \lesssim_a ||f||_{L^2}$$
uniformly in $K$. Each $a_k$ lives on a strip of $(x, \xi)$ where $\xi \sim 2^k$. Then
$$\partial_x^j \partial_\xi^\ell a_k(x, \xi) \lesssim_{a,j,\ell} 2^{-k\ell}.$$
Therefore
$$K_k(x, y) = \int_{-\infty}^\infty a_k(x, \xi)e^{2\pi i(x-y)\xi}~d\xi$$
has compact support and hence is the integral kernel of $a_k(X, D)$ by Fubini's theorem.

We bound $K_k$. First, $a_k$ is bounded and supported on the interval $[2^k, 2^{k+1}]$ of length $2^k$ so by the triangle inequality,
$$|K_k(x, y)| \leq ||a_k(x)||_{L^1} \lesssim_a 2^k.$$
Integrating by parts in $\xi$,
$$K_k(x, y) = \frac{-1}{2\pi i(x-y)} \int_{-\infty}^\infty \partial_\xi a_k(x,\xi)e^{2\pi i(x-y)\xi}~d\xi \lesssim_a \frac{2^k}{2^k|x-y|}.$$
Iterating and using the previous bound to prevent blowup,
$$|K_k(x, y)| \lesssim_{a,\ell} \frac{2^k}{\langle 2^{-\ell k}|x-y|^\ell}.$$

We now bound $\partial_x K_k(x,y)$. If the derivatives fall on $a_k$ nothing happens. If they fall on the phase, we gain a term $2\pi i\xi$, but $\xi \sim 2^k$, so we lose a factor of $2^k$. Running the above argument again,
$$|\partial_x K_k(x, y)| \lesssim_{a,\ell} \frac{2^{2k}}{\langle 2^{-\ell k}|x-y|^\ell}.$$
The same thing happens for $\partial_y$.
It follows from Young's inequality that
$$||a_k(X, D)||_{L^2 \to L^2} \lesssim_a 1.$$
It remains to remove the dependence on the number of terms in the Fatou sum $K$.
To prove this uniform bound we will show that the $a_k(X, D)$ have ``almost orthogonal" ranges and coranges (i.e. row spaces), in two different ways.

\begin{proof}[First proof]
We claim
$$||a_k(X, D) a_j(X, D)^* f||_{L^2} \lesssim_a 2^{-|j-k|}||f||_{L^2}$$
and similarly for $a_k(X, D)^* a_j(X, D)^* f$. The Cotlar-Stein lemma then gives the theorem.
Assume $j \leq k$ and work with $a_k(X, D) a_j(X, D)^*$; the other three cases are similar.

By Fubini's theorem,
$$K_{kj^*}(x, z)= \int_{-\infty}^\infty \overline{K_k}(y, x)K_j(y, z)~dy$$
is the integral kernel of $a_k(X, D) a_j(X, D)^*$.
We want to bound it using integration by parts.

First,
$$K_j(y, z) = \partial_y \int_{-\infty}^\infty \frac{a_j(y, \xi)}{2\pi i\xi} e^{2\pi i(y-z)\xi} ~d\xi - \int_{-\infty}^\infty \frac{\partial_ya_j(y,\xi)}{2\pi i\xi}e^{2\pi i(y-z)\xi}~d\xi.$$
The second term here is harmless since $a$ is a symbol; we have
$$\int_{-\infty}^\infty \frac{\partial_ya_j(y,\xi)}{2\pi i\xi}e^{2\pi i(y-z)\xi}~d\xi \sim_a 2^{-j}\int_{-\infty}^\infty a_j(y, \xi) e^{2\pi i(y-z)\xi} ~d\xi$$
since we have a $\xi$ in the denominator and are integrating over $[2^j, 2^{j+1}]$.
Thus
$$\int_{-\infty}^\infty \overline{K_k}(y, x) \int_{-\infty}^\infty \frac{\partial_ya_j(y,\xi)}{2\pi i\xi}e^{2\pi i(y-z)\xi}~d\xi \sim 2^{-j+k}.$$
This was desired. Similarly,
$$\int_{-\infty}^\infty \overline{K_k}(y, x)\partial_y \int_{-\infty}^\infty \frac{a_j(y, \xi)}{2\pi i\xi} e^{2\pi i(y-z)\xi} ~d\xi ~dy
= - \int_{-\infty}^\infty \partial_y \overline{K_k}(y, x) \int_{-\infty}^\infty \frac{a_j(y, z)}{2\pi i\xi} e^{2\pi i(y-z)\xi} ~d\xi ~dy \sim 2^{-j + k}.$$
Here we used the fact that we took a complex conjugate to get $\xi$ in the numerator when we differentiated $k$.
\end{proof}

\begin{proof}[Second proof]
Consider the integral kernel
$$L_j(z, x) = \int_{2^j}^{2^{j+1}} e^{2\pi i(z-x)\xi} ~d\xi$$
of the Littlewood-Paley projector $P_j$ to the scale $[2^j, 2^{j+1}]$.
Let $F_{jk}$ be the integral kernel of the composite
\begin{align*}
F_{jk}(z, y) &= \int_{-\infty}^\infty L_j(z, x)K_k(x, y) ~dx\\
&= \int_{-\infty}^\infty \int_{2^k}^{2^{k+1}} \int_{2^j}^{2^{j+1}} a_k(x, \eta) e^{2\pi i(x-y)\eta} e^{2\pi i(z-x)\xi} ~d\xi ~d\eta ~dx.
\end{align*}
We used the Fourier support property of $a_k$.
\begin{lemma}
One has
$$||F_{jk}||_{L^2} \lesssim_a 2^{-|j-k|}.$$
\end{lemma}
\begin{proof}
Note that
$$||F_{jk}||_{L^2}^2 = \iint_{\RR^2} \left|\int_{-\infty}^\infty \int_{2^k}^{2^{k+1}} \int_{2^j}^{2^{j+1}} a_k(x, \eta) e^{2\pi i(x-y)\eta} e^{2\pi i(z-x)\xi} ~d\xi ~d\eta ~dx\right|^2 ~dy ~dz.$$
We now integrate by parts in $dx$ to see
$$\int_{-\infty}^\infty \int_{2^k}^{2^{k+1}}\int_{2^j}^{2^{j+1}} a_k(x, \eta) e^{2\pi i(x-y)\eta} e^{2\pi i(z-x)\xi} ~d\xi ~d\eta ~dx
=  \int_{-\infty}^\infty  \int_{2^k}^{2^{k+1}}\int_{2^j}^{2^{j+1}} \partial_x(a_k(x,\eta)e^{2\pi i(z-x)\xi})\frac{e^{2\pi i(x-y)\eta}}{2\pi i\eta}~d\xi ~d\eta ~dx.$$
We have $\partial_x a_k(x, \eta) \lesssim_a 1$ and $a_k(x, \eta) \lesssim_a 1$. Similarly we have $\eta \sim 2^k$ and $\xi \sim 2^j$, so the triple integral is
$$\lesssim_a \frac{1 + 2^j}{2^k} \int_{-\infty}^\infty \int_{2^k}^{2^{k+1}}\int_{2^j}^{2^{j+1}} e^{2\pi i(z-x)\xi}e^{2\pi i(x-y)\eta} ~d\xi ~d\eta ~dx.$$
This new triple integral is
$$\lesssim_a \int_{-\infty}^\infty \frac{e^{2^{j+k}\pi ix} }{\langle (x-y)(x-z)\rangle} ~dx$$
whose $L^2$ norm is $\lesssim_a 1$. Therefore if $k \geq j$ the $L^2$ norm is $\lesssim_a 2^{-|k-j|}$. The proof is similar when $j \geq k$, but we want to differentiate $e^{2\pi i(x-y)\eta}$ instead.
\end{proof}
We conclude that
$$||P_ja_k(X, D)|| \lesssim_a 2^{-|k-j|}.$$
Similarly for $a_k(X, D)P_j$, where the roles of $\eta$ and $\xi$ in the above proof are swapped.
TODO
\end{proof}

\section{Composition estimates}
\begin{lemma}
Let $a(X, D)$ and $b(X, D)$ be pseudodifferential operators of order $\alpha,\beta$ respectively. Then the composite $a(X,D)b(X,D)$ is a pseudodifferential operator of order $\alpha + \beta$.
\end{lemma}
\begin{definition}
The symbol of the composite $a(X,D)b(X,D)$ is denote $a*b$.
\end{definition}
\begin{proof}[Proof of lemma]
We let
$$a_R(x, \xi) = a(x, \xi)\phi(x/R)\phi(\xi/R)$$
where $\phi$ is a standard bump function; then the $a_R$ obeys the same symbol estimates as $a$ uniformly in $R$, and $a_R \to a$ locally uniformly as $R \to \infty$.
If $f$ is Schwartz, then $b(X,D)f$ is as well, so $a_R(X, D) b(X, D)f$ converges pointwise to $a(X, D)b(X, D)f$.

Suppose that $a_R(X, D) b(X, D) = c_R(X, D)$ is a pseudodifferential operator with order uniform in $R$.
Then the Ascoli theorem guarantees that there is a limit $c(X, D)$ of a subsequence $c_R(X, D)$ as $R \to \infty$, and then $c(X, D)$ is a limit of not just a subsequence but the full sequence. Here we are taking limits in the weak operator topology, which is all we need because we just require that limits be unique, and the weak operator topology is Hausdorff.
By a similar argument, we can replace $b(X, D)$ with $b_R(X, D)$. So we may assume that $a,b$ are compactly supported, and hence justify any use of Fubini's theorem.

We have
$$\widehat{b(X,D)f}(\eta) = \iint_{\RR^2} b(y, \xi)\hat f(\xi)e^{2\pi i(y\xi-y\eta)} ~d\xi~dy$$
hence
$$a(X,D)b(X,D)f(x) = \iiint_{\RR^3} a(x,\eta)b(y,\xi)\hat f(\xi)e^{2\pi i(y\xi-y\eta+x\eta)}~d\xi~dy~d\eta.$$
By Fubini's theorem,
$$a*b(x,\xi) = \iint_{\RR^2} a(x,\eta)b(y,\xi)e^{2\pi i(y-x)(\xi-\eta)}~dy~d\eta.$$

We must now show the symbol estimate
$$\partial_x^j \partial_\xi^\ell (a*b)(x, \xi) \lesssim_{a,b,\alpha,\beta,j,\ell} \langle \xi\rangle^{\alpha + \beta - \ell}.$$
We readily check
$$\partial_x(a*b) = \partial_x * b + a \partial_x b,$$
and similarly in $\xi$. Moreover $\partial_x$ sends $S^\alpha$ to itself and $\partial_\xi$ sends $S^\beta$ to $S^{\beta - 1}$.
So by induction in $j$ and another in $\ell$, we see that we just need to check the case $j = \ell = 0$, i.e.
$$(a*b)(x, \xi) \lesssim_{a,b,\alpha,\beta,j,\ell} \langle \xi \rangle^{\alpha + \beta}.$$
We bound $a*b$ using the method of stationary phase.

Applying a smooth partition of unity to $a$ in the frequency variable, we split $a$ into two functions, one supported on the set of $(x, \eta)$ such that $\langle \xi \rangle \sim \langle \eta \rangle$, and its complement.
This cutoff preserves the symbol estimates for $a$.

We now treat the case $\langle \xi \rangle \sim \langle \eta \rangle$. Let
$$K_x(z) = \int_{-\infty}^\infty a(x, \eta)e^{2\pi ix\eta} ~d\eta,$$
and then we have
$$(a*b)(x, \xi) = \int_{-\infty}^\infty K_x(x - y)b(y, \xi) e^{2\pi i(y-x)\xi } ~dy.$$
Integrating by parts and using our case assumption,
$$K_x(z) \lesssim_{a,\alpha} \langle \xi\rangle^{\alpha + 1} \langle z\xi \rangle^{-2}.$$
Since we have the estimate $b(y, \xi) \lesssim_b \langle \xi \rangle^\beta$, the claim follows.

In the other case,
$$(a*b)(x, \xi) = \iint_{\RR^2} \frac{a(x, \eta)}{(2\pi i(\eta - \xi))^m} \partial_y^m b(y, \xi) e^{2\pi i (y-x)(\xi - \eta)} ~dy~d\eta.$$
This follows by iterated integration by parts. Let
$$K_{x,m}(z) = \int_{-\infty}^\infty\frac{a(x, \eta)}{(2\pi i(\eta - \xi))^m}e^{2\pi iz\eta}~d\eta,$$
so
$$(a*b)(x, \xi) = \int_{-\infty}^\infty K_{x,m}(x-y) \partial_y^m b(y,\xi) e^{2\pi i(y-x)\xi}~dy,$$
and if $m$ is large enough we have
$$K_{x,m}(z) \lesssim_{a,\alpha} \langle \langle \xi\rangle^{\alpha + 1} \langle z\xi \rangle^{-2}$$
as before.
\end{proof}
\begin{example}
If $a(x,\xi) = a(x)$ and similarly for $b$,
$$(a*b)(x, \xi) = a(x)\iint_{\RR^2} b(y)e^{2\pi i(y-x)(\xi-\eta)} ~dy~d\eta = a(x)b(x)$$
by the Fourier inversion formula, as we would hope.

If $a(x, \xi) = a(\xi)$ and similarly for $b$, we similarly have $a*b = ab$.
\end{example}
\begin{theorem}
Let $a \in S^\alpha, b \in S^\beta$. Then $a*b-ab \in S^{\alpha + \beta - 1}$.
\end{theorem}
\begin{proof}
We may again assume that $a,b$ are compactly supported, up to a locally uniform approximation.
Such approximations preserve symbol class.

By the fundamental theorem of calculus,
$$a(x, \eta) = a(x, \xi) + (\eta - \xi)\int_0^1 \partial_2a(x, \xi + t(\eta - \xi)) ~dt.$$
Thus
\begin{align*}
a*b(x, \xi) &= \lim_{R \to \infty} \int_{-R}^R \int_{-\infty}^\infty a(x, \eta) b(y, \xi) e^{2\pi i(y-x)(\xi - \eta)} ~dy ~d\eta\\
&= \int_{-\infty}^\infty \lim_{R \to \infty} \int_{-R}^R b(y, \xi)\left(a(x, \xi) + (\eta - \xi)\int_0^1 \partial_2a(x, \xi + t(\eta - \xi)) ~dt\right)e^{2\pi i(y-x)(\xi - \eta)} ~dy ~d\eta\\
&= \lim_{R \to \infty} \int_{-R}^R \int_{-\infty}^\infty  a(x, \xi) b(y, \xi) e^{2\pi i(y-x)(\xi - \eta)} ~dy~d\eta \\
&\quad+ \iiint_{\RR^2 \times [0, 1]} (\eta - \xi)\partial_2a(x, \xi + t(\eta - \xi))b(y, \xi)e^{2\pi i(y-x)(\xi - \eta)} ~dt~dy~d\eta\\
&= I + J
\end{align*}
We treat the first integral $I$ first. By the Fourier inversion formula,
$$(ab)(x, \xi) = \iint_{\RR^2} a(y, \xi)b(y, \xi) e^{-2\pi i(y-x)\eta} ~dy~d\eta$$
so
\begin{align*}
I - (ab)(x, \xi) &=\lim_{R \to \infty} \int_{-R}^R \int_{-\infty}^\infty  (a(x, \xi)e^{2\pi i(y-x)\xi} - a(y, \xi))b(y, \xi)e^{-2\pi i(y-x)\eta} ~dy ~d\eta\\
&= \int_{-\infty}^\infty (a(x, \xi)e^{2\pi i(y-x)\xi} - a(y, \xi))b(y, \xi) \int_{-\infty}^\infty e^{-2\pi i(y-x)\eta} ~d\eta~dy\\
&= \int_{-\infty}^\infty  (a(x, \xi)e^{2\pi i(y-x)\xi} - a(y, \xi))b(y, \xi) \delta(y - x) ~dy\\
&= 0
\end{align*}
by Fubini's theorem; here $\delta$ is the Dirac mass. Therefore $a*b - ab = J$.

It remains to show that $J \in S^{\alpha + \beta - 1}$, i.e.
$$\partial_x^j \partial_\xi^\ell \iiint_{\RR^2 \times [0, 1]} (\eta - \xi)\partial_2a(x, \xi + t(\eta - \xi)) b(y, \xi) e^{2\pi i(y-x)(\xi - \eta)} ~dt ~dy ~d\eta \lesssim \langle \xi \rangle^{\alpha + \beta - \ell - 1}.$$
By Fubini's theorem,
$$\partial_x^j \partial_\xi^\ell J = \int_0^1 \partial_x^j \partial_\xi^\ell \iint_{\RR^2}(\eta - \xi)\partial_2a(x, \xi + t(\eta - \xi)) b(y, \xi) e^{2\pi i(y-x)(\xi - \eta)} ~dy ~d\eta ~dt.$$
We now treat the inner integral. Letting $\zeta = \eta - \xi$, $\partial_x^j \partial_\xi^\ell$ of the inner integral is
\begin{align*}
&\sim_\ell \partial_x^j \sum_{\ell' \leq \ell} \iint_{\RR^2} \zeta \partial_\xi^{\ell'}(\partial_2a(x, \xi + t\zeta)) \partial_\xi^{\ell - \ell'}b(y, \xi)e^{2\pi i(x-y)\zeta}~dy~d\zeta\\
&= \partial_x^j \sum_{\ell' \leq \ell} \iint_{\RR^2} \zeta \partial_2^{\ell' + 1} a(x, \xi + t\zeta)\partial_2^{\ell - \ell'} b(y, \xi) e^{2\pi i(x-y)\zeta} ~dy~d\zeta\\
&\sim_j \sum_{\substack{j' \leq j\\\ell' \leq \ell}} \iint_{\RR^2} \zeta^{j-j'+1} \partial_1^{j'} \partial_2^{\ell' + 1} a(x, \xi + t\zeta) \partial_2^{\ell - \ell'} b(y, \xi) e^{2\pi i(x-y)\zeta} ~dy ~d\zeta
\end{align*}
and each of these integrals separately is
\begin{align*}
&= \iint_{\RR^2} \zeta \partial_2^{\ell' + 1} a(x, \xi + t\zeta)\partial_2^{\ell - \ell'} b(y, \xi) e^{2\pi i(x-y)\zeta} ~dy~d\zeta\\
&= -\int_{-\infty}^\infty \partial_2^{\ell - \ell'} b(x - z, \xi) \int_{-\infty}^\infty \zeta^{j - j' + 1} \partial_1^{j'} \partial_2^{\ell' + 1} a(x, \xi + t\zeta) e^{2\pi iz\zeta} ~d\zeta ~dz\\
&\sim_m \int_{-\infty}^\infty \partial_1^m \partial_2^{\ell - \ell'} b(x - z, \xi) \int_{-\infty}^\infty \zeta^{j-j'-m-1} \partial_1^{j'}\partial_2^{\ell' + 1} a(x, \xi + t\zeta) e^{2\pi iz\zeta} ~d\zeta ~dz
\end{align*}
for any $m$. Taking $m$ so large that both integrals converge we see that the above integral is bounded by
$$\lesssim_{a,b,j,\ell} \langle \xi \rangle^{\alpha + \beta - j - \ell - 1}$$
which was desired.
\end{proof}

Higher-order versions of this theorem are also true.

\begin{corollary}[quantum correspondence]
\index{quantum correspondence principle}
Let $\{\cdot,\cdot\}$ denote the Poisson bracket and $a, b \in S^\alpha,S^\beta$ respectively. Let $[a, b]$ be the symbol of the commutator $[a(X, D), b(X, D)]$. Then
$$2\pi i[a, b](X, D) - \{a, b\}(X, D) \in S^{\alpha + \beta - 1}.$$
\end{corollary}
\begin{proof}
Let us work modulo $S^{\alpha + \beta - 1}$. Then $\{a, b\} = 0$, and
$$[a, b] = a*b - b*a = ab - ba = 0.$$
In particular, $\{a, b\}$ and $[a, b]$ are in the same coset.
\end{proof}
This suggests that if we view a symbol $a$ as a classical observable, then $a(X, D)$ is its quantization.
In semiclassical analysis we are interested in the extremely high frequency regime, where lower-order symbols are negligible.
The correspondence principle says that in the extremely high frequency regime, classical and quantum mechanics behave identically.

\section{The Gabor transform}
Fix a $\phi \in \Sch$, which is centered at $0$ with little spread, and $||\phi||_{L^2} = 1$.
We are going to use $\phi$ to make an approximate phase portrait for some $f \in \Sch$, i.e. we want to know what the frequencies of $f$ are close to some fixed point $x$.
To do this, we consider $f(\cdot)\overline \phi(\cdot - x)$ to localize $f$ to the point $x$. Taking the inner product with $e^{2\pi i\cdot\xi}$, we recover the frequencies close to $x$.
\begin{definition}
The \dfn{Gabor transform} of $f$ with respect to $\phi$ is
$$T_\phi f(x, \xi) = \int_{-\infty}^\infty f(y) \overline \phi(y - x)e^{-2\pi iy\xi}~dy.$$
\end{definition}
The Gabor transform has many important applications in signal processing and microlocal analysis. In the former case we are mainly interested when $\phi$ is a Gaussian.
By the uncertainty principle, the narrower $\phi$ is, the more information we get about the position and the less localized in frequency we are.
In particular if $\phi$ is the Dirac mass then we get no information about the frequency at any one location as this is just the Fourier transform.
\begin{lemma}
The Gabor transform $T_\phi$ is a linear map $\Sch(\RR) \to \Sch(\RR^2)$.
\end{lemma}
\begin{proof}
Linearity is clear. Now suppose $f \in \Sch(\RR)$; we must show $T_\phi f \in \Sch(\RR^2)$. Indeed,
$$x^{\alpha_1} \xi^{\alpha_2} \partial_x^{\beta_1} \partial_\xi^{\beta_2} T_\phi f(x, \xi)
\sim_{\beta_1} \sum_{\beta_1' \leq \beta_1} x^{\alpha_1} \xi^{\alpha_2} \int_{-\infty}^\infty f(y) \partial_x^{\beta_1'}
\overline \phi(y - x) \partial_x^{\beta_1-\beta_1'} \partial_\xi^{\beta_2} e^{-2\pi iy\xi} ~dy$$
and we will treat each summand separately. Each summand is
\begin{align*}
&\sim_\beta x^{\alpha_1} \xi^{\alpha_2 + \beta_1 - \beta_1'} \int_{-\infty}^\infty f(y)\overline \phi^{(\beta_2)}(y - x) y^{\beta_2} e^{-2\pi iy\xi} ~dy\\
&\sim_\beta \int_{-\infty}^\infty f(y) \overline \phi^{(\beta_2)}(y-x) e^{-2\pi i y\xi} ~dy
\end{align*}
where we integrated by parts to replace powers of $\xi$ with powers of $y$ and then used the fact that $f$ is Schwartz to absorb a polynomial in $y$ into $f(y)$, and the fact that $x \mapsto \overline \phi^{(\beta_2)}(y-x)$ is Schwartz to absorb a polynomial in $x$.
Now
$$|x^{\alpha_1} \xi^{\alpha_2} \partial_x^{\beta_1} \partial_\xi^{\beta_2} T_\phi f(x, \xi)| \lesssim_{\alpha,\beta,\phi,f} \int_{-\infty}^\infty |f(y)\overline \phi^{(\beta_2)}(y-x)| ~dy \leq ||f\overline \phi^{(\beta_2)}||_{L^1(\RR)}$$
which is finite since $f\overline \phi^{(\beta_2)}$ is Schwartz.
\end{proof}
\begin{lemma}
The operator
$$T_\phi^*F(y) = \iint_{\RR^2} F(x, \xi)\phi(y - x)e^{2\pi iy\xi}~dx~d\xi$$
is a linear map $\Sch(\RR^2) \to \Sch(\RR)$ which is the adjoint to $T_\phi$ in the sense that $\langle T_\phi f, F\rangle = \langle f, T_\phi F\rangle$ for every $f \in \Sch(\RR)$ and $F \in \Sch(\RR^2)$.
\end{lemma}
\begin{proof}
Again linearity is clear. We now check that $T_\phi^*$ sends Schwartz functions to Schwartz functions. If $F \in \Sch(\RR^2)$, we have
$$y^\alpha \partial_y^\beta T_\phi^* F(y) = \iint_{\RR^2} F(x, \xi) e^{2\pi ix\xi} y^\alpha \partial_y^\beta \phi(y - x) ~dx ~d\xi$$
and as $\phi$ is Schwartz it can absorb the operator $y^\alpha \partial_y^\beta$. Then
$$|y^\alpha \partial_y^\beta T_\phi^* F(y)| \lesssim_{\alpha, \beta} \int_{-\infty}^\infty |\phi(y - x)| \int_{-\infty}^\infty |F(x, \xi)| ~d\xi ~dx.$$
Since $F$ is Schwartz, $x \mapsto ||F(x, \cdot)||_{L^1}$ is Schwartz, and thus the outer integral is bounded.

Now we check the adjoint property. We have
\begin{align*}\langle T_\phi f, F\rangle &= \iiint_{\RR^3} f(y) \overline \phi(y - x) e^{-2\pi iy\xi} \overline{F(x, \xi)} ~dy ~dx ~d\xi\\
&= \iiint_{\RR^3} f(x) \overline{F(x, \xi) \phi(y - x) e^{2\pi iy\xi}} ~dy ~d\xi ~dx\\
&= \langle f, T_\phi^*F\rangle
\end{align*}
which was promised.
\end{proof}
\begin{lemma}
For every $f \in \Sch(\RR)$, $T_\phi^* T_\phi f = f$.
\end{lemma}
\begin{proof}
One has
\begin{align*}
T_\phi^* T_\phi f &= \iiint_{\RR^3} f(y) \overline \phi(y - x) \phi(z - x) e^{2\pi i(z - y)\xi} ~dy ~dx ~d\xi\\
&= \iint_{\RR^2} f(y) \overline \phi(y - x) \phi(z - x) \int_{-\infty}^\infty e^{2\pi i(z - y)\xi} ~d\xi ~dy ~dx\\
&= \iint_{\RR^2} f(y) \overline \phi(y - x) \phi(z - x) \delta(z - y) ~dy ~dx\\
&= f(z) \int_{-\infty}^\infty |\phi(z - x)|^2 ~dx\\
&= f(z)
\end{align*}
since $||\phi||_{L^2} = 1$.
\end{proof}
\begin{theorem}
The Gabor transform $T_\phi$ extends to a linear isometry $L^2(\RR) \to L^2(\RR^2)$.
\end{theorem}
\begin{proof}
$T_\phi$ is one-sided unitary by the above two lemmata, hence an isometry in $L^2$. Since Schwartz functions are dense we are done.
\end{proof}

We now show that pseudodifferential operators act as ``approximate multipliers" on phase space.
\begin{definition}
The \dfn{Kohn-Nirenberg-Wigner distribution} is
$$W_\phi(x, \xi) = \phi(x)\overline{\hat \phi(\xi)}e^{-2\pi ix\xi}.$$
\end{definition}
So $W_\phi$ is an approximation to the convolution identity.
\begin{theorem}
For every compactly supported symbol $a$ and $f \in \Sch(\RR)$,
$$T_\phi^*(a(T_\phi f)) = (a * W_\phi)(X, D)f.$$
\end{theorem}
\begin{proof}
One has
$$(a*W_\phi)(x, \xi) = \iint_{\RR^2} a(y, \eta) \phi(x - y)\overline{\hat \phi(\xi - \eta)} e^{-2\pi i(x-y)(\xi - \eta)} ~dy~d\eta.$$
Therefore
$$(a*W_\phi)(X, D)f(z) = \iiiint_{\RR^4} a(y, \eta) \phi(z - y) \overline{\hat \phi(\xi - \eta)} e^{-2\pi i(z-y)(\xi - \eta)} f(x)e^{2\pi i(z - x)\xi} ~dx ~d\xi ~dy ~d\eta.$$
Meanwhile,
$$T_\phi^*(aT_\phi f)(z) = \iiint_{\RR^3} a(x, \xi) f(y) \overline \phi(y - x) \phi(z - x) e^{2\pi i(z - y) \xi}~d\xi ~dy ~dx.$$
These are equivalent by the Fourier inversion formula.
\end{proof}


\chapter{Almost pointwise convergence of Fourier series}
In this chapter, let $T = \RR/\ZZ$ and let $f \in L^1(T)$. Recall that its Fourier coefficients are given by
$$\hat f(n) = \int_T f(x)e^{-2\pi inx} ~dx.$$
One of the oldest questions in harmonic analysis is when the Fourier inversion formula
$$f(x) = \sum_{n \in \ZZ} \hat f(n) e^{2\pi inx}$$
is valid. This holds uniformly and absolutely if $f \in C^\infty(T)$. Now consider the partial summation operators
$$S_Nf(x) = \sum_{|n| \leq N} \hat f(n) e^{2\pi inx}.$$
If $f \notin C^\infty(T)$, then it must be false that $S_Nf \to f$ uniformly, for the $S_Nf$ are smooth, but one might hope that they converge to $f$ in some weaker sense.
Lusin conjectured in 1913 that for every $p \in [1, \infty]$ and every $f \in L^p(T)$, we have $S_Nf \to f$ almost pointwise.
Kolmogorov proved in 1916 that this is false when $p = 1$; Carleson proved in the 1960s that it is true when $p \geq 2$; and Hunt proved that it is true when $p > 1$ by modifying Carleson's argument.
\begin{definition}
The operator $S_N$ is known as the \dfn{Dirichlet summation operator}.
\end{definition}

The reason why Lusin's problem is so phenomenally hard to solve is that any decomposition of phase space used to prove almost pointwise convergence must necessarily be invariant under modulation $\hat f \mapsto (\xi \mapsto \hat f(\xi - \xi_0)$ by the frequency $\xi_0$.
But the Littlewood-Paley decomposition and the rising sun decomposition both privilege the frequency $0$, so are not invariant under modulation, so we must develop a much stronger decomposition of phase space which respects the action of the metaplectic group, as in the theory of the Gabor transform.

\section{Convergence in $L^p$}
We first show a much easier result: that at least the Dirichlet summation operators $S_N$ converge in (the strong operator topology of) $L^p$ to the identity.
\begin{theorem}
Suppose that $f \in L^p(T)$ and $p \in (1, \infty)$. Then $S_Nf \to f$ in the topology of $L^p(T)$.
\end{theorem}
To begin the proof, we first check that the $S_N$ are uniformly bounded on $L^p(T)$, but to do this we need to study a variant of the Hilbert transform adapted to periodic functions.

To do this, let
$$P_r(\theta) = \sum_{n \in \ZZ} r^{|n|}e^{2\pi in\theta}$$
be the Poisson kernel adapted to the disc $D_r$ of radius $r$ in $\CC$.
Given a harmonic function $g \in C^2(D_r)$ (so $\Delta g = 0$), let $\tilde g$ be its harmonic conjugate such that $\tilde g(0) = 0$.
\begin{definition}
The \dfn{Hilbert transform} on the unit disc is defined for smooth functions $f \in C^\infty(T)$ by
$$Hf(x) = \lim_{r \to 1^-} (\widetilde{P_r*f})(\theta).$$
\end{definition}
If $f$ is already harmonic then it is clear that $Hf$ exists, and in fact $Hf = \tilde f$.
But this is in particular true if $f$ is a polynomial, by complex analysis.
\begin{lemma}
If $n \neq 0$ then
$$\widehat{\tilde f}(n) = -i \sgn n \hat f(n).$$
\end{lemma}
\begin{proof}
If $f$ is constant then $\tilde f = 0$ and this is clear. If $f$ is holomorphic then $\tilde f = -if$ modulo constant functions and this is similarly clear. If $f$ is antiholomorphic, or a linear combination of the above, then taking complex conjugates and linear combinations we complete the proof.
\end{proof}
In particular, the Plancherel formula gives
$$||\tilde f||_2^2 = ||f||_2^2 - |f(0)|^2 \leq ||f||_2^2,$$
so the Hilbert transform satisfies the bound
$$||Hf||_2 \leq ||\tilde u_f||_2 \leq ||u_f||_2 \leq ||f||_2.$$
since the Poisson kernel is bounded on $L^2$. So $H$ extends to a bounded operator on $L^2$.
One can similarly check that $H$ is a bounded linear mapping $L^1 \to L^{1,\infty}$

\begin{lemma}
If $p \in (1, \infty)$ then the Hilbert transform $H$ is bounded $L^p \to L^p$.
\end{lemma}
\begin{proof}
By the above, and an interpolation, $H$ is bounded if $1 < p \leq 2$.
We have $H^* = -H$, and by another interpolation, $H^*$ is bounded if $2 \leq p < \infty$. So $H$ is bounded.
\end{proof}
We therefore may define the bounded operator $T: L^p(T) \to L^p(T)$ by
$$Tf = \frac{f}{2} + \frac{i}{2}Hf - \frac{\hat f(0)}{2}.$$
But
$$\widehat{Hf}(n) = -i\sgn n\hat f(n),$$
so
$$\widehat{Tf}(n) = \chi_{[1, \infty)} \hat f(n).$$

\begin{lemma}
For every $f \in L^p(T)$ and $N$ one has $||S_Nf||_p \leq ||f||_p$.
\end{lemma}
\begin{proof}
We have
$$S_Nf(x) = \sum_{n \in \ZZ} \chi_{[-N, N]}(x) \hat f(n) e^{2\pi inx} = e^{-2\pi i(N+1)x}T(e^{2\pi i(N+1)\cdot }f)(x) - e^{2\pi iNx}T(e^{-2\pi iN\cdot}f)(x)$$
so
$$||S_Nf||_p \leq 2 ||T||_p ||f||_p.$$
\end{proof}
We now prove the theorem. The $S_Nf$ are uniformly bounded in $L^p$, say $||S_Nf|| \leq 1$. On the other hand, if $g$ is a trigonometric polynomial,
$$\limsup_{N \to \infty} ||S_Nf - f||_p \leq ||S_Nf - S_Ng||_p + ||g - f||_p + ||S_Ng - g||_p.$$
Now $S_Ng = g$ if $N$ is larger than the degree of $g$, so
$$\limsup_{N \to \infty} ||S_Nf - f||_p \leq \inf_g \sup_N ||S_N||_p||f - g||_p + ||f - g||_p = 0.$$
where the $\inf$ is taken over all trigonometric polynomials $g$, which are dense in $L^p(T)$ by the Stone-Weierstrass theorem.

We now prove the converse of the above theorem.
\begin{theorem}
If $p = 1$ or $p = \infty$, then there is an $f \in L^p(T)$ such that $S_Nf$ is unbounded in $L^p(T)$ as $N \to \infty$.
\end{theorem}
\begin{proof}
To prove this, it suffices to show that the $S_N$ are not uniformly bounded in $L^p$ operator norm.
If this is true, then by the Baire category theorem via the uniform boundedness principle, the $S_Nf$ cannot be uniformly bounded.

The $S_N$ are convolution operators, say
$$S_Nf = f * D_N$$
where
$$D_N(x) = \sum_{|n| \leq N} e^{2\pi inx}$$
is the \dfn{Dirichlet kernel}. But the $D_N$ are unbounded in $L^1$ and in $L^\infty$, so by the converse to Young's inequality (which is true in $L^1$ but in the other $L^p$'s), $S_N$ blows up in $L^1$.

The adjoint of a convolution operator is convolution with the reflected complex conjugate of the kernel. So the adjoint $S_N^*: L^1 \to L^1$ blows up in $L^1$, so $S_N: L^\infty \to L^\infty$ blows up too.
\end{proof}

\section{Equivalences to almost pointwise convergence}
Recall that the $L^{p,\infty}$ norm is defined by
$$||F||_{p,\infty} = \sup_{\lambda > 0} \lambda|\{x: |F(x)| \geq \lambda\}|^{1/p}.$$
Here $|\cdot|$ denotes Lebesgue measure.
Let $P_Nf$ denote the truncated Fourier series
$$P_Nf = \sum_{n \leq N} \hat f(n) e^{2\pi inx}.$$
Let $1_{D \leq N}$ denote the Fourier multiplier $\mathcal F^{-1}1_{\xi \leq N} \mathcal F$.


\begin{theorem}
Suppose $p \leq 2$. Then the following are equivalent:
\begin{enumerate}
\item For every $f \in L^p(T)$, $S_Nf \to f$ almost pointwise.
\item There is no $f \in L^p(T)$ such that $\sup_N |S_Nf| = \infty$ almost everywhere.
\item For every $f \in C^\infty(T)$,
$$||\sup_N |S_Nf| ||_{p,\infty} \lesssim_p ||f||_p.$$
\item For every $f \in C^\infty(T)$,
$$||\sup_N |P_Nf| ||_{p,\infty} \lesssim_p ||f||_p.$$
\item For every $f \in \Sch$,
$$||\sup_N |1_{D \leq N}f|||_{p,\infty} \lesssim_p ||f||_p.$$
\end{enumerate}
\end{theorem}
\begin{proof}[Proof that 3 implies 1]
By hypothesis, for every $f \in C^\infty(T)$ and $N_0$,
$$||\sup_{0 \leq N \leq N_0} |S_Nf|||_{p,\infty} \lesssim_p ||f||_p.$$
Approximating a function in $L^p(T)$ by a function in $C^\infty(T)$ we see that the above inequality holds with the assumption $f \in C^\infty(T)$ dropped.
By Fatou's lemma in the limit $N_0 \to \infty$ we see that the hypothesis actually holds for every $f \in L^p(T)$, rather than just every $f \in C^\infty(T)$.

By the triangle inequality, for every $f \in L^p(T)$,
$$||\limsup_{N \to \infty} |S_Nf - f|||_{p, \infty} \lesssim_p ||f||_p,$$
but if $f \in C^\infty(T)$, then $S_Nf - f \to 0$ uniformly, hence in $L^\infty$, hence in $L^p$, hence in $L^{p, \infty}$.
By dominated convergence, the above triangle inequality implies that we can approximate $f$ by a function in $C^\infty(T)$ even if $f \notin C^\infty(T)$ and conclude that $S_Nf - f \to 0$, which was to be shown.
\end{proof}
That 1 implies 2 is obvious. So we are almost ready to show that 1, 2, and 3 are equivalent, but to do that we need an inequality due to Paley and Zygmund.
\begin{lemma}[Paley-Zygmund]
\index{Paley-Zygmund inequality}
Let $Z$ be a random variable and $\theta \in [0, 1]$. If the standard deviation of $Z$ is finite then
$$\Pr(Z > \theta \Expect Z) \geq (1 - \theta)^2 \frac{(\Expect Z)^2}{\Expect(Z^2)}.$$
\end{lemma}
\begin{proof}
We have
$$\Expect Z = \Expect(Z1_{Z \leq \theta \Expect Z}) + \Expect(Z1_{Z > \theta \Expect Z}).$$
The first term is $\leq \theta \Expect Z$; the second is an $L^2$ inner product, so by the Cauchy-Schwarz inequality,
$$\Expect(Z 1_{Z > \theta \Expect Z}) \leq \sqrt{\Expect(Z^2) \Pr(Z > \theta \Expect Z)}.$$
Thus
$$(1 - \theta) \Expect Z \leq \sqrt{\Expect(Z^2) \Pr(Z > \theta \Expect Z)}.$$
Squaring both sides and dividing by $\Expect(Z^2)$, which is legal since the second moment of $Z$ is finite (since its square root is the standard deviation) we see the claim.
\end{proof}

\begin{proof}[Proof that 2 implies 3]
Suppose that 3 fails.
Then for any $A > 0$ there is an $f \in L^p(T)$, $E \subseteq T$ measurable, $N_0 \in \NN$ and $\lambda > 0$ such that
$$\sup_{0 \leq N \leq N_0} |S_Nf| \geq \lambda$$
on $E$, and $\lambda |E|^{1/p} \geq A||f||_p$. Up to a rescaling we can assume $\lambda = 1$.

Let $n \geq 1$ be the integer part of $1/|E|$. Then there are translations $E + x_1, \dots, E + x_n$ whose union has measure close to $1$.
To see this, we choose the $x_i$ uniformly and independently at random; the probability that some $x$ satisfies $x \in E + x_i$ is $|E|$, so the expected value of the measure of $\bigcup_i E + x_i$ is $1 - (1 - |E|)^n$. Choosing deterministic $x_i$ so that
$$\left|\bigcup_i E + x_i\right| \geq 1 - (1 - |E|)^n,$$
and using $|n| \sim 1/|E|$ we see the claim.

Let $\epsilon_i$ be Bernoulli signs, say
$$\tilde f(x) = \sum_i \epsilon_i f(x - x_i),$$
so by Khinchine's inequality, since $p \leq 2$,
$$\Expect ||\tilde f||_p^p \sim_p ||\sqrt{\sum_i |f(\cdot - x_i)|^2}||_p^p \leq ||\sqrt[p]{\sum_i |f(\cdot - x_i)|^p}||_p^p = \sum_i ||f(\cdot - x_i)||_p^p.$$
Hence $\Expect ||\tilde f||_p^p \lesssim_p n ||f||_p^p$. In particular,
$$\Expect ||\tilde f||_p^p \lesssim_p A^{-p}.$$

Since $S_N$ is a convolution operator, it commutes with translations, so
$$S_N \tilde f(x) = \sum_i \epsilon_i S_Nf(x - x_i).$$
But by definition of $\lambda = 1$, we have
$$\sup_i \sup_{0 \leq N \leq N_0} |S_Nf(x - x_i)| \geq 1.$$
Thus there is an $N_x$ such that
$$\sup_i |S_{N_x}f(x - x_i)| \geq 1.$$
In particular,
$$Q_x = \sqrt{\sum_i |S_{N_x}f(x - x_i)|^2} \geq 1.$$
So the $q$th moment of $x \mapsto S_{N_x}f(x - x_i)$ is $Q_x$, so by the Paley-Zygmund inequality,
$$\Pr(|S_{N_x}\tilde f(x)| \gtrsim Q_x) \gtrsim 1.$$
Thus
$$\Pr(|S_{N_x}\tilde f(x)| \gtrsim 1) \gtrsim 1.$$
Therefore
$$\Expect|\{\sup_N |S_N\tilde f(x)| \gtrsim 1\}| \gtrsim 1,$$
hence
$$1 \geq \Expect|\{\sup_N |S_N \tilde f(x)| \gtrsim 1\}| \gtrsim 1 + A^p\Expect||\tilde f||_p^p$$
since the new term is $\lesssim_p A^{-p}$ and hence is small.
We choose the signs $\epsilon_i$ deterministically and run the heat flow to find a \emph{smooth} function $f_A$ such that
$||f_A||_p \lesssim_p A^{-1}$, an $N_A$, and a Borel $E_A$ such that $|E_A| \sim_p 1$ and
$$\sup_{0 \leq N \leq N_A} |S_Nf_A(x)| \gtrsim 1,$$
for every $x$.

Iterating (taking $A$ large enough based on the previous choices), we find a sequence of $f^m \in C^\infty(T)$, $N^m$, and $E^m$ such that $||f^m||_p \leq 2^{-m}$, $|E^m| \gtrsim_p 1$,
$$\sup_{0 \leq N \leq N^m} |S_Nf^m(x)| \geq m + \sum_{m' < m} \sup_N ||S_Nf^{m'}||_\infty,$$
and if $m' < m$ then
$$\sup_{0 \leq N \leq N^{m'}} ||S_Nf^m||_\infty \leq 2^{-m}.$$
By randomly translating the $E^m$ and applying the Borel-Cantelli lemma, almost surely, almost every $x$ will lie in infinitely many $E^m$.
Assume this is the case.

Let $f = \sum_m f^m$. Then $f \in L^p(T)$, and by the Borel-Cantelli assumption and the triangle inequality for almost every $x$ there are infinitely many $m$ such that
$$\sup_{0 \leq N \leq N^m} |S_Nf(x)| \geq m - \sum_{m' > m} 2^{-m'} \geq m - 1.$$
Therefore
$$\sup_N |S_Nf(x)| = \infty,$$
contradicting 2.
\end{proof}

\begin{proof}[Proof that 3 and 4 are equivalent]
We have
$$S_N = P_N - P_{-N-1}$$
so the triangle inequality implies that 4 implies 3. So suppose 3.

Let $e_M(x) = e^{2\pi iMx}$, so $||e_Mf||_p = ||f||_p$, hence
$$||\sup_{N \geq 0} |P_N(e_Mf) - P_{-N-1}(e_Mf)|||_{p, \infty} \lesssim_p ||f||_p.$$
Modulating by $M$,
$$||\sup_{N \geq 0} |P_{N-M}f - P_{-N-M-1}f||_{p, \infty} \lesssim_p ||f||_p$$
so
$$||\sup_{N \geq -M} |P_Nf - P_{-N-2M-1}f||_{p, \infty} \lesssim_p ||f||_p.$$
Choosing $N_0 < M$ we have
$$\sup_{|N| \leq N_0} |P_Nf - P_{-N-2M-1}f||_{p, \infty} \lesssim_p ||f||_p$$
but the $P_{-N-2M-1}f \to 0$ rapidly and uniformly as $M \to \infty$ so we can take $M \to \infty$ and then $N_0 \to \infty$.
\end{proof}

\begin{proof}[Proof that 4 implies 5]
Let $K > 0$, suppose without loss of generality that $f$ is compactly supported, say on $[-A, A]$, and let
$$f_K(x) = \sum_{n \in \ZZ} f(K(x - n))$$
where $x \in T$ is taken $\mod 1$.
If $K$ is large then $f_K$ is smooth and supported on $[-A/K, A/K] \mod 1$. Besides
$$||f_K||_p = K^{-1/p} ||f||_p.$$
Moreover,
$$\widehat{f_K}(n) = K^{-1}\hat f(Kn).$$
Therefore
$$P_Nf_K(x) = K^{-1}\sum_{n \leq N} \hat f(Kn)e^{2\pi inx}.$$
Notice that $P_Nf_K(x)$ looks like the integral
$$\int_{-\infty}^N \hat f(\xi) e^{2\pi ix\xi} ~d\xi = 1_{D \leq N} f.$$
We just need to make this limiting argument rigorous.

By assumption
$$|\{x \in [-1/2, 1/2]: \sup_{N \in \ZZ} K^{-1}|\sum_{n \leq N} \hat f(Kn)e^{2\pi inx}| \geq \lambda\}| \lesssim_p \lambda^{-p} ||f||_p^p.$$
We can replace this supremum with a supremum over $\RR$ without changing the summation $n \leq N$. We rescale by $K$, and then for every compact intervals $I, J$,
$$|\{x \in I: \sup_{N \in J} K^{-1} |\sum_{\substack{\xi \in K^{-1}\ZZ\\\xi \leq N}} \hat f(\xi)e^{2\pi ix\xi}| \geq \lambda\}| \lesssim_p \lambda^{-p}||f||_p^p.$$
We can now take limits as $K \to \infty$ to get the desired integration formula and estimate.
\end{proof}

\begin{proof}[Proof that 5 implies 4]
It suffices to check 4 for all trigonometric polynomials, by the Stone-Weierstrass theorem.
So let $f$ be a trigonometric polynomials, so the Fourier transform of $f$ has finite support.

Let $\eta$ be a Schwartz function with Fourier support in $[-1, 1]$, and let
$$f_R(x) = f(x \mod 1)\eta(x/R).$$
Then as $R \to \infty$ we have
$$||f_R||_p \sim_{p, \eta} R^{1/p} ||f||_p.$$
Moreover,
$$\widehat{f_R}(x) = R \sum_{n=-A}^A \hat f(n) \hat \eta(R(\xi - n)).$$
Hence
$$\eta(x/R) \sup_N |P_Nf(x \mod 1)| \leq \sup_N 1_{D \leq N}(D) f_R(x)$$
which implies that 5 implies 4.
\end{proof}

The significance of the operators $P_N$ and similarly $1_{D \leq N}$ is that they are translation-invariant, which is especially important when viewing $1_{D \leq N}$ as an operator on $\RR$. Moreover $1_{D \leq N}$ obeys scaling symmetry,

\section{Kolmogorov's theorem}
\begin{theorem}
There is a $f \in L^1(T)$ such that $S_Nf \not \to f$ almost pointwise.
\end{theorem}
\begin{proof}
In view of the previous section it suffices to show that
$$f \mapsto \sup_N |1_{D \leq N}f|$$
is not weakly $(1, 1)$.
Let $H = -\pi i \sgn D$ be the Hilbert transform,
$$Hf(x) = \int_{-\infty}^\infty \frac{f(y)}{x - y}~dy$$
where the integral is meant in the sense of Cauchy principal value. Then
$$1_{D \leq N}f(x) = \frac{f(x)}{2} + \frac{1}{2\pi i}\int_{-\infty}^\infty \frac{f(y)}{x - y}e^{2\pi iN(x-y)}~dy$$
so it suffices to show that the \dfn{Carleson operator}
$$Cf(x) = \sup_N \left|\frac{1}{2\pi i}\int_{-\infty}^\infty \frac{f(y)}{x - y}e^{2\pi iN(x-y)}~dy\right|$$
is not weakly $(1, 1)$.

Note that
$$Cf(x) \leq \int_{-\infty}^\infty \frac{|f(y)|}{|x - y|}~dy$$
so we must strongly use the fact that $|x|^{-1}$ is not $L^1$. In fact $Cf$ will just barely diverge, because we are taking a supremum, and so may choose $N$ so that the oscillation in the Carleson operator does not ``matter."

Let $n$ be a large natural number and take
$$1 = N_0 < N_1 < \cdots < N_n$$
be such that $N_i$ is a natural number and $N_{i+1}/N_i$ is very large.
Let $\varphi$ be a smooth cutoff, $||\varphi||_1 = 1$, supported on $[-1, 1]$, and let
$$f(x) = \sum_{j=1}^n N_j \varphi(N_j(x-j)).$$
(So $f$ is an approximation to a sum of Dirac masses, which become much steeper as $j$ grows.)
Thus $||f||_1 = n$.

Let $j_0 \in [n/3, 2n/3]$ be a natural number, $\delta > 0$ small, and estimate $Cf(x)$ for $x \in [j_0 + \delta, j_0 + 1 -\delta]$.
Now
$$Cf(x) \geq \left|\int_{-\infty}^\infty \frac{f(y)}{x - y}e^{2\pi iN_{j_0}(x - y)}~dy\right|.$$
If $n$ is large enough depending on $\delta$, then $j_0$ is also large and the support of $f$ near $j_0$ is very skinny, so $f(x) = 0$.
Thus this integral is not actually a principal value. Plugging in the definition of $f$,
$$Cf(x) \geq |\sum_{j=1}^n \int_{-\infty}^\infty \frac{\varphi(t)}{x - j - N_j^{-1}t}e^{2\pi iN_{j_0}t/N_j} ~dt$$
where we used $e^{-2\pi iN_0j} = 1$ since $N_0 \in \NN$.

Since the $N_i$ grow like a geometric series we can sum them. If $j \leq j_0$, then we can integrate by parts to get
$$\int_{-\infty}^\infty \frac{\varphi(t)}{x - j- N_j^{-1}t}\exp(2\pi iN_{j_0}t/N_j)~dt \lesssim_\varphi \frac{N_j}{N_{j_0}}$$
and then sum to get the sum $j \leq j_0$ to be bounded by $1$.
Meanwhile if $j > j_0$ then $\exp(2\pi itN_{j_0}/N_j)$ is almost constant, so
$$\sum_{j=1}^n \int_{-\infty}^\infty \frac{\varphi(t)}{x - j - N_j^{-1}t}\exp(2\pi itN_{j_0}N_j) ~dt = \log n + O_\varphi(1).$$
Thus as $n \to \infty$,
$$|\{x : 2Cf(x) \geq \log n\}| \gtrsim n$$
so $||Cf||_{1, \infty} \gtrsim n \log n$,
yet $||f||_1 = n$, which implies that $C$ is not weakly $(1, 1)$.
\end{proof}

\section{Averaged convergence in $L^1$}
We now show that at least we have convergence in $L^1$ on average.

\begin{definition}
The \dfn{Fej\`er summation operator} is
$$F_N = \frac{1}{N+1}\sum_{N'=0}^N S_{N'}.$$
\end{definition}
A common way to show that a sequence in $L^1$ converges almost pointwise is to use a Hardy-Littlewood estimate.
\begin{definition}
The \dfn{Hardy-Littlewood maximal function} of a function $f \in L^1(T)$ is
$$Mf(x) = \sup_{r > 0} \frac{1}{2r} \int_{x-r}^{x+r} |f(y)| ~dy.$$
\end{definition}
We let
$$A_rf(x) = \frac{1}{2r} \int_{x-r}^{x+r} |f(y)| ~dy$$
be the averaging operator, so $Mf = \sup_r A_rf$.
\begin{theorem}[Hardy-Littlewood]
  \index{Hardy-Littlewood inequality}
The Hardy-Littlewood maximal operator $M$ is weakly $(1, 1)$.
\end{theorem}
\begin{proof}
We must show that for every $f \in L^1$ and $r > 0$ that
$$|\{\sup_r |A_r f| \geq 1\}| \lesssim ||f||.$$
But we can restrict to $f$ a continuous, nonnegative, compactly supported function and $r \in \{0, 1, \dots, R\}$ for some $R$ since $r \mapsto A_r$ is strong operator continuous and we can use monotone convergence. Then
$$E = \{\sup_r |A_r f| \geq 1\}$$
is compact. For every $x \in E$ there is a $r(x) > 0$ such that
$$|B(x, r(x))| < \int_{B(x, r(x))} f(y) ~dy.$$
We want to show
$$|E| \lesssim \int_{-\infty}^\infty f(y) ~dy$$
which would follow by summing the previous estimate if the balls were disjoint.

We choose finitely many $B(x_i, r(x_i))$ to cover $E$, and run the Vitali covering algorithm to choose $B(x_i', r(x_i'))$ from that cover which are disjoint such that
$$|B(x_i', r(x_i'))| \gtrsim |E|.$$
We now can sum, at the price of the implied constant that we lost when we ran the Vitali covering algorithm.
\end{proof}
\begin{lemma}
For every $f \in L^1(T)$,
$$\sup_{N \geq 1} |F_Nf(x)| \lesssim Mf(x).$$
\end{lemma}
\begin{proof}
The convolution kernel of $F_N$ is
$$K_N(x) = \frac{\sin^2(Nx/2)}{N\sin^2(x/2)}.$$
This follows by trig identity bashing.
If $|x| < \pi/2$ (say) then $\sin^2(x/2) \sim x^2$, and otherwise $\sin^2(x/2) \sim 1$.
Thus $K_N$ is nonnegative, and is bounded uniformly in $L^1(T)$:
\begin{align*}||K_N||_1 &\sim \int_{-\pi/2}^{\pi/2} \frac{\sin^2(Nx/2)}{N(x/2)^2} ~dx + 2\int_{\pi/2}^\pi \sin^2(Nx/2)~dx \\
  &\sim 4\int_0^{N\pi/2} \frac{\sin \theta}{\theta}~d\theta + \pi \\
  &\leq 8
\end{align*}
if $N$ is large enough.

Now $\sin^2(Nx/2)$ has a period of $2\pi/N$, with zeroes at $\pm 2k\pi/N$ for each $k$. In particular it has $\sim N$ zeroes on $[-\pi, \pi)$.
We do not consider $0$ to be a zero of $\sin^2(Nx/2)$ since it is a zero of $1/x^2$.
Write
$$K_N(x) = \sum_{n \lesssim N} w_{n,N}(x)$$
where $w_{n,N}$ is $K_N$ cut off to be between its $n$th and $n+1$th zeroes, and we take $w_{0,N}$ to be supported close to $0$.
Thus $w_{n,N}$ is a rescaled, translated approximate delta function of width $\sim 1/N$,
$$\sum_{n \lesssim N} ||w_{n,N}||_1 \leq 8.$$
Thus $w_{n,N} * f \sim \Trans_{y_{n,N}} f/||w_{n,N}||_1$ where $y_{n,N}$ is the center of the support of $w_{n,N}$. In particular
$$K_N * f \sim \sum_{n \leq N} \frac{\Trans_{y_{n,N}}f}{||w_{n,N}||_1} \sim \sum_{n \leq N} \frac{f(-y_{n,N})}{||w_{n,N}||_1} \leq 8Mf$$
snice the second sum is an average of $||K_N||_1f$ at a sampling of uniformly distributed points.
\end{proof}
\begin{theorem}
For every $f \in L^1(T)$, $F_Nf \to f$ almost pointwise.
\end{theorem}
\begin{proof}
We first observe that if $S_Nf \to f$ almost pointwise then $F_Nf \to f$ almost pointwise. Indeed,
$$F_Nf(x) = \sum_{|n| \leq N+1}\frac{N+1-n}{N+1} \hat f(n)e^{2\pi inx}$$
which clearly approximates $S_Nf(x)$ if $N$ is large.
So if $f$ is smooth, then $F_Nf \to f$ almost pointwise.

Moreover, if $f$ is smooth, then by the Hardy-Littlewood inequality and the previous lemma,
$$||\sup_N |F_Nf|||_{1, \infty} \lesssim ||Mf||_{1, \infty} \lesssim ||f||_1.$$
Therefore $F_N$ is weakly $(1, 1)$ uniformly in $N$.

We now choose a sequence of $f_k \in C^\infty(T)$ such that $||f_k - f||_1 < 2^{-k}$.
By Markov's inequality,
$$||f_k - f| \geq 1/k| \leq k ||f_k - f||_1 < k 2^{-k}$$
so by the Borel-Cantelli lemma, the set of $x$ such that $f_k(x) - f(x) > 1/k$ for infinitely many $k$ has measure $0$.
Therefore $f_k \to f$ almost pointwise.

Since $F_N$ is weakly $(1, 1)$ uniformly in $N$ and $f_k \to f$ in $L^1$,
$$\lim_{k \to \infty} ||\sup_N F_N|f_k - f|||_{1, \infty} = 0.$$
Therefore $\sup_NF_N|f_k - f| \to 0$ in measure, so
$$\lim_{k \to \infty} \sup_N |F_N f_k - F_N f| = 0$$
in measure. We pass to a subsequence where we can use the Borel-Cantelli lemma to imply that the above limit converges almost pointwise.
Since the convergence is uniform in $N$,
$$|F_Nf - f| \leq |F_Nf - F_Nf_N| + |F_Nf_N - f_N| + |f_N - f| \to 0.$$
This was desired.
\end{proof}

\section{Carleson's theorem}
\begin{theorem}
For every $f \in L^2(T)$, $S_Nf \to f$ almost pointwise.
\end{theorem}
By a previous lemma it suffices to show that the maximal operator
$$f \mapsto |\sup_N 1_{D \leq N} f|$$
is weakly $(2, 2)$ on $\Sch(\RR)$, i.e.
$$|\sup_N |1_{D \leq N} f|||_{2, \infty} \lesssim ||f||_2.$$
We first linearize this estimate.
Let $N(x)$ be a frequency which nearly attains the suprema value of $|1_{D \leq N} f(x)|$. Then it suffices to show
$$||1_{D \leq N(X)}f||_{2, \infty} \lesssim ||f||_2.$$
Here $1_{D \leq N(X)}$ is the Kohn-Nirenberg quantization of the rough symbol $(x, \xi) \mapsto 1_{\xi \leq N(x)}$.

\begin{lemma}
Let $p \in (1, \infty)$, $(X, \mu)$ a $\sigma$-finite measure space, $f: X \to \CC$ measurable, and $A > 0$. Then $||f||_{L^{p,\infty}(\mu)} \leq A$ if and only if for every $E$ of finite measure, $f \in L^1(E)$ and
$$\int_E f ~d\mu \lesssim_p A\mu(E)^{1/p'}.$$
\end{lemma}
\begin{proof}
We first show that if $f \in L^{p, \infty}(\mu)$ then $f \in L^1(E)$. If $f \in L^{p, \infty}(\mu)$ then for every $\lambda > 0$,
$$\lambda^p \mu(|f| > \lambda) \leq ||f||_{L^{p, \infty}(\mu)}.$$
In particular,
$$\mu(|f| > \lambda) \lesssim_f \lambda^{-p}.$$
So if $E_\lambda = \{x \in E: |f(x)| \leq \lambda\}$ then
$$\int_E |f| ~d\mu \leq \int_{E_\lambda} \lambda ~d\mu + \int_{|f| > \lambda} |f|~d\mu.$$
Since $L^\infty(\mu)$ is dense in $L^{p, \infty}(\mu)$, we can assume that $||f||_\infty < \infty$. Thus
$$||f||_{L^1(E)} \lesssim_f \lambda \mu(E) + \lambda^{-p}.$$
Therefore $f \in L^1(E)$.

By taking a decreasing rearrangement of $f$ and then restricting to generators of the Borel $\sigma$-algebra, to check the claim it now suffices to check when $X = (0, \infty)$, $\mu$ is Lebesgue measure, $E = (0, R)$ for some $R > 0$, and $f$ is decreasing.
Then
$$||f||_{p, \infty} = \sup_{\lambda > 0} \lambda^{1/p} f(\lambda).$$
If $||f||_{p, \infty} \leq A$ then for every $\lambda > 0$, $f(\lambda) \leq \lambda^{-1/p}A$. So by Hoelder duality,
$$\int_E f~d\mu \leq A \int_E \lambda^{-1/p} ~d\lambda = A \int_0^R \lambda^{-1/p}~d\lambda \lesssim_p AR^{1/p'} = A\mu(E)^{1/p'}.$$
Conversely, if for every $E$,
$$\int_E f~d\mu \leq A\mu(E)^{1/p'}$$
then
$$\mu(E)^{-1/p'} \int_E f(\lambda) ~d\lambda \leq A.$$
So by Holeder duality,
$$\frac{1}{\mu(E)} \int_E \lambda^{1/p} f(\lambda) ~d\lambda \leq \mu(E)^{1/p-1} \int_E \lambda^{1/p} f(\lambda)~d\lambda \leq A.$$
Thus the average of $\lambda^{1/p} f(\lambda)$ as $\lambda$ ranges over any Borel set $E \subset (0, \infty)$ such that $\mu(E) < \infty$ is $\leq A$.
In particular $\lambda^{1/p} f(\lambda) \leq A$, i.e. $||f||_{p, \infty} \leq A$, which was to be shown.
\end{proof}

Thus it suffices to show that for every Borel set $E$, any measurable function $f: E \to \CC$, and $f \in \Sch$ that
$$\int_{-\infty}^\infty 1_E(X)1_{D\leq N(X)}f \lesssim ||f||_2\sqrt{|E|}.$$
Here the operator $1_E(X)1_{D\leq N(X)}$ is the Kohn-Nirenberg quantization of the rough symbol
$$(x, \xi) \mapsto 1_E(x)1_{\xi \leq N(x)}.$$

The above estimate is very weird. It has a lot of symmetries. First, if $\Trans_{x_0}$ is the translation operator
$$\Trans_{x_0} f(x) = f(x - x_0)$$
then both sides of the estimate are left invariant by $f \mapsto \Trans_{x_0}$, $N \mapsto \Trans_{x_0}$, $E \mapsto E + x_0$.
Second, for every $\lambda > 0$ we have a dilation symmetry; if $\Dil_\lambda$ is the $L^2$ dilation operator,
$$\Dil_\lambda f(x) = \lambda^{-1/2}f(x/\lambda).$$
Here $f \mapsto \Dil_\lambda f$, $E \mapsto \lambda E$ and $N \mapsto (x \mapsto \lambda^{-1}N(x/\lambda))$.

But the above estimates are preserved by Calderon-Zygmund theory. We have another symmetry which is not respected by Calderon-Zygmund theory, which is the modulation symmetry, where the modulation operator $\Mod_{\xi_0}$ satisfies
$$\Mod_{\xi_0}f(x) = e^{2\pi i\xi_0} f(x),$$
and we map $f \mapsto \Mod_{\xi_0}f$, $E$ is left invariant, and $N \mapsto N + \xi_0$. This is NOT an invariant of the original estimate, but it is an invariant of the normed estimate
$$||1_E(X)1_{D\leq N(X)}f||_1 \lesssim ||f||_2\sqrt{|E|}.$$
This is highly problematic because none of the tools we have used above do not respect modulation. So we need to develop new tools to prove Carleson's theorem.

\section{Proof of Carleson's theorem, part I: mean reduction}
We first deal with the annoying operator $\hat f \mapsto (\xi \mapsto 1_{\xi \leq N(x)}\hat f(\xi))$.
We want to approximate this as a sum of operators of the form $1_I1_J$ where $I$ is a cutoff in time and $J$ is a cutoff in frequency.
Note that the open set $\{(x, \xi): \xi < N(x)\}$ can be written as an almost-disjoint countable union of dyadic tiles $I \times J$.
By a \dfn{tile} we mean a rectangle of area $1$ and dyadic tiles are tiles that are products of dyadic intervals.

If $\omega$ is a dyadic frequency interval, we let $\omega_\pm$ denote the children of $\omega$, $\omega_+$ containing higher frequencies than $\omega_-$.
Let $\eta$ be a bump function supported on $[0.1, 0.2]$ with $||\eta||_2 = 1$; all implied constants are allowed to depend on $\eta$.
Let $\eta_\omega$ denote
$$\eta_\omega(\xi) = \eta(\frac{\xi - \inf \omega}{|\omega|})$$
which is supported on $\omega_-$.
We claim
$$\sum_\omega |\int_{-\infty}^\infty 1_E(X)1_{\omega_+}(N(X))|\eta_\omega|^2(D)f(x) ~dx| \lesssim ||f||_2 \sqrt{|E|}.$$
Here the sum is over all dyadic intervals $\omega$.

\begin{lemma}
If one has
$$\sum_\omega |\int_{-\infty}^\infty 1_E(X)1_{\omega_+}(N(X))|\eta_\omega|^2(D)f(x) ~dx| \lesssim ||f||_2 \sqrt{|E|}$$
then Carleson's theorem holds.
\end{lemma}
\begin{proof}
We need to average over translates of the claim to get a translation-invariant estimate. To do this, notice that
$$\sum_\omega |\int_{-\infty}^\infty 1_E(X)1_{\omega_+}(N(X) + \xi_0)|\eta_\omega|^2(D)\Mod_{\xi_0}f(x)~dx| \lesssim ||f||_2\sqrt{|E|}.$$
But
$$|\eta_\omega|^2(D) \Mod_{\xi_0} = \Mod_{\xi_0}|\eta_{\omega - \xi_0}|^2(D).$$
Thus
$$\sum_\omega |\int_{-\infty}^\infty 1_E(X)1_{\omega_+ - \xi_0}(N(X))|\eta_{\omega - \xi_0}|^2(D)f(x)~dx| \lesssim ||f||_2\sqrt{|E|}.$$

We now restrict to a finite range of scales. Let $K > 0$, so
$$\sum_{|k| \leq K} \sum_{|\omega| = 2^{-k}} \int_{-\infty}^\infty 1_E(X)1_{\omega_+-\xi_0}(N(X))|\eta_{\omega - \xi_0}|^2(D)f(x)~dx \lesssim ||f||_2\sqrt{|E|}.$$
For any $k$,
$$\sum_{|\omega| = 2^{-k}} \int_{-\infty}^\infty 1_E(X)1_{\omega_+-\xi_0}(N(X))|\eta_{\omega - \xi_0}|^2(D)f(x)~dx$$
is periodic in $\xi_0$ of period $2^{-k}$. Its average is
$$2^k \iint_{\RR^2} 1_E(X) 1_{[\zeta + 2^{-k-1}, \zeta + 2^{-k}]}(N(X))|\eta_{[\zeta,\zeta+2^{-k}]}|^2(D)f(x)~dx~d\zeta.$$
This is equal to
$$\iint_{\RR^2} 1_E(x)2^k \int_{-\infty}^\infty 1_{[\zeta+2^{-k-1},\zeta+2^{-k}](N(x))}\eta(2^k(\xi-\zeta))^2~d\zeta ~\hat f(\xi)e^{2\pi ix\xi}~d\xi~dx.$$
Using the change of variables $\zeta = N(x)-2^{-k}t$ we see this is equal to
$$\iint_{\RR^2} 1_E(x)\Psi(2^k(N(x)-\xi))\hat f(\xi)e^{2\pi ix\xi}~d\xi~dx.$$
Here
$$\Psi(\xi) = \int_{1/2}^1 |\eta(t - \xi)|^2~dt.$$
Averaging in $\xi_0$ over $[0, 2^K]$ we have
$$\sum_{|k| \leq K} \iint_{\RR^2} 1_E(x)\Psi(2^k(N(x)-\xi))\hat f(\xi)e^{2\pi ix\xi}~d\xi~dx \lesssim ||f||_2\sqrt{|E|}.$$
This estimate is uniform in $K$ so it remains true when we drop the constraint $\leq K$.

We now want to use dilation symmetry, so we switch to multiplicative Haar measure $d\lambda/\lambda$. We have
$$\sum_k \iint_{\RR^2} 1_E(x)\Psi(\lambda 2^k(N(x)-\xi)) \hat f(\xi)e^{2\pi ix\xi}~dx~d\xi \lesssim ||f||_2\sqrt{|E|}.$$
Averaging over $\lambda \in [1,2]$ we see
$$\iint_{\RR^2} 1_E(x) \sum_k \int_1^2 \Psi(\lambda 2^k(N(x)-\xi)) \frac{d\lambda}{\lambda}~\hat f(\xi)e^{2\pi ix\xi}~d\xi~dx \lesssim ||f||_2\sqrt{|E|}.$$
Here
$$\sum_k \int_1^2 \Psi(\lambda 2^k(N(x)-\xi))\frac{d\lambda}{\lambda}
= \sum_k \int_{2^k}^{2^{k+1}}\Psi(\lambda(N(x)-\xi))\frac{d\lambda}{\lambda} = 1_{\xi\leq N(x)}\int_0^\infty \Psi(\lambda) \frac{d\lambda}{\lambda}$$
since $\Psi$ is supported in $(0, \infty)$.
Thus
$$\iint_{\RR^2}1_E(x)1_{\xi \leq N(x)} \hat f(\xi)e^{2\pi ix\xi}~dx ~d\xi \lesssim ||f||_2 \sqrt{|E|}.$$
This completes the reduction.
\end{proof}

We have
$$|\eta_\omega|^2(D)f = f*\tilde \check \eta_\omega * \eta_\omega(x) = \iint_{\RR^2} f(z) \overline{\check \eta_\omega(z-y)}~dz~\eta_\omega(x-y)~dy
=\int_{-\infty}^\infty \langle f, \Trans_y \check \eta_\omega \rangle \Trans_y \check \eta_\omega ~dy.$$

Given a tile $P$ we write
$$P = I_P \times \omega_P$$
for the time and frequency intervals. As always we assume $|P| = 1$. We write $P_\pm = I_P \times (\omega_P)_\pm$.
We write $|I_P|$ for the \dfn{spatial scale}, i.e. the length of $I_P$, and define the \dfn{frequency scale} to be $|\omega_P|$.
Given such a tile, the \dfn{wavepacket} of the tile is
$$\phi_P = \sqrt{|I_P|} \Trans_{\inf I_P} \check \eta_{\omega_P}.$$
This is a Schwartz function with Fourier support in $(\omega_P)_-$ such that $||\phi_P||_2 = 1$ and is localized spatially in $I_P$ in the sense that away from $I_P$ it decays rapidly.
So $\phi_P$ has ``phase space support" in $P_-$.

\begin{lemma}
To prove that
$$\sum_\omega |\int_{-\infty}^\infty 1_E(X)1_{\omega_+}(N(X))|\eta_\omega|^2(D)f(x) ~dx| \lesssim ||f||_2 \sqrt{|E|}.$$
it suffices to show that
$$\sum_P |\langle f, \phi_P\rangle\langle \phi_P 1_{(\omega_P)_+}(N), 1_E\rangle| \lesssim ||f||_2\sqrt{|E|}.$$
Here $P$ ranges over all tiles.
\end{lemma}
\begin{proof}
We average over all spatial translations. We have
$$\sum_{|k| \leq K} \sum_{|\omega|=2^{-k}} |\sum_{\omega_P = \omega} \langle f, \phi_P\rangle \langle \phi_P 1_{\omega_+}(N), 1_E\rangle| \lesssim ||f||_2\sqrt{|E|}.$$
For any $x_0 \in \RR$ translation symmetry gives
$$\sum_{|k| \leq K} \sum_{|\omega|=2^{-k}} |\sum_{\omega_P = \omega} \langle \Trans_{x_0} f, \phi_P\rangle \langle \phi_P 1_{\omega_+}(\Trans_{x_0}N), 1_{E+x_0}\rangle| \lesssim ||f||_2 \sqrt{|E|}.$$
Using translation symmetry of Lebesgue measure we have
$$\sum_{|k| \leq K} \sum_{|\omega|=2^{-k}} |\sum_{\omega_P = \omega} \langle f, \phi_{P+(x_0, 0)}\rangle \langle \phi_{P+(x_0,0)} 1_{\omega_+}(N), 1_E\rangle| \lesssim ||f||_2 \sqrt{|E|}.$$
For a fixed $k$, the time scale is $2^k$ so the inner sum is periodic in $x_0$ with period $2^k$.
It averages to
$$\int_{-\infty}^\infty \langle f, \Trans_y \check \eta_\omega \rangle\langle \Trans_y \check \eta_{\omega_+}(N), 1_E\rangle ~dy.$$
But we already proved that
$$\int_{-\infty}^\infty \langle f, \Trans_y \check \eta_\omega \rangle \Trans_y \check \eta_\omega ~dy = |\eta_\omega|^2(D)f$$
so in particular, the average over $x_0$ is
$$\langle |\eta_\omega|^2(D) f1_{\omega_+}(N), 1_E\rangle.$$
Thus
$$\sum_{|k| \leq K} \sum_{|\omega|=2^{-k}} \langle |\eta_\omega|^2(D) f1_{\omega_+}(N), 1_E\rangle \lesssim ||f||_2 \sqrt{|E|}.$$
This estimate is uniform in $K$, so it completes the reduction.
\end{proof}
Now let
$$E_P^+ = \{x \in E: N(x) \in (\omega_P)_+\}.$$
By the previous lemma, to prove Carleson's theorem it suffices to show
$$\sum_P |\langle f, \phi_P\rangle \langle \phi_P, 1_{E_P^+}\rangle| \lesssim ||f||_2 \sqrt{|E|}.$$
The thing that we now need to prove is good because it has been broken up into a triple sum: sum over scales, sum over a frequency, sum over the tiles in that frequency.
We can restrict then to tiles that are of a desirable type.
In fact, by monotone convergence it suffices to show that for every finite set $\mathcal P$ of tiles we have
$$\sum_{P \in \mathcal P} |\langle f, \phi_P\rangle \langle \phi_P, 1_{E_P^+}\rangle| \lesssim ||f||_2 \sqrt{|E|}.$$
Let us say that a finite set $\mathcal P$ is \dfn{good} if this holds.
Notice that the nasty functions $f,N$ don't talk to each other, only to the explicitly defined function $\phi_P$.

\section{Proof of Carleson's theorem, part II: Disjoint tiles on one scale}
\begin{lemma}
If $\mathcal P$ has cardinality one then $\mathcal P$ is good.
\end{lemma}
\begin{proof}
We must show that
$$\langle f, \phi_P\rangle\langle \phi_P, 1_{E_P^+}\rangle \lesssim ||f||_2 \sqrt{|E|}.$$
By Cauchy-Schwarz we have
$$\langle f, \phi_P\rangle \lesssim ||f||_2.$$
Let $\chi_I$ be the indicator function of a set $I$ with a smooth, polynomially decaying tail.
Then
$$\phi_P(x) \lesssim |I_P|^{-1/2}\chi_{I_P}^M(x)$$
for any $M$. Thus we can use Hoelder in two different ways.
First,
$$\langle \phi_P, 1_{E_P^+}\rangle \lesssim ||\phi_P||_1 \lesssim \sqrt{|I_P|}.$$
Second,
$$\langle \phi_P, 1_{E_P^+}\rangle \lesssim ||\phi_P||_\infty \sqrt{|E_P^+|} \lesssim |I_P|^{-1/2}|E|.$$
Taking geometric means we see
$$\langle \phi_P, 1_{E_P^+}\rangle \lesssim \sqrt{|E|}.$$
\end{proof}
The above proof shows that the estimate
$$\langle \phi_P, 1_{E_P^+}\rangle \lesssim \sqrt{|E|}$$
is not sharp if $|I_P|$ is much smaller or much larger than $|E|$. This will be important when we sum over $\mathcal P$ where $|\mathcal P|$ is large.

\begin{lemma}
If $\mathcal P$ is a set of tiles $P$ such that $|I_P| = 2^k$ then $\mathcal P$ is good.
\end{lemma}
\begin{proof}
By dyadicity $\mathcal P$ is an almost disjoint set. We claim that therefore
$$\sum_{P \in \mathcal P} \sqrt{|I_P|}|\langle \phi_P, 1_{E_P^+}\rangle| \lesssim |E|$$
which we call a \dfn{mass estimate}.
Moreover,
$$\sum_{P \in \mathcal P} |\langle f, \phi_P\rangle|^2 \lesssim ||f||_2^2$$
which we call an \dfn{energy estimate}.
Combining with the bound
$$\langle \phi_P, 1_{E_P^+}\rangle \lesssim ||\phi_P||_1 \lesssim \sqrt{|I_P|}$$
we have
$$\sum_{P \in \mathcal P} |\langle \phi_P, 1_{E_P^+}\rangle|^2 \lesssim |E|.$$
Then Cauchy-Schwarz implies the lemma.

To establish the mass estimate, first consider a rough version of $\phi_P$ which has no tail. Then we could replace $\chi_{I_P}$ with $1_{I_P}$. Then
$$|I_P|^{1/2}\langle \phi_P, 1_{E_P^+}\rangle \lesssim |\{x \in E: (x, N(x)) \in P_+\}|$$
but $N$ is a function, so it passes the vertial line test. That means that the $\{x \in E: (x, N(x)) \in P_+\}$ are disjoint sets. So we can sum both sides over $P \in \mathcal P$ and use
$$\sum_{P \in \mathcal P}  |\{x \in E: (x, N(x)) \in P_+\}| = |E|.$$
Now to check the tails. We have
$$\sum_{P \in \mathcal P} \sqrt{|I_P|}|\langle \phi_P, 1_{E_P^+}\rangle| \leq \int_E \sqrt{|I_P|} \sum_{\substack{P \in \mathcal P\\N(x)\in (\omega_P)_+}} |\phi_P|.$$
Again the claim follows by the vertical line test (only one of the $\phi_P$ is nonzero at any time) which gives that the sum in the integral is bounded uniformly in $|\mathcal P|$.

Now we check the energy estimate. Since the $P$ are disjoint the $\phi_P$ are almost orthogonal. We have
$$\sqrt{\sum_{P \in \mathcal P}|\langle f, \phi_P\rangle|^2} = \sum_{P \in \mathcal P} \overline{c_P}\langle f, \phi_P\rangle = \langle f, \sum_{P \in \mathcal P} c_P\phi_P\rangle$$
where
$$\sum_{P \in \mathcal P} |c_P|^2 = 1.$$
Thus it suffices to show
$$||\sum_{P \in \mathcal P} c_P\phi_P||_2^2 \lesssim 1.$$
But
$$||\sum_{P \in \mathcal P} c_P\phi_P||_2^2 = \sum_{P,P' \in \mathcal P} c_P\overline{c_P'}\langle \phi_P, \phi_{P'}\rangle.$$
By dyadicity $\langle \phi_P, \phi_{P'}\rangle \neq 0$ is only possible when $\omega_P = \omega_{P'}$. In this case $\langle \phi_P, \phi_{P'}\rangle$ is a rapidly decaying function of $|I_P|$.
\end{proof}
The motivation for the terminology ``mass" is that mass should refer to the $L^1$ distribution of a function (here $1_E$).
Energy should refer to its $L^2$ behavior (here the $L^2$ behavior of $f$).

\section{Proof of Carleson's theorem, part III: Trees}
In the previous section we considered when $\mathcal P$ was on a single scale. We have to consider tiles on the same scale, which may have overlap.
If two dyadic intervals intersect, one is contained in the other. Thus we may put a partial order on tiles where $P \leq P'$ means that $I_P \subseteq I_{P'}$ and $\omega_{P'} \subseteq \omega_P$.
In this order, short, fat tiles are big.

If $\mathcal P$ is an antichain, then it is disjoint and the techniques of the above section easily imply that $\mathcal P$ is good.
But we have some disjointness for $\mathcal P$s with nontrivial orders too; if $P > P'$ then either $P_+$ and $P_+'$ are disjoint, or $P_-$ and $P_-'$ are disjoint.
\begin{definition}
Let $P_T$ be a tile. A \dfn{tree} with top $P_T$ is a set $T$ of tiles $P$ such that $P \leq P_T$. If $P_\pm \leq (P_T)_\pm$ for all $P \in T$ we say that $T$ is a \dfn{$\pm$-tree}.
\end{definition}
Notice that the top is the longest and skinniest element of the tree (though it may not be contained in the tree). Therefore every element of the tree is either in a $+$-subtree or a $-$-subtree and hence we can partition any tree into a $+$-tree and a $-$-tree.
Thus to check the claim for trees it suffices to check the claim for $\pm$-trees.

We first consider the case of a $-$-tree $T$. In this case the $P^+$ for $P \in T$ are disjoint.
We can prove something stronger than the claimed estimate
$$\sum_{P \in T} \langle f, \phi_P\rangle \langle \phi_P, 1_E\rangle \lesssim ||f||_2\sqrt{|E|}$$
because we are really only interested in $f$ close to the elements of $T$, which is local, but the right-hand side is global, because it contains a term $||f||_2$ that depends on the integral of $f$ over all over $\RR$.
So we can do better; for example we might want to use
$$\int_I f1_E \leq |I|\frac{|E \cap I|}{|I|} ||f||_{L^\infty(I)}$$
or a similar estimate. Here $|E \cap I|/|I|$ is the Lebesgue density of $E$ in $I$.

\begin{definition}
A finite $-$-tree $T$ is a \dfn{regular $-$-tree} if there is an \dfn{energy} $\varepsilon$ and a \dfn{mass} $\mu$ such that for every $P \in T$,
$$\langle f, \phi_P\rangle \lesssim \sqrt{|I_P|}\varepsilon$$
and for every $P' \geq P$,
$$\langle 1_E, \chi_{I_P'}^{10}\rangle \lesssim |I_P'| \mu.$$
Moreover, we assume that
$$\langle f, \phi_P\rangle \gtrsim \sqrt{|I_T|}\varepsilon$$
and
$$\langle 1_E, \chi_{I_T}^{10}\rangle \gtrsim |I_T|\mu$$
so that the energy and mass are optimal.
\end{definition}
Intuitively this means that the mean of $f$ on a tile is $O(\varepsilon)$ and the density of $E$ on any extension of a tile is $O(\mu)$.

\begin{definition}
We say that a tree $T$ satisfies the \dfn{tree estimate} if
$$\sum_{P \in T} |\langle f, \phi_P\rangle\langle\phi_P,1_{E_P^+}\rangle| \lesssim \varepsilon\mu|I_T|.$$
\end{definition}
\begin{lemma}
If $T$ is a regular $-$-tree which satisfies the tree estimate then $T$ is good.
\end{lemma}
\begin{proof}
We are given the estimates
$$|I_T|^{-1/2}\langle f, \phi_{P_T}\rangle \gtrsim \varepsilon$$
on energy and
$$|I_T|^{-1}\langle 1_E, \chi_{I_T}^{10}\rangle \gtrsim \mu$$
on mass. Since $||\phi_{P_T}||_2 = 1$, the Cauchy-Schwarz inequality gives
$$\varepsilon \lesssim |I_T|^{-1/2}||f||_2.$$
Similarly,
$$\mu \lesssim |I_T|^{-1/2}\sqrt{|E|},$$
Plugging these bounds into the tree estimate we see
$$\sum_{P \in T} |\langle f, \phi_P\rangle\langle\phi_P,1_{E_P^+}\rangle| \lesssim ||f||_2 \sqrt{|E|}$$
which was desired.
\end{proof}
We now show that all regular $-$-trees are good.
\begin{lemma}
If $T$ is a regular $-$-tree then $T$ satisfies the tree estimate.
\end{lemma}
To prove the tree estimate, we partition $\RR$ into intervals:
\begin{lemma}
For every nonempty finite tree $T$ there is a set $\mathcal J$ of dyadic intervals $\subset \RR$ which almost partition $\RR$ such that for every $J \in \mathcal J$:
\begin{enumerate}
\item For every $P \in T$ with $|I_P| < |J|$, $d(I_P, J) \gtrsim |J|$.
\item There is a $P \in T$ such that $|I_P| \lesssim |J|$ and $d(I_P, J) \lesssim |J|$.
\end{enumerate}
\end{lemma}
\begin{proof}
If $J$ is a dyadic interval, by $3J$ we mean $[\inf J - |J|, \sup J + |J|]$.
Let $\mathbb P$ be the poset of all dyadic intervals such that $3J$ does not contain any $I_P$ such that $P \in T$, with respect to set inclusion.
Let $\mathcal J$ denote the antichain of all maximal elements of $\mathbb P$.
We claim that $\mathcal J$ is the desired set.

We first show that $\mathcal J$ is almost a partition of $\RR$.
Let $J, J' \in \mathcal J$, and suppose that $J \cap J'$ has positive measure.
Let $J \oplus J'$ be the smallest dyadic interval containing $J \cup J'$; then the set $\mathbb P'$ of dyadic subintervals of $J \oplus J'$ is a tree (in the graph-theoretic sense).
In particular, since $J \cap J'$ is the $\mathbb P'$-meet of $J, J'$, either $J \subseteq J'$ or vice versa. But $J,J'$ are maximal so $J = J'$. Therefore $\mathcal J$ is almost disjoint.

Conversely, suppose that $x \in \RR$.
Since $T$ is finite, and hence there is a $\delta > 0$ such that for every $P \in T$, $|I_P| > \delta$, we can almost surely find a dyadic interval $J$ such that $x \in J \in \mathbb P$. Now choose the maximal such $J$.

Now fix a $J \in \mathcal J$. We check that $J$ meets the constraints of the lemma.

First, fix a $P \in T$ such that $|I_P| < |J|$.
Suppose that $d(I_P, J) < |J|$. By assumption, $3J$ does not cover $I_P$, yet $I_P \subseteq 3J$, a contradiction. Therefore $d(I_P, J) \geq |J|$.

Conversely, we must find a $P \in T$ such that $|I_P| \lesssim |J|$ and $d(I_P, J) \lesssim |J|$.
Let $J'$ be the parent of $J$, so $J' \notin \mathbb P$ and hence $3J'$ covers some $I_P$. Thus $J'$ is adjacent to $I_P$ or one of its ancestors. It is no loss to the estimates being made to assume that $J'$ is adjacent to $I_P$.
In that case, the claim follows from the fact that $|J| \sim |J'|$.
\end{proof}
\begin{proof}[Proof of tree estimate for regular $-$-trees]
We have
$$\sum_{J \in \mathcal J} \sum_{P \in T} |\langle f,\phi_P\rangle| \int_J |\phi_P|1_{E_P^+} \lesssim \varepsilon \sum_{J \in \mathcal J} \sum_{P \in T} \int_J \chi_{I_P}^{100}1_{E_P^+}.$$
We first consider the case of narrow tiles, $|I_P| < |J|$. By construction this implies $d(I_P, J) \gtrsim |J|$.
Appealing to the decay rate of $\chi_{I_P}$ we have
$$\int_J \chi_{I_P}^{100}1_{E_P^+} \lesssim \mu|J|\frac{|I_P|^{20}}{d(I_P,J)^{20}} \lesssim \mu|J|\frac{|I_P|^{10}}{|J|^{10}}\frac{|I_P|^{10}}{d(I_P, J)^{10}}.$$
Fix a scale $|I_P| = 2^k$. Then the $I_P$ of this scale are all almost disjoint. It follows that
$$\sum_{\substack{P \in T\\|I_P| = 2^k}} \frac{|I_P|^{10}}{d(I_P, J)^{10}} \lesssim \frac{|J|}{2^k}.$$
Thus
$$\sum_{\substack{P \in T\\|I_P| < |J|}} \int_J \chi_{I_P}^{100}1_{E_P^+} \lesssim \mu|J| \min(1, |I_T|/|J|)^9.$$
By the decomposition lemma $|I_T| \lesssim |J|$ so the contribution from narrow tiles is acceptable.

Now if a tile is wide, $|I_P| \geq |J|$, it follows that $|J| \leq |I_T|$ and $d(J, I_T) \lesssim |I_T|$.
Thus the set of all such $J$ has bounded cardinality and suffices to check that for each $J$,
$$\sum_{\substack{P \in T\\|I_P| \geq |J|}} \int_J \chi_{I_P}^{100} 1_{E_P^+} \lesssim \mu|J|.$$
For every scale $2^k$ there is at most one choice $\omega_k = \omega_P$ as $P$ ranges over $T$, since $T$ is a $-$-tree. Thus
$$E_P^+ = \{x \in \RR: N(x) \in \omega_k^+\}$$
only depends on $2^k$ and not $P$.
Summing up, we have
$$\sum_{\substack{P \in T\\|I_P| \geq |J|}} \int_J \chi_{I_P}^{100}1_{E_P^+} \lesssim \int_J 1_{E_k^+}.$$
Now because $T$ is a $-$-tree, the $\omega_k^+$ are almost disjoint. So so are the $E_k^+$. Thus
$$\sum_k \int_J 1_{E_k^+} \lesssim |E \cap J|.$$
By construction there is a tile $P'$ of scale $\sim |J|$ and $d(P', J) \lesssim |J|$ such that $P' \geq P$ where $d(I_P, J) \lesssim |J|$.
By regularity we have
$$|E \cap J| \lesssim \mu|J|$$
which was desired.
\end{proof}

We now turn to $+$-trees. Here the $E_P^+$ may overlap but the $\langle f,\phi_P\rangle$ are orthogonal.
\begin{definition}
A finite tree $T$ is a \dfn{regular $+$-tree} if it is a $+$-tree with an \dfn{energy} $\varepsilon$ such that for every $P \in T$,
$$\sqrt{\sum_{\substack{P' \in T\\P' \leq P}} |\langle f, \phi_{P'}\rangle|^2} \lesssim \varepsilon\sqrt{|I_P|}$$
and a \dfn{mass} $\mu$ which is defined identically to the mass of a regular $-$-tree, such that the energy and the mass are optimal, i.e.
$$\sqrt{\sum_{P \in T} |\langle f, \phi_P\rangle|^2} \gtrsim \varepsilon\sqrt{|I_T|}$$
for energy, and the lower bound for mass.
\end{definition}
Thus by optimality of mass and the Cauchy-Schwarz inequality,
$$\mu \lesssim \sqrt{\frac{|E|}{|I_T|}}.$$
\begin{lemma}
Let $T$ be a $+$-tree. Then for every vector $(c_P)_{P \in T}$ of complex numbers,
$$||\sum_{P \in T} c_P\phi_P||_2^2 \lesssim \sum_{P \in T} |c_P|^2.$$
In particular, one has
$$\sum_{P \in T} |\langle f, \phi_P\rangle|^2 \lesssim ||f||_2^2.$$
\end{lemma}
\begin{proof}
To prove the first claim we first observe that since $T$ is a $+$-tree, if $P \neq P'$ then $\phi_P \phi_{P'} = 0$ unless $\omega_P = \omega_{P'}$ in which case we have
$$\langle \phi_P, \phi_{P'}\rangle \lesssim d(I_P, I_{P'})^{-100}/|I_P|^{-100}.$$
But
$$||\sum_{P \in T} c_P\phi_P||_2^2 = \sum_{P, P' \in T} c_P \overline{c_{P'}} \langle \phi_P, \phi_{P'}\rangle \lesssim \sum_{P, P' \in T} c_P \overline{c_{P'}}  d(I_P, I_{P'})^{-N}/|I_P|^{-N} \lesssim \sum_{P \in T} |c_P|^2$$
taking $N$ large enough. This proves the first claim.

To prove the second claim, note that
$$\sqrt{\sum_{P \in T} |\langle f, \phi_P\rangle|^2} = \langle f, \sum_{P \in T} c_P \phi_P \rangle$$
for some coefficients $c_P$ with $\sum_{P \in T} |c_P|^2 = 1$. Thus the first claim implies the second.
\end{proof}
Notice that this is just a slight modification of the original proof for tiles on one scale.
It implies that
$$\varepsilon \lesssim |I_T|^{-1/2}||f||_2$$
which gives the following lemma.
\begin{lemma}
If $T$ is a regular $+$-tree which satisfies the tree estimate, then $T$ is good.
\end{lemma}

We now linearize the above estimate to make it easier to prove.
\begin{lemma}
If $T$ is a reguler $+$-tree then for every $\epsilon_P \in \CC$ with $\epsilon_P = 1$,
$$\sum_{P \in T} \epsilon_P \langle f, \phi_P\rangle \langle \phi_P, 1_{E_P^+}\rangle \lesssim \varepsilon \mu |I_T|.$$
In particular, $T$ satisfies the tree estimate.
\end{lemma}
\begin{proof}
We can rewrite the left hand side as
$$\sum_{J \in \mathcal J} \int_J \sum_{P \in T} \epsilon_P \langle f, \phi_P\rangle \phi_P 1_{E_P^+}.$$
The proof in the case $|I_P| < |J|$ is the same as for regular $-$-trees, so we consider the case $|I_P| \geq |J|$ and assume that $T$ is nonempty.
In that case, there is a $C > 0$ that doesn't depend on $P,J$ such that $CI_T$ contains $J$, or else the sum is empty.

Now
$$1_{E_P^+}(x) = 1_E(x)1_{N(x) \in \omega_P^+}.$$
Thus the left-hand side is
$$\sum_{J \in \mathcal J} \int_{J \cap E} \sum_{\substack{P \in T\\|I_P| \geq |J|\\N(x) \in \omega_P^+}} \epsilon_P \langle f, \phi_P\rangle \phi_P(x) ~dx.$$
The intervals $\omega_P^+$ are nested since $T$ is a $+$-tree.
Thus $N(x) \in \omega_P^+$ is equivalent to an estimate of the form $|I_P| \leq R(x)$.
Now we rewrite the left-hand side as
$$\sum_{J \in \mathcal J} \int_{J \cap E} \sum_{\substack{P \in T\\|I_P| \geq |J| \leq R(x)}} \epsilon_P \langle f, \phi_P\rangle \phi_P(x) ~dx.$$
Let
$$F(x) = \sum_{P \in T} \epsilon_P \langle f, \phi_P \rangle \phi_P(x).$$
Then the integrand in the left-hand side is the Littlewood-Paley projection of $F$ to those intervals $\omega_P^+$ such that $|J| \leq |I_P| \leq |R(x)|$.
\begin{lemma}
If $x \in J$ and $I$ runs over all intervals (not just dyadic) containing $J$,
$$\sum_{\substack{P \in T\\|J| \leq |I_P| \leq |R(x)|}} \epsilon_P \langle f, \phi_P\rangle \phi_P(x) \lesssim \sup_I \frac{1}{|I|} \int_I |F|.$$
\end{lemma}
\begin{proof}
TODO
\end{proof}
Now by assumption on $\mathcal J$ and the definition of mass,
$$|J \cap E| \lesssim \mu|J|.$$
Thus we have a bound
$$\lesssim \sum_{\substack{J \in \mathcal J\\J \subset CI_T}} \mu|J| \sup_I \frac{1}{|I|} \int_I |F|.$$
Then we have bounds
$$\lesssim \sum_{\substack{J \in \mathcal J\\J \subset CI_T}} \mu \int_J MF \lesssim \mu \int_{CI_T} MF \lesssim \mu|I_T|^{-1/2}||MF||_2 \lesssim \mu|I_T|^{-1/2}||F||_2 \lesssim |I_T|^{-1/2}\sqrt{\sum_{P \in T} |\langle f, \phi_P\rangle|^2 }.$$
But by the definition of energy,
$$\sum_{P \leq P_*} |\langle f, \phi_P\rangle|^2 \leq \varepsilon^2 |I_{P^*}|$$
for any $P_* \in T$.
We break up $T$ into its connected components, for which their tops $P_*$ have $I_{P^*}$ are almost disjoint.
In particular,
$$\sum_{P \in T} |\langle f, \phi_P\rangle|^2 \leq \varepsilon^2 |I_T|.$$
This was desired.
\end{proof}

\section{Proof of Carleson's theorem, part IV: Decomposition into trees}
Let $\mathcal P$ be an arbitrary finite collection of tiles.
We want to decompose $\mathcal P$ into finitely many \dfn{forests}; i.e. disjoint unions of trees, as efficiently as you can.
\begin{definition}
Given a finite set $\mathcal P$ of tiles, let
$$\Energy \mathcal P = \sup_T |I_T|^{-1/2} \sqrt{\sum_{P \in T} |\langle f, \phi_P\rangle|^2}$$
where $T$ ranges over all $+$-trees $\subseteq P$ and
$$\Mass \mathcal P = \sup_{P \in \mathcal P} \sup_{P' \geq P} |I_{P'}|^{-1} \int_{E_{P'}} \chi_{I_{P'}}^{10}$$
where
$$E_{P'} = \{x \in E: N(x) \in \omega_{P'}\}.$$
By convention $\Energy \emptyset = \Mass \emptyset = 0$.
\end{definition}
TODO: Tree estimate
\begin{lemma}[energy selection]
Let $\mathcal P$ be a finite set and
$$\Energy \mathcal P \leq \varepsilon.$$
Then there is a forest $\mathcal T$ of disjoint subtrees $T$ of $\mathcal P$ such that
$$\sum_{T \in \mathcal T} |I_T| \lesssim \varepsilon^{-2} ||f||_2^2$$
and a remainder set $\mathcal P'$ such that
$$\Energy \mathcal P' \leq \varepsilon/2.$$
\end{lemma}
\begin{lemma}[mass selection]
Let $\mathcal P$ be a finite set and
$$\Mass \mathcal P \leq \mu.$$
Then there is a forest $\mathcal T$ of disjoint subtrees $T$ of $\mathcal P$ such that
$$\sum_{T \in \mathcal T} |I_T| \lesssim \mu^{-1}|E|$$
and a remainder set $\mathcal P'$ such that
$$\Mass \mathcal P' \leq \mu/2.$$
\end{lemma}
We will prove the above two lemmata later.
Suppose that $||f||_2$ and $|E|$ are nonzero. Then given $\mathcal P_n$ such that
$$\Energy \mathcal P_n \leq 2^{-n/2} ||f||_2$$
and
$$\Mass \mathcal P_n \leq 2^{-n}|E|$$
then we can partition $\mathcal P_n$ into a forest $\mathcal T_n$ with
$$\sum_{T \in \mathcal T_n} |I_T| \lesssim 2^n$$
and a remainder $\mathcal P_{n+1}$ which keeps the induction going.
Thus for any finite set $\mathcal P = \mathcal P_{-N}$, $N$ chosen sufficiently large, we can write
$$\mathcal P = \bigcup_n \bigcup_{T \in \mathcal T_n} T \cup \mathcal P_{-\infty}$$
where $\mathcal P_{-\infty}$ is devoid of mass and energy.
Then TODO, this decomposition proves the claim.
\begin{proof}[Proof of mass selection]
Let $\mathcal P_1$ be the set of all tiles $P'$ with $P' \geq P$ for some $P \in \mathcal P$ and
$$|I_{P'}|^{-1} \int_{E_{P'}} \chi_{I_{P'}}^{10} > \mu/2$$
so the tiles in $\mathcal P_1$ cannot be put in the remainder (i.e. \dfn{heavy} or \dfn{not light}). Let $\mathcal P_*$ be the set of maximal heavy tiles. Then every tile is light or under a tile in $\mathcal P_*$.
So if $\mathcal T$ is the forest of all trees in $\mathcal P$ of $P \leq P_*$, $P_* \in \mathcal P$ we have a partition
$$\mathcal P = \mathcal P' \cup \bigcup_{T \in \mathcal T} T.$$
Here $\Mass \mathcal P' \leq \mu/2$. We must then show
$$\sum_{T \in \mathcal T} \lesssim \frac{|E|}{\mu}.$$
Note that the $T$ are almost disjoint. TODO: Prove this.
\end{proof}
\begin{proof}[Proof of energy selection]
We need to isolate the high-energy trees in $\mathcal P$. We run the following algorithm:
\begin{enumerate}
\item Initialize $\mathcal T = \mathcal T_+ = \emptyset$ and $\mathcal P' = \mathcal P$.
\item If $\Energy \mathcal P' \leq \varepsilon/2$ then halt.
\item Since $\Energy \mathcal P' > \varepsilon/2$, $\mathcal P'$ contains a $+$-tree $T_+$ such that
$$\sum_{P \in T_+} |\langle f, \phi_P\rangle|^2 > \varepsilon^2|I_{T_+}|/4.$$
Choose $T_+$ such that the midpoint of $\omega_{T_+}$ is minimal. Add $T_+$ to $\mathcal T_+$.
\item Let
$$T = \{P \in \mathcal P': P \leq P_{T_+}\}$$
be the largest tree in $\mathcal P'$ generated by elements of $T_+$. Remove $T$ from $\mathcal P'$ and add $T$ to $\mathcal T$.
\item Let
$$T^\pm = \{P \in \mathcal P': P \leq P_{T_+} \pm (|I_{T_+}|, 0)$$
be the adjacent trees to $T$. Remove $T^\pm$ from $\mathcal P'$ and add $T^\pm$ to $\mathcal T$.
\end{enumerate}
Since $\mathcal P$ is finite the above algorithm halts. When it halts we have $\Energy \mathcal P' \leq \varepsilon/2$ and for every $T_+ \in \mathcal T_+$,
$$\sum_{P \in T_+} |\langle f, \phi_P\rangle|^2 \sim \varepsilon^2 |I_{T_+}|.$$
We want to show
$$\sum_{T_+ \in \mathcal T_+} |I_{T_+}| \lesssim \varepsilon^{-2} ||f||_2^2$$
and by output of the algorithm it follows that we must show
$$\sum_{P \in \bigcup \mathcal T_+} |\langle f, \phi_P\rangle|^2 \lesssim ||f||_2^2.$$
We already know that $\mathcal T_+$ is disjoint.
\begin{lemma}
If $P \in T_+ \in \mathcal T_+$, $P' \in T_+' \in \mathcal T_+$ and $\omega_{P_-} \subset \omega_{P_-'}$ then $I_{P'}$ is disjoint from $3I_{T_+}$.
\end{lemma}
\begin{proof}
Suppose $\omega_{P_-} \subset \omega_{P_-}'$ and $I_{P'} \subset 3I_{T_+}$. Then there are three cases TODO
\end{proof}
TODO

\end{proof}



\part{Partial differential equations}
\chapter{Scattering theory}
Recall that the wave operator is
$$\Box = \partial_t^2 + \Delta$$
where $\Delta$ is the positive-definite Laplacian. Consider solutions to the wave equation $\Box u = 0$, where $u$ is defined on a spacetime slab $\Omega \times \RR$ where $\Omega \subset \RR^d$ is compact.
We can solve the wave equation because in this case $\Delta$ has a compact inverse, hence a discrete spectrum
$$\lambda_1 \leq \lambda_2 \leq \cdots \to \infty$$
with an orthonormal basis of eigenfunctions $u_j$ and hence
$$u(t, x) = \sum_j a_j e^{-it\lambda_j} u_j(x).$$
That was kind of easy but we are interested in the opposite problem of this: solving the wave equation on the complement of $\Omega$.
The intuition is that the waves are hitting the object $\Omega$ and bouncing off.
In this case $\Delta$ does not have eigenvalues but instead has a continuous spectrum.
Still we want to approximate a solution $u$ by
$$u(t, x) \approx \sum_j e^{-it\lambda_j} u_j(x)$$
where $\lambda_j$ are ``resonances" and $u_j$ are ``eigenfunctions", and the sum ``converges on compact sets as $t \to \pm \infty$".
The intuition is that $\Re \lambda_j$ gives the frequency and $-\Im \lambda_j$ gives the rate of decay.

\section{One spatial dimension}
Instead of a strict barrier for now we will work with a potential (rather than simply a barrier), thus we are interested in the quantum Hamiltonian
$$P_V = D^2 + V$$
where $D = -i\partial$ on $\RR$ and $V \in L^\infty(\RR)$ has compact support.
We want to solve
$$(P_V - \lambda^2)u = f$$
where $f \in L^2(\RR)$ but we do not assume $u \in L^2(\RR)$.
We assume $\supp V, \supp f$ are compact subsets of $(-R, R)$ for some $R > 0$.
Thus if $|x| > R$, $u$ is a linear combination of the outgoing solutions
$$
u(x) = \begin{cases}
a_- e^{-i\lambda x}, &x<-R\\
a_+ e^{i\lambda x}, &x>R
\end{cases}
$$
and the incoming solutions
$$
u(x) = \begin{cases}
b_- e^{i\lambda x}, &x<-R\\
b_+ e^{-i\lambda x}, &x>R
\end{cases}
$$
where we take the convention that $\arg \lambda \in [0, \infty)$.

It follows that if $u$ is outgoing and $\Im \lambda > 0$ then $u$ decays exponentially, and hence $u \in L^2(\RR)$.
Thus $\lambda$ is an eigenvalue in this case, if $f = 0$.

We start with the case $V = 0$. We will use the Fourier transform to invert $D_x^2 - \lambda^2$. The resolvent has Schwartz kernel
$$R_0(\lambda; x, y) = \frac{i}{2\lambda} e^{i\lambda|x-y|}$$
which is valid when $\Im \lambda > 0$.
Now if we take an analytic continuation of $R_0$ we will not get the inverse of $D_x^2 - \lambda^2$ since then $R_0$ would reflect around $\RR$, which holomorphic functions cannot do.

\begin{theorem}
The free resolvent $R_0$ extends to a meromorphic family of operators
$$R_0(\lambda): L^2_{comp} \to L^2_{loc}$$
such that if $\Im \lambda > 0$,
$$||R_0(\lambda)||_{L^2 \to L^2} = d(\lambda^2, [0, \infty))^{-1} \leq (|\lambda| \Im \lambda)^{-1}.$$
Moreover, if $\rho$ is a cutoff for a compact subset of $(-L, L)$ and $j \leq 2$,
$$||\rho R_0(\lambda) \rho||_{L^2 \to H^j} \lesssim e^{2L\Im \lambda_-}|\lambda|^{-1}\langle\lambda\rangle^j.$$
\end{theorem}
\begin{proof}
The Schwartz kernel extends meromorphically to the function
$$R_0(\lambda; x, y) = \frac{i}{2\lambda}e^{i\lambda|x-y|}.$$

Since the Fourier transform is unitary, if $\Im \lambda > 0$ and hence $u \in L^2$,
$$||R_0(\lambda)u||_2 = ||\hat u/|\xi^2 - \lambda^2|||_2 \leq ||u||_2/d(\lambda^2, [0, \infty)).$$
In general we use Schur's test. The estimate for $H^0 = L^2$ follows from the estimate
$$\int_{-\infty}^\infty |\rho(x)\rho(y)R_0(\lambda;x,y)|~dx = |\lambda|^{-1}\int_{-\infty}^\infty |\rho(x)\rho(y)|e^{-\Im \lambda|x-y|}~dx \leq |\lambda|^{-1}e^{2L(\Im \lambda)_-}.$$
The estimate for $H^2$ is just the Schauder estimate. Now interpolate to get it for $j \in (0, 2)$.
\end{proof}

\begin{theorem}
Let $V \in L^\infty_{comp}(\RR \to \CC)$. Then
$$R_V(\lambda) = (P_V - \lambda^2)^{-1}$$
extends to a meromorphic family of operators
$$R_V(\lambda): L^2_{comp} \to H^2_{loc}$$
and if $\Im \lambda > 0$ then $R_V(\lambda)$ sends $L^2 \to L^2$, with finitely many poles as exceptions.
\end{theorem}
\begin{proof}
First suppose $\Im \lambda$ is sufficiently large. We start by finding an approximate inverse to $D^2 + V - \lambda^2$, namely
$$(P_V - \lambda^2)R_0(\lambda) = 1 + VR_0(\lambda)$$
but
$$||VR_0(\lambda)||_{L^2 \to L^2} = \frac{||V||_\infty}{(\Im \lambda)^2} < 1.$$
So we can use Neumann series to write
$$(1 + VR_0(\lambda))^{-1} = \sum_j (-1)^j (VR_0(\lambda))^j$$
which converges in operator norm, and
$$R_V(\lambda) = R_0(\lambda)(1 + VR_0(\lambda))^{-1}.$$

Now choose $\rho$, a cutoff function with compact support in $(-L, L)$, such that $\rho = 1$ on $\supp V$.
Then
$$\rho R_0(\lambda) \in B(L^2(\RR) \to H_{comp}^2(-L, L)).$$
By the Rellich-Kondrachov theorem, $H^2(\RR)$ embeds compactly into $L^2(\RR)$, so $\rho R_0(\lambda) \in B_0(L^2(\RR))$, $B_0$ the compact $C^*$-algebra functor.
Therefore we may invoke the Fredholm alternative to see that $1 + VR_0(\lambda) = 1 + V \rho R_0(\lambda)$ is a Fredholm operator of index $0$.
(The second condition follows from traveling along the line $1 + t V\rho R_0(\lambda)$, where $t \in [0, 1]$, and using the fact that the function that sends a Fredholm operator to its index is continuous, hence constant on connected components of the space Fred$(L^2)$, with the operator norm.)
We now pause the proof to recall the analytic Fredholm theorem.
\end{proof}

\begin{theorem}[analytic Fredholm theorem]
Let $\Omega \subseteq \CC$ be connected and $A$ be a holomorphic family of Fredholm operators on $\Omega$ of index $0$. If $z_0 \in \Omega$ and $A(z_0)^{-1}$ exists, then $A^{-1}$ is a meromorphic family of operators.
\end{theorem}
\begin{proof}
Let $z_1 \in \Omega$. If $A(z_1)$ is invertible then we have
$$\partial_z(A(z)^{-1}) = -A(z)^{-1}\partial_zA(z)A(z)^{-1}$$
close to $z$. Otherwise, let $u(z) = \dim \ker A(z)$. Consider the \dfn{Grushin operator}
$$\tilde A(z) = \begin{bmatrix}A(z)&A_-\\A_+&0\end{bmatrix}.$$
Here if $(e_1, \dots, e_n)$ are an orthonormal basis of $\ker A(z_1)$ and $(f_1, \dots, f_n)$ are an orthonormal basis of $\ker A(z_1)^*$, then
$$A_+(u) = \begin{bmatrix}
\langle u, e_1\rangle \\ \vdots \\ \langle u, e_n \rangle
\end{bmatrix}$$
and $A_-(u)(v_1, \dots, v_n) = \sum_j v_j f_j$.
Then $\tilde A$ is invertible near $z_1$. But
$$\tilde A(z)^{-1} = \begin{bmatrix}B(z)&B_+(z)\\B_-(z)&B_\mp(z)\end{bmatrix}$$
and so $A$ is invertible iff $B_\mp$ is, since
$$A(z)^{-1} = B(z) - B_+(z)B_\mp(z)^{-1}B_-(z).$$
By construction $B_\pm$ is a meromorphic family of matrices. Thus its determinant has finitely many poles and zeroes. This means that $A^{-1}$ exists except at finitely many points.
\end{proof}

\begin{proof}[Proof of meromorphic continuation continued]
By the above we see that $(1 + VR_0(\lambda))^{-1}$ is a meromorphic family of operators, and if $\Im \lambda > 0$ then
$$R_V(\lambda) = R_0(\lambda)(1 + VR_0(\lambda))^{-1}$$
carries $L^2$ to itself.

The trouble is that we may get blowup if $\Im \lambda \leq 0$. Let
$$K(\lambda) = VR_0(\lambda).$$
Then $\rho K \rho$ is a meromorphic family of operators, so we think of $K$ as a ``meromorphic family" up to a cutoff.
So
$$(1 + K(\lambda)(1-\rho))^{-1} = 1 - K(\lambda)(1 - \rho)$$
so
$$(1 + K(\lambda))^{-1} = (1 + K(\lambda)\rho)^{-1}(1 + K(\lambda)(1 - \rho))$$
and the Rellich-Kondrachov theorem and analytic Fredholm theorem show that we have an extension to $\Im \lambda \leq 0$.

Finally, we recall that
$$||K(\lambda)\rho||_{L^2 \to L^2} \lesssim |\lambda|^{-1}$$
which means that $1 + K_V(\lambda)\rho$ is invertible if $|\lambda|$ is large and $\Im \lambda > 0$ so
$$R_V(\lambda) = R_0(\lambda)(1 + K_V(\lambda)\rho)^{-1}(1 - K(\lambda)(1 - \rho))$$
exists. Thus the set of poles in the upper-half plane is compact, but discrete by holomorphy, hence finite.
\end{proof}

\begin{definition}
A pole of $R_V(\lambda)$ is called a \dfn{scattering resonance}. The \dfn{multiplicity} $m_R(\lambda)$ of $\lambda$ is the rank of $\oint_\lambda R_V(\zeta)~d\zeta$.
\end{definition}

We now interpret the scattering resonances by using them to solve the Helmholtz equation.
\begin{theorem}
If $\lambda$ is not a scattering resonance and $f \in L^2_{comp}(\RR)$ then
$$(P_V - \lambda^2)u = f$$
has a unique outgoing solution $u = R_V(\lambda)f$.
\end{theorem}
\begin{proof}
Clearly this works if $\Im \lambda$ is sufficiently large since we defined $R_V(\lambda)$ to be the inverse of $P_V - \lambda^2$ there.
But then we can use analytic continuation to extend this to all of $\CC$.

To check uniqueness, write
$$u = u_0 + \chi_+ u_+ e^{i\lambda \cdot} + \chi_- u_- e^{-i\lambda \cdot}$$
where $\chi_\pm$ are cutoffs close to $\pm \infty$, $u_0$ has compact support and hence is in $L^2$, and $u_\pm$ are coefficients.
Then we can check uniqueness for each of those terms.
\end{proof}

\begin{theorem}
If $\lambda_0 \neq 0$ is a scattering resonance and $m_R(\lambda_0) > 0$ then there is an outgoing $u_1$ with
$$(P_V - \lambda_0)u_1 = 0$$
called a \dfn{resonant state}.
\end{theorem}
\begin{proof}
For notational simplicity we check when $m_R(\lambda) = 1$. Then
$$R_V(\lambda) = (\lambda - \lambda_0)^{-1}B_1 + B_0(\lambda)$$
for some operators $B_0,B_1$ where $B_1$ has finite rank. But
$$I - B_0(\lambda) = (\lambda - \lambda_0)^{-1}(P_V - \lambda_0^2)B_1$$
and the only way this is possible is if both sides are holomorphic, so that $(P_V - \lambda_0^2)B_1 = 0$. Thus we can solve the equation.
\end{proof}
Here the assumption $m_R(\lambda_0) > 0$ means that $\lambda_0$ is not a double pole.

We now study where the resonances are. If $V$ is real-valued then $P_V$ is self-adjoint.
\begin{lemma}
If $V$ is real and $\Im \lambda > 0$, $\lambda$ a resonance, then $\lambda$ is an eigenvalue and $\lambda = ir$, $r > 0$.
\end{lemma}
\begin{proof}
We have
$$u(x) = c_\pm e^{\pm i\lambda x}$$
and $u \in L^2$ so $\lambda^2$ is an eigenvalue. Since $P_V$ is self-adjoint, $\lambda^2 \in \RR$.
\end{proof}

\section{Resonance expansion in 1D}
On a compact domain we can write the solution of a PDE as sum of eigenfunctions.
But we are working on a cocompact domain, so the best we can do is an asymptotic sum.
Throughout, assume $V \in L^\infty(\RR \to \RR)$. This way we can use spectral theory for self-adjoint operators.

As a review, consider the eigenvalue problem
$$P_Vu = \lambda^2u$$
on $(a, b)$ where $u(a) = u(b) = 0$.
Here $P_V$ has discrete spectrum so we might hope to use its eigenvalues to find a generalized Fourier expansion of $u$.
So now consider the wave equation
$$D_t^2w - P_Vw = 0$$
on $\RR \times (a, b)$. Then one has an explicit solution depending on initial data which is given by a Fourier series plus a polynomial in $\cosh,\sinh$. This was possible because $[a, b]$ is compact.

Now for the cocompact case.
\begin{theorem}
Suppose that
$$(D_t^2 - P_V)w = 0$$
where $w(0) = w_0 \in H^1_{comp}$ and $\partial_tw(0) = w_1 \in L^2_{comp}$ are initial data.
Then for any $A > 0$ we can write
$$w(t, x) = \sum_{\Im \lambda_j > -A} \sum_{\ell=0}^{m_R(\lambda_j) - 1} t^\ell e^{-i\lambda_jt}f_{j,\ell}(x) + E_A(t, x)$$
where the sum is finite, $(P_V - \lambda_j^2)^{\ell + 1}f_{j,\ell} = 0$,
$$\sum_{\ell=0}^{m_R(\lambda_j) - 1} t^\ell e^{-i\lambda_jt}f_{j,\ell}(x) = -\Res_{\mu=\lambda_j} iR_V(\mu)w_1 + \mu R_V(\mu)w_0e^{-i\mu t},$$0
and if $K > 0$, $\supp w_j \subseteq (-K, K)$,
$$||E_A(t)||_{H^2[-K, K]} \leq C_{K,A} e^{-tA}(||w_0||_{H^1} + ||w_1||_{L^2})$$
if $t > T_{K,A}$ is large enough.
\end{theorem}
The proof of this is quite tedious but follows from the following result and a change of contour.
\begin{theorem}
Suppose that $V \in L^\infty_{comp}(\RR \to \CC)$. Then if $\rho \in C^\infty_{comp}$ and $|\ch\supp V| \delta < 1$, then there are $A,C,T$ such that
$$||\rho R_V(\lambda) \rho||_{L^2 \to H^j} \leq C|\lambda|^{j-1}e^{T(\Im \lambda)_-}$$
if $\Im \lambda \geq -A -\delta \log(1 + |\lambda|)$.
\end{theorem}
\begin{proof}
If $\rho_1$ has support in $[a, b]$ then by a previous estimate we have
$$||\rho_1 R_0(\lambda) \rho_1||_{L^2 \to L^2} \leq C|\lambda|^{-1}e^{(b-a)|\Im \lambda|}$$
but since
$$\rho R_V(\lambda) \rho = \rho R_0(\lambda) \rho_1 (1 + VR_0(\lambda))\rho)^{-1} (1 - VR_0(\lambda)(1 - \rho_1))\rho$$
where $\rho = 1$ on $\supp V$ and $\rho_1$ is a smooth approximation to $1_{\ch \supp V}$.
We claim that
$$||V \rho_1 R_0(\lambda) \rho_1||_{L^2 \to L^2} < 1/2.$$
In fact if we put $[a, b] = \ch \supp V$, then
$$||V \rho_1 R_0(\lambda) \rho_1||_{L^2 \to L^2} \leq C||V||_\infty e^{(b-a)|\Im \lambda|}/|\lambda|.$$
If $\delta < 1/(b-a)$, $\Im \lambda > -A -\delta \log(1 + |\lambda|)$, and $|\lambda|$ is large enough then the bound is $< 1/2$.
Thus $1 + V \rho_1 R_0(\lambda) \rho_1$ is invertible.
\end{proof}

Now suppose that $\ch \supp V$ is contained in $[-R + \varepsilon, R - \varepsilon]$.
Then away from $[-R, R]$ we have for eigenfunctions of eigenvalue $\lambda^2$,
$$u(x) = u_{in}(x) + u_{out}(x)$$
where
$$u_{in}(x) = b_{\sgn x} e^{-i\lambda|x|}$$
and
$$u_{out}(x) = a_{\sgn x} e^{i\lambda|x|}.$$
Let $S(\lambda)$ be the \dfn{scattering matrix}, the linear map $(b_-, b_+) \mapsto (a_+, a_-)$.
We will consider solutions of the form
$$u^\pm(x) = e^{\pm i\lambda x} + v^\pm(x, \lambda)$$
where $v^\pm(\lambda)$ is outgoing. Then
$$v^\pm(x, \lambda) = -R_V(\lambda)(V(x)e^{\pm i\lambda x})$$
Now let
$$v^\pm_{\sgn x}(\lambda) = e^{-i\lambda|x|}v^\pm(x, \lambda)$$
then
$$S(\lambda) = 1 + A(\lambda)$$
where
$$A(\lambda) = \begin{bmatrix}v^+_+(\lambda) & v_+^-(\lambda)\\ v_-^+(\lambda) & v_-^-(\lambda)\end{bmatrix}.$$

\begin{theorem}
The function $A$ is a meromorphic function given by
$$v^\omega_\theta(\lambda) = \frac{1}{2i\lambda} \int_{-\infty}^\infty e^{i\lambda(\omega - \theta)x}V(x)(1-e^{-i\lambda\omega x})R_V(\lambda)(e^{i\lambda\omega x}V(x))~dx.$$
Moreover if
$$E_\rho(\lambda): L^2(\RR) \to \CC^2$$
is the operator
$$E_\rho(\lambda)u = \left(\int_{-\infty}^\infty e^{-i\lambda x}u(x)\rho(x)~dx , \int_{-\infty}^\infty e^{i\lambda x}u(x)\rho(x) ~dx \right)$$
where $\rho V = V$ then
$$S(\lambda) = 1 + \frac{1}{2i\lambda}E_\rho(\lambda)(1 + VR_0(\lambda)\rho)^{-1} V E_\rho(\overline \lambda)^*.$$
\end{theorem}
The proof of this is just symbol-bashing.

Note that the \dfn{transmission coefficient} is $t(\lambda) = 1 + v^+_+$ and $r_\pm(\lambda) = v^\mp_\pm(\lambda)$ are the \dfn{reflection coefficients}. Moreover we have
$$S(-\lambda) = JS(\lambda)^{-1}J$$
where $J = \begin{bmatrix}&1\\1\end{bmatrix}$.
If $V$ is real and $\lambda \neq 0$ is real then $S(\lambda)$ is unitary.
Thus if $V$ is real meromorphic continuation gives
$$S(\overline \lambda)^* = S(\lambda)^{-1}.$$
In particular $v_\theta^\omega$ is holomorphic in a neighborhood of $\RR$.
\begin{theorem}
If $\Im \lambda \geq 0$ and $|\lambda|$ is large enough then
$$||e^{\mp i \lambda x}R_V(\lambda)(V(x)e^{\pm i\lambda x})||_{L^2 \to L^2} \lesssim |\lambda|^{-1}.$$
\end{theorem}
In particular,
$$v_+^+(\lambda) = \frac{1}{2i\lambda}(\hat v(0) + O(|\lambda|^{-1})).$$
\begin{proof}
The integral kernel of
$$R_0^\omega(\lambda) = e^{-i\lambda\omega x}R_0(\lambda)(e^{i\lambda\omega\cdot})$$
is
$$R_0^\omega(\lambda, x, y) = e^{-i\lambda\omega x}R_0(\lambda, x, y)e^{i\lambda\omega y} = \frac{i}{2\lambda}e^{i\lambda(|x-y|-\omega(x-y))}.$$
As $|x - y| \geq \omega(x-y)$,
$$||VR_0^\omega(\lambda)\rho||_{L^2 \to L^2} \lesssim \frac{1}{|\lambda|}$$
if $\Im \lambda \geq 0$.

Thus if $\Im \lambda \geq 0$ and $|\lambda|$ is large, $1 + VR_0^\omega(\lambda)\rho$ is invertible.
Similarly $||R_0^\omega(\lambda)\rho||_{L^2\to L^\infty} \lesssim |\lambda|^{-1}$ and hence $1 + R_0^\omega(\lambda)\rho$ is invertible. This justifies the estimates on the integral kernel.
\end{proof}

\begin{theorem}
Suppose that $\rho V = V$ and $D(\lambda) = \det(1 + VR_0(\lambda)\rho)$. Then
$$\frac{\det D(-\lambda)}{D(\lambda)} = \det S(\lambda).$$
\end{theorem}
This follows from a straight computation and standard determinant identites.


\section{Meromorphic continuation in odd dimensions}
We first consider the free resolvent. Here $n \geq 3$ is odd.

The free resolvent is
$$R_0(\lambda) = (-\Delta - \lambda^2)^{-1}$$
which sends $L^2 \to L^2$ when $\Im \lambda > 0$.
The Fourier multiplier of $R_0(\lambda)$ is
$$\frac{1}{|\xi|^2 - \lambda^2} = \int_0^\infty \frac{\sin t|\xi|}{|\xi|} e^{i\lambda t} ~dt.$$
Let
$$U(t) = \frac{\sin t\sqrt{-\Delta}}{\sqrt{-\Delta}}$$
as defined by the functional calculus. Then
$$R_0(\lambda) = \int_0^\infty e^{i\lambda t} U(t) ~dt.$$
Here $U$ is the propogator of the wave equation. In fact if $(\varphi_0, \varphi_1)$ is initial data for the wave equation, thus $u(0) = \varphi_0$, $u'(0) = \varphi_1$, then
$$u(t, x) = U(t)\varphi_1(x) + \partial_tU(t) \varphi_0(x)$$
solves the wave equation $\Box u = 0$.

Let $E_+$ be the fundamental solution of the wave equation. We have the strong Huygens principle,
$$\supp E_+ = \{(x, t): |x| = |t|, ~t \geq 0\}.$$
One can explicitly compute $E_+$ (see Evans' book) and then
$$U(t, x, y) = E_+(t, x - y)$$
if $t \geq 0$.
\begin{theorem}
The resolvent $R_0$ expands to an entire family of operators, and if $\rho$ is a cutoff then
$$||\rho R_0(\lambda) \rho||_{L^2 \to H^j} \lesssim (1 + |\lambda|)^{j-1} e^{L(\Im \lambda)_-}$$
for any $L$ larger than the diameter of $\supp \rho$ and $j \leq 2$.
\end{theorem}
\begin{proof}
If $\Im \lambda > 0$ then
$$\rho R_0(\lambda) \rho = \int_0^L e^{i\lambda t}\rho U(t)\rho~dt.$$
The right-hand side is an entire family of operators on $L^2$.

Now the Fourier multiplier satisfies
$$\frac{\sin t|\xi|}{|\xi|} \leq |t|.$$
Thus
$$||U(t)||_{L^2 \to H^1} \lesssim ||U(t)||_{L^2 \to L^2} + ||\sqrt{-\Delta}U(t)||_{L^2 \to L^2} \lesssim 1 + |t|.$$
Thus
$$||\rho R_0(\lambda) \rho||_{L^2 \to H^1} \leq \int_0^L e^{(\Im \lambda)_- t}(1 + |t|) ~dt \leq (1 + L^2)e^{L(\Im \lambda)_-} \lesssim e^{L(\Im \lambda)_-}.$$
One can use this to bootstrap an argument up to $H^2$.
\end{proof}
We now have
$$R_0(\lambda, x, y) = \frac{1}{(2\pi)^n} \int_{\RR^n} \frac{e^{i(x-y)\xi}}{|\xi|^2 - \lambda^2}~d\xi
= \frac{1}{(2\pi)^n} \int_0^\infty \int{\SS^{n-1}} \frac{e^{ir\omega(x-y)}}{r^2 - \lambda^2}~d\omega r^{n-1}~dr.$$
We conclude that
$$R_0(\lambda, x, y) = e^{i\lambda|x-y|}{|x-y|^{n-2}} P_n(\lambda|x-y|).$$
Here $P_n$ is a polynomial of degree $(n-3)/2$ of leading term $k^{(n-3)/2}{4\pi(2\pi i)^{(n-3)/2}}$ and constant term $(n-3)!/(\pi^{(n-1)/2})$. In particular, if $n = 3$ then
$$R_0(\lambda, x, y) = \frac{e^{i\lambda|x-y|}}{4\pi|x-y|}.$$
\begin{theorem}
If $\varphi$ is a compactly supported distribution then
$$R_0(\lambda)\varphi(r\omega) = e^{i\lambda r}r^{-(n-1)/2}h(r, \omega)$$
where
$$h(r, \omega) \sim \sum_{j=0}^\infty h_j(\omega)r^{-j}$$
as $r \to \infty$ and
$$h_0(\omega) = \frac{1}{4\pi}\frac{\lambda}{2\pi i}^{(n-3)/2}\hat \varphi(\lambda\omega).$$
\end{theorem}
\begin{proof}
We have
$$|r\omega - y| = r\sqrt{1 - 2r^{-1}\omega y + r^{-2}|y|^2} \approx r - \omega y + \dots$$
and similarly when we take both sides to the $-p$th power.
Now use the previous theorem.
\end{proof}

We now invert the operator $P_V - \lambda^2$. Here $P_V = V - \Delta$. Let
$$R_V(\lambda) = (P_V - \lambda^2)^{-1}.$$
\begin{theorem}
$R_V$ is meromorphic with finitely many poles in the upper-half plane. It extends to a meromorphic family of operators $L^2_{comp} \to L^2_{loc}$ on $\CC$.
\end{theorem}
\begin{proof}
The proof is the same as in one dimension. We use the formula
$$R_V(\lambda) = R_0(\lambda)(1 + VR_0(\lambda)\rho)^{-1}(1 - VR_0(\lambda)(1 - \rho)).$$
\end{proof}

As before scattering resonances are the poles of $R_V$. Their multiplicity is given by the dimension of the space
$$A_1(L^2_{comp}) + \cdots + A_J(L^2_{comp})$$
where
$$R_V(\zeta) = \sum_{j=1}^J \frac{A_J}{(\zeta - \lambda)^j} + A(\zeta - \lambda)$$
for $|\zeta - \lambda|$ small.
\begin{theorem}
If $\mu$ is a nonzero resonance of positive multiplicity $m_V(\mu)$, then for some $K(\mu) \leq m_V(\mu)$,
$$R_V(\lambda) = -\sum_{k \leq K(\mu)} \frac{(P_V - \mu^2)^{k-1}}{(\lambda^2 - \mu^2)^k} \Pi_\mu + A(\lambda, \mu)$$
where
$$\Pi_\mu = -\frac{1}{2\pi i}\oint_\mu R_V(\lambda)2\lambda~d\lambda$$
is the projection onto the kernel of $(P_V - \mu^2)^{K(\mu)}$.
\end{theorem}
\begin{proof}
Define $\Pi_\mu = A_1$. Without loss of generality we can assume $A = 0$. Then
$$A_{k+1} = (P_V - \mu^2)A_k $$
so $(P_V - \mu^2)^{K(\mu)}\Pi_\mu = 0$.
Since $\Pi_\mu$ has finite rank, one can use Jordan canonical form to show $K(\mu)$ is less than the rank of $\Pi_\mu$.
But by the expansion formula for $R_V$ we know that $m_V(\mu)$ is the rank of $\Pi_\mu$.
\end{proof}
\begin{theorem}
A nonzero complex number $\lambda_0$ is a resonance iff there is a nonzero $\varphi \in L^2_{comp}$ such that if $u = R_0(\lambda_0)\varphi$, then $(P_V - \lambda_0^2)u = 0$.
\end{theorem}
\begin{proof}
One has
$$0 = (P_V - \lambda_0^2)R_0(\lambda_0)\varphi = (1 + VR_0(\lambda_0))\varphi = (1 + VR_0(\lambda)(1 - \rho))(1 + VR_0(\lambda_0)\rho)\varphi.$$
Since $1 + VR_0(\lambda_0)(1 - \rho)$ is invertible this implies that $1 + VR_0(\lambda_0)\rho$ has nontrivial kernel, so $(1 + VR_0(\lambda_0)\rho)^{-1} = \infty$.

Conversely we use
$$R_V(\lambda) = R_0(\lambda) - R_0(\lambda)VR_V(\lambda)$$
and using the expansion of $R_V(\lambda)$ in terms of the projector $\Pi_{\lambda_0}$ we have
$$-(P_V - \lambda_0^2)^{K-1}\Pi_{\lambda_0} = R_0(\lambda_0)V(P_V - \lambda_0^2)^{K-1}\Pi_{\lambda_0}.$$
Suppose that
$$(P_V - \lambda_0^2)^{K-1}\Pi_{\lambda_0}\psi$$
is nonzero, and let
$$\varphi = V(P_V - \lambda_0^2)^{K-1}\Pi_{\lambda_0}\psi \in L^2_{comp}.$$
Since $\Pi_{\lambda_0}$ projects onto the kernel, $R_0(\lambda_0)\varphi \in \ker(P_V - \lambda_0^2)$.
\end{proof}

\section{Counting resonances}
Recall that if $X$ is a compact Riemannian $n$-manifold then the operator $V - \Delta$ has discrete spectrum on $X$, and Weyl's law gives a bound
$$\sim c_n |X| r^n$$
on the cardinality of the set of eigenvalues of $V - \Delta$ of norm $\leq r$ and $|X|$ is the volume of $X$.
We now generalize this to cocompact domains.

\begin{theorem}
Let $n \geq 3$, odd, $V \in L^\infty_c(\RR^n \to \CC)$. Then
$$\sum_{|\lambda| \leq r} \lesssim r^n.$$
\end{theorem}
\begin{proof}
Let $\rho$ be a cutoff and
$$H_V(\lambda) = \det(1 - (VR_0(\lambda)\rho)^{n+1}).$$
For this definition to make sense we need $(VR_0(\lambda)\rho)^p$ to be in the trace class when $p = n + 1$, and in fact we can prove it when $2p > n + 1$.

Recall that if $(s_j(A))_j$ is a decreasing enumeration of the singular values of the compact operator $A$ then $s_{j+k}(A+B) \leq s_j(A) + s_k(B)$ and $s_{j+k}(AB) \leq s_j(A)s_k(B)$. Moreover,
$$s_j(AB),s_j(BA) \leq ||B||s_j(A).$$
It suffices to show that $(s_j(VR_0(\lambda)\rho)^p)_j \in \ell^1$.

Let $\rho_1$ be a cutoff supported in $B(0, R)$. Let $T_R = \RR^n/R\ZZ^n$. Then $\rho_1 R_0(\lambda) \rho_1$ sends $L^2(T_R)$ to itself. Then
$$s_j(\rho_1 R_0(\lambda) \rho_1) = s_j((1 - \Delta_{T_R})^{-1}(1 - \Delta_{T_R})\rho_1 R_0(\lambda)\rho_1).$$
Thus we have a bound
$$\leq s_j((1 - \Delta_{T_R})^{-1})||(1 - \Delta_{T_R})\rho_1 R_0(\lambda) \rho_1||.$$
By the Weyl law,
$$||(1 - \Delta_{T_R})^{-1}|| \lesssim j^{-2/n}.$$
Moreover,
$$||\rho_1 R_0(\lambda) \rho_1|| \lesssim ||(1 + |\lambda|)e^{R(\Im \lambda)_-}.$$
Thus
$$s_j(\rho_1 R_0(\lambda) \rho_1) \lesssim |\lambda|j^{-2/n}e^{R(\Im \lambda)_-}.$$
Thus
$$s_j((VR_0(\lambda)\rho)^p) \lesssim |\lambda|^pj^{-2p/n}\exp(O(\Im \lambda)_-).$$
This is summable and proves the claim.

Let $m_H(\lambda)$ be the multiplicity of a zero of $H(\lambda)$. Then
$$m_R(\lambda) \leq m_H(\lambda).$$
To see this, we first check when $m_R(\lambda) \leq 1$. In fact, if there is a double pole of $R_V$, then there is a finite-rank perturbation of $R_V$ which has two single poles, by the content of the previous section, so the case of single poles suffices.
Since $n$ is odd,
$$1 - (VR_0(\lambda))^{n+1} = \sum_{j \leq n} (-VR_0(\lambda)\rho)^j (1 + VR_0(\lambda)\rho).$$
Now $1 + VR_0(\lambda)\rho$ can be continuously deformed to $1$ so it is a Fredholm operator of rank $0$.
It follows that $1 + VR_0(\lambda)\rho$ has nontrivial kernel, since it has nontrivial cokernel.
This implies that $H$ has a zero at $\lambda$ which was desired.

Now recall Jensen's formula, that if $H$ is holomorphic then
$$\int_0^r \frac{n(t)}{t}~dt + \log|H(0)| = \frac{1}{2\pi} \int_0^{2\pi} \log|H(re^{i\theta})|~d\theta.$$
Here $n$ is the zero-counting formula of $H$.
We have
$$H(\lambda) \leq \prod_j 1 + s_j((VR_0(\lambda)\rho)^{n+1}).$$
But
$$ s_j((VR_0(\lambda)\rho)^{n+1}) \leq ||V||_\infty^{n+1}s_{[j/(n+1)]}(\rho R_0(\lambda) \rho)^{n+1}.$$
This estimate works because singular values are decreasing.
So we want to bound $s_j(\rho R_0(\lambda) \rho)$. We have when $\Im \lambda \geq 0$
$$s_j(\rho_1 R_0(\lambda) \rho_1) \lesssim j^{-1/n}$$
and
$$s_k((VR_0(\lambda)\rho)^{n+1}) \lesssim k^{-(n+1)/n}.$$
But
$$|H(\lambda)| \leq \prod_k 1 + s_k((VR_0(\lambda)\rho)^{n+1})$$
but
$$\prod_\ell 1 + x_\ell \leq \exp \sum_\ell x_\ell$$
so
$$H(\lambda) \lesssim \exp \sum_k k^{-(n+1)/n}.$$

Now to bound when $\Im \lambda < 0$. By Stone's formula,
$$R_0(\lambda, x, y) - R_0(-\lambda, x, y) = C \lambda^{n-2} \int_{\Sphere^{n-1}} e^{i\lambda\langle \omega, x-y\rangle}~d\omega.$$
Let
$$E_\rho(\lambda, x, \omega) =\rho(x)e^{i\lambda\langle \omega, x\rangle}$$
so
$$\rho(R_0(\lambda) - R_0(-\lambda)) = C\lambda^{n-2}E_\rho(\overline \lambda)^* E_\rho(\lambda).$$
It turns out that
$$s_j(\rho R_0(\lambda) \rho) \leq C|\lambda|^{n-2}||E_\rho(\overline \lambda)||s_{[j/2]}(E_\rho(\lambda))+s_{[j/2]}(\rho R_0(-\lambda) \rho) \leq C \exp(C|\lambda|)s_{[j/2]}(E_\rho(\lambda)) + Cj^{-1/n}.$$

So we must estimate $s_j(E_\rho(\lambda))$. But
$$s_j(E_\rho(\lambda)) \leq s_j((1 - \Delta_{\Sphere^{n-1}})^{-\ell})||(1 - \Delta_{\Sphere^{n-1}})^{\ell}E_\rho(\lambda)||.$$
By the Weyl law we can bound
$$s_j((1 - \Delta_{\Sphere^{n-1}})^{-\ell}) \leq C^\ell j^{-(2\ell)/(n-1)}.$$
Pulling out the $\rho$ and then applying Cauchy estimates,
$$||(1 - \Delta_{\Sphere^{n-1}})^{\ell}E_\rho(\lambda)|| \lesssim C^\ell \exp(O(|\lambda|))(2\ell)!.$$
Therefore
$$s_j(E_\rho(\lambda)) \lesssim C^\ell j^{-(2\ell)/(n-1)}\exp(O(|\lambda|))(2\ell)!.$$
Take $\ell = (j/O(e))^{1/(n-1)}$.

Putting everything together we get
$$|H(\lambda)| \leq \exp(O|\lambda|^n).$$
\end{proof}

To see that this is only an upper bound we prove that there are potentials with no resonances at all.

\begin{theorem}
Let $k \geq 1$ be odd.
Let $(r, \theta, x')$ be cylindrical coordinates in $\RR^{k+2}$, $x_1 = r\cos\theta$, $x_2 = r\sin\theta$.
Suppose $V \in L^\infty_c(\RR^{k+2}, \CC)$, where
$$V(r, \theta, x') = e^{im\theta}W(r, x'),$$
$W \in L^\infty_c(\RR^k \times [0, \infty))$.
If $m \neq 0$ then $R_V$ is entire, so $V$ has no resonances.
\end{theorem}
\begin{proof}
Assume $R_V$ has a pole. Then
$$R_V(\lambda) = R_0(\lambda)(1 + VR_0(\lambda)\rho)^{-1}(1 - VR_0(\lambda)(1 - \rho)).$$
So $R_V$ has a simple pole iff $(1 + VR_0(\lambda)\rho)^{-1}$ has a pole.
In particular $1 + VR_0(\lambda)\rho$, which has Fredholm index $0$, has nontrivial kernel for $\lambda$ a pole. Thus there is a $u \in L^2$ such that
$$(1 + VR_0(\lambda)\rho)u = 0.$$
Thus
$$u = -V\rho R_0(\lambda)\rho u.$$
Let $\Pi_\ell$ project onto the $\ell$th Fourier mode.
We may assume that $\rho$ does not depend on $\theta$, in which case $\Pi_\ell$ commutes with $\rho R_0(\lambda) \rho$.
Thus
$$u = -e^{im\theta}W\rho R_0(\lambda)\rho u.$$
Thus
$$\Pi_{j+m}u = e^{im\theta}W\rho R_0(\lambda)\rho \Pi_j u.$$
Thus
$$||\Pi_{j+m}u||_2 \lesssim ||\rho R_0(\lambda) \rho \Pi_j u||_2.$$

We now give control over Fourier modes.
\begin{lemma}
For every $f \in L^2$,
$$||\rho R_0(\lambda)\rho \Pi_\ell f||_2 \lesssim e^{C(\Im \lambda)_-}\langle \ell\rangle^{-1}||f||_2.$$
\end{lemma}
\begin{proof}
Let $u = \rho R_0(\lambda)\rho \Pi_\ell f$. Then
$$||u||_{H^1} = ||\rho R_0(\lambda)\rho \Pi_\ell f||_{H^1} \leq Ce^{C(\Im \lambda)_-}||f||_2.$$
Moreover
$$||u||_{H^1}^2 \geq \langle -\Delta u, u\rangle.$$
In polar coordinates,
$$-\Delta = D_r^2 - iD_r/r - \Delta_{x'} + \ell^2 r^{-2}.$$
But $u$ has compact support so we can integrate by parts to get
$$\langle -\Delta u, u\rangle = \int_{\RR^k} \int_0^\infty \int_0^{2\pi} |\partial_ru|^2 + |\nabla u|^2 + \ell^2r^{-2}|u|^2~dV \geq \langle \ell^2r^{-2} u, u \rangle \gtrsim \ell^2 ||u||_2^2.$$
Thus we can bound the $L^2$ norm in terms of $H^1$ norm which has the bound that we want.
\end{proof}
We have
$$||\Pi_{j+m}u||_2 \lesssim ||\rho R_0(\lambda)\rho \Pi_j \Pi_j u||_2 \lesssim e^{C(\Im \lambda)_-}\langle j\rangle^{-1}||\Pi_j u||_2.$$
Let $a_j = ||\Pi_j u||_2$ and $C_j =  e^{C(\Im \lambda)_-}\langle j\rangle^{-1}$.
\begin{lemma}
Let $(a_j)_{j \in \ZZ}$ go to zero in both directions and suppose that there is a $m$ and there are $C_j$ such that $a_{j+m} \leq C_j$, $C_j \leq 1$ for all $|j|$ large enough. Then $a = 0$.
\end{lemma}
\begin{proof}
We have
$$|a_j| \leq C_{j-m}|a_{j-m}| \leq \cdots \leq \prod_{k=1}^p C_{j-km}|a_{j-mp}| \lesssim |a_{j-mp}| \to 0$$
as $p \to \infty$. Here the infinite product is bounded since the $C_j$ are.
\end{proof}
Therefore $u = 0$ almost everywhere, a contradiction.
\end{proof}

\section{Rellich's theorem}
Recall that in 1 dimension, if $(P_V - \lambda^2)u = 0$ then at infinity we can write
$$u(x) = b_{\sgn x}e^{-i\lambda|x|} + a_{\sgn x}e^{i\lambda|x|}$$
and the term $a_{\sgn x}e^{i\lambda|x|}$ is an outgoing wave. We want to generalize to higher dimensions and write
$$u^\pm(x) = e^{\pm i\lambda x} + v^\pm(x, \lambda)$$
where $v^\pm$ is an outgoing wave.

\begin{definition}
If $(P_V - \lambda^2)u = f$, $\lambda \in \RR \setminus 0$, $f \in L^2_c(\RR^n)$, $n \geq 3$ odd, we say that $u$ is an \dfn{outgoing wave} if there is a $g\in L^2_c(\RR^n)$, $u = R_0(\lambda)g$.
We say that $u$ is an \dfn{incoming wave} if $u = R_0(-\lambda)g$.
\end{definition}
We want $w(\lambda, \omega)$ to solve $(P_V - \lambda^2)w(\lambda, \omega) = 0$,
$$w(x, \lambda, \omega) = e^{-i\lambda\langle \lambda, \omega\rangle} + u(x, \lambda, \omega),$$
$u$ outgoing, $\omega \in \Sphere^{n-1}$, viz.
$$u = -R_V(\lambda)(Ve^{-i\lambda\langle\bullet,\omega}).$$
In that case
$$u(x) = \frac{e^{\pm i\lambda|x|}}{|x|^{(n-1)/2}}a(x/|x|)+ O(x^{-(n-1)/2})$$
at infinity.

\begin{theorem}[Rellich]
\index{Rellich's theorem}
Suppose $V \in L^\infty_c(\RR^n \to \RR)$. If $\lambda \in \RR \setminus 0$ there are no outgoing solutions to the operator $P_V - \lambda^2$; if and only if $R_V$ is holomorphic near $\lambda$.
\end{theorem}
\begin{proof}
If $R_V$ has a pole at $\lambda$ then $I + VR_0(\lambda)$ is not invertible, so there is a
$$g = \rho g = -VR_0(\lambda)g$$
so $u = R_0(\lambda)g$ is an outgoing solution.

Conversely, if $u = R_0(\lambda)g$ is an outgoing solution then $(1 + VR_0(\lambda)\rho)g = 0$ so $m_R(\lambda) > 0$.
Suppose $w = -R_0(\lambda)Vw$, $(P_V - \lambda^2)w = 0$. Thus $w$ is outgoing.
We claim $w(x) = O(|x|^{-(n-1)/2})$, and then claim that $w$ has compact support, and then claim that $w = 0$.

To prove the first claim, we note that
$$w(x) = \frac{e^{i\lambda|x|}}{|x|^{(n-1)/2}}(h(x/|x|) + O(1/|x|)).$$
Here
$$h(\theta) = c_n \lambda^{(n-3)/2}\hat V_w(\lambda\theta).$$
Thus $(\partial_r - i\lambda)w = O(r^{(n-1)/2})$ (here $|x| = r$).
Since $V,\lambda \in \RR$,
$$0 = \int{B(0, R)} |w(P_V - \lambda^2)\overline w (P_V - \lambda^2)w\overline w| = \int_{B(0, R)} \overline w\Delta w - w \Delta \overline w$$
so
$$0 = \int_{\partial B(0, R)} \partial_rw\overline w - \partial_r\overline ww = \int_{\partial B(0, R)} (i\lambda w + \cdots)\overline w - (-i\lambda w + \cdots)w = 2i\lambda \int_{\partial B(0, R)} |w|^2 + O(R^{-1})$$
hence the first claim.

To see the second claim, note that by the irst claim, the top order term of $w$ in the asymptotics is $0$.
We know
$$\hat V(\xi) = 0$$
on $\Sigma \cap \RR^n = \{\xi: |\xi|^2 = \lambda^2\} \cap \RR^n$, since $h(0) = 0$, so $\hat V$ vanishes on $\Sigma$. Hence
$$\hat V(\xi)(|\xi|^2 - \lambda^2)^{-1}$$
is entire. Since
$$\hat V(\xi) = \hat w(\xi)(|\xi|^2 - \lambda^2)$$
the Paley-Weiner theorem implies that $w$ has compact support.

For the third claim we appeal to a Carleman estimate:
\begin{lemma}[semiclassical Carleman estimate]
\index{semiclassical Carleman estimate}
For every $R > 0$ there is a $\varphi \in C^\infty(\RR^n \to \RR)$ such that for every $h > 0$ and $u \in H^2(\RR^n)$ such that $\supp u \subseteq B(0, R)$,
$$||h^2e^{\varphi/h}\Delta e^{-\varphi/h}u||_{L^2} \geq Ch^2||u||_{L^2}.$$
\end{lemma}
\begin{proof}
Let
$$P_\varphi = -h^2e^{\varphi/h}\Delta e^{-\varphi h}$$
so we want to show that
$$||P_\varphi||_{L^2 \to L^2} \geq Ch^2.$$
Now
$$||P_\varphi u||_{L^2} = \langle P_\varphi^*P_\varphi u, u\rangle = ||P_\varphi^*u||_{L^2} + \langle [P_\varphi^*, P_\varphi]u, u\rangle
\geq \langle [P_\varphi^*, P_\varphi]u, u\rangle.$$
Now
$$[P_\varphi^*, P_\varphi] = -8h^3\sum_{j,k=1}^n \partial_{j,k}\varphi \partial_{j,k}u + 4h\langle \nabla \varphi, \nabla|\nabla \varphi|^2u - 8h^3\langle \nabla \Delta\varphi, \Delta u\rangle - 2h^3(\Delta^2\varphi)u.$$
Take
$$\varphi(x) = \frac{|x|^2}{2} + 2(R+1)x_1.$$
Then $\varphi$ is convex. Thus
$$[P_\varphi^*, P_\varphi] = 8h(-h^2\Delta + (x + 2(R+1)x_1)^2)$$
which has sufficient positivity.
\end{proof}

Let $u = e^{\varphi/h}w$, so
\begin{align*}0 &= h^2||e^{\varphi/h}(P_V - \lambda^2)w||_{L^2} \\
&= ||e^{\varphi/h}(-h^2\Delta + h^2V- h^2\lambda^2)e^{-\varphi/h}u||_{L^2}\\
& \geq h^2 ||e^{\varphi/h}\Delta e^{-\varphi/h}u||_{L^2} - Ch^2||u||_{L^2}\\
&\geq Ch^{1/2}||u||_{L^2}-Ch^2||u||_{L^2}.
\end{align*}
Taking $h \to 0$ we see that $u = 0$, so $w = 0$.
\end{proof}

\begin{theorem}[Rellich]
\index{Rellich's theorem}
Suppose $P$ is a self-adjoint operator on $H^2$, $\chi$ a cutoff with
$$B(0, R) \subset \{\chi = 1\} \subset \supp \chi \subset B(0, 2R)$$
$P(1 - \chi) = -\Delta(1 - \chi)$. If $\lambda > 0$, $u \in H^2_{loc}$, $(P - \lambda^2) = 0$,
$$\lim_{R \to \infty} \int_{\partial B(0, R)} ((\partial_r - i\lambda)u)^2 = 0$$
then for every $|x| > R$, $u(x) = 0$.
In particular if the \dfn{Sommerfeld radiation condition}
then the conclusion of the theorem holds.
\end{theorem}
\begin{proof}
Let
$$f = [\Delta, \chi]u = -(\Delta + \lambda^2)(1 - \chi)u.$$
Then $(1 - \chi)u = R_0(\lambda)f$.
To see this, note that
$$w = (1 - \chi)u - R_0(\lambda)f$$
solve $(\Delta + \lambda^2)w = 0$. If $G = (\partial_r - i\lambda)w/(2i\lambda)$, then arguing as in the proof of the other Rellich theorem we see that
$$0 \geq \frac{1}{2}\int_{\partial B(0, R)} |w|^2 - 2\int_{\partial B(0, R)}|G|^2$$
and by hypothesis
$$\frac{1}{R}\int_{\partial B(0, R)}|w|^2 \to 0,$$
and $\supp \hat w \subset \{|\xi|^2 = \lambda^2\}$, hence $w = 0$.

Now if $\chi_1$ is a cutoff, $\chi_1 = 1$ on $\supp \chi$,
$$-i\langle [-\Delta, \chi_1]R_0(\lambda)f, R_0(\lambda)f\rangle = |c_n|^2\lambda^{n-2} \int_{\Sphere^{n-1}}|\hat f(\lambda\theta)|^2~d\theta$$
but the above quadratic form is $0$, so $\hat f(\lambda\theta) = 0$ on $\Sphere^{n-1}$.
We can then repeat the proof of the other Rellich theorem.
\end{proof}
The quantity $i\langle[\Delta, \chi_1]u, u\rangle$ is known as the \dfn{quantum flux} which is positive for outgoing solutions and negative for incoming solutions.

\begin{theorem}
Let $V \in C^\infty_c(\RR^n \to \RR)$, $f$ a distribution of compact support, $(P_V - \lambda^2)u = f$, $\lambda \in \RR \setminus 0$. Then the following are equivalent:
\begin{enumerate}
\item As $x \to \infty$,
$$u(x) = e^{i\lambda|x|}w(x/|x|)|x|^{-(n-1)/2} + O(|x|^{-(n+1)/2}).$$
\item $(\partial_r - i\lambda)u = o(r^{-(n-1)/2})$ where $|x| = r$.
\item $u = R_V(\lambda)f$.
\item There is a distribution $g$ of compact support such that $u = R_0(\lambda)g$.
\end{enumerate}
\end{theorem}
This follows pretty easily from the above.

\begin{theorem}
If $\lambda \in \RR \setminus 0$, then
$$e^{-i\lambda\langle x,\omega\rangle}\sim (\lambda|x|)^{-(n-1)/2}(c_n^+ e^{-i\lambda|x|}\delta_\omega(x/|x|) + c_n^- e^{i\lambda|x|}\delta_{-\omega}(x/|x|) )$$
as $|x| \to \infty$, with
$$c_n^\pm = (2\pi)^{(n-1)/2}e^{\pm \pi/4(n-1)i}.$$
The remainder is $O(|x|^{-1})$.
\end{theorem}
\begin{proof}
We apply the method of stationary phase.
Without loss of generality assume that $\omega = (1, 0, \cdots, 0)$. Then $\theta \mapsto \langle \theta, \omega\rangle$ has antipodal critical points $\pm 1 = (\pm 1, 0, \cdots, 0)$.
Thus we may assume that the test function $\varphi$ is supported close to the critical points $\pm 1$ because everywhere else the contribution is $O(h^\infty)$ where $h = (r\lambda)^{-1}$, and the integral is
$$\int_{\Sphere^{n-1}} e^{-i\lambda r\langle \omega,\theta\rangle} \varphi(\theta)~d\theta.$$

We consider the pole $+1$ because the other is similar. Write $\theta = (\sqrt{1 - |t|^2}, t)$, $t \in \RR^{n-1}$.
The Jacobian of this change of coordinates is
$$J(t) = 1 + O(t^2)$$
and
$$I_h = \int_{B(0, 1) \subset \RR^{n-1}} e^{-\sqrt{1 - |t|^2}/h} \varphi(\sqrt{1 - |t|^2}, t)J(t)~dt$$
and stationary phase gives
$$I_h = (2\pi h)^{(n-1)/2}e^{i\pi/4(n-1)}(\varphi(1, 0) + O(h)).$$
\end{proof}

\begin{theorem}
Let $P$ be a self-adjoint operator, $P(1 - \chi) = -\Delta(1 - \chi)$, $F_\ell$ Schwartz functions, $f_\ell, g_\ell \in \Sphere^{n-1}$, $\lambda \in \RR \setminus 0$, $(P - \lambda^2)u_\ell = F_\ell$,
$$u_\ell(r\theta) = r^{-(n-1)/2}(e^{i\lambda r}f_\ell(\theta) + e^{-i\lambda r}g_\ell(\theta)) + O(r^{-(n+1)/2}).$$
Then
$$2i\lambda\int_{\Sphere^{n-1}}(g_1\overline g_2 - f_1\overline f_2) = \int_{\RR^n} F_1\overline u_2 - u_1\overline F_2.$$
\end{theorem}
This follows from selfadjointness and Green's theorem.

\section{The scattering matrix}
See the slides from the talk I gave.

\section{Blackbox scattering}
In this section we take $\Delta$ to be a positive operator, in contrast to the rest of this chapter.

We are interested in generalizing the theory of potential scattering to more general situations, such as obstacle scattering, where there is a compact obstacle in $\RR^n$, or metric perturbations, where instead of working with $\Delta$ we work with the Laplace-Beltrami operator of a Riemannian metric which is equal to the standard metric at infinity.

Let $\mathcal H$ be a Hilbert space,
$$\mathcal H = \mathcal H_{R_0} \oplus L^2(\RR^n \setminus B_{R_0}(0))$$
where $\mathcal H_{R_0}$ is a Hilbert space that we call the \dfn{black box}.
We let $1_{B_{R_0}(0)}$ be the orthogonal projection onto the black box.
We write $\mathcal H_{comp}$ and $\mathcal H_{loc}$ for
$$\mathcal H_* = \mathcal H_{R_0} \oplus L^2_*(\RR^n \setminus B_{R_0}(0)).$$

\begin{definition}
A \dfn{black box Hamiltonian} is an unbounded self-adjoint operator $P$ on $\mathcal H$ of domain $\mathcal D$ such that:
\begin{enumerate}
\item $1_{\RR^n \setminus B_{R_0}(0)}\mathcal D \subseteq H^2(\RR^n \setminus B_{R_0}(0))$
\item For every $u \in \mathcal D$, $1_{\RR^n \setminus B_{R_0}(0)}(Pu) = \Delta u|_{\RR^n \setminus B_{R_0}(0)}$
\item For every $v \in H^2(\RR^n)$, $v|_{B_{R_0 + \varepsilon}} = 0$ implies $v \in \mathcal D$.
\item $1_{B_{R_0}(0)}(P + i)^{-1}$ is a compact operator.
\end{enumerate}
\end{definition}

\begin{lemma}
Let $P$ be a black box Hamiltonian. IF $v \in H^2(\RR^n)$, $v|_{B_{R_0 + \varepsilon}(0)} = 0$, then $Pv = \Delta v$.
\end{lemma}
\begin{proof}
For every $u \in \mathcal D$,
$$\langle Pv, u\rangle_{\mathcal H} = \langle v, Pu\rangle_{L^2(\RR^n \setminus B_{R_0}(0))} = \langle v, \Delta u\rangle_{L^2(\RR^n \setminus B_{R_0}(0))} = \langle \Delta v, u\rangle_{\mathcal H}.$$
\end{proof}

We let
$$||u||_{\mathcal D}^2 = ||u||_{\mathcal H}^2 + ||Pu||_{\mathcal H}^2.$$
Thus $\mathcal D$ has the same norm as $H^2$. Similarly we write
$$||u||_{\mathcal D,\alpha}^2 = ||(P + i)^\alpha u||_{\mathcal H}^2.$$
If $u \in \mathcal D^\alpha$ then a localization of $u$ away from $B_{R_0}(0)$ is in $H^{2\alpha}$.

\begin{example}
Every potential Hamiltonian with a self-adjoint potential is a black box Hamiltonian, by the Rellich-Kondrachov theorem and $L^2 \to H^2$ estimates on the resolvent to show compactness of the resolvent.
\end{example}
\begin{example}
Fix the closure of a precompact open set $O$ with $\partial O$ a smooth manifold, and let $\Omega = \overline O^c$.
Let $\mathcal H = L^2(\Omega)$, $\mathcal D$ the set of functions in $H^2$ meeting some boundary condition along $\partial O$.
Take $P = \Delta$, then $P$ is a black box Hamiltonian. The only nontrivial part of this is to use Schauder estimates to show compactness of hte resolvent.
\end{example}
\begin{example}
Let $(X, g)$ be a complete Riemannian surface.
Let $X = X_0 \cup X_1$, $\partial X_0 = \partial X_1$ a smooth shared boundary.
Take $X_0$ to be compact, and
$$(X_1, g_1) = (S_1 \times [a, \infty), dr^2 + e^{-2r}~d\theta^2)$$
so we are thinking of $(X_1, g_1)$ as kind of like polar coordinates,
then take
$$\mathcal H = L^2(X_0) \oplus \mathcal H^0_a \oplus L^2([a, \infty), dr).$$
Here $\mathcal H^0_a$ consists of biinfinite sequences $(a_n)_{n \in \ZZ,n \neq 0}$ of functions such that the $\ell^1$ norm of the sequence of $L^2$ norms is finite, and
$$||u||_{\mathcal H}^2 = ||u|_{L^2(X_0)} + \sum_{n \in \ZZ} \int_0^\infty |a_n(r)|^2~dr$$
where $a_0$ is the projection of $u$ to $L^2([a, \infty), dr)$.

For $u \in H^1(X)$ write
$$u \cong (u|_{X_0}, \{e^{-r/2}u_n\}_{n \in \ZZ,n\neq 0}, e^{-r/2}u_0 )$$
where
$$u_n(r) = \frac{1}{2\pi} \int_{\Sphere^1} u(r, \theta)e^{-in\theta}~d\theta.$$
Thus $H^1(X)$ embeds in $\mathcal H$.
\end{example}

We now show meromorphic continuation of black box Hamiltonians.
\begin{lemma}
Let $P$ be a black box Hamiltonian, $R \geq R_0$. Then if $\lambda^2 \notin \Spec P$, $\Im \lambda > 0$, $1_{B_R(0)}(P - \lambda^2)^{-1}, (P - \lambda^2)^{-1}1_{B_R(0)}$ are compact operators.
\end{lemma}
\begin{proof}
The compact operators form a $C^*$-algebra, so take adjoints to just do the first operator.

If $R = R_0$,
$$1_{B_R(0)}(P - \lambda^2)^{-1} = 1_{B_R(0)}(P - i)^{-1} + 1_{B_R(0)}(P - i)^{-1}(i + \lambda^2)(P - \lambda^2)^{-1}$$
as seen by taking $(P - \lambda^2)$ on the right of both sides. Both of the terms on the right hand side are compact.

If $R > R_0$, $(1_{B_R(0)} - 1_{B_{R_0}(0)})(P - \lambda^2)^{-1}$ sends $\mathcal H$ into $H^2(B_R(0) \setminus B_{R_0}(0))$ which embeds compactly into $L^2(B_R(0))$ by the Rellich-Kondrachov theorem.
\end{proof}
\begin{lemma}
If $P$ is a black box Hamiltonian, $K \in [0, 2]$, $\tau > 0$, then
$$||1_{\RR^n \setminus B_R(0)}(P - i\tau)^{-1}||_{\mathcal H \to H^k(\RR^n \setminus B_{R_0}(0))} \lesssim \langle \tau\rangle^{k/2}\tau^{-1}.$$
\end{lemma}
\begin{proof}
If $k = 0$ this follows from
$$||(P - i\tau)^{-1}||_{\mathcal H \to \mathcal H} = d(\lambda, \Spec P)^{-1}$$
and for $k = 2$ it follows from
$$P(P - i\tau)^{-1} = 1 + i\tau(P - i\tau)^{-1}.$$
Now interpolate.
\end{proof}

\begin{theorem}
If $P$ is a black box Hamiltonian and $n$ is odd, then
$$R(\lambda) = (P - \lambda^2)^{-1}$$
is meromorphic $\mathcal H \to \mathcal D$ for $\Im \lambda > 0$, and otherwise is meromorphic $\mathcal H_{comp} \to \mathcal D_{loc}$.
\end{theorem}
\begin{proof}
Let $\lambda_0$ have $\Im \lambda_0 > 0$, $\lambda_0^2 \notin \Spec P$, to be chosen later.

Choose cutoffs $\chi_j$ such that $\chi_{j+1} = 1$ on $\supp \chi_j$, $\chi_0 = 1$ on $B_{R_0}(0)$.

Let $Q(\lambda) = Q_0(\lambda) + Q_1(\lambda_0)$ where $Q_0(\lambda) = (1 - \chi_0)R_0(\lambda)(1 - \chi_1)$ and $Q_1(\lambda) = \chi_2(P - \lambda^2)^{-1}\chi_1$.

Then
$$(P - \lambda^2)Q_0(\lambda) = 1 - \chi_1 + [\Delta, \chi_0]R_0(\lambda)(1 - \chi_1) = 1 - \chi_1 + K_0(\lambda).$$
Similarly we write
$$(P - \lambda^2)Q_1(\lambda_0) = \chi_1 + K_1(\lambda).$$
By a standard Rellich-Kondrachov argument using the previous lemma we see that $K_0,K_1$ are compact. Let $K = K_1 + K_2$.

Thus
$$(P - \lambda^2)Q(\lambda) = 1 + K(\lambda)$$
is Fredholm. Now let $\mu \gg 1$ and $\lambda_0 = e^{i\pi/4}\mu$. Then one can check that
$$||K(\lambda)||_{\mathcal H \to \mathcal H} \lesssim \mu^{-1}$$
so if $\mu$ is large enough then $1 + K(\lambda)$ is invertible.
Thus analytic Fredholm theory implies that $(P - \lambda^2)Q(\lambda)$ inverts to a meromorphic family of operators, $\Im \lambda > 0$.

The argument for $\Im \lambda \leq 0$ uses the same $\lambda_0$ and lots of obnoxious cutoffs.
\end{proof}

\begin{example}
As an example, the Green function of a Helmholtz operator $\Delta - \lambda^2$ in an open system depends meromorphically on $\lambda$.
\end{example}

One can generalize the basic results about the resolvent from potential Hamiltonians to black box Hamiltonians for not much work.

\section{Complex scaling}
We want to construct a modified resolvent $R_{V, \Gamma}(\lambda): L^2 \to H^2$ without any cutoffs. We do this for $n = 1$ for simplicity.

Let $\Gamma$ be a simple curve and define $\partial_z^\Gamma$ to be the partial derivative operator on $\Gamma$, and $\gamma$ its parametrization. Define $dz = \gamma'(t)~dt$ on $\Gamma$. Assume that $\Gamma \cap \RR \supseteq [-L, L]$ where $L > 0$ is so large that if $|x| > V$ then $V(x) = 0$.
Assume that $\Gamma$ is just a straight line at angle $\theta \in (0, \pi/2)$ close to infinity.
Let $P_{V,\Gamma} = (D^\Gamma)^2 + V$, so $P_{V,\Gamma} = P_V$ on $[-L, L]$.
Let $\Lambda_\Gamma$ be the set of $\lambda$ such that $\Im \lambda e^{i\theta} > 0$.

\begin{lemma}
If $\lambda \neq 0$ and $f \in C^1_c(\Gamma)$ then
$$R_{0,\Gamma}(\lambda)f(z) = \frac{i}{2\lambda} \int_\Gamma e^{i\lambda\varphi(z, w)} f(w)~dw$$
where $\varphi$ is distance on $\Gamma$, extends to an operator $L^2(\Gamma) \to H^2(\Gamma)$ which is an inverse of $P_{V,\Gamma}$.
\end{lemma}
\begin{proof}
It's easy to check on Schwartz functions that $R_{0,\Gamma} = P_{V,\Gamma}^{-1}$ by integration by parts.
Using elliptic regularity and $D_\Gamma^2R_{0,\Gamma} = 1 + \lambda^2R_{0,\Gamma}$ we see that if $R_{0,\Gamma}$ carries $L^2$ to itself then it maps into $H^2$. We do this by Schur's test.
The real part of the term in the exponential is $\leq -\varepsilon|\lambda||t-s| + O(1)$ which gives good bounds for Schur.
\end{proof}

\begin{lemma}
$P_{V,\Gamma} - \lambda^2$ is Fredholm and $\Spec(P_{V,\Gamma}) \cap \Lambda_\Gamma$ is discrete. Moreover if $\lambda \in \Lambda_\Gamma$ then
$$m_R(\lambda) = \tr\frac{1}{2\pi i}\oint_\lambda (\zeta^2 - P_{V,\Gamma})^{-1}2\zeta~d\zeta.$$
Finally if we let
$$m_D(\lambda) = \frac{1}{2\pi i} \oint_\lambda \frac{D'(\zeta)}{D(\zeta)}~d\zeta$$
and $D(\lambda) = 1 + R_{0,\Gamma}(\lambda)\rho$ then $m_D = m_R$.
\end{lemma}
\begin{proof}
The proof that $P_{V,\Gamma} - \lambda^2$ is Fredholm follows by the Rellich-Kondrachov theorem and the previous lemma in the usual way.

Now if $\lambda$ is a pole then there is $u,m$ such that
$$(P_V - \lambda^2)^m u_m = 0.$$
Here $u_m$ is a plane wave near infinity at frequency $\lambda$. By a Fourier series argument we see that
$$u_m(x) = P(x)e^{i\lambda x}$$
if $x > L$ and similarly for $Q$, $x < -L$, where $P,Q$ are polynomials of degree $m - 1$. Let $\tilde u_m(x) = e^{i\lambda x}$ for $x > L$, $Q(x)e^{-i\lambda x}$ for $x < -L$, $u_m$ on $[-L, L]$, then $\tilde u_m$ is annihilated by $(P_{V,\Gamma} - \lambda^2)^m$ and not by the $m-1$th power. Moreover, $\tilde u_m \in L^2$ and is the unique eigenfunction up to scaling.
Therefore $\lambda$ has multiplicity $m$. The converse to this step is similar.
\end{proof}

We now give applications of complex scaling.

\begin{theorem}
Suppose that $V_0$ is a potential, $\Omega$ a precompact open subset of $\CC$ with smooth boundary, and $V_0$ has no resonances on $\partial \Omega$. Then if $||V - V_0||_{L^\infty}$ is small,
$$\sum_{\lambda \in \Omega} m_V(\lambda) = \sum_{\lambda \in \Omega} m_{V_0}(\lambda).$$
\end{theorem}
\begin{proof}
Suppose $0 \notin \Omega$; we return to this case later. Write $\Omega$ as a union of open sets with piecewise smooth curves so we can assume $\Omega \subset \Lambda_\Gamma$ or its complex conjugate $\overline \Lambda_\Gamma$. In the former case, we show
$$\frac{1}{2\pi} |\tr \oint_{\partial \Omega} (\zeta - P_{V_0,\Gamma})^{-1}~d\zeta - \tr \oint_{\partial \Omega} (\zeta - P_{V,\Gamma})^{-1}~d\zeta < 1.$$
First, by a Neumann series trick we show that $||(\zeta - P_{V,\Gamma})^{-1}||_{L^2 \to H^2} \lesssim ||(\zeta - P_{V_0,\Gamma})^{-1}||_{L^2 \to H^2}$.
Now for any cutoff the trace class norm satisfies $||\rho T||_1 \leq ||T||_{L^2 \to H^2}$. In particular,
$$|\tr \oint_{\partial \Omega} (\zeta - P_{V_0,\Gamma})^{-1}(V - V_0)\rho(\zeta - P_{V,\Gamma})^{-1}~d\zeta| \lesssim ||(\zeta - P_{V_0,\Gamma})^{-1}||_{L^2 \to H^2} ||V - V_0||_\infty.$$
In particular we can make it $< 1$ and use the fact that multiplicity is discrete.

If $0 \in \Omega$ we reduce to the case that $\Omega = B(0, r)$ and $r$ is small. Now $m_D(0) = m_R(0) - 1$. Therefore
$$m_R(0) - 1 = \tr\oint_{|\zeta| = r} (1 + V_0R_0(\zeta)\rho)^{-1}V_0\partial_\zeta(\rho R_0(\zeta)\rho)~d\zeta.$$
Since the free resolvent has no resonances on $\partial B(0, r)$ one can show that
$$||(1 + V\rho R_0(\lambda)\rho)^{-1}||_{L^2} \lesssim ||(\zeta - P_{V_0,\Gamma})^{-1}||_{L^2 \to H^2}$$
but if we choose $r$ small then $V$ has no resonances there so by Cauchy's integral formula
$$||\partial_\zeta \rho R_0(\lambda) \rho||_1 \lesssim 1.$$
One can then apply the same argument again.
\end{proof}

\begin{theorem}
For the generic potential, all resonances are simple.
\end{theorem}
\begin{proof}
Order the resonances $z \leq w$ if $|z| \leq |w|$. Let $\mathcal V_n$ be the set of potentials where the first $n$ resonances are simple.
By the previous theorem $\mathcal V_n$ is open and the desired set is $\bigcap_n \mathcal V_n$.
One can then use Rouche's theorem to show that $\mathcal V_n$ is dense.
\end{proof}

Now we consider the case $n \geq 3$ odd.

\begin{definition}
An $n$-dimensional real submanifold $M$ of $\CC^n$ is \dfn{maximally totally real} if for every $m \in M$, $T_mM \cap iT_mM = 0$.
\end{definition}

\begin{definition}
If $M$ is maximally totally real, $u \in C^\infty(\CC^n)$ is \dfn{almost analytic} if $\dbar u(z) = O(d(z, M)^\infty)$.
\end{definition}

\begin{lemma}
If $F_\theta$ is convex then $f_\theta(x) = x + i\partial_x F_\theta(x)$ parametrizes a maximally totally real submanifold $\Gamma_\theta$.
\end{lemma}

\begin{lemma}
Every smooth function on $M$ has an almost analytic extension to $\CC^n$. If $\tilde P$ is a holomorphic differential operator near $M$ then it defines a differential operator on $M$ which commutes with almost analytic extension.
\end{lemma}

Let $\Delta_\theta$ be the Laplacian on $\Gamma_\theta$ induced by the previous two lemmata, for $F_\theta$ fixed.
\begin{lemma}
$-\Delta_\theta$ is a black box Hamiltonian and $-\Delta_\theta$ is a second-order elliptic operator.
\end{lemma}

\begin{theorem}
Let
$$R_\theta(\lambda)\varphi(x) = \int_{-\infty}^\infty R_0(\lambda, x, y)\varphi(y)\det(1 + i\partial^2_y F_\theta(y))~dy$$
then $R_\theta(\lambda)$ is the inverse of $-\Delta_\theta - \lambda^2$ and if $\Im \theta \gtrsim \Re \theta$ then
$$R_\theta(\lambda) = O(|\Im \lambda|^{-2}).$$
\end{theorem}


\section{Resonance-free regions}



\chapter{General relativity}
\section{Axioms of special relativity}
\begin{definition}
    A \dfn{reference frame} is a coordinate system for $\RR^4 = \RR \times \RR^3$. A reference frame is said to be \dfn{inertial} if the motion of a body without external influence forms a straight line in $\RR^4$. Otherwise, the reference frame is said to be \dfn{accelerated}.
\end{definition}
\begin{axiom}
    All laws of physics are invariant under change of inertial reference frame.
\end{axiom}
\begin{axiom}
    The speed of light in a vacuum is invariant under change of inertial reference frame.
\end{axiom}
    We denote the speed of light in a vacuum by $c$.

\section{Lorentz transformations}
\begin{definition}
    A \dfn{Lorentz transformation} is a smooth transformation which fixes the origin and is homotopic to the identity, which carries an inertial reference frame to an inertial reference frame.
\end{definition}
\begin{definition}
    Let $p = (t, x), q = (t', x') \in \RR^4$. The \dfn{spacetime interval} $\Delta s = [p, q]$ between $p, q$ is the distance
    $$\Delta s^2 = \Delta x^2 - c^2\Delta t^2$$
    where $\Delta t = t' - t$ and $\Delta x = x' - x$.
\end{definition}
It is not hard to check that Lorentz transformations are linear (since they preserve straight-line trajectories). Moreover, spacetime intervals are also preserved by Lorentz transformations. By the second axiom of relativity, the quadratic polynomials associated to $\Delta s$ and its Lorentz transform, say $\Delta s'$, have the same roots. So there is an $\alpha \neq 0$ such that
$$(\Delta s)^2 = \alpha (\Delta s')^2.$$
Moreover, this constant appears for any choice of $s, s'$, so by ``reciprocity", $\alpha^2 = 1$. Since Lorentz transformations are homotopic to the identity, which clearly has $\alpha > 0$, we have $\alpha = 1$. Therefore the claim holds.

\begin{example}[twin paradox]
\index{twin paradox}
Let $A, B$ be two twins born in space. They are separated at birth (spacetime $P$), and $B$ moves away from $A$ but then suddenly turns around (at spacetime $Q$) and meets $A$ again (at spacetime $R$). Then it appears that both $A$ is older than $B$ (from the point of view of $A$) and $B$ is older than $A$ (from the point of view of $B$). However, one can check that in fact $A$ is older than $B$, since $B$ had an accelerated reference frame (when he turned around at $Q$) and so has an incorrect perception of the universe. This can be checked using the spacetime interval invariance.
\end{example}

Let us consider the Lorentzian metric
$$ds^2 = dx^2 - c^2 dt^2,$$
where as usual we write $s = (t, x) \in \RR \times \RR^3 = \RR^4$ for a point in spacetime. This is a linear combination of the Riemannian metrics $dx^2$ and $dt^2$. We will also write $m$ for the indefinite quadratic form induced by $ds^2$ on the tangent bundle. On the other hand we will write $\delta$ for the positive-definite quadratic form induced by the Riemannian metric $dx^2$. Therefore $(\RR^3, \delta)$ is just Euclidean space.
\begin{definition}
    A \dfn{Lorentzian manifold} is a smooth manifold equipped with a smoothly varying quadratic form on each tangent space. The Lorentzian manifold $(\RR^4, m)$ is known as \dfn{Minkowski spacetime}.
\end{definition}

Now let $\gamma$ be a curve in $\RR^4$, which we think of as parametrized by $[0, 1]$. We denote the tangent vector by $\dot \gamma$.
\begin{definition}
The \dfn{proper time} of the curve $\gamma$ is
$$\int_0^1 \frac{\sqrt{-m(\dot \gamma(\sigma), \dot \gamma(\sigma))}}{c} ~d\sigma.$$
\end{definition}
\begin{definition}
    Let $v$ be a tangent vector over $\RR^4$. If $m(v, v) < 0$, we say that $v$ is \dfn{timelike}. If $m(v, v) = 0$, then $v$ is \dfn{lightlike} or \dfn{null}. Otherwise, $v$ is \dfn{spacelike}. If $v$ is not spacelike, we say that $v$ is \dfn{causal}. If every tangent vector to a curve is timelike (lightlike, etc.), we say that the curve itself is timelike (lightlike, etc.)
\end{definition}
Notice that a vector $v$ has speed $\leq c$ iff $v$ is causal. So causal curves are those trajectories of objects which are allowed by the laws of physics.

\section{Riemannian geometry}
We dive deeper into Lorentzian geometry. Throughout this chapter we fix a Lorentzian spacetime $(M, g)$. In other words, $(M, g)$ is locally isomorphic as a Lorentzian manifold to the Minkowski spacetime $(\RR^4, m)$. We always assume that $M$ is orientable.

Throughout these notes we use Einstein's conventions that a repeated index is summed over:
$$\omega_\mu v^\mu = \langle \omega, v\rangle.$$
We let $\{\partial_0, \dots, \partial_3\}$ be the standard basis of the tangent bundle $TM$, and $\{dx_0, \dots, dx_3\}$ be the standard basis of the cotangent bundle $T^*M$. Thus we have a pairing
$$dx^\mu \partial_\nu = \delta_\nu^\mu.$$

\begin{definition}
A $(p, q)$-\dfn{tensor} at $x \in M$ is an element of $(T_x^*M)^{\otimes p} \otimes (T_xM)^{\otimes q}$. A $(p, q)$-\dfn{tensor field} is a section of the tensor bundle $$(T^*M)^{\otimes p} \otimes (TM)^{\otimes q} \to M.$$
\end{definition}
In local coordinates, we write
$$T_{\alpha_1, \dots, \alpha_p}^{\beta_1, \dots, \beta_q}(x)$$
for the $(\alpha_1, \dots, \alpha_p; \beta_1, \dots, \beta_q)$th coordinate of a $(p, q)$-tensor field evaluated at $x$.

We now need the notion of a linear connection. A linear connection, morally, is a ``way to differentiate a vector field against another vector field." Let $\mathcal T(M)$ denote the space of vector fields $M \to TM$.
\begin{definition}
    A \dfn{linear connection} is a $(C^\infty(M), \RR)$-bilinear map $\nabla: \mathcal T(M)^2 \to \mathcal T(M)$, written $(X, Y) \mapsto \nabla_XY$ (though we write $\nabla_\alpha = \nabla_{\partial_\alpha}$) satisfying the Leibniz rule
    $$\nabla_X (f Y) = (\nabla_X f) Y + f\nabla_XY = df(X)Y + f\nabla_XY.$$
\end{definition}
Let's consider the easy example of a Euclidean connection.
\begin{definition}
    Assume $(M, g)$ is Euclidean space. The \dfn{Euclidean connection} on $M$ is the linear connection
    $$\nabla_X Y^j \partial_j = XY^j \partial_j.$$
\end{definition}
Since $X$ is a first-order derivation at each point, $XY^j$ is the partial derivative of $Y$ in the direction of $X$. Thus Euclidean connections are a very natural thing to study, and in case $X = \partial_\alpha$, $\nabla_X$ is just the map that sends $Y$ to its derivative in some direction. The Euclidean connection has the useful property that $\nabla g = 0$.
\begin{definition}
    The \dfn{Levi-Civita connection} $\nabla$ is the unique connection on $M$ such that $\nabla g = 0$ and which satisfies $\nabla_XY - \nabla_YX = [X, Y]$.
\end{definition}
\begin{theorem}
    The Levi-Civita connection is well-defined.
\end{theorem}
\begin{definition}
    The \dfn{Riemann curvature tensor} is the $(3, 1)$-tensor field
    $$R_{\alpha\beta\gamma}^\delta \partial_\delta = \nabla_\alpha \nabla_\beta \partial_\gamma - \nabla_\beta \nabla_\alpha \partial_\gamma.$$
\end{definition}
It is pretty clear that
$$R_{\alpha\beta\gamma}^\delta = -R_{\beta\alpha\gamma}^\delta,$$
and
$$R_{\alpha\beta\gamma\delta} = R_{\alpha\beta\delta\gamma}.$$
\begin{theorem}[Bianchi]
    \index{Bianchi's identities}
    One has
    $$R_{\alpha\beta\gamma\delta} + R_{\beta\gamma\alpha\delta} + R_{\gamma\beta\alpha\delta} = 0$$
    and
    $$\nabla_\alpha R_{\beta\gamma\delta\epsilon} + \nabla_\beta R_{\gamma\alpha\delta\epsilon} + \nabla_\gamma R_{\alpha\beta\delta\epsilon} = 0.$$
\end{theorem}
\begin{definition}
    The \dfn{Christoffel symbol} $\Gamma$ is defined by
    $$\nabla_\alpha \partial_\beta = \Gamma_{\alpha\beta}^\gamma \partial_\gamma.$$
\end{definition}
We have the \dfn{Kozsul formula}
$$\Gamma_{\alpha\beta}^\gamma = \frac{g^{\gamma\delta}}{2}(\partial_\alpha g_{\beta\delta} + \partial_\beta g_{\delta\alpha} - \partial_\delta g_{\alpha\beta}).$$

\section{Causality}
Let $(M, g)$ be a Lorentzian spacetime as above. Recall that we have a causal structure on the tangent bundle of $M$, which gives rise to a pair of light cones in each tangent space. Taking the exponential map, we get a causal structure on curves in $M$.

\begin{definition}
    The spacetime $(M, g)$ is \dfn{time-orientable} if there is a continuous choice of light cone for each tangent space.
\end{definition}
    Let us fix a time-orientation. The vectors in the chosen lightcone point to the ``future."
\begin{definition}
    Let $S \subseteq M$. The \dfn{chronological future} $I^+(S)$ is the set of points in $M$ that can be reached by a curve through the exponential map of the open future light cones of $S$. The chronological past is defined similarly, but with the open past light cone. The \dfn{causal future} and causal past are defined similarly, but for the closed light cones.
\end{definition}

\section{The Einstein equation}
We pose the Einstein equation as an initial-value problem on the Lorenztian manifold $(M, g)$.

If $\mathcal L$ is a Lagrangian density, then $\mathcal L$ does not have to be integrable, so long as we only take only compactly supported perturbations when we carry out the calculus of variations. That is why we emphasize that $\mathcal L$ is only a ``density" rather than a summable quantity.

Throughout, we let $\delta g_{\alpha\beta}$ be a compcatly supported perturbation of the metric tensor $g_{\alpha\beta}$.
\begin{definition}
    Let $\mathcal L$ be a Lagrangian density. The \dfn{energy-momentum tensor} associated to $\mathcal L$ is the tensor $T_{\alpha\beta}$ given by
    $$\int \frac{d\mathcal L}{ds}(\cdot, g + s\delta g) ~dV(g + s \delta g) + \int T^{\alpha\beta} \delta g_{\alpha\beta} dV = 0.$$
\end{definition}
\begin{theorem}[Noether]
    If $T_{\alpha\beta}$ is an energy-momentum tensor, then the divergence
    $$\nabla^\alpha T_{\alpha\beta} = 0.$$
\end{theorem}
Noether's theorem can be interpreted as a generalization of the conservation laws of energy, mass (which is just a form of energy by Einstein's special theory of relativity), and momentum. It is a special case of Noether's theorem that for any Lie action of $\RR$ on a Lagrangian density, there is an associated conserved quantity in the respective Euler-Lagrange equations.

A key point in general relativity is that ``curvature is energy-momentum", yet the energy-momentum tensor $T_{\alpha\beta}$ is divergence-free. So the curvature tensor appearing in general relativity should be a divergence-free covariant $2$-tensor. Thus we must define a $2$-tensor which measures curvature.
\begin{definition}
    Let $R^\alpha_{\beta\gamma\delta}$ be the Riemann curvature tensor of $(M, g)$. The \dfn{Ricci curvature tensor} of $(M, g)$ is given by
    $$\Ric_{\alpha\beta} = R^\mu_{\alpha\mu\beta}.$$
    The \dfn{scalar curvature} is given by $R = \Ric_\alpha^\alpha$.
\end{definition}
\begin{definition}
    The \dfn{Einstein tensor} of $(M, g)$ is
    $$G_{\alpha\beta} = \Ric_{\alpha\beta} - \frac{1}{2}g_{\alpha\beta} R.$$
    The \dfn{Einstein equation} is the equation
    $$G_{\alpha\beta} = \frac{8\pi G}{c^4} T_{\alpha\beta}.$$
\end{definition}
We will normalize $c = 1$, and then take $G = 1/(4\pi)$, so the Einstein equation will read as $G_{\alpha\beta} = 2T_{\alpha\beta}$. Notice the similarity to the Gauss-Poisson equation for gravity
$$4\pi G \nabla^\alpha g_\alpha = \rho$$
where $\rho$ is the mass density of the universe and $g_\alpha$ is the gravitational field. We have
$$\nabla^\alpha G_{\alpha\beta} = 0$$
by the second Bianchi identity.

We interpret $T_{\alpha\beta} = 0$ as meaning that the universe is a vacuum. In this case we have $\Ric_{\alpha\beta} = 0$. Now $\Ric_{\alpha\beta} = 0$ is a geometric PDE, but we want to frame it as an initial-value problem where the initial data consists of a $3$-manifold, and the resulting $4$-manifold comes from gluing together the $3$-manifolds together in time.

This interpretation gives another derivation of the Einstein equation. Assume $T_{\alpha\beta} = 0$; then the universe should have no curvature.
\begin{definition}
    The \dfn{Einstein-Hilbert Lagrangian density} is $\mathcal L_{EH} = R ~dV$.
\end{definition}
The Einstein equation should be the Euler-Lagrange equation minimizing the Einstein-Hilbert action.
\begin{theorem}
    The Euler-Lagrange equation corresponding to the Einstein-Hilbert Lagrangian density is the Einstein equation.
\end{theorem}
\begin{proof}
    Let $\delta g$ be a compactly supported perturbation of hte metric tensor as above. Then
    $$\frac{\delta}{\delta s} (g + s \delta g)^{\mu\nu} = -\delta g^{\mu\nu}.$$
    Similarly
    $$\frac{\delta}{\delta g} dV(g) = \delta g^{\alpha\beta} ~dV(g).$$
    In coordinates, we have
    $$\Ric_{\beta\nu} = \partial_\alpha \Gamma^\alpha_{\beta\nu} - \partial_\beta \Gamma^\alpha_{\alpha\nu} + \Gamma^\mu_{\alpha\gamma} \Gamma^\gamma_{\mu\nu} + \Gamma_{\beta\gamma}^\alpha\Gamma_{\alpha\nu}^\gamma.$$
    After a tedious computation in normal coordinates (where $g = m$ and $\Gamma = 0$ at the origin) we have
    $$\frac{\delta}{\delta s} \Ric_{\alpha\beta} (g + s\delta g)| = \frac{1}{2}g^{\mu\nu} (\partial_\alpha\delta g_{\beta\nu} + \partial_\beta \delta g_{\nu\alpha} - \partial_\nu\delta g_{\alpha\beta}).$$
    Applying the Lebiniz rule we have
    $$\int_M \frac{\delta}{\delta s} \mathcal L_{EH}(g + s\delta g) = \frac{1}{2} \int_M g^{\alpha\beta} R \delta g_{\alpha\beta} - \Ric^{\alpha\beta} \delta g_{\alpha\beta} ~dV$$
    so the claim follows by lowering indices.
\end{proof}

\section{Initial-data sets}
Henceforth we fix a time-orientation of $(M, g)$.
\begin{definition}
A \dfn{time function} is a smooth function $t$ on $M$ such that for every future-pointing timelike vector field $X^\alpha$, $g_{\alpha\beta} \nabla^\alpha t X^\beta > 0$.
\end{definition}
We fix a time function as well.

\begin{definition}
The \dfn{initial-time slice} $\Sigma_0$ is the level set of the equation $t = 0$.
\end{definition}
Because the metric signature is $(-, +, +, +)$, the initial-time slice will be a $3$-manifold. We denote its induced Riemannian metric by $\overline g$ and induced Levi-Civita connection by $\overline \nabla$.

\begin{definition}
    Let $\Sigma$ be a Riemannian submanifold of codimension $1$. Let $n$ denote the future-pointing unit normal vector to $\Sigma$. Then the \dfn{second fundamental form} $\overline k_{\alpha\beta}$ is given by
    $$\overline k_{\alpha\beta} u^\alpha v^\beta = -g_{\alpha\beta} u^\alpha \cdot \nabla_v n^\beta.$$
\end{definition}
The second fundamental form measures how fast the unit normal vectors change as we move along unit tangent vectors; it is a measure of the extrinsic curvature of $\Sigma$ in $M$.

\begin{theorem}[Gauss-Codazzi]
    \index{Gauss-Codazzi equations}
    One has $R(\overline g)_{ijk\ell} + \overline k_{ij} \overline k_{j\ell} - \overline k_{i\ell} \overline k_{jk} = R(g)_{ijk\ell}$ and $\overline \nabla_i \overline k_{j\ell} - \overline \nabla_j \overline k_{i\ell} = C R(g)_{ik\ell0}$.
\end{theorem}
    Thus, if $(\Sigma, \overline g, \overline k)$ is to be an initial-data set, it had better satisfy the Gauss-Codazzi equations for the $4$-manifold we want to embed it into.
\begin{definition}
    Let $T_{\alpha\beta}$ be a symmetric, divergence-free $2$-tensor. An \dfn{initial-data set} $(\Sigma, \overline g, \overline k)$ corresponding to the energy-momentum tensor $T_{\alpha\beta}$ is the data of:
\begin{enumerate}
    \item A $3$-manifold $\Sigma$,
    \item a Riemannian metric $\overline g$ on $\Sigma$ with Riemann curvature tensor $\overline R$,
    \item and a symmetric $2$-tensor $\overline k$ on $\Sigma$,
\end{enumerate}
    satisfying the Gauss-Codazzi constraints
\begin{align*}
    \overline R + (\operatorname{tr} \overline k)^2 + \overline k^{ij} \overline k_{ij} &= 4 \varphi^2 T_{tt}\\
    \nabla^i \overline k_{ij} - \nabla_j \operatorname{tr} \overline k &= 2\varphi T_{jt}
\end{align*}
    where
    $$\varphi = \frac{\overline k_{ij}}{2\partial_t \overline g_{ij}}.$$
\end{definition}
\begin{definition}
    Let $(\Sigma, \overline g, \overline k)$ be an initial-data set corresponding to the energy-momentum tensor $T_{\alpha\beta}$. A \dfn{development} of $(\Sigma, \overline g, \overline k)$ is an isometric embedding $\iota: \Sigma \to M$, where $M = (M, g)$ is a Lorentzian $(1+3)$-manifold solving the Einstein equation
    $$\Ric_{\alpha\beta} - \frac{1}{2} g_{\alpha\beta} R = T_{\alpha\beta}$$
    and $\overline k$ is the second fundamental form of $\iota$.
\end{definition}
    We think of the initial-data set as being the initial conditions of the Einstein equation and $(M, g)$ as being the solution.
\begin{definition}
    Let $S \subseteq M$ be a spacelike hypersurface. Then $S$ is a {Cauchy hypersurface} if every maximal causal curve in $M$ intersects $S$ at exactly one point. Moreover, the \dfn{domain of dependence} is the maximal submanifold $D \subseteq M$ such that $S$ is a Cauchy hypersurface of $D$.
\end{definition}
    For example, the initial-time slice $\Sigma_0$ of Minkowski spacetime is a Cauchy hypersurface. In fact, if $B$ is a ball in $\Sigma_0$, then the future-pointing causal cone based at $B$ is the domain of dependence of $B$.
\begin{definition}
    Let $(\Sigma, \overline g, \overline k)$ be a respective initial-data set. Let $(M, g)$ be a Lorentzian $(1+3)$-manifold. A \dfn{globally hyperbolic development} $\iota: \Sigma \to M$ is a development of $(\Sigma, \overline g, \overline k)$ such that $\iota(\Sigma)$ is a Cauchy hypersurface of $(M, g)$.
\end{definition}

\section{Well-posedness for the vacuum equation}
Throughout this section we work with the Einstein vacuum equation $\Ric_{\alpha\beta} = 0$.

First, we recall the theorem that quasilinear wave equations are well-posed.
\begin{theorem}
    Fix a Lorentzian metric $g$ and consider the PDE
\begin{align*}
    g^{\mu\nu}(x, \varphi(x)) \partial_\mu \partial_\nu \varphi(x) &= N(x, \varphi(x), \partial \varphi(x))\\
    (\varphi, \partial_t\varphi)(x) &= (\varphi_0, \varphi_1)(x)
\end{align*}
    where $\varphi$ is an unknown. Let $s > d/2 + 1$. If $(\varphi_0, \varphi_1) \in H^s \times H^{s-1}(\Sigma_0)$, then there is an maximal eclipse time $T > 0$ and a unique solution $\varphi \in H^s([0, T] \times \Sigma_0)$.
\end{theorem}

For $T_{\alpha\beta}$ a tensor, we write
$$\hat T_{\alpha\beta} = T_{\alpha\beta} - \frac{1}{2} g_{\alpha\beta} g^{\alpha\beta} T_{\alpha\beta}.$$

\begin{theorem}[Choquet-Bruhat-Geroch]
    \index{Choquet-Bruhat-Geroch theorem}
    Let $(\Sigma, \overline g, \overline k)$ be a smooth initial-data set with $\Ric_{\alpha\beta} = 0$. Then there is a unique \dfn{maximal globally hyperbolic development} $(M, g, \iota)$ of $(\Sigma, \overline g, \overline k)$; i.e. a globally hyperbolic development such that for any globally hyperbolic development $(\hat M, \hat g, \hat \iota)$, there is an isometric embedding $\Phi: \hat M \to M$ such that the diagram
$$\begin{tikzcd}
    \hat M \arrow[rr, "\Phi"] && M\\
    &\Sigma \arrow[lu, "\hat \iota"] \arrow[ru, "\iota"]
    \end{tikzcd}$$
    commutes.
\end{theorem}
    By lower-order terms we mean those of first or zeroth order (those which may serve as quasilinear perturbations of the d'Alembertian, which is a second-order linear operator). The idea of the proof is to write $\Ric_{\alpha\beta}$ as a quasilinear wave equation and use local well-posedness to construct local solutions, then glue all the local solutions together using Zorn's lemma.
\begin{proof}
    We have
\begin{align*}
    \Ric_{\alpha\beta} &= \partial_\mu \Gamma^\mu_{\alpha\beta} - \partial_\alpha \Gamma^\mu_{\mu\beta}\\
    &= \frac{1}{2} g^{\mu\nu} \partial_\mu \partial_\nu g_{\alpha\beta} - \frac{1}{2} g^{\mu\nu} \partial_\alpha\partial_\beta g_{\mu\nu} + \frac{1}{2} g^{\mu\nu}\partial_\alpha\partial_\nu g_{\beta\nu} + \frac{1}{2}g^{\mu\nu} \partial_\beta \partial_\mu g_{\alpha\nu}\\
    &= \frac{1}{2} \partial^\nu \partial_\nu g_{\alpha\beta} + \partial_\alpha \Gamma_\beta + \partial_\beta \Gamma_\alpha
\end{align*}
where
$$\Gamma_\beta = \frac{1}{2} g^{\mu\nu} \partial_\mu g_{\beta\nu} - \frac{1}{2} \partial_\beta g_{\mu\nu} = \frac{1}{2} g^{\mu\nu} \Gamma_{\mu\nu}^\alpha g_{\alpha\beta}.$$
Let
$$S_{\alpha\beta} = \Ric_{\alpha\beta} - \partial_\alpha \Gamma_\beta - \partial_\beta \Gamma_\alpha.$$
Then the equation $S_{\alpha\beta} = 0$ is a quasilinear wave equation, so is locally well-posed, and has a solution on a submanifold $M$ of $\RR \times \Sigma$.

Recall that $\widehat \Ric_{\alpha\beta}$ is the Einstein tensor and hence
$$\nabla^\alpha \widehat \Ric_{\alpha\beta} = 0.$$
Taking the hat and divergence of both sides of the definition of $S_{\alpha\beta}$, we have
$$\nabla^\alpha (\widehat{\nabla_\alpha \Gamma_\beta + \nabla_\beta \Gamma_\alpha}) = 0.$$
But
$$\widehat{\nabla_\alpha \Gamma_\beta + \nabla_\beta \Gamma_\alpha} = \nabla_\alpha \Gamma_\beta + \nabla_\beta \Gamma_\alpha - g_{\alpha\beta} g^{\mu\nu} \nabla_\mu \Gamma_\nu$$
so
$$0 = \nabla^\alpha \nabla_\alpha - \Gamma_\beta + \nabla^\alpha \nabla_\beta \Gamma_\alpha - g^{\mu\nu} \nabla_\beta \nabla_\mu \Gamma_\nu = \nabla^\alpha \nabla_\alpha \Gamma_\beta.$$
Therefore $\Gamma$ solves the wave equation. Since the wave equation is well-posed, it suffices to show therefore that $\Gamma|_\Sigma = 0$ and $\partial_t \Gamma|_\Sigma = 0$. For $i,j$ spatial coordinates, we set $g_{ij}|_\Sigma = 0$ and $g_{tt}|_\Sigma = -1$, $g_{ti}|_\Sigma = 0$, $\partial_t g_{ij}|_\Sigma|_\Sigma = 2\overline k_{ij}$, and $\partial_t g_{t\alpha}|_\Sigma = 0$. Then $\Gamma|_\Sigma = \partial_t\Gamma|_\Sigma = 0$ by the Gauss-Codazzi equations. Thus with these initial conditions, $S_{\alpha\beta} = \Ric_{\alpha\beta}$ so the Einstein equation reduces to the quasilinear wave equation $S_{\alpha\beta} = 0$, and the solution manifold $M$ solves the vacuum Einstein equation, which is therefore locally well-posed.

Now let $\mathcal M$ be the class of globally hyperbolic developments of $(\Sigma, \overline g, \overline k)$, ordered by isometric embeddings which commute with the inclusions $\iota$. This class is proper, but taking a quotient by isometry, we arrive at a poset. Taking injective limits, we show that every chain has an upper bound, so $\mathcal M$ has a maximal element $\iota: \Sigma \to M$, the \dfn{set-theoretic maximal globally hyperbolic development}. It remains to show that $\iota$ is maximal in the sense of the definition of maximal globally hyperbolic development (and hence unique).

Let $\hat \iota: \Sigma \to \hat M$ be a set-theoretically maximal globally hyperbolic development. We must construct a isometric embedding $\Phi: \hat M \to M$ making the diagram commute. By a \dfn{partial isometric embedding} of $\hat M$ into $M$ we mean a isometric embedding $\hat U \to M$ for some open set $\hat U \subseteq \hat M$. By local well-posedness, every point is contained in a neighborhood which admits a partial isometric embedding that makes the diagram commute, and by local uniqueness, they satisfy the cohomological conditions in the definition of a sheaf. Therefore there is a global partial isometric embedding, which is of course $\Phi$.

We define the \dfn{development-theoretic union} $M \cup \hat M = M \coprod \hat M/\Phi$, where the coproduct $\coprod$ is the sense of disjoint union. All conditions in the definition of a globally hyperbolic development are easily checked for $M \cup \hat M$ except that $M \cup \hat M$ is Hausdorff.

Assume that $M \cup \hat M$ is not Hausdorff at a point $x \in M \cup \hat M$. Then $x \in \partial (M \cup \hat M)$, and by a difficult computation in Lorentzian geometry, there is a spacelike hypersurface $S$ which touches $\partial M$ exactly at $x$. Away from $x$, $S$ and $\Psi(S)$ determine the same initial-data set. But by continuity, $S$ and $\Psi(S)$ determine the same initial-data set at $x$ as well.

But $x$ lifts to a regular point in $M \coprod \hat M$ (and let us assume without loss of generality that $x$ then lifts to a regular point in $M$), so there is a globally hyperbolic development extending from a $S$-neighborhood of $x$ by local well-posedness. Since $M$ is set-theoretically maximal, $x$ does not lift to a point of $\partial M$. Therefore $x \notin \partial (M \cup \hat M)$, a contradiction.

It follows that $M \cup \hat M$ is Hausdorff, and hence a globally hyperbolic development which contains $M$. So $M \cup \hat M = M$, and it follows that $\hat M = M$. So $M$ is a globally hyperbolic development.
\end{proof}

\section{Spherical symmetry}
We now make a simplifying assumption to get rid of annoying obstructions in Lorentzian geometry: that of spherical symmetry.

\begin{definition}
    A spacetime $(M, g)$ is \dfn{spherically symmetric} if there is a $SO(3)$-action on $M$ by $g$-isometries such that every $SO(3)$-orbit is a manifold of dimension at most $2$.
\end{definition}
Then the only possible orbits are fixed points and spheres of positive radius. For $p \in M$ we let $S_p$ denote the orbit of $p$, and let $r(p)$ denote the radius of $S_p$, which can be intrinsically defined by
$$r(p) = \sqrt{\frac{\mu(S_p)}{4\pi}},$$
$\mu$ denoting area. Then zeroes of $r$ are fixed points of $SO(3)$.

When $r(p) > 0$, the induced metric on $S_p$ is given by
$$g|_{S_p} = r^2 \underline g$$
where $\underline g$ is the Riemannian metric of the unit $2$-sphere $S^2$.

We let $\Q = M/SO(3)$, so $\Q$ is a Lorentzian $(1+1)$-manifold with boundary $\Gamma = \partial \Q$. Then
$$g = g_\Q + r^2 \underline g.$$

\section{Double-null pairs}
\begin{definition}
    A \dfn{double-null pair} on $M$ is a pair of $SO(3)$-invariant smooth functions $u, v: M \to \RR$, increasing in time, such that
    $$g^{\alpha\beta} du_\alpha du_\beta = g^{\alpha\beta} dv_\alpha dv_\beta = 0$$
    and such that $du, dv$ are linearly independent on every cotangent space. If we view $u,v$ as coordinates on $M$ and let $\theta, \varphi$ be the usual polar coordinates on $S^2$, the tuple $(u, v, \theta, \varphi)$ is known as a system of \dfn{double-null pair coordinates}.
\end{definition}
    Assuming that $M$ has double-null pair coordinates,
    $$\underline g = d\theta^2 + \sin^2 \theta ~d\varphi^2$$
and
    $$g_\Q = - \Omega^2 du \cdot dv$$
    for some function $\Omega$.
\begin{definition}
    The function $\Omega$ determined by double-null pair coordinates is called the \dfn{null lapse} of the double-pull pair.
\end{definition}
    Let us assume that every spacetime admits a double-null pair coordinate system.

    We have $g_{uu} = g_{vv} = 0$ and
    $$g_{uv} = - \frac{1}{2} \Omega^2.$$
In particular we have
$$g = \begin{bmatrix}
&2^{-1}\Omega^2\\
2^{-1}\Omega^2\\
&&r^2\\
&&&r^2\end{bmatrix}$$
so
$2\sqrt{-\det g} = $
    We will always write the angular coordinates with capital letters.

    By reparametrizing $u,v$ to have bounded range, we can embed $\Q$ into a compact subset of the Minkowski spacetime $\RR^{1+1}$.
\begin{theorem}
    Let $(u, v, \theta, \varphi)$ be a double-null coordinate system with null lapse $\Omega$ and let $\phi$ be a spherically symmetric scalar field. Then
    $$\Box_g \phi = -4 \Omega^{-2}(\partial_u \partial_v \phi + r^{-1}\partial_u r \partial_v \phi + r^{-1} \partial_v r \partial_u \phi).$$
    Besides this, we can write the Einstein tensor $G_{\alpha\beta}$ as
\begin{align*}
    G_{uu} &= \Ric_{uu} &= -2r^{-1} \Omega^2 \partial_u (\Omega^{-2} \partial_u r)\\
    G_{vv} &= \Ric_{vv} &= -2r^{-1} \Omega^2 \partial_v (\Omega^{-2} \partial_v r)\\
    G_{uv} &= \Ric_{uv} - \frac{1}{2} g_{uv}R &= 2r^{-1} \partial_u \partial_v r + 2r^{-2} \partial_u r \partial_v r + \Omega^2r^{-2}\\
    G_{AB} &= \Ric_{AB} - \frac{1}{2}g_{AB} &= -4r^2 Omega^2\underline g_{AB}(\Omega^{-1} \partial_u \partial_v \Omega - \Omega^{-2} \partial_u \Omega \partial_v \Omega + r^{-1} \partial_u \partial_v r)
\end{align*}
    and all other entries determined by symmetry or vanishing.
\end{theorem}
From this, it is easy to see that the Einstein vacuum equation in spherical symmetry can be expressed as
\begin{align*}
    \partial_u(\Omega^{-2}\partial_u r) &= 0\\
    \partial_v(\Omega^{-2}\partial_v r) &= 0\\
    \partial_u \partial_v r + 2r^{-1} \partial_u r \partial_v r + (2r)^{1} \Omega &= 0\\
    \partial_u \partial_v \Omega - \Omega \partial_u \Omega \partial_v \Omega - \Omega r^{-2}(2\partial_u r \partial_b r + 2^{-1}\Omega^2) &= 0.
\end{align*}
The wave operator in spherical symmetry has principal part $\partial_u \partial_v$. So we view the first two Einstein equations as constraint equations (called \dfn{Raychaudhuri equations}) and the last two Einstein equations as quasilinear wave equations.

\section{Local rigidity}
We show that the Raychaudhuri equations form a strong constraint on the sort of solutions we are allowed to study.
\begin{lemma}
    Consider the quasilinear wave equation
    $$\partial_u\partial_v \Phi = N(\phi, \partial \Phi)$$
    where $N$ is $C^1$. If $\Phi$ is a $C^1$ solution to the equation with $\Phi$ prescribed on the future-pointing lightcone centered at a point $p \in M$, then $\Phi$ is unique.
\end{lemma}
Since this is a wave equation, we expect to need $\partial \Phi$ as initial data as well in order for $\Phi$ to be unique. But the lightcone consists exactly of characteristic curves of $\Phi$, one of which determines $\partial_u \Phi$ and the other determines $\partial_v \Phi$ -- and they must be compatible since $p$ touches both curves.
\begin{proof}
    Notice that
    $$\partial_u \partial_v \Psi (\partial_u + \partial_v) \Psi = .5 \partial_v(\partial_u \Psi)^2 + .5 \partial_u(\partial_v \Psi)^2.$$
    Assume that $\Phi, \Phi'$ are solutions and let $\Psi = \Phi - \Phi'$. Then
    $$\partial_u \partial_v \Psi = \Psi\partial_\Phi N(\Phi, \partial \Phi) +  O(\Psi, \partial \Psi).$$
    Integrate along a future-pointing ``diamond" whose first vertex is $p = (0, 0)$ and whose sides are given by (or are perpendicular to -- we call these $C_u$ and $C_v$) the characteristic curves $C_0, \underline C_0$). This gives
$$\frac{1}{2}\left(\int_{C_u} (\partial_v \Psi)^2 + \int_{C_v} (\partial_u \Psi)^2  - \int_{C_0} (\partial_v \Psi)^2 - \int_{\underline C_0} (\partial_u \Psi)^2 \right) \leq C \int_D |\Psi| |\partial \Psi| + C\int_D |\partial \Psi|^2.$$
    The integrals along $C_0$ and $\overline C_0$ are $0$ because $\Phi = \Phi'$ there by assumption. So we have
    $$\int_{C_u} (\partial_v \Psi)^2 + \int_{C_v} (\partial_u \Psi)^2 \leq C \int_D |\Psi| |\partial \Psi| + \int_D |\partial \Psi|^2.$$
    We use Gronwall's inequality to control the right-hand side.
    Now
    $$\Psi(u, v) = \int_0^v \partial_v \Psi(u, \cdot)$$
    which then vanishes. So this energy estimate gives $\Psi = 0$.
\end{proof}
\begin{theorem}[Birkhoff]
    \index{Birkhoff's theorem on local rigidity}
    Up to gauge symmetry, the solution to the Einstein vacuum equation in spherical symmetry near a point $p \in M$ is determined by $r(p)$, the signs $\sigma_\nu, \sigma_\lambda$ of $\partial_u r(p)$ and $\partial_v r(p)$, and $g^{\mu\nu} \partial_\mu \partial_\nu r(p)$.
\end{theorem}
\begin{proof}
    If $u,v$ are a future-pointing double-null pair, and we transform them to $(\tilde u, \tilde v)$ where $\tilde u > 0$ only depends on $u$ and similarly for $\tilde v$, then $(\tilde u, \tilde v)$ are a future-pointing double-null pair. This transformation results in the transformation of $\Omega$ by
$$-\Omega^2 ~du~dv = -\tilde \Omega^2 ~d\tilde u ~d\tilde v = -\tilde \Omega^2 \tilde u' \tilde v' ~du ~dv$$
so $\tilde \Omega^2 \tilde u' \tilde v' = \Omega^2$.
    Let $\underline c_p$, $c_p$ be the curves of the future-pointing lightcone along $u, v$ from $p$. Then we can choose $\tilde u, \tilde v$ so that $\tilde \Omega = 1$ on $\underline c_p, c_p$. Let us henceforth work in the coordinates $\tilde u, \tilde v$ (so $\Omega = \tilde \Omega$).

    By the lemma, we only need to determine $\Omega$ and $r$ along $\underline c_p, c_p$, and this will uniquely determine the solution inside any diamond with two sides that lie along $\underline c_p, c_p$; then make the diamond as big as we need.

    Assume $\sigma_\nu = \sigma_\lambda = 0$. Applying the Raychaudhuri equations along $\underline c_p, c_p$, we have $\partial_u\partial_u r = 0$ on $\underline c_p$, so by the initial conditions we have $\partial_u r = 0$ on $\underline c_p$. Similarly $\partial_v r = 0$ on $c_p$. Thus $r = r(p)$.

    If $\sigma_\nu \neq 0$, $\sigma_\lambda \neq 0$, then we again have $\partial_u \partial_u r = 0$ along $\underline c_p$. The only remaining degree of freedom is our freedom to choose $g^{\mu\nu} \partial_\mu \partial_\nu r(p)$, which ends up determining $\partial_u r$. Therefore we know the value of $r$ along $\underline c_p, c_p$.

    Finally assume $\sigma_\nu \neq 0$ but $\sigma_\lambda = 0$. The proof is similar to the previous cases.

    We have proven uniqueness in the future-pointing lightcone of $p$. By time-reversal symmetry we obtain uniqueness in the past-pointing lightcone. By spherical symmetry, we can switch $u$ and $v$ with $-u$ and $-v$ and run the same argument for the ``left-pointing lightcone" and the ``right-pointing lightcone" which is all four cones that are around $p$.
\end{proof}
    The point is that $r,\sigma_\nu,\sigma_\lambda$, and $\mu_0 = g^{\mu\nu}\partial_\mu r \partial_\nu r(p)$ are geometric data, and don't depend on the choice of coordinates; but everything that isn't determined by these terms is determined by our choice of coordinates. Actually, $\mu_0$ is only needed when $\sigma_\nu$ and $\sigma_\lambda$ are nonzero.
\begin{definition}
    The \dfn{Hawking mass} is a function $m$ on spherically symmetric spacetime defined by
    $$g^{\mu\nu} \partial_\mu r \partial_\nu r = 1 - 2mr^{-1}.$$
\end{definition}
    Note that $m$ does not depend on a choice of coordinates since neither does $r$.
\begin{lemma}
    The Hawking mass is constant on connected components.
\end{lemma}
\begin{proof}
    We have
    $$-4\partial_ur\partial_vr\Omega^{-2} = g^{\mu\nu} \partial_\mu r \partial_\nu r$$
    so by implicit differentation we have
    $$-2r^{-1}\partial_u m + 2 \partial_u r r^{-2} m = -4 \partial_ur \Omega^{-2} \partial_u\partial_v r.$$
    Doing a bunch of algebra we see $\partial_u m = \partial_v m = 0$.
\end{proof}
When $m = 0$ we will end up with Minkowski spacetime. If $m > 0$ one can show that the null lapse is given by
$$\Omega^2 = -\sigma_\nu\sigma_\lambda(1 - 2mr^{-1}).$$
This gives a certain metric that we call the Schwarzschild metric.
\begin{definition}
The \dfn{Schwarzschild metric} is the metric
$$g = -\sigma_\nu\sigma_\lambda (1 - 2mr^{-1}) ~dudv + r^2 \underline g.$$
\end{definition}
One can construct a maximal Schwarzschild spacetime. In fact if we define $\mu$ by $1 - \mu = g^{\alpha\beta}\partial_\alpha\partial_\beta r$, then $r\mu$ is constant, and in fact we take $r\mu = 2m$. Doing some algebra and using the Raychaudhuri equations, we have $\Omega^2 = |1-2mr^{-1}|$. If $r \to r_0$ as $v \to \infty$, then $\partial_v r \to 0$, i.e. $r_0 = 2m$.

We now rephrase Birkhoff's theorem.
\begin{corollary}
    If $(M, g)$ is a spherically symmetric solution to the Einstein vacuum equation then $(M, g)$ is locally isometric to an open subset of a Schwarzschild spacetime.
\end{corollary}

We think of Schwarzschild spacetime as an easy example of a black hole spacetime, for $m > 0$. Choosing our signs correctly, we have
$$g = -(1-2mr^{-1})~dudv + r^2 \underline g = -dudv + r^2 \underline g + o(1)$$
so that $g$ approximates Minkowski spacetime for $r$ large enough (or $m$ small enough; if $m = 0$ it is Minkowski spacetime, with the singularity $r = 0$ artifically added by the choice of coordinates). That is, $g$ is asymptotically flat, so models a gravitational system (where the mass is concentrated in a compact set -- say, all the mass is inside some star.) In particular, if the observer is not massless, then the observer is at $r = \infty$. Drawing the Penrose diagram, our causal past, looking in from $r = \infty$, is $r > 2m$. Thus no matter how far in the future we are, we lie in the causal complement of the region $r < 2m$.
\begin{definition}
    The boundary $r = 2m$ of a black hole is called the \dfn{event horizon}. The region $r < 2m$ is called a \dfn{black hole}.
\end{definition}
In fact we have $R_{\mu\nu\alpha\beta}R^{\mu\nu\alpha\beta} \geq Cm^2r^{-6}$, so the spacetime has infinite curvature at $0$.

But assume $m < 0$. Then $r = 0$ is a ``naked singularity", which lies in our causal past. A major conjecture, the \dfn{weak cosmic censorship conjecture}, is that for any physically meaningful spacetime, naked singularities do not exist. Note that the Schwarzschild spacetime with $m < 0$ is not a counterexample, because such a spacetime somehow has negative mass, which is absurd.

\section{Einstein-Maxwell equations}
Let $F_{\mu\nu}$ be a real-valued $2$-form on $M$, the \dfn{electromagnetic field}. If $(M, g)$ is Minkowski spacetime, we can take $E_i = F_{0i}$ and $B_i = \epsilon_{ijk}F^{jk}/2$, the Hodge dual of $E$, to recover the electric and magnetic fields.
\begin{definition}
    The \dfn{Maxwell equations} are the system $\nabla^\mu F_{\nu\mu} = 0$, $dF = 0$.
\end{definition}
Let us assume that $F$ is spherically symmetric; i.e. if $R \in SO(3)$ then $R^*F_{\mu\mu} = F_{\mu\nu}$, where we think of $SO(3)$ as the symmetry group of $(M, g)$. We will write
$$F = F_{uv} ~du\wedge dv + F_{\theta\varphi} ~d\theta \wedge d\varphi.$$
One can use algebraic topology to prove that that $F_{uv}$ is completely determined by $u,v$ and $F_{\theta\varphi}$ is completely determined by a function of $u,v$ as well as $\sin \theta$. Since $dF = 0$, $\partial_u F_{\theta\varphi} = 0$, and $\partial_v F_{\theta\varphi} = 0$. So actually $F_{\theta\varphi} = m \sin\theta ~d\theta \wedge d\varphi$ for some constant $m$. Also,
$$0 = \nabla^\mu F_{u\mu} = -2\Omega^{-2}\partial_u(r^2\Omega^{-2} F_{uv})$$
and similarly for $v$. Thus $\partial_u(r^2\Omega^{-2}F_{uv}) = 0$ and similarly for $v$. Thus $F_{uv} = e\Omega^2r^{-2}$ for some constant $e$.

\begin{theorem}[Weyl?]
    Every spherically symmetric solution $F$ of the Maxwell equation is given by
    $$F = e\Omega^2r^{-2}~du\wedge dv + b\sin \theta ~d\theta \wedge d\varphi.$$
\end{theorem}
Thus an electromagnetic field is completely determined by the pair $(e, m)$. In Minkowski spacetime, $e\Omega^2r^{-2} ~du\wedge dv = er^{-2} ~dt \wedge dr$ which is the electric field given by a point charge at the origin, while $b\sin \theta ~d\theta \wedge d\varphi$ is the magnetic flux through a sphere.

We now derive the Einstein-Maxwell system from the principle of least action. The Lagrangian density of the Einstein vacuum equation was $R~dV$ while the Lagrangian density of the Maxwell equation is $-F_{\alpha\beta}F^{\alpha\beta}/2$. Thus we have
\begin{align*}
    \Ric_{\alpha\beta} - \frac{1}{2}g_{\alpha\beta}R &= 2T_{\alpha\beta}\\
    T_{\alpha\beta} &= F_{\alpha\mu}F^\mu_\beta - \frac{1}{4}g_{\alpha\beta} F_{\mu\nu} F^{\mu\nu}\\
    \nabla^\alpha F_{\alpha\beta} = dF &= 0.
\end{align*}
As usual, $T_{\alpha\beta}$ is the energy-momentum tensor of the Maxwell equation. We now compute $T_{\alpha\beta}$ by
\begin{align*}
    T_{uu} = T_{vv} &= 0\\
    T_{uv} &= 4^{-1} \Omega^2 r^{-4}(b^2 - e^2)
\end{align*}
since
$$F_{\mu\nu} F^{\mu\nu} = 2(g^{uv})^2 (F_{uv})^2 + g^{AA'}g^{BB'} F_{AB} F_{A'B'} = 2r^{-4}(e^2 + b^2).$$
Moreover, $T_{AB}$ is proportional to $T_{uv}$. Thus, the Einstein-Maxwell equations in spherical symmetry, obtained by plugging into the Raychaudhuri and Einstein spherically symmetric equations, is
\begin{align*}
    0 &= -2r^{-1}\Omega^2 \partial_u (\Omega^{-2} \partial_ur)\\
    0 &= -2r^{-1}\Omega^2 \partial_v (\Omega^{-2} \partial_vr)\\
    0 &= 2r^{-1}\partial_u\partial_v r + 2r^{-2}\partial_ur\partial_vr + \Omega^22^{-1}r^{-2} - 2^{-1}\Omega^2r^{-4}(e^2 + b^2).
\end{align*}
\begin{theorem}
    Let $(M, g, F)$ be a spherically symmetric solution to the Einstein-Maxwell system. Then for any $p \in M$, the solution is determined in an open neighborhood $O$ of $p$ by $r$, $\mu$, $\sigma_\nu$, $\sigma_\lambda$, $e = 2r^2\Omega^{-2}F_{uv}$, and $b = \csc \theta F_{\theta \varphi}$.
\end{theorem}
\begin{proof}
    The electromagnetic field is rigid since we are in spherical symmetry. Now run the proof of Einstein vacuum equation rigidity (using the Raychaudhuri equations, which are the same as before) but with $T_{\alpha\beta}$ given by $(e, b)$.
\end{proof}
\begin{lemma}
    $d(1 - \mu) \wedge dr = 0$.
\end{lemma}
\begin{proof}
    Same as in the vacuum case, because $\Ric_{uu} = \Ric_{vv} = 0$.
\end{proof}
As a result, there are constants $C$ such that $1 - \mu = 1 - 2Cr^{-1} + 2C(e^2 + b^2)r^{-2}$. In fact, $1 - \mu = g^{\alpha\beta} \partial_u r \partial_v r = -4\partial_u r \partial_vr \Omega^{-2}$ so we have
$$d(1 - \mu) = -4d(\partial_u r \partial_v r\Omega^{-2}) = -4 \partial_u\partial_vr \Omega^{-2} (\partial_ur ~du + \partial_vr ~dv).$$
Therefore
$$d(1 - \mu) = -4\Omega^{-2}\partial_u\partial_vr ~dr.$$
Using the Einstein-Maxwell equations we see that if $f(r) = -r^{-1}(1 - \mu) + r^{-1} - (e^2 + b^2)r^{-3}$ then $d(1 - \mu) = f(r) ~dr$. In addition, if $h = 1 - \mu$ then $h' = f$ so $d(rh)/dr = 1 - (e^2 + b^2)r^{-2}$ whence $rh = C + r + (e^2 + b^2)r^{-1}$. This proves the above claim.

We now search for a global solution to the Einstein-Maxwell equation. We do this in Eddington-Finkelstein coordinates, which just means that $\partial_ur \Omega^{-2}$ is constant in one dimension and $\partial_vr \Omega^{-2}$ is constant in the other dimension. This is possible because of the Raychaudhuri equations. In these coordinates, $\Omega^2 = |1 - 2Cr^{-1} + (e^2 + b^2)r^{-2}|$ and $g = -\Omega^2 du~dv + r^2 \underline g$.

We look at the sign of the discriminant $C^2 - Q^2$ where $Q^2 = e^2 + b^2$. If $0 < |Q| < C$ then there are two solutions to the equation $1 - 2CR^{-1} + Q^2r^{-2} = 0$, namely $r_\pm = C \pm \sqrt{C^2 - Q^2}$. This is called the \dfn{subextremal case}.

By the Raychaudhuri equations the signs of $\partial_ur$ and $\partial_vr$ cannot change along the $u$ and $v$ directions respectively. So we can fix a sign for each and see what happens.

First take the case $\partial_ur < 0$, $\partial_vr > 0$. Assume that $r \to r_+$ as $u \to \infty$, $v \to -\infty$; then $r \to \infty$ as $u \to -\infty$, $v \to \infty$. Thus along every null curve, $r$ tends to $r_+$ in one direction and $\infty$ in the other direction. On the other hand, if we take ``initial data" $r = r_-$, then we hit $r = 0$ for some finite $u$, which is a singularity.

If $\partial_ur < 0$, $\partial_vr < 0$, then as $u \to -\infty$, $v \to -\infty$, $r \to r_+$. Similarly as $u \to \infty$, $v \to \infty$, $r \to r_-$.

Gluing together the above Penrose diagrams we construct all possible solutions to the Einstein-Maxwell equations in spherical symmetry. We have to make sure that $\Omega$ is continuous along the gluings, which can be guaranteed by a clever change of coordinates. The maximal such simply connected solution is called the \dfn{maximal Reissner-Nordstrom spacetime}. It is not compact.

In the \dfn{superextremal case} $Q^2 > C^2$ we recover the negative-mass Schwarzschild solution.

Finally we consider the \dfn{extremal case} $Q^2 = C^2$. The resulting maximal solution is the \dfn{Bertotti-Robinson spacetime}. One can show that
$$\partial_u\partial_v \log \Omega = 2r^{-2} \partial_u \partial_v r + ((2r^2)^{-1} - e^2r^{-4})\Omega^2$$
using the equation for the angular Einstein tensor $\Ric_{AB} - g_{AB}R/2$ and the angular energy-momentum $T_{AB} = Q^2$. One then shows that $\partial_u\partial_v \log \Omega = K\Omega^2$ for some $K = (2r_0^2)^{-1} - e^2 r_0^{-4}$. This is a constant-curvature spacetime.

\begin{theorem}[Birkhoff for Einstein-Maxwell]
    \index{Birkhoff's theorem}
    If $(M, g, F)$ is a spherically symmetric solution to the Einstein-Maxwell equation, then each point of $M$ is contained in an open set which is isometric to an open set of either the maximal Reissner-Nordstrom spacetime, the Bertotti-Robinson spacetime, a Schwarzschild spacetime, or the Minkowski spacetime.
\end{theorem}

\chapter{Cosmic censorship}
In GR, we are interested in two regimes: isolated gravitational systems (asymptotically flat spacetimes; there is a singularity at one point and everything else is a vacuum, so we are studying the dynamical structure) and cosmological systems (where we are modeling the entire universe, and we want to study the topological structure). For now, we will study the isolated case, and view it as a Cauchy problem.

Notice that the Cauchy problem behaves quite strange in the negative Schwarzschild spacetime $(M, g)$. Suppose we have an initial-data set $\Sigma$ for $M$; then, a geodesic in $\Sigma$ along which $r \to 0$ cannot be extended to the future. Drawing the Penrose diagram we see that the negative Schwarzschild spacetime is ``not deterministic," i.e. $\Sigma$ does not uniquely determine the future because we cannot extend it into the future-pointing lightcone of the black hole.

At least in a positive Schwarzschild spacetime, these ``incomplete geodesics" are inside the black hole region. Therefore the observer at infinity cannot see the singularity, where we cannot extend an initial data set to the future. But in the negative Schwarzschild spacetime, the observer sees the singularity. But negative Schwarzschild spacetimes have negative mass by definition, which makes no sense physically.

We thus state the weak cosmic censorship conjecture: an observer at infinity cannot see a singularity in a ``typical" physically meaningful spacetime.

We call the future boundary of a Penrose diagram (limiting points of radial null geodesics along which $r \to \infty$) the \dfn{null infinity} of the spacetime. A spacetime has \dfn{complete null infinity} if the lengths of geodesics parallel to null infinity tend to $\infty$ as $r \to \infty$. In the negative Schwarzschild spacetime, the null infinity was incomplete because the null infinity was the limit of the causal future of the initial-data set, which was compact.

We will be deliberately vague about what we mean by a \dfn{reasonable Einstein-matter system}, but it will be the Einstein equation coupled to physically meaningful Lagrangian densities (i.e. the Maxwell density, the vacuum density, etc.) Similarly for \dfn{physically-meaningful initial-data set} but in particular the initial-data set should be a \dfn{geodesically complete manifold}. (This means that you can ``follow a geodesic forever"; or in other words the domain of the exponential map $T\Sigma \to \Sigma$ is defined on all of $T\Sigma$.) This rules out the punctured line and manifolds with boundary, because those have singularities we can run into in finite distance, which does not seem physically reasonable.

By generic we mean in the sense of the Baire category theorem. In fact, Christodoulou has proven that a naked singularity is unstable, and under a slight perturbation of $g$ necessarily collapses into a black hole, and so is hidden from the observer at infinity, as in the positive Schwarzschild spacetime.
\begin{conjecture}[weak cosmic censorship]
    Given a generic physically-meaningful initial-data set to a reasonable Einstein-matter system in an asympotically flat universe, the future maximal globally hyperbolic development has complete null infinity.
\end{conjecture}

Recall that by definition, the maximal globally hyperbolic development ends at the spacelike hypersurface wherein the development fails to be unique. This region is called a \dfn{Cauchy horizon}. In a Reissner-Nordstrom black hole, there is a Cauchy horizon, so that a test particle falling into a black hole is NOT unique.
\begin{conjecture}[strong cosmic censorship]
    Given a generic physically-meaningful initial-data set to a reasonable Einstein-matter system in an asymptotically flat universe, the future maximal globally hyperbolic development is inextendible as a smooth Lorentzian manifold.
\end{conjecture}

\section{Einstein-Maxwell-charged scalar field equations}
The most complicated model of the cosmic censorship conjectures is the \dfn{Einstein-Maxwell-charged scalar field} equation. A scalar field $\phi$ is a section of a complex line bundle $E$ whose structure group is the orthogonal group $O(1)$. This gives rise to a connection $D$ on $E$ and
$$F_{\alpha\beta} = [D_\alpha, D_\beta].$$
Locally, we have $D_\alpha = \partial_\alpha + iA_\alpha$. The action is given by
$$\rho(\phi, D, g) = \int R ~dV(g) - \int F^{\alpha\beta}F_{\alpha\beta} ~dV_g - 2 \int \langle D^\alpha\phi, D_\alpha\phi\rangle ~dV_g$$
where $\langle \phi, \psi \rangle = \Re(\phi\overline\psi)$ is the natural real-valued inner product on a complex line bundle.

In case $\phi = 0$, the Einstein-Maxwell-charged scalar field reduces to the Einstein-Maxwell system, but it is dynamical because it solves the wave equation with connection $D$, namely
$$D_\alpha D^\alpha \phi = 0.$$
However, the Einstein-Maxwell-charged scalar field is too hard to study directly, so we restrict to subsystems thereof.
\begin{example}
    The \dfn{Einstein-scalar field} equation or \dfn{Christodoulou model} is the Einstein-Maxwell-charged scalar field with trivial Maxwell tensor, $F_{\alpha\beta} = 0$. Then $D = \partial$, so we do not need to worry about the curvature of the line bundle. That is, we can think of $\phi$ as a mapping $\phi: M \to \RR$. It is the model that we will study when we consider the weak cosmic censorship conjecture.
\end{example}
\begin{example}
    The \dfn{Einstein-Maxwell-uncharged scalar field} equation or \dfn{Daferemos model} is the system obtained by decoupling $\phi$ from $F$. In other words, $\phi: M \to \RR$ (so the curvature of the line bundle is trivial). It is the model where Reichner-Nordstrom spacetimes make sense, so we study the strong cosmic censorship here.
\end{example}

We now study the (relativistic) kinetic theory of the Einstein equation. Let $M$ be a spacetime, so $T^*M$, the cotangent bundle, has a natural symplectic form, namely
$$\omega = dx^\alpha \wedge dp_\alpha.$$
Here $x^\alpha$ is a coordinate system on $U \subseteq M$ and we view a covector as $p_\alpha ~dx^\alpha$. Given $H \in C^\infty(T^*M)$ we define the \dfn{Hamiltonian vector field} by
$$(X^H)^\alpha = \omega^{\alpha\beta}~dH_\beta.$$
In case $H = 2^{-1}p^\alpha p_\alpha$ then $X^H$ is the vector field on the cotangent bundle whose flow restricts to the Hamiltonian flow on $M$. We apply the Legrende transform $(x^\alpha, p_\alpha) \mapsto (x^\alpha, p^\alpha)$ we get a flow on $TM$ for which $\dot x^\alpha = p^\alpha$, $\dot p^\alpha = -\Gamma^\alpha_{\beta\gamma} p^\beta p^\gamma$. We let $\Phi^H$ denote the induced flow of $X_H$.

\begin{definition}
    A \dfn{Vlasov field} is a positive measure $\mu$ on $T^*M$ which is invariant under the pullback by $\Phi^H_t$ for every $t$; that is,
    $$\mu = (\Phi_t^H)^* \mu.$$
\end{definition}
    In Newtonian mechanics, one assumes that the Vlasov field is absolutely continuous with respect to the natural volume form $\epsilon$ induced by the symplectic form $\mu$. Using the Radon-Nikodym theorem, we find an $f$ so that $\mu = f \epsilon$. Since $\Phi^H$ preserves $\epsilon$ we just need to check that $X^Hf = 0$, the \dfn{Vlasov equation}.

    Now $T^*M$ is foliated by level hypersurfaces of $H$, and $X^HH = 0$, so $\Phi^H$ preserves the foliation of $T^*M$. Now a null geodesic is one arising from the flow restricted to $H = 0$, and timelike geodesics are those for which $H = -1$. To restrict to future-pointing geodesics we assume $p^0 < 0$. Thus we define $P_0^+$ to be the $(x, p)$ with $H(x, p) = 0$ and $p^0 < 0$. Similarly for $P_1^+$ where we have $H(x, p) = -1$. These level hypersurfaces are $7$-manifolds and we search for a top form on them. Now
    $$\epsilon_{P^+_\sigma} = c~dH\wedge\omega\wedge\omega\wedge\omega$$
    for some function $c$ allowed to depend on $\sigma \{0, -1\}$. For $\mu = f \epsilon_{P^+_\sigma}$, $X^Hf = 0$ iff
    $$p^\alpha \partial_\alpha f = \partial_\alpha g^{\beta\gamma} p_\beta p_\gamma \partial_\alpha f = 0.$$
    Of course if $\sigma = 0$ then we are thinking of our particle as a photo (no mass) so we say that this is the ``massless" case and $\sigma = -1$ is the ``massive" case.
\begin{definition}
    Let $\mu$ be a Vlasov field which is absolutely continuous with respect to $\epsilon_{P^+_\sigma}$. The \dfn{associated energy-momentum tensor} $T_{\alpha\beta}$ of $\mu$ is given weakly by (with $\varphi$ a test function)
    $$\int_M T_{\alpha\beta})x \varphi(x) ~dV(g) = \int_{T^*M} p_\alpha p_\beta \varphi(x) ~d\mu.$$
    The \dfn{number density} is
    $$\int_M N_\alpha(x) \varphi(x) ~dV(g) = \int_{T^*M} p_\alpha \varphi(x) ~d\mu.$$
\end{definition}
    Since $\mu$ is absolutely continuous, it is supported on the $7$-manifold which is a level hypersurface of $H$. If $f$ is the Radon-Nikodym derivative, then
    $$T_{\alpha\beta}(x) = \int_{T^*M} p_\alpha p_\beta f(-\det g)^{-1/2}\epsilon_{P^+_\sigma}|_{T^*_xM}$$
    and
    $$N_\alpha(x) = \int_{T^*M} p_\alpha f(-\det g)^{-1/2}\epsilon_{P^+_\sigma}|_{T^*_xM}.$$

    To couple the Vlasov field to the Maxwell equation we take $N_\beta = \nabla^\alpha F_{\alpha\beta}$ and
    $$2H = g^{\alpha\beta}(p_\alpha + A_\alpha)(p_\beta + A_\beta).$$

\begin{example}
    A subsystem of the Einstein-Vlasov system is the \dfn{Einstein-null dust system}. It is too simple to be realistic but is useful to demonstrate computations. The interpretation is that everything travels along radial null geodesics. So there is no mass, and the physical system consists solely of radiation moving radially.

    An \dfn{null dust field} which is outgoing is characterized by having energy-momentum tensor $T_{\alpha\beta}$ such that
    $$T^{out}_{uu} \geq 0$$
    with other components zero. Similarly $T^{in}_{vv} \leq 0$ for incoming null dust fields. Now $\nabla^\alpha T_{\alpha\beta} = 0$ so $\partial_v T_{uu}^{out} = 0$. (Similarly $\partial_u T_{vv}^{in} = 0$.)

    We will assume that there are two noninteracting null dusts, one incoming and one outgoing. That is, the Einstein-null dust equation is given by
    $$\Ric_{\alpha\beta} -\frac{1}{2}g_{\alpha\beta}R = 2(T^{in}_{\alpha\beta} + T^{out}_{\alpha\beta}).$$
\end{example}

\section{The structure of toy models}
    Two basic papers about the a priori characterizations of solutions to spherically symmetric toy models are Daferemos ``Spherically symmmetric spacetimes with a trapped surface" and Komnemi ``The global structure of a spherically symmetric charged scalar field spacetime". Let us give a shallow introduction to this theory.

    We will let $(M, g)$ be the $1+3$-dimensional maximal globally hyperbolic development with a spherically symmetric initial data set $\Sigma_0$. Let $(Q, g_Q)$ be the quotient of $(M, g)$ by $SO(3)$. We will assume that $\Sigma_0$ is diffeomorphic to $\RR^3$ or $\RR \times S^2$. (The latter is the initial-data set of the spacetimes for which we will study the strong cosmic censorship conjecture.)

    If $\Sigma_0 = \RR^3$, then by algebraic topology, there is a fixed point of $SO(3)$. In other words, the set $\Gamma = \{r = 0\}$ has
    $$\Gamma \cap \Sigma_0 = \{p\}.$$
    On the other hand, if $\Sigma_0 = \RR \times S^2$, then $SO(3)$ cannot have any fixed points.

    By global hyperbolicity, there is a future-pointing double null pair $(u, v)$ on $Q$. The existence of a double null pair implies that there is an embedding $Q \to \RR^2$, i.e. a Penrose diagram. We will write $\overline Q$ for the closure of $Q$ inside $\RR^2$; i.e. if $Q$ is not a closed manifold then we will take it to be a manifold with boundary.

\begin{definition}
    $T_{\alpha\beta}$ obeys the \dfn{dominant energy condition} if for every causal, future-pointing vectors $x, y$,
    $$T_{\alpha\beta}x^\alpha y^\beta \geq 0.$$
\end{definition}
    In fact, $T_{\alpha\beta} \dot \gamma^\alpha = J_\beta$ should be interpreted as the ``energy-momentum" along $\gamma$. In fact, the coordinate of $J_\beta$ along $\gamma$ is the energy along $\gamma$. So the dominant energy condition says that there is positive energy.

    In spherical symmetry, the dominant energy condition is equivalent to $T_{uu} \geq 0$, $T_{vv} \geq 0$, $T_{uv} \geq 0$. It follows that $\Ric_{uu} \geq 0$, $\Ric_{vv} \geq 0$. Since
    $$\Ric_{uu} = -2r^{-1}\Omega^2 \partial_u (\Omega^{-2}\partial_ur)$$
    it must be that the sign of $\partial_ur$ is preserved, and similarly for $\partial_vr$. Thus $r$ is monotone in $u$ and $v$ separately.

    Henceforth we assume the dominant energy condition. It therefore makes sense to also assume the antitrapping condition:
\begin{definition}
    $\Sigma_0$ obeys the \dfn{antitrapping condition} if: if $\Sigma_0 = \RR^3$ then $\partial_ur < 0$ on $\Sigma_0$; if $\Sigma_0 = \RR \times S^2$ then $\partial_ur < 0$ on some $\Sigma_0'$ a connected subset of $\Sigma$ which meets the ideal endpoint of $\Sigma_0$ on the right.
\end{definition}
    Let
    $$Q' = \{(u, v) \in Q: \exists u_0~(u_0(v), v) \in \Sigma_0\}.$$
    Then the antitrapping condition implies that $\partial_ur < 0$.
\begin{definition}
    Assume the antitrapping condition. $(u, v) \in Q'$ is \dfn{trapped} if $\partial_vr < 0$. $(u, v) \in Q'$ is \dfn{regular} if $\partial_ur > 0$. $(u, v)$ is \dfn{marginally trapped} if $\partial_vr = 0$.

    Because of these conventions, we say that $u$ is incoming and $v$ is outgoing.
\end{definition}
    In a black hole, every point is trapped. The event horizon is marginally trapped. Formally, if $T$ is the set of trapped points, and $(u, v')$ lies in the future of $(u, v)$, then $(u, v) \in T$ implies $(u, v') \in T$.
\begin{theorem}[Penrose singularity theorem]
    \index{Penrose singularity theorem}Suppose that $T$ is nonempty. Then there is an incomplete outgoing null geodesic.
\end{theorem}
    Recall that a geodesic $\gamma$ is complete if for every $t$ such that $\gamma_{\dot \gamma}\dot \gamma(t) = 0$ ($t$ is an \dfn{affine paramter}), $\gamma(t)$ exists. This is not the case if $\gamma$ runs into a boundary. That is, there is an incomplete geodesic the exponential map $TM \to M$ fails to be defined far away from the origin of each tangent space. Incomplete null geodesics can be interpreted physically as meaning that a light wave fails to exist after traveling a finite distance.
\begin{proof}
    Let $(u_0, v_0) \in T$ be trapped, and let $(u_1, v_1)$ be the endpoint of the outgoing null geodesic from $(u_0, v_0)$. This is finite because we embedded $Q$ in $\RR^2$. Now we compute
    $$\int_{v_0}^{v_1} \Omega^2(u, v) ~dv$$
    and use the Raychaudhuri equations and the trapping conditions to conclude that the integral is the integral of a bounded function over a compact set. So it's finite, hence an affine parameter.
\end{proof}
    Actually the Penrose singularity theorem holds in much greater generality. The existence of trapped surfaces is an open condition on the moduli space of all initial-data sets, which implies that there is a \emph{stable} singularity, which necessarily follows from the existence of black holes.

\section{Penrose inequalities}
We generalize the result that says that the mass of the universe is positive if there are no black holes, to bound the mass of the universe in terms of the radius of the black hole. We follow Daferemos's paper ``Spherically symmetric spacetimes with a trapped surface".

Let $(M, g)$ be a spherically symmetric solution to the Einstein equation, which is the future maximally globally hyperbolic development of a spherically symmetric initial-data set $\Sigma_0$, where $\Sigma_0$ is either homeomorphic to $\RR^3$ to $\RR \times S^2$. Let $Q = M/SO(3)$ be the Penrose diagram of $(M, g)$. We will assume the dominant energy condition on the energy-momentum tensor $T$ (i.e. $T_{uu} \geq 0$, $T_{vv} \geq 0$, $T_{uv} \geq 0$). We also assume that there are no antitrapped spheres (which for $\Sigma_0 = \RR^3$ means that $\partial_ur < 0$ on $\Sigma_0$.)

Let $Q'$ be the set of points in the Penrose diagram which are in the image of an incoming null curve from $\Sigma_0$. By the Raychaudhuri equations and the assumption on antitrapped spheres, $\partial_ur < 0$ on $Q'$.

Let $A$ be the apparent horizon, i.e. those $(u, v)$ for which $\partial_vr(u, v) = 0$. Every event horizon is contained in the apparent horizon.

Let $U$ be the set of $u$ such that $\sup_v r(u, v) = \infty$. Thinking of $Q$ as a bounded subset of $\RR^2$ we let $\zeta^+$ be the set of $(u,v) \in \partial U$ such that $u \in U$.
\begin{definition}
    $\zeta^+$ is the \dfn{future null infinity} of $Q$.
\end{definition}
\begin{lemma}
    If $\zeta^+$ is nonempty, then it is a connected incoming null curve emanating from the interior.
\end{lemma}
\begin{proof}
    If $(u, v) \in \zeta^+$ then we can find a point on $\Sigma_0$ whose lightcone includes $(u, v)$.
\end{proof}
\begin{lemma}
    $J^-(\zeta^+) \subseteq R$, the set of regular points.
\end{lemma}
    So a particle cannot end up in the future null infinity if it is trapped or lies on an event horizon.

Recall that the Hawking mass $m$ at $(u, v)$ is defined by
$$1 - \frac{2m}{r} = -4 \frac{\partial_ur\partial_vr}{\Omega^2}.$$
\begin{lemma}
    One has $\partial_um = 2r^2\Omega^{-2} (T_{uv}\partial_ur - T_{uu}\partial_vr)$ and similarly for $v$.
\end{lemma}
\begin{proof}
    Use the Einstein equations in spherical symmetry and the dominant energy and no-antitrapping conditions.
\end{proof}
\begin{corollary}
    Inside $R \cup A$, $\partial_um \leq 0$ and $\partial_vm \geq 0$.
\end{corollary}
\begin{lemma}
    Inside $Q'$, the sign of $\partial_vr$ is the sign of $1 - 2mr^{-1}$.
\end{lemma}
    So in particular, a point is trapped provided that $1 - 2mr^{-1}$.
\begin{definition}
    Fix $(u, v) \in J^{-1}(\zeta^+)$. Define the \dfn{Bondi mass}
    $$M(u) = \lim_{v \to v_{\zeta^+}} m(u, v).$$
    The \dfn{ADM mass} is
    $$M_{ADM} = \lim_{u \to \Sigma_0} M(u).$$
\end{definition}
    So the Bondi mass is the mass observed by someone standing at the future end of a curve for which $u$ is constant. The ADM mass is the mass observed by an observer at $\partial \Sigma_0$. Here ``feeling mass" means experiencing a gravitational field.
\begin{theorem}[positive mass theorem]
    \index{positive mass theorem}
    If $\Sigma_0 = \RR^3$ then $M_{ADM} \geq 0$.
\end{theorem}
\begin{proof}
    Either $\Sigma_0 \subseteq R$ or not. If not, then there is a point on $\Sigma_0$ which does not end up at $\zeta^+$, and in particular there is a point $(u_0, v_0)$ on $\partial R \cap \Sigma_0$ which lies in the apparent horizon. So at that point, $1 = 2mr^{-1}$. Since $r > 0$, $m > 0$, and the monotonicity properties above guarantee that the regular points also have positive mass. The observer at infinity can only feel things in his causal past, in particular $\Sigma_0 \cap R$, so we're done.

    If $\Sigma_0 \subseteq R$, note that since $g$ is smooth, $r$ is Lipschitz. So
    $$1 - 2mr^{-1} = g(\partial r, \partial r)$$
    is bounded, whence $m \to 0^+$ as $r \to 0$ on $\Sigma_0$. By monotonicity, $m \geq 0$ on $\Sigma_0$, and so $M_{ADM} \geq 0$.
\end{proof}
    Note that in the case $\Sigma_0 \subseteq R$, we used the fact that $\Sigma_0 = \RR^3$ so show that $g$ is smooth and that $\Sigma_0$ is connected. We used the dominant energy condition and the antitrapping to guarantee monotonicity.
\begin{corollary}[Riemannian Penrose inequality]
    \index{Riemannian Penrose inequality}
    Let $S_R$ be a minimal sphere in $\Sigma_0$ of radius $R > 0$, and assume that the second fundamental form is $0$. Then
    $$M_{ADM} \geq \frac{R}{2}.$$
\end{corollary}
    In $\RR^3$ there are no minimal spheres so we take $R \to 0$. The positive mass theorem is sharp, because the ADM mass of Minkowski spacetime is $0$.
\begin{definition}
    The \dfn{generalized extension principle} is the assumption that for every $p \in \overline Q$, $q \in I^-(p)$, $q \neq p$, if
    $$D = J^+(q) \cap J^-(p) \setminus p,$$
    then $D$ has finite volume and $$0 < \inf_D r < \sup_D r < \infty.$$
\end{definition}
    The generalized extension principle holds for any reasonable spacetime.
\begin{example}
    The generalized extension principle is not true for the Einstein null dust spacetime.
\end{example}
\begin{definition}
    The \dfn{event horizon} $H^+$ is the future boundary of $J^-(\zeta^+)$.
\end{definition}
    Then one has
    $$\lim_{v \to \zeta^+} r = \sup_{H^+} r.$$
\begin{definition}
    The \dfn{final Bondi mass} is
    $$M_f = \lim_{u \to u_\Box} M(u) = \inf_u M(u),$$
    the limit taken as $u$ goes to the future.
\end{definition}
    The fact that this is an infimum follows from the monoticity assumptions.
\begin{theorem}[Penrose event horizon inequality]
    \index{Penrose event horizon inequality}
    Assume the generalized extension principle. Then
    $$\sup_{H^+} r \leq 2 M_f.$$
\end{theorem}
    We think of the sup as the radius of the black hole. Unravelling the definitions, we obtain a lower bound on all Bondi masses that follows from the size of the black hole.

    The idea of the proof is that if we have control of $1 - 2mr^{-1}$, then we use the Raychaudhuri equation
    $$-4 \partial_ur\Omega^{-2} = \frac{1 - 2mr^{-1}}{\partial_vr}$$
    to control $\partial_vr$ in terms of $\partial_ur$. We then use the definition of the Hawking mass to control the integral of the energy-momentum tensor. So if the conclusion of the Penrose event horizon inequality fails, we can find a $(u, v)$ on the event horizon such that $r > 2M_f$. Since $M$ and $r$ obey similar monoticity conditions, we obtain an absurd bound on the mass.

\section{Recent progress on strong censorship}
\begin{conjecture}
    For a generic asymptotically flat initial data set for a ``reasonable" Einstein-matter Lagrangian, the future maximal globally hyperbolic development is inextendible as a ``suitably regular" Lorentzian manifold.
\end{conjecture}
\begin{example}
    The Reichner-Nordstrom spacetime is a (highly nongeneric) counterexample.
\end{example}
    To prove the strong cosmic censorship conjecture one would need to show that the Cauchy horizon of any counterexample must be unstable in the sense that a small perturbation of the initial-data set would necessarily destroy the Cauchy horizon. To do this, we first characterize its stability properties.
\begin{example}
    Let us study the stability properties of Cauchy horizons in the Einstein-Maxwell null dust Lagrangian. Recall that null dust is defined by its energy momentum tensor. That is, $T_{uu}^{out}$ is nonzero and can depend on $u$ and $v$ but all other $T_{\alpha\beta}^{out} = 0$. This is the outgoing null dust. By Noether's theorem, $\nabla^\mu T_{\mu\nu}^{out} = 0$ which implies that $T_{uu}$ does not depend on $v$. We also have a term $T_{vv}^{out}$ which can be nonzero and only depends on $v$.

    The Einstein-Maxwell-null dust equation is $G_{\alpha\beta} = 2T_{\alpha\beta}$ like usual, where
    where
    $$T_{\alpha\beta} = T^{out}_{\alpha\beta} + T^{in}_{\alpha\beta} + T_{\alpha\beta}^{Max}$$
    where $T^{Max}$ is the Einstein-Maxwell energy-momentum tensor. But $T_{uu}^{Max} = T_{vv}^{Max} = 0$, so the null dust coordinates do not interact with the Einstein-Maxwell coordinates.

    First we treat the case $T^{out}|_{\Sigma_0} = 0$. Assume that $T^{in}|_{\Sigma_0}$ is small and rapidly decaying. We claim that this will deform into a large perturbation of the Cauchy horizon. In these assumptions, the metric tensor is given by the \dfn{Vaidya metric}. In Eddington-Finkelstein coordinates for $v$ (i.e. $v$ is normalized so $\Omega^2(\partial_ur)^{-1} = -2$, which is possible by the Raychaudhuri equations),
\begin{align*}
    g &= -\Omega^2 ~dudv + r^2\underline g = -\Omega^2((\partial_ur)^{-1} \partial_ur + (\partial_vr)^{-1} \partial_vr) ~dudv + r^2\underline g\\
        &= 2~drdv - 2\partial_vr dv^2 + r^2\underline g.
\end{align*}
    We introduce the \dfn{modified Hawking mass} $\varpi$ defined by
    $$g^{\alpha\beta} \partial_\alpha r \partial_\beta r = 1 -2\varpi r^{-1} + \varpi^2 r^{-2}.$$
    Then $\partial_u\varpi = -2r^2 \partial_vr\Omega^{-2} T_{uu}$ and similarly for $v$. In Eddington-Finkelstein coordinates,
    $$\partial_v \varpi = r^2 T_{vv}.$$
    Thus we arrive at the Vaidya metric
\begin{align*}
    g &= 2~drdv - (1 - 2\varpi r^{-1} + Q^2r^{-2} ~dv^2 + r^2\underline g)\\
    \partial_v\varpi &= r^2T_{vv}.
\end{align*}
    We now normalize so $T_{vv}|_{\Sigma_0}(v) = \varepsilon v^{-p}$ for $p,\varepsilon$ parameters. Then $\partial_v \varpi = \varepsilon v^{-p}$. We assume $p > 1$; then $\partial_v \varpi$ is $L^1$ and $\varpi$ stays finite up to the Cauchy horizon. Now we do not have $r \to 0$at the Cauchy horizon, so the Vaidya metric cannot blow up. But $v \to \infty$ at the Cauchy horizon, and $\Ric$ blows up at the Cauchy horizon. In double-null coordinates,
    $$\Omega^2 = O(e^{-2Kv})$$
    for some $K$, when $u$ is held fixed. So if $L = \Omega^2 ~\partial_v$, $L$ ``should be" a well-behaved vector field, yet $L$ experiences exponential growth as we approach the Cauchy horizon. Now $\Ric(L, L) = 2r^{-2}v^{-p} O(e^{4Kv})$ which blows up at the Cauchy horizon.

    So $\Ric$ is highly unstable near the Cauchy horizon, even though the Vaidya metric itself is stable. But a theorem of Poisson and Israel in the early 90's shows that the blowup of $\varpi$ near the Cauchy horizon is generic, so the Einstein-Maxwell null dust system with no outgoing radiation is highly unrealistic. In fact if $T^{out}$ is nonzero on $\Sigma_0$ then $\varpi = \infty$ on the Cauchy horizon. This phenomenon is known as the \dfn{mass inflation scenario}.
\end{example}

\begin{example}
    We now treat the more realistic Einstein-Maxwell uncharged scalar field system. Here we have introduced a scalar field $\phi$ on $M$ which is governed by the wave equation $\Box_g\phi = 0$. When we say it is uncharged we mean that we do not use the Maxwell tensor to introduce curvature on the line bundle that $\phi$ maps $M$ into (so we can take that line bundle to just be $\RR$).
\begin{theorem}[Kommemi]
    Assume that $\Sigma_0$ is homeomorphic to $\RR \times S^2$, and is asymptotically flat on two ends. Then there are at most two Cauchy horizons, and there must be a complete null infinity. If the spacetime is $C^2$-extendible, then it must be extendible through the Cauchy horizon in the sense that there must be a timeline geodesic $\gamma$ in the extension which meets the Cauchy horizon on the interior of $\gamma$.
\end{theorem}
    Let us consider the initial-value problem inside the black hole region. We normalize $v$ so that $-2\partial_vr = \Omega^{-2}$ on the event horizon, and we assume that there is a $p > 1/2$ such that $\phi = O(v^{-p})$ on the event horizon. If $\phi$ is smooth, then Daferemos proved that there is a Cauchy horizon, and that $g$ is continuous up to the Cauchy horizon. Moreover, if $\phi$ is compactly supported on $\Sigma_0$ then $\partial_v\phi = O(v^{-4})$. This estimate on $\phi$ is known as the \dfn{Price law rate}.
\end{example}






\newpage
\printindex

\end{document}
